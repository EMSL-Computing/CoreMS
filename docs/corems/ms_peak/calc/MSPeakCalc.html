<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.1.0"/>
    <title>corems.ms_peak.calc.MSPeakCalc API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../calc.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;corems.ms_peak.calc</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#MSPeakCalculation">MSPeakCalculation</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#MSPeakCalculation.calc_area">calc_area</a>
                        </li>
                        <li>
                                <a class="function" href="#MSPeakCalculation.fit_peak">fit_peak</a>
                        </li>
                        <li>
                                <a class="function" href="#MSPeakCalculation.voigt_pso">voigt_pso</a>
                        </li>
                        <li>
                                <a class="function" href="#MSPeakCalculation.objective_pso">objective_pso</a>
                        </li>
                        <li>
                                <a class="function" href="#MSPeakCalculation.minimize_pso">minimize_pso</a>
                        </li>
                        <li>
                                <a class="function" href="#MSPeakCalculation.fit_peak_pso">fit_peak_pso</a>
                        </li>
                        <li>
                                <a class="function" href="#MSPeakCalculation.voigt">voigt</a>
                        </li>
                        <li>
                                <a class="function" href="#MSPeakCalculation.pseudovoigt">pseudovoigt</a>
                        </li>
                        <li>
                                <a class="function" href="#MSPeakCalculation.lorentz">lorentz</a>
                        </li>
                        <li>
                                <a class="function" href="#MSPeakCalculation.gaussian">gaussian</a>
                        </li>
                        <li>
                                <a class="function" href="#MSPeakCalculation.get_mz_domain">get_mz_domain</a>
                        </li>
                        <li>
                                <a class="variable" href="#MSPeakCalculation.number_possible_assignments">number_possible_assignments</a>
                        </li>
                        <li>
                                <a class="function" href="#MSPeakCalculation.molecular_formula_lowest_error">molecular_formula_lowest_error</a>
                        </li>
                        <li>
                                <a class="function" href="#MSPeakCalculation.molecular_formula_highest_prob_score">molecular_formula_highest_prob_score</a>
                        </li>
                        <li>
                                <a class="function" href="#MSPeakCalculation.molecular_formula_earth_filter">molecular_formula_earth_filter</a>
                        </li>
                        <li>
                                <a class="function" href="#MSPeakCalculation.molecular_formula_water_filter">molecular_formula_water_filter</a>
                        </li>
                        <li>
                                <a class="function" href="#MSPeakCalculation.molecular_formula_air_filter">molecular_formula_air_filter</a>
                        </li>
                        <li>
                                <a class="function" href="#MSPeakCalculation.cia_score_S_P_error">cia_score_S_P_error</a>
                        </li>
                        <li>
                                <a class="function" href="#MSPeakCalculation.cia_score_N_S_P_error">cia_score_N_S_P_error</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../../corems.html">corems</a><wbr>.<a href="./../../ms_peak.html">ms_peak</a><wbr>.<a href="./../calc.html">calc</a><wbr>.MSPeakCalc    </h1>

                
                        <input id="mod-MSPeakCalc-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-MSPeakCalc-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Yuri E. Corilo&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;Jun 04, 2019&quot;</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">import</span> <span class="nn">warnings</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">import</span> <span class="nn">pyswarm</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">from</span> <span class="nn">lmfit</span> <span class="kn">import</span> <span class="n">models</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a>    <span class="n">ceil</span><span class="p">,</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a>    <span class="n">exp</span><span class="p">,</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a>    <span class="n">flip</span><span class="p">,</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a>    <span class="n">floor</span><span class="p">,</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a>    <span class="n">linspace</span><span class="p">,</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a>    <span class="n">log</span><span class="p">,</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a>    <span class="n">nan</span><span class="p">,</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a>    <span class="n">pi</span><span class="p">,</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a>    <span class="n">poly1d</span><span class="p">,</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a>    <span class="n">polyfit</span><span class="p">,</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a>    <span class="n">rint</span><span class="p">,</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a>    <span class="n">sqrt</span><span class="p">,</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a>    <span class="n">square</span><span class="p">,</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a>    <span class="n">trapz</span><span class="p">,</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="p">)</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="kn">from</span> <span class="nn">corems.encapsulation.constant</span> <span class="kn">import</span> <span class="n">Atoms</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="kn">from</span> <span class="nn">corems.encapsulation.factory.parameters</span> <span class="kn">import</span> <span class="n">MSParameters</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="k">class</span> <span class="nc">MSPeakCalculation</span><span class="p">:</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to perform calculations on MSPeak objects.</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">    This class provides methods to perform various calculations on MSPeak objects, such as calculating Kendrick Mass Defect (KMD) and Kendrick Mass (KM), calculating peak area, and fitting peak lineshape using different models.</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="sd">    Parameters</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="sd">    ----------</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="sd">    None</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="sd">    Attributes</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="sd">    ----------</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="sd">    _ms_parent : MSParent</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="sd">        The parent MSParent object associated with the MSPeakCalculation object.</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="sd">    mz_exp : float</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="sd">        The experimental m/z value of the peak.</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="sd">    peak_left_index : int</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="sd">        The start scan index of the peak.</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="sd">    peak_right_index : int</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="sd">        The final scan index of the peak.</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="sd">    resolving_power : float</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="sd">        The resolving power of the peak.</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="sd">    Methods</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">    -------</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="sd">    * _calc_kmd(dict_base).</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">        Calculate the Kendrick Mass Defect (KMD) and Kendrick Mass (KM) for a given base formula.</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">    * calc_area().</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="sd">        Calculate the peak area using numpy&#39;s trapezoidal fit.</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd">    * fit_peak(mz_extend=6, delta_rp=0, model=&#39;Gaussian&#39;).</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="sd">        Perform lineshape analysis on a peak using lmfit module.</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="sd">    * voigt_pso(w, r, yoff, width, loc, a).</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="sd">        Calculate the Voigt function for particle swarm optimization (PSO) fitting.</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">    * objective_pso(x, w, u).</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="sd">        Calculate the objective function for PSO fitting.</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="sd">    * minimize_pso(lower, upper, w, u).</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="sd">        Minimize the objective function using the particle swarm optimization algorithm.</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="sd">    * fit_peak_pso(mz_extend=6, upsample_multiplier=5).</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a><span class="sd">        Perform lineshape analysis on a peak using particle swarm optimization (PSO) fitting.</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">    * voigt(oversample_multiplier=1, delta_rp=0, mz_overlay=1).</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="sd">        [Legacy] Perform voigt lineshape analysis on a peak.</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="sd">    * pseudovoigt(oversample_multiplier=1, delta_rp=0, mz_overlay=1, fraction=0.5).</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="sd">        [Legacy] Perform pseudovoigt lineshape analysis on a peak.</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a><span class="sd">    * lorentz(oversample_multiplier=1, delta_rp=0, mz_overlay=1).</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a><span class="sd">        [Legacy] Perform lorentz lineshape analysis on a peak.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="sd">    * gaussian(oversample_multiplier=1, delta_rp=0, mz_overlay=1).</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a><span class="sd">        [Legacy] Perform gaussian lineshape analysis on a peak.</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a><span class="sd">    * get_mz_domain(oversample_multiplier, mz_overlay).</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a><span class="sd">        [Legacy] Resample/interpolate datapoints for lineshape analysis.</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a><span class="sd">    * number_possible_assignments().</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a><span class="sd">        Return the number of possible molecular formula assignments for the peak.</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a><span class="sd">    * molecular_formula_lowest_error().</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a><span class="sd">        Return the molecular formula with the smallest absolute mz error.</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a><span class="sd">    * molecular_formula_highest_prob_score().</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a><span class="sd">        Return the molecular formula with the highest confidence score.</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a><span class="sd">    * molecular_formula_earth_filter(lowest_error=True).</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a><span class="sd">        Filter molecular formula using the &#39;Earth&#39; filter.</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a><span class="sd">    * molecular_formula_water_filter(lowest_error=True).</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a><span class="sd">        Filter molecular formula using the &#39;Water&#39; filter.</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a><span class="sd">    * molecular_formula_air_filter(lowest_error=True).</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a><span class="sd">        Filter molecular formula using the &#39;Air&#39; filter.</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a><span class="sd">    * cia_score_S_P_error().</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a><span class="sd">        Compound Identification Algorithm SP Error - Assignment Filter.</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a><span class="sd">    * cia_score_N_S_P_error().</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a><span class="sd">        Compound Identification Algorithm NSP Error - Assignment Filter.</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>    <span class="k">def</span> <span class="nf">_calc_kmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_base</span><span class="p">):</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the Kendrick Mass Defect (KMD) and Kendrick Mass (KM) for a given base formula</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a><span class="sd">        Parameters</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="sd">        ----------</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="sd">        dict_base : dict</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a><span class="sd">            dictionary with the base formula to be used in the calculation</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a><span class="sd">            Default is CH2, e.g.</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a><span class="sd">                dict_base = {&quot;C&quot;: 1, &quot;H&quot;: 2}</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="p">:</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>            <span class="c1"># msPeak obj does have a ms object parent</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>            <span class="n">kendrick_rounding_method</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mspeaks_settings</span><span class="o">.</span><span class="n">kendrick_rounding_method</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>            <span class="p">)</span>  <span class="c1"># rounding method can be one of floor, ceil or round</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>            <span class="c1"># msPeak obj does not have a ms object parent</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>            <span class="n">kendrick_rounding_method</span> <span class="o">=</span> <span class="n">MSParameters</span><span class="o">.</span><span class="n">ms_peak</span><span class="o">.</span><span class="n">kendrick_rounding_method</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>        <span class="n">mass</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">dict_base</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>            <span class="n">mass</span> <span class="o">+=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">atomic_masses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span> <span class="o">*</span> <span class="n">dict_base</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>        <span class="n">kendrick_mass</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span> <span class="o">/</span> <span class="n">mass</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>        <span class="k">if</span> <span class="n">kendrick_rounding_method</span> <span class="o">==</span> <span class="s2">&quot;ceil&quot;</span><span class="p">:</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>            <span class="n">nominal_km</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="n">kendrick_mass</span><span class="p">)</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>        <span class="k">elif</span> <span class="n">kendrick_rounding_method</span> <span class="o">==</span> <span class="s2">&quot;round&quot;</span><span class="p">:</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>            <span class="n">nominal_km</span> <span class="o">=</span> <span class="n">rint</span><span class="p">(</span><span class="n">kendrick_mass</span><span class="p">)</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>        <span class="k">elif</span> <span class="n">kendrick_rounding_method</span> <span class="o">==</span> <span class="s2">&quot;floor&quot;</span><span class="p">:</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>            <span class="n">nominal_km</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">kendrick_mass</span><span class="p">)</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> method was not implemented, please refer to corems.ms_peak.calc.MSPeakCalc Class&quot;</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>                <span class="o">%</span> <span class="n">kendrick_rounding_method</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>            <span class="p">)</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>        <span class="n">kmd</span> <span class="o">=</span> <span class="n">nominal_km</span> <span class="o">-</span> <span class="n">kendrick_mass</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>        <span class="c1"># kmd = (nominal_km - km) * 1</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>        <span class="c1"># kmd = round(kmd,0)</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>        <span class="k">return</span> <span class="n">kmd</span><span class="p">,</span> <span class="n">kendrick_mass</span><span class="p">,</span> <span class="n">nominal_km</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>    <span class="k">def</span> <span class="nf">calc_area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the peak area using numpy&#39;s trapezoidal fit</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a><span class="sd">        uses provided mz_domain to accurately integrate areas independent of digital resolution</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a><span class="sd">        Returns</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a><span class="sd">        -------</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a><span class="sd">        float</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="sd">            peak area</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span><span class="p">:</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>            <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">abundance_profile</span><span class="p">[</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>            <span class="p">]</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>            <span class="n">xx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">[</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>            <span class="p">]</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>            <span class="c1"># check if the axis is high to low m/z or not. if its MSFromFreq its high mz first, if its from Profile, its low mz first</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>            <span class="k">if</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>                <span class="n">xx</span> <span class="o">=</span> <span class="n">flip</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>                <span class="n">yy</span> <span class="o">=</span> <span class="n">flip</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">trapz</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">))</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>                <span class="s2">&quot;Peak Area Calculation for m/z </span><span class="si">{}</span><span class="s2"> has failed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">)</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>            <span class="p">)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>            <span class="k">return</span> <span class="n">nan</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>    <span class="k">def</span> <span class="nf">fit_peak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz_extend</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;Gaussian&quot;</span><span class="p">):</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Lineshape analysis on a peak using lmfit module.</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a><span class="sd">        Model and fit peak lineshape by defined function - using lmfit module</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a><span class="sd">        Does not oversample/resample/interpolate data points</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a><span class="sd">        Better to go back to time domain and perform more zero filling - if possible.</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a><span class="sd">        Parameters</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="sd">        ----------</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a><span class="sd">        mz_extend : int</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a><span class="sd">            extra points left and right of peak definition to include in fitting</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a><span class="sd">        delta_rp : float</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a><span class="sd">            delta resolving power to add to resolving power</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a><span class="sd">        model : str</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a><span class="sd">            Type of lineshape model to use.</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a><span class="sd">            Models allowed: Gaussian, Lorentz, Voigt</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a><span class="sd">        Returns</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a><span class="sd">        -----</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="sd">        mz_domain : ndarray</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">            x-axis domain for fit</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a><span class="sd">        fit_peak : lmfit object</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a><span class="sd">            fit results object from lmfit module</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a><span class="sd">        Notes</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a><span class="sd">        -----</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a><span class="sd">        Returns the calculated mz domain, initial defined abundance profile, and the fit peak results object from lmfit module</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a><span class="sd">        mz_extend here extends the x-axis domain so that we have sufficient points either side of the apex to fit.</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a><span class="sd">        Takes about 10ms per peak</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>        <span class="n">start_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">-</span> <span class="n">mz_extend</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>        <span class="p">)</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>        <span class="n">final_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">+</span> <span class="n">mz_extend</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">)</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>        <span class="p">)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>        <span class="c1"># check if MSPeak contains the resolving power info</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span> <span class="o">+</span> <span class="n">delta_rp</span><span class="p">)</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">final_index</span><span class="p">]</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>            <span class="n">abundance_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">abundance_profile</span><span class="p">[</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>                <span class="n">start_index</span><span class="p">:</span><span class="n">final_index</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>            <span class="p">]</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>            <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Gaussian&quot;</span><span class="p">:</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>                <span class="c1"># stardard deviation</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>                <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>                <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>                <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GaussianModel</span><span class="p">()</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>                <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>                    <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>                <span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>            <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Lorentz&quot;</span><span class="p">:</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>                <span class="c1"># stardard deviation</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>                <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>                <span class="n">amplitude</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>                <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">LorentzianModel</span><span class="p">()</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>                <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>                    <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>                <span class="p">)</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>            <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Voigt&quot;</span><span class="p">:</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>                <span class="c1"># stardard deviation</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>                <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="mf">3.6013</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>                <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>                <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">VoigtModel</span><span class="p">()</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>                <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>                    <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>                <span class="p">)</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>                <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s2">&quot;model lineshape not known or defined&quot;</span><span class="p">)</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>            <span class="c1"># calc_abundance = model.eval(params=params, x=mz_domain) #Same as initial fit, returned in fit_peak object</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>            <span class="n">fit_peak</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">abundance_domain</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mz_domain</span><span class="p">)</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>            <span class="k">return</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">fit_peak</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>            <span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>    <span class="k">def</span> <span class="nf">voigt_pso</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">yoff</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Voigt function for particle swarm optimisation (PSO) fitting</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a><span class="sd">        From https://github.com/pnnl/nmrfit/blob/master/nmrfit/equations.py.</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a><span class="sd">        Calculates a Voigt function over w based on the relevant properties of the distribution.</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a><span class="sd">        Parameters</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a><span class="sd">        ----------</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a><span class="sd">        w : ndarray</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a><span class="sd">            Array over which the Voigt function will be evaluated.</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a><span class="sd">        r : float</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a><span class="sd">            Ratio between the Guassian and Lorentzian functions.</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a><span class="sd">        yoff : float</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a><span class="sd">            Y-offset of the Voigt function.</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a><span class="sd">        width : float</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a><span class="sd">            The width of the Voigt function.</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a><span class="sd">        loc : float</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a><span class="sd">            Center of the Voigt function.</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a><span class="sd">        a : float</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a><span class="sd">            Area of the Voigt function.</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a><span class="sd">        Returns</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a><span class="sd">        -------</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a><span class="sd">        V : ndarray</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a><span class="sd">            Array defining the Voigt function over w.</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a><span class="sd">        References</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a><span class="sd">        ----------</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a><span class="sd">        1. https://github.com/pnnl/nmrfit</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a><span class="sd">        Notes</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a><span class="sd">        -----</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a><span class="sd">        Particle swarm optimisation (PSO) fitting function can be significantly more computationally expensive than lmfit, with more parameters to optimise.</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>        <span class="c1"># Lorentzian component</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">width</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">w</span> <span class="o">-</span> <span class="n">loc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">width</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>        <span class="c1"># Gaussian component</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>            <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>            <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">pi</span><span class="p">)</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>            <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(((</span><span class="n">w</span> <span class="o">-</span> <span class="n">loc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>        <span class="p">)</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>        <span class="c1"># Voigt body</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="p">(</span><span class="n">yoff</span> <span class="o">+</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">L</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">G</span><span class="p">)</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>        <span class="k">return</span> <span class="n">V</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>    <span class="k">def</span> <span class="nf">objective_pso</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Objective function for particle swarm optimisation (PSO) fitting</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a><span class="sd">        The objective function used to fit supplied data.  Evaluates sum of squared differences between the fit and the data.</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a><span class="sd">        Parameters</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a><span class="sd">        ----------</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a><span class="sd">        x : list of floats</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a><span class="sd">            Parameter vector.</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a><span class="sd">        w : ndarray</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a><span class="sd">            Array of frequency data.</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a><span class="sd">        u : ndarray</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a><span class="sd">            Array of data to be fit.</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a><span class="sd">        Returns</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a><span class="sd">        -------</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a><span class="sd">        rmse : float</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a><span class="sd">            Root mean square error between the data and fit.</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a><span class="sd">        References</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a><span class="sd">        ----------</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a><span class="sd">        1. https://github.com/pnnl/nmrfit</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>        <span class="c1"># global parameters</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>        <span class="n">r</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>        <span class="n">yoff</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>        <span class="c1"># calculate fit for V</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>        <span class="n">V_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voigt_pso</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">yoff</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>        <span class="c1"># real component RMSE</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>        <span class="n">rmse</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">square</span><span class="p">((</span><span class="n">u</span> <span class="o">-</span> <span class="n">V_fit</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>        <span class="c1"># return the total RMSE</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>        <span class="k">return</span> <span class="n">rmse</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>    <span class="k">def</span> <span class="nf">minimize_pso</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Minimization function for particle swarm optimisation (PSO) fitting</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a><span class="sd">        Minimizes the objective function using the particle swarm optimization algorithm.</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a><span class="sd">        Minimization function based on defined parameters</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a><span class="sd">        Parameters</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a><span class="sd">        ----------</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a><span class="sd">        lower : list of floats</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a><span class="sd">            Lower bounds for the parameters.</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a><span class="sd">        upper : list of floats</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a><span class="sd">            Upper bounds for the parameters.</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a><span class="sd">        w : ndarray</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a><span class="sd">            Array of frequency data.</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a><span class="sd">        u : ndarray</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a><span class="sd">            Array of data to be fit.</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a><span class="sd">        Notes</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a><span class="sd">        -----</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a><span class="sd">        Particle swarm optimisation (PSO) fitting function can be significantly more computationally expensive than lmfit, with more parameters to optimise.</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a><span class="sd">        Current parameters take ~2 seconds per peak.</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a><span class="sd">        References</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a><span class="sd">        ----------</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a><span class="sd">        1. https://github.com/pnnl/nmrfit</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>        <span class="c1"># TODO - allow support to pass swarmsize, maxiter, omega, phip, phig parameters.</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>        <span class="c1"># TODO - Refactor PSO fitting into its own class?</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>        <span class="n">xopt</span><span class="p">,</span> <span class="n">fopt</span> <span class="o">=</span> <span class="n">pyswarm</span><span class="o">.</span><span class="n">pso</span><span class="p">(</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objective_pso</span><span class="p">,</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>            <span class="n">lower</span><span class="p">,</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>            <span class="n">upper</span><span class="p">,</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">u</span><span class="p">),</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>            <span class="n">swarmsize</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>            <span class="n">maxiter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>            <span class="n">omega</span><span class="o">=-</span><span class="mf">0.2134</span><span class="p">,</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>            <span class="n">phip</span><span class="o">=-</span><span class="mf">0.3344</span><span class="p">,</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>            <span class="n">phig</span><span class="o">=</span><span class="mf">2.3259</span><span class="p">,</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>        <span class="p">)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>        <span class="k">return</span> <span class="n">xopt</span><span class="p">,</span> <span class="n">fopt</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>    <span class="k">def</span> <span class="nf">fit_peak_pso</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz_extend</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">upsample_multiplier</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Lineshape analysis on a peak using particle swarm optimisation (PSO) fitting</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a><span class="sd">        Function to fit a Voigt peakshape using particle swarm optimisation (PSO).</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a><span class="sd">        Should return better results than lmfit, but much more computationally expensive</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a><span class="sd">        Parameters</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a><span class="sd">        ----------</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a><span class="sd">        mz_extend : int, optional</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a><span class="sd">            extra points left and right of peak definition to include in fitting. Defaults to 6.</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a><span class="sd">        upsample_multiplier : int, optional</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function. Defaults to 5.</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a><span class="sd">        Returns</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a><span class="sd">        -------</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="sd">        xopt : array</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a><span class="sd">            variables describing the voigt function.</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="sd">            G/L ratio, width (fwhm), apex (x-axis), area.</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a><span class="sd">            y-axis offset is fixed at 0</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="sd">        fopt : float</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a><span class="sd">            objective score (rmse)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a><span class="sd">        psfit : array</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a><span class="sd">            recalculated y values based on function and optimised fit</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a><span class="sd">        psfit_hdp : tuple of arrays</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="sd">            0 - linspace x-axis upsampled grid</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a><span class="sd">            1 - recalculated y values based on function and upsampled x-axis grid</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="sd">            Does not change results, but aids in visualisation of the &#39;true&#39; voigt lineshape</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a><span class="sd">        Notes</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a><span class="sd">        -----</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a><span class="sd">        Particle swarm optimisation (PSO) fitting function can be significantly more computationally expensive than lmfit, with more parameters to optimise.</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>        <span class="c1"># TODO - Add ability to pass pso args (i.e. swarm size, maxiter, omega, phig, etc)</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>        <span class="c1"># TODO: fix xopt. Magnitude mode data through CoreMS/Bruker starts at 0 but is noise centered well above 0.</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>        <span class="c1"># Thermo data is noise reduced by also noise subtracted, so starts at 0</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>        <span class="c1"># Absorption mode/phased data will have positive and negative components and may not be baseline corrected</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>        <span class="n">start_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">-</span> <span class="n">mz_extend</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>        <span class="p">)</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>        <span class="n">final_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">+</span> <span class="n">mz_extend</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">)</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>        <span class="p">)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>        <span class="c1"># check if MSPeak contains the resolving power info</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">final_index</span><span class="p">]</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>            <span class="n">abundance_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">abundance_profile</span><span class="p">[</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>                <span class="n">start_index</span><span class="p">:</span><span class="n">final_index</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>            <span class="p">]</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>            <span class="n">lower</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">-</span> <span class="mf">0.0005</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>            <span class="n">upper</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>                <span class="mi">1</span><span class="p">,</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">,</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">+</span> <span class="mf">0.0005</span><span class="p">),</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_to_noise</span><span class="p">,</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>            <span class="p">]</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>            <span class="n">xopt</span><span class="p">,</span> <span class="n">fopt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimize_pso</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">abundance_domain</span><span class="p">)</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>            <span class="n">psfit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voigt_pso</span><span class="p">(</span><span class="n">mz_domain</span><span class="p">,</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>            <span class="n">psfit_hdp_x</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>                <span class="nb">min</span><span class="p">(</span><span class="n">mz_domain</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">mz_domain</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">mz_domain</span><span class="p">)</span> <span class="o">*</span> <span class="n">upsample_multiplier</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>            <span class="p">)</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>            <span class="n">psfit_hdp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voigt_pso</span><span class="p">(</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>                <span class="n">psfit_hdp_x</span><span class="p">,</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>            <span class="p">)</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>            <span class="k">return</span> <span class="n">xopt</span><span class="p">,</span> <span class="n">fopt</span><span class="p">,</span> <span class="n">psfit</span><span class="p">,</span> <span class="p">(</span><span class="n">psfit_hdp_x</span><span class="p">,</span> <span class="n">psfit_hdp</span><span class="p">)</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>            <span class="p">)</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>    <span class="k">def</span> <span class="nf">voigt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oversample_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;[Legacy] Voigt lineshape analysis function</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a><span class="sd">        Legacy function for voigt lineshape analysis</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a><span class="sd">        Parameters</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a><span class="sd">        ----------</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a><span class="sd">        oversample_multiplier : int</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a><span class="sd">        delta_rp : float</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a><span class="sd">            delta resolving power to add to resolving power</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a><span class="sd">        mz_overlay : int</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a><span class="sd">            extra points left and right of peak definition to include in fitting</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a><span class="sd">        Returns</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a><span class="sd">        -------</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a><span class="sd">        mz_domain : ndarray</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a><span class="sd">            x-axis domain for fit</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a><span class="sd">        calc_abundance : ndarray</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="sd">            calculated abundance profile based on voigt function</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span> <span class="o">+</span> <span class="n">delta_rp</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>            <span class="p">)</span>  <span class="c1"># self.resolving_power)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>            <span class="c1"># stardart deviation</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="mf">3.6013</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>            <span class="c1"># half width baseline distance</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>            <span class="c1"># mz_domain = linspace(self.mz_exp - hw_base_distance,</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>            <span class="c1">#                     self.mz_exp + hw_base_distance, datapoint)</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mz_domain</span><span class="p">(</span><span class="n">oversample_multiplier</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="p">)</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>            <span class="c1"># gaussian_pdf = lambda x0, x, s: (1/ math.sqrt(2*math.pi*math.pow(s,2))) * math.exp(-1 * math.pow(x-x0,2) / 2*math.pow(s,2) )</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>            <span class="c1"># TODO derive amplitude</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>            <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">VoigtModel</span><span class="p">()</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>                <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>            <span class="p">)</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>            <span class="n">calc_abundance</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mz_domain</span><span class="p">)</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>            <span class="k">return</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">calc_abundance</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>            <span class="p">)</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>    <span class="k">def</span> <span class="nf">pseudovoigt</span><span class="p">(</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">oversample_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.5</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>    <span class="p">):</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;[Legacy] pseudovoigt lineshape function</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a><span class="sd">        Legacy function for pseudovoigt lineshape analysis.</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a><span class="sd">        Note - Code may not be functional currently.</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a><span class="sd">        Parameters</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a><span class="sd">        ----------</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a><span class="sd">        oversample_multiplier : int, optional</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function. Defaults to 1.</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a><span class="sd">        delta_rp : float, optional</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a><span class="sd">            delta resolving power to add to resolving power. Defaults to 0.</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a><span class="sd">        mz_overlay : int, optional</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a><span class="sd">            extra points left and right of peak definition to include in fitting. Defaults to 1.</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a><span class="sd">        fraction : float, optional</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a><span class="sd">            fraction of gaussian component in pseudovoigt function. Defaults to 0.5.</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span> <span class="o">+</span> <span class="n">delta_rp</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>            <span class="p">)</span>  <span class="c1"># self.resolving_power)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>            <span class="c1"># stardart deviation</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>            <span class="c1"># half width baseline distance</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>            <span class="c1"># mz_domain = linspace(self.mz_exp - hw_base_distance,</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>            <span class="c1">#                     self.mz_exp + hw_base_distance, datapoint)</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mz_domain</span><span class="p">(</span><span class="n">oversample_multiplier</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="p">)</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>            <span class="c1"># gaussian_pdf = lambda x0, x, s: (1/ math.sqrt(2*math.pi*math.pow(s,2))) * math.exp(-1 * math.pow(x-x0,2) / 2*math.pow(s,2) )</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PseudoVoigtModel</span><span class="p">()</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>            <span class="c1"># TODO derive amplitude</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>            <span class="n">gamma</span> <span class="o">=</span> <span class="n">sigma</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>            <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>            <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pi</span> <span class="o">/</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>                <span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">gamma</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">)</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>            <span class="p">)</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>            <span class="n">calc_abundance</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mz_domain</span><span class="p">)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>            <span class="k">return</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">calc_abundance</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>            <span class="p">)</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>    <span class="k">def</span> <span class="nf">lorentz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oversample_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;[Legacy] Lorentz lineshape analysis function</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a><span class="sd">        Legacy function for lorentz lineshape analysis</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a><span class="sd">        Parameters</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a><span class="sd">        ----------</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a><span class="sd">        oversample_multiplier : int</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a><span class="sd">        delta_rp : float</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a><span class="sd">            delta resolving power to add to resolving power</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a><span class="sd">        mz_overlay : int</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a><span class="sd">            extra points left and right of peak definition to include in fitting</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a><span class="sd">        Returns</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a><span class="sd">        -------</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a><span class="sd">        mz_domain : ndarray</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a><span class="sd">            x-axis domain for fit</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a><span class="sd">        calc_abundance : ndarray</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a><span class="sd">            calculated abundance profile based on lorentz function</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span> <span class="o">+</span> <span class="n">delta_rp</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>            <span class="p">)</span>  <span class="c1"># self.resolving_power)</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>            <span class="c1"># stardart deviation</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>            <span class="c1"># half width baseline distance</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>            <span class="n">hw_base_distance</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">sigma</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>            <span class="c1"># mz_domain = linspace(self.mz_exp - hw_base_distance,</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>            <span class="c1">#                     self.mz_exp + hw_base_distance, datapoint)</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mz_domain</span><span class="p">(</span><span class="n">oversample_multiplier</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>            <span class="c1"># gaussian_pdf = lambda x0, x, s: (1/ math.sqrt(2*math.pi*math.pow(s,2))) * math.exp(-1 * math.pow(x-x0,2) / 2*math.pow(s,2) )</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">LorentzianModel</span><span class="p">()</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>            <span class="n">amplitude</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>                <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>            <span class="p">)</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>            <span class="n">calc_abundance</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mz_domain</span><span class="p">)</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>            <span class="k">return</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">calc_abundance</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>            <span class="p">)</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>    <span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oversample_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;[Legacy] Gaussian lineshape analysis function</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a><span class="sd">        Legacy gaussian lineshape analysis function</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a><span class="sd">        Parameters</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a><span class="sd">        ----------</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a><span class="sd">        oversample_multiplier : int</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a><span class="sd">        delta_rp : float</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a><span class="sd">            delta resolving power to add to resolving power</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a><span class="sd">        mz_overlay : int</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a><span class="sd">            extra points left and right of peak definition to include in fitting</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a><span class="sd">        Returns</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a><span class="sd">        -------</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a><span class="sd">        mz_domain : ndarray</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a><span class="sd">            x-axis domain for fit</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a><span class="sd">        calc_abundance : ndarray</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a><span class="sd">            calculated abundance profile based on gaussian function</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>        <span class="c1"># check if MSPeak contains the resolving power info</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span> <span class="o">+</span> <span class="n">delta_rp</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>            <span class="p">)</span>  <span class="c1"># self.resolving_power)</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>            <span class="c1"># stardart deviation</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>            <span class="c1"># half width baseline distance</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>            <span class="c1"># hw_base_distance = (3.2 * s)</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>            <span class="c1"># match_loz_factor = 3</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>            <span class="c1"># n_d = hw_base_distance * match_loz_factor</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>            <span class="c1"># mz_domain = linspace(</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>            <span class="c1">#    self.mz_exp - n_d, self.mz_exp + n_d, datapoint)</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mz_domain</span><span class="p">(</span><span class="n">oversample_multiplier</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="p">)</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>            <span class="c1"># gaussian_pdf = lambda x0, x, s: (1/ math.sqrt(2*math.pi*math.pow(s,2))) * math.exp(-1 * math.pow(x-x0,2) / 2*math.pow(s,2) )</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>            <span class="c1"># calc_abundance = norm.pdf(mz_domain, self.mz_exp, s)</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GaussianModel</span><span class="p">()</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>            <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>                <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>            <span class="p">)</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>            <span class="n">calc_abundance</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mz_domain</span><span class="p">)</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>            <span class="k">return</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">calc_abundance</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>            <span class="p">)</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>    <span class="k">def</span> <span class="nf">get_mz_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oversample_multiplier</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="p">):</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;[Legacy] function to resample/interpolate datapoints for lineshape analysis</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a><span class="sd">        This code is used for the legacy line fitting functions and not recommended.</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a><span class="sd">        Legacy function to support expanding mz domain for legacy lineshape functions</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a><span class="sd">        Parameters</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a><span class="sd">        ----------</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a><span class="sd">        oversample_multiplier : int</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a><span class="sd">        mz_overlay : int</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a><span class="sd">            extra points left and right of peak definition to include in fitting</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a><span class="sd">        Returns</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a><span class="sd">        -------</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a><span class="sd">        mz_domain : ndarray</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a><span class="sd">            x-axis domain for fit</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>        <span class="n">start_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">-</span> <span class="n">mz_overlay</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>        <span class="p">)</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>        <span class="n">final_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">+</span> <span class="n">mz_overlay</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">)</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>        <span class="p">)</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>        <span class="k">if</span> <span class="n">oversample_multiplier</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">final_index</span><span class="p">]</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>            <span class="c1"># we assume a linear correlation for m/z and datapoits</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>            <span class="c1"># which is only true if the m/z range in narrow (within 1 m/z unit)</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>            <span class="c1"># this is not true for a wide m/z range</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>            <span class="n">indexes</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_index</span><span class="p">,</span> <span class="n">final_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>            <span class="n">mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>            <span class="n">pol</span> <span class="o">=</span> <span class="n">poly1d</span><span class="p">(</span><span class="n">polyfit</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>            <span class="n">oversampled_indexes</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>                <span class="n">start_index</span><span class="p">,</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>                <span class="n">final_index</span><span class="p">,</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>                <span class="p">(</span><span class="n">final_index</span> <span class="o">-</span> <span class="n">start_index</span><span class="p">)</span> <span class="o">*</span> <span class="n">oversample_multiplier</span><span class="p">,</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>            <span class="p">)</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="n">pol</span><span class="p">(</span><span class="n">oversampled_indexes</span><span class="p">)</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>        <span class="k">return</span> <span class="n">mz_domain</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>    <span class="nd">@property</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>    <span class="k">def</span> <span class="nf">number_possible_assignments</span><span class="p">(</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>    <span class="p">):</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">)</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>    <span class="k">def</span> <span class="nf">molecular_formula_lowest_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the molecular formula with the smallest absolute mz error&quot;&quot;&quot;</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>    <span class="k">def</span> <span class="nf">molecular_formula_highest_prob_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the molecular formula with the highest confidence score score&quot;&quot;&quot;</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">confidence_score</span><span class="p">))</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>    <span class="k">def</span> <span class="nf">molecular_formula_earth_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lowest_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter molecular formula using the &#39;Earth&#39; filter</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a><span class="sd">        This function applies the Formularity-esque &#39;Earth&#39; filter to possible molecular formula assignments.</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a><span class="sd">        Earth Filter:</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a><span class="sd">            O &gt; 0 AND N &lt;= 3 AND P &lt;= 2 AND 3P &lt;= O</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a><span class="sd">        If the lowest_error method is also used, it will return the single formula annotation with the smallest absolute error which also fits the Earth filter.</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a><span class="sd">        Otherwise, it will return all Earth-filter compliant formulas.</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a><span class="sd">        Parameters</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a><span class="sd">        ----------</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a><span class="sd">        lowest_error : bool, optional.</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a><span class="sd">            Return only the lowest error formula which also fits the Earth filter.</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a><span class="sd">            If False, return all Earth-filter compliant formulas. Default is True.</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a><span class="sd">        Returns</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a><span class="sd">        -------</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a><span class="sd">        list</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a><span class="sd">            List of molecular formula objects which fit the Earth filter</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a><span class="sd">        References</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a><span class="sd">        ----------</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a><span class="sd">        1. Nikola Tolic et al., &quot;Formularity: Software for Automated Formula Assignment of Natural and Other Organic Matter from Ultrahigh-Resolution Mass Spectra&quot;</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a><span class="sd">            Anal. Chem. 2017, 89, 23, 12659–12665</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a><span class="sd">            doi: 10.1021/acs.analchem.7b03318</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>        <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>            <span class="nb">filter</span><span class="p">(</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>                <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>                <span class="ow">and</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">),</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>            <span class="p">)</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>        <span class="p">)</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>            <span class="k">if</span> <span class="n">lowest_error</span><span class="p">:</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>                <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>                <span class="k">return</span> <span class="n">candidates</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>            <span class="k">return</span> <span class="n">candidates</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>    <span class="k">def</span> <span class="nf">molecular_formula_water_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lowest_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter molecular formula using the &#39;Water&#39; filter</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a><span class="sd">        This function applies the Formularity-esque &#39;Water&#39; filter to possible molecular formula assignments.</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a><span class="sd">        Water Filter:</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a><span class="sd">            O &gt; 0 AND N &lt;= 3 AND S &lt;= 2 AND P &lt;= 2</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a><span class="sd">        If the lowest_error method is also used, it will return the single formula annotation with the smallest absolute error which also fits the Water filter.</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a><span class="sd">        Otherwise, it will return all Water-filter compliant formulas.</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a><span class="sd">        Parameters</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a><span class="sd">        ----------</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a><span class="sd">        lowest_error : bool, optional</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a><span class="sd">            Return only the lowest error formula which also fits the Water filter.</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a><span class="sd">            If False, return all Water-filter compliant formulas. Defaults to 2</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a><span class="sd">        Returns</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a><span class="sd">        -------</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a><span class="sd">        list</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a><span class="sd">            List of molecular formula objects which fit the Water filter</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a><span class="sd">        References</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a><span class="sd">        ----------</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a><span class="sd">        1. Nikola Tolic et al., &quot;Formularity: Software for Automated Formula Assignment of Natural and Other Organic Matter from Ultrahigh-Resolution Mass Spectra&quot;</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a><span class="sd">            Anal. Chem. 2017, 89, 23, 12659–12665</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a><span class="sd">            doi: 10.1021/acs.analchem.7b03318</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>        <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>            <span class="nb">filter</span><span class="p">(</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>                <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>            <span class="p">)</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>        <span class="p">)</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>            <span class="k">if</span> <span class="n">lowest_error</span><span class="p">:</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>                <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>                <span class="k">return</span> <span class="n">candidates</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>            <span class="k">return</span> <span class="n">candidates</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>    <span class="k">def</span> <span class="nf">molecular_formula_air_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lowest_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter molecular formula using the &#39;Air&#39; filter</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a><span class="sd">        This function applies the Formularity-esque &#39;Air&#39; filter to possible molecular formula assignments.</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a><span class="sd">        Air Filter:</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a><span class="sd">            O &gt; 0 AND N &lt;= 3 AND S &lt;= 1 AND P = 0 AND 3(S+N) &lt;= O</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a><span class="sd">        If the lowest_error method is also used, it will return the single formula annotation with the smallest absolute error which also fits the Air filter.</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a><span class="sd">        Otherwise, it will return all Air-filter compliant formulas.</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a><span class="sd">        Parameters</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a><span class="sd">        ----------</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a><span class="sd">        lowest_error : bool, optional</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a><span class="sd">            Return only the lowest error formula which also fits the Air filter.</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a><span class="sd">            If False, return all Air-filter compliant formulas. Defaults to True.</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a><span class="sd">        Returns</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a><span class="sd">        -------</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a><span class="sd">        list</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a><span class="sd">            List of molecular formula objects which fit the Air filter</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a><span class="sd">        References</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a><span class="sd">        ----------</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a><span class="sd">        1. Nikola Tolic et al., &quot;Formularity: Software for Automated Formula Assignment of Natural and Other Organic Matter from Ultrahigh-Resolution Mass Spectra&quot;</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a><span class="sd">            Anal. Chem. 2017, 89, 23, 12659–12665</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a><span class="sd">            doi: 10.1021/acs.analchem.7b03318</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>        <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>            <span class="nb">filter</span><span class="p">(</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>                <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>                <span class="ow">and</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">),</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>            <span class="p">)</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>        <span class="p">)</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>            <span class="k">if</span> <span class="n">lowest_error</span><span class="p">:</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>                <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>                <span class="k">return</span> <span class="n">candidates</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>            <span class="k">return</span> <span class="n">candidates</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>    <span class="k">def</span> <span class="nf">cia_score_S_P_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compound Identification Algorithm SP Error - Assignment Filter</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a><span class="sd">        This function applies the Compound Identification Algorithm (CIA) SP Error filter to possible molecular formula assignments.</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a><span class="sd">        It takes the molecular formula with the lowest S+P count, and returns the formula with the lowest absolute error from this subset.</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a><span class="sd">        Returns</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a><span class="sd">        -------</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a><span class="sd">        MolecularFormula</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a><span class="sd">            A single molecular formula which fits the rules of the CIA SP Error filter</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a><span class="sd">        References</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a><span class="sd">        ----------</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a><span class="sd">        1. Elizabeth B. Kujawinski and Mark D. Behn, &quot;Automated Analysis of Electrospray Ionization Fourier Transform Ion Cyclotron Resonance Mass Spectra of Natural Organic Matter&quot;</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a><span class="sd">            Anal. Chem. 2006, 78, 13, 4363–4373</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a><span class="sd">            doi: 10.1021/ac0600306</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>        <span class="c1"># case EFormulaScore.HAcap:</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>        <span class="n">lowest_S_P_mf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>        <span class="p">)</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>        <span class="n">lowest_S_P_count</span> <span class="o">=</span> <span class="n">lowest_S_P_mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">lowest_S_P_mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>        <span class="n">list_same_s_p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>            <span class="nb">filter</span><span class="p">(</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>                <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">lowest_S_P_count</span><span class="p">,</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>            <span class="p">)</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>        <span class="p">)</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>        <span class="c1"># check if list is not empty</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>        <span class="k">if</span> <span class="n">list_same_s_p</span><span class="p">:</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">list_same_s_p</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>            <span class="k">return</span> <span class="n">lowest_S_P_mf</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>    <span class="k">def</span> <span class="nf">cia_score_N_S_P_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compound Identification Algorithm NSP Error - Assignment Filter</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a><span class="sd">        This function applies the Compound Identification Algorithm (CIA) NSP Error filter to possible molecular formula assignments.</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a><span class="sd">        It takes the molecular formula with the lowest N+S+P count, and returns the formula with the lowest absolute error from this subset.</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a><span class="sd">        Returns</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a><span class="sd">        -------</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a><span class="sd">        MolecularFormula</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a><span class="sd">            A single molecular formula which fits the rules of the CIA NSP Error filter</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="sd">        References</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a><span class="sd">        ----------</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a><span class="sd">        1. Elizabeth B. Kujawinski and Mark D. Behn, &quot;Automated Analysis of Electrospray Ionization Fourier Transform Ion Cyclotron Resonance Mass Spectra of Natural Organic Matter&quot;</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a><span class="sd">            Anal. Chem. 2006, 78, 13, 4363–4373</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a><span class="sd">            doi: 10.1021/ac0600306</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a><span class="sd">        Raises</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a><span class="sd">        -------</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a><span class="sd">        Exception</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a><span class="sd">            If no molecular formula are associated with mass spectrum peak.</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>        <span class="c1"># case EFormulaScore.HAcap:</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">:</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>            <span class="n">lowest_N_S_P_mf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">),</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>            <span class="p">)</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>            <span class="n">lowest_N_S_P_count</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>                <span class="n">lowest_N_S_P_mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>                <span class="o">+</span> <span class="n">lowest_N_S_P_mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>                <span class="o">+</span> <span class="n">lowest_N_S_P_mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>            <span class="p">)</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>            <span class="n">list_same_N_S_P</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>                <span class="nb">filter</span><span class="p">(</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>                    <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>                    <span class="o">==</span> <span class="n">lowest_N_S_P_count</span><span class="p">,</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>                <span class="p">)</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>            <span class="p">)</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>            <span class="k">if</span> <span class="n">list_same_N_S_P</span><span class="p">:</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>                <span class="n">SP_filtered_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>                    <span class="nb">filter</span><span class="p">(</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>                        <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>                        <span class="n">list_same_N_S_P</span><span class="p">,</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>                    <span class="p">)</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>                <span class="p">)</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>                <span class="k">if</span> <span class="n">SP_filtered_list</span><span class="p">:</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>                    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">SP_filtered_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>                    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">list_same_N_S_P</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>                <span class="k">return</span> <span class="n">lowest_N_S_P_mf</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>                <span class="s2">&quot;No molecular formula associated with the mass spectrum peak at m/z: </span><span class="si">%.6f</span><span class="s2">&quot;</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>            <span class="p">)</span>
</span></pre></div>


            </section>
                <section id="MSPeakCalculation">
                            <input id="MSPeakCalculation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MSPeakCalculation</span>:

                <label class="view-source-button" for="MSPeakCalculation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation-30"><a href="#MSPeakCalculation-30"><span class="linenos">  30</span></a><span class="k">class</span> <span class="nc">MSPeakCalculation</span><span class="p">:</span>
</span><span id="MSPeakCalculation-31"><a href="#MSPeakCalculation-31"><span class="linenos">  31</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to perform calculations on MSPeak objects.</span>
</span><span id="MSPeakCalculation-32"><a href="#MSPeakCalculation-32"><span class="linenos">  32</span></a>
</span><span id="MSPeakCalculation-33"><a href="#MSPeakCalculation-33"><span class="linenos">  33</span></a><span class="sd">    This class provides methods to perform various calculations on MSPeak objects, such as calculating Kendrick Mass Defect (KMD) and Kendrick Mass (KM), calculating peak area, and fitting peak lineshape using different models.</span>
</span><span id="MSPeakCalculation-34"><a href="#MSPeakCalculation-34"><span class="linenos">  34</span></a>
</span><span id="MSPeakCalculation-35"><a href="#MSPeakCalculation-35"><span class="linenos">  35</span></a><span class="sd">    Parameters</span>
</span><span id="MSPeakCalculation-36"><a href="#MSPeakCalculation-36"><span class="linenos">  36</span></a><span class="sd">    ----------</span>
</span><span id="MSPeakCalculation-37"><a href="#MSPeakCalculation-37"><span class="linenos">  37</span></a><span class="sd">    None</span>
</span><span id="MSPeakCalculation-38"><a href="#MSPeakCalculation-38"><span class="linenos">  38</span></a>
</span><span id="MSPeakCalculation-39"><a href="#MSPeakCalculation-39"><span class="linenos">  39</span></a><span class="sd">    Attributes</span>
</span><span id="MSPeakCalculation-40"><a href="#MSPeakCalculation-40"><span class="linenos">  40</span></a><span class="sd">    ----------</span>
</span><span id="MSPeakCalculation-41"><a href="#MSPeakCalculation-41"><span class="linenos">  41</span></a><span class="sd">    _ms_parent : MSParent</span>
</span><span id="MSPeakCalculation-42"><a href="#MSPeakCalculation-42"><span class="linenos">  42</span></a><span class="sd">        The parent MSParent object associated with the MSPeakCalculation object.</span>
</span><span id="MSPeakCalculation-43"><a href="#MSPeakCalculation-43"><span class="linenos">  43</span></a><span class="sd">    mz_exp : float</span>
</span><span id="MSPeakCalculation-44"><a href="#MSPeakCalculation-44"><span class="linenos">  44</span></a><span class="sd">        The experimental m/z value of the peak.</span>
</span><span id="MSPeakCalculation-45"><a href="#MSPeakCalculation-45"><span class="linenos">  45</span></a><span class="sd">    peak_left_index : int</span>
</span><span id="MSPeakCalculation-46"><a href="#MSPeakCalculation-46"><span class="linenos">  46</span></a><span class="sd">        The start scan index of the peak.</span>
</span><span id="MSPeakCalculation-47"><a href="#MSPeakCalculation-47"><span class="linenos">  47</span></a><span class="sd">    peak_right_index : int</span>
</span><span id="MSPeakCalculation-48"><a href="#MSPeakCalculation-48"><span class="linenos">  48</span></a><span class="sd">        The final scan index of the peak.</span>
</span><span id="MSPeakCalculation-49"><a href="#MSPeakCalculation-49"><span class="linenos">  49</span></a><span class="sd">    resolving_power : float</span>
</span><span id="MSPeakCalculation-50"><a href="#MSPeakCalculation-50"><span class="linenos">  50</span></a><span class="sd">        The resolving power of the peak.</span>
</span><span id="MSPeakCalculation-51"><a href="#MSPeakCalculation-51"><span class="linenos">  51</span></a>
</span><span id="MSPeakCalculation-52"><a href="#MSPeakCalculation-52"><span class="linenos">  52</span></a><span class="sd">    Methods</span>
</span><span id="MSPeakCalculation-53"><a href="#MSPeakCalculation-53"><span class="linenos">  53</span></a><span class="sd">    -------</span>
</span><span id="MSPeakCalculation-54"><a href="#MSPeakCalculation-54"><span class="linenos">  54</span></a><span class="sd">    * _calc_kmd(dict_base).</span>
</span><span id="MSPeakCalculation-55"><a href="#MSPeakCalculation-55"><span class="linenos">  55</span></a><span class="sd">        Calculate the Kendrick Mass Defect (KMD) and Kendrick Mass (KM) for a given base formula.</span>
</span><span id="MSPeakCalculation-56"><a href="#MSPeakCalculation-56"><span class="linenos">  56</span></a><span class="sd">    * calc_area().</span>
</span><span id="MSPeakCalculation-57"><a href="#MSPeakCalculation-57"><span class="linenos">  57</span></a><span class="sd">        Calculate the peak area using numpy&#39;s trapezoidal fit.</span>
</span><span id="MSPeakCalculation-58"><a href="#MSPeakCalculation-58"><span class="linenos">  58</span></a><span class="sd">    * fit_peak(mz_extend=6, delta_rp=0, model=&#39;Gaussian&#39;).</span>
</span><span id="MSPeakCalculation-59"><a href="#MSPeakCalculation-59"><span class="linenos">  59</span></a><span class="sd">        Perform lineshape analysis on a peak using lmfit module.</span>
</span><span id="MSPeakCalculation-60"><a href="#MSPeakCalculation-60"><span class="linenos">  60</span></a><span class="sd">    * voigt_pso(w, r, yoff, width, loc, a).</span>
</span><span id="MSPeakCalculation-61"><a href="#MSPeakCalculation-61"><span class="linenos">  61</span></a><span class="sd">        Calculate the Voigt function for particle swarm optimization (PSO) fitting.</span>
</span><span id="MSPeakCalculation-62"><a href="#MSPeakCalculation-62"><span class="linenos">  62</span></a><span class="sd">    * objective_pso(x, w, u).</span>
</span><span id="MSPeakCalculation-63"><a href="#MSPeakCalculation-63"><span class="linenos">  63</span></a><span class="sd">        Calculate the objective function for PSO fitting.</span>
</span><span id="MSPeakCalculation-64"><a href="#MSPeakCalculation-64"><span class="linenos">  64</span></a><span class="sd">    * minimize_pso(lower, upper, w, u).</span>
</span><span id="MSPeakCalculation-65"><a href="#MSPeakCalculation-65"><span class="linenos">  65</span></a><span class="sd">        Minimize the objective function using the particle swarm optimization algorithm.</span>
</span><span id="MSPeakCalculation-66"><a href="#MSPeakCalculation-66"><span class="linenos">  66</span></a><span class="sd">    * fit_peak_pso(mz_extend=6, upsample_multiplier=5).</span>
</span><span id="MSPeakCalculation-67"><a href="#MSPeakCalculation-67"><span class="linenos">  67</span></a><span class="sd">        Perform lineshape analysis on a peak using particle swarm optimization (PSO) fitting.</span>
</span><span id="MSPeakCalculation-68"><a href="#MSPeakCalculation-68"><span class="linenos">  68</span></a><span class="sd">    * voigt(oversample_multiplier=1, delta_rp=0, mz_overlay=1).</span>
</span><span id="MSPeakCalculation-69"><a href="#MSPeakCalculation-69"><span class="linenos">  69</span></a><span class="sd">        [Legacy] Perform voigt lineshape analysis on a peak.</span>
</span><span id="MSPeakCalculation-70"><a href="#MSPeakCalculation-70"><span class="linenos">  70</span></a><span class="sd">    * pseudovoigt(oversample_multiplier=1, delta_rp=0, mz_overlay=1, fraction=0.5).</span>
</span><span id="MSPeakCalculation-71"><a href="#MSPeakCalculation-71"><span class="linenos">  71</span></a><span class="sd">        [Legacy] Perform pseudovoigt lineshape analysis on a peak.</span>
</span><span id="MSPeakCalculation-72"><a href="#MSPeakCalculation-72"><span class="linenos">  72</span></a><span class="sd">    * lorentz(oversample_multiplier=1, delta_rp=0, mz_overlay=1).</span>
</span><span id="MSPeakCalculation-73"><a href="#MSPeakCalculation-73"><span class="linenos">  73</span></a><span class="sd">        [Legacy] Perform lorentz lineshape analysis on a peak.</span>
</span><span id="MSPeakCalculation-74"><a href="#MSPeakCalculation-74"><span class="linenos">  74</span></a><span class="sd">    * gaussian(oversample_multiplier=1, delta_rp=0, mz_overlay=1).</span>
</span><span id="MSPeakCalculation-75"><a href="#MSPeakCalculation-75"><span class="linenos">  75</span></a><span class="sd">        [Legacy] Perform gaussian lineshape analysis on a peak.</span>
</span><span id="MSPeakCalculation-76"><a href="#MSPeakCalculation-76"><span class="linenos">  76</span></a><span class="sd">    * get_mz_domain(oversample_multiplier, mz_overlay).</span>
</span><span id="MSPeakCalculation-77"><a href="#MSPeakCalculation-77"><span class="linenos">  77</span></a><span class="sd">        [Legacy] Resample/interpolate datapoints for lineshape analysis.</span>
</span><span id="MSPeakCalculation-78"><a href="#MSPeakCalculation-78"><span class="linenos">  78</span></a><span class="sd">    * number_possible_assignments().</span>
</span><span id="MSPeakCalculation-79"><a href="#MSPeakCalculation-79"><span class="linenos">  79</span></a><span class="sd">        Return the number of possible molecular formula assignments for the peak.</span>
</span><span id="MSPeakCalculation-80"><a href="#MSPeakCalculation-80"><span class="linenos">  80</span></a><span class="sd">    * molecular_formula_lowest_error().</span>
</span><span id="MSPeakCalculation-81"><a href="#MSPeakCalculation-81"><span class="linenos">  81</span></a><span class="sd">        Return the molecular formula with the smallest absolute mz error.</span>
</span><span id="MSPeakCalculation-82"><a href="#MSPeakCalculation-82"><span class="linenos">  82</span></a><span class="sd">    * molecular_formula_highest_prob_score().</span>
</span><span id="MSPeakCalculation-83"><a href="#MSPeakCalculation-83"><span class="linenos">  83</span></a><span class="sd">        Return the molecular formula with the highest confidence score.</span>
</span><span id="MSPeakCalculation-84"><a href="#MSPeakCalculation-84"><span class="linenos">  84</span></a><span class="sd">    * molecular_formula_earth_filter(lowest_error=True).</span>
</span><span id="MSPeakCalculation-85"><a href="#MSPeakCalculation-85"><span class="linenos">  85</span></a><span class="sd">        Filter molecular formula using the &#39;Earth&#39; filter.</span>
</span><span id="MSPeakCalculation-86"><a href="#MSPeakCalculation-86"><span class="linenos">  86</span></a><span class="sd">    * molecular_formula_water_filter(lowest_error=True).</span>
</span><span id="MSPeakCalculation-87"><a href="#MSPeakCalculation-87"><span class="linenos">  87</span></a><span class="sd">        Filter molecular formula using the &#39;Water&#39; filter.</span>
</span><span id="MSPeakCalculation-88"><a href="#MSPeakCalculation-88"><span class="linenos">  88</span></a><span class="sd">    * molecular_formula_air_filter(lowest_error=True).</span>
</span><span id="MSPeakCalculation-89"><a href="#MSPeakCalculation-89"><span class="linenos">  89</span></a><span class="sd">        Filter molecular formula using the &#39;Air&#39; filter.</span>
</span><span id="MSPeakCalculation-90"><a href="#MSPeakCalculation-90"><span class="linenos">  90</span></a><span class="sd">    * cia_score_S_P_error().</span>
</span><span id="MSPeakCalculation-91"><a href="#MSPeakCalculation-91"><span class="linenos">  91</span></a><span class="sd">        Compound Identification Algorithm SP Error - Assignment Filter.</span>
</span><span id="MSPeakCalculation-92"><a href="#MSPeakCalculation-92"><span class="linenos">  92</span></a><span class="sd">    * cia_score_N_S_P_error().</span>
</span><span id="MSPeakCalculation-93"><a href="#MSPeakCalculation-93"><span class="linenos">  93</span></a><span class="sd">        Compound Identification Algorithm NSP Error - Assignment Filter.</span>
</span><span id="MSPeakCalculation-94"><a href="#MSPeakCalculation-94"><span class="linenos">  94</span></a>
</span><span id="MSPeakCalculation-95"><a href="#MSPeakCalculation-95"><span class="linenos">  95</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-96"><a href="#MSPeakCalculation-96"><span class="linenos">  96</span></a>
</span><span id="MSPeakCalculation-97"><a href="#MSPeakCalculation-97"><span class="linenos">  97</span></a>    <span class="k">def</span> <span class="nf">_calc_kmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_base</span><span class="p">):</span>
</span><span id="MSPeakCalculation-98"><a href="#MSPeakCalculation-98"><span class="linenos">  98</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the Kendrick Mass Defect (KMD) and Kendrick Mass (KM) for a given base formula</span>
</span><span id="MSPeakCalculation-99"><a href="#MSPeakCalculation-99"><span class="linenos">  99</span></a>
</span><span id="MSPeakCalculation-100"><a href="#MSPeakCalculation-100"><span class="linenos"> 100</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation-101"><a href="#MSPeakCalculation-101"><span class="linenos"> 101</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-102"><a href="#MSPeakCalculation-102"><span class="linenos"> 102</span></a><span class="sd">        dict_base : dict</span>
</span><span id="MSPeakCalculation-103"><a href="#MSPeakCalculation-103"><span class="linenos"> 103</span></a><span class="sd">            dictionary with the base formula to be used in the calculation</span>
</span><span id="MSPeakCalculation-104"><a href="#MSPeakCalculation-104"><span class="linenos"> 104</span></a><span class="sd">            Default is CH2, e.g.</span>
</span><span id="MSPeakCalculation-105"><a href="#MSPeakCalculation-105"><span class="linenos"> 105</span></a><span class="sd">                dict_base = {&quot;C&quot;: 1, &quot;H&quot;: 2}</span>
</span><span id="MSPeakCalculation-106"><a href="#MSPeakCalculation-106"><span class="linenos"> 106</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-107"><a href="#MSPeakCalculation-107"><span class="linenos"> 107</span></a>
</span><span id="MSPeakCalculation-108"><a href="#MSPeakCalculation-108"><span class="linenos"> 108</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="p">:</span>
</span><span id="MSPeakCalculation-109"><a href="#MSPeakCalculation-109"><span class="linenos"> 109</span></a>            <span class="c1"># msPeak obj does have a ms object parent</span>
</span><span id="MSPeakCalculation-110"><a href="#MSPeakCalculation-110"><span class="linenos"> 110</span></a>            <span class="n">kendrick_rounding_method</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MSPeakCalculation-111"><a href="#MSPeakCalculation-111"><span class="linenos"> 111</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mspeaks_settings</span><span class="o">.</span><span class="n">kendrick_rounding_method</span>
</span><span id="MSPeakCalculation-112"><a href="#MSPeakCalculation-112"><span class="linenos"> 112</span></a>            <span class="p">)</span>  <span class="c1"># rounding method can be one of floor, ceil or round</span>
</span><span id="MSPeakCalculation-113"><a href="#MSPeakCalculation-113"><span class="linenos"> 113</span></a>            <span class="c1"># msPeak obj does not have a ms object parent</span>
</span><span id="MSPeakCalculation-114"><a href="#MSPeakCalculation-114"><span class="linenos"> 114</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-115"><a href="#MSPeakCalculation-115"><span class="linenos"> 115</span></a>            <span class="n">kendrick_rounding_method</span> <span class="o">=</span> <span class="n">MSParameters</span><span class="o">.</span><span class="n">ms_peak</span><span class="o">.</span><span class="n">kendrick_rounding_method</span>
</span><span id="MSPeakCalculation-116"><a href="#MSPeakCalculation-116"><span class="linenos"> 116</span></a>
</span><span id="MSPeakCalculation-117"><a href="#MSPeakCalculation-117"><span class="linenos"> 117</span></a>        <span class="n">mass</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MSPeakCalculation-118"><a href="#MSPeakCalculation-118"><span class="linenos"> 118</span></a>        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">dict_base</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="MSPeakCalculation-119"><a href="#MSPeakCalculation-119"><span class="linenos"> 119</span></a>            <span class="n">mass</span> <span class="o">+=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">atomic_masses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span> <span class="o">*</span> <span class="n">dict_base</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
</span><span id="MSPeakCalculation-120"><a href="#MSPeakCalculation-120"><span class="linenos"> 120</span></a>
</span><span id="MSPeakCalculation-121"><a href="#MSPeakCalculation-121"><span class="linenos"> 121</span></a>        <span class="n">kendrick_mass</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span> <span class="o">/</span> <span class="n">mass</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span>
</span><span id="MSPeakCalculation-122"><a href="#MSPeakCalculation-122"><span class="linenos"> 122</span></a>
</span><span id="MSPeakCalculation-123"><a href="#MSPeakCalculation-123"><span class="linenos"> 123</span></a>        <span class="k">if</span> <span class="n">kendrick_rounding_method</span> <span class="o">==</span> <span class="s2">&quot;ceil&quot;</span><span class="p">:</span>
</span><span id="MSPeakCalculation-124"><a href="#MSPeakCalculation-124"><span class="linenos"> 124</span></a>            <span class="n">nominal_km</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="n">kendrick_mass</span><span class="p">)</span>
</span><span id="MSPeakCalculation-125"><a href="#MSPeakCalculation-125"><span class="linenos"> 125</span></a>
</span><span id="MSPeakCalculation-126"><a href="#MSPeakCalculation-126"><span class="linenos"> 126</span></a>        <span class="k">elif</span> <span class="n">kendrick_rounding_method</span> <span class="o">==</span> <span class="s2">&quot;round&quot;</span><span class="p">:</span>
</span><span id="MSPeakCalculation-127"><a href="#MSPeakCalculation-127"><span class="linenos"> 127</span></a>            <span class="n">nominal_km</span> <span class="o">=</span> <span class="n">rint</span><span class="p">(</span><span class="n">kendrick_mass</span><span class="p">)</span>
</span><span id="MSPeakCalculation-128"><a href="#MSPeakCalculation-128"><span class="linenos"> 128</span></a>
</span><span id="MSPeakCalculation-129"><a href="#MSPeakCalculation-129"><span class="linenos"> 129</span></a>        <span class="k">elif</span> <span class="n">kendrick_rounding_method</span> <span class="o">==</span> <span class="s2">&quot;floor&quot;</span><span class="p">:</span>
</span><span id="MSPeakCalculation-130"><a href="#MSPeakCalculation-130"><span class="linenos"> 130</span></a>            <span class="n">nominal_km</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">kendrick_mass</span><span class="p">)</span>
</span><span id="MSPeakCalculation-131"><a href="#MSPeakCalculation-131"><span class="linenos"> 131</span></a>
</span><span id="MSPeakCalculation-132"><a href="#MSPeakCalculation-132"><span class="linenos"> 132</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-133"><a href="#MSPeakCalculation-133"><span class="linenos"> 133</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="MSPeakCalculation-134"><a href="#MSPeakCalculation-134"><span class="linenos"> 134</span></a>                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> method was not implemented, please refer to corems.ms_peak.calc.MSPeakCalc Class&quot;</span>
</span><span id="MSPeakCalculation-135"><a href="#MSPeakCalculation-135"><span class="linenos"> 135</span></a>                <span class="o">%</span> <span class="n">kendrick_rounding_method</span>
</span><span id="MSPeakCalculation-136"><a href="#MSPeakCalculation-136"><span class="linenos"> 136</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-137"><a href="#MSPeakCalculation-137"><span class="linenos"> 137</span></a>
</span><span id="MSPeakCalculation-138"><a href="#MSPeakCalculation-138"><span class="linenos"> 138</span></a>        <span class="n">kmd</span> <span class="o">=</span> <span class="n">nominal_km</span> <span class="o">-</span> <span class="n">kendrick_mass</span>
</span><span id="MSPeakCalculation-139"><a href="#MSPeakCalculation-139"><span class="linenos"> 139</span></a>
</span><span id="MSPeakCalculation-140"><a href="#MSPeakCalculation-140"><span class="linenos"> 140</span></a>        <span class="c1"># kmd = (nominal_km - km) * 1</span>
</span><span id="MSPeakCalculation-141"><a href="#MSPeakCalculation-141"><span class="linenos"> 141</span></a>        <span class="c1"># kmd = round(kmd,0)</span>
</span><span id="MSPeakCalculation-142"><a href="#MSPeakCalculation-142"><span class="linenos"> 142</span></a>
</span><span id="MSPeakCalculation-143"><a href="#MSPeakCalculation-143"><span class="linenos"> 143</span></a>        <span class="k">return</span> <span class="n">kmd</span><span class="p">,</span> <span class="n">kendrick_mass</span><span class="p">,</span> <span class="n">nominal_km</span>
</span><span id="MSPeakCalculation-144"><a href="#MSPeakCalculation-144"><span class="linenos"> 144</span></a>
</span><span id="MSPeakCalculation-145"><a href="#MSPeakCalculation-145"><span class="linenos"> 145</span></a>    <span class="k">def</span> <span class="nf">calc_area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MSPeakCalculation-146"><a href="#MSPeakCalculation-146"><span class="linenos"> 146</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the peak area using numpy&#39;s trapezoidal fit</span>
</span><span id="MSPeakCalculation-147"><a href="#MSPeakCalculation-147"><span class="linenos"> 147</span></a>
</span><span id="MSPeakCalculation-148"><a href="#MSPeakCalculation-148"><span class="linenos"> 148</span></a><span class="sd">        uses provided mz_domain to accurately integrate areas independent of digital resolution</span>
</span><span id="MSPeakCalculation-149"><a href="#MSPeakCalculation-149"><span class="linenos"> 149</span></a>
</span><span id="MSPeakCalculation-150"><a href="#MSPeakCalculation-150"><span class="linenos"> 150</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation-151"><a href="#MSPeakCalculation-151"><span class="linenos"> 151</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation-152"><a href="#MSPeakCalculation-152"><span class="linenos"> 152</span></a><span class="sd">        float</span>
</span><span id="MSPeakCalculation-153"><a href="#MSPeakCalculation-153"><span class="linenos"> 153</span></a><span class="sd">            peak area</span>
</span><span id="MSPeakCalculation-154"><a href="#MSPeakCalculation-154"><span class="linenos"> 154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-155"><a href="#MSPeakCalculation-155"><span class="linenos"> 155</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span><span class="p">:</span>
</span><span id="MSPeakCalculation-156"><a href="#MSPeakCalculation-156"><span class="linenos"> 156</span></a>            <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">abundance_profile</span><span class="p">[</span>
</span><span id="MSPeakCalculation-157"><a href="#MSPeakCalculation-157"><span class="linenos"> 157</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span>
</span><span id="MSPeakCalculation-158"><a href="#MSPeakCalculation-158"><span class="linenos"> 158</span></a>            <span class="p">]</span>
</span><span id="MSPeakCalculation-159"><a href="#MSPeakCalculation-159"><span class="linenos"> 159</span></a>            <span class="n">xx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">[</span>
</span><span id="MSPeakCalculation-160"><a href="#MSPeakCalculation-160"><span class="linenos"> 160</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span>
</span><span id="MSPeakCalculation-161"><a href="#MSPeakCalculation-161"><span class="linenos"> 161</span></a>            <span class="p">]</span>
</span><span id="MSPeakCalculation-162"><a href="#MSPeakCalculation-162"><span class="linenos"> 162</span></a>            <span class="c1"># check if the axis is high to low m/z or not. if its MSFromFreq its high mz first, if its from Profile, its low mz first</span>
</span><span id="MSPeakCalculation-163"><a href="#MSPeakCalculation-163"><span class="linenos"> 163</span></a>            <span class="k">if</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="MSPeakCalculation-164"><a href="#MSPeakCalculation-164"><span class="linenos"> 164</span></a>                <span class="n">xx</span> <span class="o">=</span> <span class="n">flip</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
</span><span id="MSPeakCalculation-165"><a href="#MSPeakCalculation-165"><span class="linenos"> 165</span></a>                <span class="n">yy</span> <span class="o">=</span> <span class="n">flip</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
</span><span id="MSPeakCalculation-166"><a href="#MSPeakCalculation-166"><span class="linenos"> 166</span></a>            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">trapz</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">))</span>
</span><span id="MSPeakCalculation-167"><a href="#MSPeakCalculation-167"><span class="linenos"> 167</span></a>
</span><span id="MSPeakCalculation-168"><a href="#MSPeakCalculation-168"><span class="linenos"> 168</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-169"><a href="#MSPeakCalculation-169"><span class="linenos"> 169</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="MSPeakCalculation-170"><a href="#MSPeakCalculation-170"><span class="linenos"> 170</span></a>                <span class="s2">&quot;Peak Area Calculation for m/z </span><span class="si">{}</span><span class="s2"> has failed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">)</span>
</span><span id="MSPeakCalculation-171"><a href="#MSPeakCalculation-171"><span class="linenos"> 171</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-172"><a href="#MSPeakCalculation-172"><span class="linenos"> 172</span></a>            <span class="k">return</span> <span class="n">nan</span>
</span><span id="MSPeakCalculation-173"><a href="#MSPeakCalculation-173"><span class="linenos"> 173</span></a>
</span><span id="MSPeakCalculation-174"><a href="#MSPeakCalculation-174"><span class="linenos"> 174</span></a>    <span class="k">def</span> <span class="nf">fit_peak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz_extend</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;Gaussian&quot;</span><span class="p">):</span>
</span><span id="MSPeakCalculation-175"><a href="#MSPeakCalculation-175"><span class="linenos"> 175</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Lineshape analysis on a peak using lmfit module.</span>
</span><span id="MSPeakCalculation-176"><a href="#MSPeakCalculation-176"><span class="linenos"> 176</span></a>
</span><span id="MSPeakCalculation-177"><a href="#MSPeakCalculation-177"><span class="linenos"> 177</span></a><span class="sd">        Model and fit peak lineshape by defined function - using lmfit module</span>
</span><span id="MSPeakCalculation-178"><a href="#MSPeakCalculation-178"><span class="linenos"> 178</span></a><span class="sd">        Does not oversample/resample/interpolate data points</span>
</span><span id="MSPeakCalculation-179"><a href="#MSPeakCalculation-179"><span class="linenos"> 179</span></a><span class="sd">        Better to go back to time domain and perform more zero filling - if possible.</span>
</span><span id="MSPeakCalculation-180"><a href="#MSPeakCalculation-180"><span class="linenos"> 180</span></a>
</span><span id="MSPeakCalculation-181"><a href="#MSPeakCalculation-181"><span class="linenos"> 181</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation-182"><a href="#MSPeakCalculation-182"><span class="linenos"> 182</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-183"><a href="#MSPeakCalculation-183"><span class="linenos"> 183</span></a><span class="sd">        mz_extend : int</span>
</span><span id="MSPeakCalculation-184"><a href="#MSPeakCalculation-184"><span class="linenos"> 184</span></a><span class="sd">            extra points left and right of peak definition to include in fitting</span>
</span><span id="MSPeakCalculation-185"><a href="#MSPeakCalculation-185"><span class="linenos"> 185</span></a><span class="sd">        delta_rp : float</span>
</span><span id="MSPeakCalculation-186"><a href="#MSPeakCalculation-186"><span class="linenos"> 186</span></a><span class="sd">            delta resolving power to add to resolving power</span>
</span><span id="MSPeakCalculation-187"><a href="#MSPeakCalculation-187"><span class="linenos"> 187</span></a><span class="sd">        model : str</span>
</span><span id="MSPeakCalculation-188"><a href="#MSPeakCalculation-188"><span class="linenos"> 188</span></a><span class="sd">            Type of lineshape model to use.</span>
</span><span id="MSPeakCalculation-189"><a href="#MSPeakCalculation-189"><span class="linenos"> 189</span></a><span class="sd">            Models allowed: Gaussian, Lorentz, Voigt</span>
</span><span id="MSPeakCalculation-190"><a href="#MSPeakCalculation-190"><span class="linenos"> 190</span></a>
</span><span id="MSPeakCalculation-191"><a href="#MSPeakCalculation-191"><span class="linenos"> 191</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation-192"><a href="#MSPeakCalculation-192"><span class="linenos"> 192</span></a><span class="sd">        -----</span>
</span><span id="MSPeakCalculation-193"><a href="#MSPeakCalculation-193"><span class="linenos"> 193</span></a><span class="sd">        mz_domain : ndarray</span>
</span><span id="MSPeakCalculation-194"><a href="#MSPeakCalculation-194"><span class="linenos"> 194</span></a><span class="sd">            x-axis domain for fit</span>
</span><span id="MSPeakCalculation-195"><a href="#MSPeakCalculation-195"><span class="linenos"> 195</span></a><span class="sd">        fit_peak : lmfit object</span>
</span><span id="MSPeakCalculation-196"><a href="#MSPeakCalculation-196"><span class="linenos"> 196</span></a><span class="sd">            fit results object from lmfit module</span>
</span><span id="MSPeakCalculation-197"><a href="#MSPeakCalculation-197"><span class="linenos"> 197</span></a>
</span><span id="MSPeakCalculation-198"><a href="#MSPeakCalculation-198"><span class="linenos"> 198</span></a><span class="sd">        Notes</span>
</span><span id="MSPeakCalculation-199"><a href="#MSPeakCalculation-199"><span class="linenos"> 199</span></a><span class="sd">        -----</span>
</span><span id="MSPeakCalculation-200"><a href="#MSPeakCalculation-200"><span class="linenos"> 200</span></a><span class="sd">        Returns the calculated mz domain, initial defined abundance profile, and the fit peak results object from lmfit module</span>
</span><span id="MSPeakCalculation-201"><a href="#MSPeakCalculation-201"><span class="linenos"> 201</span></a><span class="sd">        mz_extend here extends the x-axis domain so that we have sufficient points either side of the apex to fit.</span>
</span><span id="MSPeakCalculation-202"><a href="#MSPeakCalculation-202"><span class="linenos"> 202</span></a><span class="sd">        Takes about 10ms per peak</span>
</span><span id="MSPeakCalculation-203"><a href="#MSPeakCalculation-203"><span class="linenos"> 203</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-204"><a href="#MSPeakCalculation-204"><span class="linenos"> 204</span></a>        <span class="n">start_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MSPeakCalculation-205"><a href="#MSPeakCalculation-205"><span class="linenos"> 205</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">-</span> <span class="n">mz_extend</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="MSPeakCalculation-206"><a href="#MSPeakCalculation-206"><span class="linenos"> 206</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation-207"><a href="#MSPeakCalculation-207"><span class="linenos"> 207</span></a>        <span class="n">final_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MSPeakCalculation-208"><a href="#MSPeakCalculation-208"><span class="linenos"> 208</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">+</span> <span class="n">mz_extend</span>
</span><span id="MSPeakCalculation-209"><a href="#MSPeakCalculation-209"><span class="linenos"> 209</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">)</span>
</span><span id="MSPeakCalculation-210"><a href="#MSPeakCalculation-210"><span class="linenos"> 210</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span>
</span><span id="MSPeakCalculation-211"><a href="#MSPeakCalculation-211"><span class="linenos"> 211</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation-212"><a href="#MSPeakCalculation-212"><span class="linenos"> 212</span></a>
</span><span id="MSPeakCalculation-213"><a href="#MSPeakCalculation-213"><span class="linenos"> 213</span></a>        <span class="c1"># check if MSPeak contains the resolving power info</span>
</span><span id="MSPeakCalculation-214"><a href="#MSPeakCalculation-214"><span class="linenos"> 214</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="MSPeakCalculation-215"><a href="#MSPeakCalculation-215"><span class="linenos"> 215</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="MSPeakCalculation-216"><a href="#MSPeakCalculation-216"><span class="linenos"> 216</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span> <span class="o">+</span> <span class="n">delta_rp</span><span class="p">)</span>
</span><span id="MSPeakCalculation-217"><a href="#MSPeakCalculation-217"><span class="linenos"> 217</span></a>
</span><span id="MSPeakCalculation-218"><a href="#MSPeakCalculation-218"><span class="linenos"> 218</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">final_index</span><span class="p">]</span>
</span><span id="MSPeakCalculation-219"><a href="#MSPeakCalculation-219"><span class="linenos"> 219</span></a>            <span class="n">abundance_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">abundance_profile</span><span class="p">[</span>
</span><span id="MSPeakCalculation-220"><a href="#MSPeakCalculation-220"><span class="linenos"> 220</span></a>                <span class="n">start_index</span><span class="p">:</span><span class="n">final_index</span>
</span><span id="MSPeakCalculation-221"><a href="#MSPeakCalculation-221"><span class="linenos"> 221</span></a>            <span class="p">]</span>
</span><span id="MSPeakCalculation-222"><a href="#MSPeakCalculation-222"><span class="linenos"> 222</span></a>
</span><span id="MSPeakCalculation-223"><a href="#MSPeakCalculation-223"><span class="linenos"> 223</span></a>            <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Gaussian&quot;</span><span class="p">:</span>
</span><span id="MSPeakCalculation-224"><a href="#MSPeakCalculation-224"><span class="linenos"> 224</span></a>                <span class="c1"># stardard deviation</span>
</span><span id="MSPeakCalculation-225"><a href="#MSPeakCalculation-225"><span class="linenos"> 225</span></a>                <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
</span><span id="MSPeakCalculation-226"><a href="#MSPeakCalculation-226"><span class="linenos"> 226</span></a>                <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="MSPeakCalculation-227"><a href="#MSPeakCalculation-227"><span class="linenos"> 227</span></a>                <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GaussianModel</span><span class="p">()</span>
</span><span id="MSPeakCalculation-228"><a href="#MSPeakCalculation-228"><span class="linenos"> 228</span></a>                <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="MSPeakCalculation-229"><a href="#MSPeakCalculation-229"><span class="linenos"> 229</span></a>                    <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="MSPeakCalculation-230"><a href="#MSPeakCalculation-230"><span class="linenos"> 230</span></a>                <span class="p">)</span>
</span><span id="MSPeakCalculation-231"><a href="#MSPeakCalculation-231"><span class="linenos"> 231</span></a>
</span><span id="MSPeakCalculation-232"><a href="#MSPeakCalculation-232"><span class="linenos"> 232</span></a>            <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Lorentz&quot;</span><span class="p">:</span>
</span><span id="MSPeakCalculation-233"><a href="#MSPeakCalculation-233"><span class="linenos"> 233</span></a>                <span class="c1"># stardard deviation</span>
</span><span id="MSPeakCalculation-234"><a href="#MSPeakCalculation-234"><span class="linenos"> 234</span></a>                <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="MSPeakCalculation-235"><a href="#MSPeakCalculation-235"><span class="linenos"> 235</span></a>                <span class="n">amplitude</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="MSPeakCalculation-236"><a href="#MSPeakCalculation-236"><span class="linenos"> 236</span></a>                <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">LorentzianModel</span><span class="p">()</span>
</span><span id="MSPeakCalculation-237"><a href="#MSPeakCalculation-237"><span class="linenos"> 237</span></a>                <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="MSPeakCalculation-238"><a href="#MSPeakCalculation-238"><span class="linenos"> 238</span></a>                    <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="MSPeakCalculation-239"><a href="#MSPeakCalculation-239"><span class="linenos"> 239</span></a>                <span class="p">)</span>
</span><span id="MSPeakCalculation-240"><a href="#MSPeakCalculation-240"><span class="linenos"> 240</span></a>
</span><span id="MSPeakCalculation-241"><a href="#MSPeakCalculation-241"><span class="linenos"> 241</span></a>            <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Voigt&quot;</span><span class="p">:</span>
</span><span id="MSPeakCalculation-242"><a href="#MSPeakCalculation-242"><span class="linenos"> 242</span></a>                <span class="c1"># stardard deviation</span>
</span><span id="MSPeakCalculation-243"><a href="#MSPeakCalculation-243"><span class="linenos"> 243</span></a>                <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="mf">3.6013</span>
</span><span id="MSPeakCalculation-244"><a href="#MSPeakCalculation-244"><span class="linenos"> 244</span></a>                <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="MSPeakCalculation-245"><a href="#MSPeakCalculation-245"><span class="linenos"> 245</span></a>                <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">VoigtModel</span><span class="p">()</span>
</span><span id="MSPeakCalculation-246"><a href="#MSPeakCalculation-246"><span class="linenos"> 246</span></a>                <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="MSPeakCalculation-247"><a href="#MSPeakCalculation-247"><span class="linenos"> 247</span></a>                    <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="MSPeakCalculation-248"><a href="#MSPeakCalculation-248"><span class="linenos"> 248</span></a>                <span class="p">)</span>
</span><span id="MSPeakCalculation-249"><a href="#MSPeakCalculation-249"><span class="linenos"> 249</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-250"><a href="#MSPeakCalculation-250"><span class="linenos"> 250</span></a>                <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s2">&quot;model lineshape not known or defined&quot;</span><span class="p">)</span>
</span><span id="MSPeakCalculation-251"><a href="#MSPeakCalculation-251"><span class="linenos"> 251</span></a>
</span><span id="MSPeakCalculation-252"><a href="#MSPeakCalculation-252"><span class="linenos"> 252</span></a>            <span class="c1"># calc_abundance = model.eval(params=params, x=mz_domain) #Same as initial fit, returned in fit_peak object</span>
</span><span id="MSPeakCalculation-253"><a href="#MSPeakCalculation-253"><span class="linenos"> 253</span></a>            <span class="n">fit_peak</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">abundance_domain</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mz_domain</span><span class="p">)</span>
</span><span id="MSPeakCalculation-254"><a href="#MSPeakCalculation-254"><span class="linenos"> 254</span></a>            <span class="k">return</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">fit_peak</span>
</span><span id="MSPeakCalculation-255"><a href="#MSPeakCalculation-255"><span class="linenos"> 255</span></a>
</span><span id="MSPeakCalculation-256"><a href="#MSPeakCalculation-256"><span class="linenos"> 256</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-257"><a href="#MSPeakCalculation-257"><span class="linenos"> 257</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="MSPeakCalculation-258"><a href="#MSPeakCalculation-258"><span class="linenos"> 258</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="MSPeakCalculation-259"><a href="#MSPeakCalculation-259"><span class="linenos"> 259</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-260"><a href="#MSPeakCalculation-260"><span class="linenos"> 260</span></a>
</span><span id="MSPeakCalculation-261"><a href="#MSPeakCalculation-261"><span class="linenos"> 261</span></a>    <span class="k">def</span> <span class="nf">voigt_pso</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">yoff</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
</span><span id="MSPeakCalculation-262"><a href="#MSPeakCalculation-262"><span class="linenos"> 262</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Voigt function for particle swarm optimisation (PSO) fitting</span>
</span><span id="MSPeakCalculation-263"><a href="#MSPeakCalculation-263"><span class="linenos"> 263</span></a>
</span><span id="MSPeakCalculation-264"><a href="#MSPeakCalculation-264"><span class="linenos"> 264</span></a><span class="sd">        From https://github.com/pnnl/nmrfit/blob/master/nmrfit/equations.py.</span>
</span><span id="MSPeakCalculation-265"><a href="#MSPeakCalculation-265"><span class="linenos"> 265</span></a><span class="sd">        Calculates a Voigt function over w based on the relevant properties of the distribution.</span>
</span><span id="MSPeakCalculation-266"><a href="#MSPeakCalculation-266"><span class="linenos"> 266</span></a>
</span><span id="MSPeakCalculation-267"><a href="#MSPeakCalculation-267"><span class="linenos"> 267</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation-268"><a href="#MSPeakCalculation-268"><span class="linenos"> 268</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-269"><a href="#MSPeakCalculation-269"><span class="linenos"> 269</span></a><span class="sd">        w : ndarray</span>
</span><span id="MSPeakCalculation-270"><a href="#MSPeakCalculation-270"><span class="linenos"> 270</span></a><span class="sd">            Array over which the Voigt function will be evaluated.</span>
</span><span id="MSPeakCalculation-271"><a href="#MSPeakCalculation-271"><span class="linenos"> 271</span></a><span class="sd">        r : float</span>
</span><span id="MSPeakCalculation-272"><a href="#MSPeakCalculation-272"><span class="linenos"> 272</span></a><span class="sd">            Ratio between the Guassian and Lorentzian functions.</span>
</span><span id="MSPeakCalculation-273"><a href="#MSPeakCalculation-273"><span class="linenos"> 273</span></a><span class="sd">        yoff : float</span>
</span><span id="MSPeakCalculation-274"><a href="#MSPeakCalculation-274"><span class="linenos"> 274</span></a><span class="sd">            Y-offset of the Voigt function.</span>
</span><span id="MSPeakCalculation-275"><a href="#MSPeakCalculation-275"><span class="linenos"> 275</span></a><span class="sd">        width : float</span>
</span><span id="MSPeakCalculation-276"><a href="#MSPeakCalculation-276"><span class="linenos"> 276</span></a><span class="sd">            The width of the Voigt function.</span>
</span><span id="MSPeakCalculation-277"><a href="#MSPeakCalculation-277"><span class="linenos"> 277</span></a><span class="sd">        loc : float</span>
</span><span id="MSPeakCalculation-278"><a href="#MSPeakCalculation-278"><span class="linenos"> 278</span></a><span class="sd">            Center of the Voigt function.</span>
</span><span id="MSPeakCalculation-279"><a href="#MSPeakCalculation-279"><span class="linenos"> 279</span></a><span class="sd">        a : float</span>
</span><span id="MSPeakCalculation-280"><a href="#MSPeakCalculation-280"><span class="linenos"> 280</span></a><span class="sd">            Area of the Voigt function.</span>
</span><span id="MSPeakCalculation-281"><a href="#MSPeakCalculation-281"><span class="linenos"> 281</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation-282"><a href="#MSPeakCalculation-282"><span class="linenos"> 282</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation-283"><a href="#MSPeakCalculation-283"><span class="linenos"> 283</span></a><span class="sd">        V : ndarray</span>
</span><span id="MSPeakCalculation-284"><a href="#MSPeakCalculation-284"><span class="linenos"> 284</span></a><span class="sd">            Array defining the Voigt function over w.</span>
</span><span id="MSPeakCalculation-285"><a href="#MSPeakCalculation-285"><span class="linenos"> 285</span></a>
</span><span id="MSPeakCalculation-286"><a href="#MSPeakCalculation-286"><span class="linenos"> 286</span></a><span class="sd">        References</span>
</span><span id="MSPeakCalculation-287"><a href="#MSPeakCalculation-287"><span class="linenos"> 287</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-288"><a href="#MSPeakCalculation-288"><span class="linenos"> 288</span></a><span class="sd">        1. https://github.com/pnnl/nmrfit</span>
</span><span id="MSPeakCalculation-289"><a href="#MSPeakCalculation-289"><span class="linenos"> 289</span></a>
</span><span id="MSPeakCalculation-290"><a href="#MSPeakCalculation-290"><span class="linenos"> 290</span></a><span class="sd">        Notes</span>
</span><span id="MSPeakCalculation-291"><a href="#MSPeakCalculation-291"><span class="linenos"> 291</span></a><span class="sd">        -----</span>
</span><span id="MSPeakCalculation-292"><a href="#MSPeakCalculation-292"><span class="linenos"> 292</span></a><span class="sd">        Particle swarm optimisation (PSO) fitting function can be significantly more computationally expensive than lmfit, with more parameters to optimise.</span>
</span><span id="MSPeakCalculation-293"><a href="#MSPeakCalculation-293"><span class="linenos"> 293</span></a>
</span><span id="MSPeakCalculation-294"><a href="#MSPeakCalculation-294"><span class="linenos"> 294</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-295"><a href="#MSPeakCalculation-295"><span class="linenos"> 295</span></a>        <span class="c1"># Lorentzian component</span>
</span><span id="MSPeakCalculation-296"><a href="#MSPeakCalculation-296"><span class="linenos"> 296</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">width</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">w</span> <span class="o">-</span> <span class="n">loc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">width</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="MSPeakCalculation-297"><a href="#MSPeakCalculation-297"><span class="linenos"> 297</span></a>
</span><span id="MSPeakCalculation-298"><a href="#MSPeakCalculation-298"><span class="linenos"> 298</span></a>        <span class="c1"># Gaussian component</span>
</span><span id="MSPeakCalculation-299"><a href="#MSPeakCalculation-299"><span class="linenos"> 299</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MSPeakCalculation-300"><a href="#MSPeakCalculation-300"><span class="linenos"> 300</span></a>            <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span>
</span><span id="MSPeakCalculation-301"><a href="#MSPeakCalculation-301"><span class="linenos"> 301</span></a>            <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">pi</span><span class="p">)</span>
</span><span id="MSPeakCalculation-302"><a href="#MSPeakCalculation-302"><span class="linenos"> 302</span></a>            <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(((</span><span class="n">w</span> <span class="o">-</span> <span class="n">loc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="MSPeakCalculation-303"><a href="#MSPeakCalculation-303"><span class="linenos"> 303</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation-304"><a href="#MSPeakCalculation-304"><span class="linenos"> 304</span></a>
</span><span id="MSPeakCalculation-305"><a href="#MSPeakCalculation-305"><span class="linenos"> 305</span></a>        <span class="c1"># Voigt body</span>
</span><span id="MSPeakCalculation-306"><a href="#MSPeakCalculation-306"><span class="linenos"> 306</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="p">(</span><span class="n">yoff</span> <span class="o">+</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">L</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">G</span><span class="p">)</span>
</span><span id="MSPeakCalculation-307"><a href="#MSPeakCalculation-307"><span class="linenos"> 307</span></a>
</span><span id="MSPeakCalculation-308"><a href="#MSPeakCalculation-308"><span class="linenos"> 308</span></a>        <span class="k">return</span> <span class="n">V</span>
</span><span id="MSPeakCalculation-309"><a href="#MSPeakCalculation-309"><span class="linenos"> 309</span></a>
</span><span id="MSPeakCalculation-310"><a href="#MSPeakCalculation-310"><span class="linenos"> 310</span></a>    <span class="k">def</span> <span class="nf">objective_pso</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
</span><span id="MSPeakCalculation-311"><a href="#MSPeakCalculation-311"><span class="linenos"> 311</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Objective function for particle swarm optimisation (PSO) fitting</span>
</span><span id="MSPeakCalculation-312"><a href="#MSPeakCalculation-312"><span class="linenos"> 312</span></a>
</span><span id="MSPeakCalculation-313"><a href="#MSPeakCalculation-313"><span class="linenos"> 313</span></a><span class="sd">        The objective function used to fit supplied data.  Evaluates sum of squared differences between the fit and the data.</span>
</span><span id="MSPeakCalculation-314"><a href="#MSPeakCalculation-314"><span class="linenos"> 314</span></a>
</span><span id="MSPeakCalculation-315"><a href="#MSPeakCalculation-315"><span class="linenos"> 315</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation-316"><a href="#MSPeakCalculation-316"><span class="linenos"> 316</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-317"><a href="#MSPeakCalculation-317"><span class="linenos"> 317</span></a><span class="sd">        x : list of floats</span>
</span><span id="MSPeakCalculation-318"><a href="#MSPeakCalculation-318"><span class="linenos"> 318</span></a><span class="sd">            Parameter vector.</span>
</span><span id="MSPeakCalculation-319"><a href="#MSPeakCalculation-319"><span class="linenos"> 319</span></a><span class="sd">        w : ndarray</span>
</span><span id="MSPeakCalculation-320"><a href="#MSPeakCalculation-320"><span class="linenos"> 320</span></a><span class="sd">            Array of frequency data.</span>
</span><span id="MSPeakCalculation-321"><a href="#MSPeakCalculation-321"><span class="linenos"> 321</span></a><span class="sd">        u : ndarray</span>
</span><span id="MSPeakCalculation-322"><a href="#MSPeakCalculation-322"><span class="linenos"> 322</span></a><span class="sd">            Array of data to be fit.</span>
</span><span id="MSPeakCalculation-323"><a href="#MSPeakCalculation-323"><span class="linenos"> 323</span></a>
</span><span id="MSPeakCalculation-324"><a href="#MSPeakCalculation-324"><span class="linenos"> 324</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation-325"><a href="#MSPeakCalculation-325"><span class="linenos"> 325</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation-326"><a href="#MSPeakCalculation-326"><span class="linenos"> 326</span></a><span class="sd">        rmse : float</span>
</span><span id="MSPeakCalculation-327"><a href="#MSPeakCalculation-327"><span class="linenos"> 327</span></a><span class="sd">            Root mean square error between the data and fit.</span>
</span><span id="MSPeakCalculation-328"><a href="#MSPeakCalculation-328"><span class="linenos"> 328</span></a>
</span><span id="MSPeakCalculation-329"><a href="#MSPeakCalculation-329"><span class="linenos"> 329</span></a><span class="sd">        References</span>
</span><span id="MSPeakCalculation-330"><a href="#MSPeakCalculation-330"><span class="linenos"> 330</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-331"><a href="#MSPeakCalculation-331"><span class="linenos"> 331</span></a><span class="sd">        1. https://github.com/pnnl/nmrfit</span>
</span><span id="MSPeakCalculation-332"><a href="#MSPeakCalculation-332"><span class="linenos"> 332</span></a>
</span><span id="MSPeakCalculation-333"><a href="#MSPeakCalculation-333"><span class="linenos"> 333</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-334"><a href="#MSPeakCalculation-334"><span class="linenos"> 334</span></a>        <span class="c1"># global parameters</span>
</span><span id="MSPeakCalculation-335"><a href="#MSPeakCalculation-335"><span class="linenos"> 335</span></a>        <span class="n">r</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="MSPeakCalculation-336"><a href="#MSPeakCalculation-336"><span class="linenos"> 336</span></a>        <span class="n">yoff</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MSPeakCalculation-337"><a href="#MSPeakCalculation-337"><span class="linenos"> 337</span></a>
</span><span id="MSPeakCalculation-338"><a href="#MSPeakCalculation-338"><span class="linenos"> 338</span></a>        <span class="c1"># calculate fit for V</span>
</span><span id="MSPeakCalculation-339"><a href="#MSPeakCalculation-339"><span class="linenos"> 339</span></a>        <span class="n">V_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voigt_pso</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">yoff</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</span><span id="MSPeakCalculation-340"><a href="#MSPeakCalculation-340"><span class="linenos"> 340</span></a>
</span><span id="MSPeakCalculation-341"><a href="#MSPeakCalculation-341"><span class="linenos"> 341</span></a>        <span class="c1"># real component RMSE</span>
</span><span id="MSPeakCalculation-342"><a href="#MSPeakCalculation-342"><span class="linenos"> 342</span></a>        <span class="n">rmse</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">square</span><span class="p">((</span><span class="n">u</span> <span class="o">-</span> <span class="n">V_fit</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
</span><span id="MSPeakCalculation-343"><a href="#MSPeakCalculation-343"><span class="linenos"> 343</span></a>
</span><span id="MSPeakCalculation-344"><a href="#MSPeakCalculation-344"><span class="linenos"> 344</span></a>        <span class="c1"># return the total RMSE</span>
</span><span id="MSPeakCalculation-345"><a href="#MSPeakCalculation-345"><span class="linenos"> 345</span></a>        <span class="k">return</span> <span class="n">rmse</span>
</span><span id="MSPeakCalculation-346"><a href="#MSPeakCalculation-346"><span class="linenos"> 346</span></a>
</span><span id="MSPeakCalculation-347"><a href="#MSPeakCalculation-347"><span class="linenos"> 347</span></a>    <span class="k">def</span> <span class="nf">minimize_pso</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
</span><span id="MSPeakCalculation-348"><a href="#MSPeakCalculation-348"><span class="linenos"> 348</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Minimization function for particle swarm optimisation (PSO) fitting</span>
</span><span id="MSPeakCalculation-349"><a href="#MSPeakCalculation-349"><span class="linenos"> 349</span></a>
</span><span id="MSPeakCalculation-350"><a href="#MSPeakCalculation-350"><span class="linenos"> 350</span></a><span class="sd">        Minimizes the objective function using the particle swarm optimization algorithm.</span>
</span><span id="MSPeakCalculation-351"><a href="#MSPeakCalculation-351"><span class="linenos"> 351</span></a><span class="sd">        Minimization function based on defined parameters</span>
</span><span id="MSPeakCalculation-352"><a href="#MSPeakCalculation-352"><span class="linenos"> 352</span></a>
</span><span id="MSPeakCalculation-353"><a href="#MSPeakCalculation-353"><span class="linenos"> 353</span></a>
</span><span id="MSPeakCalculation-354"><a href="#MSPeakCalculation-354"><span class="linenos"> 354</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation-355"><a href="#MSPeakCalculation-355"><span class="linenos"> 355</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-356"><a href="#MSPeakCalculation-356"><span class="linenos"> 356</span></a><span class="sd">        lower : list of floats</span>
</span><span id="MSPeakCalculation-357"><a href="#MSPeakCalculation-357"><span class="linenos"> 357</span></a><span class="sd">            Lower bounds for the parameters.</span>
</span><span id="MSPeakCalculation-358"><a href="#MSPeakCalculation-358"><span class="linenos"> 358</span></a><span class="sd">        upper : list of floats</span>
</span><span id="MSPeakCalculation-359"><a href="#MSPeakCalculation-359"><span class="linenos"> 359</span></a><span class="sd">            Upper bounds for the parameters.</span>
</span><span id="MSPeakCalculation-360"><a href="#MSPeakCalculation-360"><span class="linenos"> 360</span></a><span class="sd">        w : ndarray</span>
</span><span id="MSPeakCalculation-361"><a href="#MSPeakCalculation-361"><span class="linenos"> 361</span></a><span class="sd">            Array of frequency data.</span>
</span><span id="MSPeakCalculation-362"><a href="#MSPeakCalculation-362"><span class="linenos"> 362</span></a><span class="sd">        u : ndarray</span>
</span><span id="MSPeakCalculation-363"><a href="#MSPeakCalculation-363"><span class="linenos"> 363</span></a><span class="sd">            Array of data to be fit.</span>
</span><span id="MSPeakCalculation-364"><a href="#MSPeakCalculation-364"><span class="linenos"> 364</span></a>
</span><span id="MSPeakCalculation-365"><a href="#MSPeakCalculation-365"><span class="linenos"> 365</span></a><span class="sd">        Notes</span>
</span><span id="MSPeakCalculation-366"><a href="#MSPeakCalculation-366"><span class="linenos"> 366</span></a><span class="sd">        -----</span>
</span><span id="MSPeakCalculation-367"><a href="#MSPeakCalculation-367"><span class="linenos"> 367</span></a><span class="sd">        Particle swarm optimisation (PSO) fitting function can be significantly more computationally expensive than lmfit, with more parameters to optimise.</span>
</span><span id="MSPeakCalculation-368"><a href="#MSPeakCalculation-368"><span class="linenos"> 368</span></a><span class="sd">        Current parameters take ~2 seconds per peak.</span>
</span><span id="MSPeakCalculation-369"><a href="#MSPeakCalculation-369"><span class="linenos"> 369</span></a>
</span><span id="MSPeakCalculation-370"><a href="#MSPeakCalculation-370"><span class="linenos"> 370</span></a>
</span><span id="MSPeakCalculation-371"><a href="#MSPeakCalculation-371"><span class="linenos"> 371</span></a><span class="sd">        References</span>
</span><span id="MSPeakCalculation-372"><a href="#MSPeakCalculation-372"><span class="linenos"> 372</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-373"><a href="#MSPeakCalculation-373"><span class="linenos"> 373</span></a><span class="sd">        1. https://github.com/pnnl/nmrfit</span>
</span><span id="MSPeakCalculation-374"><a href="#MSPeakCalculation-374"><span class="linenos"> 374</span></a>
</span><span id="MSPeakCalculation-375"><a href="#MSPeakCalculation-375"><span class="linenos"> 375</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-376"><a href="#MSPeakCalculation-376"><span class="linenos"> 376</span></a>        <span class="c1"># TODO - allow support to pass swarmsize, maxiter, omega, phip, phig parameters.</span>
</span><span id="MSPeakCalculation-377"><a href="#MSPeakCalculation-377"><span class="linenos"> 377</span></a>        <span class="c1"># TODO - Refactor PSO fitting into its own class?</span>
</span><span id="MSPeakCalculation-378"><a href="#MSPeakCalculation-378"><span class="linenos"> 378</span></a>
</span><span id="MSPeakCalculation-379"><a href="#MSPeakCalculation-379"><span class="linenos"> 379</span></a>        <span class="n">xopt</span><span class="p">,</span> <span class="n">fopt</span> <span class="o">=</span> <span class="n">pyswarm</span><span class="o">.</span><span class="n">pso</span><span class="p">(</span>
</span><span id="MSPeakCalculation-380"><a href="#MSPeakCalculation-380"><span class="linenos"> 380</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objective_pso</span><span class="p">,</span>
</span><span id="MSPeakCalculation-381"><a href="#MSPeakCalculation-381"><span class="linenos"> 381</span></a>            <span class="n">lower</span><span class="p">,</span>
</span><span id="MSPeakCalculation-382"><a href="#MSPeakCalculation-382"><span class="linenos"> 382</span></a>            <span class="n">upper</span><span class="p">,</span>
</span><span id="MSPeakCalculation-383"><a href="#MSPeakCalculation-383"><span class="linenos"> 383</span></a>            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">u</span><span class="p">),</span>
</span><span id="MSPeakCalculation-384"><a href="#MSPeakCalculation-384"><span class="linenos"> 384</span></a>            <span class="n">swarmsize</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="MSPeakCalculation-385"><a href="#MSPeakCalculation-385"><span class="linenos"> 385</span></a>            <span class="n">maxiter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
</span><span id="MSPeakCalculation-386"><a href="#MSPeakCalculation-386"><span class="linenos"> 386</span></a>            <span class="n">omega</span><span class="o">=-</span><span class="mf">0.2134</span><span class="p">,</span>
</span><span id="MSPeakCalculation-387"><a href="#MSPeakCalculation-387"><span class="linenos"> 387</span></a>            <span class="n">phip</span><span class="o">=-</span><span class="mf">0.3344</span><span class="p">,</span>
</span><span id="MSPeakCalculation-388"><a href="#MSPeakCalculation-388"><span class="linenos"> 388</span></a>            <span class="n">phig</span><span class="o">=</span><span class="mf">2.3259</span><span class="p">,</span>
</span><span id="MSPeakCalculation-389"><a href="#MSPeakCalculation-389"><span class="linenos"> 389</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation-390"><a href="#MSPeakCalculation-390"><span class="linenos"> 390</span></a>        <span class="k">return</span> <span class="n">xopt</span><span class="p">,</span> <span class="n">fopt</span>
</span><span id="MSPeakCalculation-391"><a href="#MSPeakCalculation-391"><span class="linenos"> 391</span></a>
</span><span id="MSPeakCalculation-392"><a href="#MSPeakCalculation-392"><span class="linenos"> 392</span></a>    <span class="k">def</span> <span class="nf">fit_peak_pso</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz_extend</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">upsample_multiplier</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
</span><span id="MSPeakCalculation-393"><a href="#MSPeakCalculation-393"><span class="linenos"> 393</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Lineshape analysis on a peak using particle swarm optimisation (PSO) fitting</span>
</span><span id="MSPeakCalculation-394"><a href="#MSPeakCalculation-394"><span class="linenos"> 394</span></a>
</span><span id="MSPeakCalculation-395"><a href="#MSPeakCalculation-395"><span class="linenos"> 395</span></a><span class="sd">        Function to fit a Voigt peakshape using particle swarm optimisation (PSO).</span>
</span><span id="MSPeakCalculation-396"><a href="#MSPeakCalculation-396"><span class="linenos"> 396</span></a><span class="sd">        Should return better results than lmfit, but much more computationally expensive</span>
</span><span id="MSPeakCalculation-397"><a href="#MSPeakCalculation-397"><span class="linenos"> 397</span></a>
</span><span id="MSPeakCalculation-398"><a href="#MSPeakCalculation-398"><span class="linenos"> 398</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation-399"><a href="#MSPeakCalculation-399"><span class="linenos"> 399</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-400"><a href="#MSPeakCalculation-400"><span class="linenos"> 400</span></a><span class="sd">        mz_extend : int, optional</span>
</span><span id="MSPeakCalculation-401"><a href="#MSPeakCalculation-401"><span class="linenos"> 401</span></a><span class="sd">            extra points left and right of peak definition to include in fitting. Defaults to 6.</span>
</span><span id="MSPeakCalculation-402"><a href="#MSPeakCalculation-402"><span class="linenos"> 402</span></a><span class="sd">        upsample_multiplier : int, optional</span>
</span><span id="MSPeakCalculation-403"><a href="#MSPeakCalculation-403"><span class="linenos"> 403</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function. Defaults to 5.</span>
</span><span id="MSPeakCalculation-404"><a href="#MSPeakCalculation-404"><span class="linenos"> 404</span></a>
</span><span id="MSPeakCalculation-405"><a href="#MSPeakCalculation-405"><span class="linenos"> 405</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation-406"><a href="#MSPeakCalculation-406"><span class="linenos"> 406</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation-407"><a href="#MSPeakCalculation-407"><span class="linenos"> 407</span></a><span class="sd">        xopt : array</span>
</span><span id="MSPeakCalculation-408"><a href="#MSPeakCalculation-408"><span class="linenos"> 408</span></a><span class="sd">            variables describing the voigt function.</span>
</span><span id="MSPeakCalculation-409"><a href="#MSPeakCalculation-409"><span class="linenos"> 409</span></a><span class="sd">            G/L ratio, width (fwhm), apex (x-axis), area.</span>
</span><span id="MSPeakCalculation-410"><a href="#MSPeakCalculation-410"><span class="linenos"> 410</span></a><span class="sd">            y-axis offset is fixed at 0</span>
</span><span id="MSPeakCalculation-411"><a href="#MSPeakCalculation-411"><span class="linenos"> 411</span></a><span class="sd">        fopt : float</span>
</span><span id="MSPeakCalculation-412"><a href="#MSPeakCalculation-412"><span class="linenos"> 412</span></a><span class="sd">            objective score (rmse)</span>
</span><span id="MSPeakCalculation-413"><a href="#MSPeakCalculation-413"><span class="linenos"> 413</span></a><span class="sd">        psfit : array</span>
</span><span id="MSPeakCalculation-414"><a href="#MSPeakCalculation-414"><span class="linenos"> 414</span></a><span class="sd">            recalculated y values based on function and optimised fit</span>
</span><span id="MSPeakCalculation-415"><a href="#MSPeakCalculation-415"><span class="linenos"> 415</span></a><span class="sd">        psfit_hdp : tuple of arrays</span>
</span><span id="MSPeakCalculation-416"><a href="#MSPeakCalculation-416"><span class="linenos"> 416</span></a><span class="sd">            0 - linspace x-axis upsampled grid</span>
</span><span id="MSPeakCalculation-417"><a href="#MSPeakCalculation-417"><span class="linenos"> 417</span></a><span class="sd">            1 - recalculated y values based on function and upsampled x-axis grid</span>
</span><span id="MSPeakCalculation-418"><a href="#MSPeakCalculation-418"><span class="linenos"> 418</span></a><span class="sd">            Does not change results, but aids in visualisation of the &#39;true&#39; voigt lineshape</span>
</span><span id="MSPeakCalculation-419"><a href="#MSPeakCalculation-419"><span class="linenos"> 419</span></a>
</span><span id="MSPeakCalculation-420"><a href="#MSPeakCalculation-420"><span class="linenos"> 420</span></a><span class="sd">        Notes</span>
</span><span id="MSPeakCalculation-421"><a href="#MSPeakCalculation-421"><span class="linenos"> 421</span></a><span class="sd">        -----</span>
</span><span id="MSPeakCalculation-422"><a href="#MSPeakCalculation-422"><span class="linenos"> 422</span></a><span class="sd">        Particle swarm optimisation (PSO) fitting function can be significantly more computationally expensive than lmfit, with more parameters to optimise.</span>
</span><span id="MSPeakCalculation-423"><a href="#MSPeakCalculation-423"><span class="linenos"> 423</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-424"><a href="#MSPeakCalculation-424"><span class="linenos"> 424</span></a>        <span class="c1"># TODO - Add ability to pass pso args (i.e. swarm size, maxiter, omega, phig, etc)</span>
</span><span id="MSPeakCalculation-425"><a href="#MSPeakCalculation-425"><span class="linenos"> 425</span></a>        <span class="c1"># TODO: fix xopt. Magnitude mode data through CoreMS/Bruker starts at 0 but is noise centered well above 0.</span>
</span><span id="MSPeakCalculation-426"><a href="#MSPeakCalculation-426"><span class="linenos"> 426</span></a>        <span class="c1"># Thermo data is noise reduced by also noise subtracted, so starts at 0</span>
</span><span id="MSPeakCalculation-427"><a href="#MSPeakCalculation-427"><span class="linenos"> 427</span></a>        <span class="c1"># Absorption mode/phased data will have positive and negative components and may not be baseline corrected</span>
</span><span id="MSPeakCalculation-428"><a href="#MSPeakCalculation-428"><span class="linenos"> 428</span></a>
</span><span id="MSPeakCalculation-429"><a href="#MSPeakCalculation-429"><span class="linenos"> 429</span></a>        <span class="n">start_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MSPeakCalculation-430"><a href="#MSPeakCalculation-430"><span class="linenos"> 430</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">-</span> <span class="n">mz_extend</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="MSPeakCalculation-431"><a href="#MSPeakCalculation-431"><span class="linenos"> 431</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation-432"><a href="#MSPeakCalculation-432"><span class="linenos"> 432</span></a>        <span class="n">final_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MSPeakCalculation-433"><a href="#MSPeakCalculation-433"><span class="linenos"> 433</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">+</span> <span class="n">mz_extend</span>
</span><span id="MSPeakCalculation-434"><a href="#MSPeakCalculation-434"><span class="linenos"> 434</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">)</span>
</span><span id="MSPeakCalculation-435"><a href="#MSPeakCalculation-435"><span class="linenos"> 435</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span>
</span><span id="MSPeakCalculation-436"><a href="#MSPeakCalculation-436"><span class="linenos"> 436</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation-437"><a href="#MSPeakCalculation-437"><span class="linenos"> 437</span></a>
</span><span id="MSPeakCalculation-438"><a href="#MSPeakCalculation-438"><span class="linenos"> 438</span></a>        <span class="c1"># check if MSPeak contains the resolving power info</span>
</span><span id="MSPeakCalculation-439"><a href="#MSPeakCalculation-439"><span class="linenos"> 439</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="MSPeakCalculation-440"><a href="#MSPeakCalculation-440"><span class="linenos"> 440</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="MSPeakCalculation-441"><a href="#MSPeakCalculation-441"><span class="linenos"> 441</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">)</span>
</span><span id="MSPeakCalculation-442"><a href="#MSPeakCalculation-442"><span class="linenos"> 442</span></a>
</span><span id="MSPeakCalculation-443"><a href="#MSPeakCalculation-443"><span class="linenos"> 443</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">final_index</span><span class="p">]</span>
</span><span id="MSPeakCalculation-444"><a href="#MSPeakCalculation-444"><span class="linenos"> 444</span></a>            <span class="n">abundance_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">abundance_profile</span><span class="p">[</span>
</span><span id="MSPeakCalculation-445"><a href="#MSPeakCalculation-445"><span class="linenos"> 445</span></a>                <span class="n">start_index</span><span class="p">:</span><span class="n">final_index</span>
</span><span id="MSPeakCalculation-446"><a href="#MSPeakCalculation-446"><span class="linenos"> 446</span></a>            <span class="p">]</span>
</span><span id="MSPeakCalculation-447"><a href="#MSPeakCalculation-447"><span class="linenos"> 447</span></a>            <span class="n">lower</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">-</span> <span class="mf">0.0005</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="MSPeakCalculation-448"><a href="#MSPeakCalculation-448"><span class="linenos"> 448</span></a>            <span class="n">upper</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="MSPeakCalculation-449"><a href="#MSPeakCalculation-449"><span class="linenos"> 449</span></a>                <span class="mi">1</span><span class="p">,</span>
</span><span id="MSPeakCalculation-450"><a href="#MSPeakCalculation-450"><span class="linenos"> 450</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">,</span>
</span><span id="MSPeakCalculation-451"><a href="#MSPeakCalculation-451"><span class="linenos"> 451</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">+</span> <span class="mf">0.0005</span><span class="p">),</span>
</span><span id="MSPeakCalculation-452"><a href="#MSPeakCalculation-452"><span class="linenos"> 452</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_to_noise</span><span class="p">,</span>
</span><span id="MSPeakCalculation-453"><a href="#MSPeakCalculation-453"><span class="linenos"> 453</span></a>            <span class="p">]</span>
</span><span id="MSPeakCalculation-454"><a href="#MSPeakCalculation-454"><span class="linenos"> 454</span></a>            <span class="n">xopt</span><span class="p">,</span> <span class="n">fopt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimize_pso</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">abundance_domain</span><span class="p">)</span>
</span><span id="MSPeakCalculation-455"><a href="#MSPeakCalculation-455"><span class="linenos"> 455</span></a>
</span><span id="MSPeakCalculation-456"><a href="#MSPeakCalculation-456"><span class="linenos"> 456</span></a>            <span class="n">psfit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voigt_pso</span><span class="p">(</span><span class="n">mz_domain</span><span class="p">,</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="MSPeakCalculation-457"><a href="#MSPeakCalculation-457"><span class="linenos"> 457</span></a>            <span class="n">psfit_hdp_x</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span>
</span><span id="MSPeakCalculation-458"><a href="#MSPeakCalculation-458"><span class="linenos"> 458</span></a>                <span class="nb">min</span><span class="p">(</span><span class="n">mz_domain</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">mz_domain</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">mz_domain</span><span class="p">)</span> <span class="o">*</span> <span class="n">upsample_multiplier</span>
</span><span id="MSPeakCalculation-459"><a href="#MSPeakCalculation-459"><span class="linenos"> 459</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-460"><a href="#MSPeakCalculation-460"><span class="linenos"> 460</span></a>            <span class="n">psfit_hdp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voigt_pso</span><span class="p">(</span>
</span><span id="MSPeakCalculation-461"><a href="#MSPeakCalculation-461"><span class="linenos"> 461</span></a>                <span class="n">psfit_hdp_x</span><span class="p">,</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="MSPeakCalculation-462"><a href="#MSPeakCalculation-462"><span class="linenos"> 462</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-463"><a href="#MSPeakCalculation-463"><span class="linenos"> 463</span></a>            <span class="k">return</span> <span class="n">xopt</span><span class="p">,</span> <span class="n">fopt</span><span class="p">,</span> <span class="n">psfit</span><span class="p">,</span> <span class="p">(</span><span class="n">psfit_hdp_x</span><span class="p">,</span> <span class="n">psfit_hdp</span><span class="p">)</span>
</span><span id="MSPeakCalculation-464"><a href="#MSPeakCalculation-464"><span class="linenos"> 464</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-465"><a href="#MSPeakCalculation-465"><span class="linenos"> 465</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="MSPeakCalculation-466"><a href="#MSPeakCalculation-466"><span class="linenos"> 466</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="MSPeakCalculation-467"><a href="#MSPeakCalculation-467"><span class="linenos"> 467</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-468"><a href="#MSPeakCalculation-468"><span class="linenos"> 468</span></a>
</span><span id="MSPeakCalculation-469"><a href="#MSPeakCalculation-469"><span class="linenos"> 469</span></a>    <span class="k">def</span> <span class="nf">voigt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oversample_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="MSPeakCalculation-470"><a href="#MSPeakCalculation-470"><span class="linenos"> 470</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;[Legacy] Voigt lineshape analysis function</span>
</span><span id="MSPeakCalculation-471"><a href="#MSPeakCalculation-471"><span class="linenos"> 471</span></a><span class="sd">        Legacy function for voigt lineshape analysis</span>
</span><span id="MSPeakCalculation-472"><a href="#MSPeakCalculation-472"><span class="linenos"> 472</span></a>
</span><span id="MSPeakCalculation-473"><a href="#MSPeakCalculation-473"><span class="linenos"> 473</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation-474"><a href="#MSPeakCalculation-474"><span class="linenos"> 474</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-475"><a href="#MSPeakCalculation-475"><span class="linenos"> 475</span></a><span class="sd">        oversample_multiplier : int</span>
</span><span id="MSPeakCalculation-476"><a href="#MSPeakCalculation-476"><span class="linenos"> 476</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function</span>
</span><span id="MSPeakCalculation-477"><a href="#MSPeakCalculation-477"><span class="linenos"> 477</span></a><span class="sd">        delta_rp : float</span>
</span><span id="MSPeakCalculation-478"><a href="#MSPeakCalculation-478"><span class="linenos"> 478</span></a><span class="sd">            delta resolving power to add to resolving power</span>
</span><span id="MSPeakCalculation-479"><a href="#MSPeakCalculation-479"><span class="linenos"> 479</span></a><span class="sd">        mz_overlay : int</span>
</span><span id="MSPeakCalculation-480"><a href="#MSPeakCalculation-480"><span class="linenos"> 480</span></a><span class="sd">            extra points left and right of peak definition to include in fitting</span>
</span><span id="MSPeakCalculation-481"><a href="#MSPeakCalculation-481"><span class="linenos"> 481</span></a>
</span><span id="MSPeakCalculation-482"><a href="#MSPeakCalculation-482"><span class="linenos"> 482</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation-483"><a href="#MSPeakCalculation-483"><span class="linenos"> 483</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation-484"><a href="#MSPeakCalculation-484"><span class="linenos"> 484</span></a><span class="sd">        mz_domain : ndarray</span>
</span><span id="MSPeakCalculation-485"><a href="#MSPeakCalculation-485"><span class="linenos"> 485</span></a><span class="sd">            x-axis domain for fit</span>
</span><span id="MSPeakCalculation-486"><a href="#MSPeakCalculation-486"><span class="linenos"> 486</span></a><span class="sd">        calc_abundance : ndarray</span>
</span><span id="MSPeakCalculation-487"><a href="#MSPeakCalculation-487"><span class="linenos"> 487</span></a><span class="sd">            calculated abundance profile based on voigt function</span>
</span><span id="MSPeakCalculation-488"><a href="#MSPeakCalculation-488"><span class="linenos"> 488</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-489"><a href="#MSPeakCalculation-489"><span class="linenos"> 489</span></a>
</span><span id="MSPeakCalculation-490"><a href="#MSPeakCalculation-490"><span class="linenos"> 490</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="MSPeakCalculation-491"><a href="#MSPeakCalculation-491"><span class="linenos"> 491</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="MSPeakCalculation-492"><a href="#MSPeakCalculation-492"><span class="linenos"> 492</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="MSPeakCalculation-493"><a href="#MSPeakCalculation-493"><span class="linenos"> 493</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span> <span class="o">+</span> <span class="n">delta_rp</span>
</span><span id="MSPeakCalculation-494"><a href="#MSPeakCalculation-494"><span class="linenos"> 494</span></a>            <span class="p">)</span>  <span class="c1"># self.resolving_power)</span>
</span><span id="MSPeakCalculation-495"><a href="#MSPeakCalculation-495"><span class="linenos"> 495</span></a>
</span><span id="MSPeakCalculation-496"><a href="#MSPeakCalculation-496"><span class="linenos"> 496</span></a>            <span class="c1"># stardart deviation</span>
</span><span id="MSPeakCalculation-497"><a href="#MSPeakCalculation-497"><span class="linenos"> 497</span></a>            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="mf">3.6013</span>
</span><span id="MSPeakCalculation-498"><a href="#MSPeakCalculation-498"><span class="linenos"> 498</span></a>
</span><span id="MSPeakCalculation-499"><a href="#MSPeakCalculation-499"><span class="linenos"> 499</span></a>            <span class="c1"># half width baseline distance</span>
</span><span id="MSPeakCalculation-500"><a href="#MSPeakCalculation-500"><span class="linenos"> 500</span></a>
</span><span id="MSPeakCalculation-501"><a href="#MSPeakCalculation-501"><span class="linenos"> 501</span></a>            <span class="c1"># mz_domain = linspace(self.mz_exp - hw_base_distance,</span>
</span><span id="MSPeakCalculation-502"><a href="#MSPeakCalculation-502"><span class="linenos"> 502</span></a>            <span class="c1">#                     self.mz_exp + hw_base_distance, datapoint)</span>
</span><span id="MSPeakCalculation-503"><a href="#MSPeakCalculation-503"><span class="linenos"> 503</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mz_domain</span><span class="p">(</span><span class="n">oversample_multiplier</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="p">)</span>
</span><span id="MSPeakCalculation-504"><a href="#MSPeakCalculation-504"><span class="linenos"> 504</span></a>
</span><span id="MSPeakCalculation-505"><a href="#MSPeakCalculation-505"><span class="linenos"> 505</span></a>            <span class="c1"># gaussian_pdf = lambda x0, x, s: (1/ math.sqrt(2*math.pi*math.pow(s,2))) * math.exp(-1 * math.pow(x-x0,2) / 2*math.pow(s,2) )</span>
</span><span id="MSPeakCalculation-506"><a href="#MSPeakCalculation-506"><span class="linenos"> 506</span></a>
</span><span id="MSPeakCalculation-507"><a href="#MSPeakCalculation-507"><span class="linenos"> 507</span></a>            <span class="c1"># TODO derive amplitude</span>
</span><span id="MSPeakCalculation-508"><a href="#MSPeakCalculation-508"><span class="linenos"> 508</span></a>            <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="MSPeakCalculation-509"><a href="#MSPeakCalculation-509"><span class="linenos"> 509</span></a>
</span><span id="MSPeakCalculation-510"><a href="#MSPeakCalculation-510"><span class="linenos"> 510</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">VoigtModel</span><span class="p">()</span>
</span><span id="MSPeakCalculation-511"><a href="#MSPeakCalculation-511"><span class="linenos"> 511</span></a>
</span><span id="MSPeakCalculation-512"><a href="#MSPeakCalculation-512"><span class="linenos"> 512</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="MSPeakCalculation-513"><a href="#MSPeakCalculation-513"><span class="linenos"> 513</span></a>                <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="MSPeakCalculation-514"><a href="#MSPeakCalculation-514"><span class="linenos"> 514</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-515"><a href="#MSPeakCalculation-515"><span class="linenos"> 515</span></a>
</span><span id="MSPeakCalculation-516"><a href="#MSPeakCalculation-516"><span class="linenos"> 516</span></a>            <span class="n">calc_abundance</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mz_domain</span><span class="p">)</span>
</span><span id="MSPeakCalculation-517"><a href="#MSPeakCalculation-517"><span class="linenos"> 517</span></a>
</span><span id="MSPeakCalculation-518"><a href="#MSPeakCalculation-518"><span class="linenos"> 518</span></a>            <span class="k">return</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">calc_abundance</span>
</span><span id="MSPeakCalculation-519"><a href="#MSPeakCalculation-519"><span class="linenos"> 519</span></a>
</span><span id="MSPeakCalculation-520"><a href="#MSPeakCalculation-520"><span class="linenos"> 520</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-521"><a href="#MSPeakCalculation-521"><span class="linenos"> 521</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="MSPeakCalculation-522"><a href="#MSPeakCalculation-522"><span class="linenos"> 522</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="MSPeakCalculation-523"><a href="#MSPeakCalculation-523"><span class="linenos"> 523</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-524"><a href="#MSPeakCalculation-524"><span class="linenos"> 524</span></a>
</span><span id="MSPeakCalculation-525"><a href="#MSPeakCalculation-525"><span class="linenos"> 525</span></a>    <span class="k">def</span> <span class="nf">pseudovoigt</span><span class="p">(</span>
</span><span id="MSPeakCalculation-526"><a href="#MSPeakCalculation-526"><span class="linenos"> 526</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">oversample_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.5</span>
</span><span id="MSPeakCalculation-527"><a href="#MSPeakCalculation-527"><span class="linenos"> 527</span></a>    <span class="p">):</span>
</span><span id="MSPeakCalculation-528"><a href="#MSPeakCalculation-528"><span class="linenos"> 528</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;[Legacy] pseudovoigt lineshape function</span>
</span><span id="MSPeakCalculation-529"><a href="#MSPeakCalculation-529"><span class="linenos"> 529</span></a>
</span><span id="MSPeakCalculation-530"><a href="#MSPeakCalculation-530"><span class="linenos"> 530</span></a><span class="sd">        Legacy function for pseudovoigt lineshape analysis.</span>
</span><span id="MSPeakCalculation-531"><a href="#MSPeakCalculation-531"><span class="linenos"> 531</span></a><span class="sd">        Note - Code may not be functional currently.</span>
</span><span id="MSPeakCalculation-532"><a href="#MSPeakCalculation-532"><span class="linenos"> 532</span></a>
</span><span id="MSPeakCalculation-533"><a href="#MSPeakCalculation-533"><span class="linenos"> 533</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation-534"><a href="#MSPeakCalculation-534"><span class="linenos"> 534</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-535"><a href="#MSPeakCalculation-535"><span class="linenos"> 535</span></a><span class="sd">        oversample_multiplier : int, optional</span>
</span><span id="MSPeakCalculation-536"><a href="#MSPeakCalculation-536"><span class="linenos"> 536</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function. Defaults to 1.</span>
</span><span id="MSPeakCalculation-537"><a href="#MSPeakCalculation-537"><span class="linenos"> 537</span></a><span class="sd">        delta_rp : float, optional</span>
</span><span id="MSPeakCalculation-538"><a href="#MSPeakCalculation-538"><span class="linenos"> 538</span></a><span class="sd">            delta resolving power to add to resolving power. Defaults to 0.</span>
</span><span id="MSPeakCalculation-539"><a href="#MSPeakCalculation-539"><span class="linenos"> 539</span></a><span class="sd">        mz_overlay : int, optional</span>
</span><span id="MSPeakCalculation-540"><a href="#MSPeakCalculation-540"><span class="linenos"> 540</span></a><span class="sd">            extra points left and right of peak definition to include in fitting. Defaults to 1.</span>
</span><span id="MSPeakCalculation-541"><a href="#MSPeakCalculation-541"><span class="linenos"> 541</span></a><span class="sd">        fraction : float, optional</span>
</span><span id="MSPeakCalculation-542"><a href="#MSPeakCalculation-542"><span class="linenos"> 542</span></a><span class="sd">            fraction of gaussian component in pseudovoigt function. Defaults to 0.5.</span>
</span><span id="MSPeakCalculation-543"><a href="#MSPeakCalculation-543"><span class="linenos"> 543</span></a>
</span><span id="MSPeakCalculation-544"><a href="#MSPeakCalculation-544"><span class="linenos"> 544</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-545"><a href="#MSPeakCalculation-545"><span class="linenos"> 545</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="MSPeakCalculation-546"><a href="#MSPeakCalculation-546"><span class="linenos"> 546</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="MSPeakCalculation-547"><a href="#MSPeakCalculation-547"><span class="linenos"> 547</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="MSPeakCalculation-548"><a href="#MSPeakCalculation-548"><span class="linenos"> 548</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span> <span class="o">+</span> <span class="n">delta_rp</span>
</span><span id="MSPeakCalculation-549"><a href="#MSPeakCalculation-549"><span class="linenos"> 549</span></a>            <span class="p">)</span>  <span class="c1"># self.resolving_power)</span>
</span><span id="MSPeakCalculation-550"><a href="#MSPeakCalculation-550"><span class="linenos"> 550</span></a>
</span><span id="MSPeakCalculation-551"><a href="#MSPeakCalculation-551"><span class="linenos"> 551</span></a>            <span class="c1"># stardart deviation</span>
</span><span id="MSPeakCalculation-552"><a href="#MSPeakCalculation-552"><span class="linenos"> 552</span></a>            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="MSPeakCalculation-553"><a href="#MSPeakCalculation-553"><span class="linenos"> 553</span></a>
</span><span id="MSPeakCalculation-554"><a href="#MSPeakCalculation-554"><span class="linenos"> 554</span></a>            <span class="c1"># half width baseline distance</span>
</span><span id="MSPeakCalculation-555"><a href="#MSPeakCalculation-555"><span class="linenos"> 555</span></a>
</span><span id="MSPeakCalculation-556"><a href="#MSPeakCalculation-556"><span class="linenos"> 556</span></a>            <span class="c1"># mz_domain = linspace(self.mz_exp - hw_base_distance,</span>
</span><span id="MSPeakCalculation-557"><a href="#MSPeakCalculation-557"><span class="linenos"> 557</span></a>            <span class="c1">#                     self.mz_exp + hw_base_distance, datapoint)</span>
</span><span id="MSPeakCalculation-558"><a href="#MSPeakCalculation-558"><span class="linenos"> 558</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mz_domain</span><span class="p">(</span><span class="n">oversample_multiplier</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="p">)</span>
</span><span id="MSPeakCalculation-559"><a href="#MSPeakCalculation-559"><span class="linenos"> 559</span></a>
</span><span id="MSPeakCalculation-560"><a href="#MSPeakCalculation-560"><span class="linenos"> 560</span></a>            <span class="c1"># gaussian_pdf = lambda x0, x, s: (1/ math.sqrt(2*math.pi*math.pow(s,2))) * math.exp(-1 * math.pow(x-x0,2) / 2*math.pow(s,2) )</span>
</span><span id="MSPeakCalculation-561"><a href="#MSPeakCalculation-561"><span class="linenos"> 561</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PseudoVoigtModel</span><span class="p">()</span>
</span><span id="MSPeakCalculation-562"><a href="#MSPeakCalculation-562"><span class="linenos"> 562</span></a>
</span><span id="MSPeakCalculation-563"><a href="#MSPeakCalculation-563"><span class="linenos"> 563</span></a>            <span class="c1"># TODO derive amplitude</span>
</span><span id="MSPeakCalculation-564"><a href="#MSPeakCalculation-564"><span class="linenos"> 564</span></a>            <span class="n">gamma</span> <span class="o">=</span> <span class="n">sigma</span>
</span><span id="MSPeakCalculation-565"><a href="#MSPeakCalculation-565"><span class="linenos"> 565</span></a>
</span><span id="MSPeakCalculation-566"><a href="#MSPeakCalculation-566"><span class="linenos"> 566</span></a>            <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="MSPeakCalculation-567"><a href="#MSPeakCalculation-567"><span class="linenos"> 567</span></a>            <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pi</span> <span class="o">/</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="MSPeakCalculation-568"><a href="#MSPeakCalculation-568"><span class="linenos"> 568</span></a>                <span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">gamma</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">)</span>
</span><span id="MSPeakCalculation-569"><a href="#MSPeakCalculation-569"><span class="linenos"> 569</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-570"><a href="#MSPeakCalculation-570"><span class="linenos"> 570</span></a>
</span><span id="MSPeakCalculation-571"><a href="#MSPeakCalculation-571"><span class="linenos"> 571</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
</span><span id="MSPeakCalculation-572"><a href="#MSPeakCalculation-572"><span class="linenos"> 572</span></a>
</span><span id="MSPeakCalculation-573"><a href="#MSPeakCalculation-573"><span class="linenos"> 573</span></a>            <span class="n">calc_abundance</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mz_domain</span><span class="p">)</span>
</span><span id="MSPeakCalculation-574"><a href="#MSPeakCalculation-574"><span class="linenos"> 574</span></a>
</span><span id="MSPeakCalculation-575"><a href="#MSPeakCalculation-575"><span class="linenos"> 575</span></a>            <span class="k">return</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">calc_abundance</span>
</span><span id="MSPeakCalculation-576"><a href="#MSPeakCalculation-576"><span class="linenos"> 576</span></a>
</span><span id="MSPeakCalculation-577"><a href="#MSPeakCalculation-577"><span class="linenos"> 577</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-578"><a href="#MSPeakCalculation-578"><span class="linenos"> 578</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="MSPeakCalculation-579"><a href="#MSPeakCalculation-579"><span class="linenos"> 579</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="MSPeakCalculation-580"><a href="#MSPeakCalculation-580"><span class="linenos"> 580</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-581"><a href="#MSPeakCalculation-581"><span class="linenos"> 581</span></a>
</span><span id="MSPeakCalculation-582"><a href="#MSPeakCalculation-582"><span class="linenos"> 582</span></a>    <span class="k">def</span> <span class="nf">lorentz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oversample_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="MSPeakCalculation-583"><a href="#MSPeakCalculation-583"><span class="linenos"> 583</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;[Legacy] Lorentz lineshape analysis function</span>
</span><span id="MSPeakCalculation-584"><a href="#MSPeakCalculation-584"><span class="linenos"> 584</span></a>
</span><span id="MSPeakCalculation-585"><a href="#MSPeakCalculation-585"><span class="linenos"> 585</span></a><span class="sd">        Legacy function for lorentz lineshape analysis</span>
</span><span id="MSPeakCalculation-586"><a href="#MSPeakCalculation-586"><span class="linenos"> 586</span></a>
</span><span id="MSPeakCalculation-587"><a href="#MSPeakCalculation-587"><span class="linenos"> 587</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation-588"><a href="#MSPeakCalculation-588"><span class="linenos"> 588</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-589"><a href="#MSPeakCalculation-589"><span class="linenos"> 589</span></a><span class="sd">        oversample_multiplier : int</span>
</span><span id="MSPeakCalculation-590"><a href="#MSPeakCalculation-590"><span class="linenos"> 590</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function</span>
</span><span id="MSPeakCalculation-591"><a href="#MSPeakCalculation-591"><span class="linenos"> 591</span></a><span class="sd">        delta_rp : float</span>
</span><span id="MSPeakCalculation-592"><a href="#MSPeakCalculation-592"><span class="linenos"> 592</span></a><span class="sd">            delta resolving power to add to resolving power</span>
</span><span id="MSPeakCalculation-593"><a href="#MSPeakCalculation-593"><span class="linenos"> 593</span></a><span class="sd">        mz_overlay : int</span>
</span><span id="MSPeakCalculation-594"><a href="#MSPeakCalculation-594"><span class="linenos"> 594</span></a><span class="sd">            extra points left and right of peak definition to include in fitting</span>
</span><span id="MSPeakCalculation-595"><a href="#MSPeakCalculation-595"><span class="linenos"> 595</span></a>
</span><span id="MSPeakCalculation-596"><a href="#MSPeakCalculation-596"><span class="linenos"> 596</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation-597"><a href="#MSPeakCalculation-597"><span class="linenos"> 597</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation-598"><a href="#MSPeakCalculation-598"><span class="linenos"> 598</span></a><span class="sd">        mz_domain : ndarray</span>
</span><span id="MSPeakCalculation-599"><a href="#MSPeakCalculation-599"><span class="linenos"> 599</span></a><span class="sd">            x-axis domain for fit</span>
</span><span id="MSPeakCalculation-600"><a href="#MSPeakCalculation-600"><span class="linenos"> 600</span></a><span class="sd">        calc_abundance : ndarray</span>
</span><span id="MSPeakCalculation-601"><a href="#MSPeakCalculation-601"><span class="linenos"> 601</span></a><span class="sd">            calculated abundance profile based on lorentz function</span>
</span><span id="MSPeakCalculation-602"><a href="#MSPeakCalculation-602"><span class="linenos"> 602</span></a>
</span><span id="MSPeakCalculation-603"><a href="#MSPeakCalculation-603"><span class="linenos"> 603</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-604"><a href="#MSPeakCalculation-604"><span class="linenos"> 604</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="MSPeakCalculation-605"><a href="#MSPeakCalculation-605"><span class="linenos"> 605</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="MSPeakCalculation-606"><a href="#MSPeakCalculation-606"><span class="linenos"> 606</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="MSPeakCalculation-607"><a href="#MSPeakCalculation-607"><span class="linenos"> 607</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span> <span class="o">+</span> <span class="n">delta_rp</span>
</span><span id="MSPeakCalculation-608"><a href="#MSPeakCalculation-608"><span class="linenos"> 608</span></a>            <span class="p">)</span>  <span class="c1"># self.resolving_power)</span>
</span><span id="MSPeakCalculation-609"><a href="#MSPeakCalculation-609"><span class="linenos"> 609</span></a>
</span><span id="MSPeakCalculation-610"><a href="#MSPeakCalculation-610"><span class="linenos"> 610</span></a>            <span class="c1"># stardart deviation</span>
</span><span id="MSPeakCalculation-611"><a href="#MSPeakCalculation-611"><span class="linenos"> 611</span></a>            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="MSPeakCalculation-612"><a href="#MSPeakCalculation-612"><span class="linenos"> 612</span></a>
</span><span id="MSPeakCalculation-613"><a href="#MSPeakCalculation-613"><span class="linenos"> 613</span></a>            <span class="c1"># half width baseline distance</span>
</span><span id="MSPeakCalculation-614"><a href="#MSPeakCalculation-614"><span class="linenos"> 614</span></a>            <span class="n">hw_base_distance</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">sigma</span>
</span><span id="MSPeakCalculation-615"><a href="#MSPeakCalculation-615"><span class="linenos"> 615</span></a>
</span><span id="MSPeakCalculation-616"><a href="#MSPeakCalculation-616"><span class="linenos"> 616</span></a>            <span class="c1"># mz_domain = linspace(self.mz_exp - hw_base_distance,</span>
</span><span id="MSPeakCalculation-617"><a href="#MSPeakCalculation-617"><span class="linenos"> 617</span></a>            <span class="c1">#                     self.mz_exp + hw_base_distance, datapoint)</span>
</span><span id="MSPeakCalculation-618"><a href="#MSPeakCalculation-618"><span class="linenos"> 618</span></a>
</span><span id="MSPeakCalculation-619"><a href="#MSPeakCalculation-619"><span class="linenos"> 619</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mz_domain</span><span class="p">(</span><span class="n">oversample_multiplier</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="p">)</span>
</span><span id="MSPeakCalculation-620"><a href="#MSPeakCalculation-620"><span class="linenos"> 620</span></a>            <span class="c1"># gaussian_pdf = lambda x0, x, s: (1/ math.sqrt(2*math.pi*math.pow(s,2))) * math.exp(-1 * math.pow(x-x0,2) / 2*math.pow(s,2) )</span>
</span><span id="MSPeakCalculation-621"><a href="#MSPeakCalculation-621"><span class="linenos"> 621</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">LorentzianModel</span><span class="p">()</span>
</span><span id="MSPeakCalculation-622"><a href="#MSPeakCalculation-622"><span class="linenos"> 622</span></a>
</span><span id="MSPeakCalculation-623"><a href="#MSPeakCalculation-623"><span class="linenos"> 623</span></a>            <span class="n">amplitude</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="MSPeakCalculation-624"><a href="#MSPeakCalculation-624"><span class="linenos"> 624</span></a>
</span><span id="MSPeakCalculation-625"><a href="#MSPeakCalculation-625"><span class="linenos"> 625</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="MSPeakCalculation-626"><a href="#MSPeakCalculation-626"><span class="linenos"> 626</span></a>                <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="MSPeakCalculation-627"><a href="#MSPeakCalculation-627"><span class="linenos"> 627</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-628"><a href="#MSPeakCalculation-628"><span class="linenos"> 628</span></a>
</span><span id="MSPeakCalculation-629"><a href="#MSPeakCalculation-629"><span class="linenos"> 629</span></a>            <span class="n">calc_abundance</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mz_domain</span><span class="p">)</span>
</span><span id="MSPeakCalculation-630"><a href="#MSPeakCalculation-630"><span class="linenos"> 630</span></a>
</span><span id="MSPeakCalculation-631"><a href="#MSPeakCalculation-631"><span class="linenos"> 631</span></a>            <span class="k">return</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">calc_abundance</span>
</span><span id="MSPeakCalculation-632"><a href="#MSPeakCalculation-632"><span class="linenos"> 632</span></a>
</span><span id="MSPeakCalculation-633"><a href="#MSPeakCalculation-633"><span class="linenos"> 633</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-634"><a href="#MSPeakCalculation-634"><span class="linenos"> 634</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="MSPeakCalculation-635"><a href="#MSPeakCalculation-635"><span class="linenos"> 635</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="MSPeakCalculation-636"><a href="#MSPeakCalculation-636"><span class="linenos"> 636</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-637"><a href="#MSPeakCalculation-637"><span class="linenos"> 637</span></a>
</span><span id="MSPeakCalculation-638"><a href="#MSPeakCalculation-638"><span class="linenos"> 638</span></a>    <span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oversample_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="MSPeakCalculation-639"><a href="#MSPeakCalculation-639"><span class="linenos"> 639</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;[Legacy] Gaussian lineshape analysis function</span>
</span><span id="MSPeakCalculation-640"><a href="#MSPeakCalculation-640"><span class="linenos"> 640</span></a><span class="sd">        Legacy gaussian lineshape analysis function</span>
</span><span id="MSPeakCalculation-641"><a href="#MSPeakCalculation-641"><span class="linenos"> 641</span></a>
</span><span id="MSPeakCalculation-642"><a href="#MSPeakCalculation-642"><span class="linenos"> 642</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation-643"><a href="#MSPeakCalculation-643"><span class="linenos"> 643</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-644"><a href="#MSPeakCalculation-644"><span class="linenos"> 644</span></a><span class="sd">        oversample_multiplier : int</span>
</span><span id="MSPeakCalculation-645"><a href="#MSPeakCalculation-645"><span class="linenos"> 645</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function</span>
</span><span id="MSPeakCalculation-646"><a href="#MSPeakCalculation-646"><span class="linenos"> 646</span></a><span class="sd">        delta_rp : float</span>
</span><span id="MSPeakCalculation-647"><a href="#MSPeakCalculation-647"><span class="linenos"> 647</span></a><span class="sd">            delta resolving power to add to resolving power</span>
</span><span id="MSPeakCalculation-648"><a href="#MSPeakCalculation-648"><span class="linenos"> 648</span></a><span class="sd">        mz_overlay : int</span>
</span><span id="MSPeakCalculation-649"><a href="#MSPeakCalculation-649"><span class="linenos"> 649</span></a><span class="sd">            extra points left and right of peak definition to include in fitting</span>
</span><span id="MSPeakCalculation-650"><a href="#MSPeakCalculation-650"><span class="linenos"> 650</span></a>
</span><span id="MSPeakCalculation-651"><a href="#MSPeakCalculation-651"><span class="linenos"> 651</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation-652"><a href="#MSPeakCalculation-652"><span class="linenos"> 652</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation-653"><a href="#MSPeakCalculation-653"><span class="linenos"> 653</span></a><span class="sd">        mz_domain : ndarray</span>
</span><span id="MSPeakCalculation-654"><a href="#MSPeakCalculation-654"><span class="linenos"> 654</span></a><span class="sd">            x-axis domain for fit</span>
</span><span id="MSPeakCalculation-655"><a href="#MSPeakCalculation-655"><span class="linenos"> 655</span></a><span class="sd">        calc_abundance : ndarray</span>
</span><span id="MSPeakCalculation-656"><a href="#MSPeakCalculation-656"><span class="linenos"> 656</span></a><span class="sd">            calculated abundance profile based on gaussian function</span>
</span><span id="MSPeakCalculation-657"><a href="#MSPeakCalculation-657"><span class="linenos"> 657</span></a>
</span><span id="MSPeakCalculation-658"><a href="#MSPeakCalculation-658"><span class="linenos"> 658</span></a>
</span><span id="MSPeakCalculation-659"><a href="#MSPeakCalculation-659"><span class="linenos"> 659</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-660"><a href="#MSPeakCalculation-660"><span class="linenos"> 660</span></a>
</span><span id="MSPeakCalculation-661"><a href="#MSPeakCalculation-661"><span class="linenos"> 661</span></a>        <span class="c1"># check if MSPeak contains the resolving power info</span>
</span><span id="MSPeakCalculation-662"><a href="#MSPeakCalculation-662"><span class="linenos"> 662</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="MSPeakCalculation-663"><a href="#MSPeakCalculation-663"><span class="linenos"> 663</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="MSPeakCalculation-664"><a href="#MSPeakCalculation-664"><span class="linenos"> 664</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="MSPeakCalculation-665"><a href="#MSPeakCalculation-665"><span class="linenos"> 665</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span> <span class="o">+</span> <span class="n">delta_rp</span>
</span><span id="MSPeakCalculation-666"><a href="#MSPeakCalculation-666"><span class="linenos"> 666</span></a>            <span class="p">)</span>  <span class="c1"># self.resolving_power)</span>
</span><span id="MSPeakCalculation-667"><a href="#MSPeakCalculation-667"><span class="linenos"> 667</span></a>
</span><span id="MSPeakCalculation-668"><a href="#MSPeakCalculation-668"><span class="linenos"> 668</span></a>            <span class="c1"># stardart deviation</span>
</span><span id="MSPeakCalculation-669"><a href="#MSPeakCalculation-669"><span class="linenos"> 669</span></a>            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
</span><span id="MSPeakCalculation-670"><a href="#MSPeakCalculation-670"><span class="linenos"> 670</span></a>
</span><span id="MSPeakCalculation-671"><a href="#MSPeakCalculation-671"><span class="linenos"> 671</span></a>            <span class="c1"># half width baseline distance</span>
</span><span id="MSPeakCalculation-672"><a href="#MSPeakCalculation-672"><span class="linenos"> 672</span></a>            <span class="c1"># hw_base_distance = (3.2 * s)</span>
</span><span id="MSPeakCalculation-673"><a href="#MSPeakCalculation-673"><span class="linenos"> 673</span></a>
</span><span id="MSPeakCalculation-674"><a href="#MSPeakCalculation-674"><span class="linenos"> 674</span></a>            <span class="c1"># match_loz_factor = 3</span>
</span><span id="MSPeakCalculation-675"><a href="#MSPeakCalculation-675"><span class="linenos"> 675</span></a>
</span><span id="MSPeakCalculation-676"><a href="#MSPeakCalculation-676"><span class="linenos"> 676</span></a>            <span class="c1"># n_d = hw_base_distance * match_loz_factor</span>
</span><span id="MSPeakCalculation-677"><a href="#MSPeakCalculation-677"><span class="linenos"> 677</span></a>
</span><span id="MSPeakCalculation-678"><a href="#MSPeakCalculation-678"><span class="linenos"> 678</span></a>            <span class="c1"># mz_domain = linspace(</span>
</span><span id="MSPeakCalculation-679"><a href="#MSPeakCalculation-679"><span class="linenos"> 679</span></a>            <span class="c1">#    self.mz_exp - n_d, self.mz_exp + n_d, datapoint)</span>
</span><span id="MSPeakCalculation-680"><a href="#MSPeakCalculation-680"><span class="linenos"> 680</span></a>
</span><span id="MSPeakCalculation-681"><a href="#MSPeakCalculation-681"><span class="linenos"> 681</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mz_domain</span><span class="p">(</span><span class="n">oversample_multiplier</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="p">)</span>
</span><span id="MSPeakCalculation-682"><a href="#MSPeakCalculation-682"><span class="linenos"> 682</span></a>
</span><span id="MSPeakCalculation-683"><a href="#MSPeakCalculation-683"><span class="linenos"> 683</span></a>            <span class="c1"># gaussian_pdf = lambda x0, x, s: (1/ math.sqrt(2*math.pi*math.pow(s,2))) * math.exp(-1 * math.pow(x-x0,2) / 2*math.pow(s,2) )</span>
</span><span id="MSPeakCalculation-684"><a href="#MSPeakCalculation-684"><span class="linenos"> 684</span></a>
</span><span id="MSPeakCalculation-685"><a href="#MSPeakCalculation-685"><span class="linenos"> 685</span></a>            <span class="c1"># calc_abundance = norm.pdf(mz_domain, self.mz_exp, s)</span>
</span><span id="MSPeakCalculation-686"><a href="#MSPeakCalculation-686"><span class="linenos"> 686</span></a>
</span><span id="MSPeakCalculation-687"><a href="#MSPeakCalculation-687"><span class="linenos"> 687</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GaussianModel</span><span class="p">()</span>
</span><span id="MSPeakCalculation-688"><a href="#MSPeakCalculation-688"><span class="linenos"> 688</span></a>
</span><span id="MSPeakCalculation-689"><a href="#MSPeakCalculation-689"><span class="linenos"> 689</span></a>            <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="MSPeakCalculation-690"><a href="#MSPeakCalculation-690"><span class="linenos"> 690</span></a>
</span><span id="MSPeakCalculation-691"><a href="#MSPeakCalculation-691"><span class="linenos"> 691</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="MSPeakCalculation-692"><a href="#MSPeakCalculation-692"><span class="linenos"> 692</span></a>                <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="MSPeakCalculation-693"><a href="#MSPeakCalculation-693"><span class="linenos"> 693</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-694"><a href="#MSPeakCalculation-694"><span class="linenos"> 694</span></a>
</span><span id="MSPeakCalculation-695"><a href="#MSPeakCalculation-695"><span class="linenos"> 695</span></a>            <span class="n">calc_abundance</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mz_domain</span><span class="p">)</span>
</span><span id="MSPeakCalculation-696"><a href="#MSPeakCalculation-696"><span class="linenos"> 696</span></a>
</span><span id="MSPeakCalculation-697"><a href="#MSPeakCalculation-697"><span class="linenos"> 697</span></a>            <span class="k">return</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">calc_abundance</span>
</span><span id="MSPeakCalculation-698"><a href="#MSPeakCalculation-698"><span class="linenos"> 698</span></a>
</span><span id="MSPeakCalculation-699"><a href="#MSPeakCalculation-699"><span class="linenos"> 699</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-700"><a href="#MSPeakCalculation-700"><span class="linenos"> 700</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="MSPeakCalculation-701"><a href="#MSPeakCalculation-701"><span class="linenos"> 701</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="MSPeakCalculation-702"><a href="#MSPeakCalculation-702"><span class="linenos"> 702</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-703"><a href="#MSPeakCalculation-703"><span class="linenos"> 703</span></a>
</span><span id="MSPeakCalculation-704"><a href="#MSPeakCalculation-704"><span class="linenos"> 704</span></a>    <span class="k">def</span> <span class="nf">get_mz_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oversample_multiplier</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="p">):</span>
</span><span id="MSPeakCalculation-705"><a href="#MSPeakCalculation-705"><span class="linenos"> 705</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;[Legacy] function to resample/interpolate datapoints for lineshape analysis</span>
</span><span id="MSPeakCalculation-706"><a href="#MSPeakCalculation-706"><span class="linenos"> 706</span></a>
</span><span id="MSPeakCalculation-707"><a href="#MSPeakCalculation-707"><span class="linenos"> 707</span></a><span class="sd">        This code is used for the legacy line fitting functions and not recommended.</span>
</span><span id="MSPeakCalculation-708"><a href="#MSPeakCalculation-708"><span class="linenos"> 708</span></a><span class="sd">        Legacy function to support expanding mz domain for legacy lineshape functions</span>
</span><span id="MSPeakCalculation-709"><a href="#MSPeakCalculation-709"><span class="linenos"> 709</span></a>
</span><span id="MSPeakCalculation-710"><a href="#MSPeakCalculation-710"><span class="linenos"> 710</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation-711"><a href="#MSPeakCalculation-711"><span class="linenos"> 711</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-712"><a href="#MSPeakCalculation-712"><span class="linenos"> 712</span></a><span class="sd">        oversample_multiplier : int</span>
</span><span id="MSPeakCalculation-713"><a href="#MSPeakCalculation-713"><span class="linenos"> 713</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function</span>
</span><span id="MSPeakCalculation-714"><a href="#MSPeakCalculation-714"><span class="linenos"> 714</span></a><span class="sd">        mz_overlay : int</span>
</span><span id="MSPeakCalculation-715"><a href="#MSPeakCalculation-715"><span class="linenos"> 715</span></a><span class="sd">            extra points left and right of peak definition to include in fitting</span>
</span><span id="MSPeakCalculation-716"><a href="#MSPeakCalculation-716"><span class="linenos"> 716</span></a>
</span><span id="MSPeakCalculation-717"><a href="#MSPeakCalculation-717"><span class="linenos"> 717</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation-718"><a href="#MSPeakCalculation-718"><span class="linenos"> 718</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation-719"><a href="#MSPeakCalculation-719"><span class="linenos"> 719</span></a><span class="sd">        mz_domain : ndarray</span>
</span><span id="MSPeakCalculation-720"><a href="#MSPeakCalculation-720"><span class="linenos"> 720</span></a><span class="sd">            x-axis domain for fit</span>
</span><span id="MSPeakCalculation-721"><a href="#MSPeakCalculation-721"><span class="linenos"> 721</span></a>
</span><span id="MSPeakCalculation-722"><a href="#MSPeakCalculation-722"><span class="linenos"> 722</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-723"><a href="#MSPeakCalculation-723"><span class="linenos"> 723</span></a>        <span class="n">start_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MSPeakCalculation-724"><a href="#MSPeakCalculation-724"><span class="linenos"> 724</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">-</span> <span class="n">mz_overlay</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="MSPeakCalculation-725"><a href="#MSPeakCalculation-725"><span class="linenos"> 725</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation-726"><a href="#MSPeakCalculation-726"><span class="linenos"> 726</span></a>        <span class="n">final_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MSPeakCalculation-727"><a href="#MSPeakCalculation-727"><span class="linenos"> 727</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">+</span> <span class="n">mz_overlay</span>
</span><span id="MSPeakCalculation-728"><a href="#MSPeakCalculation-728"><span class="linenos"> 728</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">)</span>
</span><span id="MSPeakCalculation-729"><a href="#MSPeakCalculation-729"><span class="linenos"> 729</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span>
</span><span id="MSPeakCalculation-730"><a href="#MSPeakCalculation-730"><span class="linenos"> 730</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation-731"><a href="#MSPeakCalculation-731"><span class="linenos"> 731</span></a>
</span><span id="MSPeakCalculation-732"><a href="#MSPeakCalculation-732"><span class="linenos"> 732</span></a>        <span class="k">if</span> <span class="n">oversample_multiplier</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MSPeakCalculation-733"><a href="#MSPeakCalculation-733"><span class="linenos"> 733</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">final_index</span><span class="p">]</span>
</span><span id="MSPeakCalculation-734"><a href="#MSPeakCalculation-734"><span class="linenos"> 734</span></a>
</span><span id="MSPeakCalculation-735"><a href="#MSPeakCalculation-735"><span class="linenos"> 735</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-736"><a href="#MSPeakCalculation-736"><span class="linenos"> 736</span></a>            <span class="c1"># we assume a linear correlation for m/z and datapoits</span>
</span><span id="MSPeakCalculation-737"><a href="#MSPeakCalculation-737"><span class="linenos"> 737</span></a>            <span class="c1"># which is only true if the m/z range in narrow (within 1 m/z unit)</span>
</span><span id="MSPeakCalculation-738"><a href="#MSPeakCalculation-738"><span class="linenos"> 738</span></a>            <span class="c1"># this is not true for a wide m/z range</span>
</span><span id="MSPeakCalculation-739"><a href="#MSPeakCalculation-739"><span class="linenos"> 739</span></a>
</span><span id="MSPeakCalculation-740"><a href="#MSPeakCalculation-740"><span class="linenos"> 740</span></a>            <span class="n">indexes</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_index</span><span class="p">,</span> <span class="n">final_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="MSPeakCalculation-741"><a href="#MSPeakCalculation-741"><span class="linenos"> 741</span></a>            <span class="n">mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span>
</span><span id="MSPeakCalculation-742"><a href="#MSPeakCalculation-742"><span class="linenos"> 742</span></a>            <span class="n">pol</span> <span class="o">=</span> <span class="n">poly1d</span><span class="p">(</span><span class="n">polyfit</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="MSPeakCalculation-743"><a href="#MSPeakCalculation-743"><span class="linenos"> 743</span></a>            <span class="n">oversampled_indexes</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span>
</span><span id="MSPeakCalculation-744"><a href="#MSPeakCalculation-744"><span class="linenos"> 744</span></a>                <span class="n">start_index</span><span class="p">,</span>
</span><span id="MSPeakCalculation-745"><a href="#MSPeakCalculation-745"><span class="linenos"> 745</span></a>                <span class="n">final_index</span><span class="p">,</span>
</span><span id="MSPeakCalculation-746"><a href="#MSPeakCalculation-746"><span class="linenos"> 746</span></a>                <span class="p">(</span><span class="n">final_index</span> <span class="o">-</span> <span class="n">start_index</span><span class="p">)</span> <span class="o">*</span> <span class="n">oversample_multiplier</span><span class="p">,</span>
</span><span id="MSPeakCalculation-747"><a href="#MSPeakCalculation-747"><span class="linenos"> 747</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-748"><a href="#MSPeakCalculation-748"><span class="linenos"> 748</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="n">pol</span><span class="p">(</span><span class="n">oversampled_indexes</span><span class="p">)</span>
</span><span id="MSPeakCalculation-749"><a href="#MSPeakCalculation-749"><span class="linenos"> 749</span></a>
</span><span id="MSPeakCalculation-750"><a href="#MSPeakCalculation-750"><span class="linenos"> 750</span></a>        <span class="k">return</span> <span class="n">mz_domain</span>
</span><span id="MSPeakCalculation-751"><a href="#MSPeakCalculation-751"><span class="linenos"> 751</span></a>
</span><span id="MSPeakCalculation-752"><a href="#MSPeakCalculation-752"><span class="linenos"> 752</span></a>    <span class="nd">@property</span>
</span><span id="MSPeakCalculation-753"><a href="#MSPeakCalculation-753"><span class="linenos"> 753</span></a>    <span class="k">def</span> <span class="nf">number_possible_assignments</span><span class="p">(</span>
</span><span id="MSPeakCalculation-754"><a href="#MSPeakCalculation-754"><span class="linenos"> 754</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MSPeakCalculation-755"><a href="#MSPeakCalculation-755"><span class="linenos"> 755</span></a>    <span class="p">):</span>
</span><span id="MSPeakCalculation-756"><a href="#MSPeakCalculation-756"><span class="linenos"> 756</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">)</span>
</span><span id="MSPeakCalculation-757"><a href="#MSPeakCalculation-757"><span class="linenos"> 757</span></a>
</span><span id="MSPeakCalculation-758"><a href="#MSPeakCalculation-758"><span class="linenos"> 758</span></a>    <span class="k">def</span> <span class="nf">molecular_formula_lowest_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MSPeakCalculation-759"><a href="#MSPeakCalculation-759"><span class="linenos"> 759</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the molecular formula with the smallest absolute mz error&quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-760"><a href="#MSPeakCalculation-760"><span class="linenos"> 760</span></a>
</span><span id="MSPeakCalculation-761"><a href="#MSPeakCalculation-761"><span class="linenos"> 761</span></a>        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="MSPeakCalculation-762"><a href="#MSPeakCalculation-762"><span class="linenos"> 762</span></a>
</span><span id="MSPeakCalculation-763"><a href="#MSPeakCalculation-763"><span class="linenos"> 763</span></a>    <span class="k">def</span> <span class="nf">molecular_formula_highest_prob_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MSPeakCalculation-764"><a href="#MSPeakCalculation-764"><span class="linenos"> 764</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the molecular formula with the highest confidence score score&quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-765"><a href="#MSPeakCalculation-765"><span class="linenos"> 765</span></a>
</span><span id="MSPeakCalculation-766"><a href="#MSPeakCalculation-766"><span class="linenos"> 766</span></a>        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">confidence_score</span><span class="p">))</span>
</span><span id="MSPeakCalculation-767"><a href="#MSPeakCalculation-767"><span class="linenos"> 767</span></a>
</span><span id="MSPeakCalculation-768"><a href="#MSPeakCalculation-768"><span class="linenos"> 768</span></a>    <span class="k">def</span> <span class="nf">molecular_formula_earth_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lowest_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="MSPeakCalculation-769"><a href="#MSPeakCalculation-769"><span class="linenos"> 769</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter molecular formula using the &#39;Earth&#39; filter</span>
</span><span id="MSPeakCalculation-770"><a href="#MSPeakCalculation-770"><span class="linenos"> 770</span></a>
</span><span id="MSPeakCalculation-771"><a href="#MSPeakCalculation-771"><span class="linenos"> 771</span></a><span class="sd">        This function applies the Formularity-esque &#39;Earth&#39; filter to possible molecular formula assignments.</span>
</span><span id="MSPeakCalculation-772"><a href="#MSPeakCalculation-772"><span class="linenos"> 772</span></a><span class="sd">        Earth Filter:</span>
</span><span id="MSPeakCalculation-773"><a href="#MSPeakCalculation-773"><span class="linenos"> 773</span></a><span class="sd">            O &gt; 0 AND N &lt;= 3 AND P &lt;= 2 AND 3P &lt;= O</span>
</span><span id="MSPeakCalculation-774"><a href="#MSPeakCalculation-774"><span class="linenos"> 774</span></a>
</span><span id="MSPeakCalculation-775"><a href="#MSPeakCalculation-775"><span class="linenos"> 775</span></a><span class="sd">        If the lowest_error method is also used, it will return the single formula annotation with the smallest absolute error which also fits the Earth filter.</span>
</span><span id="MSPeakCalculation-776"><a href="#MSPeakCalculation-776"><span class="linenos"> 776</span></a><span class="sd">        Otherwise, it will return all Earth-filter compliant formulas.</span>
</span><span id="MSPeakCalculation-777"><a href="#MSPeakCalculation-777"><span class="linenos"> 777</span></a>
</span><span id="MSPeakCalculation-778"><a href="#MSPeakCalculation-778"><span class="linenos"> 778</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation-779"><a href="#MSPeakCalculation-779"><span class="linenos"> 779</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-780"><a href="#MSPeakCalculation-780"><span class="linenos"> 780</span></a><span class="sd">        lowest_error : bool, optional.</span>
</span><span id="MSPeakCalculation-781"><a href="#MSPeakCalculation-781"><span class="linenos"> 781</span></a><span class="sd">            Return only the lowest error formula which also fits the Earth filter.</span>
</span><span id="MSPeakCalculation-782"><a href="#MSPeakCalculation-782"><span class="linenos"> 782</span></a><span class="sd">            If False, return all Earth-filter compliant formulas. Default is True.</span>
</span><span id="MSPeakCalculation-783"><a href="#MSPeakCalculation-783"><span class="linenos"> 783</span></a>
</span><span id="MSPeakCalculation-784"><a href="#MSPeakCalculation-784"><span class="linenos"> 784</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation-785"><a href="#MSPeakCalculation-785"><span class="linenos"> 785</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation-786"><a href="#MSPeakCalculation-786"><span class="linenos"> 786</span></a><span class="sd">        list</span>
</span><span id="MSPeakCalculation-787"><a href="#MSPeakCalculation-787"><span class="linenos"> 787</span></a><span class="sd">            List of molecular formula objects which fit the Earth filter</span>
</span><span id="MSPeakCalculation-788"><a href="#MSPeakCalculation-788"><span class="linenos"> 788</span></a>
</span><span id="MSPeakCalculation-789"><a href="#MSPeakCalculation-789"><span class="linenos"> 789</span></a><span class="sd">        References</span>
</span><span id="MSPeakCalculation-790"><a href="#MSPeakCalculation-790"><span class="linenos"> 790</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-791"><a href="#MSPeakCalculation-791"><span class="linenos"> 791</span></a><span class="sd">        1. Nikola Tolic et al., &quot;Formularity: Software for Automated Formula Assignment of Natural and Other Organic Matter from Ultrahigh-Resolution Mass Spectra&quot;</span>
</span><span id="MSPeakCalculation-792"><a href="#MSPeakCalculation-792"><span class="linenos"> 792</span></a><span class="sd">            Anal. Chem. 2017, 89, 23, 12659–12665</span>
</span><span id="MSPeakCalculation-793"><a href="#MSPeakCalculation-793"><span class="linenos"> 793</span></a><span class="sd">            doi: 10.1021/acs.analchem.7b03318</span>
</span><span id="MSPeakCalculation-794"><a href="#MSPeakCalculation-794"><span class="linenos"> 794</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-795"><a href="#MSPeakCalculation-795"><span class="linenos"> 795</span></a>
</span><span id="MSPeakCalculation-796"><a href="#MSPeakCalculation-796"><span class="linenos"> 796</span></a>        <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="MSPeakCalculation-797"><a href="#MSPeakCalculation-797"><span class="linenos"> 797</span></a>            <span class="nb">filter</span><span class="p">(</span>
</span><span id="MSPeakCalculation-798"><a href="#MSPeakCalculation-798"><span class="linenos"> 798</span></a>                <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="MSPeakCalculation-799"><a href="#MSPeakCalculation-799"><span class="linenos"> 799</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span>
</span><span id="MSPeakCalculation-800"><a href="#MSPeakCalculation-800"><span class="linenos"> 800</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span>
</span><span id="MSPeakCalculation-801"><a href="#MSPeakCalculation-801"><span class="linenos"> 801</span></a>                <span class="ow">and</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">),</span>
</span><span id="MSPeakCalculation-802"><a href="#MSPeakCalculation-802"><span class="linenos"> 802</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="MSPeakCalculation-803"><a href="#MSPeakCalculation-803"><span class="linenos"> 803</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-804"><a href="#MSPeakCalculation-804"><span class="linenos"> 804</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation-805"><a href="#MSPeakCalculation-805"><span class="linenos"> 805</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MSPeakCalculation-806"><a href="#MSPeakCalculation-806"><span class="linenos"> 806</span></a>            <span class="k">if</span> <span class="n">lowest_error</span><span class="p">:</span>
</span><span id="MSPeakCalculation-807"><a href="#MSPeakCalculation-807"><span class="linenos"> 807</span></a>                <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="MSPeakCalculation-808"><a href="#MSPeakCalculation-808"><span class="linenos"> 808</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-809"><a href="#MSPeakCalculation-809"><span class="linenos"> 809</span></a>                <span class="k">return</span> <span class="n">candidates</span>
</span><span id="MSPeakCalculation-810"><a href="#MSPeakCalculation-810"><span class="linenos"> 810</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-811"><a href="#MSPeakCalculation-811"><span class="linenos"> 811</span></a>            <span class="k">return</span> <span class="n">candidates</span>
</span><span id="MSPeakCalculation-812"><a href="#MSPeakCalculation-812"><span class="linenos"> 812</span></a>
</span><span id="MSPeakCalculation-813"><a href="#MSPeakCalculation-813"><span class="linenos"> 813</span></a>    <span class="k">def</span> <span class="nf">molecular_formula_water_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lowest_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="MSPeakCalculation-814"><a href="#MSPeakCalculation-814"><span class="linenos"> 814</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter molecular formula using the &#39;Water&#39; filter</span>
</span><span id="MSPeakCalculation-815"><a href="#MSPeakCalculation-815"><span class="linenos"> 815</span></a>
</span><span id="MSPeakCalculation-816"><a href="#MSPeakCalculation-816"><span class="linenos"> 816</span></a><span class="sd">        This function applies the Formularity-esque &#39;Water&#39; filter to possible molecular formula assignments.</span>
</span><span id="MSPeakCalculation-817"><a href="#MSPeakCalculation-817"><span class="linenos"> 817</span></a><span class="sd">        Water Filter:</span>
</span><span id="MSPeakCalculation-818"><a href="#MSPeakCalculation-818"><span class="linenos"> 818</span></a><span class="sd">            O &gt; 0 AND N &lt;= 3 AND S &lt;= 2 AND P &lt;= 2</span>
</span><span id="MSPeakCalculation-819"><a href="#MSPeakCalculation-819"><span class="linenos"> 819</span></a>
</span><span id="MSPeakCalculation-820"><a href="#MSPeakCalculation-820"><span class="linenos"> 820</span></a><span class="sd">        If the lowest_error method is also used, it will return the single formula annotation with the smallest absolute error which also fits the Water filter.</span>
</span><span id="MSPeakCalculation-821"><a href="#MSPeakCalculation-821"><span class="linenos"> 821</span></a><span class="sd">        Otherwise, it will return all Water-filter compliant formulas.</span>
</span><span id="MSPeakCalculation-822"><a href="#MSPeakCalculation-822"><span class="linenos"> 822</span></a>
</span><span id="MSPeakCalculation-823"><a href="#MSPeakCalculation-823"><span class="linenos"> 823</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation-824"><a href="#MSPeakCalculation-824"><span class="linenos"> 824</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-825"><a href="#MSPeakCalculation-825"><span class="linenos"> 825</span></a><span class="sd">        lowest_error : bool, optional</span>
</span><span id="MSPeakCalculation-826"><a href="#MSPeakCalculation-826"><span class="linenos"> 826</span></a><span class="sd">            Return only the lowest error formula which also fits the Water filter.</span>
</span><span id="MSPeakCalculation-827"><a href="#MSPeakCalculation-827"><span class="linenos"> 827</span></a><span class="sd">            If False, return all Water-filter compliant formulas. Defaults to 2</span>
</span><span id="MSPeakCalculation-828"><a href="#MSPeakCalculation-828"><span class="linenos"> 828</span></a>
</span><span id="MSPeakCalculation-829"><a href="#MSPeakCalculation-829"><span class="linenos"> 829</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation-830"><a href="#MSPeakCalculation-830"><span class="linenos"> 830</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation-831"><a href="#MSPeakCalculation-831"><span class="linenos"> 831</span></a><span class="sd">        list</span>
</span><span id="MSPeakCalculation-832"><a href="#MSPeakCalculation-832"><span class="linenos"> 832</span></a><span class="sd">            List of molecular formula objects which fit the Water filter</span>
</span><span id="MSPeakCalculation-833"><a href="#MSPeakCalculation-833"><span class="linenos"> 833</span></a>
</span><span id="MSPeakCalculation-834"><a href="#MSPeakCalculation-834"><span class="linenos"> 834</span></a><span class="sd">        References</span>
</span><span id="MSPeakCalculation-835"><a href="#MSPeakCalculation-835"><span class="linenos"> 835</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-836"><a href="#MSPeakCalculation-836"><span class="linenos"> 836</span></a><span class="sd">        1. Nikola Tolic et al., &quot;Formularity: Software for Automated Formula Assignment of Natural and Other Organic Matter from Ultrahigh-Resolution Mass Spectra&quot;</span>
</span><span id="MSPeakCalculation-837"><a href="#MSPeakCalculation-837"><span class="linenos"> 837</span></a><span class="sd">            Anal. Chem. 2017, 89, 23, 12659–12665</span>
</span><span id="MSPeakCalculation-838"><a href="#MSPeakCalculation-838"><span class="linenos"> 838</span></a><span class="sd">            doi: 10.1021/acs.analchem.7b03318</span>
</span><span id="MSPeakCalculation-839"><a href="#MSPeakCalculation-839"><span class="linenos"> 839</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-840"><a href="#MSPeakCalculation-840"><span class="linenos"> 840</span></a>
</span><span id="MSPeakCalculation-841"><a href="#MSPeakCalculation-841"><span class="linenos"> 841</span></a>        <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="MSPeakCalculation-842"><a href="#MSPeakCalculation-842"><span class="linenos"> 842</span></a>            <span class="nb">filter</span><span class="p">(</span>
</span><span id="MSPeakCalculation-843"><a href="#MSPeakCalculation-843"><span class="linenos"> 843</span></a>                <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="MSPeakCalculation-844"><a href="#MSPeakCalculation-844"><span class="linenos"> 844</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span>
</span><span id="MSPeakCalculation-845"><a href="#MSPeakCalculation-845"><span class="linenos"> 845</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span>
</span><span id="MSPeakCalculation-846"><a href="#MSPeakCalculation-846"><span class="linenos"> 846</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="MSPeakCalculation-847"><a href="#MSPeakCalculation-847"><span class="linenos"> 847</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="MSPeakCalculation-848"><a href="#MSPeakCalculation-848"><span class="linenos"> 848</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-849"><a href="#MSPeakCalculation-849"><span class="linenos"> 849</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation-850"><a href="#MSPeakCalculation-850"><span class="linenos"> 850</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MSPeakCalculation-851"><a href="#MSPeakCalculation-851"><span class="linenos"> 851</span></a>            <span class="k">if</span> <span class="n">lowest_error</span><span class="p">:</span>
</span><span id="MSPeakCalculation-852"><a href="#MSPeakCalculation-852"><span class="linenos"> 852</span></a>                <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="MSPeakCalculation-853"><a href="#MSPeakCalculation-853"><span class="linenos"> 853</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-854"><a href="#MSPeakCalculation-854"><span class="linenos"> 854</span></a>                <span class="k">return</span> <span class="n">candidates</span>
</span><span id="MSPeakCalculation-855"><a href="#MSPeakCalculation-855"><span class="linenos"> 855</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-856"><a href="#MSPeakCalculation-856"><span class="linenos"> 856</span></a>            <span class="k">return</span> <span class="n">candidates</span>
</span><span id="MSPeakCalculation-857"><a href="#MSPeakCalculation-857"><span class="linenos"> 857</span></a>
</span><span id="MSPeakCalculation-858"><a href="#MSPeakCalculation-858"><span class="linenos"> 858</span></a>    <span class="k">def</span> <span class="nf">molecular_formula_air_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lowest_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="MSPeakCalculation-859"><a href="#MSPeakCalculation-859"><span class="linenos"> 859</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter molecular formula using the &#39;Air&#39; filter</span>
</span><span id="MSPeakCalculation-860"><a href="#MSPeakCalculation-860"><span class="linenos"> 860</span></a>
</span><span id="MSPeakCalculation-861"><a href="#MSPeakCalculation-861"><span class="linenos"> 861</span></a><span class="sd">        This function applies the Formularity-esque &#39;Air&#39; filter to possible molecular formula assignments.</span>
</span><span id="MSPeakCalculation-862"><a href="#MSPeakCalculation-862"><span class="linenos"> 862</span></a><span class="sd">        Air Filter:</span>
</span><span id="MSPeakCalculation-863"><a href="#MSPeakCalculation-863"><span class="linenos"> 863</span></a><span class="sd">            O &gt; 0 AND N &lt;= 3 AND S &lt;= 1 AND P = 0 AND 3(S+N) &lt;= O</span>
</span><span id="MSPeakCalculation-864"><a href="#MSPeakCalculation-864"><span class="linenos"> 864</span></a>
</span><span id="MSPeakCalculation-865"><a href="#MSPeakCalculation-865"><span class="linenos"> 865</span></a><span class="sd">        If the lowest_error method is also used, it will return the single formula annotation with the smallest absolute error which also fits the Air filter.</span>
</span><span id="MSPeakCalculation-866"><a href="#MSPeakCalculation-866"><span class="linenos"> 866</span></a><span class="sd">        Otherwise, it will return all Air-filter compliant formulas.</span>
</span><span id="MSPeakCalculation-867"><a href="#MSPeakCalculation-867"><span class="linenos"> 867</span></a>
</span><span id="MSPeakCalculation-868"><a href="#MSPeakCalculation-868"><span class="linenos"> 868</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation-869"><a href="#MSPeakCalculation-869"><span class="linenos"> 869</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-870"><a href="#MSPeakCalculation-870"><span class="linenos"> 870</span></a><span class="sd">        lowest_error : bool, optional</span>
</span><span id="MSPeakCalculation-871"><a href="#MSPeakCalculation-871"><span class="linenos"> 871</span></a><span class="sd">            Return only the lowest error formula which also fits the Air filter.</span>
</span><span id="MSPeakCalculation-872"><a href="#MSPeakCalculation-872"><span class="linenos"> 872</span></a><span class="sd">            If False, return all Air-filter compliant formulas. Defaults to True.</span>
</span><span id="MSPeakCalculation-873"><a href="#MSPeakCalculation-873"><span class="linenos"> 873</span></a>
</span><span id="MSPeakCalculation-874"><a href="#MSPeakCalculation-874"><span class="linenos"> 874</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation-875"><a href="#MSPeakCalculation-875"><span class="linenos"> 875</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation-876"><a href="#MSPeakCalculation-876"><span class="linenos"> 876</span></a><span class="sd">        list</span>
</span><span id="MSPeakCalculation-877"><a href="#MSPeakCalculation-877"><span class="linenos"> 877</span></a><span class="sd">            List of molecular formula objects which fit the Air filter</span>
</span><span id="MSPeakCalculation-878"><a href="#MSPeakCalculation-878"><span class="linenos"> 878</span></a>
</span><span id="MSPeakCalculation-879"><a href="#MSPeakCalculation-879"><span class="linenos"> 879</span></a><span class="sd">        References</span>
</span><span id="MSPeakCalculation-880"><a href="#MSPeakCalculation-880"><span class="linenos"> 880</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-881"><a href="#MSPeakCalculation-881"><span class="linenos"> 881</span></a><span class="sd">        1. Nikola Tolic et al., &quot;Formularity: Software for Automated Formula Assignment of Natural and Other Organic Matter from Ultrahigh-Resolution Mass Spectra&quot;</span>
</span><span id="MSPeakCalculation-882"><a href="#MSPeakCalculation-882"><span class="linenos"> 882</span></a><span class="sd">            Anal. Chem. 2017, 89, 23, 12659–12665</span>
</span><span id="MSPeakCalculation-883"><a href="#MSPeakCalculation-883"><span class="linenos"> 883</span></a><span class="sd">            doi: 10.1021/acs.analchem.7b03318</span>
</span><span id="MSPeakCalculation-884"><a href="#MSPeakCalculation-884"><span class="linenos"> 884</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-885"><a href="#MSPeakCalculation-885"><span class="linenos"> 885</span></a>
</span><span id="MSPeakCalculation-886"><a href="#MSPeakCalculation-886"><span class="linenos"> 886</span></a>        <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="MSPeakCalculation-887"><a href="#MSPeakCalculation-887"><span class="linenos"> 887</span></a>            <span class="nb">filter</span><span class="p">(</span>
</span><span id="MSPeakCalculation-888"><a href="#MSPeakCalculation-888"><span class="linenos"> 888</span></a>                <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="MSPeakCalculation-889"><a href="#MSPeakCalculation-889"><span class="linenos"> 889</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span>
</span><span id="MSPeakCalculation-890"><a href="#MSPeakCalculation-890"><span class="linenos"> 890</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
</span><span id="MSPeakCalculation-891"><a href="#MSPeakCalculation-891"><span class="linenos"> 891</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="MSPeakCalculation-892"><a href="#MSPeakCalculation-892"><span class="linenos"> 892</span></a>                <span class="ow">and</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">),</span>
</span><span id="MSPeakCalculation-893"><a href="#MSPeakCalculation-893"><span class="linenos"> 893</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="MSPeakCalculation-894"><a href="#MSPeakCalculation-894"><span class="linenos"> 894</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-895"><a href="#MSPeakCalculation-895"><span class="linenos"> 895</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation-896"><a href="#MSPeakCalculation-896"><span class="linenos"> 896</span></a>
</span><span id="MSPeakCalculation-897"><a href="#MSPeakCalculation-897"><span class="linenos"> 897</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MSPeakCalculation-898"><a href="#MSPeakCalculation-898"><span class="linenos"> 898</span></a>            <span class="k">if</span> <span class="n">lowest_error</span><span class="p">:</span>
</span><span id="MSPeakCalculation-899"><a href="#MSPeakCalculation-899"><span class="linenos"> 899</span></a>                <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="MSPeakCalculation-900"><a href="#MSPeakCalculation-900"><span class="linenos"> 900</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-901"><a href="#MSPeakCalculation-901"><span class="linenos"> 901</span></a>                <span class="k">return</span> <span class="n">candidates</span>
</span><span id="MSPeakCalculation-902"><a href="#MSPeakCalculation-902"><span class="linenos"> 902</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-903"><a href="#MSPeakCalculation-903"><span class="linenos"> 903</span></a>            <span class="k">return</span> <span class="n">candidates</span>
</span><span id="MSPeakCalculation-904"><a href="#MSPeakCalculation-904"><span class="linenos"> 904</span></a>
</span><span id="MSPeakCalculation-905"><a href="#MSPeakCalculation-905"><span class="linenos"> 905</span></a>    <span class="k">def</span> <span class="nf">cia_score_S_P_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MSPeakCalculation-906"><a href="#MSPeakCalculation-906"><span class="linenos"> 906</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compound Identification Algorithm SP Error - Assignment Filter</span>
</span><span id="MSPeakCalculation-907"><a href="#MSPeakCalculation-907"><span class="linenos"> 907</span></a>
</span><span id="MSPeakCalculation-908"><a href="#MSPeakCalculation-908"><span class="linenos"> 908</span></a><span class="sd">        This function applies the Compound Identification Algorithm (CIA) SP Error filter to possible molecular formula assignments.</span>
</span><span id="MSPeakCalculation-909"><a href="#MSPeakCalculation-909"><span class="linenos"> 909</span></a>
</span><span id="MSPeakCalculation-910"><a href="#MSPeakCalculation-910"><span class="linenos"> 910</span></a><span class="sd">        It takes the molecular formula with the lowest S+P count, and returns the formula with the lowest absolute error from this subset.</span>
</span><span id="MSPeakCalculation-911"><a href="#MSPeakCalculation-911"><span class="linenos"> 911</span></a>
</span><span id="MSPeakCalculation-912"><a href="#MSPeakCalculation-912"><span class="linenos"> 912</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation-913"><a href="#MSPeakCalculation-913"><span class="linenos"> 913</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation-914"><a href="#MSPeakCalculation-914"><span class="linenos"> 914</span></a><span class="sd">        MolecularFormula</span>
</span><span id="MSPeakCalculation-915"><a href="#MSPeakCalculation-915"><span class="linenos"> 915</span></a><span class="sd">            A single molecular formula which fits the rules of the CIA SP Error filter</span>
</span><span id="MSPeakCalculation-916"><a href="#MSPeakCalculation-916"><span class="linenos"> 916</span></a>
</span><span id="MSPeakCalculation-917"><a href="#MSPeakCalculation-917"><span class="linenos"> 917</span></a>
</span><span id="MSPeakCalculation-918"><a href="#MSPeakCalculation-918"><span class="linenos"> 918</span></a><span class="sd">        References</span>
</span><span id="MSPeakCalculation-919"><a href="#MSPeakCalculation-919"><span class="linenos"> 919</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-920"><a href="#MSPeakCalculation-920"><span class="linenos"> 920</span></a><span class="sd">        1. Elizabeth B. Kujawinski and Mark D. Behn, &quot;Automated Analysis of Electrospray Ionization Fourier Transform Ion Cyclotron Resonance Mass Spectra of Natural Organic Matter&quot;</span>
</span><span id="MSPeakCalculation-921"><a href="#MSPeakCalculation-921"><span class="linenos"> 921</span></a><span class="sd">            Anal. Chem. 2006, 78, 13, 4363–4373</span>
</span><span id="MSPeakCalculation-922"><a href="#MSPeakCalculation-922"><span class="linenos"> 922</span></a><span class="sd">            doi: 10.1021/ac0600306</span>
</span><span id="MSPeakCalculation-923"><a href="#MSPeakCalculation-923"><span class="linenos"> 923</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-924"><a href="#MSPeakCalculation-924"><span class="linenos"> 924</span></a>        <span class="c1"># case EFormulaScore.HAcap:</span>
</span><span id="MSPeakCalculation-925"><a href="#MSPeakCalculation-925"><span class="linenos"> 925</span></a>
</span><span id="MSPeakCalculation-926"><a href="#MSPeakCalculation-926"><span class="linenos"> 926</span></a>        <span class="n">lowest_S_P_mf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
</span><span id="MSPeakCalculation-927"><a href="#MSPeakCalculation-927"><span class="linenos"> 927</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
</span><span id="MSPeakCalculation-928"><a href="#MSPeakCalculation-928"><span class="linenos"> 928</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation-929"><a href="#MSPeakCalculation-929"><span class="linenos"> 929</span></a>        <span class="n">lowest_S_P_count</span> <span class="o">=</span> <span class="n">lowest_S_P_mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">lowest_S_P_mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
</span><span id="MSPeakCalculation-930"><a href="#MSPeakCalculation-930"><span class="linenos"> 930</span></a>
</span><span id="MSPeakCalculation-931"><a href="#MSPeakCalculation-931"><span class="linenos"> 931</span></a>        <span class="n">list_same_s_p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="MSPeakCalculation-932"><a href="#MSPeakCalculation-932"><span class="linenos"> 932</span></a>            <span class="nb">filter</span><span class="p">(</span>
</span><span id="MSPeakCalculation-933"><a href="#MSPeakCalculation-933"><span class="linenos"> 933</span></a>                <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">lowest_S_P_count</span><span class="p">,</span>
</span><span id="MSPeakCalculation-934"><a href="#MSPeakCalculation-934"><span class="linenos"> 934</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="MSPeakCalculation-935"><a href="#MSPeakCalculation-935"><span class="linenos"> 935</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-936"><a href="#MSPeakCalculation-936"><span class="linenos"> 936</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation-937"><a href="#MSPeakCalculation-937"><span class="linenos"> 937</span></a>
</span><span id="MSPeakCalculation-938"><a href="#MSPeakCalculation-938"><span class="linenos"> 938</span></a>        <span class="c1"># check if list is not empty</span>
</span><span id="MSPeakCalculation-939"><a href="#MSPeakCalculation-939"><span class="linenos"> 939</span></a>        <span class="k">if</span> <span class="n">list_same_s_p</span><span class="p">:</span>
</span><span id="MSPeakCalculation-940"><a href="#MSPeakCalculation-940"><span class="linenos"> 940</span></a>            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">list_same_s_p</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="MSPeakCalculation-941"><a href="#MSPeakCalculation-941"><span class="linenos"> 941</span></a>
</span><span id="MSPeakCalculation-942"><a href="#MSPeakCalculation-942"><span class="linenos"> 942</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-943"><a href="#MSPeakCalculation-943"><span class="linenos"> 943</span></a>            <span class="k">return</span> <span class="n">lowest_S_P_mf</span>
</span><span id="MSPeakCalculation-944"><a href="#MSPeakCalculation-944"><span class="linenos"> 944</span></a>
</span><span id="MSPeakCalculation-945"><a href="#MSPeakCalculation-945"><span class="linenos"> 945</span></a>    <span class="k">def</span> <span class="nf">cia_score_N_S_P_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MSPeakCalculation-946"><a href="#MSPeakCalculation-946"><span class="linenos"> 946</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compound Identification Algorithm NSP Error - Assignment Filter</span>
</span><span id="MSPeakCalculation-947"><a href="#MSPeakCalculation-947"><span class="linenos"> 947</span></a>
</span><span id="MSPeakCalculation-948"><a href="#MSPeakCalculation-948"><span class="linenos"> 948</span></a><span class="sd">        This function applies the Compound Identification Algorithm (CIA) NSP Error filter to possible molecular formula assignments.</span>
</span><span id="MSPeakCalculation-949"><a href="#MSPeakCalculation-949"><span class="linenos"> 949</span></a>
</span><span id="MSPeakCalculation-950"><a href="#MSPeakCalculation-950"><span class="linenos"> 950</span></a><span class="sd">        It takes the molecular formula with the lowest N+S+P count, and returns the formula with the lowest absolute error from this subset.</span>
</span><span id="MSPeakCalculation-951"><a href="#MSPeakCalculation-951"><span class="linenos"> 951</span></a>
</span><span id="MSPeakCalculation-952"><a href="#MSPeakCalculation-952"><span class="linenos"> 952</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation-953"><a href="#MSPeakCalculation-953"><span class="linenos"> 953</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation-954"><a href="#MSPeakCalculation-954"><span class="linenos"> 954</span></a><span class="sd">        MolecularFormula</span>
</span><span id="MSPeakCalculation-955"><a href="#MSPeakCalculation-955"><span class="linenos"> 955</span></a><span class="sd">            A single molecular formula which fits the rules of the CIA NSP Error filter</span>
</span><span id="MSPeakCalculation-956"><a href="#MSPeakCalculation-956"><span class="linenos"> 956</span></a>
</span><span id="MSPeakCalculation-957"><a href="#MSPeakCalculation-957"><span class="linenos"> 957</span></a><span class="sd">        References</span>
</span><span id="MSPeakCalculation-958"><a href="#MSPeakCalculation-958"><span class="linenos"> 958</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation-959"><a href="#MSPeakCalculation-959"><span class="linenos"> 959</span></a><span class="sd">        1. Elizabeth B. Kujawinski and Mark D. Behn, &quot;Automated Analysis of Electrospray Ionization Fourier Transform Ion Cyclotron Resonance Mass Spectra of Natural Organic Matter&quot;</span>
</span><span id="MSPeakCalculation-960"><a href="#MSPeakCalculation-960"><span class="linenos"> 960</span></a><span class="sd">            Anal. Chem. 2006, 78, 13, 4363–4373</span>
</span><span id="MSPeakCalculation-961"><a href="#MSPeakCalculation-961"><span class="linenos"> 961</span></a><span class="sd">            doi: 10.1021/ac0600306</span>
</span><span id="MSPeakCalculation-962"><a href="#MSPeakCalculation-962"><span class="linenos"> 962</span></a>
</span><span id="MSPeakCalculation-963"><a href="#MSPeakCalculation-963"><span class="linenos"> 963</span></a><span class="sd">        Raises</span>
</span><span id="MSPeakCalculation-964"><a href="#MSPeakCalculation-964"><span class="linenos"> 964</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation-965"><a href="#MSPeakCalculation-965"><span class="linenos"> 965</span></a><span class="sd">        Exception</span>
</span><span id="MSPeakCalculation-966"><a href="#MSPeakCalculation-966"><span class="linenos"> 966</span></a><span class="sd">            If no molecular formula are associated with mass spectrum peak.</span>
</span><span id="MSPeakCalculation-967"><a href="#MSPeakCalculation-967"><span class="linenos"> 967</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation-968"><a href="#MSPeakCalculation-968"><span class="linenos"> 968</span></a>        <span class="c1"># case EFormulaScore.HAcap:</span>
</span><span id="MSPeakCalculation-969"><a href="#MSPeakCalculation-969"><span class="linenos"> 969</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">:</span>
</span><span id="MSPeakCalculation-970"><a href="#MSPeakCalculation-970"><span class="linenos"> 970</span></a>            <span class="n">lowest_N_S_P_mf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
</span><span id="MSPeakCalculation-971"><a href="#MSPeakCalculation-971"><span class="linenos"> 971</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="MSPeakCalculation-972"><a href="#MSPeakCalculation-972"><span class="linenos"> 972</span></a>                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">),</span>
</span><span id="MSPeakCalculation-973"><a href="#MSPeakCalculation-973"><span class="linenos"> 973</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-974"><a href="#MSPeakCalculation-974"><span class="linenos"> 974</span></a>            <span class="n">lowest_N_S_P_count</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MSPeakCalculation-975"><a href="#MSPeakCalculation-975"><span class="linenos"> 975</span></a>                <span class="n">lowest_N_S_P_mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
</span><span id="MSPeakCalculation-976"><a href="#MSPeakCalculation-976"><span class="linenos"> 976</span></a>                <span class="o">+</span> <span class="n">lowest_N_S_P_mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>
</span><span id="MSPeakCalculation-977"><a href="#MSPeakCalculation-977"><span class="linenos"> 977</span></a>                <span class="o">+</span> <span class="n">lowest_N_S_P_mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
</span><span id="MSPeakCalculation-978"><a href="#MSPeakCalculation-978"><span class="linenos"> 978</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-979"><a href="#MSPeakCalculation-979"><span class="linenos"> 979</span></a>
</span><span id="MSPeakCalculation-980"><a href="#MSPeakCalculation-980"><span class="linenos"> 980</span></a>            <span class="n">list_same_N_S_P</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="MSPeakCalculation-981"><a href="#MSPeakCalculation-981"><span class="linenos"> 981</span></a>                <span class="nb">filter</span><span class="p">(</span>
</span><span id="MSPeakCalculation-982"><a href="#MSPeakCalculation-982"><span class="linenos"> 982</span></a>                    <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
</span><span id="MSPeakCalculation-983"><a href="#MSPeakCalculation-983"><span class="linenos"> 983</span></a>                    <span class="o">==</span> <span class="n">lowest_N_S_P_count</span><span class="p">,</span>
</span><span id="MSPeakCalculation-984"><a href="#MSPeakCalculation-984"><span class="linenos"> 984</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="MSPeakCalculation-985"><a href="#MSPeakCalculation-985"><span class="linenos"> 985</span></a>                <span class="p">)</span>
</span><span id="MSPeakCalculation-986"><a href="#MSPeakCalculation-986"><span class="linenos"> 986</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation-987"><a href="#MSPeakCalculation-987"><span class="linenos"> 987</span></a>
</span><span id="MSPeakCalculation-988"><a href="#MSPeakCalculation-988"><span class="linenos"> 988</span></a>            <span class="k">if</span> <span class="n">list_same_N_S_P</span><span class="p">:</span>
</span><span id="MSPeakCalculation-989"><a href="#MSPeakCalculation-989"><span class="linenos"> 989</span></a>                <span class="n">SP_filtered_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="MSPeakCalculation-990"><a href="#MSPeakCalculation-990"><span class="linenos"> 990</span></a>                    <span class="nb">filter</span><span class="p">(</span>
</span><span id="MSPeakCalculation-991"><a href="#MSPeakCalculation-991"><span class="linenos"> 991</span></a>                        <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="MSPeakCalculation-992"><a href="#MSPeakCalculation-992"><span class="linenos"> 992</span></a>                        <span class="n">list_same_N_S_P</span><span class="p">,</span>
</span><span id="MSPeakCalculation-993"><a href="#MSPeakCalculation-993"><span class="linenos"> 993</span></a>                    <span class="p">)</span>
</span><span id="MSPeakCalculation-994"><a href="#MSPeakCalculation-994"><span class="linenos"> 994</span></a>                <span class="p">)</span>
</span><span id="MSPeakCalculation-995"><a href="#MSPeakCalculation-995"><span class="linenos"> 995</span></a>
</span><span id="MSPeakCalculation-996"><a href="#MSPeakCalculation-996"><span class="linenos"> 996</span></a>                <span class="k">if</span> <span class="n">SP_filtered_list</span><span class="p">:</span>
</span><span id="MSPeakCalculation-997"><a href="#MSPeakCalculation-997"><span class="linenos"> 997</span></a>                    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">SP_filtered_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="MSPeakCalculation-998"><a href="#MSPeakCalculation-998"><span class="linenos"> 998</span></a>
</span><span id="MSPeakCalculation-999"><a href="#MSPeakCalculation-999"><span class="linenos"> 999</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-1000"><a href="#MSPeakCalculation-1000"><span class="linenos">1000</span></a>                    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">list_same_N_S_P</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="MSPeakCalculation-1001"><a href="#MSPeakCalculation-1001"><span class="linenos">1001</span></a>
</span><span id="MSPeakCalculation-1002"><a href="#MSPeakCalculation-1002"><span class="linenos">1002</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-1003"><a href="#MSPeakCalculation-1003"><span class="linenos">1003</span></a>                <span class="k">return</span> <span class="n">lowest_N_S_P_mf</span>
</span><span id="MSPeakCalculation-1004"><a href="#MSPeakCalculation-1004"><span class="linenos">1004</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation-1005"><a href="#MSPeakCalculation-1005"><span class="linenos">1005</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="MSPeakCalculation-1006"><a href="#MSPeakCalculation-1006"><span class="linenos">1006</span></a>                <span class="s2">&quot;No molecular formula associated with the mass spectrum peak at m/z: </span><span class="si">%.6f</span><span class="s2">&quot;</span>
</span><span id="MSPeakCalculation-1007"><a href="#MSPeakCalculation-1007"><span class="linenos">1007</span></a>                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span>
</span><span id="MSPeakCalculation-1008"><a href="#MSPeakCalculation-1008"><span class="linenos">1008</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Class to perform calculations on MSPeak objects.</p>

<p>This class provides methods to perform various calculations on MSPeak objects, such as calculating Kendrick Mass Defect (KMD) and Kendrick Mass (KM), calculating peak area, and fitting peak lineshape using different models.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>None</strong></li>
</ul>

<h6 id="attributes">Attributes</h6>

<ul>
<li><strong>_ms_parent</strong> (MSParent):
The parent MSParent object associated with the MSPeakCalculation object.</li>
<li><strong>mz_exp</strong> (float):
The experimental m/z value of the peak.</li>
<li><strong>peak_left_index</strong> (int):
The start scan index of the peak.</li>
<li><strong>peak_right_index</strong> (int):
The final scan index of the peak.</li>
<li><strong>resolving_power</strong> (float):
The resolving power of the peak.</li>
</ul>

<h6 id="methods">Methods</h6>

<ul>
<li>_calc_kmd(dict_base).
Calculate the Kendrick Mass Defect (KMD) and Kendrick Mass (KM) for a given base formula.</li>
<li>calc_area().
Calculate the peak area using numpy's trapezoidal fit.</li>
<li>fit_peak(mz_extend=6, delta_rp=0, model='Gaussian').
Perform lineshape analysis on a peak using lmfit module.</li>
<li>voigt_pso(w, r, yoff, width, loc, a).
Calculate the Voigt function for particle swarm optimization (PSO) fitting.</li>
<li>objective_pso(x, w, u).
Calculate the objective function for PSO fitting.</li>
<li>minimize_pso(lower, upper, w, u).
Minimize the objective function using the particle swarm optimization algorithm.</li>
<li>fit_peak_pso(mz_extend=6, upsample_multiplier=5).
Perform lineshape analysis on a peak using particle swarm optimization (PSO) fitting.</li>
<li>voigt(oversample_multiplier=1, delta_rp=0, mz_overlay=1).
[Legacy] Perform voigt lineshape analysis on a peak.</li>
<li>pseudovoigt(oversample_multiplier=1, delta_rp=0, mz_overlay=1, fraction=0.5).
[Legacy] Perform pseudovoigt lineshape analysis on a peak.</li>
<li>lorentz(oversample_multiplier=1, delta_rp=0, mz_overlay=1).
[Legacy] Perform lorentz lineshape analysis on a peak.</li>
<li>gaussian(oversample_multiplier=1, delta_rp=0, mz_overlay=1).
[Legacy] Perform gaussian lineshape analysis on a peak.</li>
<li>get_mz_domain(oversample_multiplier, mz_overlay).
[Legacy] Resample/interpolate datapoints for lineshape analysis.</li>
<li>number_possible_assignments().
Return the number of possible molecular formula assignments for the peak.</li>
<li>molecular_formula_lowest_error().
Return the molecular formula with the smallest absolute mz error.</li>
<li>molecular_formula_highest_prob_score().
Return the molecular formula with the highest confidence score.</li>
<li>molecular_formula_earth_filter(lowest_error=True).
Filter molecular formula using the 'Earth' filter.</li>
<li>molecular_formula_water_filter(lowest_error=True).
Filter molecular formula using the 'Water' filter.</li>
<li>molecular_formula_air_filter(lowest_error=True).
Filter molecular formula using the 'Air' filter.</li>
<li>cia_score_S_P_error().
Compound Identification Algorithm SP Error - Assignment Filter.</li>
<li>cia_score_N_S_P_error().
Compound Identification Algorithm NSP Error - Assignment Filter.</li>
</ul>
</div>


                            <div id="MSPeakCalculation.calc_area" class="classattr">
                                        <input id="MSPeakCalculation.calc_area-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calc_area</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.calc_area-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.calc_area"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.calc_area-145"><a href="#MSPeakCalculation.calc_area-145"><span class="linenos">145</span></a>    <span class="k">def</span> <span class="nf">calc_area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MSPeakCalculation.calc_area-146"><a href="#MSPeakCalculation.calc_area-146"><span class="linenos">146</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the peak area using numpy&#39;s trapezoidal fit</span>
</span><span id="MSPeakCalculation.calc_area-147"><a href="#MSPeakCalculation.calc_area-147"><span class="linenos">147</span></a>
</span><span id="MSPeakCalculation.calc_area-148"><a href="#MSPeakCalculation.calc_area-148"><span class="linenos">148</span></a><span class="sd">        uses provided mz_domain to accurately integrate areas independent of digital resolution</span>
</span><span id="MSPeakCalculation.calc_area-149"><a href="#MSPeakCalculation.calc_area-149"><span class="linenos">149</span></a>
</span><span id="MSPeakCalculation.calc_area-150"><a href="#MSPeakCalculation.calc_area-150"><span class="linenos">150</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation.calc_area-151"><a href="#MSPeakCalculation.calc_area-151"><span class="linenos">151</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation.calc_area-152"><a href="#MSPeakCalculation.calc_area-152"><span class="linenos">152</span></a><span class="sd">        float</span>
</span><span id="MSPeakCalculation.calc_area-153"><a href="#MSPeakCalculation.calc_area-153"><span class="linenos">153</span></a><span class="sd">            peak area</span>
</span><span id="MSPeakCalculation.calc_area-154"><a href="#MSPeakCalculation.calc_area-154"><span class="linenos">154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.calc_area-155"><a href="#MSPeakCalculation.calc_area-155"><span class="linenos">155</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span><span class="p">:</span>
</span><span id="MSPeakCalculation.calc_area-156"><a href="#MSPeakCalculation.calc_area-156"><span class="linenos">156</span></a>            <span class="n">yy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">abundance_profile</span><span class="p">[</span>
</span><span id="MSPeakCalculation.calc_area-157"><a href="#MSPeakCalculation.calc_area-157"><span class="linenos">157</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span>
</span><span id="MSPeakCalculation.calc_area-158"><a href="#MSPeakCalculation.calc_area-158"><span class="linenos">158</span></a>            <span class="p">]</span>
</span><span id="MSPeakCalculation.calc_area-159"><a href="#MSPeakCalculation.calc_area-159"><span class="linenos">159</span></a>            <span class="n">xx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">[</span>
</span><span id="MSPeakCalculation.calc_area-160"><a href="#MSPeakCalculation.calc_area-160"><span class="linenos">160</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span>
</span><span id="MSPeakCalculation.calc_area-161"><a href="#MSPeakCalculation.calc_area-161"><span class="linenos">161</span></a>            <span class="p">]</span>
</span><span id="MSPeakCalculation.calc_area-162"><a href="#MSPeakCalculation.calc_area-162"><span class="linenos">162</span></a>            <span class="c1"># check if the axis is high to low m/z or not. if its MSFromFreq its high mz first, if its from Profile, its low mz first</span>
</span><span id="MSPeakCalculation.calc_area-163"><a href="#MSPeakCalculation.calc_area-163"><span class="linenos">163</span></a>            <span class="k">if</span> <span class="n">xx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="MSPeakCalculation.calc_area-164"><a href="#MSPeakCalculation.calc_area-164"><span class="linenos">164</span></a>                <span class="n">xx</span> <span class="o">=</span> <span class="n">flip</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
</span><span id="MSPeakCalculation.calc_area-165"><a href="#MSPeakCalculation.calc_area-165"><span class="linenos">165</span></a>                <span class="n">yy</span> <span class="o">=</span> <span class="n">flip</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
</span><span id="MSPeakCalculation.calc_area-166"><a href="#MSPeakCalculation.calc_area-166"><span class="linenos">166</span></a>            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">trapz</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">))</span>
</span><span id="MSPeakCalculation.calc_area-167"><a href="#MSPeakCalculation.calc_area-167"><span class="linenos">167</span></a>
</span><span id="MSPeakCalculation.calc_area-168"><a href="#MSPeakCalculation.calc_area-168"><span class="linenos">168</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.calc_area-169"><a href="#MSPeakCalculation.calc_area-169"><span class="linenos">169</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="MSPeakCalculation.calc_area-170"><a href="#MSPeakCalculation.calc_area-170"><span class="linenos">170</span></a>                <span class="s2">&quot;Peak Area Calculation for m/z </span><span class="si">{}</span><span class="s2"> has failed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">)</span>
</span><span id="MSPeakCalculation.calc_area-171"><a href="#MSPeakCalculation.calc_area-171"><span class="linenos">171</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation.calc_area-172"><a href="#MSPeakCalculation.calc_area-172"><span class="linenos">172</span></a>            <span class="k">return</span> <span class="n">nan</span>
</span></pre></div>


            <div class="docstring"><p>Calculate the peak area using numpy's trapezoidal fit</p>

<p>uses provided mz_domain to accurately integrate areas independent of digital resolution</p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>float</strong>: peak area</li>
</ul>
</div>


                            </div>
                            <div id="MSPeakCalculation.fit_peak" class="classattr">
                                        <input id="MSPeakCalculation.fit_peak-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fit_peak</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mz_extend</span><span class="o">=</span><span class="mi">6</span>, </span><span class="param"><span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">model</span><span class="o">=</span><span class="s1">&#39;Gaussian&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.fit_peak-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.fit_peak"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.fit_peak-174"><a href="#MSPeakCalculation.fit_peak-174"><span class="linenos">174</span></a>    <span class="k">def</span> <span class="nf">fit_peak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz_extend</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;Gaussian&quot;</span><span class="p">):</span>
</span><span id="MSPeakCalculation.fit_peak-175"><a href="#MSPeakCalculation.fit_peak-175"><span class="linenos">175</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Lineshape analysis on a peak using lmfit module.</span>
</span><span id="MSPeakCalculation.fit_peak-176"><a href="#MSPeakCalculation.fit_peak-176"><span class="linenos">176</span></a>
</span><span id="MSPeakCalculation.fit_peak-177"><a href="#MSPeakCalculation.fit_peak-177"><span class="linenos">177</span></a><span class="sd">        Model and fit peak lineshape by defined function - using lmfit module</span>
</span><span id="MSPeakCalculation.fit_peak-178"><a href="#MSPeakCalculation.fit_peak-178"><span class="linenos">178</span></a><span class="sd">        Does not oversample/resample/interpolate data points</span>
</span><span id="MSPeakCalculation.fit_peak-179"><a href="#MSPeakCalculation.fit_peak-179"><span class="linenos">179</span></a><span class="sd">        Better to go back to time domain and perform more zero filling - if possible.</span>
</span><span id="MSPeakCalculation.fit_peak-180"><a href="#MSPeakCalculation.fit_peak-180"><span class="linenos">180</span></a>
</span><span id="MSPeakCalculation.fit_peak-181"><a href="#MSPeakCalculation.fit_peak-181"><span class="linenos">181</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation.fit_peak-182"><a href="#MSPeakCalculation.fit_peak-182"><span class="linenos">182</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.fit_peak-183"><a href="#MSPeakCalculation.fit_peak-183"><span class="linenos">183</span></a><span class="sd">        mz_extend : int</span>
</span><span id="MSPeakCalculation.fit_peak-184"><a href="#MSPeakCalculation.fit_peak-184"><span class="linenos">184</span></a><span class="sd">            extra points left and right of peak definition to include in fitting</span>
</span><span id="MSPeakCalculation.fit_peak-185"><a href="#MSPeakCalculation.fit_peak-185"><span class="linenos">185</span></a><span class="sd">        delta_rp : float</span>
</span><span id="MSPeakCalculation.fit_peak-186"><a href="#MSPeakCalculation.fit_peak-186"><span class="linenos">186</span></a><span class="sd">            delta resolving power to add to resolving power</span>
</span><span id="MSPeakCalculation.fit_peak-187"><a href="#MSPeakCalculation.fit_peak-187"><span class="linenos">187</span></a><span class="sd">        model : str</span>
</span><span id="MSPeakCalculation.fit_peak-188"><a href="#MSPeakCalculation.fit_peak-188"><span class="linenos">188</span></a><span class="sd">            Type of lineshape model to use.</span>
</span><span id="MSPeakCalculation.fit_peak-189"><a href="#MSPeakCalculation.fit_peak-189"><span class="linenos">189</span></a><span class="sd">            Models allowed: Gaussian, Lorentz, Voigt</span>
</span><span id="MSPeakCalculation.fit_peak-190"><a href="#MSPeakCalculation.fit_peak-190"><span class="linenos">190</span></a>
</span><span id="MSPeakCalculation.fit_peak-191"><a href="#MSPeakCalculation.fit_peak-191"><span class="linenos">191</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation.fit_peak-192"><a href="#MSPeakCalculation.fit_peak-192"><span class="linenos">192</span></a><span class="sd">        -----</span>
</span><span id="MSPeakCalculation.fit_peak-193"><a href="#MSPeakCalculation.fit_peak-193"><span class="linenos">193</span></a><span class="sd">        mz_domain : ndarray</span>
</span><span id="MSPeakCalculation.fit_peak-194"><a href="#MSPeakCalculation.fit_peak-194"><span class="linenos">194</span></a><span class="sd">            x-axis domain for fit</span>
</span><span id="MSPeakCalculation.fit_peak-195"><a href="#MSPeakCalculation.fit_peak-195"><span class="linenos">195</span></a><span class="sd">        fit_peak : lmfit object</span>
</span><span id="MSPeakCalculation.fit_peak-196"><a href="#MSPeakCalculation.fit_peak-196"><span class="linenos">196</span></a><span class="sd">            fit results object from lmfit module</span>
</span><span id="MSPeakCalculation.fit_peak-197"><a href="#MSPeakCalculation.fit_peak-197"><span class="linenos">197</span></a>
</span><span id="MSPeakCalculation.fit_peak-198"><a href="#MSPeakCalculation.fit_peak-198"><span class="linenos">198</span></a><span class="sd">        Notes</span>
</span><span id="MSPeakCalculation.fit_peak-199"><a href="#MSPeakCalculation.fit_peak-199"><span class="linenos">199</span></a><span class="sd">        -----</span>
</span><span id="MSPeakCalculation.fit_peak-200"><a href="#MSPeakCalculation.fit_peak-200"><span class="linenos">200</span></a><span class="sd">        Returns the calculated mz domain, initial defined abundance profile, and the fit peak results object from lmfit module</span>
</span><span id="MSPeakCalculation.fit_peak-201"><a href="#MSPeakCalculation.fit_peak-201"><span class="linenos">201</span></a><span class="sd">        mz_extend here extends the x-axis domain so that we have sufficient points either side of the apex to fit.</span>
</span><span id="MSPeakCalculation.fit_peak-202"><a href="#MSPeakCalculation.fit_peak-202"><span class="linenos">202</span></a><span class="sd">        Takes about 10ms per peak</span>
</span><span id="MSPeakCalculation.fit_peak-203"><a href="#MSPeakCalculation.fit_peak-203"><span class="linenos">203</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.fit_peak-204"><a href="#MSPeakCalculation.fit_peak-204"><span class="linenos">204</span></a>        <span class="n">start_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MSPeakCalculation.fit_peak-205"><a href="#MSPeakCalculation.fit_peak-205"><span class="linenos">205</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">-</span> <span class="n">mz_extend</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="MSPeakCalculation.fit_peak-206"><a href="#MSPeakCalculation.fit_peak-206"><span class="linenos">206</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation.fit_peak-207"><a href="#MSPeakCalculation.fit_peak-207"><span class="linenos">207</span></a>        <span class="n">final_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MSPeakCalculation.fit_peak-208"><a href="#MSPeakCalculation.fit_peak-208"><span class="linenos">208</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">+</span> <span class="n">mz_extend</span>
</span><span id="MSPeakCalculation.fit_peak-209"><a href="#MSPeakCalculation.fit_peak-209"><span class="linenos">209</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">)</span>
</span><span id="MSPeakCalculation.fit_peak-210"><a href="#MSPeakCalculation.fit_peak-210"><span class="linenos">210</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span>
</span><span id="MSPeakCalculation.fit_peak-211"><a href="#MSPeakCalculation.fit_peak-211"><span class="linenos">211</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation.fit_peak-212"><a href="#MSPeakCalculation.fit_peak-212"><span class="linenos">212</span></a>
</span><span id="MSPeakCalculation.fit_peak-213"><a href="#MSPeakCalculation.fit_peak-213"><span class="linenos">213</span></a>        <span class="c1"># check if MSPeak contains the resolving power info</span>
</span><span id="MSPeakCalculation.fit_peak-214"><a href="#MSPeakCalculation.fit_peak-214"><span class="linenos">214</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="MSPeakCalculation.fit_peak-215"><a href="#MSPeakCalculation.fit_peak-215"><span class="linenos">215</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="MSPeakCalculation.fit_peak-216"><a href="#MSPeakCalculation.fit_peak-216"><span class="linenos">216</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span> <span class="o">+</span> <span class="n">delta_rp</span><span class="p">)</span>
</span><span id="MSPeakCalculation.fit_peak-217"><a href="#MSPeakCalculation.fit_peak-217"><span class="linenos">217</span></a>
</span><span id="MSPeakCalculation.fit_peak-218"><a href="#MSPeakCalculation.fit_peak-218"><span class="linenos">218</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">final_index</span><span class="p">]</span>
</span><span id="MSPeakCalculation.fit_peak-219"><a href="#MSPeakCalculation.fit_peak-219"><span class="linenos">219</span></a>            <span class="n">abundance_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">abundance_profile</span><span class="p">[</span>
</span><span id="MSPeakCalculation.fit_peak-220"><a href="#MSPeakCalculation.fit_peak-220"><span class="linenos">220</span></a>                <span class="n">start_index</span><span class="p">:</span><span class="n">final_index</span>
</span><span id="MSPeakCalculation.fit_peak-221"><a href="#MSPeakCalculation.fit_peak-221"><span class="linenos">221</span></a>            <span class="p">]</span>
</span><span id="MSPeakCalculation.fit_peak-222"><a href="#MSPeakCalculation.fit_peak-222"><span class="linenos">222</span></a>
</span><span id="MSPeakCalculation.fit_peak-223"><a href="#MSPeakCalculation.fit_peak-223"><span class="linenos">223</span></a>            <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Gaussian&quot;</span><span class="p">:</span>
</span><span id="MSPeakCalculation.fit_peak-224"><a href="#MSPeakCalculation.fit_peak-224"><span class="linenos">224</span></a>                <span class="c1"># stardard deviation</span>
</span><span id="MSPeakCalculation.fit_peak-225"><a href="#MSPeakCalculation.fit_peak-225"><span class="linenos">225</span></a>                <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
</span><span id="MSPeakCalculation.fit_peak-226"><a href="#MSPeakCalculation.fit_peak-226"><span class="linenos">226</span></a>                <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="MSPeakCalculation.fit_peak-227"><a href="#MSPeakCalculation.fit_peak-227"><span class="linenos">227</span></a>                <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GaussianModel</span><span class="p">()</span>
</span><span id="MSPeakCalculation.fit_peak-228"><a href="#MSPeakCalculation.fit_peak-228"><span class="linenos">228</span></a>                <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="MSPeakCalculation.fit_peak-229"><a href="#MSPeakCalculation.fit_peak-229"><span class="linenos">229</span></a>                    <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="MSPeakCalculation.fit_peak-230"><a href="#MSPeakCalculation.fit_peak-230"><span class="linenos">230</span></a>                <span class="p">)</span>
</span><span id="MSPeakCalculation.fit_peak-231"><a href="#MSPeakCalculation.fit_peak-231"><span class="linenos">231</span></a>
</span><span id="MSPeakCalculation.fit_peak-232"><a href="#MSPeakCalculation.fit_peak-232"><span class="linenos">232</span></a>            <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Lorentz&quot;</span><span class="p">:</span>
</span><span id="MSPeakCalculation.fit_peak-233"><a href="#MSPeakCalculation.fit_peak-233"><span class="linenos">233</span></a>                <span class="c1"># stardard deviation</span>
</span><span id="MSPeakCalculation.fit_peak-234"><a href="#MSPeakCalculation.fit_peak-234"><span class="linenos">234</span></a>                <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="MSPeakCalculation.fit_peak-235"><a href="#MSPeakCalculation.fit_peak-235"><span class="linenos">235</span></a>                <span class="n">amplitude</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="MSPeakCalculation.fit_peak-236"><a href="#MSPeakCalculation.fit_peak-236"><span class="linenos">236</span></a>                <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">LorentzianModel</span><span class="p">()</span>
</span><span id="MSPeakCalculation.fit_peak-237"><a href="#MSPeakCalculation.fit_peak-237"><span class="linenos">237</span></a>                <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="MSPeakCalculation.fit_peak-238"><a href="#MSPeakCalculation.fit_peak-238"><span class="linenos">238</span></a>                    <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="MSPeakCalculation.fit_peak-239"><a href="#MSPeakCalculation.fit_peak-239"><span class="linenos">239</span></a>                <span class="p">)</span>
</span><span id="MSPeakCalculation.fit_peak-240"><a href="#MSPeakCalculation.fit_peak-240"><span class="linenos">240</span></a>
</span><span id="MSPeakCalculation.fit_peak-241"><a href="#MSPeakCalculation.fit_peak-241"><span class="linenos">241</span></a>            <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Voigt&quot;</span><span class="p">:</span>
</span><span id="MSPeakCalculation.fit_peak-242"><a href="#MSPeakCalculation.fit_peak-242"><span class="linenos">242</span></a>                <span class="c1"># stardard deviation</span>
</span><span id="MSPeakCalculation.fit_peak-243"><a href="#MSPeakCalculation.fit_peak-243"><span class="linenos">243</span></a>                <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="mf">3.6013</span>
</span><span id="MSPeakCalculation.fit_peak-244"><a href="#MSPeakCalculation.fit_peak-244"><span class="linenos">244</span></a>                <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="MSPeakCalculation.fit_peak-245"><a href="#MSPeakCalculation.fit_peak-245"><span class="linenos">245</span></a>                <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">VoigtModel</span><span class="p">()</span>
</span><span id="MSPeakCalculation.fit_peak-246"><a href="#MSPeakCalculation.fit_peak-246"><span class="linenos">246</span></a>                <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="MSPeakCalculation.fit_peak-247"><a href="#MSPeakCalculation.fit_peak-247"><span class="linenos">247</span></a>                    <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="MSPeakCalculation.fit_peak-248"><a href="#MSPeakCalculation.fit_peak-248"><span class="linenos">248</span></a>                <span class="p">)</span>
</span><span id="MSPeakCalculation.fit_peak-249"><a href="#MSPeakCalculation.fit_peak-249"><span class="linenos">249</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.fit_peak-250"><a href="#MSPeakCalculation.fit_peak-250"><span class="linenos">250</span></a>                <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s2">&quot;model lineshape not known or defined&quot;</span><span class="p">)</span>
</span><span id="MSPeakCalculation.fit_peak-251"><a href="#MSPeakCalculation.fit_peak-251"><span class="linenos">251</span></a>
</span><span id="MSPeakCalculation.fit_peak-252"><a href="#MSPeakCalculation.fit_peak-252"><span class="linenos">252</span></a>            <span class="c1"># calc_abundance = model.eval(params=params, x=mz_domain) #Same as initial fit, returned in fit_peak object</span>
</span><span id="MSPeakCalculation.fit_peak-253"><a href="#MSPeakCalculation.fit_peak-253"><span class="linenos">253</span></a>            <span class="n">fit_peak</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">abundance_domain</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mz_domain</span><span class="p">)</span>
</span><span id="MSPeakCalculation.fit_peak-254"><a href="#MSPeakCalculation.fit_peak-254"><span class="linenos">254</span></a>            <span class="k">return</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">fit_peak</span>
</span><span id="MSPeakCalculation.fit_peak-255"><a href="#MSPeakCalculation.fit_peak-255"><span class="linenos">255</span></a>
</span><span id="MSPeakCalculation.fit_peak-256"><a href="#MSPeakCalculation.fit_peak-256"><span class="linenos">256</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.fit_peak-257"><a href="#MSPeakCalculation.fit_peak-257"><span class="linenos">257</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="MSPeakCalculation.fit_peak-258"><a href="#MSPeakCalculation.fit_peak-258"><span class="linenos">258</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="MSPeakCalculation.fit_peak-259"><a href="#MSPeakCalculation.fit_peak-259"><span class="linenos">259</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Lineshape analysis on a peak using lmfit module.</p>

<p>Model and fit peak lineshape by defined function - using lmfit module
Does not oversample/resample/interpolate data points
Better to go back to time domain and perform more zero filling - if possible.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>mz_extend</strong> (int):
extra points left and right of peak definition to include in fitting</li>
<li><strong>delta_rp</strong> (float):
delta resolving power to add to resolving power</li>
<li><strong>model</strong> (str):
Type of lineshape model to use.
Models allowed: Gaussian, Lorentz, Voigt</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>mz_domain</strong> (ndarray):
x-axis domain for fit</li>
<li><strong>fit_peak</strong> (lmfit object):
fit results object from lmfit module</li>
</ul>

<h6 id="notes">Notes</h6>

<p>Returns the calculated mz domain, initial defined abundance profile, and the fit peak results object from lmfit module
mz_extend here extends the x-axis domain so that we have sufficient points either side of the apex to fit.
Takes about 10ms per peak</p>
</div>


                            </div>
                            <div id="MSPeakCalculation.voigt_pso" class="classattr">
                                        <input id="MSPeakCalculation.voigt_pso-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">voigt_pso</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">w</span>, </span><span class="param"><span class="n">r</span>, </span><span class="param"><span class="n">yoff</span>, </span><span class="param"><span class="n">width</span>, </span><span class="param"><span class="n">loc</span>, </span><span class="param"><span class="n">a</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.voigt_pso-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.voigt_pso"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.voigt_pso-261"><a href="#MSPeakCalculation.voigt_pso-261"><span class="linenos">261</span></a>    <span class="k">def</span> <span class="nf">voigt_pso</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">yoff</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
</span><span id="MSPeakCalculation.voigt_pso-262"><a href="#MSPeakCalculation.voigt_pso-262"><span class="linenos">262</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Voigt function for particle swarm optimisation (PSO) fitting</span>
</span><span id="MSPeakCalculation.voigt_pso-263"><a href="#MSPeakCalculation.voigt_pso-263"><span class="linenos">263</span></a>
</span><span id="MSPeakCalculation.voigt_pso-264"><a href="#MSPeakCalculation.voigt_pso-264"><span class="linenos">264</span></a><span class="sd">        From https://github.com/pnnl/nmrfit/blob/master/nmrfit/equations.py.</span>
</span><span id="MSPeakCalculation.voigt_pso-265"><a href="#MSPeakCalculation.voigt_pso-265"><span class="linenos">265</span></a><span class="sd">        Calculates a Voigt function over w based on the relevant properties of the distribution.</span>
</span><span id="MSPeakCalculation.voigt_pso-266"><a href="#MSPeakCalculation.voigt_pso-266"><span class="linenos">266</span></a>
</span><span id="MSPeakCalculation.voigt_pso-267"><a href="#MSPeakCalculation.voigt_pso-267"><span class="linenos">267</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation.voigt_pso-268"><a href="#MSPeakCalculation.voigt_pso-268"><span class="linenos">268</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.voigt_pso-269"><a href="#MSPeakCalculation.voigt_pso-269"><span class="linenos">269</span></a><span class="sd">        w : ndarray</span>
</span><span id="MSPeakCalculation.voigt_pso-270"><a href="#MSPeakCalculation.voigt_pso-270"><span class="linenos">270</span></a><span class="sd">            Array over which the Voigt function will be evaluated.</span>
</span><span id="MSPeakCalculation.voigt_pso-271"><a href="#MSPeakCalculation.voigt_pso-271"><span class="linenos">271</span></a><span class="sd">        r : float</span>
</span><span id="MSPeakCalculation.voigt_pso-272"><a href="#MSPeakCalculation.voigt_pso-272"><span class="linenos">272</span></a><span class="sd">            Ratio between the Guassian and Lorentzian functions.</span>
</span><span id="MSPeakCalculation.voigt_pso-273"><a href="#MSPeakCalculation.voigt_pso-273"><span class="linenos">273</span></a><span class="sd">        yoff : float</span>
</span><span id="MSPeakCalculation.voigt_pso-274"><a href="#MSPeakCalculation.voigt_pso-274"><span class="linenos">274</span></a><span class="sd">            Y-offset of the Voigt function.</span>
</span><span id="MSPeakCalculation.voigt_pso-275"><a href="#MSPeakCalculation.voigt_pso-275"><span class="linenos">275</span></a><span class="sd">        width : float</span>
</span><span id="MSPeakCalculation.voigt_pso-276"><a href="#MSPeakCalculation.voigt_pso-276"><span class="linenos">276</span></a><span class="sd">            The width of the Voigt function.</span>
</span><span id="MSPeakCalculation.voigt_pso-277"><a href="#MSPeakCalculation.voigt_pso-277"><span class="linenos">277</span></a><span class="sd">        loc : float</span>
</span><span id="MSPeakCalculation.voigt_pso-278"><a href="#MSPeakCalculation.voigt_pso-278"><span class="linenos">278</span></a><span class="sd">            Center of the Voigt function.</span>
</span><span id="MSPeakCalculation.voigt_pso-279"><a href="#MSPeakCalculation.voigt_pso-279"><span class="linenos">279</span></a><span class="sd">        a : float</span>
</span><span id="MSPeakCalculation.voigt_pso-280"><a href="#MSPeakCalculation.voigt_pso-280"><span class="linenos">280</span></a><span class="sd">            Area of the Voigt function.</span>
</span><span id="MSPeakCalculation.voigt_pso-281"><a href="#MSPeakCalculation.voigt_pso-281"><span class="linenos">281</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation.voigt_pso-282"><a href="#MSPeakCalculation.voigt_pso-282"><span class="linenos">282</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation.voigt_pso-283"><a href="#MSPeakCalculation.voigt_pso-283"><span class="linenos">283</span></a><span class="sd">        V : ndarray</span>
</span><span id="MSPeakCalculation.voigt_pso-284"><a href="#MSPeakCalculation.voigt_pso-284"><span class="linenos">284</span></a><span class="sd">            Array defining the Voigt function over w.</span>
</span><span id="MSPeakCalculation.voigt_pso-285"><a href="#MSPeakCalculation.voigt_pso-285"><span class="linenos">285</span></a>
</span><span id="MSPeakCalculation.voigt_pso-286"><a href="#MSPeakCalculation.voigt_pso-286"><span class="linenos">286</span></a><span class="sd">        References</span>
</span><span id="MSPeakCalculation.voigt_pso-287"><a href="#MSPeakCalculation.voigt_pso-287"><span class="linenos">287</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.voigt_pso-288"><a href="#MSPeakCalculation.voigt_pso-288"><span class="linenos">288</span></a><span class="sd">        1. https://github.com/pnnl/nmrfit</span>
</span><span id="MSPeakCalculation.voigt_pso-289"><a href="#MSPeakCalculation.voigt_pso-289"><span class="linenos">289</span></a>
</span><span id="MSPeakCalculation.voigt_pso-290"><a href="#MSPeakCalculation.voigt_pso-290"><span class="linenos">290</span></a><span class="sd">        Notes</span>
</span><span id="MSPeakCalculation.voigt_pso-291"><a href="#MSPeakCalculation.voigt_pso-291"><span class="linenos">291</span></a><span class="sd">        -----</span>
</span><span id="MSPeakCalculation.voigt_pso-292"><a href="#MSPeakCalculation.voigt_pso-292"><span class="linenos">292</span></a><span class="sd">        Particle swarm optimisation (PSO) fitting function can be significantly more computationally expensive than lmfit, with more parameters to optimise.</span>
</span><span id="MSPeakCalculation.voigt_pso-293"><a href="#MSPeakCalculation.voigt_pso-293"><span class="linenos">293</span></a>
</span><span id="MSPeakCalculation.voigt_pso-294"><a href="#MSPeakCalculation.voigt_pso-294"><span class="linenos">294</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.voigt_pso-295"><a href="#MSPeakCalculation.voigt_pso-295"><span class="linenos">295</span></a>        <span class="c1"># Lorentzian component</span>
</span><span id="MSPeakCalculation.voigt_pso-296"><a href="#MSPeakCalculation.voigt_pso-296"><span class="linenos">296</span></a>        <span class="n">L</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">width</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">w</span> <span class="o">-</span> <span class="n">loc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">width</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="MSPeakCalculation.voigt_pso-297"><a href="#MSPeakCalculation.voigt_pso-297"><span class="linenos">297</span></a>
</span><span id="MSPeakCalculation.voigt_pso-298"><a href="#MSPeakCalculation.voigt_pso-298"><span class="linenos">298</span></a>        <span class="c1"># Gaussian component</span>
</span><span id="MSPeakCalculation.voigt_pso-299"><a href="#MSPeakCalculation.voigt_pso-299"><span class="linenos">299</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MSPeakCalculation.voigt_pso-300"><a href="#MSPeakCalculation.voigt_pso-300"><span class="linenos">300</span></a>            <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="n">width</span><span class="p">)</span>
</span><span id="MSPeakCalculation.voigt_pso-301"><a href="#MSPeakCalculation.voigt_pso-301"><span class="linenos">301</span></a>            <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">pi</span><span class="p">)</span>
</span><span id="MSPeakCalculation.voigt_pso-302"><a href="#MSPeakCalculation.voigt_pso-302"><span class="linenos">302</span></a>            <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(((</span><span class="n">w</span> <span class="o">-</span> <span class="n">loc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="MSPeakCalculation.voigt_pso-303"><a href="#MSPeakCalculation.voigt_pso-303"><span class="linenos">303</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation.voigt_pso-304"><a href="#MSPeakCalculation.voigt_pso-304"><span class="linenos">304</span></a>
</span><span id="MSPeakCalculation.voigt_pso-305"><a href="#MSPeakCalculation.voigt_pso-305"><span class="linenos">305</span></a>        <span class="c1"># Voigt body</span>
</span><span id="MSPeakCalculation.voigt_pso-306"><a href="#MSPeakCalculation.voigt_pso-306"><span class="linenos">306</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="p">(</span><span class="n">yoff</span> <span class="o">+</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">L</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">G</span><span class="p">)</span>
</span><span id="MSPeakCalculation.voigt_pso-307"><a href="#MSPeakCalculation.voigt_pso-307"><span class="linenos">307</span></a>
</span><span id="MSPeakCalculation.voigt_pso-308"><a href="#MSPeakCalculation.voigt_pso-308"><span class="linenos">308</span></a>        <span class="k">return</span> <span class="n">V</span>
</span></pre></div>


            <div class="docstring"><p>Voigt function for particle swarm optimisation (PSO) fitting</p>

<p>From <a href="https://github.com/pnnl/nmrfit/blob/master/nmrfit/equations.py">https://github.com/pnnl/nmrfit/blob/master/nmrfit/equations.py</a>.
Calculates a Voigt function over w based on the relevant properties of the distribution.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>w</strong> (ndarray):
Array over which the Voigt function will be evaluated.</li>
<li><strong>r</strong> (float):
Ratio between the Guassian and Lorentzian functions.</li>
<li><strong>yoff</strong> (float):
Y-offset of the Voigt function.</li>
<li><strong>width</strong> (float):
The width of the Voigt function.</li>
<li><strong>loc</strong> (float):
Center of the Voigt function.</li>
<li><strong>a</strong> (float):
Area of the Voigt function.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>V</strong> (ndarray):
Array defining the Voigt function over w.</li>
</ul>

<h6 id="references">References</h6>

<ol>
<li><a href="https://github.com/pnnl/nmrfit">https://github.com/pnnl/nmrfit</a></li>
</ol>

<h6 id="notes">Notes</h6>

<p>Particle swarm optimisation (PSO) fitting function can be significantly more computationally expensive than lmfit, with more parameters to optimise.</p>
</div>


                            </div>
                            <div id="MSPeakCalculation.objective_pso" class="classattr">
                                        <input id="MSPeakCalculation.objective_pso-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">objective_pso</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">w</span>, </span><span class="param"><span class="n">u</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.objective_pso-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.objective_pso"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.objective_pso-310"><a href="#MSPeakCalculation.objective_pso-310"><span class="linenos">310</span></a>    <span class="k">def</span> <span class="nf">objective_pso</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
</span><span id="MSPeakCalculation.objective_pso-311"><a href="#MSPeakCalculation.objective_pso-311"><span class="linenos">311</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Objective function for particle swarm optimisation (PSO) fitting</span>
</span><span id="MSPeakCalculation.objective_pso-312"><a href="#MSPeakCalculation.objective_pso-312"><span class="linenos">312</span></a>
</span><span id="MSPeakCalculation.objective_pso-313"><a href="#MSPeakCalculation.objective_pso-313"><span class="linenos">313</span></a><span class="sd">        The objective function used to fit supplied data.  Evaluates sum of squared differences between the fit and the data.</span>
</span><span id="MSPeakCalculation.objective_pso-314"><a href="#MSPeakCalculation.objective_pso-314"><span class="linenos">314</span></a>
</span><span id="MSPeakCalculation.objective_pso-315"><a href="#MSPeakCalculation.objective_pso-315"><span class="linenos">315</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation.objective_pso-316"><a href="#MSPeakCalculation.objective_pso-316"><span class="linenos">316</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.objective_pso-317"><a href="#MSPeakCalculation.objective_pso-317"><span class="linenos">317</span></a><span class="sd">        x : list of floats</span>
</span><span id="MSPeakCalculation.objective_pso-318"><a href="#MSPeakCalculation.objective_pso-318"><span class="linenos">318</span></a><span class="sd">            Parameter vector.</span>
</span><span id="MSPeakCalculation.objective_pso-319"><a href="#MSPeakCalculation.objective_pso-319"><span class="linenos">319</span></a><span class="sd">        w : ndarray</span>
</span><span id="MSPeakCalculation.objective_pso-320"><a href="#MSPeakCalculation.objective_pso-320"><span class="linenos">320</span></a><span class="sd">            Array of frequency data.</span>
</span><span id="MSPeakCalculation.objective_pso-321"><a href="#MSPeakCalculation.objective_pso-321"><span class="linenos">321</span></a><span class="sd">        u : ndarray</span>
</span><span id="MSPeakCalculation.objective_pso-322"><a href="#MSPeakCalculation.objective_pso-322"><span class="linenos">322</span></a><span class="sd">            Array of data to be fit.</span>
</span><span id="MSPeakCalculation.objective_pso-323"><a href="#MSPeakCalculation.objective_pso-323"><span class="linenos">323</span></a>
</span><span id="MSPeakCalculation.objective_pso-324"><a href="#MSPeakCalculation.objective_pso-324"><span class="linenos">324</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation.objective_pso-325"><a href="#MSPeakCalculation.objective_pso-325"><span class="linenos">325</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation.objective_pso-326"><a href="#MSPeakCalculation.objective_pso-326"><span class="linenos">326</span></a><span class="sd">        rmse : float</span>
</span><span id="MSPeakCalculation.objective_pso-327"><a href="#MSPeakCalculation.objective_pso-327"><span class="linenos">327</span></a><span class="sd">            Root mean square error between the data and fit.</span>
</span><span id="MSPeakCalculation.objective_pso-328"><a href="#MSPeakCalculation.objective_pso-328"><span class="linenos">328</span></a>
</span><span id="MSPeakCalculation.objective_pso-329"><a href="#MSPeakCalculation.objective_pso-329"><span class="linenos">329</span></a><span class="sd">        References</span>
</span><span id="MSPeakCalculation.objective_pso-330"><a href="#MSPeakCalculation.objective_pso-330"><span class="linenos">330</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.objective_pso-331"><a href="#MSPeakCalculation.objective_pso-331"><span class="linenos">331</span></a><span class="sd">        1. https://github.com/pnnl/nmrfit</span>
</span><span id="MSPeakCalculation.objective_pso-332"><a href="#MSPeakCalculation.objective_pso-332"><span class="linenos">332</span></a>
</span><span id="MSPeakCalculation.objective_pso-333"><a href="#MSPeakCalculation.objective_pso-333"><span class="linenos">333</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.objective_pso-334"><a href="#MSPeakCalculation.objective_pso-334"><span class="linenos">334</span></a>        <span class="c1"># global parameters</span>
</span><span id="MSPeakCalculation.objective_pso-335"><a href="#MSPeakCalculation.objective_pso-335"><span class="linenos">335</span></a>        <span class="n">r</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="MSPeakCalculation.objective_pso-336"><a href="#MSPeakCalculation.objective_pso-336"><span class="linenos">336</span></a>        <span class="n">yoff</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MSPeakCalculation.objective_pso-337"><a href="#MSPeakCalculation.objective_pso-337"><span class="linenos">337</span></a>
</span><span id="MSPeakCalculation.objective_pso-338"><a href="#MSPeakCalculation.objective_pso-338"><span class="linenos">338</span></a>        <span class="c1"># calculate fit for V</span>
</span><span id="MSPeakCalculation.objective_pso-339"><a href="#MSPeakCalculation.objective_pso-339"><span class="linenos">339</span></a>        <span class="n">V_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voigt_pso</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">yoff</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</span><span id="MSPeakCalculation.objective_pso-340"><a href="#MSPeakCalculation.objective_pso-340"><span class="linenos">340</span></a>
</span><span id="MSPeakCalculation.objective_pso-341"><a href="#MSPeakCalculation.objective_pso-341"><span class="linenos">341</span></a>        <span class="c1"># real component RMSE</span>
</span><span id="MSPeakCalculation.objective_pso-342"><a href="#MSPeakCalculation.objective_pso-342"><span class="linenos">342</span></a>        <span class="n">rmse</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">square</span><span class="p">((</span><span class="n">u</span> <span class="o">-</span> <span class="n">V_fit</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
</span><span id="MSPeakCalculation.objective_pso-343"><a href="#MSPeakCalculation.objective_pso-343"><span class="linenos">343</span></a>
</span><span id="MSPeakCalculation.objective_pso-344"><a href="#MSPeakCalculation.objective_pso-344"><span class="linenos">344</span></a>        <span class="c1"># return the total RMSE</span>
</span><span id="MSPeakCalculation.objective_pso-345"><a href="#MSPeakCalculation.objective_pso-345"><span class="linenos">345</span></a>        <span class="k">return</span> <span class="n">rmse</span>
</span></pre></div>


            <div class="docstring"><p>Objective function for particle swarm optimisation (PSO) fitting</p>

<p>The objective function used to fit supplied data.  Evaluates sum of squared differences between the fit and the data.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>x</strong> (list of floats):
Parameter vector.</li>
<li><strong>w</strong> (ndarray):
Array of frequency data.</li>
<li><strong>u</strong> (ndarray):
Array of data to be fit.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>rmse</strong> (float):
Root mean square error between the data and fit.</li>
</ul>

<h6 id="references">References</h6>

<ol>
<li><a href="https://github.com/pnnl/nmrfit">https://github.com/pnnl/nmrfit</a></li>
</ol>
</div>


                            </div>
                            <div id="MSPeakCalculation.minimize_pso" class="classattr">
                                        <input id="MSPeakCalculation.minimize_pso-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">minimize_pso</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">lower</span>, </span><span class="param"><span class="n">upper</span>, </span><span class="param"><span class="n">w</span>, </span><span class="param"><span class="n">u</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.minimize_pso-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.minimize_pso"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.minimize_pso-347"><a href="#MSPeakCalculation.minimize_pso-347"><span class="linenos">347</span></a>    <span class="k">def</span> <span class="nf">minimize_pso</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">u</span><span class="p">):</span>
</span><span id="MSPeakCalculation.minimize_pso-348"><a href="#MSPeakCalculation.minimize_pso-348"><span class="linenos">348</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Minimization function for particle swarm optimisation (PSO) fitting</span>
</span><span id="MSPeakCalculation.minimize_pso-349"><a href="#MSPeakCalculation.minimize_pso-349"><span class="linenos">349</span></a>
</span><span id="MSPeakCalculation.minimize_pso-350"><a href="#MSPeakCalculation.minimize_pso-350"><span class="linenos">350</span></a><span class="sd">        Minimizes the objective function using the particle swarm optimization algorithm.</span>
</span><span id="MSPeakCalculation.minimize_pso-351"><a href="#MSPeakCalculation.minimize_pso-351"><span class="linenos">351</span></a><span class="sd">        Minimization function based on defined parameters</span>
</span><span id="MSPeakCalculation.minimize_pso-352"><a href="#MSPeakCalculation.minimize_pso-352"><span class="linenos">352</span></a>
</span><span id="MSPeakCalculation.minimize_pso-353"><a href="#MSPeakCalculation.minimize_pso-353"><span class="linenos">353</span></a>
</span><span id="MSPeakCalculation.minimize_pso-354"><a href="#MSPeakCalculation.minimize_pso-354"><span class="linenos">354</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation.minimize_pso-355"><a href="#MSPeakCalculation.minimize_pso-355"><span class="linenos">355</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.minimize_pso-356"><a href="#MSPeakCalculation.minimize_pso-356"><span class="linenos">356</span></a><span class="sd">        lower : list of floats</span>
</span><span id="MSPeakCalculation.minimize_pso-357"><a href="#MSPeakCalculation.minimize_pso-357"><span class="linenos">357</span></a><span class="sd">            Lower bounds for the parameters.</span>
</span><span id="MSPeakCalculation.minimize_pso-358"><a href="#MSPeakCalculation.minimize_pso-358"><span class="linenos">358</span></a><span class="sd">        upper : list of floats</span>
</span><span id="MSPeakCalculation.minimize_pso-359"><a href="#MSPeakCalculation.minimize_pso-359"><span class="linenos">359</span></a><span class="sd">            Upper bounds for the parameters.</span>
</span><span id="MSPeakCalculation.minimize_pso-360"><a href="#MSPeakCalculation.minimize_pso-360"><span class="linenos">360</span></a><span class="sd">        w : ndarray</span>
</span><span id="MSPeakCalculation.minimize_pso-361"><a href="#MSPeakCalculation.minimize_pso-361"><span class="linenos">361</span></a><span class="sd">            Array of frequency data.</span>
</span><span id="MSPeakCalculation.minimize_pso-362"><a href="#MSPeakCalculation.minimize_pso-362"><span class="linenos">362</span></a><span class="sd">        u : ndarray</span>
</span><span id="MSPeakCalculation.minimize_pso-363"><a href="#MSPeakCalculation.minimize_pso-363"><span class="linenos">363</span></a><span class="sd">            Array of data to be fit.</span>
</span><span id="MSPeakCalculation.minimize_pso-364"><a href="#MSPeakCalculation.minimize_pso-364"><span class="linenos">364</span></a>
</span><span id="MSPeakCalculation.minimize_pso-365"><a href="#MSPeakCalculation.minimize_pso-365"><span class="linenos">365</span></a><span class="sd">        Notes</span>
</span><span id="MSPeakCalculation.minimize_pso-366"><a href="#MSPeakCalculation.minimize_pso-366"><span class="linenos">366</span></a><span class="sd">        -----</span>
</span><span id="MSPeakCalculation.minimize_pso-367"><a href="#MSPeakCalculation.minimize_pso-367"><span class="linenos">367</span></a><span class="sd">        Particle swarm optimisation (PSO) fitting function can be significantly more computationally expensive than lmfit, with more parameters to optimise.</span>
</span><span id="MSPeakCalculation.minimize_pso-368"><a href="#MSPeakCalculation.minimize_pso-368"><span class="linenos">368</span></a><span class="sd">        Current parameters take ~2 seconds per peak.</span>
</span><span id="MSPeakCalculation.minimize_pso-369"><a href="#MSPeakCalculation.minimize_pso-369"><span class="linenos">369</span></a>
</span><span id="MSPeakCalculation.minimize_pso-370"><a href="#MSPeakCalculation.minimize_pso-370"><span class="linenos">370</span></a>
</span><span id="MSPeakCalculation.minimize_pso-371"><a href="#MSPeakCalculation.minimize_pso-371"><span class="linenos">371</span></a><span class="sd">        References</span>
</span><span id="MSPeakCalculation.minimize_pso-372"><a href="#MSPeakCalculation.minimize_pso-372"><span class="linenos">372</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.minimize_pso-373"><a href="#MSPeakCalculation.minimize_pso-373"><span class="linenos">373</span></a><span class="sd">        1. https://github.com/pnnl/nmrfit</span>
</span><span id="MSPeakCalculation.minimize_pso-374"><a href="#MSPeakCalculation.minimize_pso-374"><span class="linenos">374</span></a>
</span><span id="MSPeakCalculation.minimize_pso-375"><a href="#MSPeakCalculation.minimize_pso-375"><span class="linenos">375</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.minimize_pso-376"><a href="#MSPeakCalculation.minimize_pso-376"><span class="linenos">376</span></a>        <span class="c1"># TODO - allow support to pass swarmsize, maxiter, omega, phip, phig parameters.</span>
</span><span id="MSPeakCalculation.minimize_pso-377"><a href="#MSPeakCalculation.minimize_pso-377"><span class="linenos">377</span></a>        <span class="c1"># TODO - Refactor PSO fitting into its own class?</span>
</span><span id="MSPeakCalculation.minimize_pso-378"><a href="#MSPeakCalculation.minimize_pso-378"><span class="linenos">378</span></a>
</span><span id="MSPeakCalculation.minimize_pso-379"><a href="#MSPeakCalculation.minimize_pso-379"><span class="linenos">379</span></a>        <span class="n">xopt</span><span class="p">,</span> <span class="n">fopt</span> <span class="o">=</span> <span class="n">pyswarm</span><span class="o">.</span><span class="n">pso</span><span class="p">(</span>
</span><span id="MSPeakCalculation.minimize_pso-380"><a href="#MSPeakCalculation.minimize_pso-380"><span class="linenos">380</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">objective_pso</span><span class="p">,</span>
</span><span id="MSPeakCalculation.minimize_pso-381"><a href="#MSPeakCalculation.minimize_pso-381"><span class="linenos">381</span></a>            <span class="n">lower</span><span class="p">,</span>
</span><span id="MSPeakCalculation.minimize_pso-382"><a href="#MSPeakCalculation.minimize_pso-382"><span class="linenos">382</span></a>            <span class="n">upper</span><span class="p">,</span>
</span><span id="MSPeakCalculation.minimize_pso-383"><a href="#MSPeakCalculation.minimize_pso-383"><span class="linenos">383</span></a>            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">u</span><span class="p">),</span>
</span><span id="MSPeakCalculation.minimize_pso-384"><a href="#MSPeakCalculation.minimize_pso-384"><span class="linenos">384</span></a>            <span class="n">swarmsize</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span><span id="MSPeakCalculation.minimize_pso-385"><a href="#MSPeakCalculation.minimize_pso-385"><span class="linenos">385</span></a>            <span class="n">maxiter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
</span><span id="MSPeakCalculation.minimize_pso-386"><a href="#MSPeakCalculation.minimize_pso-386"><span class="linenos">386</span></a>            <span class="n">omega</span><span class="o">=-</span><span class="mf">0.2134</span><span class="p">,</span>
</span><span id="MSPeakCalculation.minimize_pso-387"><a href="#MSPeakCalculation.minimize_pso-387"><span class="linenos">387</span></a>            <span class="n">phip</span><span class="o">=-</span><span class="mf">0.3344</span><span class="p">,</span>
</span><span id="MSPeakCalculation.minimize_pso-388"><a href="#MSPeakCalculation.minimize_pso-388"><span class="linenos">388</span></a>            <span class="n">phig</span><span class="o">=</span><span class="mf">2.3259</span><span class="p">,</span>
</span><span id="MSPeakCalculation.minimize_pso-389"><a href="#MSPeakCalculation.minimize_pso-389"><span class="linenos">389</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation.minimize_pso-390"><a href="#MSPeakCalculation.minimize_pso-390"><span class="linenos">390</span></a>        <span class="k">return</span> <span class="n">xopt</span><span class="p">,</span> <span class="n">fopt</span>
</span></pre></div>


            <div class="docstring"><p>Minimization function for particle swarm optimisation (PSO) fitting</p>

<p>Minimizes the objective function using the particle swarm optimization algorithm.
Minimization function based on defined parameters</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>lower</strong> (list of floats):
Lower bounds for the parameters.</li>
<li><strong>upper</strong> (list of floats):
Upper bounds for the parameters.</li>
<li><strong>w</strong> (ndarray):
Array of frequency data.</li>
<li><strong>u</strong> (ndarray):
Array of data to be fit.</li>
</ul>

<h6 id="notes">Notes</h6>

<p>Particle swarm optimisation (PSO) fitting function can be significantly more computationally expensive than lmfit, with more parameters to optimise.
Current parameters take ~2 seconds per peak.</p>

<h6 id="references">References</h6>

<ol>
<li><a href="https://github.com/pnnl/nmrfit">https://github.com/pnnl/nmrfit</a></li>
</ol>
</div>


                            </div>
                            <div id="MSPeakCalculation.fit_peak_pso" class="classattr">
                                        <input id="MSPeakCalculation.fit_peak_pso-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fit_peak_pso</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mz_extend</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span>, </span><span class="param"><span class="n">upsample_multiplier</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.fit_peak_pso-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.fit_peak_pso"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.fit_peak_pso-392"><a href="#MSPeakCalculation.fit_peak_pso-392"><span class="linenos">392</span></a>    <span class="k">def</span> <span class="nf">fit_peak_pso</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mz_extend</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">upsample_multiplier</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
</span><span id="MSPeakCalculation.fit_peak_pso-393"><a href="#MSPeakCalculation.fit_peak_pso-393"><span class="linenos">393</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Lineshape analysis on a peak using particle swarm optimisation (PSO) fitting</span>
</span><span id="MSPeakCalculation.fit_peak_pso-394"><a href="#MSPeakCalculation.fit_peak_pso-394"><span class="linenos">394</span></a>
</span><span id="MSPeakCalculation.fit_peak_pso-395"><a href="#MSPeakCalculation.fit_peak_pso-395"><span class="linenos">395</span></a><span class="sd">        Function to fit a Voigt peakshape using particle swarm optimisation (PSO).</span>
</span><span id="MSPeakCalculation.fit_peak_pso-396"><a href="#MSPeakCalculation.fit_peak_pso-396"><span class="linenos">396</span></a><span class="sd">        Should return better results than lmfit, but much more computationally expensive</span>
</span><span id="MSPeakCalculation.fit_peak_pso-397"><a href="#MSPeakCalculation.fit_peak_pso-397"><span class="linenos">397</span></a>
</span><span id="MSPeakCalculation.fit_peak_pso-398"><a href="#MSPeakCalculation.fit_peak_pso-398"><span class="linenos">398</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation.fit_peak_pso-399"><a href="#MSPeakCalculation.fit_peak_pso-399"><span class="linenos">399</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.fit_peak_pso-400"><a href="#MSPeakCalculation.fit_peak_pso-400"><span class="linenos">400</span></a><span class="sd">        mz_extend : int, optional</span>
</span><span id="MSPeakCalculation.fit_peak_pso-401"><a href="#MSPeakCalculation.fit_peak_pso-401"><span class="linenos">401</span></a><span class="sd">            extra points left and right of peak definition to include in fitting. Defaults to 6.</span>
</span><span id="MSPeakCalculation.fit_peak_pso-402"><a href="#MSPeakCalculation.fit_peak_pso-402"><span class="linenos">402</span></a><span class="sd">        upsample_multiplier : int, optional</span>
</span><span id="MSPeakCalculation.fit_peak_pso-403"><a href="#MSPeakCalculation.fit_peak_pso-403"><span class="linenos">403</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function. Defaults to 5.</span>
</span><span id="MSPeakCalculation.fit_peak_pso-404"><a href="#MSPeakCalculation.fit_peak_pso-404"><span class="linenos">404</span></a>
</span><span id="MSPeakCalculation.fit_peak_pso-405"><a href="#MSPeakCalculation.fit_peak_pso-405"><span class="linenos">405</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation.fit_peak_pso-406"><a href="#MSPeakCalculation.fit_peak_pso-406"><span class="linenos">406</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation.fit_peak_pso-407"><a href="#MSPeakCalculation.fit_peak_pso-407"><span class="linenos">407</span></a><span class="sd">        xopt : array</span>
</span><span id="MSPeakCalculation.fit_peak_pso-408"><a href="#MSPeakCalculation.fit_peak_pso-408"><span class="linenos">408</span></a><span class="sd">            variables describing the voigt function.</span>
</span><span id="MSPeakCalculation.fit_peak_pso-409"><a href="#MSPeakCalculation.fit_peak_pso-409"><span class="linenos">409</span></a><span class="sd">            G/L ratio, width (fwhm), apex (x-axis), area.</span>
</span><span id="MSPeakCalculation.fit_peak_pso-410"><a href="#MSPeakCalculation.fit_peak_pso-410"><span class="linenos">410</span></a><span class="sd">            y-axis offset is fixed at 0</span>
</span><span id="MSPeakCalculation.fit_peak_pso-411"><a href="#MSPeakCalculation.fit_peak_pso-411"><span class="linenos">411</span></a><span class="sd">        fopt : float</span>
</span><span id="MSPeakCalculation.fit_peak_pso-412"><a href="#MSPeakCalculation.fit_peak_pso-412"><span class="linenos">412</span></a><span class="sd">            objective score (rmse)</span>
</span><span id="MSPeakCalculation.fit_peak_pso-413"><a href="#MSPeakCalculation.fit_peak_pso-413"><span class="linenos">413</span></a><span class="sd">        psfit : array</span>
</span><span id="MSPeakCalculation.fit_peak_pso-414"><a href="#MSPeakCalculation.fit_peak_pso-414"><span class="linenos">414</span></a><span class="sd">            recalculated y values based on function and optimised fit</span>
</span><span id="MSPeakCalculation.fit_peak_pso-415"><a href="#MSPeakCalculation.fit_peak_pso-415"><span class="linenos">415</span></a><span class="sd">        psfit_hdp : tuple of arrays</span>
</span><span id="MSPeakCalculation.fit_peak_pso-416"><a href="#MSPeakCalculation.fit_peak_pso-416"><span class="linenos">416</span></a><span class="sd">            0 - linspace x-axis upsampled grid</span>
</span><span id="MSPeakCalculation.fit_peak_pso-417"><a href="#MSPeakCalculation.fit_peak_pso-417"><span class="linenos">417</span></a><span class="sd">            1 - recalculated y values based on function and upsampled x-axis grid</span>
</span><span id="MSPeakCalculation.fit_peak_pso-418"><a href="#MSPeakCalculation.fit_peak_pso-418"><span class="linenos">418</span></a><span class="sd">            Does not change results, but aids in visualisation of the &#39;true&#39; voigt lineshape</span>
</span><span id="MSPeakCalculation.fit_peak_pso-419"><a href="#MSPeakCalculation.fit_peak_pso-419"><span class="linenos">419</span></a>
</span><span id="MSPeakCalculation.fit_peak_pso-420"><a href="#MSPeakCalculation.fit_peak_pso-420"><span class="linenos">420</span></a><span class="sd">        Notes</span>
</span><span id="MSPeakCalculation.fit_peak_pso-421"><a href="#MSPeakCalculation.fit_peak_pso-421"><span class="linenos">421</span></a><span class="sd">        -----</span>
</span><span id="MSPeakCalculation.fit_peak_pso-422"><a href="#MSPeakCalculation.fit_peak_pso-422"><span class="linenos">422</span></a><span class="sd">        Particle swarm optimisation (PSO) fitting function can be significantly more computationally expensive than lmfit, with more parameters to optimise.</span>
</span><span id="MSPeakCalculation.fit_peak_pso-423"><a href="#MSPeakCalculation.fit_peak_pso-423"><span class="linenos">423</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.fit_peak_pso-424"><a href="#MSPeakCalculation.fit_peak_pso-424"><span class="linenos">424</span></a>        <span class="c1"># TODO - Add ability to pass pso args (i.e. swarm size, maxiter, omega, phig, etc)</span>
</span><span id="MSPeakCalculation.fit_peak_pso-425"><a href="#MSPeakCalculation.fit_peak_pso-425"><span class="linenos">425</span></a>        <span class="c1"># TODO: fix xopt. Magnitude mode data through CoreMS/Bruker starts at 0 but is noise centered well above 0.</span>
</span><span id="MSPeakCalculation.fit_peak_pso-426"><a href="#MSPeakCalculation.fit_peak_pso-426"><span class="linenos">426</span></a>        <span class="c1"># Thermo data is noise reduced by also noise subtracted, so starts at 0</span>
</span><span id="MSPeakCalculation.fit_peak_pso-427"><a href="#MSPeakCalculation.fit_peak_pso-427"><span class="linenos">427</span></a>        <span class="c1"># Absorption mode/phased data will have positive and negative components and may not be baseline corrected</span>
</span><span id="MSPeakCalculation.fit_peak_pso-428"><a href="#MSPeakCalculation.fit_peak_pso-428"><span class="linenos">428</span></a>
</span><span id="MSPeakCalculation.fit_peak_pso-429"><a href="#MSPeakCalculation.fit_peak_pso-429"><span class="linenos">429</span></a>        <span class="n">start_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MSPeakCalculation.fit_peak_pso-430"><a href="#MSPeakCalculation.fit_peak_pso-430"><span class="linenos">430</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">-</span> <span class="n">mz_extend</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="MSPeakCalculation.fit_peak_pso-431"><a href="#MSPeakCalculation.fit_peak_pso-431"><span class="linenos">431</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation.fit_peak_pso-432"><a href="#MSPeakCalculation.fit_peak_pso-432"><span class="linenos">432</span></a>        <span class="n">final_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MSPeakCalculation.fit_peak_pso-433"><a href="#MSPeakCalculation.fit_peak_pso-433"><span class="linenos">433</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">+</span> <span class="n">mz_extend</span>
</span><span id="MSPeakCalculation.fit_peak_pso-434"><a href="#MSPeakCalculation.fit_peak_pso-434"><span class="linenos">434</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">)</span>
</span><span id="MSPeakCalculation.fit_peak_pso-435"><a href="#MSPeakCalculation.fit_peak_pso-435"><span class="linenos">435</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span>
</span><span id="MSPeakCalculation.fit_peak_pso-436"><a href="#MSPeakCalculation.fit_peak_pso-436"><span class="linenos">436</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation.fit_peak_pso-437"><a href="#MSPeakCalculation.fit_peak_pso-437"><span class="linenos">437</span></a>
</span><span id="MSPeakCalculation.fit_peak_pso-438"><a href="#MSPeakCalculation.fit_peak_pso-438"><span class="linenos">438</span></a>        <span class="c1"># check if MSPeak contains the resolving power info</span>
</span><span id="MSPeakCalculation.fit_peak_pso-439"><a href="#MSPeakCalculation.fit_peak_pso-439"><span class="linenos">439</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="MSPeakCalculation.fit_peak_pso-440"><a href="#MSPeakCalculation.fit_peak_pso-440"><span class="linenos">440</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="MSPeakCalculation.fit_peak_pso-441"><a href="#MSPeakCalculation.fit_peak_pso-441"><span class="linenos">441</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">)</span>
</span><span id="MSPeakCalculation.fit_peak_pso-442"><a href="#MSPeakCalculation.fit_peak_pso-442"><span class="linenos">442</span></a>
</span><span id="MSPeakCalculation.fit_peak_pso-443"><a href="#MSPeakCalculation.fit_peak_pso-443"><span class="linenos">443</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">final_index</span><span class="p">]</span>
</span><span id="MSPeakCalculation.fit_peak_pso-444"><a href="#MSPeakCalculation.fit_peak_pso-444"><span class="linenos">444</span></a>            <span class="n">abundance_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">abundance_profile</span><span class="p">[</span>
</span><span id="MSPeakCalculation.fit_peak_pso-445"><a href="#MSPeakCalculation.fit_peak_pso-445"><span class="linenos">445</span></a>                <span class="n">start_index</span><span class="p">:</span><span class="n">final_index</span>
</span><span id="MSPeakCalculation.fit_peak_pso-446"><a href="#MSPeakCalculation.fit_peak_pso-446"><span class="linenos">446</span></a>            <span class="p">]</span>
</span><span id="MSPeakCalculation.fit_peak_pso-447"><a href="#MSPeakCalculation.fit_peak_pso-447"><span class="linenos">447</span></a>            <span class="n">lower</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">-</span> <span class="mf">0.0005</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="MSPeakCalculation.fit_peak_pso-448"><a href="#MSPeakCalculation.fit_peak_pso-448"><span class="linenos">448</span></a>            <span class="n">upper</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="MSPeakCalculation.fit_peak_pso-449"><a href="#MSPeakCalculation.fit_peak_pso-449"><span class="linenos">449</span></a>                <span class="mi">1</span><span class="p">,</span>
</span><span id="MSPeakCalculation.fit_peak_pso-450"><a href="#MSPeakCalculation.fit_peak_pso-450"><span class="linenos">450</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">,</span>
</span><span id="MSPeakCalculation.fit_peak_pso-451"><a href="#MSPeakCalculation.fit_peak_pso-451"><span class="linenos">451</span></a>                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">+</span> <span class="mf">0.0005</span><span class="p">),</span>
</span><span id="MSPeakCalculation.fit_peak_pso-452"><a href="#MSPeakCalculation.fit_peak_pso-452"><span class="linenos">452</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal_to_noise</span><span class="p">,</span>
</span><span id="MSPeakCalculation.fit_peak_pso-453"><a href="#MSPeakCalculation.fit_peak_pso-453"><span class="linenos">453</span></a>            <span class="p">]</span>
</span><span id="MSPeakCalculation.fit_peak_pso-454"><a href="#MSPeakCalculation.fit_peak_pso-454"><span class="linenos">454</span></a>            <span class="n">xopt</span><span class="p">,</span> <span class="n">fopt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimize_pso</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">abundance_domain</span><span class="p">)</span>
</span><span id="MSPeakCalculation.fit_peak_pso-455"><a href="#MSPeakCalculation.fit_peak_pso-455"><span class="linenos">455</span></a>
</span><span id="MSPeakCalculation.fit_peak_pso-456"><a href="#MSPeakCalculation.fit_peak_pso-456"><span class="linenos">456</span></a>            <span class="n">psfit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voigt_pso</span><span class="p">(</span><span class="n">mz_domain</span><span class="p">,</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="MSPeakCalculation.fit_peak_pso-457"><a href="#MSPeakCalculation.fit_peak_pso-457"><span class="linenos">457</span></a>            <span class="n">psfit_hdp_x</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span>
</span><span id="MSPeakCalculation.fit_peak_pso-458"><a href="#MSPeakCalculation.fit_peak_pso-458"><span class="linenos">458</span></a>                <span class="nb">min</span><span class="p">(</span><span class="n">mz_domain</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">mz_domain</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">mz_domain</span><span class="p">)</span> <span class="o">*</span> <span class="n">upsample_multiplier</span>
</span><span id="MSPeakCalculation.fit_peak_pso-459"><a href="#MSPeakCalculation.fit_peak_pso-459"><span class="linenos">459</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation.fit_peak_pso-460"><a href="#MSPeakCalculation.fit_peak_pso-460"><span class="linenos">460</span></a>            <span class="n">psfit_hdp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voigt_pso</span><span class="p">(</span>
</span><span id="MSPeakCalculation.fit_peak_pso-461"><a href="#MSPeakCalculation.fit_peak_pso-461"><span class="linenos">461</span></a>                <span class="n">psfit_hdp_x</span><span class="p">,</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">xopt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="MSPeakCalculation.fit_peak_pso-462"><a href="#MSPeakCalculation.fit_peak_pso-462"><span class="linenos">462</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation.fit_peak_pso-463"><a href="#MSPeakCalculation.fit_peak_pso-463"><span class="linenos">463</span></a>            <span class="k">return</span> <span class="n">xopt</span><span class="p">,</span> <span class="n">fopt</span><span class="p">,</span> <span class="n">psfit</span><span class="p">,</span> <span class="p">(</span><span class="n">psfit_hdp_x</span><span class="p">,</span> <span class="n">psfit_hdp</span><span class="p">)</span>
</span><span id="MSPeakCalculation.fit_peak_pso-464"><a href="#MSPeakCalculation.fit_peak_pso-464"><span class="linenos">464</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.fit_peak_pso-465"><a href="#MSPeakCalculation.fit_peak_pso-465"><span class="linenos">465</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="MSPeakCalculation.fit_peak_pso-466"><a href="#MSPeakCalculation.fit_peak_pso-466"><span class="linenos">466</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="MSPeakCalculation.fit_peak_pso-467"><a href="#MSPeakCalculation.fit_peak_pso-467"><span class="linenos">467</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Lineshape analysis on a peak using particle swarm optimisation (PSO) fitting</p>

<p>Function to fit a Voigt peakshape using particle swarm optimisation (PSO).
Should return better results than lmfit, but much more computationally expensive</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>mz_extend</strong> (int, optional):
extra points left and right of peak definition to include in fitting. Defaults to 6.</li>
<li><strong>upsample_multiplier</strong> (int, optional):
factor to increase x-axis points by for simulation of fitted lineshape function. Defaults to 5.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>xopt</strong> (array):
variables describing the voigt function.
G/L ratio, width (fwhm), apex (x-axis), area.
y-axis offset is fixed at 0</li>
<li><strong>fopt</strong> (float):
objective score (rmse)</li>
<li><strong>psfit</strong> (array):
recalculated y values based on function and optimised fit</li>
<li><strong>psfit_hdp</strong> (tuple of arrays):
0 - linspace x-axis upsampled grid
1 - recalculated y values based on function and upsampled x-axis grid
Does not change results, but aids in visualisation of the 'true' voigt lineshape</li>
</ul>

<h6 id="notes">Notes</h6>

<p>Particle swarm optimisation (PSO) fitting function can be significantly more computationally expensive than lmfit, with more parameters to optimise.</p>
</div>


                            </div>
                            <div id="MSPeakCalculation.voigt" class="classattr">
                                        <input id="MSPeakCalculation.voigt-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">voigt</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">oversample_multiplier</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">mz_overlay</span><span class="o">=</span><span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.voigt-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.voigt"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.voigt-469"><a href="#MSPeakCalculation.voigt-469"><span class="linenos">469</span></a>    <span class="k">def</span> <span class="nf">voigt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oversample_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="MSPeakCalculation.voigt-470"><a href="#MSPeakCalculation.voigt-470"><span class="linenos">470</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;[Legacy] Voigt lineshape analysis function</span>
</span><span id="MSPeakCalculation.voigt-471"><a href="#MSPeakCalculation.voigt-471"><span class="linenos">471</span></a><span class="sd">        Legacy function for voigt lineshape analysis</span>
</span><span id="MSPeakCalculation.voigt-472"><a href="#MSPeakCalculation.voigt-472"><span class="linenos">472</span></a>
</span><span id="MSPeakCalculation.voigt-473"><a href="#MSPeakCalculation.voigt-473"><span class="linenos">473</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation.voigt-474"><a href="#MSPeakCalculation.voigt-474"><span class="linenos">474</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.voigt-475"><a href="#MSPeakCalculation.voigt-475"><span class="linenos">475</span></a><span class="sd">        oversample_multiplier : int</span>
</span><span id="MSPeakCalculation.voigt-476"><a href="#MSPeakCalculation.voigt-476"><span class="linenos">476</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function</span>
</span><span id="MSPeakCalculation.voigt-477"><a href="#MSPeakCalculation.voigt-477"><span class="linenos">477</span></a><span class="sd">        delta_rp : float</span>
</span><span id="MSPeakCalculation.voigt-478"><a href="#MSPeakCalculation.voigt-478"><span class="linenos">478</span></a><span class="sd">            delta resolving power to add to resolving power</span>
</span><span id="MSPeakCalculation.voigt-479"><a href="#MSPeakCalculation.voigt-479"><span class="linenos">479</span></a><span class="sd">        mz_overlay : int</span>
</span><span id="MSPeakCalculation.voigt-480"><a href="#MSPeakCalculation.voigt-480"><span class="linenos">480</span></a><span class="sd">            extra points left and right of peak definition to include in fitting</span>
</span><span id="MSPeakCalculation.voigt-481"><a href="#MSPeakCalculation.voigt-481"><span class="linenos">481</span></a>
</span><span id="MSPeakCalculation.voigt-482"><a href="#MSPeakCalculation.voigt-482"><span class="linenos">482</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation.voigt-483"><a href="#MSPeakCalculation.voigt-483"><span class="linenos">483</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation.voigt-484"><a href="#MSPeakCalculation.voigt-484"><span class="linenos">484</span></a><span class="sd">        mz_domain : ndarray</span>
</span><span id="MSPeakCalculation.voigt-485"><a href="#MSPeakCalculation.voigt-485"><span class="linenos">485</span></a><span class="sd">            x-axis domain for fit</span>
</span><span id="MSPeakCalculation.voigt-486"><a href="#MSPeakCalculation.voigt-486"><span class="linenos">486</span></a><span class="sd">        calc_abundance : ndarray</span>
</span><span id="MSPeakCalculation.voigt-487"><a href="#MSPeakCalculation.voigt-487"><span class="linenos">487</span></a><span class="sd">            calculated abundance profile based on voigt function</span>
</span><span id="MSPeakCalculation.voigt-488"><a href="#MSPeakCalculation.voigt-488"><span class="linenos">488</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.voigt-489"><a href="#MSPeakCalculation.voigt-489"><span class="linenos">489</span></a>
</span><span id="MSPeakCalculation.voigt-490"><a href="#MSPeakCalculation.voigt-490"><span class="linenos">490</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="MSPeakCalculation.voigt-491"><a href="#MSPeakCalculation.voigt-491"><span class="linenos">491</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="MSPeakCalculation.voigt-492"><a href="#MSPeakCalculation.voigt-492"><span class="linenos">492</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="MSPeakCalculation.voigt-493"><a href="#MSPeakCalculation.voigt-493"><span class="linenos">493</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span> <span class="o">+</span> <span class="n">delta_rp</span>
</span><span id="MSPeakCalculation.voigt-494"><a href="#MSPeakCalculation.voigt-494"><span class="linenos">494</span></a>            <span class="p">)</span>  <span class="c1"># self.resolving_power)</span>
</span><span id="MSPeakCalculation.voigt-495"><a href="#MSPeakCalculation.voigt-495"><span class="linenos">495</span></a>
</span><span id="MSPeakCalculation.voigt-496"><a href="#MSPeakCalculation.voigt-496"><span class="linenos">496</span></a>            <span class="c1"># stardart deviation</span>
</span><span id="MSPeakCalculation.voigt-497"><a href="#MSPeakCalculation.voigt-497"><span class="linenos">497</span></a>            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="mf">3.6013</span>
</span><span id="MSPeakCalculation.voigt-498"><a href="#MSPeakCalculation.voigt-498"><span class="linenos">498</span></a>
</span><span id="MSPeakCalculation.voigt-499"><a href="#MSPeakCalculation.voigt-499"><span class="linenos">499</span></a>            <span class="c1"># half width baseline distance</span>
</span><span id="MSPeakCalculation.voigt-500"><a href="#MSPeakCalculation.voigt-500"><span class="linenos">500</span></a>
</span><span id="MSPeakCalculation.voigt-501"><a href="#MSPeakCalculation.voigt-501"><span class="linenos">501</span></a>            <span class="c1"># mz_domain = linspace(self.mz_exp - hw_base_distance,</span>
</span><span id="MSPeakCalculation.voigt-502"><a href="#MSPeakCalculation.voigt-502"><span class="linenos">502</span></a>            <span class="c1">#                     self.mz_exp + hw_base_distance, datapoint)</span>
</span><span id="MSPeakCalculation.voigt-503"><a href="#MSPeakCalculation.voigt-503"><span class="linenos">503</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mz_domain</span><span class="p">(</span><span class="n">oversample_multiplier</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="p">)</span>
</span><span id="MSPeakCalculation.voigt-504"><a href="#MSPeakCalculation.voigt-504"><span class="linenos">504</span></a>
</span><span id="MSPeakCalculation.voigt-505"><a href="#MSPeakCalculation.voigt-505"><span class="linenos">505</span></a>            <span class="c1"># gaussian_pdf = lambda x0, x, s: (1/ math.sqrt(2*math.pi*math.pow(s,2))) * math.exp(-1 * math.pow(x-x0,2) / 2*math.pow(s,2) )</span>
</span><span id="MSPeakCalculation.voigt-506"><a href="#MSPeakCalculation.voigt-506"><span class="linenos">506</span></a>
</span><span id="MSPeakCalculation.voigt-507"><a href="#MSPeakCalculation.voigt-507"><span class="linenos">507</span></a>            <span class="c1"># TODO derive amplitude</span>
</span><span id="MSPeakCalculation.voigt-508"><a href="#MSPeakCalculation.voigt-508"><span class="linenos">508</span></a>            <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="MSPeakCalculation.voigt-509"><a href="#MSPeakCalculation.voigt-509"><span class="linenos">509</span></a>
</span><span id="MSPeakCalculation.voigt-510"><a href="#MSPeakCalculation.voigt-510"><span class="linenos">510</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">VoigtModel</span><span class="p">()</span>
</span><span id="MSPeakCalculation.voigt-511"><a href="#MSPeakCalculation.voigt-511"><span class="linenos">511</span></a>
</span><span id="MSPeakCalculation.voigt-512"><a href="#MSPeakCalculation.voigt-512"><span class="linenos">512</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="MSPeakCalculation.voigt-513"><a href="#MSPeakCalculation.voigt-513"><span class="linenos">513</span></a>                <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="MSPeakCalculation.voigt-514"><a href="#MSPeakCalculation.voigt-514"><span class="linenos">514</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation.voigt-515"><a href="#MSPeakCalculation.voigt-515"><span class="linenos">515</span></a>
</span><span id="MSPeakCalculation.voigt-516"><a href="#MSPeakCalculation.voigt-516"><span class="linenos">516</span></a>            <span class="n">calc_abundance</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mz_domain</span><span class="p">)</span>
</span><span id="MSPeakCalculation.voigt-517"><a href="#MSPeakCalculation.voigt-517"><span class="linenos">517</span></a>
</span><span id="MSPeakCalculation.voigt-518"><a href="#MSPeakCalculation.voigt-518"><span class="linenos">518</span></a>            <span class="k">return</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">calc_abundance</span>
</span><span id="MSPeakCalculation.voigt-519"><a href="#MSPeakCalculation.voigt-519"><span class="linenos">519</span></a>
</span><span id="MSPeakCalculation.voigt-520"><a href="#MSPeakCalculation.voigt-520"><span class="linenos">520</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.voigt-521"><a href="#MSPeakCalculation.voigt-521"><span class="linenos">521</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="MSPeakCalculation.voigt-522"><a href="#MSPeakCalculation.voigt-522"><span class="linenos">522</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="MSPeakCalculation.voigt-523"><a href="#MSPeakCalculation.voigt-523"><span class="linenos">523</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>[Legacy] Voigt lineshape analysis function
Legacy function for voigt lineshape analysis</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>oversample_multiplier</strong> (int):
factor to increase x-axis points by for simulation of fitted lineshape function</li>
<li><strong>delta_rp</strong> (float):
delta resolving power to add to resolving power</li>
<li><strong>mz_overlay</strong> (int):
extra points left and right of peak definition to include in fitting</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>mz_domain</strong> (ndarray):
x-axis domain for fit</li>
<li><strong>calc_abundance</strong> (ndarray):
calculated abundance profile based on voigt function</li>
</ul>
</div>


                            </div>
                            <div id="MSPeakCalculation.pseudovoigt" class="classattr">
                                        <input id="MSPeakCalculation.pseudovoigt-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pseudovoigt</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">oversample_multiplier</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span>,</span><span class="param">	<span class="n">mz_overlay</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">fraction</span><span class="o">=</span><span class="mf">0.5</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.pseudovoigt-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.pseudovoigt"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.pseudovoigt-525"><a href="#MSPeakCalculation.pseudovoigt-525"><span class="linenos">525</span></a>    <span class="k">def</span> <span class="nf">pseudovoigt</span><span class="p">(</span>
</span><span id="MSPeakCalculation.pseudovoigt-526"><a href="#MSPeakCalculation.pseudovoigt-526"><span class="linenos">526</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">oversample_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.5</span>
</span><span id="MSPeakCalculation.pseudovoigt-527"><a href="#MSPeakCalculation.pseudovoigt-527"><span class="linenos">527</span></a>    <span class="p">):</span>
</span><span id="MSPeakCalculation.pseudovoigt-528"><a href="#MSPeakCalculation.pseudovoigt-528"><span class="linenos">528</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;[Legacy] pseudovoigt lineshape function</span>
</span><span id="MSPeakCalculation.pseudovoigt-529"><a href="#MSPeakCalculation.pseudovoigt-529"><span class="linenos">529</span></a>
</span><span id="MSPeakCalculation.pseudovoigt-530"><a href="#MSPeakCalculation.pseudovoigt-530"><span class="linenos">530</span></a><span class="sd">        Legacy function for pseudovoigt lineshape analysis.</span>
</span><span id="MSPeakCalculation.pseudovoigt-531"><a href="#MSPeakCalculation.pseudovoigt-531"><span class="linenos">531</span></a><span class="sd">        Note - Code may not be functional currently.</span>
</span><span id="MSPeakCalculation.pseudovoigt-532"><a href="#MSPeakCalculation.pseudovoigt-532"><span class="linenos">532</span></a>
</span><span id="MSPeakCalculation.pseudovoigt-533"><a href="#MSPeakCalculation.pseudovoigt-533"><span class="linenos">533</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation.pseudovoigt-534"><a href="#MSPeakCalculation.pseudovoigt-534"><span class="linenos">534</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.pseudovoigt-535"><a href="#MSPeakCalculation.pseudovoigt-535"><span class="linenos">535</span></a><span class="sd">        oversample_multiplier : int, optional</span>
</span><span id="MSPeakCalculation.pseudovoigt-536"><a href="#MSPeakCalculation.pseudovoigt-536"><span class="linenos">536</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function. Defaults to 1.</span>
</span><span id="MSPeakCalculation.pseudovoigt-537"><a href="#MSPeakCalculation.pseudovoigt-537"><span class="linenos">537</span></a><span class="sd">        delta_rp : float, optional</span>
</span><span id="MSPeakCalculation.pseudovoigt-538"><a href="#MSPeakCalculation.pseudovoigt-538"><span class="linenos">538</span></a><span class="sd">            delta resolving power to add to resolving power. Defaults to 0.</span>
</span><span id="MSPeakCalculation.pseudovoigt-539"><a href="#MSPeakCalculation.pseudovoigt-539"><span class="linenos">539</span></a><span class="sd">        mz_overlay : int, optional</span>
</span><span id="MSPeakCalculation.pseudovoigt-540"><a href="#MSPeakCalculation.pseudovoigt-540"><span class="linenos">540</span></a><span class="sd">            extra points left and right of peak definition to include in fitting. Defaults to 1.</span>
</span><span id="MSPeakCalculation.pseudovoigt-541"><a href="#MSPeakCalculation.pseudovoigt-541"><span class="linenos">541</span></a><span class="sd">        fraction : float, optional</span>
</span><span id="MSPeakCalculation.pseudovoigt-542"><a href="#MSPeakCalculation.pseudovoigt-542"><span class="linenos">542</span></a><span class="sd">            fraction of gaussian component in pseudovoigt function. Defaults to 0.5.</span>
</span><span id="MSPeakCalculation.pseudovoigt-543"><a href="#MSPeakCalculation.pseudovoigt-543"><span class="linenos">543</span></a>
</span><span id="MSPeakCalculation.pseudovoigt-544"><a href="#MSPeakCalculation.pseudovoigt-544"><span class="linenos">544</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.pseudovoigt-545"><a href="#MSPeakCalculation.pseudovoigt-545"><span class="linenos">545</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="MSPeakCalculation.pseudovoigt-546"><a href="#MSPeakCalculation.pseudovoigt-546"><span class="linenos">546</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="MSPeakCalculation.pseudovoigt-547"><a href="#MSPeakCalculation.pseudovoigt-547"><span class="linenos">547</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="MSPeakCalculation.pseudovoigt-548"><a href="#MSPeakCalculation.pseudovoigt-548"><span class="linenos">548</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span> <span class="o">+</span> <span class="n">delta_rp</span>
</span><span id="MSPeakCalculation.pseudovoigt-549"><a href="#MSPeakCalculation.pseudovoigt-549"><span class="linenos">549</span></a>            <span class="p">)</span>  <span class="c1"># self.resolving_power)</span>
</span><span id="MSPeakCalculation.pseudovoigt-550"><a href="#MSPeakCalculation.pseudovoigt-550"><span class="linenos">550</span></a>
</span><span id="MSPeakCalculation.pseudovoigt-551"><a href="#MSPeakCalculation.pseudovoigt-551"><span class="linenos">551</span></a>            <span class="c1"># stardart deviation</span>
</span><span id="MSPeakCalculation.pseudovoigt-552"><a href="#MSPeakCalculation.pseudovoigt-552"><span class="linenos">552</span></a>            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="MSPeakCalculation.pseudovoigt-553"><a href="#MSPeakCalculation.pseudovoigt-553"><span class="linenos">553</span></a>
</span><span id="MSPeakCalculation.pseudovoigt-554"><a href="#MSPeakCalculation.pseudovoigt-554"><span class="linenos">554</span></a>            <span class="c1"># half width baseline distance</span>
</span><span id="MSPeakCalculation.pseudovoigt-555"><a href="#MSPeakCalculation.pseudovoigt-555"><span class="linenos">555</span></a>
</span><span id="MSPeakCalculation.pseudovoigt-556"><a href="#MSPeakCalculation.pseudovoigt-556"><span class="linenos">556</span></a>            <span class="c1"># mz_domain = linspace(self.mz_exp - hw_base_distance,</span>
</span><span id="MSPeakCalculation.pseudovoigt-557"><a href="#MSPeakCalculation.pseudovoigt-557"><span class="linenos">557</span></a>            <span class="c1">#                     self.mz_exp + hw_base_distance, datapoint)</span>
</span><span id="MSPeakCalculation.pseudovoigt-558"><a href="#MSPeakCalculation.pseudovoigt-558"><span class="linenos">558</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mz_domain</span><span class="p">(</span><span class="n">oversample_multiplier</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="p">)</span>
</span><span id="MSPeakCalculation.pseudovoigt-559"><a href="#MSPeakCalculation.pseudovoigt-559"><span class="linenos">559</span></a>
</span><span id="MSPeakCalculation.pseudovoigt-560"><a href="#MSPeakCalculation.pseudovoigt-560"><span class="linenos">560</span></a>            <span class="c1"># gaussian_pdf = lambda x0, x, s: (1/ math.sqrt(2*math.pi*math.pow(s,2))) * math.exp(-1 * math.pow(x-x0,2) / 2*math.pow(s,2) )</span>
</span><span id="MSPeakCalculation.pseudovoigt-561"><a href="#MSPeakCalculation.pseudovoigt-561"><span class="linenos">561</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PseudoVoigtModel</span><span class="p">()</span>
</span><span id="MSPeakCalculation.pseudovoigt-562"><a href="#MSPeakCalculation.pseudovoigt-562"><span class="linenos">562</span></a>
</span><span id="MSPeakCalculation.pseudovoigt-563"><a href="#MSPeakCalculation.pseudovoigt-563"><span class="linenos">563</span></a>            <span class="c1"># TODO derive amplitude</span>
</span><span id="MSPeakCalculation.pseudovoigt-564"><a href="#MSPeakCalculation.pseudovoigt-564"><span class="linenos">564</span></a>            <span class="n">gamma</span> <span class="o">=</span> <span class="n">sigma</span>
</span><span id="MSPeakCalculation.pseudovoigt-565"><a href="#MSPeakCalculation.pseudovoigt-565"><span class="linenos">565</span></a>
</span><span id="MSPeakCalculation.pseudovoigt-566"><a href="#MSPeakCalculation.pseudovoigt-566"><span class="linenos">566</span></a>            <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="MSPeakCalculation.pseudovoigt-567"><a href="#MSPeakCalculation.pseudovoigt-567"><span class="linenos">567</span></a>            <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pi</span> <span class="o">/</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="MSPeakCalculation.pseudovoigt-568"><a href="#MSPeakCalculation.pseudovoigt-568"><span class="linenos">568</span></a>                <span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">gamma</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pi</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">gamma</span><span class="p">)</span>
</span><span id="MSPeakCalculation.pseudovoigt-569"><a href="#MSPeakCalculation.pseudovoigt-569"><span class="linenos">569</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation.pseudovoigt-570"><a href="#MSPeakCalculation.pseudovoigt-570"><span class="linenos">570</span></a>
</span><span id="MSPeakCalculation.pseudovoigt-571"><a href="#MSPeakCalculation.pseudovoigt-571"><span class="linenos">571</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
</span><span id="MSPeakCalculation.pseudovoigt-572"><a href="#MSPeakCalculation.pseudovoigt-572"><span class="linenos">572</span></a>
</span><span id="MSPeakCalculation.pseudovoigt-573"><a href="#MSPeakCalculation.pseudovoigt-573"><span class="linenos">573</span></a>            <span class="n">calc_abundance</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mz_domain</span><span class="p">)</span>
</span><span id="MSPeakCalculation.pseudovoigt-574"><a href="#MSPeakCalculation.pseudovoigt-574"><span class="linenos">574</span></a>
</span><span id="MSPeakCalculation.pseudovoigt-575"><a href="#MSPeakCalculation.pseudovoigt-575"><span class="linenos">575</span></a>            <span class="k">return</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">calc_abundance</span>
</span><span id="MSPeakCalculation.pseudovoigt-576"><a href="#MSPeakCalculation.pseudovoigt-576"><span class="linenos">576</span></a>
</span><span id="MSPeakCalculation.pseudovoigt-577"><a href="#MSPeakCalculation.pseudovoigt-577"><span class="linenos">577</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.pseudovoigt-578"><a href="#MSPeakCalculation.pseudovoigt-578"><span class="linenos">578</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="MSPeakCalculation.pseudovoigt-579"><a href="#MSPeakCalculation.pseudovoigt-579"><span class="linenos">579</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="MSPeakCalculation.pseudovoigt-580"><a href="#MSPeakCalculation.pseudovoigt-580"><span class="linenos">580</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>[Legacy] pseudovoigt lineshape function</p>

<p>Legacy function for pseudovoigt lineshape analysis.
Note - Code may not be functional currently.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>oversample_multiplier</strong> (int, optional):
factor to increase x-axis points by for simulation of fitted lineshape function. Defaults to 1.</li>
<li><strong>delta_rp</strong> (float, optional):
delta resolving power to add to resolving power. Defaults to 0.</li>
<li><strong>mz_overlay</strong> (int, optional):
extra points left and right of peak definition to include in fitting. Defaults to 1.</li>
<li><strong>fraction</strong> (float, optional):
fraction of gaussian component in pseudovoigt function. Defaults to 0.5.</li>
</ul>
</div>


                            </div>
                            <div id="MSPeakCalculation.lorentz" class="classattr">
                                        <input id="MSPeakCalculation.lorentz-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">lorentz</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">oversample_multiplier</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">mz_overlay</span><span class="o">=</span><span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.lorentz-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.lorentz"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.lorentz-582"><a href="#MSPeakCalculation.lorentz-582"><span class="linenos">582</span></a>    <span class="k">def</span> <span class="nf">lorentz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oversample_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="MSPeakCalculation.lorentz-583"><a href="#MSPeakCalculation.lorentz-583"><span class="linenos">583</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;[Legacy] Lorentz lineshape analysis function</span>
</span><span id="MSPeakCalculation.lorentz-584"><a href="#MSPeakCalculation.lorentz-584"><span class="linenos">584</span></a>
</span><span id="MSPeakCalculation.lorentz-585"><a href="#MSPeakCalculation.lorentz-585"><span class="linenos">585</span></a><span class="sd">        Legacy function for lorentz lineshape analysis</span>
</span><span id="MSPeakCalculation.lorentz-586"><a href="#MSPeakCalculation.lorentz-586"><span class="linenos">586</span></a>
</span><span id="MSPeakCalculation.lorentz-587"><a href="#MSPeakCalculation.lorentz-587"><span class="linenos">587</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation.lorentz-588"><a href="#MSPeakCalculation.lorentz-588"><span class="linenos">588</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.lorentz-589"><a href="#MSPeakCalculation.lorentz-589"><span class="linenos">589</span></a><span class="sd">        oversample_multiplier : int</span>
</span><span id="MSPeakCalculation.lorentz-590"><a href="#MSPeakCalculation.lorentz-590"><span class="linenos">590</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function</span>
</span><span id="MSPeakCalculation.lorentz-591"><a href="#MSPeakCalculation.lorentz-591"><span class="linenos">591</span></a><span class="sd">        delta_rp : float</span>
</span><span id="MSPeakCalculation.lorentz-592"><a href="#MSPeakCalculation.lorentz-592"><span class="linenos">592</span></a><span class="sd">            delta resolving power to add to resolving power</span>
</span><span id="MSPeakCalculation.lorentz-593"><a href="#MSPeakCalculation.lorentz-593"><span class="linenos">593</span></a><span class="sd">        mz_overlay : int</span>
</span><span id="MSPeakCalculation.lorentz-594"><a href="#MSPeakCalculation.lorentz-594"><span class="linenos">594</span></a><span class="sd">            extra points left and right of peak definition to include in fitting</span>
</span><span id="MSPeakCalculation.lorentz-595"><a href="#MSPeakCalculation.lorentz-595"><span class="linenos">595</span></a>
</span><span id="MSPeakCalculation.lorentz-596"><a href="#MSPeakCalculation.lorentz-596"><span class="linenos">596</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation.lorentz-597"><a href="#MSPeakCalculation.lorentz-597"><span class="linenos">597</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation.lorentz-598"><a href="#MSPeakCalculation.lorentz-598"><span class="linenos">598</span></a><span class="sd">        mz_domain : ndarray</span>
</span><span id="MSPeakCalculation.lorentz-599"><a href="#MSPeakCalculation.lorentz-599"><span class="linenos">599</span></a><span class="sd">            x-axis domain for fit</span>
</span><span id="MSPeakCalculation.lorentz-600"><a href="#MSPeakCalculation.lorentz-600"><span class="linenos">600</span></a><span class="sd">        calc_abundance : ndarray</span>
</span><span id="MSPeakCalculation.lorentz-601"><a href="#MSPeakCalculation.lorentz-601"><span class="linenos">601</span></a><span class="sd">            calculated abundance profile based on lorentz function</span>
</span><span id="MSPeakCalculation.lorentz-602"><a href="#MSPeakCalculation.lorentz-602"><span class="linenos">602</span></a>
</span><span id="MSPeakCalculation.lorentz-603"><a href="#MSPeakCalculation.lorentz-603"><span class="linenos">603</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.lorentz-604"><a href="#MSPeakCalculation.lorentz-604"><span class="linenos">604</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="MSPeakCalculation.lorentz-605"><a href="#MSPeakCalculation.lorentz-605"><span class="linenos">605</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="MSPeakCalculation.lorentz-606"><a href="#MSPeakCalculation.lorentz-606"><span class="linenos">606</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="MSPeakCalculation.lorentz-607"><a href="#MSPeakCalculation.lorentz-607"><span class="linenos">607</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span> <span class="o">+</span> <span class="n">delta_rp</span>
</span><span id="MSPeakCalculation.lorentz-608"><a href="#MSPeakCalculation.lorentz-608"><span class="linenos">608</span></a>            <span class="p">)</span>  <span class="c1"># self.resolving_power)</span>
</span><span id="MSPeakCalculation.lorentz-609"><a href="#MSPeakCalculation.lorentz-609"><span class="linenos">609</span></a>
</span><span id="MSPeakCalculation.lorentz-610"><a href="#MSPeakCalculation.lorentz-610"><span class="linenos">610</span></a>            <span class="c1"># stardart deviation</span>
</span><span id="MSPeakCalculation.lorentz-611"><a href="#MSPeakCalculation.lorentz-611"><span class="linenos">611</span></a>            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="MSPeakCalculation.lorentz-612"><a href="#MSPeakCalculation.lorentz-612"><span class="linenos">612</span></a>
</span><span id="MSPeakCalculation.lorentz-613"><a href="#MSPeakCalculation.lorentz-613"><span class="linenos">613</span></a>            <span class="c1"># half width baseline distance</span>
</span><span id="MSPeakCalculation.lorentz-614"><a href="#MSPeakCalculation.lorentz-614"><span class="linenos">614</span></a>            <span class="n">hw_base_distance</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">sigma</span>
</span><span id="MSPeakCalculation.lorentz-615"><a href="#MSPeakCalculation.lorentz-615"><span class="linenos">615</span></a>
</span><span id="MSPeakCalculation.lorentz-616"><a href="#MSPeakCalculation.lorentz-616"><span class="linenos">616</span></a>            <span class="c1"># mz_domain = linspace(self.mz_exp - hw_base_distance,</span>
</span><span id="MSPeakCalculation.lorentz-617"><a href="#MSPeakCalculation.lorentz-617"><span class="linenos">617</span></a>            <span class="c1">#                     self.mz_exp + hw_base_distance, datapoint)</span>
</span><span id="MSPeakCalculation.lorentz-618"><a href="#MSPeakCalculation.lorentz-618"><span class="linenos">618</span></a>
</span><span id="MSPeakCalculation.lorentz-619"><a href="#MSPeakCalculation.lorentz-619"><span class="linenos">619</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mz_domain</span><span class="p">(</span><span class="n">oversample_multiplier</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="p">)</span>
</span><span id="MSPeakCalculation.lorentz-620"><a href="#MSPeakCalculation.lorentz-620"><span class="linenos">620</span></a>            <span class="c1"># gaussian_pdf = lambda x0, x, s: (1/ math.sqrt(2*math.pi*math.pow(s,2))) * math.exp(-1 * math.pow(x-x0,2) / 2*math.pow(s,2) )</span>
</span><span id="MSPeakCalculation.lorentz-621"><a href="#MSPeakCalculation.lorentz-621"><span class="linenos">621</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">LorentzianModel</span><span class="p">()</span>
</span><span id="MSPeakCalculation.lorentz-622"><a href="#MSPeakCalculation.lorentz-622"><span class="linenos">622</span></a>
</span><span id="MSPeakCalculation.lorentz-623"><a href="#MSPeakCalculation.lorentz-623"><span class="linenos">623</span></a>            <span class="n">amplitude</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="MSPeakCalculation.lorentz-624"><a href="#MSPeakCalculation.lorentz-624"><span class="linenos">624</span></a>
</span><span id="MSPeakCalculation.lorentz-625"><a href="#MSPeakCalculation.lorentz-625"><span class="linenos">625</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="MSPeakCalculation.lorentz-626"><a href="#MSPeakCalculation.lorentz-626"><span class="linenos">626</span></a>                <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="MSPeakCalculation.lorentz-627"><a href="#MSPeakCalculation.lorentz-627"><span class="linenos">627</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation.lorentz-628"><a href="#MSPeakCalculation.lorentz-628"><span class="linenos">628</span></a>
</span><span id="MSPeakCalculation.lorentz-629"><a href="#MSPeakCalculation.lorentz-629"><span class="linenos">629</span></a>            <span class="n">calc_abundance</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mz_domain</span><span class="p">)</span>
</span><span id="MSPeakCalculation.lorentz-630"><a href="#MSPeakCalculation.lorentz-630"><span class="linenos">630</span></a>
</span><span id="MSPeakCalculation.lorentz-631"><a href="#MSPeakCalculation.lorentz-631"><span class="linenos">631</span></a>            <span class="k">return</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">calc_abundance</span>
</span><span id="MSPeakCalculation.lorentz-632"><a href="#MSPeakCalculation.lorentz-632"><span class="linenos">632</span></a>
</span><span id="MSPeakCalculation.lorentz-633"><a href="#MSPeakCalculation.lorentz-633"><span class="linenos">633</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.lorentz-634"><a href="#MSPeakCalculation.lorentz-634"><span class="linenos">634</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="MSPeakCalculation.lorentz-635"><a href="#MSPeakCalculation.lorentz-635"><span class="linenos">635</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="MSPeakCalculation.lorentz-636"><a href="#MSPeakCalculation.lorentz-636"><span class="linenos">636</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>[Legacy] Lorentz lineshape analysis function</p>

<p>Legacy function for lorentz lineshape analysis</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>oversample_multiplier</strong> (int):
factor to increase x-axis points by for simulation of fitted lineshape function</li>
<li><strong>delta_rp</strong> (float):
delta resolving power to add to resolving power</li>
<li><strong>mz_overlay</strong> (int):
extra points left and right of peak definition to include in fitting</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>mz_domain</strong> (ndarray):
x-axis domain for fit</li>
<li><strong>calc_abundance</strong> (ndarray):
calculated abundance profile based on lorentz function</li>
</ul>
</div>


                            </div>
                            <div id="MSPeakCalculation.gaussian" class="classattr">
                                        <input id="MSPeakCalculation.gaussian-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">gaussian</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">oversample_multiplier</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span>, </span><span class="param"><span class="n">mz_overlay</span><span class="o">=</span><span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.gaussian-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.gaussian"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.gaussian-638"><a href="#MSPeakCalculation.gaussian-638"><span class="linenos">638</span></a>    <span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oversample_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">delta_rp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="MSPeakCalculation.gaussian-639"><a href="#MSPeakCalculation.gaussian-639"><span class="linenos">639</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;[Legacy] Gaussian lineshape analysis function</span>
</span><span id="MSPeakCalculation.gaussian-640"><a href="#MSPeakCalculation.gaussian-640"><span class="linenos">640</span></a><span class="sd">        Legacy gaussian lineshape analysis function</span>
</span><span id="MSPeakCalculation.gaussian-641"><a href="#MSPeakCalculation.gaussian-641"><span class="linenos">641</span></a>
</span><span id="MSPeakCalculation.gaussian-642"><a href="#MSPeakCalculation.gaussian-642"><span class="linenos">642</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation.gaussian-643"><a href="#MSPeakCalculation.gaussian-643"><span class="linenos">643</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.gaussian-644"><a href="#MSPeakCalculation.gaussian-644"><span class="linenos">644</span></a><span class="sd">        oversample_multiplier : int</span>
</span><span id="MSPeakCalculation.gaussian-645"><a href="#MSPeakCalculation.gaussian-645"><span class="linenos">645</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function</span>
</span><span id="MSPeakCalculation.gaussian-646"><a href="#MSPeakCalculation.gaussian-646"><span class="linenos">646</span></a><span class="sd">        delta_rp : float</span>
</span><span id="MSPeakCalculation.gaussian-647"><a href="#MSPeakCalculation.gaussian-647"><span class="linenos">647</span></a><span class="sd">            delta resolving power to add to resolving power</span>
</span><span id="MSPeakCalculation.gaussian-648"><a href="#MSPeakCalculation.gaussian-648"><span class="linenos">648</span></a><span class="sd">        mz_overlay : int</span>
</span><span id="MSPeakCalculation.gaussian-649"><a href="#MSPeakCalculation.gaussian-649"><span class="linenos">649</span></a><span class="sd">            extra points left and right of peak definition to include in fitting</span>
</span><span id="MSPeakCalculation.gaussian-650"><a href="#MSPeakCalculation.gaussian-650"><span class="linenos">650</span></a>
</span><span id="MSPeakCalculation.gaussian-651"><a href="#MSPeakCalculation.gaussian-651"><span class="linenos">651</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation.gaussian-652"><a href="#MSPeakCalculation.gaussian-652"><span class="linenos">652</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation.gaussian-653"><a href="#MSPeakCalculation.gaussian-653"><span class="linenos">653</span></a><span class="sd">        mz_domain : ndarray</span>
</span><span id="MSPeakCalculation.gaussian-654"><a href="#MSPeakCalculation.gaussian-654"><span class="linenos">654</span></a><span class="sd">            x-axis domain for fit</span>
</span><span id="MSPeakCalculation.gaussian-655"><a href="#MSPeakCalculation.gaussian-655"><span class="linenos">655</span></a><span class="sd">        calc_abundance : ndarray</span>
</span><span id="MSPeakCalculation.gaussian-656"><a href="#MSPeakCalculation.gaussian-656"><span class="linenos">656</span></a><span class="sd">            calculated abundance profile based on gaussian function</span>
</span><span id="MSPeakCalculation.gaussian-657"><a href="#MSPeakCalculation.gaussian-657"><span class="linenos">657</span></a>
</span><span id="MSPeakCalculation.gaussian-658"><a href="#MSPeakCalculation.gaussian-658"><span class="linenos">658</span></a>
</span><span id="MSPeakCalculation.gaussian-659"><a href="#MSPeakCalculation.gaussian-659"><span class="linenos">659</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.gaussian-660"><a href="#MSPeakCalculation.gaussian-660"><span class="linenos">660</span></a>
</span><span id="MSPeakCalculation.gaussian-661"><a href="#MSPeakCalculation.gaussian-661"><span class="linenos">661</span></a>        <span class="c1"># check if MSPeak contains the resolving power info</span>
</span><span id="MSPeakCalculation.gaussian-662"><a href="#MSPeakCalculation.gaussian-662"><span class="linenos">662</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span><span class="p">:</span>
</span><span id="MSPeakCalculation.gaussian-663"><a href="#MSPeakCalculation.gaussian-663"><span class="linenos">663</span></a>            <span class="c1"># full width half maximum distance</span>
</span><span id="MSPeakCalculation.gaussian-664"><a href="#MSPeakCalculation.gaussian-664"><span class="linenos">664</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">/</span> <span class="p">(</span>
</span><span id="MSPeakCalculation.gaussian-665"><a href="#MSPeakCalculation.gaussian-665"><span class="linenos">665</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">resolving_power</span> <span class="o">+</span> <span class="n">delta_rp</span>
</span><span id="MSPeakCalculation.gaussian-666"><a href="#MSPeakCalculation.gaussian-666"><span class="linenos">666</span></a>            <span class="p">)</span>  <span class="c1"># self.resolving_power)</span>
</span><span id="MSPeakCalculation.gaussian-667"><a href="#MSPeakCalculation.gaussian-667"><span class="linenos">667</span></a>
</span><span id="MSPeakCalculation.gaussian-668"><a href="#MSPeakCalculation.gaussian-668"><span class="linenos">668</span></a>            <span class="c1"># stardart deviation</span>
</span><span id="MSPeakCalculation.gaussian-669"><a href="#MSPeakCalculation.gaussian-669"><span class="linenos">669</span></a>            <span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
</span><span id="MSPeakCalculation.gaussian-670"><a href="#MSPeakCalculation.gaussian-670"><span class="linenos">670</span></a>
</span><span id="MSPeakCalculation.gaussian-671"><a href="#MSPeakCalculation.gaussian-671"><span class="linenos">671</span></a>            <span class="c1"># half width baseline distance</span>
</span><span id="MSPeakCalculation.gaussian-672"><a href="#MSPeakCalculation.gaussian-672"><span class="linenos">672</span></a>            <span class="c1"># hw_base_distance = (3.2 * s)</span>
</span><span id="MSPeakCalculation.gaussian-673"><a href="#MSPeakCalculation.gaussian-673"><span class="linenos">673</span></a>
</span><span id="MSPeakCalculation.gaussian-674"><a href="#MSPeakCalculation.gaussian-674"><span class="linenos">674</span></a>            <span class="c1"># match_loz_factor = 3</span>
</span><span id="MSPeakCalculation.gaussian-675"><a href="#MSPeakCalculation.gaussian-675"><span class="linenos">675</span></a>
</span><span id="MSPeakCalculation.gaussian-676"><a href="#MSPeakCalculation.gaussian-676"><span class="linenos">676</span></a>            <span class="c1"># n_d = hw_base_distance * match_loz_factor</span>
</span><span id="MSPeakCalculation.gaussian-677"><a href="#MSPeakCalculation.gaussian-677"><span class="linenos">677</span></a>
</span><span id="MSPeakCalculation.gaussian-678"><a href="#MSPeakCalculation.gaussian-678"><span class="linenos">678</span></a>            <span class="c1"># mz_domain = linspace(</span>
</span><span id="MSPeakCalculation.gaussian-679"><a href="#MSPeakCalculation.gaussian-679"><span class="linenos">679</span></a>            <span class="c1">#    self.mz_exp - n_d, self.mz_exp + n_d, datapoint)</span>
</span><span id="MSPeakCalculation.gaussian-680"><a href="#MSPeakCalculation.gaussian-680"><span class="linenos">680</span></a>
</span><span id="MSPeakCalculation.gaussian-681"><a href="#MSPeakCalculation.gaussian-681"><span class="linenos">681</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mz_domain</span><span class="p">(</span><span class="n">oversample_multiplier</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="p">)</span>
</span><span id="MSPeakCalculation.gaussian-682"><a href="#MSPeakCalculation.gaussian-682"><span class="linenos">682</span></a>
</span><span id="MSPeakCalculation.gaussian-683"><a href="#MSPeakCalculation.gaussian-683"><span class="linenos">683</span></a>            <span class="c1"># gaussian_pdf = lambda x0, x, s: (1/ math.sqrt(2*math.pi*math.pow(s,2))) * math.exp(-1 * math.pow(x-x0,2) / 2*math.pow(s,2) )</span>
</span><span id="MSPeakCalculation.gaussian-684"><a href="#MSPeakCalculation.gaussian-684"><span class="linenos">684</span></a>
</span><span id="MSPeakCalculation.gaussian-685"><a href="#MSPeakCalculation.gaussian-685"><span class="linenos">685</span></a>            <span class="c1"># calc_abundance = norm.pdf(mz_domain, self.mz_exp, s)</span>
</span><span id="MSPeakCalculation.gaussian-686"><a href="#MSPeakCalculation.gaussian-686"><span class="linenos">686</span></a>
</span><span id="MSPeakCalculation.gaussian-687"><a href="#MSPeakCalculation.gaussian-687"><span class="linenos">687</span></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">GaussianModel</span><span class="p">()</span>
</span><span id="MSPeakCalculation.gaussian-688"><a href="#MSPeakCalculation.gaussian-688"><span class="linenos">688</span></a>
</span><span id="MSPeakCalculation.gaussian-689"><a href="#MSPeakCalculation.gaussian-689"><span class="linenos">689</span></a>            <span class="n">amplitude</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="MSPeakCalculation.gaussian-690"><a href="#MSPeakCalculation.gaussian-690"><span class="linenos">690</span></a>
</span><span id="MSPeakCalculation.gaussian-691"><a href="#MSPeakCalculation.gaussian-691"><span class="linenos">691</span></a>            <span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">make_params</span><span class="p">(</span>
</span><span id="MSPeakCalculation.gaussian-692"><a href="#MSPeakCalculation.gaussian-692"><span class="linenos">692</span></a>                <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span>
</span><span id="MSPeakCalculation.gaussian-693"><a href="#MSPeakCalculation.gaussian-693"><span class="linenos">693</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation.gaussian-694"><a href="#MSPeakCalculation.gaussian-694"><span class="linenos">694</span></a>
</span><span id="MSPeakCalculation.gaussian-695"><a href="#MSPeakCalculation.gaussian-695"><span class="linenos">695</span></a>            <span class="n">calc_abundance</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mz_domain</span><span class="p">)</span>
</span><span id="MSPeakCalculation.gaussian-696"><a href="#MSPeakCalculation.gaussian-696"><span class="linenos">696</span></a>
</span><span id="MSPeakCalculation.gaussian-697"><a href="#MSPeakCalculation.gaussian-697"><span class="linenos">697</span></a>            <span class="k">return</span> <span class="n">mz_domain</span><span class="p">,</span> <span class="n">calc_abundance</span>
</span><span id="MSPeakCalculation.gaussian-698"><a href="#MSPeakCalculation.gaussian-698"><span class="linenos">698</span></a>
</span><span id="MSPeakCalculation.gaussian-699"><a href="#MSPeakCalculation.gaussian-699"><span class="linenos">699</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.gaussian-700"><a href="#MSPeakCalculation.gaussian-700"><span class="linenos">700</span></a>            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span>
</span><span id="MSPeakCalculation.gaussian-701"><a href="#MSPeakCalculation.gaussian-701"><span class="linenos">701</span></a>                <span class="s2">&quot;resolving power is not defined, try to use set_max_resolving_power()&quot;</span>
</span><span id="MSPeakCalculation.gaussian-702"><a href="#MSPeakCalculation.gaussian-702"><span class="linenos">702</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>[Legacy] Gaussian lineshape analysis function
Legacy gaussian lineshape analysis function</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>oversample_multiplier</strong> (int):
factor to increase x-axis points by for simulation of fitted lineshape function</li>
<li><strong>delta_rp</strong> (float):
delta resolving power to add to resolving power</li>
<li><strong>mz_overlay</strong> (int):
extra points left and right of peak definition to include in fitting</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>mz_domain</strong> (ndarray):
x-axis domain for fit</li>
<li><strong>calc_abundance</strong> (ndarray):
calculated abundance profile based on gaussian function</li>
</ul>
</div>


                            </div>
                            <div id="MSPeakCalculation.get_mz_domain" class="classattr">
                                        <input id="MSPeakCalculation.get_mz_domain-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_mz_domain</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">oversample_multiplier</span>, </span><span class="param"><span class="n">mz_overlay</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.get_mz_domain-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.get_mz_domain"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.get_mz_domain-704"><a href="#MSPeakCalculation.get_mz_domain-704"><span class="linenos">704</span></a>    <span class="k">def</span> <span class="nf">get_mz_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oversample_multiplier</span><span class="p">,</span> <span class="n">mz_overlay</span><span class="p">):</span>
</span><span id="MSPeakCalculation.get_mz_domain-705"><a href="#MSPeakCalculation.get_mz_domain-705"><span class="linenos">705</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;[Legacy] function to resample/interpolate datapoints for lineshape analysis</span>
</span><span id="MSPeakCalculation.get_mz_domain-706"><a href="#MSPeakCalculation.get_mz_domain-706"><span class="linenos">706</span></a>
</span><span id="MSPeakCalculation.get_mz_domain-707"><a href="#MSPeakCalculation.get_mz_domain-707"><span class="linenos">707</span></a><span class="sd">        This code is used for the legacy line fitting functions and not recommended.</span>
</span><span id="MSPeakCalculation.get_mz_domain-708"><a href="#MSPeakCalculation.get_mz_domain-708"><span class="linenos">708</span></a><span class="sd">        Legacy function to support expanding mz domain for legacy lineshape functions</span>
</span><span id="MSPeakCalculation.get_mz_domain-709"><a href="#MSPeakCalculation.get_mz_domain-709"><span class="linenos">709</span></a>
</span><span id="MSPeakCalculation.get_mz_domain-710"><a href="#MSPeakCalculation.get_mz_domain-710"><span class="linenos">710</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation.get_mz_domain-711"><a href="#MSPeakCalculation.get_mz_domain-711"><span class="linenos">711</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.get_mz_domain-712"><a href="#MSPeakCalculation.get_mz_domain-712"><span class="linenos">712</span></a><span class="sd">        oversample_multiplier : int</span>
</span><span id="MSPeakCalculation.get_mz_domain-713"><a href="#MSPeakCalculation.get_mz_domain-713"><span class="linenos">713</span></a><span class="sd">            factor to increase x-axis points by for simulation of fitted lineshape function</span>
</span><span id="MSPeakCalculation.get_mz_domain-714"><a href="#MSPeakCalculation.get_mz_domain-714"><span class="linenos">714</span></a><span class="sd">        mz_overlay : int</span>
</span><span id="MSPeakCalculation.get_mz_domain-715"><a href="#MSPeakCalculation.get_mz_domain-715"><span class="linenos">715</span></a><span class="sd">            extra points left and right of peak definition to include in fitting</span>
</span><span id="MSPeakCalculation.get_mz_domain-716"><a href="#MSPeakCalculation.get_mz_domain-716"><span class="linenos">716</span></a>
</span><span id="MSPeakCalculation.get_mz_domain-717"><a href="#MSPeakCalculation.get_mz_domain-717"><span class="linenos">717</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation.get_mz_domain-718"><a href="#MSPeakCalculation.get_mz_domain-718"><span class="linenos">718</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation.get_mz_domain-719"><a href="#MSPeakCalculation.get_mz_domain-719"><span class="linenos">719</span></a><span class="sd">        mz_domain : ndarray</span>
</span><span id="MSPeakCalculation.get_mz_domain-720"><a href="#MSPeakCalculation.get_mz_domain-720"><span class="linenos">720</span></a><span class="sd">            x-axis domain for fit</span>
</span><span id="MSPeakCalculation.get_mz_domain-721"><a href="#MSPeakCalculation.get_mz_domain-721"><span class="linenos">721</span></a>
</span><span id="MSPeakCalculation.get_mz_domain-722"><a href="#MSPeakCalculation.get_mz_domain-722"><span class="linenos">722</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.get_mz_domain-723"><a href="#MSPeakCalculation.get_mz_domain-723"><span class="linenos">723</span></a>        <span class="n">start_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MSPeakCalculation.get_mz_domain-724"><a href="#MSPeakCalculation.get_mz_domain-724"><span class="linenos">724</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">-</span> <span class="n">mz_overlay</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_left_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="MSPeakCalculation.get_mz_domain-725"><a href="#MSPeakCalculation.get_mz_domain-725"><span class="linenos">725</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation.get_mz_domain-726"><a href="#MSPeakCalculation.get_mz_domain-726"><span class="linenos">726</span></a>        <span class="n">final_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MSPeakCalculation.get_mz_domain-727"><a href="#MSPeakCalculation.get_mz_domain-727"><span class="linenos">727</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">+</span> <span class="n">mz_overlay</span>
</span><span id="MSPeakCalculation.get_mz_domain-728"><a href="#MSPeakCalculation.get_mz_domain-728"><span class="linenos">728</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">)</span>
</span><span id="MSPeakCalculation.get_mz_domain-729"><a href="#MSPeakCalculation.get_mz_domain-729"><span class="linenos">729</span></a>            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak_right_index</span>
</span><span id="MSPeakCalculation.get_mz_domain-730"><a href="#MSPeakCalculation.get_mz_domain-730"><span class="linenos">730</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation.get_mz_domain-731"><a href="#MSPeakCalculation.get_mz_domain-731"><span class="linenos">731</span></a>
</span><span id="MSPeakCalculation.get_mz_domain-732"><a href="#MSPeakCalculation.get_mz_domain-732"><span class="linenos">732</span></a>        <span class="k">if</span> <span class="n">oversample_multiplier</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MSPeakCalculation.get_mz_domain-733"><a href="#MSPeakCalculation.get_mz_domain-733"><span class="linenos">733</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">final_index</span><span class="p">]</span>
</span><span id="MSPeakCalculation.get_mz_domain-734"><a href="#MSPeakCalculation.get_mz_domain-734"><span class="linenos">734</span></a>
</span><span id="MSPeakCalculation.get_mz_domain-735"><a href="#MSPeakCalculation.get_mz_domain-735"><span class="linenos">735</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.get_mz_domain-736"><a href="#MSPeakCalculation.get_mz_domain-736"><span class="linenos">736</span></a>            <span class="c1"># we assume a linear correlation for m/z and datapoits</span>
</span><span id="MSPeakCalculation.get_mz_domain-737"><a href="#MSPeakCalculation.get_mz_domain-737"><span class="linenos">737</span></a>            <span class="c1"># which is only true if the m/z range in narrow (within 1 m/z unit)</span>
</span><span id="MSPeakCalculation.get_mz_domain-738"><a href="#MSPeakCalculation.get_mz_domain-738"><span class="linenos">738</span></a>            <span class="c1"># this is not true for a wide m/z range</span>
</span><span id="MSPeakCalculation.get_mz_domain-739"><a href="#MSPeakCalculation.get_mz_domain-739"><span class="linenos">739</span></a>
</span><span id="MSPeakCalculation.get_mz_domain-740"><a href="#MSPeakCalculation.get_mz_domain-740"><span class="linenos">740</span></a>            <span class="n">indexes</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_index</span><span class="p">,</span> <span class="n">final_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="MSPeakCalculation.get_mz_domain-741"><a href="#MSPeakCalculation.get_mz_domain-741"><span class="linenos">741</span></a>            <span class="n">mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_parent</span><span class="o">.</span><span class="n">mz_exp_profile</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span>
</span><span id="MSPeakCalculation.get_mz_domain-742"><a href="#MSPeakCalculation.get_mz_domain-742"><span class="linenos">742</span></a>            <span class="n">pol</span> <span class="o">=</span> <span class="n">poly1d</span><span class="p">(</span><span class="n">polyfit</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">mz</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="MSPeakCalculation.get_mz_domain-743"><a href="#MSPeakCalculation.get_mz_domain-743"><span class="linenos">743</span></a>            <span class="n">oversampled_indexes</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span>
</span><span id="MSPeakCalculation.get_mz_domain-744"><a href="#MSPeakCalculation.get_mz_domain-744"><span class="linenos">744</span></a>                <span class="n">start_index</span><span class="p">,</span>
</span><span id="MSPeakCalculation.get_mz_domain-745"><a href="#MSPeakCalculation.get_mz_domain-745"><span class="linenos">745</span></a>                <span class="n">final_index</span><span class="p">,</span>
</span><span id="MSPeakCalculation.get_mz_domain-746"><a href="#MSPeakCalculation.get_mz_domain-746"><span class="linenos">746</span></a>                <span class="p">(</span><span class="n">final_index</span> <span class="o">-</span> <span class="n">start_index</span><span class="p">)</span> <span class="o">*</span> <span class="n">oversample_multiplier</span><span class="p">,</span>
</span><span id="MSPeakCalculation.get_mz_domain-747"><a href="#MSPeakCalculation.get_mz_domain-747"><span class="linenos">747</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation.get_mz_domain-748"><a href="#MSPeakCalculation.get_mz_domain-748"><span class="linenos">748</span></a>            <span class="n">mz_domain</span> <span class="o">=</span> <span class="n">pol</span><span class="p">(</span><span class="n">oversampled_indexes</span><span class="p">)</span>
</span><span id="MSPeakCalculation.get_mz_domain-749"><a href="#MSPeakCalculation.get_mz_domain-749"><span class="linenos">749</span></a>
</span><span id="MSPeakCalculation.get_mz_domain-750"><a href="#MSPeakCalculation.get_mz_domain-750"><span class="linenos">750</span></a>        <span class="k">return</span> <span class="n">mz_domain</span>
</span></pre></div>


            <div class="docstring"><p>[Legacy] function to resample/interpolate datapoints for lineshape analysis</p>

<p>This code is used for the legacy line fitting functions and not recommended.
Legacy function to support expanding mz domain for legacy lineshape functions</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>oversample_multiplier</strong> (int):
factor to increase x-axis points by for simulation of fitted lineshape function</li>
<li><strong>mz_overlay</strong> (int):
extra points left and right of peak definition to include in fitting</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>mz_domain</strong> (ndarray):
x-axis domain for fit</li>
</ul>
</div>


                            </div>
                            <div id="MSPeakCalculation.number_possible_assignments" class="classattr">
                                <div class="attr variable">
            <span class="name">number_possible_assignments</span>

        
    </div>
    <a class="headerlink" href="#MSPeakCalculation.number_possible_assignments"></a>
    
    

                            </div>
                            <div id="MSPeakCalculation.molecular_formula_lowest_error" class="classattr">
                                        <input id="MSPeakCalculation.molecular_formula_lowest_error-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">molecular_formula_lowest_error</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.molecular_formula_lowest_error-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.molecular_formula_lowest_error"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.molecular_formula_lowest_error-758"><a href="#MSPeakCalculation.molecular_formula_lowest_error-758"><span class="linenos">758</span></a>    <span class="k">def</span> <span class="nf">molecular_formula_lowest_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MSPeakCalculation.molecular_formula_lowest_error-759"><a href="#MSPeakCalculation.molecular_formula_lowest_error-759"><span class="linenos">759</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the molecular formula with the smallest absolute mz error&quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.molecular_formula_lowest_error-760"><a href="#MSPeakCalculation.molecular_formula_lowest_error-760"><span class="linenos">760</span></a>
</span><span id="MSPeakCalculation.molecular_formula_lowest_error-761"><a href="#MSPeakCalculation.molecular_formula_lowest_error-761"><span class="linenos">761</span></a>        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Return the molecular formula with the smallest absolute mz error</p>
</div>


                            </div>
                            <div id="MSPeakCalculation.molecular_formula_highest_prob_score" class="classattr">
                                        <input id="MSPeakCalculation.molecular_formula_highest_prob_score-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">molecular_formula_highest_prob_score</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.molecular_formula_highest_prob_score-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.molecular_formula_highest_prob_score"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.molecular_formula_highest_prob_score-763"><a href="#MSPeakCalculation.molecular_formula_highest_prob_score-763"><span class="linenos">763</span></a>    <span class="k">def</span> <span class="nf">molecular_formula_highest_prob_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MSPeakCalculation.molecular_formula_highest_prob_score-764"><a href="#MSPeakCalculation.molecular_formula_highest_prob_score-764"><span class="linenos">764</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the molecular formula with the highest confidence score score&quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.molecular_formula_highest_prob_score-765"><a href="#MSPeakCalculation.molecular_formula_highest_prob_score-765"><span class="linenos">765</span></a>
</span><span id="MSPeakCalculation.molecular_formula_highest_prob_score-766"><a href="#MSPeakCalculation.molecular_formula_highest_prob_score-766"><span class="linenos">766</span></a>        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">confidence_score</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Return the molecular formula with the highest confidence score score</p>
</div>


                            </div>
                            <div id="MSPeakCalculation.molecular_formula_earth_filter" class="classattr">
                                        <input id="MSPeakCalculation.molecular_formula_earth_filter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">molecular_formula_earth_filter</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">lowest_error</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.molecular_formula_earth_filter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.molecular_formula_earth_filter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.molecular_formula_earth_filter-768"><a href="#MSPeakCalculation.molecular_formula_earth_filter-768"><span class="linenos">768</span></a>    <span class="k">def</span> <span class="nf">molecular_formula_earth_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lowest_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-769"><a href="#MSPeakCalculation.molecular_formula_earth_filter-769"><span class="linenos">769</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter molecular formula using the &#39;Earth&#39; filter</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-770"><a href="#MSPeakCalculation.molecular_formula_earth_filter-770"><span class="linenos">770</span></a>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-771"><a href="#MSPeakCalculation.molecular_formula_earth_filter-771"><span class="linenos">771</span></a><span class="sd">        This function applies the Formularity-esque &#39;Earth&#39; filter to possible molecular formula assignments.</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-772"><a href="#MSPeakCalculation.molecular_formula_earth_filter-772"><span class="linenos">772</span></a><span class="sd">        Earth Filter:</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-773"><a href="#MSPeakCalculation.molecular_formula_earth_filter-773"><span class="linenos">773</span></a><span class="sd">            O &gt; 0 AND N &lt;= 3 AND P &lt;= 2 AND 3P &lt;= O</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-774"><a href="#MSPeakCalculation.molecular_formula_earth_filter-774"><span class="linenos">774</span></a>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-775"><a href="#MSPeakCalculation.molecular_formula_earth_filter-775"><span class="linenos">775</span></a><span class="sd">        If the lowest_error method is also used, it will return the single formula annotation with the smallest absolute error which also fits the Earth filter.</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-776"><a href="#MSPeakCalculation.molecular_formula_earth_filter-776"><span class="linenos">776</span></a><span class="sd">        Otherwise, it will return all Earth-filter compliant formulas.</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-777"><a href="#MSPeakCalculation.molecular_formula_earth_filter-777"><span class="linenos">777</span></a>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-778"><a href="#MSPeakCalculation.molecular_formula_earth_filter-778"><span class="linenos">778</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-779"><a href="#MSPeakCalculation.molecular_formula_earth_filter-779"><span class="linenos">779</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-780"><a href="#MSPeakCalculation.molecular_formula_earth_filter-780"><span class="linenos">780</span></a><span class="sd">        lowest_error : bool, optional.</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-781"><a href="#MSPeakCalculation.molecular_formula_earth_filter-781"><span class="linenos">781</span></a><span class="sd">            Return only the lowest error formula which also fits the Earth filter.</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-782"><a href="#MSPeakCalculation.molecular_formula_earth_filter-782"><span class="linenos">782</span></a><span class="sd">            If False, return all Earth-filter compliant formulas. Default is True.</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-783"><a href="#MSPeakCalculation.molecular_formula_earth_filter-783"><span class="linenos">783</span></a>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-784"><a href="#MSPeakCalculation.molecular_formula_earth_filter-784"><span class="linenos">784</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-785"><a href="#MSPeakCalculation.molecular_formula_earth_filter-785"><span class="linenos">785</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-786"><a href="#MSPeakCalculation.molecular_formula_earth_filter-786"><span class="linenos">786</span></a><span class="sd">        list</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-787"><a href="#MSPeakCalculation.molecular_formula_earth_filter-787"><span class="linenos">787</span></a><span class="sd">            List of molecular formula objects which fit the Earth filter</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-788"><a href="#MSPeakCalculation.molecular_formula_earth_filter-788"><span class="linenos">788</span></a>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-789"><a href="#MSPeakCalculation.molecular_formula_earth_filter-789"><span class="linenos">789</span></a><span class="sd">        References</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-790"><a href="#MSPeakCalculation.molecular_formula_earth_filter-790"><span class="linenos">790</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-791"><a href="#MSPeakCalculation.molecular_formula_earth_filter-791"><span class="linenos">791</span></a><span class="sd">        1. Nikola Tolic et al., &quot;Formularity: Software for Automated Formula Assignment of Natural and Other Organic Matter from Ultrahigh-Resolution Mass Spectra&quot;</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-792"><a href="#MSPeakCalculation.molecular_formula_earth_filter-792"><span class="linenos">792</span></a><span class="sd">            Anal. Chem. 2017, 89, 23, 12659–12665</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-793"><a href="#MSPeakCalculation.molecular_formula_earth_filter-793"><span class="linenos">793</span></a><span class="sd">            doi: 10.1021/acs.analchem.7b03318</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-794"><a href="#MSPeakCalculation.molecular_formula_earth_filter-794"><span class="linenos">794</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-795"><a href="#MSPeakCalculation.molecular_formula_earth_filter-795"><span class="linenos">795</span></a>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-796"><a href="#MSPeakCalculation.molecular_formula_earth_filter-796"><span class="linenos">796</span></a>        <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-797"><a href="#MSPeakCalculation.molecular_formula_earth_filter-797"><span class="linenos">797</span></a>            <span class="nb">filter</span><span class="p">(</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-798"><a href="#MSPeakCalculation.molecular_formula_earth_filter-798"><span class="linenos">798</span></a>                <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-799"><a href="#MSPeakCalculation.molecular_formula_earth_filter-799"><span class="linenos">799</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-800"><a href="#MSPeakCalculation.molecular_formula_earth_filter-800"><span class="linenos">800</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-801"><a href="#MSPeakCalculation.molecular_formula_earth_filter-801"><span class="linenos">801</span></a>                <span class="ow">and</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">),</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-802"><a href="#MSPeakCalculation.molecular_formula_earth_filter-802"><span class="linenos">802</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-803"><a href="#MSPeakCalculation.molecular_formula_earth_filter-803"><span class="linenos">803</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-804"><a href="#MSPeakCalculation.molecular_formula_earth_filter-804"><span class="linenos">804</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-805"><a href="#MSPeakCalculation.molecular_formula_earth_filter-805"><span class="linenos">805</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-806"><a href="#MSPeakCalculation.molecular_formula_earth_filter-806"><span class="linenos">806</span></a>            <span class="k">if</span> <span class="n">lowest_error</span><span class="p">:</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-807"><a href="#MSPeakCalculation.molecular_formula_earth_filter-807"><span class="linenos">807</span></a>                <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-808"><a href="#MSPeakCalculation.molecular_formula_earth_filter-808"><span class="linenos">808</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-809"><a href="#MSPeakCalculation.molecular_formula_earth_filter-809"><span class="linenos">809</span></a>                <span class="k">return</span> <span class="n">candidates</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-810"><a href="#MSPeakCalculation.molecular_formula_earth_filter-810"><span class="linenos">810</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.molecular_formula_earth_filter-811"><a href="#MSPeakCalculation.molecular_formula_earth_filter-811"><span class="linenos">811</span></a>            <span class="k">return</span> <span class="n">candidates</span>
</span></pre></div>


            <div class="docstring"><p>Filter molecular formula using the 'Earth' filter</p>

<p>This function applies the Formularity-esque 'Earth' filter to possible molecular formula assignments.
Earth Filter:
    O &gt; 0 AND N &lt;= 3 AND P &lt;= 2 AND 3P &lt;= O</p>

<p>If the lowest_error method is also used, it will return the single formula annotation with the smallest absolute error which also fits the Earth filter.
Otherwise, it will return all Earth-filter compliant formulas.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>lowest_error</strong> (bool, optional.):
Return only the lowest error formula which also fits the Earth filter.
If False, return all Earth-filter compliant formulas. Default is True.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list</strong>: List of molecular formula objects which fit the Earth filter</li>
</ul>

<h6 id="references">References</h6>

<ol>
<li>Nikola Tolic et al., "Formularity: Software for Automated Formula Assignment of Natural and Other Organic Matter from Ultrahigh-Resolution Mass Spectra"
Anal. Chem. 2017, 89, 23, 12659–12665
doi: 10.1021/acs.analchem.7b03318</li>
</ol>
</div>


                            </div>
                            <div id="MSPeakCalculation.molecular_formula_water_filter" class="classattr">
                                        <input id="MSPeakCalculation.molecular_formula_water_filter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">molecular_formula_water_filter</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">lowest_error</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.molecular_formula_water_filter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.molecular_formula_water_filter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.molecular_formula_water_filter-813"><a href="#MSPeakCalculation.molecular_formula_water_filter-813"><span class="linenos">813</span></a>    <span class="k">def</span> <span class="nf">molecular_formula_water_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lowest_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-814"><a href="#MSPeakCalculation.molecular_formula_water_filter-814"><span class="linenos">814</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter molecular formula using the &#39;Water&#39; filter</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-815"><a href="#MSPeakCalculation.molecular_formula_water_filter-815"><span class="linenos">815</span></a>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-816"><a href="#MSPeakCalculation.molecular_formula_water_filter-816"><span class="linenos">816</span></a><span class="sd">        This function applies the Formularity-esque &#39;Water&#39; filter to possible molecular formula assignments.</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-817"><a href="#MSPeakCalculation.molecular_formula_water_filter-817"><span class="linenos">817</span></a><span class="sd">        Water Filter:</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-818"><a href="#MSPeakCalculation.molecular_formula_water_filter-818"><span class="linenos">818</span></a><span class="sd">            O &gt; 0 AND N &lt;= 3 AND S &lt;= 2 AND P &lt;= 2</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-819"><a href="#MSPeakCalculation.molecular_formula_water_filter-819"><span class="linenos">819</span></a>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-820"><a href="#MSPeakCalculation.molecular_formula_water_filter-820"><span class="linenos">820</span></a><span class="sd">        If the lowest_error method is also used, it will return the single formula annotation with the smallest absolute error which also fits the Water filter.</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-821"><a href="#MSPeakCalculation.molecular_formula_water_filter-821"><span class="linenos">821</span></a><span class="sd">        Otherwise, it will return all Water-filter compliant formulas.</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-822"><a href="#MSPeakCalculation.molecular_formula_water_filter-822"><span class="linenos">822</span></a>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-823"><a href="#MSPeakCalculation.molecular_formula_water_filter-823"><span class="linenos">823</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-824"><a href="#MSPeakCalculation.molecular_formula_water_filter-824"><span class="linenos">824</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-825"><a href="#MSPeakCalculation.molecular_formula_water_filter-825"><span class="linenos">825</span></a><span class="sd">        lowest_error : bool, optional</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-826"><a href="#MSPeakCalculation.molecular_formula_water_filter-826"><span class="linenos">826</span></a><span class="sd">            Return only the lowest error formula which also fits the Water filter.</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-827"><a href="#MSPeakCalculation.molecular_formula_water_filter-827"><span class="linenos">827</span></a><span class="sd">            If False, return all Water-filter compliant formulas. Defaults to 2</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-828"><a href="#MSPeakCalculation.molecular_formula_water_filter-828"><span class="linenos">828</span></a>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-829"><a href="#MSPeakCalculation.molecular_formula_water_filter-829"><span class="linenos">829</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-830"><a href="#MSPeakCalculation.molecular_formula_water_filter-830"><span class="linenos">830</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-831"><a href="#MSPeakCalculation.molecular_formula_water_filter-831"><span class="linenos">831</span></a><span class="sd">        list</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-832"><a href="#MSPeakCalculation.molecular_formula_water_filter-832"><span class="linenos">832</span></a><span class="sd">            List of molecular formula objects which fit the Water filter</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-833"><a href="#MSPeakCalculation.molecular_formula_water_filter-833"><span class="linenos">833</span></a>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-834"><a href="#MSPeakCalculation.molecular_formula_water_filter-834"><span class="linenos">834</span></a><span class="sd">        References</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-835"><a href="#MSPeakCalculation.molecular_formula_water_filter-835"><span class="linenos">835</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-836"><a href="#MSPeakCalculation.molecular_formula_water_filter-836"><span class="linenos">836</span></a><span class="sd">        1. Nikola Tolic et al., &quot;Formularity: Software for Automated Formula Assignment of Natural and Other Organic Matter from Ultrahigh-Resolution Mass Spectra&quot;</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-837"><a href="#MSPeakCalculation.molecular_formula_water_filter-837"><span class="linenos">837</span></a><span class="sd">            Anal. Chem. 2017, 89, 23, 12659–12665</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-838"><a href="#MSPeakCalculation.molecular_formula_water_filter-838"><span class="linenos">838</span></a><span class="sd">            doi: 10.1021/acs.analchem.7b03318</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-839"><a href="#MSPeakCalculation.molecular_formula_water_filter-839"><span class="linenos">839</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-840"><a href="#MSPeakCalculation.molecular_formula_water_filter-840"><span class="linenos">840</span></a>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-841"><a href="#MSPeakCalculation.molecular_formula_water_filter-841"><span class="linenos">841</span></a>        <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-842"><a href="#MSPeakCalculation.molecular_formula_water_filter-842"><span class="linenos">842</span></a>            <span class="nb">filter</span><span class="p">(</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-843"><a href="#MSPeakCalculation.molecular_formula_water_filter-843"><span class="linenos">843</span></a>                <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-844"><a href="#MSPeakCalculation.molecular_formula_water_filter-844"><span class="linenos">844</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-845"><a href="#MSPeakCalculation.molecular_formula_water_filter-845"><span class="linenos">845</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-846"><a href="#MSPeakCalculation.molecular_formula_water_filter-846"><span class="linenos">846</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-847"><a href="#MSPeakCalculation.molecular_formula_water_filter-847"><span class="linenos">847</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-848"><a href="#MSPeakCalculation.molecular_formula_water_filter-848"><span class="linenos">848</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-849"><a href="#MSPeakCalculation.molecular_formula_water_filter-849"><span class="linenos">849</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-850"><a href="#MSPeakCalculation.molecular_formula_water_filter-850"><span class="linenos">850</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-851"><a href="#MSPeakCalculation.molecular_formula_water_filter-851"><span class="linenos">851</span></a>            <span class="k">if</span> <span class="n">lowest_error</span><span class="p">:</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-852"><a href="#MSPeakCalculation.molecular_formula_water_filter-852"><span class="linenos">852</span></a>                <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-853"><a href="#MSPeakCalculation.molecular_formula_water_filter-853"><span class="linenos">853</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-854"><a href="#MSPeakCalculation.molecular_formula_water_filter-854"><span class="linenos">854</span></a>                <span class="k">return</span> <span class="n">candidates</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-855"><a href="#MSPeakCalculation.molecular_formula_water_filter-855"><span class="linenos">855</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.molecular_formula_water_filter-856"><a href="#MSPeakCalculation.molecular_formula_water_filter-856"><span class="linenos">856</span></a>            <span class="k">return</span> <span class="n">candidates</span>
</span></pre></div>


            <div class="docstring"><p>Filter molecular formula using the 'Water' filter</p>

<p>This function applies the Formularity-esque 'Water' filter to possible molecular formula assignments.
Water Filter:
    O &gt; 0 AND N &lt;= 3 AND S &lt;= 2 AND P &lt;= 2</p>

<p>If the lowest_error method is also used, it will return the single formula annotation with the smallest absolute error which also fits the Water filter.
Otherwise, it will return all Water-filter compliant formulas.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>lowest_error</strong> (bool, optional):
Return only the lowest error formula which also fits the Water filter.
If False, return all Water-filter compliant formulas. Defaults to 2</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list</strong>: List of molecular formula objects which fit the Water filter</li>
</ul>

<h6 id="references">References</h6>

<ol>
<li>Nikola Tolic et al., "Formularity: Software for Automated Formula Assignment of Natural and Other Organic Matter from Ultrahigh-Resolution Mass Spectra"
Anal. Chem. 2017, 89, 23, 12659–12665
doi: 10.1021/acs.analchem.7b03318</li>
</ol>
</div>


                            </div>
                            <div id="MSPeakCalculation.molecular_formula_air_filter" class="classattr">
                                        <input id="MSPeakCalculation.molecular_formula_air_filter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">molecular_formula_air_filter</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">lowest_error</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.molecular_formula_air_filter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.molecular_formula_air_filter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.molecular_formula_air_filter-858"><a href="#MSPeakCalculation.molecular_formula_air_filter-858"><span class="linenos">858</span></a>    <span class="k">def</span> <span class="nf">molecular_formula_air_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lowest_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-859"><a href="#MSPeakCalculation.molecular_formula_air_filter-859"><span class="linenos">859</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter molecular formula using the &#39;Air&#39; filter</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-860"><a href="#MSPeakCalculation.molecular_formula_air_filter-860"><span class="linenos">860</span></a>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-861"><a href="#MSPeakCalculation.molecular_formula_air_filter-861"><span class="linenos">861</span></a><span class="sd">        This function applies the Formularity-esque &#39;Air&#39; filter to possible molecular formula assignments.</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-862"><a href="#MSPeakCalculation.molecular_formula_air_filter-862"><span class="linenos">862</span></a><span class="sd">        Air Filter:</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-863"><a href="#MSPeakCalculation.molecular_formula_air_filter-863"><span class="linenos">863</span></a><span class="sd">            O &gt; 0 AND N &lt;= 3 AND S &lt;= 1 AND P = 0 AND 3(S+N) &lt;= O</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-864"><a href="#MSPeakCalculation.molecular_formula_air_filter-864"><span class="linenos">864</span></a>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-865"><a href="#MSPeakCalculation.molecular_formula_air_filter-865"><span class="linenos">865</span></a><span class="sd">        If the lowest_error method is also used, it will return the single formula annotation with the smallest absolute error which also fits the Air filter.</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-866"><a href="#MSPeakCalculation.molecular_formula_air_filter-866"><span class="linenos">866</span></a><span class="sd">        Otherwise, it will return all Air-filter compliant formulas.</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-867"><a href="#MSPeakCalculation.molecular_formula_air_filter-867"><span class="linenos">867</span></a>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-868"><a href="#MSPeakCalculation.molecular_formula_air_filter-868"><span class="linenos">868</span></a><span class="sd">        Parameters</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-869"><a href="#MSPeakCalculation.molecular_formula_air_filter-869"><span class="linenos">869</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-870"><a href="#MSPeakCalculation.molecular_formula_air_filter-870"><span class="linenos">870</span></a><span class="sd">        lowest_error : bool, optional</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-871"><a href="#MSPeakCalculation.molecular_formula_air_filter-871"><span class="linenos">871</span></a><span class="sd">            Return only the lowest error formula which also fits the Air filter.</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-872"><a href="#MSPeakCalculation.molecular_formula_air_filter-872"><span class="linenos">872</span></a><span class="sd">            If False, return all Air-filter compliant formulas. Defaults to True.</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-873"><a href="#MSPeakCalculation.molecular_formula_air_filter-873"><span class="linenos">873</span></a>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-874"><a href="#MSPeakCalculation.molecular_formula_air_filter-874"><span class="linenos">874</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-875"><a href="#MSPeakCalculation.molecular_formula_air_filter-875"><span class="linenos">875</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-876"><a href="#MSPeakCalculation.molecular_formula_air_filter-876"><span class="linenos">876</span></a><span class="sd">        list</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-877"><a href="#MSPeakCalculation.molecular_formula_air_filter-877"><span class="linenos">877</span></a><span class="sd">            List of molecular formula objects which fit the Air filter</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-878"><a href="#MSPeakCalculation.molecular_formula_air_filter-878"><span class="linenos">878</span></a>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-879"><a href="#MSPeakCalculation.molecular_formula_air_filter-879"><span class="linenos">879</span></a><span class="sd">        References</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-880"><a href="#MSPeakCalculation.molecular_formula_air_filter-880"><span class="linenos">880</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-881"><a href="#MSPeakCalculation.molecular_formula_air_filter-881"><span class="linenos">881</span></a><span class="sd">        1. Nikola Tolic et al., &quot;Formularity: Software for Automated Formula Assignment of Natural and Other Organic Matter from Ultrahigh-Resolution Mass Spectra&quot;</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-882"><a href="#MSPeakCalculation.molecular_formula_air_filter-882"><span class="linenos">882</span></a><span class="sd">            Anal. Chem. 2017, 89, 23, 12659–12665</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-883"><a href="#MSPeakCalculation.molecular_formula_air_filter-883"><span class="linenos">883</span></a><span class="sd">            doi: 10.1021/acs.analchem.7b03318</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-884"><a href="#MSPeakCalculation.molecular_formula_air_filter-884"><span class="linenos">884</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-885"><a href="#MSPeakCalculation.molecular_formula_air_filter-885"><span class="linenos">885</span></a>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-886"><a href="#MSPeakCalculation.molecular_formula_air_filter-886"><span class="linenos">886</span></a>        <span class="n">candidates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-887"><a href="#MSPeakCalculation.molecular_formula_air_filter-887"><span class="linenos">887</span></a>            <span class="nb">filter</span><span class="p">(</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-888"><a href="#MSPeakCalculation.molecular_formula_air_filter-888"><span class="linenos">888</span></a>                <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-889"><a href="#MSPeakCalculation.molecular_formula_air_filter-889"><span class="linenos">889</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-890"><a href="#MSPeakCalculation.molecular_formula_air_filter-890"><span class="linenos">890</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-891"><a href="#MSPeakCalculation.molecular_formula_air_filter-891"><span class="linenos">891</span></a>                <span class="ow">and</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-892"><a href="#MSPeakCalculation.molecular_formula_air_filter-892"><span class="linenos">892</span></a>                <span class="ow">and</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;O&quot;</span><span class="p">),</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-893"><a href="#MSPeakCalculation.molecular_formula_air_filter-893"><span class="linenos">893</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-894"><a href="#MSPeakCalculation.molecular_formula_air_filter-894"><span class="linenos">894</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-895"><a href="#MSPeakCalculation.molecular_formula_air_filter-895"><span class="linenos">895</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-896"><a href="#MSPeakCalculation.molecular_formula_air_filter-896"><span class="linenos">896</span></a>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-897"><a href="#MSPeakCalculation.molecular_formula_air_filter-897"><span class="linenos">897</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-898"><a href="#MSPeakCalculation.molecular_formula_air_filter-898"><span class="linenos">898</span></a>            <span class="k">if</span> <span class="n">lowest_error</span><span class="p">:</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-899"><a href="#MSPeakCalculation.molecular_formula_air_filter-899"><span class="linenos">899</span></a>                <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-900"><a href="#MSPeakCalculation.molecular_formula_air_filter-900"><span class="linenos">900</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-901"><a href="#MSPeakCalculation.molecular_formula_air_filter-901"><span class="linenos">901</span></a>                <span class="k">return</span> <span class="n">candidates</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-902"><a href="#MSPeakCalculation.molecular_formula_air_filter-902"><span class="linenos">902</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.molecular_formula_air_filter-903"><a href="#MSPeakCalculation.molecular_formula_air_filter-903"><span class="linenos">903</span></a>            <span class="k">return</span> <span class="n">candidates</span>
</span></pre></div>


            <div class="docstring"><p>Filter molecular formula using the 'Air' filter</p>

<p>This function applies the Formularity-esque 'Air' filter to possible molecular formula assignments.
Air Filter:
    O &gt; 0 AND N &lt;= 3 AND S &lt;= 1 AND P = 0 AND 3(S+N) &lt;= O</p>

<p>If the lowest_error method is also used, it will return the single formula annotation with the smallest absolute error which also fits the Air filter.
Otherwise, it will return all Air-filter compliant formulas.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>lowest_error</strong> (bool, optional):
Return only the lowest error formula which also fits the Air filter.
If False, return all Air-filter compliant formulas. Defaults to True.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list</strong>: List of molecular formula objects which fit the Air filter</li>
</ul>

<h6 id="references">References</h6>

<ol>
<li>Nikola Tolic et al., "Formularity: Software for Automated Formula Assignment of Natural and Other Organic Matter from Ultrahigh-Resolution Mass Spectra"
Anal. Chem. 2017, 89, 23, 12659–12665
doi: 10.1021/acs.analchem.7b03318</li>
</ol>
</div>


                            </div>
                            <div id="MSPeakCalculation.cia_score_S_P_error" class="classattr">
                                        <input id="MSPeakCalculation.cia_score_S_P_error-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cia_score_S_P_error</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.cia_score_S_P_error-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.cia_score_S_P_error"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.cia_score_S_P_error-905"><a href="#MSPeakCalculation.cia_score_S_P_error-905"><span class="linenos">905</span></a>    <span class="k">def</span> <span class="nf">cia_score_S_P_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-906"><a href="#MSPeakCalculation.cia_score_S_P_error-906"><span class="linenos">906</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compound Identification Algorithm SP Error - Assignment Filter</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-907"><a href="#MSPeakCalculation.cia_score_S_P_error-907"><span class="linenos">907</span></a>
</span><span id="MSPeakCalculation.cia_score_S_P_error-908"><a href="#MSPeakCalculation.cia_score_S_P_error-908"><span class="linenos">908</span></a><span class="sd">        This function applies the Compound Identification Algorithm (CIA) SP Error filter to possible molecular formula assignments.</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-909"><a href="#MSPeakCalculation.cia_score_S_P_error-909"><span class="linenos">909</span></a>
</span><span id="MSPeakCalculation.cia_score_S_P_error-910"><a href="#MSPeakCalculation.cia_score_S_P_error-910"><span class="linenos">910</span></a><span class="sd">        It takes the molecular formula with the lowest S+P count, and returns the formula with the lowest absolute error from this subset.</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-911"><a href="#MSPeakCalculation.cia_score_S_P_error-911"><span class="linenos">911</span></a>
</span><span id="MSPeakCalculation.cia_score_S_P_error-912"><a href="#MSPeakCalculation.cia_score_S_P_error-912"><span class="linenos">912</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-913"><a href="#MSPeakCalculation.cia_score_S_P_error-913"><span class="linenos">913</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-914"><a href="#MSPeakCalculation.cia_score_S_P_error-914"><span class="linenos">914</span></a><span class="sd">        MolecularFormula</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-915"><a href="#MSPeakCalculation.cia_score_S_P_error-915"><span class="linenos">915</span></a><span class="sd">            A single molecular formula which fits the rules of the CIA SP Error filter</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-916"><a href="#MSPeakCalculation.cia_score_S_P_error-916"><span class="linenos">916</span></a>
</span><span id="MSPeakCalculation.cia_score_S_P_error-917"><a href="#MSPeakCalculation.cia_score_S_P_error-917"><span class="linenos">917</span></a>
</span><span id="MSPeakCalculation.cia_score_S_P_error-918"><a href="#MSPeakCalculation.cia_score_S_P_error-918"><span class="linenos">918</span></a><span class="sd">        References</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-919"><a href="#MSPeakCalculation.cia_score_S_P_error-919"><span class="linenos">919</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-920"><a href="#MSPeakCalculation.cia_score_S_P_error-920"><span class="linenos">920</span></a><span class="sd">        1. Elizabeth B. Kujawinski and Mark D. Behn, &quot;Automated Analysis of Electrospray Ionization Fourier Transform Ion Cyclotron Resonance Mass Spectra of Natural Organic Matter&quot;</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-921"><a href="#MSPeakCalculation.cia_score_S_P_error-921"><span class="linenos">921</span></a><span class="sd">            Anal. Chem. 2006, 78, 13, 4363–4373</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-922"><a href="#MSPeakCalculation.cia_score_S_P_error-922"><span class="linenos">922</span></a><span class="sd">            doi: 10.1021/ac0600306</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-923"><a href="#MSPeakCalculation.cia_score_S_P_error-923"><span class="linenos">923</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-924"><a href="#MSPeakCalculation.cia_score_S_P_error-924"><span class="linenos">924</span></a>        <span class="c1"># case EFormulaScore.HAcap:</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-925"><a href="#MSPeakCalculation.cia_score_S_P_error-925"><span class="linenos">925</span></a>
</span><span id="MSPeakCalculation.cia_score_S_P_error-926"><a href="#MSPeakCalculation.cia_score_S_P_error-926"><span class="linenos">926</span></a>        <span class="n">lowest_S_P_mf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-927"><a href="#MSPeakCalculation.cia_score_S_P_error-927"><span class="linenos">927</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-928"><a href="#MSPeakCalculation.cia_score_S_P_error-928"><span class="linenos">928</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-929"><a href="#MSPeakCalculation.cia_score_S_P_error-929"><span class="linenos">929</span></a>        <span class="n">lowest_S_P_count</span> <span class="o">=</span> <span class="n">lowest_S_P_mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">lowest_S_P_mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-930"><a href="#MSPeakCalculation.cia_score_S_P_error-930"><span class="linenos">930</span></a>
</span><span id="MSPeakCalculation.cia_score_S_P_error-931"><a href="#MSPeakCalculation.cia_score_S_P_error-931"><span class="linenos">931</span></a>        <span class="n">list_same_s_p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-932"><a href="#MSPeakCalculation.cia_score_S_P_error-932"><span class="linenos">932</span></a>            <span class="nb">filter</span><span class="p">(</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-933"><a href="#MSPeakCalculation.cia_score_S_P_error-933"><span class="linenos">933</span></a>                <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">lowest_S_P_count</span><span class="p">,</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-934"><a href="#MSPeakCalculation.cia_score_S_P_error-934"><span class="linenos">934</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-935"><a href="#MSPeakCalculation.cia_score_S_P_error-935"><span class="linenos">935</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-936"><a href="#MSPeakCalculation.cia_score_S_P_error-936"><span class="linenos">936</span></a>        <span class="p">)</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-937"><a href="#MSPeakCalculation.cia_score_S_P_error-937"><span class="linenos">937</span></a>
</span><span id="MSPeakCalculation.cia_score_S_P_error-938"><a href="#MSPeakCalculation.cia_score_S_P_error-938"><span class="linenos">938</span></a>        <span class="c1"># check if list is not empty</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-939"><a href="#MSPeakCalculation.cia_score_S_P_error-939"><span class="linenos">939</span></a>        <span class="k">if</span> <span class="n">list_same_s_p</span><span class="p">:</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-940"><a href="#MSPeakCalculation.cia_score_S_P_error-940"><span class="linenos">940</span></a>            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">list_same_s_p</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-941"><a href="#MSPeakCalculation.cia_score_S_P_error-941"><span class="linenos">941</span></a>
</span><span id="MSPeakCalculation.cia_score_S_P_error-942"><a href="#MSPeakCalculation.cia_score_S_P_error-942"><span class="linenos">942</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.cia_score_S_P_error-943"><a href="#MSPeakCalculation.cia_score_S_P_error-943"><span class="linenos">943</span></a>            <span class="k">return</span> <span class="n">lowest_S_P_mf</span>
</span></pre></div>


            <div class="docstring"><p>Compound Identification Algorithm SP Error - Assignment Filter</p>

<p>This function applies the Compound Identification Algorithm (CIA) SP Error filter to possible molecular formula assignments.</p>

<p>It takes the molecular formula with the lowest S+P count, and returns the formula with the lowest absolute error from this subset.</p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>MolecularFormula</strong>: A single molecular formula which fits the rules of the CIA SP Error filter</li>
</ul>

<h6 id="references">References</h6>

<ol>
<li>Elizabeth B. Kujawinski and Mark D. Behn, "Automated Analysis of Electrospray Ionization Fourier Transform Ion Cyclotron Resonance Mass Spectra of Natural Organic Matter"
Anal. Chem. 2006, 78, 13, 4363–4373
doi: 10.1021/ac0600306</li>
</ol>
</div>


                            </div>
                            <div id="MSPeakCalculation.cia_score_N_S_P_error" class="classattr">
                                        <input id="MSPeakCalculation.cia_score_N_S_P_error-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cia_score_N_S_P_error</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MSPeakCalculation.cia_score_N_S_P_error-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MSPeakCalculation.cia_score_N_S_P_error"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MSPeakCalculation.cia_score_N_S_P_error-945"><a href="#MSPeakCalculation.cia_score_N_S_P_error-945"><span class="linenos"> 945</span></a>    <span class="k">def</span> <span class="nf">cia_score_N_S_P_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-946"><a href="#MSPeakCalculation.cia_score_N_S_P_error-946"><span class="linenos"> 946</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compound Identification Algorithm NSP Error - Assignment Filter</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-947"><a href="#MSPeakCalculation.cia_score_N_S_P_error-947"><span class="linenos"> 947</span></a>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-948"><a href="#MSPeakCalculation.cia_score_N_S_P_error-948"><span class="linenos"> 948</span></a><span class="sd">        This function applies the Compound Identification Algorithm (CIA) NSP Error filter to possible molecular formula assignments.</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-949"><a href="#MSPeakCalculation.cia_score_N_S_P_error-949"><span class="linenos"> 949</span></a>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-950"><a href="#MSPeakCalculation.cia_score_N_S_P_error-950"><span class="linenos"> 950</span></a><span class="sd">        It takes the molecular formula with the lowest N+S+P count, and returns the formula with the lowest absolute error from this subset.</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-951"><a href="#MSPeakCalculation.cia_score_N_S_P_error-951"><span class="linenos"> 951</span></a>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-952"><a href="#MSPeakCalculation.cia_score_N_S_P_error-952"><span class="linenos"> 952</span></a><span class="sd">        Returns</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-953"><a href="#MSPeakCalculation.cia_score_N_S_P_error-953"><span class="linenos"> 953</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-954"><a href="#MSPeakCalculation.cia_score_N_S_P_error-954"><span class="linenos"> 954</span></a><span class="sd">        MolecularFormula</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-955"><a href="#MSPeakCalculation.cia_score_N_S_P_error-955"><span class="linenos"> 955</span></a><span class="sd">            A single molecular formula which fits the rules of the CIA NSP Error filter</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-956"><a href="#MSPeakCalculation.cia_score_N_S_P_error-956"><span class="linenos"> 956</span></a>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-957"><a href="#MSPeakCalculation.cia_score_N_S_P_error-957"><span class="linenos"> 957</span></a><span class="sd">        References</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-958"><a href="#MSPeakCalculation.cia_score_N_S_P_error-958"><span class="linenos"> 958</span></a><span class="sd">        ----------</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-959"><a href="#MSPeakCalculation.cia_score_N_S_P_error-959"><span class="linenos"> 959</span></a><span class="sd">        1. Elizabeth B. Kujawinski and Mark D. Behn, &quot;Automated Analysis of Electrospray Ionization Fourier Transform Ion Cyclotron Resonance Mass Spectra of Natural Organic Matter&quot;</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-960"><a href="#MSPeakCalculation.cia_score_N_S_P_error-960"><span class="linenos"> 960</span></a><span class="sd">            Anal. Chem. 2006, 78, 13, 4363–4373</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-961"><a href="#MSPeakCalculation.cia_score_N_S_P_error-961"><span class="linenos"> 961</span></a><span class="sd">            doi: 10.1021/ac0600306</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-962"><a href="#MSPeakCalculation.cia_score_N_S_P_error-962"><span class="linenos"> 962</span></a>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-963"><a href="#MSPeakCalculation.cia_score_N_S_P_error-963"><span class="linenos"> 963</span></a><span class="sd">        Raises</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-964"><a href="#MSPeakCalculation.cia_score_N_S_P_error-964"><span class="linenos"> 964</span></a><span class="sd">        -------</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-965"><a href="#MSPeakCalculation.cia_score_N_S_P_error-965"><span class="linenos"> 965</span></a><span class="sd">        Exception</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-966"><a href="#MSPeakCalculation.cia_score_N_S_P_error-966"><span class="linenos"> 966</span></a><span class="sd">            If no molecular formula are associated with mass spectrum peak.</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-967"><a href="#MSPeakCalculation.cia_score_N_S_P_error-967"><span class="linenos"> 967</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-968"><a href="#MSPeakCalculation.cia_score_N_S_P_error-968"><span class="linenos"> 968</span></a>        <span class="c1"># case EFormulaScore.HAcap:</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-969"><a href="#MSPeakCalculation.cia_score_N_S_P_error-969"><span class="linenos"> 969</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">:</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-970"><a href="#MSPeakCalculation.cia_score_N_S_P_error-970"><span class="linenos"> 970</span></a>            <span class="n">lowest_N_S_P_mf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-971"><a href="#MSPeakCalculation.cia_score_N_S_P_error-971"><span class="linenos"> 971</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-972"><a href="#MSPeakCalculation.cia_score_N_S_P_error-972"><span class="linenos"> 972</span></a>                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">),</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-973"><a href="#MSPeakCalculation.cia_score_N_S_P_error-973"><span class="linenos"> 973</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-974"><a href="#MSPeakCalculation.cia_score_N_S_P_error-974"><span class="linenos"> 974</span></a>            <span class="n">lowest_N_S_P_count</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-975"><a href="#MSPeakCalculation.cia_score_N_S_P_error-975"><span class="linenos"> 975</span></a>                <span class="n">lowest_N_S_P_mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-976"><a href="#MSPeakCalculation.cia_score_N_S_P_error-976"><span class="linenos"> 976</span></a>                <span class="o">+</span> <span class="n">lowest_N_S_P_mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-977"><a href="#MSPeakCalculation.cia_score_N_S_P_error-977"><span class="linenos"> 977</span></a>                <span class="o">+</span> <span class="n">lowest_N_S_P_mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-978"><a href="#MSPeakCalculation.cia_score_N_S_P_error-978"><span class="linenos"> 978</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-979"><a href="#MSPeakCalculation.cia_score_N_S_P_error-979"><span class="linenos"> 979</span></a>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-980"><a href="#MSPeakCalculation.cia_score_N_S_P_error-980"><span class="linenos"> 980</span></a>            <span class="n">list_same_N_S_P</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-981"><a href="#MSPeakCalculation.cia_score_N_S_P_error-981"><span class="linenos"> 981</span></a>                <span class="nb">filter</span><span class="p">(</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-982"><a href="#MSPeakCalculation.cia_score_N_S_P_error-982"><span class="linenos"> 982</span></a>                    <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-983"><a href="#MSPeakCalculation.cia_score_N_S_P_error-983"><span class="linenos"> 983</span></a>                    <span class="o">==</span> <span class="n">lowest_N_S_P_count</span><span class="p">,</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-984"><a href="#MSPeakCalculation.cia_score_N_S_P_error-984"><span class="linenos"> 984</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">molecular_formulas</span><span class="p">,</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-985"><a href="#MSPeakCalculation.cia_score_N_S_P_error-985"><span class="linenos"> 985</span></a>                <span class="p">)</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-986"><a href="#MSPeakCalculation.cia_score_N_S_P_error-986"><span class="linenos"> 986</span></a>            <span class="p">)</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-987"><a href="#MSPeakCalculation.cia_score_N_S_P_error-987"><span class="linenos"> 987</span></a>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-988"><a href="#MSPeakCalculation.cia_score_N_S_P_error-988"><span class="linenos"> 988</span></a>            <span class="k">if</span> <span class="n">list_same_N_S_P</span><span class="p">:</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-989"><a href="#MSPeakCalculation.cia_score_N_S_P_error-989"><span class="linenos"> 989</span></a>                <span class="n">SP_filtered_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-990"><a href="#MSPeakCalculation.cia_score_N_S_P_error-990"><span class="linenos"> 990</span></a>                    <span class="nb">filter</span><span class="p">(</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-991"><a href="#MSPeakCalculation.cia_score_N_S_P_error-991"><span class="linenos"> 991</span></a>                        <span class="k">lambda</span> <span class="n">mf</span><span class="p">:</span> <span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">),</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-992"><a href="#MSPeakCalculation.cia_score_N_S_P_error-992"><span class="linenos"> 992</span></a>                        <span class="n">list_same_N_S_P</span><span class="p">,</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-993"><a href="#MSPeakCalculation.cia_score_N_S_P_error-993"><span class="linenos"> 993</span></a>                    <span class="p">)</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-994"><a href="#MSPeakCalculation.cia_score_N_S_P_error-994"><span class="linenos"> 994</span></a>                <span class="p">)</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-995"><a href="#MSPeakCalculation.cia_score_N_S_P_error-995"><span class="linenos"> 995</span></a>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-996"><a href="#MSPeakCalculation.cia_score_N_S_P_error-996"><span class="linenos"> 996</span></a>                <span class="k">if</span> <span class="n">SP_filtered_list</span><span class="p">:</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-997"><a href="#MSPeakCalculation.cia_score_N_S_P_error-997"><span class="linenos"> 997</span></a>                    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">SP_filtered_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-998"><a href="#MSPeakCalculation.cia_score_N_S_P_error-998"><span class="linenos"> 998</span></a>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-999"><a href="#MSPeakCalculation.cia_score_N_S_P_error-999"><span class="linenos"> 999</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-1000"><a href="#MSPeakCalculation.cia_score_N_S_P_error-1000"><span class="linenos">1000</span></a>                    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">list_same_N_S_P</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">mz_error</span><span class="p">))</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-1001"><a href="#MSPeakCalculation.cia_score_N_S_P_error-1001"><span class="linenos">1001</span></a>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-1002"><a href="#MSPeakCalculation.cia_score_N_S_P_error-1002"><span class="linenos">1002</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-1003"><a href="#MSPeakCalculation.cia_score_N_S_P_error-1003"><span class="linenos">1003</span></a>                <span class="k">return</span> <span class="n">lowest_N_S_P_mf</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-1004"><a href="#MSPeakCalculation.cia_score_N_S_P_error-1004"><span class="linenos">1004</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-1005"><a href="#MSPeakCalculation.cia_score_N_S_P_error-1005"><span class="linenos">1005</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-1006"><a href="#MSPeakCalculation.cia_score_N_S_P_error-1006"><span class="linenos">1006</span></a>                <span class="s2">&quot;No molecular formula associated with the mass spectrum peak at m/z: </span><span class="si">%.6f</span><span class="s2">&quot;</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-1007"><a href="#MSPeakCalculation.cia_score_N_S_P_error-1007"><span class="linenos">1007</span></a>                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz_exp</span>
</span><span id="MSPeakCalculation.cia_score_N_S_P_error-1008"><a href="#MSPeakCalculation.cia_score_N_S_P_error-1008"><span class="linenos">1008</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compound Identification Algorithm NSP Error - Assignment Filter</p>

<p>This function applies the Compound Identification Algorithm (CIA) NSP Error filter to possible molecular formula assignments.</p>

<p>It takes the molecular formula with the lowest N+S+P count, and returns the formula with the lowest absolute error from this subset.</p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>MolecularFormula</strong>: A single molecular formula which fits the rules of the CIA NSP Error filter</li>
</ul>

<h6 id="references">References</h6>

<ol>
<li>Elizabeth B. Kujawinski and Mark D. Behn, "Automated Analysis of Electrospray Ionization Fourier Transform Ion Cyclotron Resonance Mass Spectra of Natural Organic Matter"
Anal. Chem. 2006, 78, 13, 4363–4373
doi: 10.1021/ac0600306</li>
</ol>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>Exception</strong>: If no molecular formula are associated with mass spectrum peak.</li>
</ul>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>