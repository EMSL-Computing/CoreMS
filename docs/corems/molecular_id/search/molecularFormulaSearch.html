<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.1.0"/>
    <title>corems.molecular_id.search.molecularFormulaSearch API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../search.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;corems.molecular_id.search</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#last_error">last_error</a>
            </li>
            <li>
                    <a class="variable" href="#last_dif">last_dif</a>
            </li>
            <li>
                    <a class="variable" href="#closest_error">closest_error</a>
            </li>
            <li>
                    <a class="variable" href="#error_average">error_average</a>
            </li>
            <li>
                    <a class="variable" href="#nbValues">nbValues</a>
            </li>
            <li>
                    <a class="class" href="#SearchMolecularFormulas">SearchMolecularFormulas</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SearchMolecularFormulas.__init__">SearchMolecularFormulas</a>
                        </li>
                        <li>
                                <a class="variable" href="#SearchMolecularFormulas.first_hit">first_hit</a>
                        </li>
                        <li>
                                <a class="variable" href="#SearchMolecularFormulas.find_isotopologues">find_isotopologues</a>
                        </li>
                        <li>
                                <a class="variable" href="#SearchMolecularFormulas.mass_spectrum_obj">mass_spectrum_obj</a>
                        </li>
                        <li>
                                <a class="function" href="#SearchMolecularFormulas.run_search">run_search</a>
                        </li>
                        <li>
                                <a class="function" href="#SearchMolecularFormulas.run_worker_mass_spectrum">run_worker_mass_spectrum</a>
                        </li>
                        <li>
                                <a class="function" href="#SearchMolecularFormulas.run_worker_ms_peaks">run_worker_ms_peaks</a>
                        </li>
                        <li>
                                <a class="function" href="#SearchMolecularFormulas.database_to_dict">database_to_dict</a>
                        </li>
                        <li>
                                <a class="function" href="#SearchMolecularFormulas.run_molecular_formula">run_molecular_formula</a>
                        </li>
                        <li>
                                <a class="function" href="#SearchMolecularFormulas.search_mol_formulas">search_mol_formulas</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SearchMolecularFormulaWorker">SearchMolecularFormulaWorker</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SearchMolecularFormulaWorker.__init__">SearchMolecularFormulaWorker</a>
                        </li>
                        <li>
                                <a class="variable" href="#SearchMolecularFormulaWorker.find_isotopologues">find_isotopologues</a>
                        </li>
                        <li>
                                <a class="function" href="#SearchMolecularFormulaWorker.reset_error">reset_error</a>
                        </li>
                        <li>
                                <a class="function" href="#SearchMolecularFormulaWorker.set_last_error">set_last_error</a>
                        </li>
                        <li>
                                <a class="function" href="#SearchMolecularFormulaWorker.calc_error">calc_error</a>
                        </li>
                        <li>
                                <a class="function" href="#SearchMolecularFormulaWorker.find_formulas">find_formulas</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SearchMolecularFormulasLC">SearchMolecularFormulasLC</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SearchMolecularFormulasLC.__init__">SearchMolecularFormulasLC</a>
                        </li>
                        <li>
                                <a class="variable" href="#SearchMolecularFormulasLC.first_hit">first_hit</a>
                        </li>
                        <li>
                                <a class="variable" href="#SearchMolecularFormulasLC.find_isotopologues">find_isotopologues</a>
                        </li>
                        <li>
                                <a class="variable" href="#SearchMolecularFormulasLC.lcms_obj">lcms_obj</a>
                        </li>
                        <li>
                                <a class="function" href="#SearchMolecularFormulasLC.search_spectra_against_candidates">search_spectra_against_candidates</a>
                        </li>
                        <li>
                                <a class="function" href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search">bulk_run_molecular_formula_search</a>
                        </li>
                        <li>
                                <a class="function" href="#SearchMolecularFormulasLC.run_mass_feature_search">run_mass_feature_search</a>
                        </li>
                        <li>
                                <a class="function" href="#SearchMolecularFormulasLC.run_untargeted_worker_ms1">run_untargeted_worker_ms1</a>
                        </li>
                        <li>
                                <a class="function" href="#SearchMolecularFormulasLC.run_target_worker_ms1">run_target_worker_ms1</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../../corems.html">corems</a><wbr>.<a href="./../../molecular_id.html">molecular_id</a><wbr>.<a href="./../search.html">search</a><wbr>.molecularFormulaSearch    </h1>

                
                        <input id="mod-molecularFormulaSearch-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-molecularFormulaSearch-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Yuri E. Corilo&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;Jul 29, 2019&quot;</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">import</span> <span class="nn">tqdm</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">from</span> <span class="nn">corems</span> <span class="kn">import</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">timeit</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">from</span> <span class="nn">corems.encapsulation.constant</span> <span class="kn">import</span> <span class="n">Labels</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">from</span> <span class="nn">corems.molecular_formula.factory.MolecularFormulaFactory</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a>    <span class="n">LCMSLibRefMolecularFormula</span><span class="p">,</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a>    <span class="n">MolecularFormula</span><span class="p">,</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="p">)</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="kn">from</span> <span class="nn">corems.molecular_id.factory.MolecularLookupTable</span> <span class="kn">import</span> <span class="n">MolecularCombinations</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">from</span> <span class="nn">corems.molecular_id.factory.molecularSQL</span> <span class="kn">import</span> <span class="n">MolForm_SQL</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">from</span> <span class="nn">corems.ms_peak.factory.MSPeakClasses</span> <span class="kn">import</span> <span class="n">_MSPeak</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="n">last_error</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="n">last_dif</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="n">closest_error</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="n">error_average</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="n">nbValues</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="k">class</span> <span class="nc">SearchMolecularFormulas</span><span class="p">:</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for searching molecular formulas in a mass spectrum.</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="sd">    Parameters</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="sd">    ----------</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="sd">    mass_spectrum_obj : MassSpectrum</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">        The mass spectrum object.</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="sd">    sql_db : MolForm_SQL, optional</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="sd">        The SQL database object, by default None.</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="sd">    first_hit : bool, optional</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="sd">        Flag to indicate whether to skip peaks that already have a molecular formula assigned, by default False.</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="sd">    find_isotopologues : bool, optional</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="sd">        Flag to indicate whether to find isotopologues, by default True.</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="sd">    Attributes</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="sd">    ----------</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="sd">    mass_spectrum_obj : MassSpectrum</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="sd">        The mass spectrum object.</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="sd">    sql_db : MolForm_SQL</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="sd">        The SQL database object.</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="sd">    first_hit : bool</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="sd">        Flag to indicate whether to skip peaks that already have a molecular formula assigned.</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="sd">    find_isotopologues : bool</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="sd">        Flag to indicate whether to find isotopologues.</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">    Methods</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="sd">    -------</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">    * run_search().</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">        Run the molecular formula search.</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="sd">    * run_worker_mass_spectrum().</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd">        Run the molecular formula search on the mass spectrum object.</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="sd">    * run_worker_ms_peaks().</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="sd">        Run the molecular formula search on the given list of mass spectrum peaks.</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="sd">    * database_to_dict().</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">        Convert the database results to a dictionary.</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="sd">    * run_molecular_formula().</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="sd">        Run the molecular formula search on the given list of mass spectrum peaks.</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="sd">    * search_mol_formulas().</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="sd">        Search for molecular formulas in the mass spectrum.</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>        <span class="n">mass_spectrum_obj</span><span class="p">,</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>        <span class="n">sql_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>        <span class="n">first_hit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>        <span class="n">find_isotopologues</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>    <span class="p">):</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">first_hit</span> <span class="o">=</span> <span class="n">first_hit</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span> <span class="o">=</span> <span class="n">find_isotopologues</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span> <span class="o">=</span> <span class="n">mass_spectrum_obj</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sql_db</span><span class="p">:</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span> <span class="o">=</span> <span class="n">MolForm_SQL</span><span class="p">(</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>                <span class="n">url</span><span class="o">=</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">url_database</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>            <span class="p">)</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span> <span class="o">=</span> <span class="n">sql_db</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Open the SQL database connection.&quot;&quot;&quot;</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the SQL database connection.&quot;&quot;&quot;</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>    <span class="k">def</span> <span class="nf">run_search</span><span class="p">(</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>        <span class="n">mspeaks</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>        <span class="n">min_abundance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>        <span class="n">ion_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>        <span class="n">ion_charge</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>        <span class="n">adduct_atom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>    <span class="p">):</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the molecular formula search.</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="sd">        Parameters</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="sd">        ----------</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a><span class="sd">        mspeaks : list of MSPeak</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="sd">            The list of mass spectrum peaks.</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a><span class="sd">        query : dict</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a><span class="sd">            The query dictionary containing the possible molecular formulas.</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a><span class="sd">        min_abundance : float</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a><span class="sd">            The minimum abundance threshold.</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a><span class="sd">        ion_type : str</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a><span class="sd">            The ion type.</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a><span class="sd">        ion_charge : int</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a><span class="sd">            The ion charge.</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a><span class="sd">        adduct_atom : str, optional</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a><span class="sd">            The adduct atom, by default None.</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>        <span class="k">def</span> <span class="nf">get_formulas</span><span class="p">(</span><span class="n">nominal_overlay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a><span class="sd">            Get the list of formulas based on the nominal overlay.</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="sd">            Parameters</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="sd">            ----------</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a><span class="sd">            nominal_overlay : float, optional</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a><span class="sd">                The nominal overlay, by default 0.1.</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a><span class="sd">            Returns</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="sd">            -------</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">            list</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="sd">                The list of formulas.</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>            <span class="n">nominal_mz</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">nominal_mz_exp</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>            <span class="n">defect_mass</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">-</span> <span class="n">nominal_mz</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>            <span class="n">nominal_masses</span> <span class="o">=</span> <span class="p">[</span><span class="n">nominal_mz</span><span class="p">]</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">defect_mass</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">nominal_overlay</span><span class="p">:</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>                <span class="n">nominal_masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nominal_mz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>            <span class="k">elif</span> <span class="p">(</span><span class="n">defect_mass</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">nominal_overlay</span><span class="p">:</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>                <span class="n">nominal_masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nominal_mz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>            <span class="n">list_formulas_candidates</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>            <span class="k">for</span> <span class="n">nominal_mass</span> <span class="ow">in</span> <span class="n">nominal_masses</span><span class="p">:</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>                <span class="k">if</span> <span class="n">nominal_mass</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>                    <span class="n">list_formulas_candidates</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nominal_mass</span><span class="p">))</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>            <span class="k">return</span> <span class="n">list_formulas_candidates</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>        <span class="n">all_assigned_indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>        <span class="c1"># molecular_search_settings = self.mass_spectrum_obj.molecular_search_settings</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>        <span class="n">search_molfrom</span> <span class="o">=</span> <span class="n">SearchMolecularFormulaWorker</span><span class="p">(</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>            <span class="n">find_isotopologues</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>        <span class="p">)</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>        <span class="k">for</span> <span class="n">ms_peak</span> <span class="ow">in</span> <span class="n">mspeaks</span><span class="p">:</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>            <span class="c1"># already assigned a molecular formula</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_hit</span><span class="p">:</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>                <span class="k">if</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">is_assigned</span><span class="p">:</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>                    <span class="k">continue</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>            <span class="n">ms_peak_indexes</span> <span class="o">=</span> <span class="n">search_molfrom</span><span class="o">.</span><span class="n">find_formulas</span><span class="p">(</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>                <span class="n">get_formulas</span><span class="p">(),</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>                <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="p">,</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>                <span class="n">ms_peak</span><span class="p">,</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>                <span class="n">ion_type</span><span class="p">,</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>                <span class="n">adduct_atom</span><span class="p">,</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>            <span class="p">)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>            <span class="n">all_assigned_indexes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ms_peak_indexes</span><span class="p">)</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>        <span class="c1"># all_assigned_indexes = MolecularFormulaSearchFilters().filter_isotopologue(all_assigned_indexes, self.mass_spectrum_obj)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>        <span class="c1"># all_assigned_indexes = MolecularFormulaSearchFilters().filter_kendrick(all_assigned_indexes, self.mass_spectrum_obj)</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>        <span class="c1"># MolecularFormulaSearchFilters().check_min_peaks(all_assigned_indexes, self.mass_spectrum_obj)</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>        <span class="c1"># filter per min peaks per mono isotopic class</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>    <span class="k">def</span> <span class="nf">run_worker_mass_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the molecular formula search on the mass spectrum object.&quot;&quot;&quot;</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_molecular_formula</span><span class="p">(</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">sort_by_abundance</span><span class="p">(),</span> 
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>            <span class="n">print_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>            <span class="p">)</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>    <span class="k">def</span> <span class="nf">run_worker_ms_peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms_peaks</span><span class="p">):</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the molecular formula search on the given list of mass spectrum peaks.</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a><span class="sd">        Parameters</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a><span class="sd">        ----------</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a><span class="sd">        ms_peaks : list of MSPeak</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a><span class="sd">            The list of mass spectrum peaks.</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_molecular_formula</span><span class="p">(</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>            <span class="n">ms_peaks</span><span class="p">,</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>            <span class="n">print_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>        <span class="p">)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>    <span class="k">def</span> <span class="nf">database_to_dict</span><span class="p">(</span><span class="n">classe_str_list</span><span class="p">,</span> <span class="n">nominal_mzs</span><span class="p">,</span> <span class="n">mf_search_settings</span><span class="p">,</span> <span class="n">ion_charge</span><span class="p">):</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert the database results to a dictionary.</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a><span class="sd">        Parameters</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a><span class="sd">        ----------</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a><span class="sd">        classe_str_list : list</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a><span class="sd">            The list of class strings.</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a><span class="sd">        nominal_mzs : list</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a><span class="sd">            The list of nominal m/z values.</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a><span class="sd">        mf_search_settings : MolecularFormulaSearchSettings</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a><span class="sd">            The molecular formula search settings.</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a><span class="sd">        ion_charge : int</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a><span class="sd">            The ion charge.</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a><span class="sd">        Returns</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a><span class="sd">        -------</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a><span class="sd">        dict</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a><span class="sd">            The dictionary containing the database results.</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>        <span class="n">sql_db</span> <span class="o">=</span> <span class="n">MolForm_SQL</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">mf_search_settings</span><span class="o">.</span><span class="n">url_database</span><span class="p">)</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>        <span class="n">dict_res</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>        <span class="k">if</span> <span class="n">mf_search_settings</span><span class="o">.</span><span class="n">isProtonated</span><span class="p">:</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>            <span class="n">dict_res</span><span class="p">[</span><span class="n">Labels</span><span class="o">.</span><span class="n">protonated_de_ion</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql_db</span><span class="o">.</span><span class="n">get_dict_by_classes</span><span class="p">(</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>                <span class="n">classe_str_list</span><span class="p">,</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>                <span class="n">Labels</span><span class="o">.</span><span class="n">protonated_de_ion</span><span class="p">,</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>                <span class="n">nominal_mzs</span><span class="p">,</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>                <span class="n">mf_search_settings</span><span class="p">,</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>            <span class="p">)</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>        <span class="k">if</span> <span class="n">mf_search_settings</span><span class="o">.</span><span class="n">isRadical</span><span class="p">:</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>            <span class="n">dict_res</span><span class="p">[</span><span class="n">Labels</span><span class="o">.</span><span class="n">radical_ion</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql_db</span><span class="o">.</span><span class="n">get_dict_by_classes</span><span class="p">(</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>                <span class="n">classe_str_list</span><span class="p">,</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>                <span class="n">Labels</span><span class="o">.</span><span class="n">radical_ion</span><span class="p">,</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>                <span class="n">nominal_mzs</span><span class="p">,</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>                <span class="n">mf_search_settings</span><span class="p">,</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>            <span class="p">)</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>        <span class="k">if</span> <span class="n">mf_search_settings</span><span class="o">.</span><span class="n">isAdduct</span><span class="p">:</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>            <span class="n">adduct_list</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>                <span class="n">mf_search_settings</span><span class="o">.</span><span class="n">adduct_atoms_neg</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>                <span class="k">if</span> <span class="n">ion_charge</span> <span class="o">&lt;</span> <span class="mi">0</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>                <span class="k">else</span> <span class="n">mf_search_settings</span><span class="o">.</span><span class="n">adduct_atoms_pos</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>            <span class="p">)</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>            <span class="n">dict_res</span><span class="p">[</span><span class="n">Labels</span><span class="o">.</span><span class="n">adduct_ion</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql_db</span><span class="o">.</span><span class="n">get_dict_by_classes</span><span class="p">(</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>                <span class="n">classe_str_list</span><span class="p">,</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>                <span class="n">Labels</span><span class="o">.</span><span class="n">adduct_ion</span><span class="p">,</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>                <span class="n">nominal_mzs</span><span class="p">,</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>                <span class="n">mf_search_settings</span><span class="p">,</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>                <span class="n">adducts</span><span class="o">=</span><span class="n">adduct_list</span><span class="p">,</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>            <span class="p">)</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>        <span class="k">return</span> <span class="n">dict_res</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>    <span class="nd">@timeit</span><span class="p">(</span><span class="n">print_time</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>    <span class="k">def</span> <span class="nf">run_molecular_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms_peaks</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the molecular formula search on the given list of mass spectrum peaks.</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a><span class="sd">        Parameters</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a><span class="sd">        ----------</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a><span class="sd">        ms_peaks : list of MSPeak</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a><span class="sd">            The list of mass spectrum peaks.</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a><span class="sd">        **kwargs</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a><span class="sd">            Additional keyword arguments. </span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a><span class="sd">            Most notably, print_time, which is a boolean flag to indicate whether to print the time </span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a><span class="sd">            and passed to the timeit decorator.</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>        <span class="n">ion_charge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">polarity</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>        <span class="n">min_abundance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">min_abundance</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>        <span class="n">nominal_mzs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">nominal_mz</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>        <span class="c1"># reset average error, only relevant is average mass error method is being used</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>        <span class="n">SearchMolecularFormulaWorker</span><span class="p">(</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>            <span class="n">find_isotopologues</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">reset_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="p">)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>        <span class="c1"># check database for all possible molecular formula combinations based on the setting passed to self.mass_spectrum_obj.molecular_search_settings</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>        <span class="n">classes</span> <span class="o">=</span> <span class="n">MolecularCombinations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="p">)</span><span class="o">.</span><span class="n">runworker</span><span class="p">(</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="p">,</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>            <span class="n">print_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>        <span class="p">)</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>        <span class="c1"># split the database load to not blowout the memory</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>        <span class="c1"># TODO add to the settings</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>        <span class="k">for</span> <span class="n">classe_chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">(</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>            <span class="n">classes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">db_chunk_size</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>        <span class="p">):</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>            <span class="n">classes_str_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">class_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">class_tuple</span> <span class="ow">in</span> <span class="n">classe_chunk</span><span class="p">]</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>            <span class="c1"># load the molecular formula objs binned by ion type and heteroatoms classes, {ion type:{classe:[list_formula]}}</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>            <span class="c1"># for adduct ion type a third key is added {atoms:{ion type:{classe:[list_formula]}}}</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>            <span class="n">dict_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_to_dict</span><span class="p">(</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>                <span class="n">classes_str_list</span><span class="p">,</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>                <span class="n">nominal_mzs</span><span class="p">,</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="p">,</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>            <span class="p">)</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">classe_chunk</span><span class="p">,</span> <span class="n">disable</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>            <span class="k">for</span> <span class="n">classe_tuple</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>                <span class="c1"># class string is a json serialized dict</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>                <span class="n">classe_str</span> <span class="o">=</span> <span class="n">classe_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>                <span class="n">classe_dict</span> <span class="o">=</span> <span class="n">classe_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">isProtonated</span><span class="p">:</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>                    <span class="n">ion_type</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">protonated_de_ion</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>                        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description_str</span><span class="p">(</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>                            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Started molecular formula search for class </span><span class="si">%s</span><span class="s2">, (de)protonated &quot;</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>                            <span class="o">%</span> <span class="n">classe_str</span><span class="p">,</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>                            <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>                        <span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>                    <span class="n">candidate_formulas</span> <span class="o">=</span> <span class="n">dict_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ion_type</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">classe_str</span><span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>                    <span class="k">if</span> <span class="n">candidate_formulas</span><span class="p">:</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">run_search</span><span class="p">(</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>                            <span class="n">ms_peaks</span><span class="p">,</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>                            <span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>                            <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>                            <span class="n">ion_type</span><span class="p">,</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>                            <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>                        <span class="p">)</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">isRadical</span><span class="p">:</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>                        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description_str</span><span class="p">(</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>                            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Started molecular formula search for class </span><span class="si">%s</span><span class="s2">, radical &quot;</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>                            <span class="o">%</span> <span class="n">classe_str</span><span class="p">,</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>                            <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>                        <span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>                    <span class="n">ion_type</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">radical_ion</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>                    <span class="n">candidate_formulas</span> <span class="o">=</span> <span class="n">dict_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ion_type</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">classe_str</span><span class="p">)</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>                    <span class="k">if</span> <span class="n">candidate_formulas</span><span class="p">:</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">run_search</span><span class="p">(</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>                            <span class="n">ms_peaks</span><span class="p">,</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>                            <span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>                            <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>                            <span class="n">ion_type</span><span class="p">,</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>                            <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>                        <span class="p">)</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>                <span class="c1"># looks for adduct, used_atom_valences should be 0</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>                <span class="c1"># this code does not support H exchance by halogen atoms</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">isAdduct</span><span class="p">:</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>                        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description_str</span><span class="p">(</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>                            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Started molecular formula search for class </span><span class="si">%s</span><span class="s2">, adduct &quot;</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>                            <span class="o">%</span> <span class="n">classe_str</span><span class="p">,</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>                            <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>                        <span class="p">)</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>                    <span class="n">ion_type</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">adduct_ion</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>                    <span class="n">dict_atoms_formulas</span> <span class="o">=</span> <span class="n">dict_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ion_type</span><span class="p">)</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>                    <span class="k">for</span> <span class="n">adduct_atom</span><span class="p">,</span> <span class="n">dict_by_class</span> <span class="ow">in</span> <span class="n">dict_atoms_formulas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>                        <span class="n">candidate_formulas</span> <span class="o">=</span> <span class="n">dict_by_class</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">classe_str</span><span class="p">)</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>                        <span class="k">if</span> <span class="n">candidate_formulas</span><span class="p">:</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">run_search</span><span class="p">(</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>                                <span class="n">ms_peaks</span><span class="p">,</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>                                <span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>                                <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>                                <span class="n">ion_type</span><span class="p">,</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>                                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>                                <span class="n">adduct_atom</span><span class="o">=</span><span class="n">adduct_atom</span><span class="p">,</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>                            <span class="p">)</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>    <span class="k">def</span> <span class="nf">search_mol_formulas</span><span class="p">(</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>        <span class="n">possible_formulas_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MolecularFormula</span><span class="p">],</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>        <span class="n">ion_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>        <span class="n">neutral_molform</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>        <span class="n">find_isotopologues</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>        <span class="n">adduct_atom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">_MSPeak</span><span class="p">]:</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Search for molecular formulas in the mass spectrum.</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a><span class="sd">        Parameters</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a><span class="sd">        ----------</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a><span class="sd">        possible_formulas_list : list of MolecularFormula</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a><span class="sd">            The list of possible molecular formulas.</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a><span class="sd">        ion_type : str</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a><span class="sd">            The ion type.</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a><span class="sd">        neutral_molform : bool, optional</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a><span class="sd">            Flag to indicate whether the molecular formulas are neutral, by default True.</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="sd">        find_isotopologues : bool, optional</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a><span class="sd">            Flag to indicate whether to find isotopologues, by default True.</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="sd">        adduct_atom : str, optional</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a><span class="sd">            The adduct atom, by default None.</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a><span class="sd">        Returns</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a><span class="sd">        -------</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a><span class="sd">        list of MSPeak</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a><span class="sd">            The list of mass spectrum peaks with assigned molecular formulas.</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>        <span class="c1"># neutral_molform: some reference files already present the formula on ion mode, for instance, bruker reference files</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>        <span class="c1">#    if that is the case than turn neutral_molform off</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>        <span class="n">SearchMolecularFormulaWorker</span><span class="p">(</span><span class="n">find_isotopologues</span><span class="o">=</span><span class="n">find_isotopologues</span><span class="p">)</span><span class="o">.</span><span class="n">reset_error</span><span class="p">(</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>        <span class="p">)</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>        <span class="n">initial_min_peak_bool</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_min_peaks_filter</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>        <span class="p">)</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>        <span class="n">initial_runtime_kendrick_filter</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_runtime_kendrick_filter</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>        <span class="p">)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>        <span class="c1"># Are the following 3 lines redundant?</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_min_peaks_filter</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_min_peaks_filter</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>            <span class="kc">False</span>  <span class="c1"># TODO check this line</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>        <span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_runtime_kendrick_filter</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>            <span class="kc">False</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>        <span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>        <span class="n">possible_formulas_dict_nm</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>        <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="n">possible_formulas_list</span><span class="p">:</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>            <span class="k">if</span> <span class="n">neutral_molform</span><span class="p">:</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>                <span class="n">nm</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">protonated_mz</span><span class="p">)</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>                <span class="n">nm</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">mz_nominal_calc</span><span class="p">)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>            <span class="k">if</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">possible_formulas_dict_nm</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>                <span class="n">possible_formulas_dict_nm</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>                <span class="n">possible_formulas_dict_nm</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mf</span><span class="p">]</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>        <span class="n">min_abundance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">min_abundance</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>        <span class="n">ion_type</span> <span class="o">=</span> <span class="n">ion_type</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_search</span><span class="p">(</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="p">,</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>            <span class="n">possible_formulas_dict_nm</span><span class="p">,</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>            <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>            <span class="n">ion_type</span><span class="p">,</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">polarity</span><span class="p">,</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>            <span class="n">adduct_atom</span><span class="o">=</span><span class="n">adduct_atom</span><span class="p">,</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>        <span class="p">)</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_min_peaks_filter</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>            <span class="n">initial_min_peak_bool</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>        <span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_runtime_kendrick_filter</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>            <span class="n">initial_runtime_kendrick_filter</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>        <span class="p">)</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>        <span class="n">mspeaks</span> <span class="o">=</span> <span class="p">[</span><span class="n">mspeak</span> <span class="k">for</span> <span class="n">mspeak</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span> <span class="k">if</span> <span class="n">mspeak</span><span class="o">.</span><span class="n">is_assigned</span><span class="p">]</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>        <span class="k">return</span> <span class="n">mspeaks</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a><span class="k">class</span> <span class="nc">SearchMolecularFormulaWorker</span><span class="p">:</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for searching molecular formulas in a mass spectrum.</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a><span class="sd">    Parameters</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a><span class="sd">    ----------</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a><span class="sd">    find_isotopologues : bool, optional</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="sd">        Flag to indicate whether to find isotopologues, by default True.</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a><span class="sd">    Attributes</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a><span class="sd">    ----------</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a><span class="sd">    find_isotopologues : bool</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a><span class="sd">        Flag to indicate whether to find isotopologues.</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a><span class="sd">    Methods</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a><span class="sd">    -------</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a><span class="sd">    * reset_error().</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a><span class="sd">        Reset the error variables.</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a><span class="sd">    * set_last_error().</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a><span class="sd">        Set the last error.</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a><span class="sd">    * find_formulas().</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a><span class="sd">        Find the formulas.</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a><span class="sd">    * calc_error().</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a><span class="sd">        Calculate the error.</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>    <span class="c1"># TODO add reset error function</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>    <span class="c1"># needs this wraper to pass the class to multiprocessing</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">find_isotopologues</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span> <span class="o">=</span> <span class="n">find_isotopologues</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Call the find formulas function.</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a><span class="sd">        Parameters</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a><span class="sd">        ----------</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a><span class="sd">        args : tuple</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a><span class="sd">            The arguments.</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a><span class="sd">        Returns</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a><span class="sd">        -------</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a><span class="sd">        list</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a><span class="sd">            The list of mass spectrum peaks with assigned molecular formulas.</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_formulas</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>  <span class="c1"># ,args[1]</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>    <span class="k">def</span> <span class="nf">reset_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass_spectrum_obj</span><span class="p">):</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the error variables.</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a><span class="sd">        Parameters</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a><span class="sd">        ----------</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a><span class="sd">        mass_spectrum_obj : MassSpectrum</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a><span class="sd">            The mass spectrum object.</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a><span class="sd">        Notes</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a><span class="sd">        -----</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a><span class="sd">        This function resets the error variables for the given mass spectrum object.</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>        <span class="k">global</span> <span class="n">last_error</span><span class="p">,</span> <span class="n">last_dif</span><span class="p">,</span> <span class="n">closest_error</span><span class="p">,</span> <span class="n">error_average</span><span class="p">,</span> <span class="n">nbValues</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>        <span class="n">last_error</span><span class="p">,</span> <span class="n">last_dif</span><span class="p">,</span> <span class="n">closest_error</span><span class="p">,</span> <span class="n">nbValues</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>    <span class="k">def</span> <span class="nf">set_last_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">mass_spectrum_obj</span><span class="p">):</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the last error.</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a><span class="sd">        Parameters</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a><span class="sd">        ----------</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a><span class="sd">        error : float</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a><span class="sd">            The error.</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a><span class="sd">        mass_spectrum_obj : MassSpectrum</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a><span class="sd">            The mass spectrum object.</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>        <span class="c1"># set the changes to the global variables, not internal ones</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>        <span class="k">global</span> <span class="n">last_error</span><span class="p">,</span> <span class="n">last_dif</span><span class="p">,</span> <span class="n">closest_error</span><span class="p">,</span> <span class="n">error_average</span><span class="p">,</span> <span class="n">nbValues</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>        <span class="k">if</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">error_method</span> <span class="o">==</span> <span class="s2">&quot;distance&quot;</span><span class="p">:</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>            <span class="n">dif</span> <span class="o">=</span> <span class="n">error</span> <span class="o">-</span> <span class="n">last_error</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>            <span class="k">if</span> <span class="n">dif</span> <span class="o">&lt;</span> <span class="n">last_dif</span><span class="p">:</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>                <span class="n">last_dif</span> <span class="o">=</span> <span class="n">dif</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>                <span class="n">closest_error</span> <span class="o">=</span> <span class="n">error</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>                    <span class="n">closest_error</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>                    <span class="o">-</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>                <span class="p">)</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>                    <span class="n">closest_error</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>                    <span class="o">+</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>                <span class="p">)</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>        <span class="k">elif</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">error_method</span> <span class="o">==</span> <span class="s2">&quot;lowest&quot;</span><span class="p">:</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>            <span class="k">if</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">last_error</span><span class="p">:</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>                    <span class="n">error</span> <span class="o">-</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>                <span class="p">)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>                    <span class="n">error</span> <span class="o">+</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>                <span class="p">)</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="n">error</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>        <span class="k">elif</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">error_method</span> <span class="o">==</span> <span class="s2">&quot;symmetrical&quot;</span><span class="p">:</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>            <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_average</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>                <span class="o">-</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>            <span class="p">)</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>            <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_average</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>                <span class="o">+</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>            <span class="p">)</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>        <span class="k">elif</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">error_method</span> <span class="o">==</span> <span class="s2">&quot;average&quot;</span><span class="p">:</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>            <span class="n">nbValues</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>            <span class="n">error_average</span> <span class="o">=</span> <span class="n">error_average</span> <span class="o">+</span> <span class="p">((</span><span class="n">error</span> <span class="o">-</span> <span class="n">error_average</span><span class="p">)</span> <span class="o">/</span> <span class="n">nbValues</span><span class="p">)</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>            <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>                <span class="n">error_average</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>                <span class="o">-</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>            <span class="p">)</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>            <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>                <span class="n">error_average</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>                <span class="o">+</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>            <span class="p">)</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>            <span class="c1"># using set mass_spectrum_obj.molecular_search_settings.min_ppm_error  and max_ppm_error range</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>            <span class="k">pass</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>        <span class="c1"># returns the error based on the selected method at mass_spectrum_obj.molecular_search_settings.method</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>    <span class="k">def</span> <span class="nf">calc_error</span><span class="p">(</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">mz_calc</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ppm&quot;</span><span class="p">):</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the error.</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a><span class="sd">        Parameters</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a><span class="sd">        ----------</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a><span class="sd">        mz_exp : float</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a><span class="sd">            The experimental m/z value.</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a><span class="sd">        mz_calc : float</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a><span class="sd">            The calculated m/z value.</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a><span class="sd">        method : str, optional</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a><span class="sd">            The method, by default &#39;ppm&#39;.</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a><span class="sd">        Raises</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a><span class="sd">        -------</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a><span class="sd">        Exception</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a><span class="sd">            If the method is not ppm or ppb.</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a><span class="sd">        Returns</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a><span class="sd">        -------</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a><span class="sd">        float</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a><span class="sd">            The error.</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;ppm&quot;</span><span class="p">:</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>            <span class="n">multi_factor</span> <span class="o">=</span> <span class="mi">1_000_000</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;ppb&quot;</span><span class="p">:</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>            <span class="n">multi_factor</span> <span class="o">=</span> <span class="mi">1_000_000_000</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;perc&quot;</span><span class="p">:</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>            <span class="n">multi_factor</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>                <span class="s2">&quot;method needs to be ppm or ppb, you have entered </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">method</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>            <span class="p">)</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>        <span class="k">if</span> <span class="n">mz_exp</span><span class="p">:</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>            <span class="k">return</span> <span class="p">((</span><span class="n">mz_exp</span> <span class="o">-</span> <span class="n">mz_calc</span><span class="p">)</span> <span class="o">/</span> <span class="n">mz_calc</span><span class="p">)</span> <span class="o">*</span> <span class="n">multi_factor</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please set mz_calc first&quot;</span><span class="p">)</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>    <span class="k">def</span> <span class="nf">find_formulas</span><span class="p">(</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>        <span class="n">formulas</span><span class="p">,</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>        <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>        <span class="n">mass_spectrum_obj</span><span class="p">,</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>        <span class="n">ms_peak</span><span class="p">,</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>        <span class="n">ion_type</span><span class="p">,</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>        <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>        <span class="n">adduct_atom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>    <span class="p">):</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the formulas.</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a><span class="sd">        Parameters</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a><span class="sd">        ----------</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a><span class="sd">        formulas : list of MolecularFormula</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a><span class="sd">            The list of molecular formulas.</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a><span class="sd">        min_abundance : float</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a><span class="sd">            The minimum abundance threshold.</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a><span class="sd">        mass_spectrum_obj : MassSpectrum</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a><span class="sd">            The mass spectrum object.</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a><span class="sd">        ms_peak : MSPeak</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a><span class="sd">            The mass spectrum peak.</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a><span class="sd">        ion_type : str</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a><span class="sd">            The ion type.</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a><span class="sd">        ion_charge : int</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a><span class="sd">            The ion charge.</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a><span class="sd">        adduct_atom : str, optional</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a><span class="sd">            The adduct atom, by default None.</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a><span class="sd">        Returns</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a><span class="sd">        -------</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a><span class="sd">        list of MSPeak</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a><span class="sd">            The list of mass spectrum peaks with assigned molecular formulas.</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="sd">        Notes</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="sd">        -----</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a><span class="sd">        Uses the closest error the next search (this is not ideal, it needs to use confidence</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a><span class="sd">        metric to choose the right candidate then propagate the error using the error from the best candidate).</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">        It needs to add s/n to the equation.</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a><span class="sd">        It need optimization to define the mz_error_range within a m/z unit since it is directly proportional</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="sd">        with the mass, and inversely proportional to the rp. It&#39;s not linear, i.e., sigma mass.</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a><span class="sd">        The idea it to correlate sigma to resolving power, signal to noise and sample complexity per mz unit.</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a><span class="sd">        Method=&#39;distance&#39;</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>        <span class="n">mspeak_assigned_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>        <span class="n">min_ppm_error</span> <span class="o">=</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_ppm_error</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>        <span class="n">max_ppm_error</span> <span class="o">=</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_ppm_error</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>        <span class="n">min_abun_error</span> <span class="o">=</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_abun_error</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>        <span class="n">max_abun_error</span> <span class="o">=</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_abun_error</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>        <span class="c1"># f = open(&quot;abundance_error.txt&quot;, &quot;a+&quot;)</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>        <span class="n">ms_peak_mz_exp</span><span class="p">,</span> <span class="n">ms_peak_abundance</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>        <span class="c1"># min_error = min([pmf.mz_error for pmf in possible_formulas])</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>        <span class="k">def</span> <span class="nf">mass_by_ion_type</span><span class="p">(</span><span class="n">possible_formula_obj</span><span class="p">):</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>            <span class="k">if</span> <span class="n">ion_type</span> <span class="o">==</span> <span class="n">Labels</span><span class="o">.</span><span class="n">protonated_de_ion</span><span class="p">:</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>                <span class="k">return</span> <span class="n">possible_formula_obj</span><span class="o">.</span><span class="n">_protonated_mz</span><span class="p">(</span><span class="n">ion_charge</span><span class="p">)</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>            <span class="k">elif</span> <span class="n">ion_type</span> <span class="o">==</span> <span class="n">Labels</span><span class="o">.</span><span class="n">radical_ion</span><span class="p">:</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>                <span class="k">return</span> <span class="n">possible_formula_obj</span><span class="o">.</span><span class="n">_radical_mz</span><span class="p">(</span><span class="n">ion_charge</span><span class="p">)</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>            <span class="k">elif</span> <span class="n">ion_type</span> <span class="o">==</span> <span class="n">Labels</span><span class="o">.</span><span class="n">adduct_ion</span> <span class="ow">and</span> <span class="n">adduct_atom</span><span class="p">:</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>                <span class="k">return</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">_adduct_mz</span><span class="p">(</span><span class="n">ion_charge</span><span class="p">,</span> <span class="n">adduct_atom</span><span class="p">)</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>                <span class="c1"># will return externally calculated mz if is set, #use on Bruker Reference list import</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>                <span class="c1"># if the ion type is known the ion mass based on molecular formula ion type</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>                <span class="c1"># if ion type is unknow will return neutral mass</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>                <span class="k">return</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">mz_calc</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>        <span class="k">if</span> <span class="n">formulas</span><span class="p">:</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">formulas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">LCMSLibRefMolecularFormula</span><span class="p">):</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>                <span class="n">possible_mf_class</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>                <span class="n">possible_mf_class</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>        <span class="k">for</span> <span class="n">possible_formula</span> <span class="ow">in</span> <span class="n">formulas</span><span class="p">:</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>            <span class="k">if</span> <span class="n">possible_formula</span><span class="p">:</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>                <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_error</span><span class="p">(</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>                    <span class="n">ms_peak_mz_exp</span><span class="p">,</span> <span class="n">mass_by_ion_type</span><span class="p">(</span><span class="n">possible_formula</span><span class="p">)</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>                <span class="p">)</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>                <span class="c1"># error = possible_formula.mz_error</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>                <span class="k">if</span> <span class="n">min_ppm_error</span> <span class="o">&lt;=</span> <span class="n">error</span> <span class="o">&lt;=</span> <span class="n">max_ppm_error</span><span class="p">:</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>                    <span class="c1"># update the error</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">set_last_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">mass_spectrum_obj</span><span class="p">)</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>                    <span class="c1"># add molecular formula match to ms_peak</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>                    <span class="c1"># get molecular formula dict from sql obj</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>                    <span class="c1"># formula_dict = pickle.loads(possible_formula.mol_formula)</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>                    <span class="c1"># if possible_mf_class:</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>                    <span class="c1">#    molecular_formula = deepcopy(possible_formula)</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>                    <span class="c1"># else:</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>                    <span class="n">formula_dict</span> <span class="o">=</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>                    <span class="c1"># create the molecular formula obj to be stored</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>                    <span class="k">if</span> <span class="n">possible_mf_class</span><span class="p">:</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>                        <span class="n">molecular_formula</span> <span class="o">=</span> <span class="n">LCMSLibRefMolecularFormula</span><span class="p">(</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>                            <span class="n">formula_dict</span><span class="p">,</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>                            <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>                            <span class="n">ion_type</span><span class="o">=</span><span class="n">ion_type</span><span class="p">,</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>                            <span class="n">adduct_atom</span><span class="o">=</span><span class="n">adduct_atom</span><span class="p">,</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>                        <span class="p">)</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>                        <span class="n">molecular_formula</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>                        <span class="n">molecular_formula</span><span class="o">.</span><span class="n">kegg_id</span> <span class="o">=</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">kegg_id</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>                        <span class="n">molecular_formula</span><span class="o">.</span><span class="n">cas</span> <span class="o">=</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">cas</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>                        <span class="n">molecular_formula</span> <span class="o">=</span> <span class="n">MolecularFormula</span><span class="p">(</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>                            <span class="n">formula_dict</span><span class="p">,</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>                            <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>                            <span class="n">ion_type</span><span class="o">=</span><span class="n">ion_type</span><span class="p">,</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>                            <span class="n">adduct_atom</span><span class="o">=</span><span class="n">adduct_atom</span><span class="p">,</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>                        <span class="p">)</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>                    <span class="c1"># add the molecular formula obj to the mspeak obj</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>                    <span class="c1"># add the mspeak obj and it&#39;s index for tracking next assignment step</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span><span class="p">:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>                        <span class="c1"># calculates isotopologues</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>                        <span class="n">isotopologues</span> <span class="o">=</span> <span class="n">molecular_formula</span><span class="o">.</span><span class="n">isotopologues</span><span class="p">(</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>                            <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>                            <span class="n">ms_peak_abundance</span><span class="p">,</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>                            <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">dynamic_range</span><span class="p">,</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>                        <span class="p">)</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>                        <span class="c1"># search for isotopologues</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>                        <span class="k">for</span> <span class="n">isotopologue_formula</span> <span class="ow">in</span> <span class="n">isotopologues</span><span class="p">:</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>                            <span class="n">molecular_formula</span><span class="o">.</span><span class="n">expected_isotopologues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>                                <span class="n">isotopologue_formula</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>                            <span class="p">)</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>                            <span class="c1"># move this outside to improve preformace</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>                            <span class="c1"># we need to increase the search space to -+1 m_z</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>                            <span class="n">first_index</span><span class="p">,</span> <span class="n">last_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>                                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">get_nominal_mz_first_last_indexes</span><span class="p">(</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>                                    <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">mz_nominal_calc</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>                                <span class="p">)</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>                            <span class="p">)</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>                            <span class="k">for</span> <span class="n">ms_peak_iso</span> <span class="ow">in</span> <span class="n">mass_spectrum_obj</span><span class="p">[</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>                                <span class="n">first_index</span><span class="p">:</span><span class="n">last_index</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>                            <span class="p">]:</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>                                <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_error</span><span class="p">(</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>                                    <span class="n">ms_peak_iso</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">mz_calc</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>                                <span class="p">)</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>                                <span class="k">if</span> <span class="n">min_ppm_error</span> <span class="o">&lt;=</span> <span class="n">error</span> <span class="o">&lt;=</span> <span class="n">max_ppm_error</span><span class="p">:</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>                                    <span class="c1"># need to define error distribution for abundance measurements</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>                                    <span class="c1"># if mass_spectrum_obj.is_centroid:</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>                                    <span class="n">abundance_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_error</span><span class="p">(</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>                                        <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">abundance_calc</span><span class="p">,</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>                                        <span class="n">ms_peak_iso</span><span class="o">.</span><span class="n">abundance</span><span class="p">,</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>                                        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;perc&quot;</span><span class="p">,</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>                                    <span class="p">)</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>                                    <span class="c1"># area_error = self.calc_error(ms_peak.area, ms_peak_iso.area, method=&#39;perc&#39;)</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>                                    <span class="c1"># margin of error was set empirically/ needs statistical calculation</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>                                    <span class="c1">#  of margin of error for the measurement of the abundances</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>                                    <span class="k">if</span> <span class="p">(</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>                                        <span class="n">min_abun_error</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>                                        <span class="o">&lt;=</span> <span class="n">abundance_error</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>                                        <span class="o">&lt;=</span> <span class="n">max_abun_error</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>                                    <span class="p">):</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>                                        <span class="c1"># update the error</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">set_last_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">mass_spectrum_obj</span><span class="p">)</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>                                        <span class="c1"># isotopologue_formula.mz_error = error</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>                                        <span class="c1"># isotopologue_formula.area_error = area_error</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>                                        <span class="c1"># isotopologue_formula.abundance_error = abundance_error</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>                                        <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">mspeak_index_mono_isotopic</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">index</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>                                        <span class="n">mono_isotopic_formula_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms_peak</span><span class="p">)</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>                                        <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">mspeak_index_mono_isotopic</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">index</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>                                        <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">mono_isotopic_formula_index</span> <span class="o">=</span> <span class="n">mono_isotopic_formula_index</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>                                        <span class="c1"># add mspeaks isotopologue index to the mono isotopic MolecularFormula obj and the respective formula position</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>                                        <span class="c1"># add molecular formula match to ms_peak</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>                                        <span class="n">x</span> <span class="o">=</span> <span class="n">ms_peak_iso</span><span class="o">.</span><span class="n">add_molecular_formula</span><span class="p">(</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>                                            <span class="n">isotopologue_formula</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>                                        <span class="p">)</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>                                        <span class="n">molecular_formula</span><span class="o">.</span><span class="n">mspeak_mf_isotopologues_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>                                            <span class="p">(</span><span class="n">ms_peak_iso</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>                                        <span class="p">)</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>                                        <span class="c1"># add mspeaks mono isotopic index to the isotopologue MolecularFormula obj</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>                    <span class="n">y</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">add_molecular_formula</span><span class="p">(</span><span class="n">molecular_formula</span><span class="p">)</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>                    <span class="n">mspeak_assigned_index</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ms_peak</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>        <span class="k">return</span> <span class="n">mspeak_assigned_index</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a><span class="k">class</span> <span class="nc">SearchMolecularFormulasLC</span><span class="p">:</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for searching molecular formulas in a LC object.</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a><span class="sd">    Parameters</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a><span class="sd">    ----------</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a><span class="sd">    lcms_obj : LCMSBase</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a><span class="sd">        The LCMSBase object.</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a><span class="sd">    sql_db : MolForm_SQL, optional</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a><span class="sd">        The SQL database object, by default None.</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a><span class="sd">    first_hit : bool, optional</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a><span class="sd">        Flag to indicate whether to skip peaks that already have a molecular formula assigned, by default False.</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a><span class="sd">    find_isotopologues : bool, optional</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a><span class="sd">        Flag to indicate whether to find isotopologues, by default True.</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a><span class="sd">    Methods</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a><span class="sd">    -------</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a><span class="sd">    * search_spectra_against_candidates().</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a><span class="sd">        Search a list of mass spectra against a list of candidate formulas with a given ion type and charge.</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a><span class="sd">    * bulk_run_molecular_formula_search().</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a><span class="sd">        Run the molecular formula search on the given list of mass spectra.</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a><span class="sd">        Pulls the settings from the LCMSBase object to set ion type and charge to search for. </span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a><span class="sd">    * run_mass_feature_search().</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a><span class="sd">        Run the molecular formula search on mass features.</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a><span class="sd">        Calls bulk_run_molecular_formula_search() with specified mass spectra and mass peaks.</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a><span class="sd">    * run_untargeted_worker_ms1().</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a><span class="sd">        Run untargeted molecular formula search on the ms1 mass spectrum.</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a><span class="sd">        DEPRECATED: use run_mass_feature_search() or bulk_run_molecular_formula_search() instead.</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a><span class="sd">    * run_target_worker_ms1().</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a><span class="sd">        Run targeted molecular formula search on the ms1 mass spectrum.</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a><span class="sd">        DEPRECATED: use run_mass_feature_search() or bulk_run_molecular_formula_search() instead.</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lcms_obj</span><span class="p">,</span> <span class="n">sql_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">first_hit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">find_isotopologues</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">first_hit</span> <span class="o">=</span> <span class="n">first_hit</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span> <span class="o">=</span> <span class="n">find_isotopologues</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span> <span class="o">=</span> <span class="n">lcms_obj</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sql_db</span><span class="p">:</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span> <span class="o">=</span> <span class="n">MolForm_SQL</span><span class="p">(</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>                <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="s1">&#39;ms1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">url_database</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>            <span class="p">)</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span> <span class="o">=</span> <span class="n">sql_db</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>    <span class="k">def</span> <span class="nf">search_spectra_against_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass_spectrum_list</span><span class="p">,</span> <span class="n">ms_peaks_list</span><span class="p">,</span> <span class="n">candidate_formulas</span><span class="p">,</span> <span class="n">ion_type</span><span class="p">,</span> <span class="n">ion_charge</span><span class="p">):</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Search a list of mass spectra against a list of candidate formulas with a given ion type and charge.</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a><span class="sd">        Parameters</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a><span class="sd">        ----------</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a><span class="sd">        mass_spectrum_list : list of MassSpectrum</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a><span class="sd">            The list of mass spectra to perform the search on.</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a><span class="sd">        ms_peaks_list : list of lists of MSPeak objects</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a><span class="sd">            The list of mass spectrum peaks to search within each mass spectrum.</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a><span class="sd">        candidate_formulas : dict</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a><span class="sd">            The candidate formulas.</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a><span class="sd">        ion_type : str</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a><span class="sd">            The ion type.</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a><span class="sd">        ion_charge : int</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a><span class="sd">            The ion charge, either 1 or -1.</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a><span class="sd">        Notes</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a><span class="sd">        -----</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a><span class="sd">        This function is designed to be used with the bulk_run_molecular_formula_search function.</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>        <span class="k">for</span> <span class="n">mass_spectrum</span><span class="p">,</span> <span class="n">ms_peaks</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mass_spectrum_list</span><span class="p">,</span> <span class="n">ms_peaks_list</span><span class="p">):</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>            <span class="n">single_ms_search</span> <span class="o">=</span> <span class="n">SearchMolecularFormulas</span><span class="p">(</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>                <span class="n">mass_spectrum</span><span class="p">,</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>                <span class="n">sql_db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="p">,</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>                <span class="n">first_hit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">first_hit</span><span class="p">,</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>                <span class="n">find_isotopologues</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span><span class="p">,</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>            <span class="p">)</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>            <span class="n">single_ms_search</span><span class="o">.</span><span class="n">run_search</span><span class="p">(</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>                <span class="n">ms_peaks</span><span class="p">,</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>                <span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>                <span class="n">mass_spectrum</span><span class="o">.</span><span class="n">min_abundance</span><span class="p">,</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>                <span class="n">ion_type</span><span class="p">,</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>            <span class="p">)</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>    <span class="k">def</span> <span class="nf">bulk_run_molecular_formula_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass_spectrum_list</span><span class="p">,</span> <span class="n">ms_peaks_list</span><span class="p">,</span> <span class="n">mass_spectrum_setting_key</span><span class="o">=</span><span class="s1">&#39;ms1&#39;</span><span class="p">):</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the molecular formula search on the given list of mass spectra</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a><span class="sd">        Parameters</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a><span class="sd">        ----------</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a><span class="sd">        mass_spectrum_list : list of MassSpectrum</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a><span class="sd">            The list of mass spectra to search.</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a><span class="sd">        ms_peaks_list : list of lists of MSPeak objects </span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a><span class="sd">            The mass peaks to perform molecular formula search within each mass spectrum</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a><span class="sd">        mass_spectrum_setting_key : str, optional</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a><span class="sd">            The mass spectrum setting key, by default &#39;ms1&#39;.</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a><span class="sd">            This is used to get the appropriate molecular search settings from the LCMSBase object</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>        <span class="c1"># Set min_abundance and nominal_mzs</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">polarity</span> <span class="o">==</span> <span class="s2">&quot;positive&quot;</span><span class="p">:</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>            <span class="n">ion_charge</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">polarity</span> <span class="o">==</span> <span class="s2">&quot;negative&quot;</span><span class="p">:</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>            <span class="n">ion_charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Polarity must be either &#39;positive&#39; or &#39;negative&#39;&quot;</span><span class="p">)</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>        
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>        <span class="c1"># Check that the length of the mass spectrum list and the ms_peaks list are the same</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mass_spectrum_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms_peaks_list</span><span class="p">):</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The length of the mass spectrum list and the ms_peaks list must be the same&quot;</span><span class="p">)</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>        
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>        <span class="n">nominal_mzs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">nominal_mz</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mass_spectrum_list</span><span class="p">]</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>        <span class="n">nominal_mzs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">nominal_mzs</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]))</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">verbose_processing</span> 
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>        <span class="c1"># reset average error, only relevant if average mass error method is being used</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>        <span class="n">SearchMolecularFormulaWorker</span><span class="p">(</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>            <span class="n">find_isotopologues</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">reset_error</span><span class="p">(</span><span class="n">mass_spectrum_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>        <span class="c1"># check database for all possible molecular formula combinations based on the setting passed to self.mass_spectrum_obj.molecular_search_settings</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>        <span class="n">classes</span> <span class="o">=</span> <span class="n">MolecularCombinations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="p">)</span><span class="o">.</span><span class="n">runworker</span><span class="p">(</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="p">,</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>            <span class="n">print_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>        <span class="p">)</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>        
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>        <span class="c1"># split the database load to not blowout the memory</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>        <span class="k">for</span> <span class="n">classe_chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">(</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>            <span class="n">classes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">db_chunk_size</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>        <span class="p">):</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>            <span class="n">classes_str_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">class_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">class_tuple</span> <span class="ow">in</span> <span class="n">classe_chunk</span><span class="p">]</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>            <span class="c1"># load the molecular formula objs binned by ion type and heteroatoms classes, {ion type:{classe:[list_formula]}}</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>            <span class="c1"># for adduct ion type a third key is added {atoms:{ion type:{classe:[list_formula]}}}</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>            <span class="n">dict_res</span> <span class="o">=</span> <span class="n">SearchMolecularFormulas</span><span class="o">.</span><span class="n">database_to_dict</span><span class="p">(</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>                <span class="n">classes_str_list</span><span class="p">,</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>                <span class="n">nominal_mzs</span><span class="p">,</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="p">,</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>            <span class="p">)</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">classe_chunk</span><span class="p">,</span> <span class="n">disable</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">)</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>            <span class="k">for</span> <span class="n">classe_tuple</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>                <span class="c1"># class string is a json serialized dict</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>                <span class="n">classe_str</span> <span class="o">=</span> <span class="n">classe_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>                <span class="c1"># Perform search for (de)protonated ion type</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">isProtonated</span><span class="p">:</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>                    <span class="n">ion_type</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">protonated_de_ion</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>                    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description_str</span><span class="p">(</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>                        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Started molecular formula search for class </span><span class="si">%s</span><span class="s2">, (de)protonated &quot;</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>                        <span class="o">%</span> <span class="n">classe_str</span><span class="p">,</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>                        <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>                    <span class="p">)</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>                    <span class="n">candidate_formulas</span> <span class="o">=</span> <span class="n">dict_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ion_type</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">classe_str</span><span class="p">)</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>                    <span class="k">if</span> <span class="n">candidate_formulas</span><span class="p">:</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">search_spectra_against_candidates</span><span class="p">(</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>                            <span class="n">mass_spectrum_list</span><span class="o">=</span><span class="n">mass_spectrum_list</span><span class="p">,</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>                            <span class="n">ms_peaks_list</span><span class="o">=</span><span class="n">ms_peaks_list</span><span class="p">,</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>                            <span class="n">candidate_formulas</span><span class="o">=</span><span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>                            <span class="n">ion_type</span><span class="o">=</span><span class="n">ion_type</span><span class="p">,</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>                            <span class="n">ion_charge</span><span class="o">=</span><span class="n">ion_charge</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>                        <span class="p">)</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>                <span class="c1"># Perform search for radical ion type</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">isRadical</span><span class="p">:</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>                    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description_str</span><span class="p">(</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>                        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Started molecular formula search for class </span><span class="si">%s</span><span class="s2">, radical &quot;</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>                        <span class="o">%</span> <span class="n">classe_str</span><span class="p">,</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>                        <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>                    <span class="p">)</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>                    <span class="n">ion_type</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">radical_ion</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>                    <span class="n">candidate_formulas</span> <span class="o">=</span> <span class="n">dict_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ion_type</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">classe_str</span><span class="p">)</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>                    <span class="k">if</span> <span class="n">candidate_formulas</span><span class="p">:</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">search_spectra_against_candidates</span><span class="p">(</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>                            <span class="n">mass_spectrum_list</span><span class="o">=</span><span class="n">mass_spectrum_list</span><span class="p">,</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>                            <span class="n">ms_peaks_list</span><span class="o">=</span><span class="n">ms_peaks_list</span><span class="p">,</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>                            <span class="n">candidate_formulas</span><span class="o">=</span><span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>                            <span class="n">ion_type</span><span class="o">=</span><span class="n">ion_type</span><span class="p">,</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>                            <span class="n">ion_charge</span><span class="o">=</span><span class="n">ion_charge</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>                        <span class="p">)</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>                <span class="c1"># Perform search for adduct ion type</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>                <span class="c1"># looks for adduct, used_atom_valences should be 0</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>                <span class="c1"># this code does not support H exchance by halogen atoms</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">isAdduct</span><span class="p">:</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>                    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description_str</span><span class="p">(</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>                        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Started molecular formula search for class </span><span class="si">%s</span><span class="s2">, adduct &quot;</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>                        <span class="o">%</span> <span class="n">classe_str</span><span class="p">,</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>                        <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>                    <span class="p">)</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>                    <span class="n">ion_type</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">adduct_ion</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>                    <span class="n">dict_atoms_formulas</span> <span class="o">=</span> <span class="n">dict_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ion_type</span><span class="p">)</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>                    <span class="k">for</span> <span class="n">adduct_atom</span><span class="p">,</span> <span class="n">dict_by_class</span> <span class="ow">in</span> <span class="n">dict_atoms_formulas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>                        <span class="n">candidate_formulas</span> <span class="o">=</span> <span class="n">dict_by_class</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">classe_str</span><span class="p">)</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>                        <span class="k">if</span> <span class="n">candidate_formulas</span><span class="p">:</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">search_spectra_against_candidates</span><span class="p">(</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>                                <span class="n">mass_spectrum_list</span><span class="o">=</span><span class="n">mass_spectrum_list</span><span class="p">,</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>                                <span class="n">ms_peaks_list</span><span class="o">=</span><span class="n">ms_peaks_list</span><span class="p">,</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>                                <span class="n">candidate_formulas</span><span class="o">=</span><span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>                                <span class="n">ion_type</span><span class="o">=</span><span class="n">ion_type</span><span class="p">,</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>                                <span class="n">ion_charge</span><span class="o">=</span><span class="n">ion_charge</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>                            <span class="p">)</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>        
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>    <span class="k">def</span> <span class="nf">run_mass_feature_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the molecular formula search on the mass features.</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a><span class="sd">        </span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a><span class="sd">        Calls bulk_run_molecular_formula_search() with specified mass spectra and mass peaks.</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>        <span class="n">mass_features_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>        <span class="c1"># Get the list of mass spectrum (and peaks to search with each mass spectrum) for all mass features</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>        <span class="n">scan_list</span> <span class="o">=</span> <span class="n">mass_features_df</span><span class="o">.</span><span class="n">apex_scan</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>        <span class="n">mass_spectrum_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">_ms</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scan_list</span><span class="p">]</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>        <span class="n">ms_peaks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scan_list</span><span class="p">:</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>            <span class="n">mf_df_scan</span> <span class="o">=</span> <span class="n">mass_features_df</span><span class="p">[</span><span class="n">mass_features_df</span><span class="o">.</span><span class="n">apex_scan</span> <span class="o">==</span> <span class="n">scan</span><span class="p">]</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>            <span class="n">peaks_to_search</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">ms1_peak</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mf_df_scan</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>            <span class="p">]</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>            <span class="n">ms_peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peaks_to_search</span><span class="p">)</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>        
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>        <span class="c1"># Run the molecular formula search</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_run_molecular_formula_search</span><span class="p">(</span><span class="n">mass_spectrum_list</span><span class="p">,</span> <span class="n">ms_peaks</span><span class="p">)</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>    
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>    <span class="k">def</span> <span class="nf">run_untargeted_worker_ms1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run untargeted molecular formula search on the ms1 mass spectrum.&quot;&quot;&quot;</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;run_untargeted_worker_ms1 search is not implemented in CoreMS 3.0 and greater&quot;</span><span class="p">)</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>    <span class="k">def</span> <span class="nf">run_target_worker_ms1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run targeted molecular formula search on the ms1 mass spectrum.&quot;&quot;&quot;</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;run_target_worker_ms1 formula search is not yet implemented in CoreMS 3.0 and greater&quot;</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="last_error">
                    <div class="attr variable">
            <span class="name">last_error</span>        =
<span class="default_value">0</span>

        
    </div>
    <a class="headerlink" href="#last_error"></a>
    
    

                </section>
                <section id="last_dif">
                    <div class="attr variable">
            <span class="name">last_dif</span>        =
<span class="default_value">0</span>

        
    </div>
    <a class="headerlink" href="#last_dif"></a>
    
    

                </section>
                <section id="closest_error">
                    <div class="attr variable">
            <span class="name">closest_error</span>        =
<span class="default_value">0</span>

        
    </div>
    <a class="headerlink" href="#closest_error"></a>
    
    

                </section>
                <section id="error_average">
                    <div class="attr variable">
            <span class="name">error_average</span>        =
<span class="default_value">0</span>

        
    </div>
    <a class="headerlink" href="#error_average"></a>
    
    

                </section>
                <section id="nbValues">
                    <div class="attr variable">
            <span class="name">nbValues</span>        =
<span class="default_value">0</span>

        
    </div>
    <a class="headerlink" href="#nbValues"></a>
    
    

                </section>
                <section id="SearchMolecularFormulas">
                            <input id="SearchMolecularFormulas-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SearchMolecularFormulas</span>:

                <label class="view-source-button" for="SearchMolecularFormulas-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulas"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulas-27"><a href="#SearchMolecularFormulas-27"><span class="linenos"> 27</span></a><span class="k">class</span> <span class="nc">SearchMolecularFormulas</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-28"><a href="#SearchMolecularFormulas-28"><span class="linenos"> 28</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for searching molecular formulas in a mass spectrum.</span>
</span><span id="SearchMolecularFormulas-29"><a href="#SearchMolecularFormulas-29"><span class="linenos"> 29</span></a>
</span><span id="SearchMolecularFormulas-30"><a href="#SearchMolecularFormulas-30"><span class="linenos"> 30</span></a><span class="sd">    Parameters</span>
</span><span id="SearchMolecularFormulas-31"><a href="#SearchMolecularFormulas-31"><span class="linenos"> 31</span></a><span class="sd">    ----------</span>
</span><span id="SearchMolecularFormulas-32"><a href="#SearchMolecularFormulas-32"><span class="linenos"> 32</span></a><span class="sd">    mass_spectrum_obj : MassSpectrum</span>
</span><span id="SearchMolecularFormulas-33"><a href="#SearchMolecularFormulas-33"><span class="linenos"> 33</span></a><span class="sd">        The mass spectrum object.</span>
</span><span id="SearchMolecularFormulas-34"><a href="#SearchMolecularFormulas-34"><span class="linenos"> 34</span></a><span class="sd">    sql_db : MolForm_SQL, optional</span>
</span><span id="SearchMolecularFormulas-35"><a href="#SearchMolecularFormulas-35"><span class="linenos"> 35</span></a><span class="sd">        The SQL database object, by default None.</span>
</span><span id="SearchMolecularFormulas-36"><a href="#SearchMolecularFormulas-36"><span class="linenos"> 36</span></a><span class="sd">    first_hit : bool, optional</span>
</span><span id="SearchMolecularFormulas-37"><a href="#SearchMolecularFormulas-37"><span class="linenos"> 37</span></a><span class="sd">        Flag to indicate whether to skip peaks that already have a molecular formula assigned, by default False.</span>
</span><span id="SearchMolecularFormulas-38"><a href="#SearchMolecularFormulas-38"><span class="linenos"> 38</span></a><span class="sd">    find_isotopologues : bool, optional</span>
</span><span id="SearchMolecularFormulas-39"><a href="#SearchMolecularFormulas-39"><span class="linenos"> 39</span></a><span class="sd">        Flag to indicate whether to find isotopologues, by default True.</span>
</span><span id="SearchMolecularFormulas-40"><a href="#SearchMolecularFormulas-40"><span class="linenos"> 40</span></a>
</span><span id="SearchMolecularFormulas-41"><a href="#SearchMolecularFormulas-41"><span class="linenos"> 41</span></a><span class="sd">    Attributes</span>
</span><span id="SearchMolecularFormulas-42"><a href="#SearchMolecularFormulas-42"><span class="linenos"> 42</span></a><span class="sd">    ----------</span>
</span><span id="SearchMolecularFormulas-43"><a href="#SearchMolecularFormulas-43"><span class="linenos"> 43</span></a><span class="sd">    mass_spectrum_obj : MassSpectrum</span>
</span><span id="SearchMolecularFormulas-44"><a href="#SearchMolecularFormulas-44"><span class="linenos"> 44</span></a><span class="sd">        The mass spectrum object.</span>
</span><span id="SearchMolecularFormulas-45"><a href="#SearchMolecularFormulas-45"><span class="linenos"> 45</span></a><span class="sd">    sql_db : MolForm_SQL</span>
</span><span id="SearchMolecularFormulas-46"><a href="#SearchMolecularFormulas-46"><span class="linenos"> 46</span></a><span class="sd">        The SQL database object.</span>
</span><span id="SearchMolecularFormulas-47"><a href="#SearchMolecularFormulas-47"><span class="linenos"> 47</span></a><span class="sd">    first_hit : bool</span>
</span><span id="SearchMolecularFormulas-48"><a href="#SearchMolecularFormulas-48"><span class="linenos"> 48</span></a><span class="sd">        Flag to indicate whether to skip peaks that already have a molecular formula assigned.</span>
</span><span id="SearchMolecularFormulas-49"><a href="#SearchMolecularFormulas-49"><span class="linenos"> 49</span></a><span class="sd">    find_isotopologues : bool</span>
</span><span id="SearchMolecularFormulas-50"><a href="#SearchMolecularFormulas-50"><span class="linenos"> 50</span></a><span class="sd">        Flag to indicate whether to find isotopologues.</span>
</span><span id="SearchMolecularFormulas-51"><a href="#SearchMolecularFormulas-51"><span class="linenos"> 51</span></a>
</span><span id="SearchMolecularFormulas-52"><a href="#SearchMolecularFormulas-52"><span class="linenos"> 52</span></a>
</span><span id="SearchMolecularFormulas-53"><a href="#SearchMolecularFormulas-53"><span class="linenos"> 53</span></a><span class="sd">    Methods</span>
</span><span id="SearchMolecularFormulas-54"><a href="#SearchMolecularFormulas-54"><span class="linenos"> 54</span></a><span class="sd">    -------</span>
</span><span id="SearchMolecularFormulas-55"><a href="#SearchMolecularFormulas-55"><span class="linenos"> 55</span></a><span class="sd">    * run_search().</span>
</span><span id="SearchMolecularFormulas-56"><a href="#SearchMolecularFormulas-56"><span class="linenos"> 56</span></a><span class="sd">        Run the molecular formula search.</span>
</span><span id="SearchMolecularFormulas-57"><a href="#SearchMolecularFormulas-57"><span class="linenos"> 57</span></a><span class="sd">    * run_worker_mass_spectrum().</span>
</span><span id="SearchMolecularFormulas-58"><a href="#SearchMolecularFormulas-58"><span class="linenos"> 58</span></a><span class="sd">        Run the molecular formula search on the mass spectrum object.</span>
</span><span id="SearchMolecularFormulas-59"><a href="#SearchMolecularFormulas-59"><span class="linenos"> 59</span></a><span class="sd">    * run_worker_ms_peaks().</span>
</span><span id="SearchMolecularFormulas-60"><a href="#SearchMolecularFormulas-60"><span class="linenos"> 60</span></a><span class="sd">        Run the molecular formula search on the given list of mass spectrum peaks.</span>
</span><span id="SearchMolecularFormulas-61"><a href="#SearchMolecularFormulas-61"><span class="linenos"> 61</span></a><span class="sd">    * database_to_dict().</span>
</span><span id="SearchMolecularFormulas-62"><a href="#SearchMolecularFormulas-62"><span class="linenos"> 62</span></a><span class="sd">        Convert the database results to a dictionary.</span>
</span><span id="SearchMolecularFormulas-63"><a href="#SearchMolecularFormulas-63"><span class="linenos"> 63</span></a><span class="sd">    * run_molecular_formula().</span>
</span><span id="SearchMolecularFormulas-64"><a href="#SearchMolecularFormulas-64"><span class="linenos"> 64</span></a><span class="sd">        Run the molecular formula search on the given list of mass spectrum peaks.</span>
</span><span id="SearchMolecularFormulas-65"><a href="#SearchMolecularFormulas-65"><span class="linenos"> 65</span></a><span class="sd">    * search_mol_formulas().</span>
</span><span id="SearchMolecularFormulas-66"><a href="#SearchMolecularFormulas-66"><span class="linenos"> 66</span></a><span class="sd">        Search for molecular formulas in the mass spectrum.</span>
</span><span id="SearchMolecularFormulas-67"><a href="#SearchMolecularFormulas-67"><span class="linenos"> 67</span></a>
</span><span id="SearchMolecularFormulas-68"><a href="#SearchMolecularFormulas-68"><span class="linenos"> 68</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas-69"><a href="#SearchMolecularFormulas-69"><span class="linenos"> 69</span></a>
</span><span id="SearchMolecularFormulas-70"><a href="#SearchMolecularFormulas-70"><span class="linenos"> 70</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-71"><a href="#SearchMolecularFormulas-71"><span class="linenos"> 71</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-72"><a href="#SearchMolecularFormulas-72"><span class="linenos"> 72</span></a>        <span class="n">mass_spectrum_obj</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-73"><a href="#SearchMolecularFormulas-73"><span class="linenos"> 73</span></a>        <span class="n">sql_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-74"><a href="#SearchMolecularFormulas-74"><span class="linenos"> 74</span></a>        <span class="n">first_hit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-75"><a href="#SearchMolecularFormulas-75"><span class="linenos"> 75</span></a>        <span class="n">find_isotopologues</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-76"><a href="#SearchMolecularFormulas-76"><span class="linenos"> 76</span></a>    <span class="p">):</span>
</span><span id="SearchMolecularFormulas-77"><a href="#SearchMolecularFormulas-77"><span class="linenos"> 77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">first_hit</span> <span class="o">=</span> <span class="n">first_hit</span>
</span><span id="SearchMolecularFormulas-78"><a href="#SearchMolecularFormulas-78"><span class="linenos"> 78</span></a>
</span><span id="SearchMolecularFormulas-79"><a href="#SearchMolecularFormulas-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span> <span class="o">=</span> <span class="n">find_isotopologues</span>
</span><span id="SearchMolecularFormulas-80"><a href="#SearchMolecularFormulas-80"><span class="linenos"> 80</span></a>
</span><span id="SearchMolecularFormulas-81"><a href="#SearchMolecularFormulas-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span> <span class="o">=</span> <span class="n">mass_spectrum_obj</span>
</span><span id="SearchMolecularFormulas-82"><a href="#SearchMolecularFormulas-82"><span class="linenos"> 82</span></a>
</span><span id="SearchMolecularFormulas-83"><a href="#SearchMolecularFormulas-83"><span class="linenos"> 83</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sql_db</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-84"><a href="#SearchMolecularFormulas-84"><span class="linenos"> 84</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span> <span class="o">=</span> <span class="n">MolForm_SQL</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-85"><a href="#SearchMolecularFormulas-85"><span class="linenos"> 85</span></a>                <span class="n">url</span><span class="o">=</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">url_database</span>
</span><span id="SearchMolecularFormulas-86"><a href="#SearchMolecularFormulas-86"><span class="linenos"> 86</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulas-87"><a href="#SearchMolecularFormulas-87"><span class="linenos"> 87</span></a>
</span><span id="SearchMolecularFormulas-88"><a href="#SearchMolecularFormulas-88"><span class="linenos"> 88</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-89"><a href="#SearchMolecularFormulas-89"><span class="linenos"> 89</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span> <span class="o">=</span> <span class="n">sql_db</span>
</span><span id="SearchMolecularFormulas-90"><a href="#SearchMolecularFormulas-90"><span class="linenos"> 90</span></a>
</span><span id="SearchMolecularFormulas-91"><a href="#SearchMolecularFormulas-91"><span class="linenos"> 91</span></a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SearchMolecularFormulas-92"><a href="#SearchMolecularFormulas-92"><span class="linenos"> 92</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Open the SQL database connection.&quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas-93"><a href="#SearchMolecularFormulas-93"><span class="linenos"> 93</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="SearchMolecularFormulas-94"><a href="#SearchMolecularFormulas-94"><span class="linenos"> 94</span></a>
</span><span id="SearchMolecularFormulas-95"><a href="#SearchMolecularFormulas-95"><span class="linenos"> 95</span></a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
</span><span id="SearchMolecularFormulas-96"><a href="#SearchMolecularFormulas-96"><span class="linenos"> 96</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the SQL database connection.&quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas-97"><a href="#SearchMolecularFormulas-97"><span class="linenos"> 97</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="SearchMolecularFormulas-98"><a href="#SearchMolecularFormulas-98"><span class="linenos"> 98</span></a>
</span><span id="SearchMolecularFormulas-99"><a href="#SearchMolecularFormulas-99"><span class="linenos"> 99</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="SearchMolecularFormulas-100"><a href="#SearchMolecularFormulas-100"><span class="linenos">100</span></a>
</span><span id="SearchMolecularFormulas-101"><a href="#SearchMolecularFormulas-101"><span class="linenos">101</span></a>    <span class="k">def</span> <span class="nf">run_search</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-102"><a href="#SearchMolecularFormulas-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-103"><a href="#SearchMolecularFormulas-103"><span class="linenos">103</span></a>        <span class="n">mspeaks</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-104"><a href="#SearchMolecularFormulas-104"><span class="linenos">104</span></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-105"><a href="#SearchMolecularFormulas-105"><span class="linenos">105</span></a>        <span class="n">min_abundance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-106"><a href="#SearchMolecularFormulas-106"><span class="linenos">106</span></a>        <span class="n">ion_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-107"><a href="#SearchMolecularFormulas-107"><span class="linenos">107</span></a>        <span class="n">ion_charge</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-108"><a href="#SearchMolecularFormulas-108"><span class="linenos">108</span></a>        <span class="n">adduct_atom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-109"><a href="#SearchMolecularFormulas-109"><span class="linenos">109</span></a>    <span class="p">):</span>
</span><span id="SearchMolecularFormulas-110"><a href="#SearchMolecularFormulas-110"><span class="linenos">110</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the molecular formula search.</span>
</span><span id="SearchMolecularFormulas-111"><a href="#SearchMolecularFormulas-111"><span class="linenos">111</span></a>
</span><span id="SearchMolecularFormulas-112"><a href="#SearchMolecularFormulas-112"><span class="linenos">112</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulas-113"><a href="#SearchMolecularFormulas-113"><span class="linenos">113</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulas-114"><a href="#SearchMolecularFormulas-114"><span class="linenos">114</span></a><span class="sd">        mspeaks : list of MSPeak</span>
</span><span id="SearchMolecularFormulas-115"><a href="#SearchMolecularFormulas-115"><span class="linenos">115</span></a><span class="sd">            The list of mass spectrum peaks.</span>
</span><span id="SearchMolecularFormulas-116"><a href="#SearchMolecularFormulas-116"><span class="linenos">116</span></a><span class="sd">        query : dict</span>
</span><span id="SearchMolecularFormulas-117"><a href="#SearchMolecularFormulas-117"><span class="linenos">117</span></a><span class="sd">            The query dictionary containing the possible molecular formulas.</span>
</span><span id="SearchMolecularFormulas-118"><a href="#SearchMolecularFormulas-118"><span class="linenos">118</span></a><span class="sd">        min_abundance : float</span>
</span><span id="SearchMolecularFormulas-119"><a href="#SearchMolecularFormulas-119"><span class="linenos">119</span></a><span class="sd">            The minimum abundance threshold.</span>
</span><span id="SearchMolecularFormulas-120"><a href="#SearchMolecularFormulas-120"><span class="linenos">120</span></a><span class="sd">        ion_type : str</span>
</span><span id="SearchMolecularFormulas-121"><a href="#SearchMolecularFormulas-121"><span class="linenos">121</span></a><span class="sd">            The ion type.</span>
</span><span id="SearchMolecularFormulas-122"><a href="#SearchMolecularFormulas-122"><span class="linenos">122</span></a><span class="sd">        ion_charge : int</span>
</span><span id="SearchMolecularFormulas-123"><a href="#SearchMolecularFormulas-123"><span class="linenos">123</span></a><span class="sd">            The ion charge.</span>
</span><span id="SearchMolecularFormulas-124"><a href="#SearchMolecularFormulas-124"><span class="linenos">124</span></a><span class="sd">        adduct_atom : str, optional</span>
</span><span id="SearchMolecularFormulas-125"><a href="#SearchMolecularFormulas-125"><span class="linenos">125</span></a><span class="sd">            The adduct atom, by default None.</span>
</span><span id="SearchMolecularFormulas-126"><a href="#SearchMolecularFormulas-126"><span class="linenos">126</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas-127"><a href="#SearchMolecularFormulas-127"><span class="linenos">127</span></a>
</span><span id="SearchMolecularFormulas-128"><a href="#SearchMolecularFormulas-128"><span class="linenos">128</span></a>        <span class="k">def</span> <span class="nf">get_formulas</span><span class="p">(</span><span class="n">nominal_overlay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
</span><span id="SearchMolecularFormulas-129"><a href="#SearchMolecularFormulas-129"><span class="linenos">129</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas-130"><a href="#SearchMolecularFormulas-130"><span class="linenos">130</span></a><span class="sd">            Get the list of formulas based on the nominal overlay.</span>
</span><span id="SearchMolecularFormulas-131"><a href="#SearchMolecularFormulas-131"><span class="linenos">131</span></a>
</span><span id="SearchMolecularFormulas-132"><a href="#SearchMolecularFormulas-132"><span class="linenos">132</span></a><span class="sd">            Parameters</span>
</span><span id="SearchMolecularFormulas-133"><a href="#SearchMolecularFormulas-133"><span class="linenos">133</span></a><span class="sd">            ----------</span>
</span><span id="SearchMolecularFormulas-134"><a href="#SearchMolecularFormulas-134"><span class="linenos">134</span></a><span class="sd">            nominal_overlay : float, optional</span>
</span><span id="SearchMolecularFormulas-135"><a href="#SearchMolecularFormulas-135"><span class="linenos">135</span></a><span class="sd">                The nominal overlay, by default 0.1.</span>
</span><span id="SearchMolecularFormulas-136"><a href="#SearchMolecularFormulas-136"><span class="linenos">136</span></a>
</span><span id="SearchMolecularFormulas-137"><a href="#SearchMolecularFormulas-137"><span class="linenos">137</span></a><span class="sd">            Returns</span>
</span><span id="SearchMolecularFormulas-138"><a href="#SearchMolecularFormulas-138"><span class="linenos">138</span></a><span class="sd">            -------</span>
</span><span id="SearchMolecularFormulas-139"><a href="#SearchMolecularFormulas-139"><span class="linenos">139</span></a><span class="sd">            list</span>
</span><span id="SearchMolecularFormulas-140"><a href="#SearchMolecularFormulas-140"><span class="linenos">140</span></a><span class="sd">                The list of formulas.</span>
</span><span id="SearchMolecularFormulas-141"><a href="#SearchMolecularFormulas-141"><span class="linenos">141</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas-142"><a href="#SearchMolecularFormulas-142"><span class="linenos">142</span></a>            <span class="n">nominal_mz</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">nominal_mz_exp</span>
</span><span id="SearchMolecularFormulas-143"><a href="#SearchMolecularFormulas-143"><span class="linenos">143</span></a>
</span><span id="SearchMolecularFormulas-144"><a href="#SearchMolecularFormulas-144"><span class="linenos">144</span></a>            <span class="n">defect_mass</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">-</span> <span class="n">nominal_mz</span>
</span><span id="SearchMolecularFormulas-145"><a href="#SearchMolecularFormulas-145"><span class="linenos">145</span></a>            <span class="n">nominal_masses</span> <span class="o">=</span> <span class="p">[</span><span class="n">nominal_mz</span><span class="p">]</span>
</span><span id="SearchMolecularFormulas-146"><a href="#SearchMolecularFormulas-146"><span class="linenos">146</span></a>
</span><span id="SearchMolecularFormulas-147"><a href="#SearchMolecularFormulas-147"><span class="linenos">147</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">defect_mass</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">nominal_overlay</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-148"><a href="#SearchMolecularFormulas-148"><span class="linenos">148</span></a>                <span class="n">nominal_masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nominal_mz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas-149"><a href="#SearchMolecularFormulas-149"><span class="linenos">149</span></a>            <span class="k">elif</span> <span class="p">(</span><span class="n">defect_mass</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">nominal_overlay</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-150"><a href="#SearchMolecularFormulas-150"><span class="linenos">150</span></a>                <span class="n">nominal_masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nominal_mz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas-151"><a href="#SearchMolecularFormulas-151"><span class="linenos">151</span></a>
</span><span id="SearchMolecularFormulas-152"><a href="#SearchMolecularFormulas-152"><span class="linenos">152</span></a>            <span class="n">list_formulas_candidates</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SearchMolecularFormulas-153"><a href="#SearchMolecularFormulas-153"><span class="linenos">153</span></a>
</span><span id="SearchMolecularFormulas-154"><a href="#SearchMolecularFormulas-154"><span class="linenos">154</span></a>            <span class="k">for</span> <span class="n">nominal_mass</span> <span class="ow">in</span> <span class="n">nominal_masses</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-155"><a href="#SearchMolecularFormulas-155"><span class="linenos">155</span></a>                <span class="k">if</span> <span class="n">nominal_mass</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="SearchMolecularFormulas-156"><a href="#SearchMolecularFormulas-156"><span class="linenos">156</span></a>                    <span class="n">list_formulas_candidates</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nominal_mass</span><span class="p">))</span>
</span><span id="SearchMolecularFormulas-157"><a href="#SearchMolecularFormulas-157"><span class="linenos">157</span></a>
</span><span id="SearchMolecularFormulas-158"><a href="#SearchMolecularFormulas-158"><span class="linenos">158</span></a>            <span class="k">return</span> <span class="n">list_formulas_candidates</span>
</span><span id="SearchMolecularFormulas-159"><a href="#SearchMolecularFormulas-159"><span class="linenos">159</span></a>
</span><span id="SearchMolecularFormulas-160"><a href="#SearchMolecularFormulas-160"><span class="linenos">160</span></a>        <span class="n">all_assigned_indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span><span id="SearchMolecularFormulas-161"><a href="#SearchMolecularFormulas-161"><span class="linenos">161</span></a>
</span><span id="SearchMolecularFormulas-162"><a href="#SearchMolecularFormulas-162"><span class="linenos">162</span></a>        <span class="c1"># molecular_search_settings = self.mass_spectrum_obj.molecular_search_settings</span>
</span><span id="SearchMolecularFormulas-163"><a href="#SearchMolecularFormulas-163"><span class="linenos">163</span></a>
</span><span id="SearchMolecularFormulas-164"><a href="#SearchMolecularFormulas-164"><span class="linenos">164</span></a>        <span class="n">search_molfrom</span> <span class="o">=</span> <span class="n">SearchMolecularFormulaWorker</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-165"><a href="#SearchMolecularFormulas-165"><span class="linenos">165</span></a>            <span class="n">find_isotopologues</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span>
</span><span id="SearchMolecularFormulas-166"><a href="#SearchMolecularFormulas-166"><span class="linenos">166</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas-167"><a href="#SearchMolecularFormulas-167"><span class="linenos">167</span></a>
</span><span id="SearchMolecularFormulas-168"><a href="#SearchMolecularFormulas-168"><span class="linenos">168</span></a>        <span class="k">for</span> <span class="n">ms_peak</span> <span class="ow">in</span> <span class="n">mspeaks</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-169"><a href="#SearchMolecularFormulas-169"><span class="linenos">169</span></a>            <span class="c1"># already assigned a molecular formula</span>
</span><span id="SearchMolecularFormulas-170"><a href="#SearchMolecularFormulas-170"><span class="linenos">170</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_hit</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-171"><a href="#SearchMolecularFormulas-171"><span class="linenos">171</span></a>                <span class="k">if</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">is_assigned</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-172"><a href="#SearchMolecularFormulas-172"><span class="linenos">172</span></a>                    <span class="k">continue</span>
</span><span id="SearchMolecularFormulas-173"><a href="#SearchMolecularFormulas-173"><span class="linenos">173</span></a>
</span><span id="SearchMolecularFormulas-174"><a href="#SearchMolecularFormulas-174"><span class="linenos">174</span></a>            <span class="n">ms_peak_indexes</span> <span class="o">=</span> <span class="n">search_molfrom</span><span class="o">.</span><span class="n">find_formulas</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-175"><a href="#SearchMolecularFormulas-175"><span class="linenos">175</span></a>                <span class="n">get_formulas</span><span class="p">(),</span>
</span><span id="SearchMolecularFormulas-176"><a href="#SearchMolecularFormulas-176"><span class="linenos">176</span></a>                <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-177"><a href="#SearchMolecularFormulas-177"><span class="linenos">177</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-178"><a href="#SearchMolecularFormulas-178"><span class="linenos">178</span></a>                <span class="n">ms_peak</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-179"><a href="#SearchMolecularFormulas-179"><span class="linenos">179</span></a>                <span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-180"><a href="#SearchMolecularFormulas-180"><span class="linenos">180</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-181"><a href="#SearchMolecularFormulas-181"><span class="linenos">181</span></a>                <span class="n">adduct_atom</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-182"><a href="#SearchMolecularFormulas-182"><span class="linenos">182</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulas-183"><a href="#SearchMolecularFormulas-183"><span class="linenos">183</span></a>
</span><span id="SearchMolecularFormulas-184"><a href="#SearchMolecularFormulas-184"><span class="linenos">184</span></a>            <span class="n">all_assigned_indexes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ms_peak_indexes</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas-185"><a href="#SearchMolecularFormulas-185"><span class="linenos">185</span></a>
</span><span id="SearchMolecularFormulas-186"><a href="#SearchMolecularFormulas-186"><span class="linenos">186</span></a>        <span class="c1"># all_assigned_indexes = MolecularFormulaSearchFilters().filter_isotopologue(all_assigned_indexes, self.mass_spectrum_obj)</span>
</span><span id="SearchMolecularFormulas-187"><a href="#SearchMolecularFormulas-187"><span class="linenos">187</span></a>
</span><span id="SearchMolecularFormulas-188"><a href="#SearchMolecularFormulas-188"><span class="linenos">188</span></a>        <span class="c1"># all_assigned_indexes = MolecularFormulaSearchFilters().filter_kendrick(all_assigned_indexes, self.mass_spectrum_obj)</span>
</span><span id="SearchMolecularFormulas-189"><a href="#SearchMolecularFormulas-189"><span class="linenos">189</span></a>
</span><span id="SearchMolecularFormulas-190"><a href="#SearchMolecularFormulas-190"><span class="linenos">190</span></a>        <span class="c1"># MolecularFormulaSearchFilters().check_min_peaks(all_assigned_indexes, self.mass_spectrum_obj)</span>
</span><span id="SearchMolecularFormulas-191"><a href="#SearchMolecularFormulas-191"><span class="linenos">191</span></a>        <span class="c1"># filter per min peaks per mono isotopic class</span>
</span><span id="SearchMolecularFormulas-192"><a href="#SearchMolecularFormulas-192"><span class="linenos">192</span></a>
</span><span id="SearchMolecularFormulas-193"><a href="#SearchMolecularFormulas-193"><span class="linenos">193</span></a>    <span class="k">def</span> <span class="nf">run_worker_mass_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SearchMolecularFormulas-194"><a href="#SearchMolecularFormulas-194"><span class="linenos">194</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the molecular formula search on the mass spectrum object.&quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas-195"><a href="#SearchMolecularFormulas-195"><span class="linenos">195</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_molecular_formula</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-196"><a href="#SearchMolecularFormulas-196"><span class="linenos">196</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">sort_by_abundance</span><span class="p">(),</span> 
</span><span id="SearchMolecularFormulas-197"><a href="#SearchMolecularFormulas-197"><span class="linenos">197</span></a>            <span class="n">print_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="SearchMolecularFormulas-198"><a href="#SearchMolecularFormulas-198"><span class="linenos">198</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulas-199"><a href="#SearchMolecularFormulas-199"><span class="linenos">199</span></a>
</span><span id="SearchMolecularFormulas-200"><a href="#SearchMolecularFormulas-200"><span class="linenos">200</span></a>    <span class="k">def</span> <span class="nf">run_worker_ms_peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms_peaks</span><span class="p">):</span>
</span><span id="SearchMolecularFormulas-201"><a href="#SearchMolecularFormulas-201"><span class="linenos">201</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the molecular formula search on the given list of mass spectrum peaks.</span>
</span><span id="SearchMolecularFormulas-202"><a href="#SearchMolecularFormulas-202"><span class="linenos">202</span></a>
</span><span id="SearchMolecularFormulas-203"><a href="#SearchMolecularFormulas-203"><span class="linenos">203</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulas-204"><a href="#SearchMolecularFormulas-204"><span class="linenos">204</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulas-205"><a href="#SearchMolecularFormulas-205"><span class="linenos">205</span></a><span class="sd">        ms_peaks : list of MSPeak</span>
</span><span id="SearchMolecularFormulas-206"><a href="#SearchMolecularFormulas-206"><span class="linenos">206</span></a><span class="sd">            The list of mass spectrum peaks.</span>
</span><span id="SearchMolecularFormulas-207"><a href="#SearchMolecularFormulas-207"><span class="linenos">207</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas-208"><a href="#SearchMolecularFormulas-208"><span class="linenos">208</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_molecular_formula</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-209"><a href="#SearchMolecularFormulas-209"><span class="linenos">209</span></a>            <span class="n">ms_peaks</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-210"><a href="#SearchMolecularFormulas-210"><span class="linenos">210</span></a>            <span class="n">print_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="SearchMolecularFormulas-211"><a href="#SearchMolecularFormulas-211"><span class="linenos">211</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas-212"><a href="#SearchMolecularFormulas-212"><span class="linenos">212</span></a>
</span><span id="SearchMolecularFormulas-213"><a href="#SearchMolecularFormulas-213"><span class="linenos">213</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SearchMolecularFormulas-214"><a href="#SearchMolecularFormulas-214"><span class="linenos">214</span></a>    <span class="k">def</span> <span class="nf">database_to_dict</span><span class="p">(</span><span class="n">classe_str_list</span><span class="p">,</span> <span class="n">nominal_mzs</span><span class="p">,</span> <span class="n">mf_search_settings</span><span class="p">,</span> <span class="n">ion_charge</span><span class="p">):</span>
</span><span id="SearchMolecularFormulas-215"><a href="#SearchMolecularFormulas-215"><span class="linenos">215</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert the database results to a dictionary.</span>
</span><span id="SearchMolecularFormulas-216"><a href="#SearchMolecularFormulas-216"><span class="linenos">216</span></a>
</span><span id="SearchMolecularFormulas-217"><a href="#SearchMolecularFormulas-217"><span class="linenos">217</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulas-218"><a href="#SearchMolecularFormulas-218"><span class="linenos">218</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulas-219"><a href="#SearchMolecularFormulas-219"><span class="linenos">219</span></a><span class="sd">        classe_str_list : list</span>
</span><span id="SearchMolecularFormulas-220"><a href="#SearchMolecularFormulas-220"><span class="linenos">220</span></a><span class="sd">            The list of class strings.</span>
</span><span id="SearchMolecularFormulas-221"><a href="#SearchMolecularFormulas-221"><span class="linenos">221</span></a><span class="sd">        nominal_mzs : list</span>
</span><span id="SearchMolecularFormulas-222"><a href="#SearchMolecularFormulas-222"><span class="linenos">222</span></a><span class="sd">            The list of nominal m/z values.</span>
</span><span id="SearchMolecularFormulas-223"><a href="#SearchMolecularFormulas-223"><span class="linenos">223</span></a><span class="sd">        mf_search_settings : MolecularFormulaSearchSettings</span>
</span><span id="SearchMolecularFormulas-224"><a href="#SearchMolecularFormulas-224"><span class="linenos">224</span></a><span class="sd">            The molecular formula search settings.</span>
</span><span id="SearchMolecularFormulas-225"><a href="#SearchMolecularFormulas-225"><span class="linenos">225</span></a><span class="sd">        ion_charge : int</span>
</span><span id="SearchMolecularFormulas-226"><a href="#SearchMolecularFormulas-226"><span class="linenos">226</span></a><span class="sd">            The ion charge.</span>
</span><span id="SearchMolecularFormulas-227"><a href="#SearchMolecularFormulas-227"><span class="linenos">227</span></a>
</span><span id="SearchMolecularFormulas-228"><a href="#SearchMolecularFormulas-228"><span class="linenos">228</span></a><span class="sd">        Returns</span>
</span><span id="SearchMolecularFormulas-229"><a href="#SearchMolecularFormulas-229"><span class="linenos">229</span></a><span class="sd">        -------</span>
</span><span id="SearchMolecularFormulas-230"><a href="#SearchMolecularFormulas-230"><span class="linenos">230</span></a><span class="sd">        dict</span>
</span><span id="SearchMolecularFormulas-231"><a href="#SearchMolecularFormulas-231"><span class="linenos">231</span></a><span class="sd">            The dictionary containing the database results.</span>
</span><span id="SearchMolecularFormulas-232"><a href="#SearchMolecularFormulas-232"><span class="linenos">232</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas-233"><a href="#SearchMolecularFormulas-233"><span class="linenos">233</span></a>        <span class="n">sql_db</span> <span class="o">=</span> <span class="n">MolForm_SQL</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">mf_search_settings</span><span class="o">.</span><span class="n">url_database</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas-234"><a href="#SearchMolecularFormulas-234"><span class="linenos">234</span></a>
</span><span id="SearchMolecularFormulas-235"><a href="#SearchMolecularFormulas-235"><span class="linenos">235</span></a>        <span class="n">dict_res</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SearchMolecularFormulas-236"><a href="#SearchMolecularFormulas-236"><span class="linenos">236</span></a>
</span><span id="SearchMolecularFormulas-237"><a href="#SearchMolecularFormulas-237"><span class="linenos">237</span></a>        <span class="k">if</span> <span class="n">mf_search_settings</span><span class="o">.</span><span class="n">isProtonated</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-238"><a href="#SearchMolecularFormulas-238"><span class="linenos">238</span></a>            <span class="n">dict_res</span><span class="p">[</span><span class="n">Labels</span><span class="o">.</span><span class="n">protonated_de_ion</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql_db</span><span class="o">.</span><span class="n">get_dict_by_classes</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-239"><a href="#SearchMolecularFormulas-239"><span class="linenos">239</span></a>                <span class="n">classe_str_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-240"><a href="#SearchMolecularFormulas-240"><span class="linenos">240</span></a>                <span class="n">Labels</span><span class="o">.</span><span class="n">protonated_de_ion</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-241"><a href="#SearchMolecularFormulas-241"><span class="linenos">241</span></a>                <span class="n">nominal_mzs</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-242"><a href="#SearchMolecularFormulas-242"><span class="linenos">242</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-243"><a href="#SearchMolecularFormulas-243"><span class="linenos">243</span></a>                <span class="n">mf_search_settings</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-244"><a href="#SearchMolecularFormulas-244"><span class="linenos">244</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulas-245"><a href="#SearchMolecularFormulas-245"><span class="linenos">245</span></a>
</span><span id="SearchMolecularFormulas-246"><a href="#SearchMolecularFormulas-246"><span class="linenos">246</span></a>        <span class="k">if</span> <span class="n">mf_search_settings</span><span class="o">.</span><span class="n">isRadical</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-247"><a href="#SearchMolecularFormulas-247"><span class="linenos">247</span></a>            <span class="n">dict_res</span><span class="p">[</span><span class="n">Labels</span><span class="o">.</span><span class="n">radical_ion</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql_db</span><span class="o">.</span><span class="n">get_dict_by_classes</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-248"><a href="#SearchMolecularFormulas-248"><span class="linenos">248</span></a>                <span class="n">classe_str_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-249"><a href="#SearchMolecularFormulas-249"><span class="linenos">249</span></a>                <span class="n">Labels</span><span class="o">.</span><span class="n">radical_ion</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-250"><a href="#SearchMolecularFormulas-250"><span class="linenos">250</span></a>                <span class="n">nominal_mzs</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-251"><a href="#SearchMolecularFormulas-251"><span class="linenos">251</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-252"><a href="#SearchMolecularFormulas-252"><span class="linenos">252</span></a>                <span class="n">mf_search_settings</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-253"><a href="#SearchMolecularFormulas-253"><span class="linenos">253</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulas-254"><a href="#SearchMolecularFormulas-254"><span class="linenos">254</span></a>
</span><span id="SearchMolecularFormulas-255"><a href="#SearchMolecularFormulas-255"><span class="linenos">255</span></a>        <span class="k">if</span> <span class="n">mf_search_settings</span><span class="o">.</span><span class="n">isAdduct</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-256"><a href="#SearchMolecularFormulas-256"><span class="linenos">256</span></a>            <span class="n">adduct_list</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulas-257"><a href="#SearchMolecularFormulas-257"><span class="linenos">257</span></a>                <span class="n">mf_search_settings</span><span class="o">.</span><span class="n">adduct_atoms_neg</span>
</span><span id="SearchMolecularFormulas-258"><a href="#SearchMolecularFormulas-258"><span class="linenos">258</span></a>                <span class="k">if</span> <span class="n">ion_charge</span> <span class="o">&lt;</span> <span class="mi">0</span>
</span><span id="SearchMolecularFormulas-259"><a href="#SearchMolecularFormulas-259"><span class="linenos">259</span></a>                <span class="k">else</span> <span class="n">mf_search_settings</span><span class="o">.</span><span class="n">adduct_atoms_pos</span>
</span><span id="SearchMolecularFormulas-260"><a href="#SearchMolecularFormulas-260"><span class="linenos">260</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulas-261"><a href="#SearchMolecularFormulas-261"><span class="linenos">261</span></a>            <span class="n">dict_res</span><span class="p">[</span><span class="n">Labels</span><span class="o">.</span><span class="n">adduct_ion</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql_db</span><span class="o">.</span><span class="n">get_dict_by_classes</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-262"><a href="#SearchMolecularFormulas-262"><span class="linenos">262</span></a>                <span class="n">classe_str_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-263"><a href="#SearchMolecularFormulas-263"><span class="linenos">263</span></a>                <span class="n">Labels</span><span class="o">.</span><span class="n">adduct_ion</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-264"><a href="#SearchMolecularFormulas-264"><span class="linenos">264</span></a>                <span class="n">nominal_mzs</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-265"><a href="#SearchMolecularFormulas-265"><span class="linenos">265</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-266"><a href="#SearchMolecularFormulas-266"><span class="linenos">266</span></a>                <span class="n">mf_search_settings</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-267"><a href="#SearchMolecularFormulas-267"><span class="linenos">267</span></a>                <span class="n">adducts</span><span class="o">=</span><span class="n">adduct_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-268"><a href="#SearchMolecularFormulas-268"><span class="linenos">268</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulas-269"><a href="#SearchMolecularFormulas-269"><span class="linenos">269</span></a>
</span><span id="SearchMolecularFormulas-270"><a href="#SearchMolecularFormulas-270"><span class="linenos">270</span></a>        <span class="k">return</span> <span class="n">dict_res</span>
</span><span id="SearchMolecularFormulas-271"><a href="#SearchMolecularFormulas-271"><span class="linenos">271</span></a>
</span><span id="SearchMolecularFormulas-272"><a href="#SearchMolecularFormulas-272"><span class="linenos">272</span></a>    <span class="nd">@timeit</span><span class="p">(</span><span class="n">print_time</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas-273"><a href="#SearchMolecularFormulas-273"><span class="linenos">273</span></a>    <span class="k">def</span> <span class="nf">run_molecular_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms_peaks</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="SearchMolecularFormulas-274"><a href="#SearchMolecularFormulas-274"><span class="linenos">274</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the molecular formula search on the given list of mass spectrum peaks.</span>
</span><span id="SearchMolecularFormulas-275"><a href="#SearchMolecularFormulas-275"><span class="linenos">275</span></a>
</span><span id="SearchMolecularFormulas-276"><a href="#SearchMolecularFormulas-276"><span class="linenos">276</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulas-277"><a href="#SearchMolecularFormulas-277"><span class="linenos">277</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulas-278"><a href="#SearchMolecularFormulas-278"><span class="linenos">278</span></a><span class="sd">        ms_peaks : list of MSPeak</span>
</span><span id="SearchMolecularFormulas-279"><a href="#SearchMolecularFormulas-279"><span class="linenos">279</span></a><span class="sd">            The list of mass spectrum peaks.</span>
</span><span id="SearchMolecularFormulas-280"><a href="#SearchMolecularFormulas-280"><span class="linenos">280</span></a><span class="sd">        **kwargs</span>
</span><span id="SearchMolecularFormulas-281"><a href="#SearchMolecularFormulas-281"><span class="linenos">281</span></a><span class="sd">            Additional keyword arguments. </span>
</span><span id="SearchMolecularFormulas-282"><a href="#SearchMolecularFormulas-282"><span class="linenos">282</span></a><span class="sd">            Most notably, print_time, which is a boolean flag to indicate whether to print the time </span>
</span><span id="SearchMolecularFormulas-283"><a href="#SearchMolecularFormulas-283"><span class="linenos">283</span></a><span class="sd">            and passed to the timeit decorator.</span>
</span><span id="SearchMolecularFormulas-284"><a href="#SearchMolecularFormulas-284"><span class="linenos">284</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas-285"><a href="#SearchMolecularFormulas-285"><span class="linenos">285</span></a>        <span class="n">ion_charge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">polarity</span>
</span><span id="SearchMolecularFormulas-286"><a href="#SearchMolecularFormulas-286"><span class="linenos">286</span></a>        <span class="n">min_abundance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">min_abundance</span>
</span><span id="SearchMolecularFormulas-287"><a href="#SearchMolecularFormulas-287"><span class="linenos">287</span></a>        <span class="n">nominal_mzs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">nominal_mz</span>
</span><span id="SearchMolecularFormulas-288"><a href="#SearchMolecularFormulas-288"><span class="linenos">288</span></a>
</span><span id="SearchMolecularFormulas-289"><a href="#SearchMolecularFormulas-289"><span class="linenos">289</span></a>        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="SearchMolecularFormulas-290"><a href="#SearchMolecularFormulas-290"><span class="linenos">290</span></a>        <span class="c1"># reset average error, only relevant is average mass error method is being used</span>
</span><span id="SearchMolecularFormulas-291"><a href="#SearchMolecularFormulas-291"><span class="linenos">291</span></a>        <span class="n">SearchMolecularFormulaWorker</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-292"><a href="#SearchMolecularFormulas-292"><span class="linenos">292</span></a>            <span class="n">find_isotopologues</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span>
</span><span id="SearchMolecularFormulas-293"><a href="#SearchMolecularFormulas-293"><span class="linenos">293</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">reset_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas-294"><a href="#SearchMolecularFormulas-294"><span class="linenos">294</span></a>
</span><span id="SearchMolecularFormulas-295"><a href="#SearchMolecularFormulas-295"><span class="linenos">295</span></a>        <span class="c1"># check database for all possible molecular formula combinations based on the setting passed to self.mass_spectrum_obj.molecular_search_settings</span>
</span><span id="SearchMolecularFormulas-296"><a href="#SearchMolecularFormulas-296"><span class="linenos">296</span></a>        <span class="n">classes</span> <span class="o">=</span> <span class="n">MolecularCombinations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="p">)</span><span class="o">.</span><span class="n">runworker</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-297"><a href="#SearchMolecularFormulas-297"><span class="linenos">297</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-298"><a href="#SearchMolecularFormulas-298"><span class="linenos">298</span></a>            <span class="n">print_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="SearchMolecularFormulas-299"><a href="#SearchMolecularFormulas-299"><span class="linenos">299</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas-300"><a href="#SearchMolecularFormulas-300"><span class="linenos">300</span></a>
</span><span id="SearchMolecularFormulas-301"><a href="#SearchMolecularFormulas-301"><span class="linenos">301</span></a>        <span class="c1"># split the database load to not blowout the memory</span>
</span><span id="SearchMolecularFormulas-302"><a href="#SearchMolecularFormulas-302"><span class="linenos">302</span></a>        <span class="c1"># TODO add to the settings</span>
</span><span id="SearchMolecularFormulas-303"><a href="#SearchMolecularFormulas-303"><span class="linenos">303</span></a>        <span class="k">for</span> <span class="n">classe_chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-304"><a href="#SearchMolecularFormulas-304"><span class="linenos">304</span></a>            <span class="n">classes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">db_chunk_size</span>
</span><span id="SearchMolecularFormulas-305"><a href="#SearchMolecularFormulas-305"><span class="linenos">305</span></a>        <span class="p">):</span>
</span><span id="SearchMolecularFormulas-306"><a href="#SearchMolecularFormulas-306"><span class="linenos">306</span></a>            <span class="n">classes_str_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">class_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">class_tuple</span> <span class="ow">in</span> <span class="n">classe_chunk</span><span class="p">]</span>
</span><span id="SearchMolecularFormulas-307"><a href="#SearchMolecularFormulas-307"><span class="linenos">307</span></a>
</span><span id="SearchMolecularFormulas-308"><a href="#SearchMolecularFormulas-308"><span class="linenos">308</span></a>            <span class="c1"># load the molecular formula objs binned by ion type and heteroatoms classes, {ion type:{classe:[list_formula]}}</span>
</span><span id="SearchMolecularFormulas-309"><a href="#SearchMolecularFormulas-309"><span class="linenos">309</span></a>            <span class="c1"># for adduct ion type a third key is added {atoms:{ion type:{classe:[list_formula]}}}</span>
</span><span id="SearchMolecularFormulas-310"><a href="#SearchMolecularFormulas-310"><span class="linenos">310</span></a>            <span class="n">dict_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_to_dict</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-311"><a href="#SearchMolecularFormulas-311"><span class="linenos">311</span></a>                <span class="n">classes_str_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-312"><a href="#SearchMolecularFormulas-312"><span class="linenos">312</span></a>                <span class="n">nominal_mzs</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-313"><a href="#SearchMolecularFormulas-313"><span class="linenos">313</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-314"><a href="#SearchMolecularFormulas-314"><span class="linenos">314</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-315"><a href="#SearchMolecularFormulas-315"><span class="linenos">315</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulas-316"><a href="#SearchMolecularFormulas-316"><span class="linenos">316</span></a>            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">classe_chunk</span><span class="p">,</span> <span class="n">disable</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas-317"><a href="#SearchMolecularFormulas-317"><span class="linenos">317</span></a>            <span class="k">for</span> <span class="n">classe_tuple</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-318"><a href="#SearchMolecularFormulas-318"><span class="linenos">318</span></a>                <span class="c1"># class string is a json serialized dict</span>
</span><span id="SearchMolecularFormulas-319"><a href="#SearchMolecularFormulas-319"><span class="linenos">319</span></a>                <span class="n">classe_str</span> <span class="o">=</span> <span class="n">classe_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SearchMolecularFormulas-320"><a href="#SearchMolecularFormulas-320"><span class="linenos">320</span></a>                <span class="n">classe_dict</span> <span class="o">=</span> <span class="n">classe_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SearchMolecularFormulas-321"><a href="#SearchMolecularFormulas-321"><span class="linenos">321</span></a>
</span><span id="SearchMolecularFormulas-322"><a href="#SearchMolecularFormulas-322"><span class="linenos">322</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">isProtonated</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-323"><a href="#SearchMolecularFormulas-323"><span class="linenos">323</span></a>                    <span class="n">ion_type</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">protonated_de_ion</span>
</span><span id="SearchMolecularFormulas-324"><a href="#SearchMolecularFormulas-324"><span class="linenos">324</span></a>                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-325"><a href="#SearchMolecularFormulas-325"><span class="linenos">325</span></a>                        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description_str</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-326"><a href="#SearchMolecularFormulas-326"><span class="linenos">326</span></a>                            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Started molecular formula search for class </span><span class="si">%s</span><span class="s2">, (de)protonated &quot;</span>
</span><span id="SearchMolecularFormulas-327"><a href="#SearchMolecularFormulas-327"><span class="linenos">327</span></a>                            <span class="o">%</span> <span class="n">classe_str</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-328"><a href="#SearchMolecularFormulas-328"><span class="linenos">328</span></a>                            <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-329"><a href="#SearchMolecularFormulas-329"><span class="linenos">329</span></a>                        <span class="p">)</span>
</span><span id="SearchMolecularFormulas-330"><a href="#SearchMolecularFormulas-330"><span class="linenos">330</span></a>
</span><span id="SearchMolecularFormulas-331"><a href="#SearchMolecularFormulas-331"><span class="linenos">331</span></a>                    <span class="n">candidate_formulas</span> <span class="o">=</span> <span class="n">dict_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ion_type</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">classe_str</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas-332"><a href="#SearchMolecularFormulas-332"><span class="linenos">332</span></a>
</span><span id="SearchMolecularFormulas-333"><a href="#SearchMolecularFormulas-333"><span class="linenos">333</span></a>                    <span class="k">if</span> <span class="n">candidate_formulas</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-334"><a href="#SearchMolecularFormulas-334"><span class="linenos">334</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">run_search</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-335"><a href="#SearchMolecularFormulas-335"><span class="linenos">335</span></a>                            <span class="n">ms_peaks</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-336"><a href="#SearchMolecularFormulas-336"><span class="linenos">336</span></a>                            <span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-337"><a href="#SearchMolecularFormulas-337"><span class="linenos">337</span></a>                            <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-338"><a href="#SearchMolecularFormulas-338"><span class="linenos">338</span></a>                            <span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-339"><a href="#SearchMolecularFormulas-339"><span class="linenos">339</span></a>                            <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-340"><a href="#SearchMolecularFormulas-340"><span class="linenos">340</span></a>                        <span class="p">)</span>
</span><span id="SearchMolecularFormulas-341"><a href="#SearchMolecularFormulas-341"><span class="linenos">341</span></a>
</span><span id="SearchMolecularFormulas-342"><a href="#SearchMolecularFormulas-342"><span class="linenos">342</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">isRadical</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-343"><a href="#SearchMolecularFormulas-343"><span class="linenos">343</span></a>                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-344"><a href="#SearchMolecularFormulas-344"><span class="linenos">344</span></a>                        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description_str</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-345"><a href="#SearchMolecularFormulas-345"><span class="linenos">345</span></a>                            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Started molecular formula search for class </span><span class="si">%s</span><span class="s2">, radical &quot;</span>
</span><span id="SearchMolecularFormulas-346"><a href="#SearchMolecularFormulas-346"><span class="linenos">346</span></a>                            <span class="o">%</span> <span class="n">classe_str</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-347"><a href="#SearchMolecularFormulas-347"><span class="linenos">347</span></a>                            <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-348"><a href="#SearchMolecularFormulas-348"><span class="linenos">348</span></a>                        <span class="p">)</span>
</span><span id="SearchMolecularFormulas-349"><a href="#SearchMolecularFormulas-349"><span class="linenos">349</span></a>
</span><span id="SearchMolecularFormulas-350"><a href="#SearchMolecularFormulas-350"><span class="linenos">350</span></a>                    <span class="n">ion_type</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">radical_ion</span>
</span><span id="SearchMolecularFormulas-351"><a href="#SearchMolecularFormulas-351"><span class="linenos">351</span></a>
</span><span id="SearchMolecularFormulas-352"><a href="#SearchMolecularFormulas-352"><span class="linenos">352</span></a>                    <span class="n">candidate_formulas</span> <span class="o">=</span> <span class="n">dict_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ion_type</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">classe_str</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas-353"><a href="#SearchMolecularFormulas-353"><span class="linenos">353</span></a>
</span><span id="SearchMolecularFormulas-354"><a href="#SearchMolecularFormulas-354"><span class="linenos">354</span></a>                    <span class="k">if</span> <span class="n">candidate_formulas</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-355"><a href="#SearchMolecularFormulas-355"><span class="linenos">355</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">run_search</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-356"><a href="#SearchMolecularFormulas-356"><span class="linenos">356</span></a>                            <span class="n">ms_peaks</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-357"><a href="#SearchMolecularFormulas-357"><span class="linenos">357</span></a>                            <span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-358"><a href="#SearchMolecularFormulas-358"><span class="linenos">358</span></a>                            <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-359"><a href="#SearchMolecularFormulas-359"><span class="linenos">359</span></a>                            <span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-360"><a href="#SearchMolecularFormulas-360"><span class="linenos">360</span></a>                            <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-361"><a href="#SearchMolecularFormulas-361"><span class="linenos">361</span></a>                        <span class="p">)</span>
</span><span id="SearchMolecularFormulas-362"><a href="#SearchMolecularFormulas-362"><span class="linenos">362</span></a>                <span class="c1"># looks for adduct, used_atom_valences should be 0</span>
</span><span id="SearchMolecularFormulas-363"><a href="#SearchMolecularFormulas-363"><span class="linenos">363</span></a>                <span class="c1"># this code does not support H exchance by halogen atoms</span>
</span><span id="SearchMolecularFormulas-364"><a href="#SearchMolecularFormulas-364"><span class="linenos">364</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">isAdduct</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-365"><a href="#SearchMolecularFormulas-365"><span class="linenos">365</span></a>                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-366"><a href="#SearchMolecularFormulas-366"><span class="linenos">366</span></a>                        <span class="n">pbar</span><span class="o">.</span><span class="n">set_description_str</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-367"><a href="#SearchMolecularFormulas-367"><span class="linenos">367</span></a>                            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Started molecular formula search for class </span><span class="si">%s</span><span class="s2">, adduct &quot;</span>
</span><span id="SearchMolecularFormulas-368"><a href="#SearchMolecularFormulas-368"><span class="linenos">368</span></a>                            <span class="o">%</span> <span class="n">classe_str</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-369"><a href="#SearchMolecularFormulas-369"><span class="linenos">369</span></a>                            <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-370"><a href="#SearchMolecularFormulas-370"><span class="linenos">370</span></a>                        <span class="p">)</span>
</span><span id="SearchMolecularFormulas-371"><a href="#SearchMolecularFormulas-371"><span class="linenos">371</span></a>
</span><span id="SearchMolecularFormulas-372"><a href="#SearchMolecularFormulas-372"><span class="linenos">372</span></a>                    <span class="n">ion_type</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">adduct_ion</span>
</span><span id="SearchMolecularFormulas-373"><a href="#SearchMolecularFormulas-373"><span class="linenos">373</span></a>                    <span class="n">dict_atoms_formulas</span> <span class="o">=</span> <span class="n">dict_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ion_type</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas-374"><a href="#SearchMolecularFormulas-374"><span class="linenos">374</span></a>
</span><span id="SearchMolecularFormulas-375"><a href="#SearchMolecularFormulas-375"><span class="linenos">375</span></a>                    <span class="k">for</span> <span class="n">adduct_atom</span><span class="p">,</span> <span class="n">dict_by_class</span> <span class="ow">in</span> <span class="n">dict_atoms_formulas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="SearchMolecularFormulas-376"><a href="#SearchMolecularFormulas-376"><span class="linenos">376</span></a>                        <span class="n">candidate_formulas</span> <span class="o">=</span> <span class="n">dict_by_class</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">classe_str</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas-377"><a href="#SearchMolecularFormulas-377"><span class="linenos">377</span></a>
</span><span id="SearchMolecularFormulas-378"><a href="#SearchMolecularFormulas-378"><span class="linenos">378</span></a>                        <span class="k">if</span> <span class="n">candidate_formulas</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-379"><a href="#SearchMolecularFormulas-379"><span class="linenos">379</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">run_search</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-380"><a href="#SearchMolecularFormulas-380"><span class="linenos">380</span></a>                                <span class="n">ms_peaks</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-381"><a href="#SearchMolecularFormulas-381"><span class="linenos">381</span></a>                                <span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-382"><a href="#SearchMolecularFormulas-382"><span class="linenos">382</span></a>                                <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-383"><a href="#SearchMolecularFormulas-383"><span class="linenos">383</span></a>                                <span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-384"><a href="#SearchMolecularFormulas-384"><span class="linenos">384</span></a>                                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-385"><a href="#SearchMolecularFormulas-385"><span class="linenos">385</span></a>                                <span class="n">adduct_atom</span><span class="o">=</span><span class="n">adduct_atom</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-386"><a href="#SearchMolecularFormulas-386"><span class="linenos">386</span></a>                            <span class="p">)</span>
</span><span id="SearchMolecularFormulas-387"><a href="#SearchMolecularFormulas-387"><span class="linenos">387</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="SearchMolecularFormulas-388"><a href="#SearchMolecularFormulas-388"><span class="linenos">388</span></a>
</span><span id="SearchMolecularFormulas-389"><a href="#SearchMolecularFormulas-389"><span class="linenos">389</span></a>    <span class="k">def</span> <span class="nf">search_mol_formulas</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-390"><a href="#SearchMolecularFormulas-390"><span class="linenos">390</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-391"><a href="#SearchMolecularFormulas-391"><span class="linenos">391</span></a>        <span class="n">possible_formulas_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MolecularFormula</span><span class="p">],</span>
</span><span id="SearchMolecularFormulas-392"><a href="#SearchMolecularFormulas-392"><span class="linenos">392</span></a>        <span class="n">ion_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-393"><a href="#SearchMolecularFormulas-393"><span class="linenos">393</span></a>        <span class="n">neutral_molform</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-394"><a href="#SearchMolecularFormulas-394"><span class="linenos">394</span></a>        <span class="n">find_isotopologues</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-395"><a href="#SearchMolecularFormulas-395"><span class="linenos">395</span></a>        <span class="n">adduct_atom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-396"><a href="#SearchMolecularFormulas-396"><span class="linenos">396</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">_MSPeak</span><span class="p">]:</span>
</span><span id="SearchMolecularFormulas-397"><a href="#SearchMolecularFormulas-397"><span class="linenos">397</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Search for molecular formulas in the mass spectrum.</span>
</span><span id="SearchMolecularFormulas-398"><a href="#SearchMolecularFormulas-398"><span class="linenos">398</span></a>
</span><span id="SearchMolecularFormulas-399"><a href="#SearchMolecularFormulas-399"><span class="linenos">399</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulas-400"><a href="#SearchMolecularFormulas-400"><span class="linenos">400</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulas-401"><a href="#SearchMolecularFormulas-401"><span class="linenos">401</span></a><span class="sd">        possible_formulas_list : list of MolecularFormula</span>
</span><span id="SearchMolecularFormulas-402"><a href="#SearchMolecularFormulas-402"><span class="linenos">402</span></a><span class="sd">            The list of possible molecular formulas.</span>
</span><span id="SearchMolecularFormulas-403"><a href="#SearchMolecularFormulas-403"><span class="linenos">403</span></a><span class="sd">        ion_type : str</span>
</span><span id="SearchMolecularFormulas-404"><a href="#SearchMolecularFormulas-404"><span class="linenos">404</span></a><span class="sd">            The ion type.</span>
</span><span id="SearchMolecularFormulas-405"><a href="#SearchMolecularFormulas-405"><span class="linenos">405</span></a><span class="sd">        neutral_molform : bool, optional</span>
</span><span id="SearchMolecularFormulas-406"><a href="#SearchMolecularFormulas-406"><span class="linenos">406</span></a><span class="sd">            Flag to indicate whether the molecular formulas are neutral, by default True.</span>
</span><span id="SearchMolecularFormulas-407"><a href="#SearchMolecularFormulas-407"><span class="linenos">407</span></a><span class="sd">        find_isotopologues : bool, optional</span>
</span><span id="SearchMolecularFormulas-408"><a href="#SearchMolecularFormulas-408"><span class="linenos">408</span></a><span class="sd">            Flag to indicate whether to find isotopologues, by default True.</span>
</span><span id="SearchMolecularFormulas-409"><a href="#SearchMolecularFormulas-409"><span class="linenos">409</span></a><span class="sd">        adduct_atom : str, optional</span>
</span><span id="SearchMolecularFormulas-410"><a href="#SearchMolecularFormulas-410"><span class="linenos">410</span></a><span class="sd">            The adduct atom, by default None.</span>
</span><span id="SearchMolecularFormulas-411"><a href="#SearchMolecularFormulas-411"><span class="linenos">411</span></a>
</span><span id="SearchMolecularFormulas-412"><a href="#SearchMolecularFormulas-412"><span class="linenos">412</span></a><span class="sd">        Returns</span>
</span><span id="SearchMolecularFormulas-413"><a href="#SearchMolecularFormulas-413"><span class="linenos">413</span></a><span class="sd">        -------</span>
</span><span id="SearchMolecularFormulas-414"><a href="#SearchMolecularFormulas-414"><span class="linenos">414</span></a><span class="sd">        list of MSPeak</span>
</span><span id="SearchMolecularFormulas-415"><a href="#SearchMolecularFormulas-415"><span class="linenos">415</span></a><span class="sd">            The list of mass spectrum peaks with assigned molecular formulas.</span>
</span><span id="SearchMolecularFormulas-416"><a href="#SearchMolecularFormulas-416"><span class="linenos">416</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas-417"><a href="#SearchMolecularFormulas-417"><span class="linenos">417</span></a>        <span class="c1"># neutral_molform: some reference files already present the formula on ion mode, for instance, bruker reference files</span>
</span><span id="SearchMolecularFormulas-418"><a href="#SearchMolecularFormulas-418"><span class="linenos">418</span></a>        <span class="c1">#    if that is the case than turn neutral_molform off</span>
</span><span id="SearchMolecularFormulas-419"><a href="#SearchMolecularFormulas-419"><span class="linenos">419</span></a>
</span><span id="SearchMolecularFormulas-420"><a href="#SearchMolecularFormulas-420"><span class="linenos">420</span></a>        <span class="n">SearchMolecularFormulaWorker</span><span class="p">(</span><span class="n">find_isotopologues</span><span class="o">=</span><span class="n">find_isotopologues</span><span class="p">)</span><span class="o">.</span><span class="n">reset_error</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-421"><a href="#SearchMolecularFormulas-421"><span class="linenos">421</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span>
</span><span id="SearchMolecularFormulas-422"><a href="#SearchMolecularFormulas-422"><span class="linenos">422</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas-423"><a href="#SearchMolecularFormulas-423"><span class="linenos">423</span></a>
</span><span id="SearchMolecularFormulas-424"><a href="#SearchMolecularFormulas-424"><span class="linenos">424</span></a>        <span class="n">initial_min_peak_bool</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulas-425"><a href="#SearchMolecularFormulas-425"><span class="linenos">425</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_min_peaks_filter</span>
</span><span id="SearchMolecularFormulas-426"><a href="#SearchMolecularFormulas-426"><span class="linenos">426</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas-427"><a href="#SearchMolecularFormulas-427"><span class="linenos">427</span></a>        <span class="n">initial_runtime_kendrick_filter</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulas-428"><a href="#SearchMolecularFormulas-428"><span class="linenos">428</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_runtime_kendrick_filter</span>
</span><span id="SearchMolecularFormulas-429"><a href="#SearchMolecularFormulas-429"><span class="linenos">429</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas-430"><a href="#SearchMolecularFormulas-430"><span class="linenos">430</span></a>
</span><span id="SearchMolecularFormulas-431"><a href="#SearchMolecularFormulas-431"><span class="linenos">431</span></a>        <span class="c1"># Are the following 3 lines redundant?</span>
</span><span id="SearchMolecularFormulas-432"><a href="#SearchMolecularFormulas-432"><span class="linenos">432</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_min_peaks_filter</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SearchMolecularFormulas-433"><a href="#SearchMolecularFormulas-433"><span class="linenos">433</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_min_peaks_filter</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulas-434"><a href="#SearchMolecularFormulas-434"><span class="linenos">434</span></a>            <span class="kc">False</span>  <span class="c1"># TODO check this line</span>
</span><span id="SearchMolecularFormulas-435"><a href="#SearchMolecularFormulas-435"><span class="linenos">435</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas-436"><a href="#SearchMolecularFormulas-436"><span class="linenos">436</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_runtime_kendrick_filter</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulas-437"><a href="#SearchMolecularFormulas-437"><span class="linenos">437</span></a>            <span class="kc">False</span>
</span><span id="SearchMolecularFormulas-438"><a href="#SearchMolecularFormulas-438"><span class="linenos">438</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas-439"><a href="#SearchMolecularFormulas-439"><span class="linenos">439</span></a>
</span><span id="SearchMolecularFormulas-440"><a href="#SearchMolecularFormulas-440"><span class="linenos">440</span></a>        <span class="n">possible_formulas_dict_nm</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SearchMolecularFormulas-441"><a href="#SearchMolecularFormulas-441"><span class="linenos">441</span></a>
</span><span id="SearchMolecularFormulas-442"><a href="#SearchMolecularFormulas-442"><span class="linenos">442</span></a>        <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="n">possible_formulas_list</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-443"><a href="#SearchMolecularFormulas-443"><span class="linenos">443</span></a>            <span class="k">if</span> <span class="n">neutral_molform</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-444"><a href="#SearchMolecularFormulas-444"><span class="linenos">444</span></a>                <span class="n">nm</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">protonated_mz</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas-445"><a href="#SearchMolecularFormulas-445"><span class="linenos">445</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-446"><a href="#SearchMolecularFormulas-446"><span class="linenos">446</span></a>                <span class="n">nm</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">mz_nominal_calc</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas-447"><a href="#SearchMolecularFormulas-447"><span class="linenos">447</span></a>
</span><span id="SearchMolecularFormulas-448"><a href="#SearchMolecularFormulas-448"><span class="linenos">448</span></a>            <span class="k">if</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">possible_formulas_dict_nm</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="SearchMolecularFormulas-449"><a href="#SearchMolecularFormulas-449"><span class="linenos">449</span></a>                <span class="n">possible_formulas_dict_nm</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas-450"><a href="#SearchMolecularFormulas-450"><span class="linenos">450</span></a>
</span><span id="SearchMolecularFormulas-451"><a href="#SearchMolecularFormulas-451"><span class="linenos">451</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas-452"><a href="#SearchMolecularFormulas-452"><span class="linenos">452</span></a>                <span class="n">possible_formulas_dict_nm</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mf</span><span class="p">]</span>
</span><span id="SearchMolecularFormulas-453"><a href="#SearchMolecularFormulas-453"><span class="linenos">453</span></a>
</span><span id="SearchMolecularFormulas-454"><a href="#SearchMolecularFormulas-454"><span class="linenos">454</span></a>        <span class="n">min_abundance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">min_abundance</span>
</span><span id="SearchMolecularFormulas-455"><a href="#SearchMolecularFormulas-455"><span class="linenos">455</span></a>
</span><span id="SearchMolecularFormulas-456"><a href="#SearchMolecularFormulas-456"><span class="linenos">456</span></a>        <span class="n">ion_type</span> <span class="o">=</span> <span class="n">ion_type</span>
</span><span id="SearchMolecularFormulas-457"><a href="#SearchMolecularFormulas-457"><span class="linenos">457</span></a>
</span><span id="SearchMolecularFormulas-458"><a href="#SearchMolecularFormulas-458"><span class="linenos">458</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_search</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas-459"><a href="#SearchMolecularFormulas-459"><span class="linenos">459</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-460"><a href="#SearchMolecularFormulas-460"><span class="linenos">460</span></a>            <span class="n">possible_formulas_dict_nm</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-461"><a href="#SearchMolecularFormulas-461"><span class="linenos">461</span></a>            <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-462"><a href="#SearchMolecularFormulas-462"><span class="linenos">462</span></a>            <span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-463"><a href="#SearchMolecularFormulas-463"><span class="linenos">463</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">polarity</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-464"><a href="#SearchMolecularFormulas-464"><span class="linenos">464</span></a>            <span class="n">adduct_atom</span><span class="o">=</span><span class="n">adduct_atom</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas-465"><a href="#SearchMolecularFormulas-465"><span class="linenos">465</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas-466"><a href="#SearchMolecularFormulas-466"><span class="linenos">466</span></a>
</span><span id="SearchMolecularFormulas-467"><a href="#SearchMolecularFormulas-467"><span class="linenos">467</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_min_peaks_filter</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulas-468"><a href="#SearchMolecularFormulas-468"><span class="linenos">468</span></a>            <span class="n">initial_min_peak_bool</span>
</span><span id="SearchMolecularFormulas-469"><a href="#SearchMolecularFormulas-469"><span class="linenos">469</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas-470"><a href="#SearchMolecularFormulas-470"><span class="linenos">470</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_runtime_kendrick_filter</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulas-471"><a href="#SearchMolecularFormulas-471"><span class="linenos">471</span></a>            <span class="n">initial_runtime_kendrick_filter</span>
</span><span id="SearchMolecularFormulas-472"><a href="#SearchMolecularFormulas-472"><span class="linenos">472</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas-473"><a href="#SearchMolecularFormulas-473"><span class="linenos">473</span></a>
</span><span id="SearchMolecularFormulas-474"><a href="#SearchMolecularFormulas-474"><span class="linenos">474</span></a>        <span class="n">mspeaks</span> <span class="o">=</span> <span class="p">[</span><span class="n">mspeak</span> <span class="k">for</span> <span class="n">mspeak</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span> <span class="k">if</span> <span class="n">mspeak</span><span class="o">.</span><span class="n">is_assigned</span><span class="p">]</span>
</span><span id="SearchMolecularFormulas-475"><a href="#SearchMolecularFormulas-475"><span class="linenos">475</span></a>
</span><span id="SearchMolecularFormulas-476"><a href="#SearchMolecularFormulas-476"><span class="linenos">476</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="SearchMolecularFormulas-477"><a href="#SearchMolecularFormulas-477"><span class="linenos">477</span></a>
</span><span id="SearchMolecularFormulas-478"><a href="#SearchMolecularFormulas-478"><span class="linenos">478</span></a>        <span class="k">return</span> <span class="n">mspeaks</span>
</span></pre></div>


            <div class="docstring"><p>Class for searching molecular formulas in a mass spectrum.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>mass_spectrum_obj</strong> (MassSpectrum):
The mass spectrum object.</li>
<li><strong>sql_db</strong> (MolForm_SQL, optional):
The SQL database object, by default None.</li>
<li><strong>first_hit</strong> (bool, optional):
Flag to indicate whether to skip peaks that already have a molecular formula assigned, by default False.</li>
<li><strong>find_isotopologues</strong> (bool, optional):
Flag to indicate whether to find isotopologues, by default True.</li>
</ul>

<h6 id="attributes">Attributes</h6>

<ul>
<li><strong>mass_spectrum_obj</strong> (MassSpectrum):
The mass spectrum object.</li>
<li><strong>sql_db</strong> (MolForm_SQL):
The SQL database object.</li>
<li><strong>first_hit</strong> (bool):
Flag to indicate whether to skip peaks that already have a molecular formula assigned.</li>
<li><strong>find_isotopologues</strong> (bool):
Flag to indicate whether to find isotopologues.</li>
</ul>

<h6 id="methods">Methods</h6>

<ul>
<li>run_search().
Run the molecular formula search.</li>
<li>run_worker_mass_spectrum().
Run the molecular formula search on the mass spectrum object.</li>
<li>run_worker_ms_peaks().
Run the molecular formula search on the given list of mass spectrum peaks.</li>
<li>database_to_dict().
Convert the database results to a dictionary.</li>
<li>run_molecular_formula().
Run the molecular formula search on the given list of mass spectrum peaks.</li>
<li>search_mol_formulas().
Search for molecular formulas in the mass spectrum.</li>
</ul>
</div>


                            <div id="SearchMolecularFormulas.__init__" class="classattr">
                                        <input id="SearchMolecularFormulas.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SearchMolecularFormulas</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">mass_spectrum_obj</span>,</span><span class="param">	<span class="n">sql_db</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">first_hit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">find_isotopologues</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span>)</span>

                <label class="view-source-button" for="SearchMolecularFormulas.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulas.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulas.__init__-70"><a href="#SearchMolecularFormulas.__init__-70"><span class="linenos">70</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas.__init__-71"><a href="#SearchMolecularFormulas.__init__-71"><span class="linenos">71</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.__init__-72"><a href="#SearchMolecularFormulas.__init__-72"><span class="linenos">72</span></a>        <span class="n">mass_spectrum_obj</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.__init__-73"><a href="#SearchMolecularFormulas.__init__-73"><span class="linenos">73</span></a>        <span class="n">sql_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.__init__-74"><a href="#SearchMolecularFormulas.__init__-74"><span class="linenos">74</span></a>        <span class="n">first_hit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.__init__-75"><a href="#SearchMolecularFormulas.__init__-75"><span class="linenos">75</span></a>        <span class="n">find_isotopologues</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.__init__-76"><a href="#SearchMolecularFormulas.__init__-76"><span class="linenos">76</span></a>    <span class="p">):</span>
</span><span id="SearchMolecularFormulas.__init__-77"><a href="#SearchMolecularFormulas.__init__-77"><span class="linenos">77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">first_hit</span> <span class="o">=</span> <span class="n">first_hit</span>
</span><span id="SearchMolecularFormulas.__init__-78"><a href="#SearchMolecularFormulas.__init__-78"><span class="linenos">78</span></a>
</span><span id="SearchMolecularFormulas.__init__-79"><a href="#SearchMolecularFormulas.__init__-79"><span class="linenos">79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span> <span class="o">=</span> <span class="n">find_isotopologues</span>
</span><span id="SearchMolecularFormulas.__init__-80"><a href="#SearchMolecularFormulas.__init__-80"><span class="linenos">80</span></a>
</span><span id="SearchMolecularFormulas.__init__-81"><a href="#SearchMolecularFormulas.__init__-81"><span class="linenos">81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span> <span class="o">=</span> <span class="n">mass_spectrum_obj</span>
</span><span id="SearchMolecularFormulas.__init__-82"><a href="#SearchMolecularFormulas.__init__-82"><span class="linenos">82</span></a>
</span><span id="SearchMolecularFormulas.__init__-83"><a href="#SearchMolecularFormulas.__init__-83"><span class="linenos">83</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sql_db</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas.__init__-84"><a href="#SearchMolecularFormulas.__init__-84"><span class="linenos">84</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span> <span class="o">=</span> <span class="n">MolForm_SQL</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas.__init__-85"><a href="#SearchMolecularFormulas.__init__-85"><span class="linenos">85</span></a>                <span class="n">url</span><span class="o">=</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">url_database</span>
</span><span id="SearchMolecularFormulas.__init__-86"><a href="#SearchMolecularFormulas.__init__-86"><span class="linenos">86</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulas.__init__-87"><a href="#SearchMolecularFormulas.__init__-87"><span class="linenos">87</span></a>
</span><span id="SearchMolecularFormulas.__init__-88"><a href="#SearchMolecularFormulas.__init__-88"><span class="linenos">88</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas.__init__-89"><a href="#SearchMolecularFormulas.__init__-89"><span class="linenos">89</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span> <span class="o">=</span> <span class="n">sql_db</span>
</span></pre></div>


    

                            </div>
                            <div id="SearchMolecularFormulas.first_hit" class="classattr">
                                <div class="attr variable">
            <span class="name">first_hit</span>

        
    </div>
    <a class="headerlink" href="#SearchMolecularFormulas.first_hit"></a>
    
    

                            </div>
                            <div id="SearchMolecularFormulas.find_isotopologues" class="classattr">
                                <div class="attr variable">
            <span class="name">find_isotopologues</span>

        
    </div>
    <a class="headerlink" href="#SearchMolecularFormulas.find_isotopologues"></a>
    
    

                            </div>
                            <div id="SearchMolecularFormulas.mass_spectrum_obj" class="classattr">
                                <div class="attr variable">
            <span class="name">mass_spectrum_obj</span>

        
    </div>
    <a class="headerlink" href="#SearchMolecularFormulas.mass_spectrum_obj"></a>
    
    

                            </div>
                            <div id="SearchMolecularFormulas.run_search" class="classattr">
                                        <input id="SearchMolecularFormulas.run_search-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_search</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">mspeaks</span><span class="p">:</span> <span class="nb">list</span>,</span><span class="param">	<span class="n">query</span><span class="p">:</span> <span class="nb">dict</span>,</span><span class="param">	<span class="n">min_abundance</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">ion_type</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">ion_charge</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">adduct_atom</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SearchMolecularFormulas.run_search-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulas.run_search"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulas.run_search-101"><a href="#SearchMolecularFormulas.run_search-101"><span class="linenos">101</span></a>    <span class="k">def</span> <span class="nf">run_search</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas.run_search-102"><a href="#SearchMolecularFormulas.run_search-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.run_search-103"><a href="#SearchMolecularFormulas.run_search-103"><span class="linenos">103</span></a>        <span class="n">mspeaks</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.run_search-104"><a href="#SearchMolecularFormulas.run_search-104"><span class="linenos">104</span></a>        <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.run_search-105"><a href="#SearchMolecularFormulas.run_search-105"><span class="linenos">105</span></a>        <span class="n">min_abundance</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.run_search-106"><a href="#SearchMolecularFormulas.run_search-106"><span class="linenos">106</span></a>        <span class="n">ion_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.run_search-107"><a href="#SearchMolecularFormulas.run_search-107"><span class="linenos">107</span></a>        <span class="n">ion_charge</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.run_search-108"><a href="#SearchMolecularFormulas.run_search-108"><span class="linenos">108</span></a>        <span class="n">adduct_atom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.run_search-109"><a href="#SearchMolecularFormulas.run_search-109"><span class="linenos">109</span></a>    <span class="p">):</span>
</span><span id="SearchMolecularFormulas.run_search-110"><a href="#SearchMolecularFormulas.run_search-110"><span class="linenos">110</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the molecular formula search.</span>
</span><span id="SearchMolecularFormulas.run_search-111"><a href="#SearchMolecularFormulas.run_search-111"><span class="linenos">111</span></a>
</span><span id="SearchMolecularFormulas.run_search-112"><a href="#SearchMolecularFormulas.run_search-112"><span class="linenos">112</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulas.run_search-113"><a href="#SearchMolecularFormulas.run_search-113"><span class="linenos">113</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulas.run_search-114"><a href="#SearchMolecularFormulas.run_search-114"><span class="linenos">114</span></a><span class="sd">        mspeaks : list of MSPeak</span>
</span><span id="SearchMolecularFormulas.run_search-115"><a href="#SearchMolecularFormulas.run_search-115"><span class="linenos">115</span></a><span class="sd">            The list of mass spectrum peaks.</span>
</span><span id="SearchMolecularFormulas.run_search-116"><a href="#SearchMolecularFormulas.run_search-116"><span class="linenos">116</span></a><span class="sd">        query : dict</span>
</span><span id="SearchMolecularFormulas.run_search-117"><a href="#SearchMolecularFormulas.run_search-117"><span class="linenos">117</span></a><span class="sd">            The query dictionary containing the possible molecular formulas.</span>
</span><span id="SearchMolecularFormulas.run_search-118"><a href="#SearchMolecularFormulas.run_search-118"><span class="linenos">118</span></a><span class="sd">        min_abundance : float</span>
</span><span id="SearchMolecularFormulas.run_search-119"><a href="#SearchMolecularFormulas.run_search-119"><span class="linenos">119</span></a><span class="sd">            The minimum abundance threshold.</span>
</span><span id="SearchMolecularFormulas.run_search-120"><a href="#SearchMolecularFormulas.run_search-120"><span class="linenos">120</span></a><span class="sd">        ion_type : str</span>
</span><span id="SearchMolecularFormulas.run_search-121"><a href="#SearchMolecularFormulas.run_search-121"><span class="linenos">121</span></a><span class="sd">            The ion type.</span>
</span><span id="SearchMolecularFormulas.run_search-122"><a href="#SearchMolecularFormulas.run_search-122"><span class="linenos">122</span></a><span class="sd">        ion_charge : int</span>
</span><span id="SearchMolecularFormulas.run_search-123"><a href="#SearchMolecularFormulas.run_search-123"><span class="linenos">123</span></a><span class="sd">            The ion charge.</span>
</span><span id="SearchMolecularFormulas.run_search-124"><a href="#SearchMolecularFormulas.run_search-124"><span class="linenos">124</span></a><span class="sd">        adduct_atom : str, optional</span>
</span><span id="SearchMolecularFormulas.run_search-125"><a href="#SearchMolecularFormulas.run_search-125"><span class="linenos">125</span></a><span class="sd">            The adduct atom, by default None.</span>
</span><span id="SearchMolecularFormulas.run_search-126"><a href="#SearchMolecularFormulas.run_search-126"><span class="linenos">126</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas.run_search-127"><a href="#SearchMolecularFormulas.run_search-127"><span class="linenos">127</span></a>
</span><span id="SearchMolecularFormulas.run_search-128"><a href="#SearchMolecularFormulas.run_search-128"><span class="linenos">128</span></a>        <span class="k">def</span> <span class="nf">get_formulas</span><span class="p">(</span><span class="n">nominal_overlay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
</span><span id="SearchMolecularFormulas.run_search-129"><a href="#SearchMolecularFormulas.run_search-129"><span class="linenos">129</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas.run_search-130"><a href="#SearchMolecularFormulas.run_search-130"><span class="linenos">130</span></a><span class="sd">            Get the list of formulas based on the nominal overlay.</span>
</span><span id="SearchMolecularFormulas.run_search-131"><a href="#SearchMolecularFormulas.run_search-131"><span class="linenos">131</span></a>
</span><span id="SearchMolecularFormulas.run_search-132"><a href="#SearchMolecularFormulas.run_search-132"><span class="linenos">132</span></a><span class="sd">            Parameters</span>
</span><span id="SearchMolecularFormulas.run_search-133"><a href="#SearchMolecularFormulas.run_search-133"><span class="linenos">133</span></a><span class="sd">            ----------</span>
</span><span id="SearchMolecularFormulas.run_search-134"><a href="#SearchMolecularFormulas.run_search-134"><span class="linenos">134</span></a><span class="sd">            nominal_overlay : float, optional</span>
</span><span id="SearchMolecularFormulas.run_search-135"><a href="#SearchMolecularFormulas.run_search-135"><span class="linenos">135</span></a><span class="sd">                The nominal overlay, by default 0.1.</span>
</span><span id="SearchMolecularFormulas.run_search-136"><a href="#SearchMolecularFormulas.run_search-136"><span class="linenos">136</span></a>
</span><span id="SearchMolecularFormulas.run_search-137"><a href="#SearchMolecularFormulas.run_search-137"><span class="linenos">137</span></a><span class="sd">            Returns</span>
</span><span id="SearchMolecularFormulas.run_search-138"><a href="#SearchMolecularFormulas.run_search-138"><span class="linenos">138</span></a><span class="sd">            -------</span>
</span><span id="SearchMolecularFormulas.run_search-139"><a href="#SearchMolecularFormulas.run_search-139"><span class="linenos">139</span></a><span class="sd">            list</span>
</span><span id="SearchMolecularFormulas.run_search-140"><a href="#SearchMolecularFormulas.run_search-140"><span class="linenos">140</span></a><span class="sd">                The list of formulas.</span>
</span><span id="SearchMolecularFormulas.run_search-141"><a href="#SearchMolecularFormulas.run_search-141"><span class="linenos">141</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas.run_search-142"><a href="#SearchMolecularFormulas.run_search-142"><span class="linenos">142</span></a>            <span class="n">nominal_mz</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">nominal_mz_exp</span>
</span><span id="SearchMolecularFormulas.run_search-143"><a href="#SearchMolecularFormulas.run_search-143"><span class="linenos">143</span></a>
</span><span id="SearchMolecularFormulas.run_search-144"><a href="#SearchMolecularFormulas.run_search-144"><span class="linenos">144</span></a>            <span class="n">defect_mass</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">mz_exp</span> <span class="o">-</span> <span class="n">nominal_mz</span>
</span><span id="SearchMolecularFormulas.run_search-145"><a href="#SearchMolecularFormulas.run_search-145"><span class="linenos">145</span></a>            <span class="n">nominal_masses</span> <span class="o">=</span> <span class="p">[</span><span class="n">nominal_mz</span><span class="p">]</span>
</span><span id="SearchMolecularFormulas.run_search-146"><a href="#SearchMolecularFormulas.run_search-146"><span class="linenos">146</span></a>
</span><span id="SearchMolecularFormulas.run_search-147"><a href="#SearchMolecularFormulas.run_search-147"><span class="linenos">147</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">defect_mass</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">nominal_overlay</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas.run_search-148"><a href="#SearchMolecularFormulas.run_search-148"><span class="linenos">148</span></a>                <span class="n">nominal_masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nominal_mz</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas.run_search-149"><a href="#SearchMolecularFormulas.run_search-149"><span class="linenos">149</span></a>            <span class="k">elif</span> <span class="p">(</span><span class="n">defect_mass</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">nominal_overlay</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas.run_search-150"><a href="#SearchMolecularFormulas.run_search-150"><span class="linenos">150</span></a>                <span class="n">nominal_masses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nominal_mz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas.run_search-151"><a href="#SearchMolecularFormulas.run_search-151"><span class="linenos">151</span></a>
</span><span id="SearchMolecularFormulas.run_search-152"><a href="#SearchMolecularFormulas.run_search-152"><span class="linenos">152</span></a>            <span class="n">list_formulas_candidates</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SearchMolecularFormulas.run_search-153"><a href="#SearchMolecularFormulas.run_search-153"><span class="linenos">153</span></a>
</span><span id="SearchMolecularFormulas.run_search-154"><a href="#SearchMolecularFormulas.run_search-154"><span class="linenos">154</span></a>            <span class="k">for</span> <span class="n">nominal_mass</span> <span class="ow">in</span> <span class="n">nominal_masses</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas.run_search-155"><a href="#SearchMolecularFormulas.run_search-155"><span class="linenos">155</span></a>                <span class="k">if</span> <span class="n">nominal_mass</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="SearchMolecularFormulas.run_search-156"><a href="#SearchMolecularFormulas.run_search-156"><span class="linenos">156</span></a>                    <span class="n">list_formulas_candidates</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nominal_mass</span><span class="p">))</span>
</span><span id="SearchMolecularFormulas.run_search-157"><a href="#SearchMolecularFormulas.run_search-157"><span class="linenos">157</span></a>
</span><span id="SearchMolecularFormulas.run_search-158"><a href="#SearchMolecularFormulas.run_search-158"><span class="linenos">158</span></a>            <span class="k">return</span> <span class="n">list_formulas_candidates</span>
</span><span id="SearchMolecularFormulas.run_search-159"><a href="#SearchMolecularFormulas.run_search-159"><span class="linenos">159</span></a>
</span><span id="SearchMolecularFormulas.run_search-160"><a href="#SearchMolecularFormulas.run_search-160"><span class="linenos">160</span></a>        <span class="n">all_assigned_indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span><span id="SearchMolecularFormulas.run_search-161"><a href="#SearchMolecularFormulas.run_search-161"><span class="linenos">161</span></a>
</span><span id="SearchMolecularFormulas.run_search-162"><a href="#SearchMolecularFormulas.run_search-162"><span class="linenos">162</span></a>        <span class="c1"># molecular_search_settings = self.mass_spectrum_obj.molecular_search_settings</span>
</span><span id="SearchMolecularFormulas.run_search-163"><a href="#SearchMolecularFormulas.run_search-163"><span class="linenos">163</span></a>
</span><span id="SearchMolecularFormulas.run_search-164"><a href="#SearchMolecularFormulas.run_search-164"><span class="linenos">164</span></a>        <span class="n">search_molfrom</span> <span class="o">=</span> <span class="n">SearchMolecularFormulaWorker</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas.run_search-165"><a href="#SearchMolecularFormulas.run_search-165"><span class="linenos">165</span></a>            <span class="n">find_isotopologues</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span>
</span><span id="SearchMolecularFormulas.run_search-166"><a href="#SearchMolecularFormulas.run_search-166"><span class="linenos">166</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas.run_search-167"><a href="#SearchMolecularFormulas.run_search-167"><span class="linenos">167</span></a>
</span><span id="SearchMolecularFormulas.run_search-168"><a href="#SearchMolecularFormulas.run_search-168"><span class="linenos">168</span></a>        <span class="k">for</span> <span class="n">ms_peak</span> <span class="ow">in</span> <span class="n">mspeaks</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas.run_search-169"><a href="#SearchMolecularFormulas.run_search-169"><span class="linenos">169</span></a>            <span class="c1"># already assigned a molecular formula</span>
</span><span id="SearchMolecularFormulas.run_search-170"><a href="#SearchMolecularFormulas.run_search-170"><span class="linenos">170</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_hit</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas.run_search-171"><a href="#SearchMolecularFormulas.run_search-171"><span class="linenos">171</span></a>                <span class="k">if</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">is_assigned</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas.run_search-172"><a href="#SearchMolecularFormulas.run_search-172"><span class="linenos">172</span></a>                    <span class="k">continue</span>
</span><span id="SearchMolecularFormulas.run_search-173"><a href="#SearchMolecularFormulas.run_search-173"><span class="linenos">173</span></a>
</span><span id="SearchMolecularFormulas.run_search-174"><a href="#SearchMolecularFormulas.run_search-174"><span class="linenos">174</span></a>            <span class="n">ms_peak_indexes</span> <span class="o">=</span> <span class="n">search_molfrom</span><span class="o">.</span><span class="n">find_formulas</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas.run_search-175"><a href="#SearchMolecularFormulas.run_search-175"><span class="linenos">175</span></a>                <span class="n">get_formulas</span><span class="p">(),</span>
</span><span id="SearchMolecularFormulas.run_search-176"><a href="#SearchMolecularFormulas.run_search-176"><span class="linenos">176</span></a>                <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.run_search-177"><a href="#SearchMolecularFormulas.run_search-177"><span class="linenos">177</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.run_search-178"><a href="#SearchMolecularFormulas.run_search-178"><span class="linenos">178</span></a>                <span class="n">ms_peak</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.run_search-179"><a href="#SearchMolecularFormulas.run_search-179"><span class="linenos">179</span></a>                <span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.run_search-180"><a href="#SearchMolecularFormulas.run_search-180"><span class="linenos">180</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.run_search-181"><a href="#SearchMolecularFormulas.run_search-181"><span class="linenos">181</span></a>                <span class="n">adduct_atom</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.run_search-182"><a href="#SearchMolecularFormulas.run_search-182"><span class="linenos">182</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulas.run_search-183"><a href="#SearchMolecularFormulas.run_search-183"><span class="linenos">183</span></a>
</span><span id="SearchMolecularFormulas.run_search-184"><a href="#SearchMolecularFormulas.run_search-184"><span class="linenos">184</span></a>            <span class="n">all_assigned_indexes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ms_peak_indexes</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas.run_search-185"><a href="#SearchMolecularFormulas.run_search-185"><span class="linenos">185</span></a>
</span><span id="SearchMolecularFormulas.run_search-186"><a href="#SearchMolecularFormulas.run_search-186"><span class="linenos">186</span></a>        <span class="c1"># all_assigned_indexes = MolecularFormulaSearchFilters().filter_isotopologue(all_assigned_indexes, self.mass_spectrum_obj)</span>
</span><span id="SearchMolecularFormulas.run_search-187"><a href="#SearchMolecularFormulas.run_search-187"><span class="linenos">187</span></a>
</span><span id="SearchMolecularFormulas.run_search-188"><a href="#SearchMolecularFormulas.run_search-188"><span class="linenos">188</span></a>        <span class="c1"># all_assigned_indexes = MolecularFormulaSearchFilters().filter_kendrick(all_assigned_indexes, self.mass_spectrum_obj)</span>
</span><span id="SearchMolecularFormulas.run_search-189"><a href="#SearchMolecularFormulas.run_search-189"><span class="linenos">189</span></a>
</span><span id="SearchMolecularFormulas.run_search-190"><a href="#SearchMolecularFormulas.run_search-190"><span class="linenos">190</span></a>        <span class="c1"># MolecularFormulaSearchFilters().check_min_peaks(all_assigned_indexes, self.mass_spectrum_obj)</span>
</span><span id="SearchMolecularFormulas.run_search-191"><a href="#SearchMolecularFormulas.run_search-191"><span class="linenos">191</span></a>        <span class="c1"># filter per min peaks per mono isotopic class</span>
</span></pre></div>


            <div class="docstring"><p>Run the molecular formula search.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>mspeaks</strong> (list of MSPeak):
The list of mass spectrum peaks.</li>
<li><strong>query</strong> (dict):
The query dictionary containing the possible molecular formulas.</li>
<li><strong>min_abundance</strong> (float):
The minimum abundance threshold.</li>
<li><strong>ion_type</strong> (str):
The ion type.</li>
<li><strong>ion_charge</strong> (int):
The ion charge.</li>
<li><strong>adduct_atom</strong> (str, optional):
The adduct atom, by default None.</li>
</ul>
</div>


                            </div>
                            <div id="SearchMolecularFormulas.run_worker_mass_spectrum" class="classattr">
                                        <input id="SearchMolecularFormulas.run_worker_mass_spectrum-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_worker_mass_spectrum</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SearchMolecularFormulas.run_worker_mass_spectrum-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulas.run_worker_mass_spectrum"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulas.run_worker_mass_spectrum-193"><a href="#SearchMolecularFormulas.run_worker_mass_spectrum-193"><span class="linenos">193</span></a>    <span class="k">def</span> <span class="nf">run_worker_mass_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SearchMolecularFormulas.run_worker_mass_spectrum-194"><a href="#SearchMolecularFormulas.run_worker_mass_spectrum-194"><span class="linenos">194</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the molecular formula search on the mass spectrum object.&quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas.run_worker_mass_spectrum-195"><a href="#SearchMolecularFormulas.run_worker_mass_spectrum-195"><span class="linenos">195</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_molecular_formula</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas.run_worker_mass_spectrum-196"><a href="#SearchMolecularFormulas.run_worker_mass_spectrum-196"><span class="linenos">196</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">sort_by_abundance</span><span class="p">(),</span> 
</span><span id="SearchMolecularFormulas.run_worker_mass_spectrum-197"><a href="#SearchMolecularFormulas.run_worker_mass_spectrum-197"><span class="linenos">197</span></a>            <span class="n">print_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="SearchMolecularFormulas.run_worker_mass_spectrum-198"><a href="#SearchMolecularFormulas.run_worker_mass_spectrum-198"><span class="linenos">198</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Run the molecular formula search on the mass spectrum object.</p>
</div>


                            </div>
                            <div id="SearchMolecularFormulas.run_worker_ms_peaks" class="classattr">
                                        <input id="SearchMolecularFormulas.run_worker_ms_peaks-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_worker_ms_peaks</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">ms_peaks</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SearchMolecularFormulas.run_worker_ms_peaks-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulas.run_worker_ms_peaks"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulas.run_worker_ms_peaks-200"><a href="#SearchMolecularFormulas.run_worker_ms_peaks-200"><span class="linenos">200</span></a>    <span class="k">def</span> <span class="nf">run_worker_ms_peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms_peaks</span><span class="p">):</span>
</span><span id="SearchMolecularFormulas.run_worker_ms_peaks-201"><a href="#SearchMolecularFormulas.run_worker_ms_peaks-201"><span class="linenos">201</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the molecular formula search on the given list of mass spectrum peaks.</span>
</span><span id="SearchMolecularFormulas.run_worker_ms_peaks-202"><a href="#SearchMolecularFormulas.run_worker_ms_peaks-202"><span class="linenos">202</span></a>
</span><span id="SearchMolecularFormulas.run_worker_ms_peaks-203"><a href="#SearchMolecularFormulas.run_worker_ms_peaks-203"><span class="linenos">203</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulas.run_worker_ms_peaks-204"><a href="#SearchMolecularFormulas.run_worker_ms_peaks-204"><span class="linenos">204</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulas.run_worker_ms_peaks-205"><a href="#SearchMolecularFormulas.run_worker_ms_peaks-205"><span class="linenos">205</span></a><span class="sd">        ms_peaks : list of MSPeak</span>
</span><span id="SearchMolecularFormulas.run_worker_ms_peaks-206"><a href="#SearchMolecularFormulas.run_worker_ms_peaks-206"><span class="linenos">206</span></a><span class="sd">            The list of mass spectrum peaks.</span>
</span><span id="SearchMolecularFormulas.run_worker_ms_peaks-207"><a href="#SearchMolecularFormulas.run_worker_ms_peaks-207"><span class="linenos">207</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas.run_worker_ms_peaks-208"><a href="#SearchMolecularFormulas.run_worker_ms_peaks-208"><span class="linenos">208</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_molecular_formula</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas.run_worker_ms_peaks-209"><a href="#SearchMolecularFormulas.run_worker_ms_peaks-209"><span class="linenos">209</span></a>            <span class="n">ms_peaks</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.run_worker_ms_peaks-210"><a href="#SearchMolecularFormulas.run_worker_ms_peaks-210"><span class="linenos">210</span></a>            <span class="n">print_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="SearchMolecularFormulas.run_worker_ms_peaks-211"><a href="#SearchMolecularFormulas.run_worker_ms_peaks-211"><span class="linenos">211</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Run the molecular formula search on the given list of mass spectrum peaks.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>ms_peaks</strong> (list of MSPeak):
The list of mass spectrum peaks.</li>
</ul>
</div>


                            </div>
                            <div id="SearchMolecularFormulas.database_to_dict" class="classattr">
                                        <input id="SearchMolecularFormulas.database_to_dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">database_to_dict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">classe_str_list</span>, </span><span class="param"><span class="n">nominal_mzs</span>, </span><span class="param"><span class="n">mf_search_settings</span>, </span><span class="param"><span class="n">ion_charge</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SearchMolecularFormulas.database_to_dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulas.database_to_dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulas.database_to_dict-213"><a href="#SearchMolecularFormulas.database_to_dict-213"><span class="linenos">213</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SearchMolecularFormulas.database_to_dict-214"><a href="#SearchMolecularFormulas.database_to_dict-214"><span class="linenos">214</span></a>    <span class="k">def</span> <span class="nf">database_to_dict</span><span class="p">(</span><span class="n">classe_str_list</span><span class="p">,</span> <span class="n">nominal_mzs</span><span class="p">,</span> <span class="n">mf_search_settings</span><span class="p">,</span> <span class="n">ion_charge</span><span class="p">):</span>
</span><span id="SearchMolecularFormulas.database_to_dict-215"><a href="#SearchMolecularFormulas.database_to_dict-215"><span class="linenos">215</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert the database results to a dictionary.</span>
</span><span id="SearchMolecularFormulas.database_to_dict-216"><a href="#SearchMolecularFormulas.database_to_dict-216"><span class="linenos">216</span></a>
</span><span id="SearchMolecularFormulas.database_to_dict-217"><a href="#SearchMolecularFormulas.database_to_dict-217"><span class="linenos">217</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulas.database_to_dict-218"><a href="#SearchMolecularFormulas.database_to_dict-218"><span class="linenos">218</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulas.database_to_dict-219"><a href="#SearchMolecularFormulas.database_to_dict-219"><span class="linenos">219</span></a><span class="sd">        classe_str_list : list</span>
</span><span id="SearchMolecularFormulas.database_to_dict-220"><a href="#SearchMolecularFormulas.database_to_dict-220"><span class="linenos">220</span></a><span class="sd">            The list of class strings.</span>
</span><span id="SearchMolecularFormulas.database_to_dict-221"><a href="#SearchMolecularFormulas.database_to_dict-221"><span class="linenos">221</span></a><span class="sd">        nominal_mzs : list</span>
</span><span id="SearchMolecularFormulas.database_to_dict-222"><a href="#SearchMolecularFormulas.database_to_dict-222"><span class="linenos">222</span></a><span class="sd">            The list of nominal m/z values.</span>
</span><span id="SearchMolecularFormulas.database_to_dict-223"><a href="#SearchMolecularFormulas.database_to_dict-223"><span class="linenos">223</span></a><span class="sd">        mf_search_settings : MolecularFormulaSearchSettings</span>
</span><span id="SearchMolecularFormulas.database_to_dict-224"><a href="#SearchMolecularFormulas.database_to_dict-224"><span class="linenos">224</span></a><span class="sd">            The molecular formula search settings.</span>
</span><span id="SearchMolecularFormulas.database_to_dict-225"><a href="#SearchMolecularFormulas.database_to_dict-225"><span class="linenos">225</span></a><span class="sd">        ion_charge : int</span>
</span><span id="SearchMolecularFormulas.database_to_dict-226"><a href="#SearchMolecularFormulas.database_to_dict-226"><span class="linenos">226</span></a><span class="sd">            The ion charge.</span>
</span><span id="SearchMolecularFormulas.database_to_dict-227"><a href="#SearchMolecularFormulas.database_to_dict-227"><span class="linenos">227</span></a>
</span><span id="SearchMolecularFormulas.database_to_dict-228"><a href="#SearchMolecularFormulas.database_to_dict-228"><span class="linenos">228</span></a><span class="sd">        Returns</span>
</span><span id="SearchMolecularFormulas.database_to_dict-229"><a href="#SearchMolecularFormulas.database_to_dict-229"><span class="linenos">229</span></a><span class="sd">        -------</span>
</span><span id="SearchMolecularFormulas.database_to_dict-230"><a href="#SearchMolecularFormulas.database_to_dict-230"><span class="linenos">230</span></a><span class="sd">        dict</span>
</span><span id="SearchMolecularFormulas.database_to_dict-231"><a href="#SearchMolecularFormulas.database_to_dict-231"><span class="linenos">231</span></a><span class="sd">            The dictionary containing the database results.</span>
</span><span id="SearchMolecularFormulas.database_to_dict-232"><a href="#SearchMolecularFormulas.database_to_dict-232"><span class="linenos">232</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas.database_to_dict-233"><a href="#SearchMolecularFormulas.database_to_dict-233"><span class="linenos">233</span></a>        <span class="n">sql_db</span> <span class="o">=</span> <span class="n">MolForm_SQL</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">mf_search_settings</span><span class="o">.</span><span class="n">url_database</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas.database_to_dict-234"><a href="#SearchMolecularFormulas.database_to_dict-234"><span class="linenos">234</span></a>
</span><span id="SearchMolecularFormulas.database_to_dict-235"><a href="#SearchMolecularFormulas.database_to_dict-235"><span class="linenos">235</span></a>        <span class="n">dict_res</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SearchMolecularFormulas.database_to_dict-236"><a href="#SearchMolecularFormulas.database_to_dict-236"><span class="linenos">236</span></a>
</span><span id="SearchMolecularFormulas.database_to_dict-237"><a href="#SearchMolecularFormulas.database_to_dict-237"><span class="linenos">237</span></a>        <span class="k">if</span> <span class="n">mf_search_settings</span><span class="o">.</span><span class="n">isProtonated</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas.database_to_dict-238"><a href="#SearchMolecularFormulas.database_to_dict-238"><span class="linenos">238</span></a>            <span class="n">dict_res</span><span class="p">[</span><span class="n">Labels</span><span class="o">.</span><span class="n">protonated_de_ion</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql_db</span><span class="o">.</span><span class="n">get_dict_by_classes</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas.database_to_dict-239"><a href="#SearchMolecularFormulas.database_to_dict-239"><span class="linenos">239</span></a>                <span class="n">classe_str_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.database_to_dict-240"><a href="#SearchMolecularFormulas.database_to_dict-240"><span class="linenos">240</span></a>                <span class="n">Labels</span><span class="o">.</span><span class="n">protonated_de_ion</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.database_to_dict-241"><a href="#SearchMolecularFormulas.database_to_dict-241"><span class="linenos">241</span></a>                <span class="n">nominal_mzs</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.database_to_dict-242"><a href="#SearchMolecularFormulas.database_to_dict-242"><span class="linenos">242</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.database_to_dict-243"><a href="#SearchMolecularFormulas.database_to_dict-243"><span class="linenos">243</span></a>                <span class="n">mf_search_settings</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.database_to_dict-244"><a href="#SearchMolecularFormulas.database_to_dict-244"><span class="linenos">244</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulas.database_to_dict-245"><a href="#SearchMolecularFormulas.database_to_dict-245"><span class="linenos">245</span></a>
</span><span id="SearchMolecularFormulas.database_to_dict-246"><a href="#SearchMolecularFormulas.database_to_dict-246"><span class="linenos">246</span></a>        <span class="k">if</span> <span class="n">mf_search_settings</span><span class="o">.</span><span class="n">isRadical</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas.database_to_dict-247"><a href="#SearchMolecularFormulas.database_to_dict-247"><span class="linenos">247</span></a>            <span class="n">dict_res</span><span class="p">[</span><span class="n">Labels</span><span class="o">.</span><span class="n">radical_ion</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql_db</span><span class="o">.</span><span class="n">get_dict_by_classes</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas.database_to_dict-248"><a href="#SearchMolecularFormulas.database_to_dict-248"><span class="linenos">248</span></a>                <span class="n">classe_str_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.database_to_dict-249"><a href="#SearchMolecularFormulas.database_to_dict-249"><span class="linenos">249</span></a>                <span class="n">Labels</span><span class="o">.</span><span class="n">radical_ion</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.database_to_dict-250"><a href="#SearchMolecularFormulas.database_to_dict-250"><span class="linenos">250</span></a>                <span class="n">nominal_mzs</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.database_to_dict-251"><a href="#SearchMolecularFormulas.database_to_dict-251"><span class="linenos">251</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.database_to_dict-252"><a href="#SearchMolecularFormulas.database_to_dict-252"><span class="linenos">252</span></a>                <span class="n">mf_search_settings</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.database_to_dict-253"><a href="#SearchMolecularFormulas.database_to_dict-253"><span class="linenos">253</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulas.database_to_dict-254"><a href="#SearchMolecularFormulas.database_to_dict-254"><span class="linenos">254</span></a>
</span><span id="SearchMolecularFormulas.database_to_dict-255"><a href="#SearchMolecularFormulas.database_to_dict-255"><span class="linenos">255</span></a>        <span class="k">if</span> <span class="n">mf_search_settings</span><span class="o">.</span><span class="n">isAdduct</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas.database_to_dict-256"><a href="#SearchMolecularFormulas.database_to_dict-256"><span class="linenos">256</span></a>            <span class="n">adduct_list</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulas.database_to_dict-257"><a href="#SearchMolecularFormulas.database_to_dict-257"><span class="linenos">257</span></a>                <span class="n">mf_search_settings</span><span class="o">.</span><span class="n">adduct_atoms_neg</span>
</span><span id="SearchMolecularFormulas.database_to_dict-258"><a href="#SearchMolecularFormulas.database_to_dict-258"><span class="linenos">258</span></a>                <span class="k">if</span> <span class="n">ion_charge</span> <span class="o">&lt;</span> <span class="mi">0</span>
</span><span id="SearchMolecularFormulas.database_to_dict-259"><a href="#SearchMolecularFormulas.database_to_dict-259"><span class="linenos">259</span></a>                <span class="k">else</span> <span class="n">mf_search_settings</span><span class="o">.</span><span class="n">adduct_atoms_pos</span>
</span><span id="SearchMolecularFormulas.database_to_dict-260"><a href="#SearchMolecularFormulas.database_to_dict-260"><span class="linenos">260</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulas.database_to_dict-261"><a href="#SearchMolecularFormulas.database_to_dict-261"><span class="linenos">261</span></a>            <span class="n">dict_res</span><span class="p">[</span><span class="n">Labels</span><span class="o">.</span><span class="n">adduct_ion</span><span class="p">]</span> <span class="o">=</span> <span class="n">sql_db</span><span class="o">.</span><span class="n">get_dict_by_classes</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas.database_to_dict-262"><a href="#SearchMolecularFormulas.database_to_dict-262"><span class="linenos">262</span></a>                <span class="n">classe_str_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.database_to_dict-263"><a href="#SearchMolecularFormulas.database_to_dict-263"><span class="linenos">263</span></a>                <span class="n">Labels</span><span class="o">.</span><span class="n">adduct_ion</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.database_to_dict-264"><a href="#SearchMolecularFormulas.database_to_dict-264"><span class="linenos">264</span></a>                <span class="n">nominal_mzs</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.database_to_dict-265"><a href="#SearchMolecularFormulas.database_to_dict-265"><span class="linenos">265</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.database_to_dict-266"><a href="#SearchMolecularFormulas.database_to_dict-266"><span class="linenos">266</span></a>                <span class="n">mf_search_settings</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.database_to_dict-267"><a href="#SearchMolecularFormulas.database_to_dict-267"><span class="linenos">267</span></a>                <span class="n">adducts</span><span class="o">=</span><span class="n">adduct_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.database_to_dict-268"><a href="#SearchMolecularFormulas.database_to_dict-268"><span class="linenos">268</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulas.database_to_dict-269"><a href="#SearchMolecularFormulas.database_to_dict-269"><span class="linenos">269</span></a>
</span><span id="SearchMolecularFormulas.database_to_dict-270"><a href="#SearchMolecularFormulas.database_to_dict-270"><span class="linenos">270</span></a>        <span class="k">return</span> <span class="n">dict_res</span>
</span></pre></div>


            <div class="docstring"><p>Convert the database results to a dictionary.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>classe_str_list</strong> (list):
The list of class strings.</li>
<li><strong>nominal_mzs</strong> (list):
The list of nominal m/z values.</li>
<li><strong>mf_search_settings</strong> (MolecularFormulaSearchSettings):
The molecular formula search settings.</li>
<li><strong>ion_charge</strong> (int):
The ion charge.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>dict</strong>: The dictionary containing the database results.</li>
</ul>
</div>


                            </div>
                            <div id="SearchMolecularFormulas.run_molecular_formula" class="classattr">
                                        <input id="SearchMolecularFormulas.run_molecular_formula-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_molecular_formula</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kw</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SearchMolecularFormulas.run_molecular_formula-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulas.run_molecular_formula"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulas.run_molecular_formula-27"><a href="#SearchMolecularFormulas.run_molecular_formula-27"><span class="linenos">27</span></a>        <span class="k">def</span> <span class="nf">timed</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
</span><span id="SearchMolecularFormulas.run_molecular_formula-28"><a href="#SearchMolecularFormulas.run_molecular_formula-28"><span class="linenos">28</span></a>            <span class="c1"># Extract print_time from kwargs if provided</span>
</span><span id="SearchMolecularFormulas.run_molecular_formula-29"><a href="#SearchMolecularFormulas.run_molecular_formula-29"><span class="linenos">29</span></a>            <span class="n">local_print_time</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;print_time&#39;</span><span class="p">,</span> <span class="n">print_time</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas.run_molecular_formula-30"><a href="#SearchMolecularFormulas.run_molecular_formula-30"><span class="linenos">30</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="SearchMolecularFormulas.run_molecular_formula-31"><a href="#SearchMolecularFormulas.run_molecular_formula-31"><span class="linenos">31</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas.run_molecular_formula-32"><a href="#SearchMolecularFormulas.run_molecular_formula-32"><span class="linenos">32</span></a>            <span class="n">te</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="SearchMolecularFormulas.run_molecular_formula-33"><a href="#SearchMolecularFormulas.run_molecular_formula-33"><span class="linenos">33</span></a>            <span class="k">if</span> <span class="s2">&quot;log_time&quot;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas.run_molecular_formula-34"><a href="#SearchMolecularFormulas.run_molecular_formula-34"><span class="linenos">34</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;log_name&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
</span><span id="SearchMolecularFormulas.run_molecular_formula-35"><a href="#SearchMolecularFormulas.run_molecular_formula-35"><span class="linenos">35</span></a>                <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;log_time&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">te</span> <span class="o">-</span> <span class="n">ts</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas.run_molecular_formula-36"><a href="#SearchMolecularFormulas.run_molecular_formula-36"><span class="linenos">36</span></a>            <span class="k">elif</span> <span class="n">local_print_time</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas.run_molecular_formula-37"><a href="#SearchMolecularFormulas.run_molecular_formula-37"><span class="linenos">37</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2">  </span><span class="si">%2.2f</span><span class="s2"> ms&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="p">(</span><span class="n">te</span> <span class="o">-</span> <span class="n">ts</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
</span><span id="SearchMolecularFormulas.run_molecular_formula-38"><a href="#SearchMolecularFormulas.run_molecular_formula-38"><span class="linenos">38</span></a>            <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>Run the molecular formula search on the given list of mass spectrum peaks.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>ms_peaks</strong> (list of MSPeak):
The list of mass spectrum peaks.</li>
<li><strong>**kwargs</strong>: Additional keyword arguments. 
Most notably, print_time, which is a boolean flag to indicate whether to print the time 
and passed to the timeit decorator.</li>
</ul>
</div>


                            </div>
                            <div id="SearchMolecularFormulas.search_mol_formulas" class="classattr">
                                        <input id="SearchMolecularFormulas.search_mol_formulas-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">search_mol_formulas</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">possible_formulas_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n"><a href="../../molecular_formula/factory/MolecularFormulaFactory.html#MolecularFormula">corems.molecular_formula.factory.MolecularFormulaFactory.MolecularFormula</a></span><span class="p">]</span>,</span><span class="param">	<span class="n">ion_type</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">neutral_molform</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">find_isotopologues</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">adduct_atom</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">corems</span><span class="o">.</span><span class="n">ms_peak</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">MSPeakClasses</span><span class="o">.</span><span class="n">_MSPeak</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="SearchMolecularFormulas.search_mol_formulas-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulas.search_mol_formulas"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulas.search_mol_formulas-389"><a href="#SearchMolecularFormulas.search_mol_formulas-389"><span class="linenos">389</span></a>    <span class="k">def</span> <span class="nf">search_mol_formulas</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-390"><a href="#SearchMolecularFormulas.search_mol_formulas-390"><span class="linenos">390</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-391"><a href="#SearchMolecularFormulas.search_mol_formulas-391"><span class="linenos">391</span></a>        <span class="n">possible_formulas_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MolecularFormula</span><span class="p">],</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-392"><a href="#SearchMolecularFormulas.search_mol_formulas-392"><span class="linenos">392</span></a>        <span class="n">ion_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-393"><a href="#SearchMolecularFormulas.search_mol_formulas-393"><span class="linenos">393</span></a>        <span class="n">neutral_molform</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-394"><a href="#SearchMolecularFormulas.search_mol_formulas-394"><span class="linenos">394</span></a>        <span class="n">find_isotopologues</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-395"><a href="#SearchMolecularFormulas.search_mol_formulas-395"><span class="linenos">395</span></a>        <span class="n">adduct_atom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-396"><a href="#SearchMolecularFormulas.search_mol_formulas-396"><span class="linenos">396</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">_MSPeak</span><span class="p">]:</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-397"><a href="#SearchMolecularFormulas.search_mol_formulas-397"><span class="linenos">397</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Search for molecular formulas in the mass spectrum.</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-398"><a href="#SearchMolecularFormulas.search_mol_formulas-398"><span class="linenos">398</span></a>
</span><span id="SearchMolecularFormulas.search_mol_formulas-399"><a href="#SearchMolecularFormulas.search_mol_formulas-399"><span class="linenos">399</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-400"><a href="#SearchMolecularFormulas.search_mol_formulas-400"><span class="linenos">400</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-401"><a href="#SearchMolecularFormulas.search_mol_formulas-401"><span class="linenos">401</span></a><span class="sd">        possible_formulas_list : list of MolecularFormula</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-402"><a href="#SearchMolecularFormulas.search_mol_formulas-402"><span class="linenos">402</span></a><span class="sd">            The list of possible molecular formulas.</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-403"><a href="#SearchMolecularFormulas.search_mol_formulas-403"><span class="linenos">403</span></a><span class="sd">        ion_type : str</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-404"><a href="#SearchMolecularFormulas.search_mol_formulas-404"><span class="linenos">404</span></a><span class="sd">            The ion type.</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-405"><a href="#SearchMolecularFormulas.search_mol_formulas-405"><span class="linenos">405</span></a><span class="sd">        neutral_molform : bool, optional</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-406"><a href="#SearchMolecularFormulas.search_mol_formulas-406"><span class="linenos">406</span></a><span class="sd">            Flag to indicate whether the molecular formulas are neutral, by default True.</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-407"><a href="#SearchMolecularFormulas.search_mol_formulas-407"><span class="linenos">407</span></a><span class="sd">        find_isotopologues : bool, optional</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-408"><a href="#SearchMolecularFormulas.search_mol_formulas-408"><span class="linenos">408</span></a><span class="sd">            Flag to indicate whether to find isotopologues, by default True.</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-409"><a href="#SearchMolecularFormulas.search_mol_formulas-409"><span class="linenos">409</span></a><span class="sd">        adduct_atom : str, optional</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-410"><a href="#SearchMolecularFormulas.search_mol_formulas-410"><span class="linenos">410</span></a><span class="sd">            The adduct atom, by default None.</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-411"><a href="#SearchMolecularFormulas.search_mol_formulas-411"><span class="linenos">411</span></a>
</span><span id="SearchMolecularFormulas.search_mol_formulas-412"><a href="#SearchMolecularFormulas.search_mol_formulas-412"><span class="linenos">412</span></a><span class="sd">        Returns</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-413"><a href="#SearchMolecularFormulas.search_mol_formulas-413"><span class="linenos">413</span></a><span class="sd">        -------</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-414"><a href="#SearchMolecularFormulas.search_mol_formulas-414"><span class="linenos">414</span></a><span class="sd">        list of MSPeak</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-415"><a href="#SearchMolecularFormulas.search_mol_formulas-415"><span class="linenos">415</span></a><span class="sd">            The list of mass spectrum peaks with assigned molecular formulas.</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-416"><a href="#SearchMolecularFormulas.search_mol_formulas-416"><span class="linenos">416</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-417"><a href="#SearchMolecularFormulas.search_mol_formulas-417"><span class="linenos">417</span></a>        <span class="c1"># neutral_molform: some reference files already present the formula on ion mode, for instance, bruker reference files</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-418"><a href="#SearchMolecularFormulas.search_mol_formulas-418"><span class="linenos">418</span></a>        <span class="c1">#    if that is the case than turn neutral_molform off</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-419"><a href="#SearchMolecularFormulas.search_mol_formulas-419"><span class="linenos">419</span></a>
</span><span id="SearchMolecularFormulas.search_mol_formulas-420"><a href="#SearchMolecularFormulas.search_mol_formulas-420"><span class="linenos">420</span></a>        <span class="n">SearchMolecularFormulaWorker</span><span class="p">(</span><span class="n">find_isotopologues</span><span class="o">=</span><span class="n">find_isotopologues</span><span class="p">)</span><span class="o">.</span><span class="n">reset_error</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-421"><a href="#SearchMolecularFormulas.search_mol_formulas-421"><span class="linenos">421</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-422"><a href="#SearchMolecularFormulas.search_mol_formulas-422"><span class="linenos">422</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-423"><a href="#SearchMolecularFormulas.search_mol_formulas-423"><span class="linenos">423</span></a>
</span><span id="SearchMolecularFormulas.search_mol_formulas-424"><a href="#SearchMolecularFormulas.search_mol_formulas-424"><span class="linenos">424</span></a>        <span class="n">initial_min_peak_bool</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-425"><a href="#SearchMolecularFormulas.search_mol_formulas-425"><span class="linenos">425</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_min_peaks_filter</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-426"><a href="#SearchMolecularFormulas.search_mol_formulas-426"><span class="linenos">426</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-427"><a href="#SearchMolecularFormulas.search_mol_formulas-427"><span class="linenos">427</span></a>        <span class="n">initial_runtime_kendrick_filter</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-428"><a href="#SearchMolecularFormulas.search_mol_formulas-428"><span class="linenos">428</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_runtime_kendrick_filter</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-429"><a href="#SearchMolecularFormulas.search_mol_formulas-429"><span class="linenos">429</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-430"><a href="#SearchMolecularFormulas.search_mol_formulas-430"><span class="linenos">430</span></a>
</span><span id="SearchMolecularFormulas.search_mol_formulas-431"><a href="#SearchMolecularFormulas.search_mol_formulas-431"><span class="linenos">431</span></a>        <span class="c1"># Are the following 3 lines redundant?</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-432"><a href="#SearchMolecularFormulas.search_mol_formulas-432"><span class="linenos">432</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_min_peaks_filter</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-433"><a href="#SearchMolecularFormulas.search_mol_formulas-433"><span class="linenos">433</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_min_peaks_filter</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-434"><a href="#SearchMolecularFormulas.search_mol_formulas-434"><span class="linenos">434</span></a>            <span class="kc">False</span>  <span class="c1"># TODO check this line</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-435"><a href="#SearchMolecularFormulas.search_mol_formulas-435"><span class="linenos">435</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-436"><a href="#SearchMolecularFormulas.search_mol_formulas-436"><span class="linenos">436</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_runtime_kendrick_filter</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-437"><a href="#SearchMolecularFormulas.search_mol_formulas-437"><span class="linenos">437</span></a>            <span class="kc">False</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-438"><a href="#SearchMolecularFormulas.search_mol_formulas-438"><span class="linenos">438</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-439"><a href="#SearchMolecularFormulas.search_mol_formulas-439"><span class="linenos">439</span></a>
</span><span id="SearchMolecularFormulas.search_mol_formulas-440"><a href="#SearchMolecularFormulas.search_mol_formulas-440"><span class="linenos">440</span></a>        <span class="n">possible_formulas_dict_nm</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-441"><a href="#SearchMolecularFormulas.search_mol_formulas-441"><span class="linenos">441</span></a>
</span><span id="SearchMolecularFormulas.search_mol_formulas-442"><a href="#SearchMolecularFormulas.search_mol_formulas-442"><span class="linenos">442</span></a>        <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="n">possible_formulas_list</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-443"><a href="#SearchMolecularFormulas.search_mol_formulas-443"><span class="linenos">443</span></a>            <span class="k">if</span> <span class="n">neutral_molform</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-444"><a href="#SearchMolecularFormulas.search_mol_formulas-444"><span class="linenos">444</span></a>                <span class="n">nm</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">protonated_mz</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-445"><a href="#SearchMolecularFormulas.search_mol_formulas-445"><span class="linenos">445</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-446"><a href="#SearchMolecularFormulas.search_mol_formulas-446"><span class="linenos">446</span></a>                <span class="n">nm</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">mz_nominal_calc</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-447"><a href="#SearchMolecularFormulas.search_mol_formulas-447"><span class="linenos">447</span></a>
</span><span id="SearchMolecularFormulas.search_mol_formulas-448"><a href="#SearchMolecularFormulas.search_mol_formulas-448"><span class="linenos">448</span></a>            <span class="k">if</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">possible_formulas_dict_nm</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-449"><a href="#SearchMolecularFormulas.search_mol_formulas-449"><span class="linenos">449</span></a>                <span class="n">possible_formulas_dict_nm</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-450"><a href="#SearchMolecularFormulas.search_mol_formulas-450"><span class="linenos">450</span></a>
</span><span id="SearchMolecularFormulas.search_mol_formulas-451"><a href="#SearchMolecularFormulas.search_mol_formulas-451"><span class="linenos">451</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-452"><a href="#SearchMolecularFormulas.search_mol_formulas-452"><span class="linenos">452</span></a>                <span class="n">possible_formulas_dict_nm</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mf</span><span class="p">]</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-453"><a href="#SearchMolecularFormulas.search_mol_formulas-453"><span class="linenos">453</span></a>
</span><span id="SearchMolecularFormulas.search_mol_formulas-454"><a href="#SearchMolecularFormulas.search_mol_formulas-454"><span class="linenos">454</span></a>        <span class="n">min_abundance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">min_abundance</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-455"><a href="#SearchMolecularFormulas.search_mol_formulas-455"><span class="linenos">455</span></a>
</span><span id="SearchMolecularFormulas.search_mol_formulas-456"><a href="#SearchMolecularFormulas.search_mol_formulas-456"><span class="linenos">456</span></a>        <span class="n">ion_type</span> <span class="o">=</span> <span class="n">ion_type</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-457"><a href="#SearchMolecularFormulas.search_mol_formulas-457"><span class="linenos">457</span></a>
</span><span id="SearchMolecularFormulas.search_mol_formulas-458"><a href="#SearchMolecularFormulas.search_mol_formulas-458"><span class="linenos">458</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">run_search</span><span class="p">(</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-459"><a href="#SearchMolecularFormulas.search_mol_formulas-459"><span class="linenos">459</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-460"><a href="#SearchMolecularFormulas.search_mol_formulas-460"><span class="linenos">460</span></a>            <span class="n">possible_formulas_dict_nm</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-461"><a href="#SearchMolecularFormulas.search_mol_formulas-461"><span class="linenos">461</span></a>            <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-462"><a href="#SearchMolecularFormulas.search_mol_formulas-462"><span class="linenos">462</span></a>            <span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-463"><a href="#SearchMolecularFormulas.search_mol_formulas-463"><span class="linenos">463</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">polarity</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-464"><a href="#SearchMolecularFormulas.search_mol_formulas-464"><span class="linenos">464</span></a>            <span class="n">adduct_atom</span><span class="o">=</span><span class="n">adduct_atom</span><span class="p">,</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-465"><a href="#SearchMolecularFormulas.search_mol_formulas-465"><span class="linenos">465</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-466"><a href="#SearchMolecularFormulas.search_mol_formulas-466"><span class="linenos">466</span></a>
</span><span id="SearchMolecularFormulas.search_mol_formulas-467"><a href="#SearchMolecularFormulas.search_mol_formulas-467"><span class="linenos">467</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_min_peaks_filter</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-468"><a href="#SearchMolecularFormulas.search_mol_formulas-468"><span class="linenos">468</span></a>            <span class="n">initial_min_peak_bool</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-469"><a href="#SearchMolecularFormulas.search_mol_formulas-469"><span class="linenos">469</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-470"><a href="#SearchMolecularFormulas.search_mol_formulas-470"><span class="linenos">470</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">use_runtime_kendrick_filter</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-471"><a href="#SearchMolecularFormulas.search_mol_formulas-471"><span class="linenos">471</span></a>            <span class="n">initial_runtime_kendrick_filter</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-472"><a href="#SearchMolecularFormulas.search_mol_formulas-472"><span class="linenos">472</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-473"><a href="#SearchMolecularFormulas.search_mol_formulas-473"><span class="linenos">473</span></a>
</span><span id="SearchMolecularFormulas.search_mol_formulas-474"><a href="#SearchMolecularFormulas.search_mol_formulas-474"><span class="linenos">474</span></a>        <span class="n">mspeaks</span> <span class="o">=</span> <span class="p">[</span><span class="n">mspeak</span> <span class="k">for</span> <span class="n">mspeak</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_spectrum_obj</span> <span class="k">if</span> <span class="n">mspeak</span><span class="o">.</span><span class="n">is_assigned</span><span class="p">]</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-475"><a href="#SearchMolecularFormulas.search_mol_formulas-475"><span class="linenos">475</span></a>
</span><span id="SearchMolecularFormulas.search_mol_formulas-476"><a href="#SearchMolecularFormulas.search_mol_formulas-476"><span class="linenos">476</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="SearchMolecularFormulas.search_mol_formulas-477"><a href="#SearchMolecularFormulas.search_mol_formulas-477"><span class="linenos">477</span></a>
</span><span id="SearchMolecularFormulas.search_mol_formulas-478"><a href="#SearchMolecularFormulas.search_mol_formulas-478"><span class="linenos">478</span></a>        <span class="k">return</span> <span class="n">mspeaks</span>
</span></pre></div>


            <div class="docstring"><p>Search for molecular formulas in the mass spectrum.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>possible_formulas_list</strong> (list of MolecularFormula):
The list of possible molecular formulas.</li>
<li><strong>ion_type</strong> (str):
The ion type.</li>
<li><strong>neutral_molform</strong> (bool, optional):
Flag to indicate whether the molecular formulas are neutral, by default True.</li>
<li><strong>find_isotopologues</strong> (bool, optional):
Flag to indicate whether to find isotopologues, by default True.</li>
<li><strong>adduct_atom</strong> (str, optional):
The adduct atom, by default None.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list of MSPeak</strong>: The list of mass spectrum peaks with assigned molecular formulas.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="SearchMolecularFormulaWorker">
                            <input id="SearchMolecularFormulaWorker-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SearchMolecularFormulaWorker</span>:

                <label class="view-source-button" for="SearchMolecularFormulaWorker-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulaWorker"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulaWorker-481"><a href="#SearchMolecularFormulaWorker-481"><span class="linenos">481</span></a><span class="k">class</span> <span class="nc">SearchMolecularFormulaWorker</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-482"><a href="#SearchMolecularFormulaWorker-482"><span class="linenos">482</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for searching molecular formulas in a mass spectrum.</span>
</span><span id="SearchMolecularFormulaWorker-483"><a href="#SearchMolecularFormulaWorker-483"><span class="linenos">483</span></a>
</span><span id="SearchMolecularFormulaWorker-484"><a href="#SearchMolecularFormulaWorker-484"><span class="linenos">484</span></a><span class="sd">    Parameters</span>
</span><span id="SearchMolecularFormulaWorker-485"><a href="#SearchMolecularFormulaWorker-485"><span class="linenos">485</span></a><span class="sd">    ----------</span>
</span><span id="SearchMolecularFormulaWorker-486"><a href="#SearchMolecularFormulaWorker-486"><span class="linenos">486</span></a><span class="sd">    find_isotopologues : bool, optional</span>
</span><span id="SearchMolecularFormulaWorker-487"><a href="#SearchMolecularFormulaWorker-487"><span class="linenos">487</span></a><span class="sd">        Flag to indicate whether to find isotopologues, by default True.</span>
</span><span id="SearchMolecularFormulaWorker-488"><a href="#SearchMolecularFormulaWorker-488"><span class="linenos">488</span></a>
</span><span id="SearchMolecularFormulaWorker-489"><a href="#SearchMolecularFormulaWorker-489"><span class="linenos">489</span></a><span class="sd">    Attributes</span>
</span><span id="SearchMolecularFormulaWorker-490"><a href="#SearchMolecularFormulaWorker-490"><span class="linenos">490</span></a><span class="sd">    ----------</span>
</span><span id="SearchMolecularFormulaWorker-491"><a href="#SearchMolecularFormulaWorker-491"><span class="linenos">491</span></a><span class="sd">    find_isotopologues : bool</span>
</span><span id="SearchMolecularFormulaWorker-492"><a href="#SearchMolecularFormulaWorker-492"><span class="linenos">492</span></a><span class="sd">        Flag to indicate whether to find isotopologues.</span>
</span><span id="SearchMolecularFormulaWorker-493"><a href="#SearchMolecularFormulaWorker-493"><span class="linenos">493</span></a>
</span><span id="SearchMolecularFormulaWorker-494"><a href="#SearchMolecularFormulaWorker-494"><span class="linenos">494</span></a><span class="sd">    Methods</span>
</span><span id="SearchMolecularFormulaWorker-495"><a href="#SearchMolecularFormulaWorker-495"><span class="linenos">495</span></a><span class="sd">    -------</span>
</span><span id="SearchMolecularFormulaWorker-496"><a href="#SearchMolecularFormulaWorker-496"><span class="linenos">496</span></a><span class="sd">    * reset_error().</span>
</span><span id="SearchMolecularFormulaWorker-497"><a href="#SearchMolecularFormulaWorker-497"><span class="linenos">497</span></a><span class="sd">        Reset the error variables.</span>
</span><span id="SearchMolecularFormulaWorker-498"><a href="#SearchMolecularFormulaWorker-498"><span class="linenos">498</span></a><span class="sd">    * set_last_error().</span>
</span><span id="SearchMolecularFormulaWorker-499"><a href="#SearchMolecularFormulaWorker-499"><span class="linenos">499</span></a><span class="sd">        Set the last error.</span>
</span><span id="SearchMolecularFormulaWorker-500"><a href="#SearchMolecularFormulaWorker-500"><span class="linenos">500</span></a><span class="sd">    * find_formulas().</span>
</span><span id="SearchMolecularFormulaWorker-501"><a href="#SearchMolecularFormulaWorker-501"><span class="linenos">501</span></a><span class="sd">        Find the formulas.</span>
</span><span id="SearchMolecularFormulaWorker-502"><a href="#SearchMolecularFormulaWorker-502"><span class="linenos">502</span></a><span class="sd">    * calc_error().</span>
</span><span id="SearchMolecularFormulaWorker-503"><a href="#SearchMolecularFormulaWorker-503"><span class="linenos">503</span></a><span class="sd">        Calculate the error.</span>
</span><span id="SearchMolecularFormulaWorker-504"><a href="#SearchMolecularFormulaWorker-504"><span class="linenos">504</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulaWorker-505"><a href="#SearchMolecularFormulaWorker-505"><span class="linenos">505</span></a>
</span><span id="SearchMolecularFormulaWorker-506"><a href="#SearchMolecularFormulaWorker-506"><span class="linenos">506</span></a>    <span class="c1"># TODO add reset error function</span>
</span><span id="SearchMolecularFormulaWorker-507"><a href="#SearchMolecularFormulaWorker-507"><span class="linenos">507</span></a>    <span class="c1"># needs this wraper to pass the class to multiprocessing</span>
</span><span id="SearchMolecularFormulaWorker-508"><a href="#SearchMolecularFormulaWorker-508"><span class="linenos">508</span></a>
</span><span id="SearchMolecularFormulaWorker-509"><a href="#SearchMolecularFormulaWorker-509"><span class="linenos">509</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">find_isotopologues</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="SearchMolecularFormulaWorker-510"><a href="#SearchMolecularFormulaWorker-510"><span class="linenos">510</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span> <span class="o">=</span> <span class="n">find_isotopologues</span>
</span><span id="SearchMolecularFormulaWorker-511"><a href="#SearchMolecularFormulaWorker-511"><span class="linenos">511</span></a>
</span><span id="SearchMolecularFormulaWorker-512"><a href="#SearchMolecularFormulaWorker-512"><span class="linenos">512</span></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
</span><span id="SearchMolecularFormulaWorker-513"><a href="#SearchMolecularFormulaWorker-513"><span class="linenos">513</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Call the find formulas function.</span>
</span><span id="SearchMolecularFormulaWorker-514"><a href="#SearchMolecularFormulaWorker-514"><span class="linenos">514</span></a>
</span><span id="SearchMolecularFormulaWorker-515"><a href="#SearchMolecularFormulaWorker-515"><span class="linenos">515</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulaWorker-516"><a href="#SearchMolecularFormulaWorker-516"><span class="linenos">516</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulaWorker-517"><a href="#SearchMolecularFormulaWorker-517"><span class="linenos">517</span></a><span class="sd">        args : tuple</span>
</span><span id="SearchMolecularFormulaWorker-518"><a href="#SearchMolecularFormulaWorker-518"><span class="linenos">518</span></a><span class="sd">            The arguments.</span>
</span><span id="SearchMolecularFormulaWorker-519"><a href="#SearchMolecularFormulaWorker-519"><span class="linenos">519</span></a>
</span><span id="SearchMolecularFormulaWorker-520"><a href="#SearchMolecularFormulaWorker-520"><span class="linenos">520</span></a><span class="sd">        Returns</span>
</span><span id="SearchMolecularFormulaWorker-521"><a href="#SearchMolecularFormulaWorker-521"><span class="linenos">521</span></a><span class="sd">        -------</span>
</span><span id="SearchMolecularFormulaWorker-522"><a href="#SearchMolecularFormulaWorker-522"><span class="linenos">522</span></a><span class="sd">        list</span>
</span><span id="SearchMolecularFormulaWorker-523"><a href="#SearchMolecularFormulaWorker-523"><span class="linenos">523</span></a><span class="sd">            The list of mass spectrum peaks with assigned molecular formulas.</span>
</span><span id="SearchMolecularFormulaWorker-524"><a href="#SearchMolecularFormulaWorker-524"><span class="linenos">524</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulaWorker-525"><a href="#SearchMolecularFormulaWorker-525"><span class="linenos">525</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_formulas</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>  <span class="c1"># ,args[1]</span>
</span><span id="SearchMolecularFormulaWorker-526"><a href="#SearchMolecularFormulaWorker-526"><span class="linenos">526</span></a>
</span><span id="SearchMolecularFormulaWorker-527"><a href="#SearchMolecularFormulaWorker-527"><span class="linenos">527</span></a>    <span class="k">def</span> <span class="nf">reset_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass_spectrum_obj</span><span class="p">):</span>
</span><span id="SearchMolecularFormulaWorker-528"><a href="#SearchMolecularFormulaWorker-528"><span class="linenos">528</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the error variables.</span>
</span><span id="SearchMolecularFormulaWorker-529"><a href="#SearchMolecularFormulaWorker-529"><span class="linenos">529</span></a>
</span><span id="SearchMolecularFormulaWorker-530"><a href="#SearchMolecularFormulaWorker-530"><span class="linenos">530</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulaWorker-531"><a href="#SearchMolecularFormulaWorker-531"><span class="linenos">531</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulaWorker-532"><a href="#SearchMolecularFormulaWorker-532"><span class="linenos">532</span></a><span class="sd">        mass_spectrum_obj : MassSpectrum</span>
</span><span id="SearchMolecularFormulaWorker-533"><a href="#SearchMolecularFormulaWorker-533"><span class="linenos">533</span></a><span class="sd">            The mass spectrum object.</span>
</span><span id="SearchMolecularFormulaWorker-534"><a href="#SearchMolecularFormulaWorker-534"><span class="linenos">534</span></a>
</span><span id="SearchMolecularFormulaWorker-535"><a href="#SearchMolecularFormulaWorker-535"><span class="linenos">535</span></a><span class="sd">        Notes</span>
</span><span id="SearchMolecularFormulaWorker-536"><a href="#SearchMolecularFormulaWorker-536"><span class="linenos">536</span></a><span class="sd">        -----</span>
</span><span id="SearchMolecularFormulaWorker-537"><a href="#SearchMolecularFormulaWorker-537"><span class="linenos">537</span></a><span class="sd">        This function resets the error variables for the given mass spectrum object.</span>
</span><span id="SearchMolecularFormulaWorker-538"><a href="#SearchMolecularFormulaWorker-538"><span class="linenos">538</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulaWorker-539"><a href="#SearchMolecularFormulaWorker-539"><span class="linenos">539</span></a>        <span class="k">global</span> <span class="n">last_error</span><span class="p">,</span> <span class="n">last_dif</span><span class="p">,</span> <span class="n">closest_error</span><span class="p">,</span> <span class="n">error_average</span><span class="p">,</span> <span class="n">nbValues</span>
</span><span id="SearchMolecularFormulaWorker-540"><a href="#SearchMolecularFormulaWorker-540"><span class="linenos">540</span></a>        <span class="n">last_error</span><span class="p">,</span> <span class="n">last_dif</span><span class="p">,</span> <span class="n">closest_error</span><span class="p">,</span> <span class="n">nbValues</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
</span><span id="SearchMolecularFormulaWorker-541"><a href="#SearchMolecularFormulaWorker-541"><span class="linenos">541</span></a>
</span><span id="SearchMolecularFormulaWorker-542"><a href="#SearchMolecularFormulaWorker-542"><span class="linenos">542</span></a>    <span class="k">def</span> <span class="nf">set_last_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">mass_spectrum_obj</span><span class="p">):</span>
</span><span id="SearchMolecularFormulaWorker-543"><a href="#SearchMolecularFormulaWorker-543"><span class="linenos">543</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the last error.</span>
</span><span id="SearchMolecularFormulaWorker-544"><a href="#SearchMolecularFormulaWorker-544"><span class="linenos">544</span></a>
</span><span id="SearchMolecularFormulaWorker-545"><a href="#SearchMolecularFormulaWorker-545"><span class="linenos">545</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulaWorker-546"><a href="#SearchMolecularFormulaWorker-546"><span class="linenos">546</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulaWorker-547"><a href="#SearchMolecularFormulaWorker-547"><span class="linenos">547</span></a><span class="sd">        error : float</span>
</span><span id="SearchMolecularFormulaWorker-548"><a href="#SearchMolecularFormulaWorker-548"><span class="linenos">548</span></a><span class="sd">            The error.</span>
</span><span id="SearchMolecularFormulaWorker-549"><a href="#SearchMolecularFormulaWorker-549"><span class="linenos">549</span></a><span class="sd">        mass_spectrum_obj : MassSpectrum</span>
</span><span id="SearchMolecularFormulaWorker-550"><a href="#SearchMolecularFormulaWorker-550"><span class="linenos">550</span></a><span class="sd">            The mass spectrum object.</span>
</span><span id="SearchMolecularFormulaWorker-551"><a href="#SearchMolecularFormulaWorker-551"><span class="linenos">551</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulaWorker-552"><a href="#SearchMolecularFormulaWorker-552"><span class="linenos">552</span></a>        <span class="c1"># set the changes to the global variables, not internal ones</span>
</span><span id="SearchMolecularFormulaWorker-553"><a href="#SearchMolecularFormulaWorker-553"><span class="linenos">553</span></a>        <span class="k">global</span> <span class="n">last_error</span><span class="p">,</span> <span class="n">last_dif</span><span class="p">,</span> <span class="n">closest_error</span><span class="p">,</span> <span class="n">error_average</span><span class="p">,</span> <span class="n">nbValues</span>
</span><span id="SearchMolecularFormulaWorker-554"><a href="#SearchMolecularFormulaWorker-554"><span class="linenos">554</span></a>
</span><span id="SearchMolecularFormulaWorker-555"><a href="#SearchMolecularFormulaWorker-555"><span class="linenos">555</span></a>        <span class="k">if</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">error_method</span> <span class="o">==</span> <span class="s2">&quot;distance&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-556"><a href="#SearchMolecularFormulaWorker-556"><span class="linenos">556</span></a>            <span class="n">dif</span> <span class="o">=</span> <span class="n">error</span> <span class="o">-</span> <span class="n">last_error</span>
</span><span id="SearchMolecularFormulaWorker-557"><a href="#SearchMolecularFormulaWorker-557"><span class="linenos">557</span></a>            <span class="k">if</span> <span class="n">dif</span> <span class="o">&lt;</span> <span class="n">last_dif</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-558"><a href="#SearchMolecularFormulaWorker-558"><span class="linenos">558</span></a>                <span class="n">last_dif</span> <span class="o">=</span> <span class="n">dif</span>
</span><span id="SearchMolecularFormulaWorker-559"><a href="#SearchMolecularFormulaWorker-559"><span class="linenos">559</span></a>                <span class="n">closest_error</span> <span class="o">=</span> <span class="n">error</span>
</span><span id="SearchMolecularFormulaWorker-560"><a href="#SearchMolecularFormulaWorker-560"><span class="linenos">560</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-561"><a href="#SearchMolecularFormulaWorker-561"><span class="linenos">561</span></a>                    <span class="n">closest_error</span>
</span><span id="SearchMolecularFormulaWorker-562"><a href="#SearchMolecularFormulaWorker-562"><span class="linenos">562</span></a>                    <span class="o">-</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="SearchMolecularFormulaWorker-563"><a href="#SearchMolecularFormulaWorker-563"><span class="linenos">563</span></a>                <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-564"><a href="#SearchMolecularFormulaWorker-564"><span class="linenos">564</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-565"><a href="#SearchMolecularFormulaWorker-565"><span class="linenos">565</span></a>                    <span class="n">closest_error</span>
</span><span id="SearchMolecularFormulaWorker-566"><a href="#SearchMolecularFormulaWorker-566"><span class="linenos">566</span></a>                    <span class="o">+</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="SearchMolecularFormulaWorker-567"><a href="#SearchMolecularFormulaWorker-567"><span class="linenos">567</span></a>                <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-568"><a href="#SearchMolecularFormulaWorker-568"><span class="linenos">568</span></a>
</span><span id="SearchMolecularFormulaWorker-569"><a href="#SearchMolecularFormulaWorker-569"><span class="linenos">569</span></a>        <span class="k">elif</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">error_method</span> <span class="o">==</span> <span class="s2">&quot;lowest&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-570"><a href="#SearchMolecularFormulaWorker-570"><span class="linenos">570</span></a>            <span class="k">if</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">last_error</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-571"><a href="#SearchMolecularFormulaWorker-571"><span class="linenos">571</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-572"><a href="#SearchMolecularFormulaWorker-572"><span class="linenos">572</span></a>                    <span class="n">error</span> <span class="o">-</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="SearchMolecularFormulaWorker-573"><a href="#SearchMolecularFormulaWorker-573"><span class="linenos">573</span></a>                <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-574"><a href="#SearchMolecularFormulaWorker-574"><span class="linenos">574</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-575"><a href="#SearchMolecularFormulaWorker-575"><span class="linenos">575</span></a>                    <span class="n">error</span> <span class="o">+</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="SearchMolecularFormulaWorker-576"><a href="#SearchMolecularFormulaWorker-576"><span class="linenos">576</span></a>                <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-577"><a href="#SearchMolecularFormulaWorker-577"><span class="linenos">577</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="n">error</span>
</span><span id="SearchMolecularFormulaWorker-578"><a href="#SearchMolecularFormulaWorker-578"><span class="linenos">578</span></a>
</span><span id="SearchMolecularFormulaWorker-579"><a href="#SearchMolecularFormulaWorker-579"><span class="linenos">579</span></a>        <span class="k">elif</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">error_method</span> <span class="o">==</span> <span class="s2">&quot;symmetrical&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-580"><a href="#SearchMolecularFormulaWorker-580"><span class="linenos">580</span></a>            <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-581"><a href="#SearchMolecularFormulaWorker-581"><span class="linenos">581</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_average</span>
</span><span id="SearchMolecularFormulaWorker-582"><a href="#SearchMolecularFormulaWorker-582"><span class="linenos">582</span></a>                <span class="o">-</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="SearchMolecularFormulaWorker-583"><a href="#SearchMolecularFormulaWorker-583"><span class="linenos">583</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-584"><a href="#SearchMolecularFormulaWorker-584"><span class="linenos">584</span></a>            <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-585"><a href="#SearchMolecularFormulaWorker-585"><span class="linenos">585</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_average</span>
</span><span id="SearchMolecularFormulaWorker-586"><a href="#SearchMolecularFormulaWorker-586"><span class="linenos">586</span></a>                <span class="o">+</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="SearchMolecularFormulaWorker-587"><a href="#SearchMolecularFormulaWorker-587"><span class="linenos">587</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-588"><a href="#SearchMolecularFormulaWorker-588"><span class="linenos">588</span></a>
</span><span id="SearchMolecularFormulaWorker-589"><a href="#SearchMolecularFormulaWorker-589"><span class="linenos">589</span></a>        <span class="k">elif</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">error_method</span> <span class="o">==</span> <span class="s2">&quot;average&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-590"><a href="#SearchMolecularFormulaWorker-590"><span class="linenos">590</span></a>            <span class="n">nbValues</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SearchMolecularFormulaWorker-591"><a href="#SearchMolecularFormulaWorker-591"><span class="linenos">591</span></a>            <span class="n">error_average</span> <span class="o">=</span> <span class="n">error_average</span> <span class="o">+</span> <span class="p">((</span><span class="n">error</span> <span class="o">-</span> <span class="n">error_average</span><span class="p">)</span> <span class="o">/</span> <span class="n">nbValues</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-592"><a href="#SearchMolecularFormulaWorker-592"><span class="linenos">592</span></a>            <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-593"><a href="#SearchMolecularFormulaWorker-593"><span class="linenos">593</span></a>                <span class="n">error_average</span>
</span><span id="SearchMolecularFormulaWorker-594"><a href="#SearchMolecularFormulaWorker-594"><span class="linenos">594</span></a>                <span class="o">-</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="SearchMolecularFormulaWorker-595"><a href="#SearchMolecularFormulaWorker-595"><span class="linenos">595</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-596"><a href="#SearchMolecularFormulaWorker-596"><span class="linenos">596</span></a>            <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-597"><a href="#SearchMolecularFormulaWorker-597"><span class="linenos">597</span></a>                <span class="n">error_average</span>
</span><span id="SearchMolecularFormulaWorker-598"><a href="#SearchMolecularFormulaWorker-598"><span class="linenos">598</span></a>                <span class="o">+</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="SearchMolecularFormulaWorker-599"><a href="#SearchMolecularFormulaWorker-599"><span class="linenos">599</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-600"><a href="#SearchMolecularFormulaWorker-600"><span class="linenos">600</span></a>
</span><span id="SearchMolecularFormulaWorker-601"><a href="#SearchMolecularFormulaWorker-601"><span class="linenos">601</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-602"><a href="#SearchMolecularFormulaWorker-602"><span class="linenos">602</span></a>            <span class="c1"># using set mass_spectrum_obj.molecular_search_settings.min_ppm_error  and max_ppm_error range</span>
</span><span id="SearchMolecularFormulaWorker-603"><a href="#SearchMolecularFormulaWorker-603"><span class="linenos">603</span></a>            <span class="k">pass</span>
</span><span id="SearchMolecularFormulaWorker-604"><a href="#SearchMolecularFormulaWorker-604"><span class="linenos">604</span></a>
</span><span id="SearchMolecularFormulaWorker-605"><a href="#SearchMolecularFormulaWorker-605"><span class="linenos">605</span></a>        <span class="c1"># returns the error based on the selected method at mass_spectrum_obj.molecular_search_settings.method</span>
</span><span id="SearchMolecularFormulaWorker-606"><a href="#SearchMolecularFormulaWorker-606"><span class="linenos">606</span></a>
</span><span id="SearchMolecularFormulaWorker-607"><a href="#SearchMolecularFormulaWorker-607"><span class="linenos">607</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SearchMolecularFormulaWorker-608"><a href="#SearchMolecularFormulaWorker-608"><span class="linenos">608</span></a>    <span class="k">def</span> <span class="nf">calc_error</span><span class="p">(</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">mz_calc</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ppm&quot;</span><span class="p">):</span>
</span><span id="SearchMolecularFormulaWorker-609"><a href="#SearchMolecularFormulaWorker-609"><span class="linenos">609</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the error.</span>
</span><span id="SearchMolecularFormulaWorker-610"><a href="#SearchMolecularFormulaWorker-610"><span class="linenos">610</span></a>
</span><span id="SearchMolecularFormulaWorker-611"><a href="#SearchMolecularFormulaWorker-611"><span class="linenos">611</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulaWorker-612"><a href="#SearchMolecularFormulaWorker-612"><span class="linenos">612</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulaWorker-613"><a href="#SearchMolecularFormulaWorker-613"><span class="linenos">613</span></a><span class="sd">        mz_exp : float</span>
</span><span id="SearchMolecularFormulaWorker-614"><a href="#SearchMolecularFormulaWorker-614"><span class="linenos">614</span></a><span class="sd">            The experimental m/z value.</span>
</span><span id="SearchMolecularFormulaWorker-615"><a href="#SearchMolecularFormulaWorker-615"><span class="linenos">615</span></a><span class="sd">        mz_calc : float</span>
</span><span id="SearchMolecularFormulaWorker-616"><a href="#SearchMolecularFormulaWorker-616"><span class="linenos">616</span></a><span class="sd">            The calculated m/z value.</span>
</span><span id="SearchMolecularFormulaWorker-617"><a href="#SearchMolecularFormulaWorker-617"><span class="linenos">617</span></a><span class="sd">        method : str, optional</span>
</span><span id="SearchMolecularFormulaWorker-618"><a href="#SearchMolecularFormulaWorker-618"><span class="linenos">618</span></a><span class="sd">            The method, by default &#39;ppm&#39;.</span>
</span><span id="SearchMolecularFormulaWorker-619"><a href="#SearchMolecularFormulaWorker-619"><span class="linenos">619</span></a>
</span><span id="SearchMolecularFormulaWorker-620"><a href="#SearchMolecularFormulaWorker-620"><span class="linenos">620</span></a><span class="sd">        Raises</span>
</span><span id="SearchMolecularFormulaWorker-621"><a href="#SearchMolecularFormulaWorker-621"><span class="linenos">621</span></a><span class="sd">        -------</span>
</span><span id="SearchMolecularFormulaWorker-622"><a href="#SearchMolecularFormulaWorker-622"><span class="linenos">622</span></a><span class="sd">        Exception</span>
</span><span id="SearchMolecularFormulaWorker-623"><a href="#SearchMolecularFormulaWorker-623"><span class="linenos">623</span></a><span class="sd">            If the method is not ppm or ppb.</span>
</span><span id="SearchMolecularFormulaWorker-624"><a href="#SearchMolecularFormulaWorker-624"><span class="linenos">624</span></a>
</span><span id="SearchMolecularFormulaWorker-625"><a href="#SearchMolecularFormulaWorker-625"><span class="linenos">625</span></a><span class="sd">        Returns</span>
</span><span id="SearchMolecularFormulaWorker-626"><a href="#SearchMolecularFormulaWorker-626"><span class="linenos">626</span></a><span class="sd">        -------</span>
</span><span id="SearchMolecularFormulaWorker-627"><a href="#SearchMolecularFormulaWorker-627"><span class="linenos">627</span></a><span class="sd">        float</span>
</span><span id="SearchMolecularFormulaWorker-628"><a href="#SearchMolecularFormulaWorker-628"><span class="linenos">628</span></a><span class="sd">            The error.</span>
</span><span id="SearchMolecularFormulaWorker-629"><a href="#SearchMolecularFormulaWorker-629"><span class="linenos">629</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulaWorker-630"><a href="#SearchMolecularFormulaWorker-630"><span class="linenos">630</span></a>
</span><span id="SearchMolecularFormulaWorker-631"><a href="#SearchMolecularFormulaWorker-631"><span class="linenos">631</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;ppm&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-632"><a href="#SearchMolecularFormulaWorker-632"><span class="linenos">632</span></a>            <span class="n">multi_factor</span> <span class="o">=</span> <span class="mi">1_000_000</span>
</span><span id="SearchMolecularFormulaWorker-633"><a href="#SearchMolecularFormulaWorker-633"><span class="linenos">633</span></a>
</span><span id="SearchMolecularFormulaWorker-634"><a href="#SearchMolecularFormulaWorker-634"><span class="linenos">634</span></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;ppb&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-635"><a href="#SearchMolecularFormulaWorker-635"><span class="linenos">635</span></a>            <span class="n">multi_factor</span> <span class="o">=</span> <span class="mi">1_000_000_000</span>
</span><span id="SearchMolecularFormulaWorker-636"><a href="#SearchMolecularFormulaWorker-636"><span class="linenos">636</span></a>
</span><span id="SearchMolecularFormulaWorker-637"><a href="#SearchMolecularFormulaWorker-637"><span class="linenos">637</span></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;perc&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-638"><a href="#SearchMolecularFormulaWorker-638"><span class="linenos">638</span></a>            <span class="n">multi_factor</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="SearchMolecularFormulaWorker-639"><a href="#SearchMolecularFormulaWorker-639"><span class="linenos">639</span></a>
</span><span id="SearchMolecularFormulaWorker-640"><a href="#SearchMolecularFormulaWorker-640"><span class="linenos">640</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-641"><a href="#SearchMolecularFormulaWorker-641"><span class="linenos">641</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-642"><a href="#SearchMolecularFormulaWorker-642"><span class="linenos">642</span></a>                <span class="s2">&quot;method needs to be ppm or ppb, you have entered </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">method</span>
</span><span id="SearchMolecularFormulaWorker-643"><a href="#SearchMolecularFormulaWorker-643"><span class="linenos">643</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-644"><a href="#SearchMolecularFormulaWorker-644"><span class="linenos">644</span></a>
</span><span id="SearchMolecularFormulaWorker-645"><a href="#SearchMolecularFormulaWorker-645"><span class="linenos">645</span></a>        <span class="k">if</span> <span class="n">mz_exp</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-646"><a href="#SearchMolecularFormulaWorker-646"><span class="linenos">646</span></a>            <span class="k">return</span> <span class="p">((</span><span class="n">mz_exp</span> <span class="o">-</span> <span class="n">mz_calc</span><span class="p">)</span> <span class="o">/</span> <span class="n">mz_calc</span><span class="p">)</span> <span class="o">*</span> <span class="n">multi_factor</span>
</span><span id="SearchMolecularFormulaWorker-647"><a href="#SearchMolecularFormulaWorker-647"><span class="linenos">647</span></a>
</span><span id="SearchMolecularFormulaWorker-648"><a href="#SearchMolecularFormulaWorker-648"><span class="linenos">648</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-649"><a href="#SearchMolecularFormulaWorker-649"><span class="linenos">649</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please set mz_calc first&quot;</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-650"><a href="#SearchMolecularFormulaWorker-650"><span class="linenos">650</span></a>
</span><span id="SearchMolecularFormulaWorker-651"><a href="#SearchMolecularFormulaWorker-651"><span class="linenos">651</span></a>    <span class="k">def</span> <span class="nf">find_formulas</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-652"><a href="#SearchMolecularFormulaWorker-652"><span class="linenos">652</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-653"><a href="#SearchMolecularFormulaWorker-653"><span class="linenos">653</span></a>        <span class="n">formulas</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-654"><a href="#SearchMolecularFormulaWorker-654"><span class="linenos">654</span></a>        <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-655"><a href="#SearchMolecularFormulaWorker-655"><span class="linenos">655</span></a>        <span class="n">mass_spectrum_obj</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-656"><a href="#SearchMolecularFormulaWorker-656"><span class="linenos">656</span></a>        <span class="n">ms_peak</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-657"><a href="#SearchMolecularFormulaWorker-657"><span class="linenos">657</span></a>        <span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-658"><a href="#SearchMolecularFormulaWorker-658"><span class="linenos">658</span></a>        <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-659"><a href="#SearchMolecularFormulaWorker-659"><span class="linenos">659</span></a>        <span class="n">adduct_atom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-660"><a href="#SearchMolecularFormulaWorker-660"><span class="linenos">660</span></a>    <span class="p">):</span>
</span><span id="SearchMolecularFormulaWorker-661"><a href="#SearchMolecularFormulaWorker-661"><span class="linenos">661</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the formulas.</span>
</span><span id="SearchMolecularFormulaWorker-662"><a href="#SearchMolecularFormulaWorker-662"><span class="linenos">662</span></a>
</span><span id="SearchMolecularFormulaWorker-663"><a href="#SearchMolecularFormulaWorker-663"><span class="linenos">663</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulaWorker-664"><a href="#SearchMolecularFormulaWorker-664"><span class="linenos">664</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulaWorker-665"><a href="#SearchMolecularFormulaWorker-665"><span class="linenos">665</span></a><span class="sd">        formulas : list of MolecularFormula</span>
</span><span id="SearchMolecularFormulaWorker-666"><a href="#SearchMolecularFormulaWorker-666"><span class="linenos">666</span></a><span class="sd">            The list of molecular formulas.</span>
</span><span id="SearchMolecularFormulaWorker-667"><a href="#SearchMolecularFormulaWorker-667"><span class="linenos">667</span></a><span class="sd">        min_abundance : float</span>
</span><span id="SearchMolecularFormulaWorker-668"><a href="#SearchMolecularFormulaWorker-668"><span class="linenos">668</span></a><span class="sd">            The minimum abundance threshold.</span>
</span><span id="SearchMolecularFormulaWorker-669"><a href="#SearchMolecularFormulaWorker-669"><span class="linenos">669</span></a><span class="sd">        mass_spectrum_obj : MassSpectrum</span>
</span><span id="SearchMolecularFormulaWorker-670"><a href="#SearchMolecularFormulaWorker-670"><span class="linenos">670</span></a><span class="sd">            The mass spectrum object.</span>
</span><span id="SearchMolecularFormulaWorker-671"><a href="#SearchMolecularFormulaWorker-671"><span class="linenos">671</span></a><span class="sd">        ms_peak : MSPeak</span>
</span><span id="SearchMolecularFormulaWorker-672"><a href="#SearchMolecularFormulaWorker-672"><span class="linenos">672</span></a><span class="sd">            The mass spectrum peak.</span>
</span><span id="SearchMolecularFormulaWorker-673"><a href="#SearchMolecularFormulaWorker-673"><span class="linenos">673</span></a><span class="sd">        ion_type : str</span>
</span><span id="SearchMolecularFormulaWorker-674"><a href="#SearchMolecularFormulaWorker-674"><span class="linenos">674</span></a><span class="sd">            The ion type.</span>
</span><span id="SearchMolecularFormulaWorker-675"><a href="#SearchMolecularFormulaWorker-675"><span class="linenos">675</span></a><span class="sd">        ion_charge : int</span>
</span><span id="SearchMolecularFormulaWorker-676"><a href="#SearchMolecularFormulaWorker-676"><span class="linenos">676</span></a><span class="sd">            The ion charge.</span>
</span><span id="SearchMolecularFormulaWorker-677"><a href="#SearchMolecularFormulaWorker-677"><span class="linenos">677</span></a><span class="sd">        adduct_atom : str, optional</span>
</span><span id="SearchMolecularFormulaWorker-678"><a href="#SearchMolecularFormulaWorker-678"><span class="linenos">678</span></a><span class="sd">            The adduct atom, by default None.</span>
</span><span id="SearchMolecularFormulaWorker-679"><a href="#SearchMolecularFormulaWorker-679"><span class="linenos">679</span></a>
</span><span id="SearchMolecularFormulaWorker-680"><a href="#SearchMolecularFormulaWorker-680"><span class="linenos">680</span></a><span class="sd">        Returns</span>
</span><span id="SearchMolecularFormulaWorker-681"><a href="#SearchMolecularFormulaWorker-681"><span class="linenos">681</span></a><span class="sd">        -------</span>
</span><span id="SearchMolecularFormulaWorker-682"><a href="#SearchMolecularFormulaWorker-682"><span class="linenos">682</span></a><span class="sd">        list of MSPeak</span>
</span><span id="SearchMolecularFormulaWorker-683"><a href="#SearchMolecularFormulaWorker-683"><span class="linenos">683</span></a><span class="sd">            The list of mass spectrum peaks with assigned molecular formulas.</span>
</span><span id="SearchMolecularFormulaWorker-684"><a href="#SearchMolecularFormulaWorker-684"><span class="linenos">684</span></a>
</span><span id="SearchMolecularFormulaWorker-685"><a href="#SearchMolecularFormulaWorker-685"><span class="linenos">685</span></a><span class="sd">        Notes</span>
</span><span id="SearchMolecularFormulaWorker-686"><a href="#SearchMolecularFormulaWorker-686"><span class="linenos">686</span></a><span class="sd">        -----</span>
</span><span id="SearchMolecularFormulaWorker-687"><a href="#SearchMolecularFormulaWorker-687"><span class="linenos">687</span></a><span class="sd">        Uses the closest error the next search (this is not ideal, it needs to use confidence</span>
</span><span id="SearchMolecularFormulaWorker-688"><a href="#SearchMolecularFormulaWorker-688"><span class="linenos">688</span></a><span class="sd">        metric to choose the right candidate then propagate the error using the error from the best candidate).</span>
</span><span id="SearchMolecularFormulaWorker-689"><a href="#SearchMolecularFormulaWorker-689"><span class="linenos">689</span></a><span class="sd">        It needs to add s/n to the equation.</span>
</span><span id="SearchMolecularFormulaWorker-690"><a href="#SearchMolecularFormulaWorker-690"><span class="linenos">690</span></a><span class="sd">        It need optimization to define the mz_error_range within a m/z unit since it is directly proportional</span>
</span><span id="SearchMolecularFormulaWorker-691"><a href="#SearchMolecularFormulaWorker-691"><span class="linenos">691</span></a><span class="sd">        with the mass, and inversely proportional to the rp. It&#39;s not linear, i.e., sigma mass.</span>
</span><span id="SearchMolecularFormulaWorker-692"><a href="#SearchMolecularFormulaWorker-692"><span class="linenos">692</span></a><span class="sd">        The idea it to correlate sigma to resolving power, signal to noise and sample complexity per mz unit.</span>
</span><span id="SearchMolecularFormulaWorker-693"><a href="#SearchMolecularFormulaWorker-693"><span class="linenos">693</span></a><span class="sd">        Method=&#39;distance&#39;</span>
</span><span id="SearchMolecularFormulaWorker-694"><a href="#SearchMolecularFormulaWorker-694"><span class="linenos">694</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulaWorker-695"><a href="#SearchMolecularFormulaWorker-695"><span class="linenos">695</span></a>        <span class="n">mspeak_assigned_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span><span id="SearchMolecularFormulaWorker-696"><a href="#SearchMolecularFormulaWorker-696"><span class="linenos">696</span></a>
</span><span id="SearchMolecularFormulaWorker-697"><a href="#SearchMolecularFormulaWorker-697"><span class="linenos">697</span></a>        <span class="n">min_ppm_error</span> <span class="o">=</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_ppm_error</span>
</span><span id="SearchMolecularFormulaWorker-698"><a href="#SearchMolecularFormulaWorker-698"><span class="linenos">698</span></a>        <span class="n">max_ppm_error</span> <span class="o">=</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_ppm_error</span>
</span><span id="SearchMolecularFormulaWorker-699"><a href="#SearchMolecularFormulaWorker-699"><span class="linenos">699</span></a>
</span><span id="SearchMolecularFormulaWorker-700"><a href="#SearchMolecularFormulaWorker-700"><span class="linenos">700</span></a>        <span class="n">min_abun_error</span> <span class="o">=</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_abun_error</span>
</span><span id="SearchMolecularFormulaWorker-701"><a href="#SearchMolecularFormulaWorker-701"><span class="linenos">701</span></a>        <span class="n">max_abun_error</span> <span class="o">=</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_abun_error</span>
</span><span id="SearchMolecularFormulaWorker-702"><a href="#SearchMolecularFormulaWorker-702"><span class="linenos">702</span></a>
</span><span id="SearchMolecularFormulaWorker-703"><a href="#SearchMolecularFormulaWorker-703"><span class="linenos">703</span></a>        <span class="c1"># f = open(&quot;abundance_error.txt&quot;, &quot;a+&quot;)</span>
</span><span id="SearchMolecularFormulaWorker-704"><a href="#SearchMolecularFormulaWorker-704"><span class="linenos">704</span></a>        <span class="n">ms_peak_mz_exp</span><span class="p">,</span> <span class="n">ms_peak_abundance</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="SearchMolecularFormulaWorker-705"><a href="#SearchMolecularFormulaWorker-705"><span class="linenos">705</span></a>        <span class="c1"># min_error = min([pmf.mz_error for pmf in possible_formulas])</span>
</span><span id="SearchMolecularFormulaWorker-706"><a href="#SearchMolecularFormulaWorker-706"><span class="linenos">706</span></a>
</span><span id="SearchMolecularFormulaWorker-707"><a href="#SearchMolecularFormulaWorker-707"><span class="linenos">707</span></a>        <span class="k">def</span> <span class="nf">mass_by_ion_type</span><span class="p">(</span><span class="n">possible_formula_obj</span><span class="p">):</span>
</span><span id="SearchMolecularFormulaWorker-708"><a href="#SearchMolecularFormulaWorker-708"><span class="linenos">708</span></a>            <span class="k">if</span> <span class="n">ion_type</span> <span class="o">==</span> <span class="n">Labels</span><span class="o">.</span><span class="n">protonated_de_ion</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-709"><a href="#SearchMolecularFormulaWorker-709"><span class="linenos">709</span></a>                <span class="k">return</span> <span class="n">possible_formula_obj</span><span class="o">.</span><span class="n">_protonated_mz</span><span class="p">(</span><span class="n">ion_charge</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-710"><a href="#SearchMolecularFormulaWorker-710"><span class="linenos">710</span></a>
</span><span id="SearchMolecularFormulaWorker-711"><a href="#SearchMolecularFormulaWorker-711"><span class="linenos">711</span></a>            <span class="k">elif</span> <span class="n">ion_type</span> <span class="o">==</span> <span class="n">Labels</span><span class="o">.</span><span class="n">radical_ion</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-712"><a href="#SearchMolecularFormulaWorker-712"><span class="linenos">712</span></a>                <span class="k">return</span> <span class="n">possible_formula_obj</span><span class="o">.</span><span class="n">_radical_mz</span><span class="p">(</span><span class="n">ion_charge</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-713"><a href="#SearchMolecularFormulaWorker-713"><span class="linenos">713</span></a>
</span><span id="SearchMolecularFormulaWorker-714"><a href="#SearchMolecularFormulaWorker-714"><span class="linenos">714</span></a>            <span class="k">elif</span> <span class="n">ion_type</span> <span class="o">==</span> <span class="n">Labels</span><span class="o">.</span><span class="n">adduct_ion</span> <span class="ow">and</span> <span class="n">adduct_atom</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-715"><a href="#SearchMolecularFormulaWorker-715"><span class="linenos">715</span></a>                <span class="k">return</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">_adduct_mz</span><span class="p">(</span><span class="n">ion_charge</span><span class="p">,</span> <span class="n">adduct_atom</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-716"><a href="#SearchMolecularFormulaWorker-716"><span class="linenos">716</span></a>
</span><span id="SearchMolecularFormulaWorker-717"><a href="#SearchMolecularFormulaWorker-717"><span class="linenos">717</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-718"><a href="#SearchMolecularFormulaWorker-718"><span class="linenos">718</span></a>                <span class="c1"># will return externally calculated mz if is set, #use on Bruker Reference list import</span>
</span><span id="SearchMolecularFormulaWorker-719"><a href="#SearchMolecularFormulaWorker-719"><span class="linenos">719</span></a>                <span class="c1"># if the ion type is known the ion mass based on molecular formula ion type</span>
</span><span id="SearchMolecularFormulaWorker-720"><a href="#SearchMolecularFormulaWorker-720"><span class="linenos">720</span></a>                <span class="c1"># if ion type is unknow will return neutral mass</span>
</span><span id="SearchMolecularFormulaWorker-721"><a href="#SearchMolecularFormulaWorker-721"><span class="linenos">721</span></a>                <span class="k">return</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">mz_calc</span>
</span><span id="SearchMolecularFormulaWorker-722"><a href="#SearchMolecularFormulaWorker-722"><span class="linenos">722</span></a>
</span><span id="SearchMolecularFormulaWorker-723"><a href="#SearchMolecularFormulaWorker-723"><span class="linenos">723</span></a>        <span class="k">if</span> <span class="n">formulas</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-724"><a href="#SearchMolecularFormulaWorker-724"><span class="linenos">724</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">formulas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">LCMSLibRefMolecularFormula</span><span class="p">):</span>
</span><span id="SearchMolecularFormulaWorker-725"><a href="#SearchMolecularFormulaWorker-725"><span class="linenos">725</span></a>                <span class="n">possible_mf_class</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SearchMolecularFormulaWorker-726"><a href="#SearchMolecularFormulaWorker-726"><span class="linenos">726</span></a>
</span><span id="SearchMolecularFormulaWorker-727"><a href="#SearchMolecularFormulaWorker-727"><span class="linenos">727</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-728"><a href="#SearchMolecularFormulaWorker-728"><span class="linenos">728</span></a>                <span class="n">possible_mf_class</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SearchMolecularFormulaWorker-729"><a href="#SearchMolecularFormulaWorker-729"><span class="linenos">729</span></a>
</span><span id="SearchMolecularFormulaWorker-730"><a href="#SearchMolecularFormulaWorker-730"><span class="linenos">730</span></a>        <span class="k">for</span> <span class="n">possible_formula</span> <span class="ow">in</span> <span class="n">formulas</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-731"><a href="#SearchMolecularFormulaWorker-731"><span class="linenos">731</span></a>            <span class="k">if</span> <span class="n">possible_formula</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-732"><a href="#SearchMolecularFormulaWorker-732"><span class="linenos">732</span></a>                <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_error</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-733"><a href="#SearchMolecularFormulaWorker-733"><span class="linenos">733</span></a>                    <span class="n">ms_peak_mz_exp</span><span class="p">,</span> <span class="n">mass_by_ion_type</span><span class="p">(</span><span class="n">possible_formula</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-734"><a href="#SearchMolecularFormulaWorker-734"><span class="linenos">734</span></a>                <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-735"><a href="#SearchMolecularFormulaWorker-735"><span class="linenos">735</span></a>
</span><span id="SearchMolecularFormulaWorker-736"><a href="#SearchMolecularFormulaWorker-736"><span class="linenos">736</span></a>                <span class="c1"># error = possible_formula.mz_error</span>
</span><span id="SearchMolecularFormulaWorker-737"><a href="#SearchMolecularFormulaWorker-737"><span class="linenos">737</span></a>
</span><span id="SearchMolecularFormulaWorker-738"><a href="#SearchMolecularFormulaWorker-738"><span class="linenos">738</span></a>                <span class="k">if</span> <span class="n">min_ppm_error</span> <span class="o">&lt;=</span> <span class="n">error</span> <span class="o">&lt;=</span> <span class="n">max_ppm_error</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-739"><a href="#SearchMolecularFormulaWorker-739"><span class="linenos">739</span></a>                    <span class="c1"># update the error</span>
</span><span id="SearchMolecularFormulaWorker-740"><a href="#SearchMolecularFormulaWorker-740"><span class="linenos">740</span></a>
</span><span id="SearchMolecularFormulaWorker-741"><a href="#SearchMolecularFormulaWorker-741"><span class="linenos">741</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">set_last_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">mass_spectrum_obj</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-742"><a href="#SearchMolecularFormulaWorker-742"><span class="linenos">742</span></a>
</span><span id="SearchMolecularFormulaWorker-743"><a href="#SearchMolecularFormulaWorker-743"><span class="linenos">743</span></a>                    <span class="c1"># add molecular formula match to ms_peak</span>
</span><span id="SearchMolecularFormulaWorker-744"><a href="#SearchMolecularFormulaWorker-744"><span class="linenos">744</span></a>
</span><span id="SearchMolecularFormulaWorker-745"><a href="#SearchMolecularFormulaWorker-745"><span class="linenos">745</span></a>                    <span class="c1"># get molecular formula dict from sql obj</span>
</span><span id="SearchMolecularFormulaWorker-746"><a href="#SearchMolecularFormulaWorker-746"><span class="linenos">746</span></a>                    <span class="c1"># formula_dict = pickle.loads(possible_formula.mol_formula)</span>
</span><span id="SearchMolecularFormulaWorker-747"><a href="#SearchMolecularFormulaWorker-747"><span class="linenos">747</span></a>                    <span class="c1"># if possible_mf_class:</span>
</span><span id="SearchMolecularFormulaWorker-748"><a href="#SearchMolecularFormulaWorker-748"><span class="linenos">748</span></a>
</span><span id="SearchMolecularFormulaWorker-749"><a href="#SearchMolecularFormulaWorker-749"><span class="linenos">749</span></a>                    <span class="c1">#    molecular_formula = deepcopy(possible_formula)</span>
</span><span id="SearchMolecularFormulaWorker-750"><a href="#SearchMolecularFormulaWorker-750"><span class="linenos">750</span></a>
</span><span id="SearchMolecularFormulaWorker-751"><a href="#SearchMolecularFormulaWorker-751"><span class="linenos">751</span></a>                    <span class="c1"># else:</span>
</span><span id="SearchMolecularFormulaWorker-752"><a href="#SearchMolecularFormulaWorker-752"><span class="linenos">752</span></a>
</span><span id="SearchMolecularFormulaWorker-753"><a href="#SearchMolecularFormulaWorker-753"><span class="linenos">753</span></a>                    <span class="n">formula_dict</span> <span class="o">=</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</span><span id="SearchMolecularFormulaWorker-754"><a href="#SearchMolecularFormulaWorker-754"><span class="linenos">754</span></a>                    <span class="c1"># create the molecular formula obj to be stored</span>
</span><span id="SearchMolecularFormulaWorker-755"><a href="#SearchMolecularFormulaWorker-755"><span class="linenos">755</span></a>                    <span class="k">if</span> <span class="n">possible_mf_class</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-756"><a href="#SearchMolecularFormulaWorker-756"><span class="linenos">756</span></a>                        <span class="n">molecular_formula</span> <span class="o">=</span> <span class="n">LCMSLibRefMolecularFormula</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-757"><a href="#SearchMolecularFormulaWorker-757"><span class="linenos">757</span></a>                            <span class="n">formula_dict</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-758"><a href="#SearchMolecularFormulaWorker-758"><span class="linenos">758</span></a>                            <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-759"><a href="#SearchMolecularFormulaWorker-759"><span class="linenos">759</span></a>                            <span class="n">ion_type</span><span class="o">=</span><span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-760"><a href="#SearchMolecularFormulaWorker-760"><span class="linenos">760</span></a>                            <span class="n">adduct_atom</span><span class="o">=</span><span class="n">adduct_atom</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-761"><a href="#SearchMolecularFormulaWorker-761"><span class="linenos">761</span></a>                        <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-762"><a href="#SearchMolecularFormulaWorker-762"><span class="linenos">762</span></a>
</span><span id="SearchMolecularFormulaWorker-763"><a href="#SearchMolecularFormulaWorker-763"><span class="linenos">763</span></a>                        <span class="n">molecular_formula</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">name</span>
</span><span id="SearchMolecularFormulaWorker-764"><a href="#SearchMolecularFormulaWorker-764"><span class="linenos">764</span></a>                        <span class="n">molecular_formula</span><span class="o">.</span><span class="n">kegg_id</span> <span class="o">=</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">kegg_id</span>
</span><span id="SearchMolecularFormulaWorker-765"><a href="#SearchMolecularFormulaWorker-765"><span class="linenos">765</span></a>                        <span class="n">molecular_formula</span><span class="o">.</span><span class="n">cas</span> <span class="o">=</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">cas</span>
</span><span id="SearchMolecularFormulaWorker-766"><a href="#SearchMolecularFormulaWorker-766"><span class="linenos">766</span></a>
</span><span id="SearchMolecularFormulaWorker-767"><a href="#SearchMolecularFormulaWorker-767"><span class="linenos">767</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-768"><a href="#SearchMolecularFormulaWorker-768"><span class="linenos">768</span></a>                        <span class="n">molecular_formula</span> <span class="o">=</span> <span class="n">MolecularFormula</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-769"><a href="#SearchMolecularFormulaWorker-769"><span class="linenos">769</span></a>                            <span class="n">formula_dict</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-770"><a href="#SearchMolecularFormulaWorker-770"><span class="linenos">770</span></a>                            <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-771"><a href="#SearchMolecularFormulaWorker-771"><span class="linenos">771</span></a>                            <span class="n">ion_type</span><span class="o">=</span><span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-772"><a href="#SearchMolecularFormulaWorker-772"><span class="linenos">772</span></a>                            <span class="n">adduct_atom</span><span class="o">=</span><span class="n">adduct_atom</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-773"><a href="#SearchMolecularFormulaWorker-773"><span class="linenos">773</span></a>                        <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-774"><a href="#SearchMolecularFormulaWorker-774"><span class="linenos">774</span></a>                    <span class="c1"># add the molecular formula obj to the mspeak obj</span>
</span><span id="SearchMolecularFormulaWorker-775"><a href="#SearchMolecularFormulaWorker-775"><span class="linenos">775</span></a>                    <span class="c1"># add the mspeak obj and it&#39;s index for tracking next assignment step</span>
</span><span id="SearchMolecularFormulaWorker-776"><a href="#SearchMolecularFormulaWorker-776"><span class="linenos">776</span></a>
</span><span id="SearchMolecularFormulaWorker-777"><a href="#SearchMolecularFormulaWorker-777"><span class="linenos">777</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-778"><a href="#SearchMolecularFormulaWorker-778"><span class="linenos">778</span></a>                        <span class="c1"># calculates isotopologues</span>
</span><span id="SearchMolecularFormulaWorker-779"><a href="#SearchMolecularFormulaWorker-779"><span class="linenos">779</span></a>                        <span class="n">isotopologues</span> <span class="o">=</span> <span class="n">molecular_formula</span><span class="o">.</span><span class="n">isotopologues</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-780"><a href="#SearchMolecularFormulaWorker-780"><span class="linenos">780</span></a>                            <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-781"><a href="#SearchMolecularFormulaWorker-781"><span class="linenos">781</span></a>                            <span class="n">ms_peak_abundance</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-782"><a href="#SearchMolecularFormulaWorker-782"><span class="linenos">782</span></a>                            <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">dynamic_range</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-783"><a href="#SearchMolecularFormulaWorker-783"><span class="linenos">783</span></a>                        <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-784"><a href="#SearchMolecularFormulaWorker-784"><span class="linenos">784</span></a>
</span><span id="SearchMolecularFormulaWorker-785"><a href="#SearchMolecularFormulaWorker-785"><span class="linenos">785</span></a>                        <span class="c1"># search for isotopologues</span>
</span><span id="SearchMolecularFormulaWorker-786"><a href="#SearchMolecularFormulaWorker-786"><span class="linenos">786</span></a>                        <span class="k">for</span> <span class="n">isotopologue_formula</span> <span class="ow">in</span> <span class="n">isotopologues</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-787"><a href="#SearchMolecularFormulaWorker-787"><span class="linenos">787</span></a>                            <span class="n">molecular_formula</span><span class="o">.</span><span class="n">expected_isotopologues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-788"><a href="#SearchMolecularFormulaWorker-788"><span class="linenos">788</span></a>                                <span class="n">isotopologue_formula</span>
</span><span id="SearchMolecularFormulaWorker-789"><a href="#SearchMolecularFormulaWorker-789"><span class="linenos">789</span></a>                            <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-790"><a href="#SearchMolecularFormulaWorker-790"><span class="linenos">790</span></a>                            <span class="c1"># move this outside to improve preformace</span>
</span><span id="SearchMolecularFormulaWorker-791"><a href="#SearchMolecularFormulaWorker-791"><span class="linenos">791</span></a>                            <span class="c1"># we need to increase the search space to -+1 m_z</span>
</span><span id="SearchMolecularFormulaWorker-792"><a href="#SearchMolecularFormulaWorker-792"><span class="linenos">792</span></a>                            <span class="n">first_index</span><span class="p">,</span> <span class="n">last_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-793"><a href="#SearchMolecularFormulaWorker-793"><span class="linenos">793</span></a>                                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">get_nominal_mz_first_last_indexes</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-794"><a href="#SearchMolecularFormulaWorker-794"><span class="linenos">794</span></a>                                    <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">mz_nominal_calc</span>
</span><span id="SearchMolecularFormulaWorker-795"><a href="#SearchMolecularFormulaWorker-795"><span class="linenos">795</span></a>                                <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-796"><a href="#SearchMolecularFormulaWorker-796"><span class="linenos">796</span></a>                            <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-797"><a href="#SearchMolecularFormulaWorker-797"><span class="linenos">797</span></a>
</span><span id="SearchMolecularFormulaWorker-798"><a href="#SearchMolecularFormulaWorker-798"><span class="linenos">798</span></a>                            <span class="k">for</span> <span class="n">ms_peak_iso</span> <span class="ow">in</span> <span class="n">mass_spectrum_obj</span><span class="p">[</span>
</span><span id="SearchMolecularFormulaWorker-799"><a href="#SearchMolecularFormulaWorker-799"><span class="linenos">799</span></a>                                <span class="n">first_index</span><span class="p">:</span><span class="n">last_index</span>
</span><span id="SearchMolecularFormulaWorker-800"><a href="#SearchMolecularFormulaWorker-800"><span class="linenos">800</span></a>                            <span class="p">]:</span>
</span><span id="SearchMolecularFormulaWorker-801"><a href="#SearchMolecularFormulaWorker-801"><span class="linenos">801</span></a>                                <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_error</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-802"><a href="#SearchMolecularFormulaWorker-802"><span class="linenos">802</span></a>                                    <span class="n">ms_peak_iso</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">mz_calc</span>
</span><span id="SearchMolecularFormulaWorker-803"><a href="#SearchMolecularFormulaWorker-803"><span class="linenos">803</span></a>                                <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-804"><a href="#SearchMolecularFormulaWorker-804"><span class="linenos">804</span></a>
</span><span id="SearchMolecularFormulaWorker-805"><a href="#SearchMolecularFormulaWorker-805"><span class="linenos">805</span></a>                                <span class="k">if</span> <span class="n">min_ppm_error</span> <span class="o">&lt;=</span> <span class="n">error</span> <span class="o">&lt;=</span> <span class="n">max_ppm_error</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker-806"><a href="#SearchMolecularFormulaWorker-806"><span class="linenos">806</span></a>                                    <span class="c1"># need to define error distribution for abundance measurements</span>
</span><span id="SearchMolecularFormulaWorker-807"><a href="#SearchMolecularFormulaWorker-807"><span class="linenos">807</span></a>
</span><span id="SearchMolecularFormulaWorker-808"><a href="#SearchMolecularFormulaWorker-808"><span class="linenos">808</span></a>                                    <span class="c1"># if mass_spectrum_obj.is_centroid:</span>
</span><span id="SearchMolecularFormulaWorker-809"><a href="#SearchMolecularFormulaWorker-809"><span class="linenos">809</span></a>
</span><span id="SearchMolecularFormulaWorker-810"><a href="#SearchMolecularFormulaWorker-810"><span class="linenos">810</span></a>                                    <span class="n">abundance_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_error</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-811"><a href="#SearchMolecularFormulaWorker-811"><span class="linenos">811</span></a>                                        <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">abundance_calc</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-812"><a href="#SearchMolecularFormulaWorker-812"><span class="linenos">812</span></a>                                        <span class="n">ms_peak_iso</span><span class="o">.</span><span class="n">abundance</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-813"><a href="#SearchMolecularFormulaWorker-813"><span class="linenos">813</span></a>                                        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;perc&quot;</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker-814"><a href="#SearchMolecularFormulaWorker-814"><span class="linenos">814</span></a>                                    <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-815"><a href="#SearchMolecularFormulaWorker-815"><span class="linenos">815</span></a>
</span><span id="SearchMolecularFormulaWorker-816"><a href="#SearchMolecularFormulaWorker-816"><span class="linenos">816</span></a>                                    <span class="c1"># area_error = self.calc_error(ms_peak.area, ms_peak_iso.area, method=&#39;perc&#39;)</span>
</span><span id="SearchMolecularFormulaWorker-817"><a href="#SearchMolecularFormulaWorker-817"><span class="linenos">817</span></a>
</span><span id="SearchMolecularFormulaWorker-818"><a href="#SearchMolecularFormulaWorker-818"><span class="linenos">818</span></a>                                    <span class="c1"># margin of error was set empirically/ needs statistical calculation</span>
</span><span id="SearchMolecularFormulaWorker-819"><a href="#SearchMolecularFormulaWorker-819"><span class="linenos">819</span></a>                                    <span class="c1">#  of margin of error for the measurement of the abundances</span>
</span><span id="SearchMolecularFormulaWorker-820"><a href="#SearchMolecularFormulaWorker-820"><span class="linenos">820</span></a>                                    <span class="k">if</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-821"><a href="#SearchMolecularFormulaWorker-821"><span class="linenos">821</span></a>                                        <span class="n">min_abun_error</span>
</span><span id="SearchMolecularFormulaWorker-822"><a href="#SearchMolecularFormulaWorker-822"><span class="linenos">822</span></a>                                        <span class="o">&lt;=</span> <span class="n">abundance_error</span>
</span><span id="SearchMolecularFormulaWorker-823"><a href="#SearchMolecularFormulaWorker-823"><span class="linenos">823</span></a>                                        <span class="o">&lt;=</span> <span class="n">max_abun_error</span>
</span><span id="SearchMolecularFormulaWorker-824"><a href="#SearchMolecularFormulaWorker-824"><span class="linenos">824</span></a>                                    <span class="p">):</span>
</span><span id="SearchMolecularFormulaWorker-825"><a href="#SearchMolecularFormulaWorker-825"><span class="linenos">825</span></a>                                        <span class="c1"># update the error</span>
</span><span id="SearchMolecularFormulaWorker-826"><a href="#SearchMolecularFormulaWorker-826"><span class="linenos">826</span></a>
</span><span id="SearchMolecularFormulaWorker-827"><a href="#SearchMolecularFormulaWorker-827"><span class="linenos">827</span></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">set_last_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">mass_spectrum_obj</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-828"><a href="#SearchMolecularFormulaWorker-828"><span class="linenos">828</span></a>
</span><span id="SearchMolecularFormulaWorker-829"><a href="#SearchMolecularFormulaWorker-829"><span class="linenos">829</span></a>                                        <span class="c1"># isotopologue_formula.mz_error = error</span>
</span><span id="SearchMolecularFormulaWorker-830"><a href="#SearchMolecularFormulaWorker-830"><span class="linenos">830</span></a>
</span><span id="SearchMolecularFormulaWorker-831"><a href="#SearchMolecularFormulaWorker-831"><span class="linenos">831</span></a>                                        <span class="c1"># isotopologue_formula.area_error = area_error</span>
</span><span id="SearchMolecularFormulaWorker-832"><a href="#SearchMolecularFormulaWorker-832"><span class="linenos">832</span></a>
</span><span id="SearchMolecularFormulaWorker-833"><a href="#SearchMolecularFormulaWorker-833"><span class="linenos">833</span></a>                                        <span class="c1"># isotopologue_formula.abundance_error = abundance_error</span>
</span><span id="SearchMolecularFormulaWorker-834"><a href="#SearchMolecularFormulaWorker-834"><span class="linenos">834</span></a>
</span><span id="SearchMolecularFormulaWorker-835"><a href="#SearchMolecularFormulaWorker-835"><span class="linenos">835</span></a>                                        <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">mspeak_index_mono_isotopic</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">index</span>
</span><span id="SearchMolecularFormulaWorker-836"><a href="#SearchMolecularFormulaWorker-836"><span class="linenos">836</span></a>
</span><span id="SearchMolecularFormulaWorker-837"><a href="#SearchMolecularFormulaWorker-837"><span class="linenos">837</span></a>                                        <span class="n">mono_isotopic_formula_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms_peak</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-838"><a href="#SearchMolecularFormulaWorker-838"><span class="linenos">838</span></a>
</span><span id="SearchMolecularFormulaWorker-839"><a href="#SearchMolecularFormulaWorker-839"><span class="linenos">839</span></a>                                        <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">mspeak_index_mono_isotopic</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">index</span>
</span><span id="SearchMolecularFormulaWorker-840"><a href="#SearchMolecularFormulaWorker-840"><span class="linenos">840</span></a>
</span><span id="SearchMolecularFormulaWorker-841"><a href="#SearchMolecularFormulaWorker-841"><span class="linenos">841</span></a>                                        <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">mono_isotopic_formula_index</span> <span class="o">=</span> <span class="n">mono_isotopic_formula_index</span>
</span><span id="SearchMolecularFormulaWorker-842"><a href="#SearchMolecularFormulaWorker-842"><span class="linenos">842</span></a>
</span><span id="SearchMolecularFormulaWorker-843"><a href="#SearchMolecularFormulaWorker-843"><span class="linenos">843</span></a>                                        <span class="c1"># add mspeaks isotopologue index to the mono isotopic MolecularFormula obj and the respective formula position</span>
</span><span id="SearchMolecularFormulaWorker-844"><a href="#SearchMolecularFormulaWorker-844"><span class="linenos">844</span></a>
</span><span id="SearchMolecularFormulaWorker-845"><a href="#SearchMolecularFormulaWorker-845"><span class="linenos">845</span></a>                                        <span class="c1"># add molecular formula match to ms_peak</span>
</span><span id="SearchMolecularFormulaWorker-846"><a href="#SearchMolecularFormulaWorker-846"><span class="linenos">846</span></a>                                        <span class="n">x</span> <span class="o">=</span> <span class="n">ms_peak_iso</span><span class="o">.</span><span class="n">add_molecular_formula</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-847"><a href="#SearchMolecularFormulaWorker-847"><span class="linenos">847</span></a>                                            <span class="n">isotopologue_formula</span>
</span><span id="SearchMolecularFormulaWorker-848"><a href="#SearchMolecularFormulaWorker-848"><span class="linenos">848</span></a>                                        <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-849"><a href="#SearchMolecularFormulaWorker-849"><span class="linenos">849</span></a>
</span><span id="SearchMolecularFormulaWorker-850"><a href="#SearchMolecularFormulaWorker-850"><span class="linenos">850</span></a>                                        <span class="n">molecular_formula</span><span class="o">.</span><span class="n">mspeak_mf_isotopologues_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker-851"><a href="#SearchMolecularFormulaWorker-851"><span class="linenos">851</span></a>                                            <span class="p">(</span><span class="n">ms_peak_iso</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-852"><a href="#SearchMolecularFormulaWorker-852"><span class="linenos">852</span></a>                                        <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-853"><a href="#SearchMolecularFormulaWorker-853"><span class="linenos">853</span></a>                                        <span class="c1"># add mspeaks mono isotopic index to the isotopologue MolecularFormula obj</span>
</span><span id="SearchMolecularFormulaWorker-854"><a href="#SearchMolecularFormulaWorker-854"><span class="linenos">854</span></a>
</span><span id="SearchMolecularFormulaWorker-855"><a href="#SearchMolecularFormulaWorker-855"><span class="linenos">855</span></a>                    <span class="n">y</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">add_molecular_formula</span><span class="p">(</span><span class="n">molecular_formula</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker-856"><a href="#SearchMolecularFormulaWorker-856"><span class="linenos">856</span></a>
</span><span id="SearchMolecularFormulaWorker-857"><a href="#SearchMolecularFormulaWorker-857"><span class="linenos">857</span></a>                    <span class="n">mspeak_assigned_index</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ms_peak</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</span><span id="SearchMolecularFormulaWorker-858"><a href="#SearchMolecularFormulaWorker-858"><span class="linenos">858</span></a>
</span><span id="SearchMolecularFormulaWorker-859"><a href="#SearchMolecularFormulaWorker-859"><span class="linenos">859</span></a>        <span class="k">return</span> <span class="n">mspeak_assigned_index</span>
</span></pre></div>


            <div class="docstring"><p>Class for searching molecular formulas in a mass spectrum.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>find_isotopologues</strong> (bool, optional):
Flag to indicate whether to find isotopologues, by default True.</li>
</ul>

<h6 id="attributes">Attributes</h6>

<ul>
<li><strong>find_isotopologues</strong> (bool):
Flag to indicate whether to find isotopologues.</li>
</ul>

<h6 id="methods">Methods</h6>

<ul>
<li>reset_error().
Reset the error variables.</li>
<li>set_last_error().
Set the last error.</li>
<li>find_formulas().
Find the formulas.</li>
<li>calc_error().
Calculate the error.</li>
</ul>
</div>


                            <div id="SearchMolecularFormulaWorker.__init__" class="classattr">
                                        <input id="SearchMolecularFormulaWorker.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SearchMolecularFormulaWorker</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">find_isotopologues</span><span class="o">=</span><span class="kc">True</span></span>)</span>

                <label class="view-source-button" for="SearchMolecularFormulaWorker.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulaWorker.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulaWorker.__init__-509"><a href="#SearchMolecularFormulaWorker.__init__-509"><span class="linenos">509</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">find_isotopologues</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="SearchMolecularFormulaWorker.__init__-510"><a href="#SearchMolecularFormulaWorker.__init__-510"><span class="linenos">510</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span> <span class="o">=</span> <span class="n">find_isotopologues</span>
</span></pre></div>


    

                            </div>
                            <div id="SearchMolecularFormulaWorker.find_isotopologues" class="classattr">
                                <div class="attr variable">
            <span class="name">find_isotopologues</span>

        
    </div>
    <a class="headerlink" href="#SearchMolecularFormulaWorker.find_isotopologues"></a>
    
    

                            </div>
                            <div id="SearchMolecularFormulaWorker.reset_error" class="classattr">
                                        <input id="SearchMolecularFormulaWorker.reset_error-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reset_error</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">mass_spectrum_obj</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SearchMolecularFormulaWorker.reset_error-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulaWorker.reset_error"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulaWorker.reset_error-527"><a href="#SearchMolecularFormulaWorker.reset_error-527"><span class="linenos">527</span></a>    <span class="k">def</span> <span class="nf">reset_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass_spectrum_obj</span><span class="p">):</span>
</span><span id="SearchMolecularFormulaWorker.reset_error-528"><a href="#SearchMolecularFormulaWorker.reset_error-528"><span class="linenos">528</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the error variables.</span>
</span><span id="SearchMolecularFormulaWorker.reset_error-529"><a href="#SearchMolecularFormulaWorker.reset_error-529"><span class="linenos">529</span></a>
</span><span id="SearchMolecularFormulaWorker.reset_error-530"><a href="#SearchMolecularFormulaWorker.reset_error-530"><span class="linenos">530</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulaWorker.reset_error-531"><a href="#SearchMolecularFormulaWorker.reset_error-531"><span class="linenos">531</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulaWorker.reset_error-532"><a href="#SearchMolecularFormulaWorker.reset_error-532"><span class="linenos">532</span></a><span class="sd">        mass_spectrum_obj : MassSpectrum</span>
</span><span id="SearchMolecularFormulaWorker.reset_error-533"><a href="#SearchMolecularFormulaWorker.reset_error-533"><span class="linenos">533</span></a><span class="sd">            The mass spectrum object.</span>
</span><span id="SearchMolecularFormulaWorker.reset_error-534"><a href="#SearchMolecularFormulaWorker.reset_error-534"><span class="linenos">534</span></a>
</span><span id="SearchMolecularFormulaWorker.reset_error-535"><a href="#SearchMolecularFormulaWorker.reset_error-535"><span class="linenos">535</span></a><span class="sd">        Notes</span>
</span><span id="SearchMolecularFormulaWorker.reset_error-536"><a href="#SearchMolecularFormulaWorker.reset_error-536"><span class="linenos">536</span></a><span class="sd">        -----</span>
</span><span id="SearchMolecularFormulaWorker.reset_error-537"><a href="#SearchMolecularFormulaWorker.reset_error-537"><span class="linenos">537</span></a><span class="sd">        This function resets the error variables for the given mass spectrum object.</span>
</span><span id="SearchMolecularFormulaWorker.reset_error-538"><a href="#SearchMolecularFormulaWorker.reset_error-538"><span class="linenos">538</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulaWorker.reset_error-539"><a href="#SearchMolecularFormulaWorker.reset_error-539"><span class="linenos">539</span></a>        <span class="k">global</span> <span class="n">last_error</span><span class="p">,</span> <span class="n">last_dif</span><span class="p">,</span> <span class="n">closest_error</span><span class="p">,</span> <span class="n">error_average</span><span class="p">,</span> <span class="n">nbValues</span>
</span><span id="SearchMolecularFormulaWorker.reset_error-540"><a href="#SearchMolecularFormulaWorker.reset_error-540"><span class="linenos">540</span></a>        <span class="n">last_error</span><span class="p">,</span> <span class="n">last_dif</span><span class="p">,</span> <span class="n">closest_error</span><span class="p">,</span> <span class="n">nbValues</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
</span></pre></div>


            <div class="docstring"><p>Reset the error variables.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>mass_spectrum_obj</strong> (MassSpectrum):
The mass spectrum object.</li>
</ul>

<h6 id="notes">Notes</h6>

<p>This function resets the error variables for the given mass spectrum object.</p>
</div>


                            </div>
                            <div id="SearchMolecularFormulaWorker.set_last_error" class="classattr">
                                        <input id="SearchMolecularFormulaWorker.set_last_error-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_last_error</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">error</span>, </span><span class="param"><span class="n">mass_spectrum_obj</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SearchMolecularFormulaWorker.set_last_error-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulaWorker.set_last_error"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulaWorker.set_last_error-542"><a href="#SearchMolecularFormulaWorker.set_last_error-542"><span class="linenos">542</span></a>    <span class="k">def</span> <span class="nf">set_last_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">mass_spectrum_obj</span><span class="p">):</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-543"><a href="#SearchMolecularFormulaWorker.set_last_error-543"><span class="linenos">543</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the last error.</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-544"><a href="#SearchMolecularFormulaWorker.set_last_error-544"><span class="linenos">544</span></a>
</span><span id="SearchMolecularFormulaWorker.set_last_error-545"><a href="#SearchMolecularFormulaWorker.set_last_error-545"><span class="linenos">545</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-546"><a href="#SearchMolecularFormulaWorker.set_last_error-546"><span class="linenos">546</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-547"><a href="#SearchMolecularFormulaWorker.set_last_error-547"><span class="linenos">547</span></a><span class="sd">        error : float</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-548"><a href="#SearchMolecularFormulaWorker.set_last_error-548"><span class="linenos">548</span></a><span class="sd">            The error.</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-549"><a href="#SearchMolecularFormulaWorker.set_last_error-549"><span class="linenos">549</span></a><span class="sd">        mass_spectrum_obj : MassSpectrum</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-550"><a href="#SearchMolecularFormulaWorker.set_last_error-550"><span class="linenos">550</span></a><span class="sd">            The mass spectrum object.</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-551"><a href="#SearchMolecularFormulaWorker.set_last_error-551"><span class="linenos">551</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-552"><a href="#SearchMolecularFormulaWorker.set_last_error-552"><span class="linenos">552</span></a>        <span class="c1"># set the changes to the global variables, not internal ones</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-553"><a href="#SearchMolecularFormulaWorker.set_last_error-553"><span class="linenos">553</span></a>        <span class="k">global</span> <span class="n">last_error</span><span class="p">,</span> <span class="n">last_dif</span><span class="p">,</span> <span class="n">closest_error</span><span class="p">,</span> <span class="n">error_average</span><span class="p">,</span> <span class="n">nbValues</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-554"><a href="#SearchMolecularFormulaWorker.set_last_error-554"><span class="linenos">554</span></a>
</span><span id="SearchMolecularFormulaWorker.set_last_error-555"><a href="#SearchMolecularFormulaWorker.set_last_error-555"><span class="linenos">555</span></a>        <span class="k">if</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">error_method</span> <span class="o">==</span> <span class="s2">&quot;distance&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-556"><a href="#SearchMolecularFormulaWorker.set_last_error-556"><span class="linenos">556</span></a>            <span class="n">dif</span> <span class="o">=</span> <span class="n">error</span> <span class="o">-</span> <span class="n">last_error</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-557"><a href="#SearchMolecularFormulaWorker.set_last_error-557"><span class="linenos">557</span></a>            <span class="k">if</span> <span class="n">dif</span> <span class="o">&lt;</span> <span class="n">last_dif</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-558"><a href="#SearchMolecularFormulaWorker.set_last_error-558"><span class="linenos">558</span></a>                <span class="n">last_dif</span> <span class="o">=</span> <span class="n">dif</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-559"><a href="#SearchMolecularFormulaWorker.set_last_error-559"><span class="linenos">559</span></a>                <span class="n">closest_error</span> <span class="o">=</span> <span class="n">error</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-560"><a href="#SearchMolecularFormulaWorker.set_last_error-560"><span class="linenos">560</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-561"><a href="#SearchMolecularFormulaWorker.set_last_error-561"><span class="linenos">561</span></a>                    <span class="n">closest_error</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-562"><a href="#SearchMolecularFormulaWorker.set_last_error-562"><span class="linenos">562</span></a>                    <span class="o">-</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-563"><a href="#SearchMolecularFormulaWorker.set_last_error-563"><span class="linenos">563</span></a>                <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-564"><a href="#SearchMolecularFormulaWorker.set_last_error-564"><span class="linenos">564</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-565"><a href="#SearchMolecularFormulaWorker.set_last_error-565"><span class="linenos">565</span></a>                    <span class="n">closest_error</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-566"><a href="#SearchMolecularFormulaWorker.set_last_error-566"><span class="linenos">566</span></a>                    <span class="o">+</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-567"><a href="#SearchMolecularFormulaWorker.set_last_error-567"><span class="linenos">567</span></a>                <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-568"><a href="#SearchMolecularFormulaWorker.set_last_error-568"><span class="linenos">568</span></a>
</span><span id="SearchMolecularFormulaWorker.set_last_error-569"><a href="#SearchMolecularFormulaWorker.set_last_error-569"><span class="linenos">569</span></a>        <span class="k">elif</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">error_method</span> <span class="o">==</span> <span class="s2">&quot;lowest&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-570"><a href="#SearchMolecularFormulaWorker.set_last_error-570"><span class="linenos">570</span></a>            <span class="k">if</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="n">last_error</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-571"><a href="#SearchMolecularFormulaWorker.set_last_error-571"><span class="linenos">571</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-572"><a href="#SearchMolecularFormulaWorker.set_last_error-572"><span class="linenos">572</span></a>                    <span class="n">error</span> <span class="o">-</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-573"><a href="#SearchMolecularFormulaWorker.set_last_error-573"><span class="linenos">573</span></a>                <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-574"><a href="#SearchMolecularFormulaWorker.set_last_error-574"><span class="linenos">574</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-575"><a href="#SearchMolecularFormulaWorker.set_last_error-575"><span class="linenos">575</span></a>                    <span class="n">error</span> <span class="o">+</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-576"><a href="#SearchMolecularFormulaWorker.set_last_error-576"><span class="linenos">576</span></a>                <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-577"><a href="#SearchMolecularFormulaWorker.set_last_error-577"><span class="linenos">577</span></a>                <span class="n">last_error</span> <span class="o">=</span> <span class="n">error</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-578"><a href="#SearchMolecularFormulaWorker.set_last_error-578"><span class="linenos">578</span></a>
</span><span id="SearchMolecularFormulaWorker.set_last_error-579"><a href="#SearchMolecularFormulaWorker.set_last_error-579"><span class="linenos">579</span></a>        <span class="k">elif</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">error_method</span> <span class="o">==</span> <span class="s2">&quot;symmetrical&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-580"><a href="#SearchMolecularFormulaWorker.set_last_error-580"><span class="linenos">580</span></a>            <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-581"><a href="#SearchMolecularFormulaWorker.set_last_error-581"><span class="linenos">581</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_average</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-582"><a href="#SearchMolecularFormulaWorker.set_last_error-582"><span class="linenos">582</span></a>                <span class="o">-</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-583"><a href="#SearchMolecularFormulaWorker.set_last_error-583"><span class="linenos">583</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-584"><a href="#SearchMolecularFormulaWorker.set_last_error-584"><span class="linenos">584</span></a>            <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-585"><a href="#SearchMolecularFormulaWorker.set_last_error-585"><span class="linenos">585</span></a>                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_average</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-586"><a href="#SearchMolecularFormulaWorker.set_last_error-586"><span class="linenos">586</span></a>                <span class="o">+</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-587"><a href="#SearchMolecularFormulaWorker.set_last_error-587"><span class="linenos">587</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-588"><a href="#SearchMolecularFormulaWorker.set_last_error-588"><span class="linenos">588</span></a>
</span><span id="SearchMolecularFormulaWorker.set_last_error-589"><a href="#SearchMolecularFormulaWorker.set_last_error-589"><span class="linenos">589</span></a>        <span class="k">elif</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">error_method</span> <span class="o">==</span> <span class="s2">&quot;average&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-590"><a href="#SearchMolecularFormulaWorker.set_last_error-590"><span class="linenos">590</span></a>            <span class="n">nbValues</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-591"><a href="#SearchMolecularFormulaWorker.set_last_error-591"><span class="linenos">591</span></a>            <span class="n">error_average</span> <span class="o">=</span> <span class="n">error_average</span> <span class="o">+</span> <span class="p">((</span><span class="n">error</span> <span class="o">-</span> <span class="n">error_average</span><span class="p">)</span> <span class="o">/</span> <span class="n">nbValues</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-592"><a href="#SearchMolecularFormulaWorker.set_last_error-592"><span class="linenos">592</span></a>            <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-593"><a href="#SearchMolecularFormulaWorker.set_last_error-593"><span class="linenos">593</span></a>                <span class="n">error_average</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-594"><a href="#SearchMolecularFormulaWorker.set_last_error-594"><span class="linenos">594</span></a>                <span class="o">-</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-595"><a href="#SearchMolecularFormulaWorker.set_last_error-595"><span class="linenos">595</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-596"><a href="#SearchMolecularFormulaWorker.set_last_error-596"><span class="linenos">596</span></a>            <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_ppm_error</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-597"><a href="#SearchMolecularFormulaWorker.set_last_error-597"><span class="linenos">597</span></a>                <span class="n">error_average</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-598"><a href="#SearchMolecularFormulaWorker.set_last_error-598"><span class="linenos">598</span></a>                <span class="o">+</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">mz_error_range</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-599"><a href="#SearchMolecularFormulaWorker.set_last_error-599"><span class="linenos">599</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-600"><a href="#SearchMolecularFormulaWorker.set_last_error-600"><span class="linenos">600</span></a>
</span><span id="SearchMolecularFormulaWorker.set_last_error-601"><a href="#SearchMolecularFormulaWorker.set_last_error-601"><span class="linenos">601</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-602"><a href="#SearchMolecularFormulaWorker.set_last_error-602"><span class="linenos">602</span></a>            <span class="c1"># using set mass_spectrum_obj.molecular_search_settings.min_ppm_error  and max_ppm_error range</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-603"><a href="#SearchMolecularFormulaWorker.set_last_error-603"><span class="linenos">603</span></a>            <span class="k">pass</span>
</span><span id="SearchMolecularFormulaWorker.set_last_error-604"><a href="#SearchMolecularFormulaWorker.set_last_error-604"><span class="linenos">604</span></a>
</span><span id="SearchMolecularFormulaWorker.set_last_error-605"><a href="#SearchMolecularFormulaWorker.set_last_error-605"><span class="linenos">605</span></a>        <span class="c1"># returns the error based on the selected method at mass_spectrum_obj.molecular_search_settings.method</span>
</span></pre></div>


            <div class="docstring"><p>Set the last error.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>error</strong> (float):
The error.</li>
<li><strong>mass_spectrum_obj</strong> (MassSpectrum):
The mass spectrum object.</li>
</ul>
</div>


                            </div>
                            <div id="SearchMolecularFormulaWorker.calc_error" class="classattr">
                                        <input id="SearchMolecularFormulaWorker.calc_error-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">calc_error</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">mz_exp</span>, </span><span class="param"><span class="n">mz_calc</span>, </span><span class="param"><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ppm&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SearchMolecularFormulaWorker.calc_error-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulaWorker.calc_error"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulaWorker.calc_error-607"><a href="#SearchMolecularFormulaWorker.calc_error-607"><span class="linenos">607</span></a>    <span class="nd">@staticmethod</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-608"><a href="#SearchMolecularFormulaWorker.calc_error-608"><span class="linenos">608</span></a>    <span class="k">def</span> <span class="nf">calc_error</span><span class="p">(</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">mz_calc</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ppm&quot;</span><span class="p">):</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-609"><a href="#SearchMolecularFormulaWorker.calc_error-609"><span class="linenos">609</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the error.</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-610"><a href="#SearchMolecularFormulaWorker.calc_error-610"><span class="linenos">610</span></a>
</span><span id="SearchMolecularFormulaWorker.calc_error-611"><a href="#SearchMolecularFormulaWorker.calc_error-611"><span class="linenos">611</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-612"><a href="#SearchMolecularFormulaWorker.calc_error-612"><span class="linenos">612</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-613"><a href="#SearchMolecularFormulaWorker.calc_error-613"><span class="linenos">613</span></a><span class="sd">        mz_exp : float</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-614"><a href="#SearchMolecularFormulaWorker.calc_error-614"><span class="linenos">614</span></a><span class="sd">            The experimental m/z value.</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-615"><a href="#SearchMolecularFormulaWorker.calc_error-615"><span class="linenos">615</span></a><span class="sd">        mz_calc : float</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-616"><a href="#SearchMolecularFormulaWorker.calc_error-616"><span class="linenos">616</span></a><span class="sd">            The calculated m/z value.</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-617"><a href="#SearchMolecularFormulaWorker.calc_error-617"><span class="linenos">617</span></a><span class="sd">        method : str, optional</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-618"><a href="#SearchMolecularFormulaWorker.calc_error-618"><span class="linenos">618</span></a><span class="sd">            The method, by default &#39;ppm&#39;.</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-619"><a href="#SearchMolecularFormulaWorker.calc_error-619"><span class="linenos">619</span></a>
</span><span id="SearchMolecularFormulaWorker.calc_error-620"><a href="#SearchMolecularFormulaWorker.calc_error-620"><span class="linenos">620</span></a><span class="sd">        Raises</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-621"><a href="#SearchMolecularFormulaWorker.calc_error-621"><span class="linenos">621</span></a><span class="sd">        -------</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-622"><a href="#SearchMolecularFormulaWorker.calc_error-622"><span class="linenos">622</span></a><span class="sd">        Exception</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-623"><a href="#SearchMolecularFormulaWorker.calc_error-623"><span class="linenos">623</span></a><span class="sd">            If the method is not ppm or ppb.</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-624"><a href="#SearchMolecularFormulaWorker.calc_error-624"><span class="linenos">624</span></a>
</span><span id="SearchMolecularFormulaWorker.calc_error-625"><a href="#SearchMolecularFormulaWorker.calc_error-625"><span class="linenos">625</span></a><span class="sd">        Returns</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-626"><a href="#SearchMolecularFormulaWorker.calc_error-626"><span class="linenos">626</span></a><span class="sd">        -------</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-627"><a href="#SearchMolecularFormulaWorker.calc_error-627"><span class="linenos">627</span></a><span class="sd">        float</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-628"><a href="#SearchMolecularFormulaWorker.calc_error-628"><span class="linenos">628</span></a><span class="sd">            The error.</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-629"><a href="#SearchMolecularFormulaWorker.calc_error-629"><span class="linenos">629</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-630"><a href="#SearchMolecularFormulaWorker.calc_error-630"><span class="linenos">630</span></a>
</span><span id="SearchMolecularFormulaWorker.calc_error-631"><a href="#SearchMolecularFormulaWorker.calc_error-631"><span class="linenos">631</span></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;ppm&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-632"><a href="#SearchMolecularFormulaWorker.calc_error-632"><span class="linenos">632</span></a>            <span class="n">multi_factor</span> <span class="o">=</span> <span class="mi">1_000_000</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-633"><a href="#SearchMolecularFormulaWorker.calc_error-633"><span class="linenos">633</span></a>
</span><span id="SearchMolecularFormulaWorker.calc_error-634"><a href="#SearchMolecularFormulaWorker.calc_error-634"><span class="linenos">634</span></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;ppb&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-635"><a href="#SearchMolecularFormulaWorker.calc_error-635"><span class="linenos">635</span></a>            <span class="n">multi_factor</span> <span class="o">=</span> <span class="mi">1_000_000_000</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-636"><a href="#SearchMolecularFormulaWorker.calc_error-636"><span class="linenos">636</span></a>
</span><span id="SearchMolecularFormulaWorker.calc_error-637"><a href="#SearchMolecularFormulaWorker.calc_error-637"><span class="linenos">637</span></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;perc&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-638"><a href="#SearchMolecularFormulaWorker.calc_error-638"><span class="linenos">638</span></a>            <span class="n">multi_factor</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-639"><a href="#SearchMolecularFormulaWorker.calc_error-639"><span class="linenos">639</span></a>
</span><span id="SearchMolecularFormulaWorker.calc_error-640"><a href="#SearchMolecularFormulaWorker.calc_error-640"><span class="linenos">640</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-641"><a href="#SearchMolecularFormulaWorker.calc_error-641"><span class="linenos">641</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-642"><a href="#SearchMolecularFormulaWorker.calc_error-642"><span class="linenos">642</span></a>                <span class="s2">&quot;method needs to be ppm or ppb, you have entered </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">method</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-643"><a href="#SearchMolecularFormulaWorker.calc_error-643"><span class="linenos">643</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-644"><a href="#SearchMolecularFormulaWorker.calc_error-644"><span class="linenos">644</span></a>
</span><span id="SearchMolecularFormulaWorker.calc_error-645"><a href="#SearchMolecularFormulaWorker.calc_error-645"><span class="linenos">645</span></a>        <span class="k">if</span> <span class="n">mz_exp</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-646"><a href="#SearchMolecularFormulaWorker.calc_error-646"><span class="linenos">646</span></a>            <span class="k">return</span> <span class="p">((</span><span class="n">mz_exp</span> <span class="o">-</span> <span class="n">mz_calc</span><span class="p">)</span> <span class="o">/</span> <span class="n">mz_calc</span><span class="p">)</span> <span class="o">*</span> <span class="n">multi_factor</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-647"><a href="#SearchMolecularFormulaWorker.calc_error-647"><span class="linenos">647</span></a>
</span><span id="SearchMolecularFormulaWorker.calc_error-648"><a href="#SearchMolecularFormulaWorker.calc_error-648"><span class="linenos">648</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.calc_error-649"><a href="#SearchMolecularFormulaWorker.calc_error-649"><span class="linenos">649</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please set mz_calc first&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Calculate the error.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>mz_exp</strong> (float):
The experimental m/z value.</li>
<li><strong>mz_calc</strong> (float):
The calculated m/z value.</li>
<li><strong>method</strong> (str, optional):
The method, by default 'ppm'.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>Exception</strong>: If the method is not ppm or ppb.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>float</strong>: The error.</li>
</ul>
</div>


                            </div>
                            <div id="SearchMolecularFormulaWorker.find_formulas" class="classattr">
                                        <input id="SearchMolecularFormulaWorker.find_formulas-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">find_formulas</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">formulas</span>,</span><span class="param">	<span class="n">min_abundance</span>,</span><span class="param">	<span class="n">mass_spectrum_obj</span>,</span><span class="param">	<span class="n">ms_peak</span>,</span><span class="param">	<span class="n">ion_type</span>,</span><span class="param">	<span class="n">ion_charge</span>,</span><span class="param">	<span class="n">adduct_atom</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SearchMolecularFormulaWorker.find_formulas-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulaWorker.find_formulas"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulaWorker.find_formulas-651"><a href="#SearchMolecularFormulaWorker.find_formulas-651"><span class="linenos">651</span></a>    <span class="k">def</span> <span class="nf">find_formulas</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-652"><a href="#SearchMolecularFormulaWorker.find_formulas-652"><span class="linenos">652</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-653"><a href="#SearchMolecularFormulaWorker.find_formulas-653"><span class="linenos">653</span></a>        <span class="n">formulas</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-654"><a href="#SearchMolecularFormulaWorker.find_formulas-654"><span class="linenos">654</span></a>        <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-655"><a href="#SearchMolecularFormulaWorker.find_formulas-655"><span class="linenos">655</span></a>        <span class="n">mass_spectrum_obj</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-656"><a href="#SearchMolecularFormulaWorker.find_formulas-656"><span class="linenos">656</span></a>        <span class="n">ms_peak</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-657"><a href="#SearchMolecularFormulaWorker.find_formulas-657"><span class="linenos">657</span></a>        <span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-658"><a href="#SearchMolecularFormulaWorker.find_formulas-658"><span class="linenos">658</span></a>        <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-659"><a href="#SearchMolecularFormulaWorker.find_formulas-659"><span class="linenos">659</span></a>        <span class="n">adduct_atom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-660"><a href="#SearchMolecularFormulaWorker.find_formulas-660"><span class="linenos">660</span></a>    <span class="p">):</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-661"><a href="#SearchMolecularFormulaWorker.find_formulas-661"><span class="linenos">661</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the formulas.</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-662"><a href="#SearchMolecularFormulaWorker.find_formulas-662"><span class="linenos">662</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-663"><a href="#SearchMolecularFormulaWorker.find_formulas-663"><span class="linenos">663</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-664"><a href="#SearchMolecularFormulaWorker.find_formulas-664"><span class="linenos">664</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-665"><a href="#SearchMolecularFormulaWorker.find_formulas-665"><span class="linenos">665</span></a><span class="sd">        formulas : list of MolecularFormula</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-666"><a href="#SearchMolecularFormulaWorker.find_formulas-666"><span class="linenos">666</span></a><span class="sd">            The list of molecular formulas.</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-667"><a href="#SearchMolecularFormulaWorker.find_formulas-667"><span class="linenos">667</span></a><span class="sd">        min_abundance : float</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-668"><a href="#SearchMolecularFormulaWorker.find_formulas-668"><span class="linenos">668</span></a><span class="sd">            The minimum abundance threshold.</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-669"><a href="#SearchMolecularFormulaWorker.find_formulas-669"><span class="linenos">669</span></a><span class="sd">        mass_spectrum_obj : MassSpectrum</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-670"><a href="#SearchMolecularFormulaWorker.find_formulas-670"><span class="linenos">670</span></a><span class="sd">            The mass spectrum object.</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-671"><a href="#SearchMolecularFormulaWorker.find_formulas-671"><span class="linenos">671</span></a><span class="sd">        ms_peak : MSPeak</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-672"><a href="#SearchMolecularFormulaWorker.find_formulas-672"><span class="linenos">672</span></a><span class="sd">            The mass spectrum peak.</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-673"><a href="#SearchMolecularFormulaWorker.find_formulas-673"><span class="linenos">673</span></a><span class="sd">        ion_type : str</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-674"><a href="#SearchMolecularFormulaWorker.find_formulas-674"><span class="linenos">674</span></a><span class="sd">            The ion type.</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-675"><a href="#SearchMolecularFormulaWorker.find_formulas-675"><span class="linenos">675</span></a><span class="sd">        ion_charge : int</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-676"><a href="#SearchMolecularFormulaWorker.find_formulas-676"><span class="linenos">676</span></a><span class="sd">            The ion charge.</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-677"><a href="#SearchMolecularFormulaWorker.find_formulas-677"><span class="linenos">677</span></a><span class="sd">        adduct_atom : str, optional</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-678"><a href="#SearchMolecularFormulaWorker.find_formulas-678"><span class="linenos">678</span></a><span class="sd">            The adduct atom, by default None.</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-679"><a href="#SearchMolecularFormulaWorker.find_formulas-679"><span class="linenos">679</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-680"><a href="#SearchMolecularFormulaWorker.find_formulas-680"><span class="linenos">680</span></a><span class="sd">        Returns</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-681"><a href="#SearchMolecularFormulaWorker.find_formulas-681"><span class="linenos">681</span></a><span class="sd">        -------</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-682"><a href="#SearchMolecularFormulaWorker.find_formulas-682"><span class="linenos">682</span></a><span class="sd">        list of MSPeak</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-683"><a href="#SearchMolecularFormulaWorker.find_formulas-683"><span class="linenos">683</span></a><span class="sd">            The list of mass spectrum peaks with assigned molecular formulas.</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-684"><a href="#SearchMolecularFormulaWorker.find_formulas-684"><span class="linenos">684</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-685"><a href="#SearchMolecularFormulaWorker.find_formulas-685"><span class="linenos">685</span></a><span class="sd">        Notes</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-686"><a href="#SearchMolecularFormulaWorker.find_formulas-686"><span class="linenos">686</span></a><span class="sd">        -----</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-687"><a href="#SearchMolecularFormulaWorker.find_formulas-687"><span class="linenos">687</span></a><span class="sd">        Uses the closest error the next search (this is not ideal, it needs to use confidence</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-688"><a href="#SearchMolecularFormulaWorker.find_formulas-688"><span class="linenos">688</span></a><span class="sd">        metric to choose the right candidate then propagate the error using the error from the best candidate).</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-689"><a href="#SearchMolecularFormulaWorker.find_formulas-689"><span class="linenos">689</span></a><span class="sd">        It needs to add s/n to the equation.</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-690"><a href="#SearchMolecularFormulaWorker.find_formulas-690"><span class="linenos">690</span></a><span class="sd">        It need optimization to define the mz_error_range within a m/z unit since it is directly proportional</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-691"><a href="#SearchMolecularFormulaWorker.find_formulas-691"><span class="linenos">691</span></a><span class="sd">        with the mass, and inversely proportional to the rp. It&#39;s not linear, i.e., sigma mass.</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-692"><a href="#SearchMolecularFormulaWorker.find_formulas-692"><span class="linenos">692</span></a><span class="sd">        The idea it to correlate sigma to resolving power, signal to noise and sample complexity per mz unit.</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-693"><a href="#SearchMolecularFormulaWorker.find_formulas-693"><span class="linenos">693</span></a><span class="sd">        Method=&#39;distance&#39;</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-694"><a href="#SearchMolecularFormulaWorker.find_formulas-694"><span class="linenos">694</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-695"><a href="#SearchMolecularFormulaWorker.find_formulas-695"><span class="linenos">695</span></a>        <span class="n">mspeak_assigned_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-696"><a href="#SearchMolecularFormulaWorker.find_formulas-696"><span class="linenos">696</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-697"><a href="#SearchMolecularFormulaWorker.find_formulas-697"><span class="linenos">697</span></a>        <span class="n">min_ppm_error</span> <span class="o">=</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_ppm_error</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-698"><a href="#SearchMolecularFormulaWorker.find_formulas-698"><span class="linenos">698</span></a>        <span class="n">max_ppm_error</span> <span class="o">=</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_ppm_error</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-699"><a href="#SearchMolecularFormulaWorker.find_formulas-699"><span class="linenos">699</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-700"><a href="#SearchMolecularFormulaWorker.find_formulas-700"><span class="linenos">700</span></a>        <span class="n">min_abun_error</span> <span class="o">=</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">min_abun_error</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-701"><a href="#SearchMolecularFormulaWorker.find_formulas-701"><span class="linenos">701</span></a>        <span class="n">max_abun_error</span> <span class="o">=</span> <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">molecular_search_settings</span><span class="o">.</span><span class="n">max_abun_error</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-702"><a href="#SearchMolecularFormulaWorker.find_formulas-702"><span class="linenos">702</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-703"><a href="#SearchMolecularFormulaWorker.find_formulas-703"><span class="linenos">703</span></a>        <span class="c1"># f = open(&quot;abundance_error.txt&quot;, &quot;a+&quot;)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-704"><a href="#SearchMolecularFormulaWorker.find_formulas-704"><span class="linenos">704</span></a>        <span class="n">ms_peak_mz_exp</span><span class="p">,</span> <span class="n">ms_peak_abundance</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-705"><a href="#SearchMolecularFormulaWorker.find_formulas-705"><span class="linenos">705</span></a>        <span class="c1"># min_error = min([pmf.mz_error for pmf in possible_formulas])</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-706"><a href="#SearchMolecularFormulaWorker.find_formulas-706"><span class="linenos">706</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-707"><a href="#SearchMolecularFormulaWorker.find_formulas-707"><span class="linenos">707</span></a>        <span class="k">def</span> <span class="nf">mass_by_ion_type</span><span class="p">(</span><span class="n">possible_formula_obj</span><span class="p">):</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-708"><a href="#SearchMolecularFormulaWorker.find_formulas-708"><span class="linenos">708</span></a>            <span class="k">if</span> <span class="n">ion_type</span> <span class="o">==</span> <span class="n">Labels</span><span class="o">.</span><span class="n">protonated_de_ion</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-709"><a href="#SearchMolecularFormulaWorker.find_formulas-709"><span class="linenos">709</span></a>                <span class="k">return</span> <span class="n">possible_formula_obj</span><span class="o">.</span><span class="n">_protonated_mz</span><span class="p">(</span><span class="n">ion_charge</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-710"><a href="#SearchMolecularFormulaWorker.find_formulas-710"><span class="linenos">710</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-711"><a href="#SearchMolecularFormulaWorker.find_formulas-711"><span class="linenos">711</span></a>            <span class="k">elif</span> <span class="n">ion_type</span> <span class="o">==</span> <span class="n">Labels</span><span class="o">.</span><span class="n">radical_ion</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-712"><a href="#SearchMolecularFormulaWorker.find_formulas-712"><span class="linenos">712</span></a>                <span class="k">return</span> <span class="n">possible_formula_obj</span><span class="o">.</span><span class="n">_radical_mz</span><span class="p">(</span><span class="n">ion_charge</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-713"><a href="#SearchMolecularFormulaWorker.find_formulas-713"><span class="linenos">713</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-714"><a href="#SearchMolecularFormulaWorker.find_formulas-714"><span class="linenos">714</span></a>            <span class="k">elif</span> <span class="n">ion_type</span> <span class="o">==</span> <span class="n">Labels</span><span class="o">.</span><span class="n">adduct_ion</span> <span class="ow">and</span> <span class="n">adduct_atom</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-715"><a href="#SearchMolecularFormulaWorker.find_formulas-715"><span class="linenos">715</span></a>                <span class="k">return</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">_adduct_mz</span><span class="p">(</span><span class="n">ion_charge</span><span class="p">,</span> <span class="n">adduct_atom</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-716"><a href="#SearchMolecularFormulaWorker.find_formulas-716"><span class="linenos">716</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-717"><a href="#SearchMolecularFormulaWorker.find_formulas-717"><span class="linenos">717</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-718"><a href="#SearchMolecularFormulaWorker.find_formulas-718"><span class="linenos">718</span></a>                <span class="c1"># will return externally calculated mz if is set, #use on Bruker Reference list import</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-719"><a href="#SearchMolecularFormulaWorker.find_formulas-719"><span class="linenos">719</span></a>                <span class="c1"># if the ion type is known the ion mass based on molecular formula ion type</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-720"><a href="#SearchMolecularFormulaWorker.find_formulas-720"><span class="linenos">720</span></a>                <span class="c1"># if ion type is unknow will return neutral mass</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-721"><a href="#SearchMolecularFormulaWorker.find_formulas-721"><span class="linenos">721</span></a>                <span class="k">return</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">mz_calc</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-722"><a href="#SearchMolecularFormulaWorker.find_formulas-722"><span class="linenos">722</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-723"><a href="#SearchMolecularFormulaWorker.find_formulas-723"><span class="linenos">723</span></a>        <span class="k">if</span> <span class="n">formulas</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-724"><a href="#SearchMolecularFormulaWorker.find_formulas-724"><span class="linenos">724</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">formulas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">LCMSLibRefMolecularFormula</span><span class="p">):</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-725"><a href="#SearchMolecularFormulaWorker.find_formulas-725"><span class="linenos">725</span></a>                <span class="n">possible_mf_class</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-726"><a href="#SearchMolecularFormulaWorker.find_formulas-726"><span class="linenos">726</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-727"><a href="#SearchMolecularFormulaWorker.find_formulas-727"><span class="linenos">727</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-728"><a href="#SearchMolecularFormulaWorker.find_formulas-728"><span class="linenos">728</span></a>                <span class="n">possible_mf_class</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-729"><a href="#SearchMolecularFormulaWorker.find_formulas-729"><span class="linenos">729</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-730"><a href="#SearchMolecularFormulaWorker.find_formulas-730"><span class="linenos">730</span></a>        <span class="k">for</span> <span class="n">possible_formula</span> <span class="ow">in</span> <span class="n">formulas</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-731"><a href="#SearchMolecularFormulaWorker.find_formulas-731"><span class="linenos">731</span></a>            <span class="k">if</span> <span class="n">possible_formula</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-732"><a href="#SearchMolecularFormulaWorker.find_formulas-732"><span class="linenos">732</span></a>                <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_error</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-733"><a href="#SearchMolecularFormulaWorker.find_formulas-733"><span class="linenos">733</span></a>                    <span class="n">ms_peak_mz_exp</span><span class="p">,</span> <span class="n">mass_by_ion_type</span><span class="p">(</span><span class="n">possible_formula</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-734"><a href="#SearchMolecularFormulaWorker.find_formulas-734"><span class="linenos">734</span></a>                <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-735"><a href="#SearchMolecularFormulaWorker.find_formulas-735"><span class="linenos">735</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-736"><a href="#SearchMolecularFormulaWorker.find_formulas-736"><span class="linenos">736</span></a>                <span class="c1"># error = possible_formula.mz_error</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-737"><a href="#SearchMolecularFormulaWorker.find_formulas-737"><span class="linenos">737</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-738"><a href="#SearchMolecularFormulaWorker.find_formulas-738"><span class="linenos">738</span></a>                <span class="k">if</span> <span class="n">min_ppm_error</span> <span class="o">&lt;=</span> <span class="n">error</span> <span class="o">&lt;=</span> <span class="n">max_ppm_error</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-739"><a href="#SearchMolecularFormulaWorker.find_formulas-739"><span class="linenos">739</span></a>                    <span class="c1"># update the error</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-740"><a href="#SearchMolecularFormulaWorker.find_formulas-740"><span class="linenos">740</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-741"><a href="#SearchMolecularFormulaWorker.find_formulas-741"><span class="linenos">741</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">set_last_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">mass_spectrum_obj</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-742"><a href="#SearchMolecularFormulaWorker.find_formulas-742"><span class="linenos">742</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-743"><a href="#SearchMolecularFormulaWorker.find_formulas-743"><span class="linenos">743</span></a>                    <span class="c1"># add molecular formula match to ms_peak</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-744"><a href="#SearchMolecularFormulaWorker.find_formulas-744"><span class="linenos">744</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-745"><a href="#SearchMolecularFormulaWorker.find_formulas-745"><span class="linenos">745</span></a>                    <span class="c1"># get molecular formula dict from sql obj</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-746"><a href="#SearchMolecularFormulaWorker.find_formulas-746"><span class="linenos">746</span></a>                    <span class="c1"># formula_dict = pickle.loads(possible_formula.mol_formula)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-747"><a href="#SearchMolecularFormulaWorker.find_formulas-747"><span class="linenos">747</span></a>                    <span class="c1"># if possible_mf_class:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-748"><a href="#SearchMolecularFormulaWorker.find_formulas-748"><span class="linenos">748</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-749"><a href="#SearchMolecularFormulaWorker.find_formulas-749"><span class="linenos">749</span></a>                    <span class="c1">#    molecular_formula = deepcopy(possible_formula)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-750"><a href="#SearchMolecularFormulaWorker.find_formulas-750"><span class="linenos">750</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-751"><a href="#SearchMolecularFormulaWorker.find_formulas-751"><span class="linenos">751</span></a>                    <span class="c1"># else:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-752"><a href="#SearchMolecularFormulaWorker.find_formulas-752"><span class="linenos">752</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-753"><a href="#SearchMolecularFormulaWorker.find_formulas-753"><span class="linenos">753</span></a>                    <span class="n">formula_dict</span> <span class="o">=</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-754"><a href="#SearchMolecularFormulaWorker.find_formulas-754"><span class="linenos">754</span></a>                    <span class="c1"># create the molecular formula obj to be stored</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-755"><a href="#SearchMolecularFormulaWorker.find_formulas-755"><span class="linenos">755</span></a>                    <span class="k">if</span> <span class="n">possible_mf_class</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-756"><a href="#SearchMolecularFormulaWorker.find_formulas-756"><span class="linenos">756</span></a>                        <span class="n">molecular_formula</span> <span class="o">=</span> <span class="n">LCMSLibRefMolecularFormula</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-757"><a href="#SearchMolecularFormulaWorker.find_formulas-757"><span class="linenos">757</span></a>                            <span class="n">formula_dict</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-758"><a href="#SearchMolecularFormulaWorker.find_formulas-758"><span class="linenos">758</span></a>                            <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-759"><a href="#SearchMolecularFormulaWorker.find_formulas-759"><span class="linenos">759</span></a>                            <span class="n">ion_type</span><span class="o">=</span><span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-760"><a href="#SearchMolecularFormulaWorker.find_formulas-760"><span class="linenos">760</span></a>                            <span class="n">adduct_atom</span><span class="o">=</span><span class="n">adduct_atom</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-761"><a href="#SearchMolecularFormulaWorker.find_formulas-761"><span class="linenos">761</span></a>                        <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-762"><a href="#SearchMolecularFormulaWorker.find_formulas-762"><span class="linenos">762</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-763"><a href="#SearchMolecularFormulaWorker.find_formulas-763"><span class="linenos">763</span></a>                        <span class="n">molecular_formula</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">name</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-764"><a href="#SearchMolecularFormulaWorker.find_formulas-764"><span class="linenos">764</span></a>                        <span class="n">molecular_formula</span><span class="o">.</span><span class="n">kegg_id</span> <span class="o">=</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">kegg_id</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-765"><a href="#SearchMolecularFormulaWorker.find_formulas-765"><span class="linenos">765</span></a>                        <span class="n">molecular_formula</span><span class="o">.</span><span class="n">cas</span> <span class="o">=</span> <span class="n">possible_formula</span><span class="o">.</span><span class="n">cas</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-766"><a href="#SearchMolecularFormulaWorker.find_formulas-766"><span class="linenos">766</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-767"><a href="#SearchMolecularFormulaWorker.find_formulas-767"><span class="linenos">767</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-768"><a href="#SearchMolecularFormulaWorker.find_formulas-768"><span class="linenos">768</span></a>                        <span class="n">molecular_formula</span> <span class="o">=</span> <span class="n">MolecularFormula</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-769"><a href="#SearchMolecularFormulaWorker.find_formulas-769"><span class="linenos">769</span></a>                            <span class="n">formula_dict</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-770"><a href="#SearchMolecularFormulaWorker.find_formulas-770"><span class="linenos">770</span></a>                            <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-771"><a href="#SearchMolecularFormulaWorker.find_formulas-771"><span class="linenos">771</span></a>                            <span class="n">ion_type</span><span class="o">=</span><span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-772"><a href="#SearchMolecularFormulaWorker.find_formulas-772"><span class="linenos">772</span></a>                            <span class="n">adduct_atom</span><span class="o">=</span><span class="n">adduct_atom</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-773"><a href="#SearchMolecularFormulaWorker.find_formulas-773"><span class="linenos">773</span></a>                        <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-774"><a href="#SearchMolecularFormulaWorker.find_formulas-774"><span class="linenos">774</span></a>                    <span class="c1"># add the molecular formula obj to the mspeak obj</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-775"><a href="#SearchMolecularFormulaWorker.find_formulas-775"><span class="linenos">775</span></a>                    <span class="c1"># add the mspeak obj and it&#39;s index for tracking next assignment step</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-776"><a href="#SearchMolecularFormulaWorker.find_formulas-776"><span class="linenos">776</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-777"><a href="#SearchMolecularFormulaWorker.find_formulas-777"><span class="linenos">777</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-778"><a href="#SearchMolecularFormulaWorker.find_formulas-778"><span class="linenos">778</span></a>                        <span class="c1"># calculates isotopologues</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-779"><a href="#SearchMolecularFormulaWorker.find_formulas-779"><span class="linenos">779</span></a>                        <span class="n">isotopologues</span> <span class="o">=</span> <span class="n">molecular_formula</span><span class="o">.</span><span class="n">isotopologues</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-780"><a href="#SearchMolecularFormulaWorker.find_formulas-780"><span class="linenos">780</span></a>                            <span class="n">min_abundance</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-781"><a href="#SearchMolecularFormulaWorker.find_formulas-781"><span class="linenos">781</span></a>                            <span class="n">ms_peak_abundance</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-782"><a href="#SearchMolecularFormulaWorker.find_formulas-782"><span class="linenos">782</span></a>                            <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">dynamic_range</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-783"><a href="#SearchMolecularFormulaWorker.find_formulas-783"><span class="linenos">783</span></a>                        <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-784"><a href="#SearchMolecularFormulaWorker.find_formulas-784"><span class="linenos">784</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-785"><a href="#SearchMolecularFormulaWorker.find_formulas-785"><span class="linenos">785</span></a>                        <span class="c1"># search for isotopologues</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-786"><a href="#SearchMolecularFormulaWorker.find_formulas-786"><span class="linenos">786</span></a>                        <span class="k">for</span> <span class="n">isotopologue_formula</span> <span class="ow">in</span> <span class="n">isotopologues</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-787"><a href="#SearchMolecularFormulaWorker.find_formulas-787"><span class="linenos">787</span></a>                            <span class="n">molecular_formula</span><span class="o">.</span><span class="n">expected_isotopologues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-788"><a href="#SearchMolecularFormulaWorker.find_formulas-788"><span class="linenos">788</span></a>                                <span class="n">isotopologue_formula</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-789"><a href="#SearchMolecularFormulaWorker.find_formulas-789"><span class="linenos">789</span></a>                            <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-790"><a href="#SearchMolecularFormulaWorker.find_formulas-790"><span class="linenos">790</span></a>                            <span class="c1"># move this outside to improve preformace</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-791"><a href="#SearchMolecularFormulaWorker.find_formulas-791"><span class="linenos">791</span></a>                            <span class="c1"># we need to increase the search space to -+1 m_z</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-792"><a href="#SearchMolecularFormulaWorker.find_formulas-792"><span class="linenos">792</span></a>                            <span class="n">first_index</span><span class="p">,</span> <span class="n">last_index</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-793"><a href="#SearchMolecularFormulaWorker.find_formulas-793"><span class="linenos">793</span></a>                                <span class="n">mass_spectrum_obj</span><span class="o">.</span><span class="n">get_nominal_mz_first_last_indexes</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-794"><a href="#SearchMolecularFormulaWorker.find_formulas-794"><span class="linenos">794</span></a>                                    <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">mz_nominal_calc</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-795"><a href="#SearchMolecularFormulaWorker.find_formulas-795"><span class="linenos">795</span></a>                                <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-796"><a href="#SearchMolecularFormulaWorker.find_formulas-796"><span class="linenos">796</span></a>                            <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-797"><a href="#SearchMolecularFormulaWorker.find_formulas-797"><span class="linenos">797</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-798"><a href="#SearchMolecularFormulaWorker.find_formulas-798"><span class="linenos">798</span></a>                            <span class="k">for</span> <span class="n">ms_peak_iso</span> <span class="ow">in</span> <span class="n">mass_spectrum_obj</span><span class="p">[</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-799"><a href="#SearchMolecularFormulaWorker.find_formulas-799"><span class="linenos">799</span></a>                                <span class="n">first_index</span><span class="p">:</span><span class="n">last_index</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-800"><a href="#SearchMolecularFormulaWorker.find_formulas-800"><span class="linenos">800</span></a>                            <span class="p">]:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-801"><a href="#SearchMolecularFormulaWorker.find_formulas-801"><span class="linenos">801</span></a>                                <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_error</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-802"><a href="#SearchMolecularFormulaWorker.find_formulas-802"><span class="linenos">802</span></a>                                    <span class="n">ms_peak_iso</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">,</span> <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">mz_calc</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-803"><a href="#SearchMolecularFormulaWorker.find_formulas-803"><span class="linenos">803</span></a>                                <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-804"><a href="#SearchMolecularFormulaWorker.find_formulas-804"><span class="linenos">804</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-805"><a href="#SearchMolecularFormulaWorker.find_formulas-805"><span class="linenos">805</span></a>                                <span class="k">if</span> <span class="n">min_ppm_error</span> <span class="o">&lt;=</span> <span class="n">error</span> <span class="o">&lt;=</span> <span class="n">max_ppm_error</span><span class="p">:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-806"><a href="#SearchMolecularFormulaWorker.find_formulas-806"><span class="linenos">806</span></a>                                    <span class="c1"># need to define error distribution for abundance measurements</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-807"><a href="#SearchMolecularFormulaWorker.find_formulas-807"><span class="linenos">807</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-808"><a href="#SearchMolecularFormulaWorker.find_formulas-808"><span class="linenos">808</span></a>                                    <span class="c1"># if mass_spectrum_obj.is_centroid:</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-809"><a href="#SearchMolecularFormulaWorker.find_formulas-809"><span class="linenos">809</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-810"><a href="#SearchMolecularFormulaWorker.find_formulas-810"><span class="linenos">810</span></a>                                    <span class="n">abundance_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_error</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-811"><a href="#SearchMolecularFormulaWorker.find_formulas-811"><span class="linenos">811</span></a>                                        <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">abundance_calc</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-812"><a href="#SearchMolecularFormulaWorker.find_formulas-812"><span class="linenos">812</span></a>                                        <span class="n">ms_peak_iso</span><span class="o">.</span><span class="n">abundance</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-813"><a href="#SearchMolecularFormulaWorker.find_formulas-813"><span class="linenos">813</span></a>                                        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;perc&quot;</span><span class="p">,</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-814"><a href="#SearchMolecularFormulaWorker.find_formulas-814"><span class="linenos">814</span></a>                                    <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-815"><a href="#SearchMolecularFormulaWorker.find_formulas-815"><span class="linenos">815</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-816"><a href="#SearchMolecularFormulaWorker.find_formulas-816"><span class="linenos">816</span></a>                                    <span class="c1"># area_error = self.calc_error(ms_peak.area, ms_peak_iso.area, method=&#39;perc&#39;)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-817"><a href="#SearchMolecularFormulaWorker.find_formulas-817"><span class="linenos">817</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-818"><a href="#SearchMolecularFormulaWorker.find_formulas-818"><span class="linenos">818</span></a>                                    <span class="c1"># margin of error was set empirically/ needs statistical calculation</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-819"><a href="#SearchMolecularFormulaWorker.find_formulas-819"><span class="linenos">819</span></a>                                    <span class="c1">#  of margin of error for the measurement of the abundances</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-820"><a href="#SearchMolecularFormulaWorker.find_formulas-820"><span class="linenos">820</span></a>                                    <span class="k">if</span> <span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-821"><a href="#SearchMolecularFormulaWorker.find_formulas-821"><span class="linenos">821</span></a>                                        <span class="n">min_abun_error</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-822"><a href="#SearchMolecularFormulaWorker.find_formulas-822"><span class="linenos">822</span></a>                                        <span class="o">&lt;=</span> <span class="n">abundance_error</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-823"><a href="#SearchMolecularFormulaWorker.find_formulas-823"><span class="linenos">823</span></a>                                        <span class="o">&lt;=</span> <span class="n">max_abun_error</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-824"><a href="#SearchMolecularFormulaWorker.find_formulas-824"><span class="linenos">824</span></a>                                    <span class="p">):</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-825"><a href="#SearchMolecularFormulaWorker.find_formulas-825"><span class="linenos">825</span></a>                                        <span class="c1"># update the error</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-826"><a href="#SearchMolecularFormulaWorker.find_formulas-826"><span class="linenos">826</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-827"><a href="#SearchMolecularFormulaWorker.find_formulas-827"><span class="linenos">827</span></a>                                        <span class="bp">self</span><span class="o">.</span><span class="n">set_last_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">mass_spectrum_obj</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-828"><a href="#SearchMolecularFormulaWorker.find_formulas-828"><span class="linenos">828</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-829"><a href="#SearchMolecularFormulaWorker.find_formulas-829"><span class="linenos">829</span></a>                                        <span class="c1"># isotopologue_formula.mz_error = error</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-830"><a href="#SearchMolecularFormulaWorker.find_formulas-830"><span class="linenos">830</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-831"><a href="#SearchMolecularFormulaWorker.find_formulas-831"><span class="linenos">831</span></a>                                        <span class="c1"># isotopologue_formula.area_error = area_error</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-832"><a href="#SearchMolecularFormulaWorker.find_formulas-832"><span class="linenos">832</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-833"><a href="#SearchMolecularFormulaWorker.find_formulas-833"><span class="linenos">833</span></a>                                        <span class="c1"># isotopologue_formula.abundance_error = abundance_error</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-834"><a href="#SearchMolecularFormulaWorker.find_formulas-834"><span class="linenos">834</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-835"><a href="#SearchMolecularFormulaWorker.find_formulas-835"><span class="linenos">835</span></a>                                        <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">mspeak_index_mono_isotopic</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">index</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-836"><a href="#SearchMolecularFormulaWorker.find_formulas-836"><span class="linenos">836</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-837"><a href="#SearchMolecularFormulaWorker.find_formulas-837"><span class="linenos">837</span></a>                                        <span class="n">mono_isotopic_formula_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms_peak</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-838"><a href="#SearchMolecularFormulaWorker.find_formulas-838"><span class="linenos">838</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-839"><a href="#SearchMolecularFormulaWorker.find_formulas-839"><span class="linenos">839</span></a>                                        <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">mspeak_index_mono_isotopic</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">index</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-840"><a href="#SearchMolecularFormulaWorker.find_formulas-840"><span class="linenos">840</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-841"><a href="#SearchMolecularFormulaWorker.find_formulas-841"><span class="linenos">841</span></a>                                        <span class="n">isotopologue_formula</span><span class="o">.</span><span class="n">mono_isotopic_formula_index</span> <span class="o">=</span> <span class="n">mono_isotopic_formula_index</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-842"><a href="#SearchMolecularFormulaWorker.find_formulas-842"><span class="linenos">842</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-843"><a href="#SearchMolecularFormulaWorker.find_formulas-843"><span class="linenos">843</span></a>                                        <span class="c1"># add mspeaks isotopologue index to the mono isotopic MolecularFormula obj and the respective formula position</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-844"><a href="#SearchMolecularFormulaWorker.find_formulas-844"><span class="linenos">844</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-845"><a href="#SearchMolecularFormulaWorker.find_formulas-845"><span class="linenos">845</span></a>                                        <span class="c1"># add molecular formula match to ms_peak</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-846"><a href="#SearchMolecularFormulaWorker.find_formulas-846"><span class="linenos">846</span></a>                                        <span class="n">x</span> <span class="o">=</span> <span class="n">ms_peak_iso</span><span class="o">.</span><span class="n">add_molecular_formula</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-847"><a href="#SearchMolecularFormulaWorker.find_formulas-847"><span class="linenos">847</span></a>                                            <span class="n">isotopologue_formula</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-848"><a href="#SearchMolecularFormulaWorker.find_formulas-848"><span class="linenos">848</span></a>                                        <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-849"><a href="#SearchMolecularFormulaWorker.find_formulas-849"><span class="linenos">849</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-850"><a href="#SearchMolecularFormulaWorker.find_formulas-850"><span class="linenos">850</span></a>                                        <span class="n">molecular_formula</span><span class="o">.</span><span class="n">mspeak_mf_isotopologues_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-851"><a href="#SearchMolecularFormulaWorker.find_formulas-851"><span class="linenos">851</span></a>                                            <span class="p">(</span><span class="n">ms_peak_iso</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-852"><a href="#SearchMolecularFormulaWorker.find_formulas-852"><span class="linenos">852</span></a>                                        <span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-853"><a href="#SearchMolecularFormulaWorker.find_formulas-853"><span class="linenos">853</span></a>                                        <span class="c1"># add mspeaks mono isotopic index to the isotopologue MolecularFormula obj</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-854"><a href="#SearchMolecularFormulaWorker.find_formulas-854"><span class="linenos">854</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-855"><a href="#SearchMolecularFormulaWorker.find_formulas-855"><span class="linenos">855</span></a>                    <span class="n">y</span> <span class="o">=</span> <span class="n">ms_peak</span><span class="o">.</span><span class="n">add_molecular_formula</span><span class="p">(</span><span class="n">molecular_formula</span><span class="p">)</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-856"><a href="#SearchMolecularFormulaWorker.find_formulas-856"><span class="linenos">856</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-857"><a href="#SearchMolecularFormulaWorker.find_formulas-857"><span class="linenos">857</span></a>                    <span class="n">mspeak_assigned_index</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ms_peak</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</span><span id="SearchMolecularFormulaWorker.find_formulas-858"><a href="#SearchMolecularFormulaWorker.find_formulas-858"><span class="linenos">858</span></a>
</span><span id="SearchMolecularFormulaWorker.find_formulas-859"><a href="#SearchMolecularFormulaWorker.find_formulas-859"><span class="linenos">859</span></a>        <span class="k">return</span> <span class="n">mspeak_assigned_index</span>
</span></pre></div>


            <div class="docstring"><p>Find the formulas.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>formulas</strong> (list of MolecularFormula):
The list of molecular formulas.</li>
<li><strong>min_abundance</strong> (float):
The minimum abundance threshold.</li>
<li><strong>mass_spectrum_obj</strong> (MassSpectrum):
The mass spectrum object.</li>
<li><strong>ms_peak</strong> (MSPeak):
The mass spectrum peak.</li>
<li><strong>ion_type</strong> (str):
The ion type.</li>
<li><strong>ion_charge</strong> (int):
The ion charge.</li>
<li><strong>adduct_atom</strong> (str, optional):
The adduct atom, by default None.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list of MSPeak</strong>: The list of mass spectrum peaks with assigned molecular formulas.</li>
</ul>

<h6 id="notes">Notes</h6>

<p>Uses the closest error the next search (this is not ideal, it needs to use confidence
metric to choose the right candidate then propagate the error using the error from the best candidate).
It needs to add s/n to the equation.
It need optimization to define the mz_error_range within a m/z unit since it is directly proportional
with the mass, and inversely proportional to the rp. It's not linear, i.e., sigma mass.
The idea it to correlate sigma to resolving power, signal to noise and sample complexity per mz unit.
Method='distance'</p>
</div>


                            </div>
                </section>
                <section id="SearchMolecularFormulasLC">
                            <input id="SearchMolecularFormulasLC-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SearchMolecularFormulasLC</span>:

                <label class="view-source-button" for="SearchMolecularFormulasLC-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulasLC"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulasLC-862"><a href="#SearchMolecularFormulasLC-862"><span class="linenos"> 862</span></a><span class="k">class</span> <span class="nc">SearchMolecularFormulasLC</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC-863"><a href="#SearchMolecularFormulasLC-863"><span class="linenos"> 863</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for searching molecular formulas in a LC object.</span>
</span><span id="SearchMolecularFormulasLC-864"><a href="#SearchMolecularFormulasLC-864"><span class="linenos"> 864</span></a>
</span><span id="SearchMolecularFormulasLC-865"><a href="#SearchMolecularFormulasLC-865"><span class="linenos"> 865</span></a><span class="sd">    Parameters</span>
</span><span id="SearchMolecularFormulasLC-866"><a href="#SearchMolecularFormulasLC-866"><span class="linenos"> 866</span></a><span class="sd">    ----------</span>
</span><span id="SearchMolecularFormulasLC-867"><a href="#SearchMolecularFormulasLC-867"><span class="linenos"> 867</span></a><span class="sd">    lcms_obj : LCMSBase</span>
</span><span id="SearchMolecularFormulasLC-868"><a href="#SearchMolecularFormulasLC-868"><span class="linenos"> 868</span></a><span class="sd">        The LCMSBase object.</span>
</span><span id="SearchMolecularFormulasLC-869"><a href="#SearchMolecularFormulasLC-869"><span class="linenos"> 869</span></a><span class="sd">    sql_db : MolForm_SQL, optional</span>
</span><span id="SearchMolecularFormulasLC-870"><a href="#SearchMolecularFormulasLC-870"><span class="linenos"> 870</span></a><span class="sd">        The SQL database object, by default None.</span>
</span><span id="SearchMolecularFormulasLC-871"><a href="#SearchMolecularFormulasLC-871"><span class="linenos"> 871</span></a><span class="sd">    first_hit : bool, optional</span>
</span><span id="SearchMolecularFormulasLC-872"><a href="#SearchMolecularFormulasLC-872"><span class="linenos"> 872</span></a><span class="sd">        Flag to indicate whether to skip peaks that already have a molecular formula assigned, by default False.</span>
</span><span id="SearchMolecularFormulasLC-873"><a href="#SearchMolecularFormulasLC-873"><span class="linenos"> 873</span></a><span class="sd">    find_isotopologues : bool, optional</span>
</span><span id="SearchMolecularFormulasLC-874"><a href="#SearchMolecularFormulasLC-874"><span class="linenos"> 874</span></a><span class="sd">        Flag to indicate whether to find isotopologues, by default True.</span>
</span><span id="SearchMolecularFormulasLC-875"><a href="#SearchMolecularFormulasLC-875"><span class="linenos"> 875</span></a>
</span><span id="SearchMolecularFormulasLC-876"><a href="#SearchMolecularFormulasLC-876"><span class="linenos"> 876</span></a><span class="sd">    Methods</span>
</span><span id="SearchMolecularFormulasLC-877"><a href="#SearchMolecularFormulasLC-877"><span class="linenos"> 877</span></a><span class="sd">    -------</span>
</span><span id="SearchMolecularFormulasLC-878"><a href="#SearchMolecularFormulasLC-878"><span class="linenos"> 878</span></a>
</span><span id="SearchMolecularFormulasLC-879"><a href="#SearchMolecularFormulasLC-879"><span class="linenos"> 879</span></a><span class="sd">    * search_spectra_against_candidates().</span>
</span><span id="SearchMolecularFormulasLC-880"><a href="#SearchMolecularFormulasLC-880"><span class="linenos"> 880</span></a><span class="sd">        Search a list of mass spectra against a list of candidate formulas with a given ion type and charge.</span>
</span><span id="SearchMolecularFormulasLC-881"><a href="#SearchMolecularFormulasLC-881"><span class="linenos"> 881</span></a><span class="sd">    * bulk_run_molecular_formula_search().</span>
</span><span id="SearchMolecularFormulasLC-882"><a href="#SearchMolecularFormulasLC-882"><span class="linenos"> 882</span></a><span class="sd">        Run the molecular formula search on the given list of mass spectra.</span>
</span><span id="SearchMolecularFormulasLC-883"><a href="#SearchMolecularFormulasLC-883"><span class="linenos"> 883</span></a><span class="sd">        Pulls the settings from the LCMSBase object to set ion type and charge to search for. </span>
</span><span id="SearchMolecularFormulasLC-884"><a href="#SearchMolecularFormulasLC-884"><span class="linenos"> 884</span></a><span class="sd">    * run_mass_feature_search().</span>
</span><span id="SearchMolecularFormulasLC-885"><a href="#SearchMolecularFormulasLC-885"><span class="linenos"> 885</span></a><span class="sd">        Run the molecular formula search on mass features.</span>
</span><span id="SearchMolecularFormulasLC-886"><a href="#SearchMolecularFormulasLC-886"><span class="linenos"> 886</span></a><span class="sd">        Calls bulk_run_molecular_formula_search() with specified mass spectra and mass peaks.</span>
</span><span id="SearchMolecularFormulasLC-887"><a href="#SearchMolecularFormulasLC-887"><span class="linenos"> 887</span></a><span class="sd">    * run_untargeted_worker_ms1().</span>
</span><span id="SearchMolecularFormulasLC-888"><a href="#SearchMolecularFormulasLC-888"><span class="linenos"> 888</span></a><span class="sd">        Run untargeted molecular formula search on the ms1 mass spectrum.</span>
</span><span id="SearchMolecularFormulasLC-889"><a href="#SearchMolecularFormulasLC-889"><span class="linenos"> 889</span></a><span class="sd">        DEPRECATED: use run_mass_feature_search() or bulk_run_molecular_formula_search() instead.</span>
</span><span id="SearchMolecularFormulasLC-890"><a href="#SearchMolecularFormulasLC-890"><span class="linenos"> 890</span></a><span class="sd">    * run_target_worker_ms1().</span>
</span><span id="SearchMolecularFormulasLC-891"><a href="#SearchMolecularFormulasLC-891"><span class="linenos"> 891</span></a><span class="sd">        Run targeted molecular formula search on the ms1 mass spectrum.</span>
</span><span id="SearchMolecularFormulasLC-892"><a href="#SearchMolecularFormulasLC-892"><span class="linenos"> 892</span></a><span class="sd">        DEPRECATED: use run_mass_feature_search() or bulk_run_molecular_formula_search() instead.</span>
</span><span id="SearchMolecularFormulasLC-893"><a href="#SearchMolecularFormulasLC-893"><span class="linenos"> 893</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulasLC-894"><a href="#SearchMolecularFormulasLC-894"><span class="linenos"> 894</span></a>
</span><span id="SearchMolecularFormulasLC-895"><a href="#SearchMolecularFormulasLC-895"><span class="linenos"> 895</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lcms_obj</span><span class="p">,</span> <span class="n">sql_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">first_hit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">find_isotopologues</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="SearchMolecularFormulasLC-896"><a href="#SearchMolecularFormulasLC-896"><span class="linenos"> 896</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">first_hit</span> <span class="o">=</span> <span class="n">first_hit</span>
</span><span id="SearchMolecularFormulasLC-897"><a href="#SearchMolecularFormulasLC-897"><span class="linenos"> 897</span></a>
</span><span id="SearchMolecularFormulasLC-898"><a href="#SearchMolecularFormulasLC-898"><span class="linenos"> 898</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span> <span class="o">=</span> <span class="n">find_isotopologues</span>
</span><span id="SearchMolecularFormulasLC-899"><a href="#SearchMolecularFormulasLC-899"><span class="linenos"> 899</span></a>
</span><span id="SearchMolecularFormulasLC-900"><a href="#SearchMolecularFormulasLC-900"><span class="linenos"> 900</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span> <span class="o">=</span> <span class="n">lcms_obj</span>
</span><span id="SearchMolecularFormulasLC-901"><a href="#SearchMolecularFormulasLC-901"><span class="linenos"> 901</span></a>
</span><span id="SearchMolecularFormulasLC-902"><a href="#SearchMolecularFormulasLC-902"><span class="linenos"> 902</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sql_db</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC-903"><a href="#SearchMolecularFormulasLC-903"><span class="linenos"> 903</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span> <span class="o">=</span> <span class="n">MolForm_SQL</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC-904"><a href="#SearchMolecularFormulasLC-904"><span class="linenos"> 904</span></a>                <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="s1">&#39;ms1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">url_database</span>
</span><span id="SearchMolecularFormulasLC-905"><a href="#SearchMolecularFormulasLC-905"><span class="linenos"> 905</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-906"><a href="#SearchMolecularFormulasLC-906"><span class="linenos"> 906</span></a>
</span><span id="SearchMolecularFormulasLC-907"><a href="#SearchMolecularFormulasLC-907"><span class="linenos"> 907</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC-908"><a href="#SearchMolecularFormulasLC-908"><span class="linenos"> 908</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span> <span class="o">=</span> <span class="n">sql_db</span>
</span><span id="SearchMolecularFormulasLC-909"><a href="#SearchMolecularFormulasLC-909"><span class="linenos"> 909</span></a>
</span><span id="SearchMolecularFormulasLC-910"><a href="#SearchMolecularFormulasLC-910"><span class="linenos"> 910</span></a>    <span class="k">def</span> <span class="nf">search_spectra_against_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass_spectrum_list</span><span class="p">,</span> <span class="n">ms_peaks_list</span><span class="p">,</span> <span class="n">candidate_formulas</span><span class="p">,</span> <span class="n">ion_type</span><span class="p">,</span> <span class="n">ion_charge</span><span class="p">):</span>
</span><span id="SearchMolecularFormulasLC-911"><a href="#SearchMolecularFormulasLC-911"><span class="linenos"> 911</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Search a list of mass spectra against a list of candidate formulas with a given ion type and charge.</span>
</span><span id="SearchMolecularFormulasLC-912"><a href="#SearchMolecularFormulasLC-912"><span class="linenos"> 912</span></a>
</span><span id="SearchMolecularFormulasLC-913"><a href="#SearchMolecularFormulasLC-913"><span class="linenos"> 913</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulasLC-914"><a href="#SearchMolecularFormulasLC-914"><span class="linenos"> 914</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulasLC-915"><a href="#SearchMolecularFormulasLC-915"><span class="linenos"> 915</span></a><span class="sd">        mass_spectrum_list : list of MassSpectrum</span>
</span><span id="SearchMolecularFormulasLC-916"><a href="#SearchMolecularFormulasLC-916"><span class="linenos"> 916</span></a><span class="sd">            The list of mass spectra to perform the search on.</span>
</span><span id="SearchMolecularFormulasLC-917"><a href="#SearchMolecularFormulasLC-917"><span class="linenos"> 917</span></a><span class="sd">        ms_peaks_list : list of lists of MSPeak objects</span>
</span><span id="SearchMolecularFormulasLC-918"><a href="#SearchMolecularFormulasLC-918"><span class="linenos"> 918</span></a><span class="sd">            The list of mass spectrum peaks to search within each mass spectrum.</span>
</span><span id="SearchMolecularFormulasLC-919"><a href="#SearchMolecularFormulasLC-919"><span class="linenos"> 919</span></a><span class="sd">        candidate_formulas : dict</span>
</span><span id="SearchMolecularFormulasLC-920"><a href="#SearchMolecularFormulasLC-920"><span class="linenos"> 920</span></a><span class="sd">            The candidate formulas.</span>
</span><span id="SearchMolecularFormulasLC-921"><a href="#SearchMolecularFormulasLC-921"><span class="linenos"> 921</span></a><span class="sd">        ion_type : str</span>
</span><span id="SearchMolecularFormulasLC-922"><a href="#SearchMolecularFormulasLC-922"><span class="linenos"> 922</span></a><span class="sd">            The ion type.</span>
</span><span id="SearchMolecularFormulasLC-923"><a href="#SearchMolecularFormulasLC-923"><span class="linenos"> 923</span></a><span class="sd">        ion_charge : int</span>
</span><span id="SearchMolecularFormulasLC-924"><a href="#SearchMolecularFormulasLC-924"><span class="linenos"> 924</span></a><span class="sd">            The ion charge, either 1 or -1.</span>
</span><span id="SearchMolecularFormulasLC-925"><a href="#SearchMolecularFormulasLC-925"><span class="linenos"> 925</span></a>
</span><span id="SearchMolecularFormulasLC-926"><a href="#SearchMolecularFormulasLC-926"><span class="linenos"> 926</span></a><span class="sd">        Notes</span>
</span><span id="SearchMolecularFormulasLC-927"><a href="#SearchMolecularFormulasLC-927"><span class="linenos"> 927</span></a><span class="sd">        -----</span>
</span><span id="SearchMolecularFormulasLC-928"><a href="#SearchMolecularFormulasLC-928"><span class="linenos"> 928</span></a><span class="sd">        This function is designed to be used with the bulk_run_molecular_formula_search function.</span>
</span><span id="SearchMolecularFormulasLC-929"><a href="#SearchMolecularFormulasLC-929"><span class="linenos"> 929</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulasLC-930"><a href="#SearchMolecularFormulasLC-930"><span class="linenos"> 930</span></a>        <span class="k">for</span> <span class="n">mass_spectrum</span><span class="p">,</span> <span class="n">ms_peaks</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mass_spectrum_list</span><span class="p">,</span> <span class="n">ms_peaks_list</span><span class="p">):</span>
</span><span id="SearchMolecularFormulasLC-931"><a href="#SearchMolecularFormulasLC-931"><span class="linenos"> 931</span></a>            <span class="n">single_ms_search</span> <span class="o">=</span> <span class="n">SearchMolecularFormulas</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC-932"><a href="#SearchMolecularFormulasLC-932"><span class="linenos"> 932</span></a>                <span class="n">mass_spectrum</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-933"><a href="#SearchMolecularFormulasLC-933"><span class="linenos"> 933</span></a>                <span class="n">sql_db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-934"><a href="#SearchMolecularFormulasLC-934"><span class="linenos"> 934</span></a>                <span class="n">first_hit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">first_hit</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-935"><a href="#SearchMolecularFormulasLC-935"><span class="linenos"> 935</span></a>                <span class="n">find_isotopologues</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-936"><a href="#SearchMolecularFormulasLC-936"><span class="linenos"> 936</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-937"><a href="#SearchMolecularFormulasLC-937"><span class="linenos"> 937</span></a>            <span class="n">single_ms_search</span><span class="o">.</span><span class="n">run_search</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC-938"><a href="#SearchMolecularFormulasLC-938"><span class="linenos"> 938</span></a>                <span class="n">ms_peaks</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-939"><a href="#SearchMolecularFormulasLC-939"><span class="linenos"> 939</span></a>                <span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-940"><a href="#SearchMolecularFormulasLC-940"><span class="linenos"> 940</span></a>                <span class="n">mass_spectrum</span><span class="o">.</span><span class="n">min_abundance</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-941"><a href="#SearchMolecularFormulasLC-941"><span class="linenos"> 941</span></a>                <span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-942"><a href="#SearchMolecularFormulasLC-942"><span class="linenos"> 942</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-943"><a href="#SearchMolecularFormulasLC-943"><span class="linenos"> 943</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-944"><a href="#SearchMolecularFormulasLC-944"><span class="linenos"> 944</span></a>
</span><span id="SearchMolecularFormulasLC-945"><a href="#SearchMolecularFormulasLC-945"><span class="linenos"> 945</span></a>    <span class="k">def</span> <span class="nf">bulk_run_molecular_formula_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass_spectrum_list</span><span class="p">,</span> <span class="n">ms_peaks_list</span><span class="p">,</span> <span class="n">mass_spectrum_setting_key</span><span class="o">=</span><span class="s1">&#39;ms1&#39;</span><span class="p">):</span>
</span><span id="SearchMolecularFormulasLC-946"><a href="#SearchMolecularFormulasLC-946"><span class="linenos"> 946</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the molecular formula search on the given list of mass spectra</span>
</span><span id="SearchMolecularFormulasLC-947"><a href="#SearchMolecularFormulasLC-947"><span class="linenos"> 947</span></a>
</span><span id="SearchMolecularFormulasLC-948"><a href="#SearchMolecularFormulasLC-948"><span class="linenos"> 948</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulasLC-949"><a href="#SearchMolecularFormulasLC-949"><span class="linenos"> 949</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulasLC-950"><a href="#SearchMolecularFormulasLC-950"><span class="linenos"> 950</span></a><span class="sd">        mass_spectrum_list : list of MassSpectrum</span>
</span><span id="SearchMolecularFormulasLC-951"><a href="#SearchMolecularFormulasLC-951"><span class="linenos"> 951</span></a><span class="sd">            The list of mass spectra to search.</span>
</span><span id="SearchMolecularFormulasLC-952"><a href="#SearchMolecularFormulasLC-952"><span class="linenos"> 952</span></a><span class="sd">        ms_peaks_list : list of lists of MSPeak objects </span>
</span><span id="SearchMolecularFormulasLC-953"><a href="#SearchMolecularFormulasLC-953"><span class="linenos"> 953</span></a><span class="sd">            The mass peaks to perform molecular formula search within each mass spectrum</span>
</span><span id="SearchMolecularFormulasLC-954"><a href="#SearchMolecularFormulasLC-954"><span class="linenos"> 954</span></a><span class="sd">        mass_spectrum_setting_key : str, optional</span>
</span><span id="SearchMolecularFormulasLC-955"><a href="#SearchMolecularFormulasLC-955"><span class="linenos"> 955</span></a><span class="sd">            The mass spectrum setting key, by default &#39;ms1&#39;.</span>
</span><span id="SearchMolecularFormulasLC-956"><a href="#SearchMolecularFormulasLC-956"><span class="linenos"> 956</span></a><span class="sd">            This is used to get the appropriate molecular search settings from the LCMSBase object</span>
</span><span id="SearchMolecularFormulasLC-957"><a href="#SearchMolecularFormulasLC-957"><span class="linenos"> 957</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulasLC-958"><a href="#SearchMolecularFormulasLC-958"><span class="linenos"> 958</span></a>        <span class="c1"># Set min_abundance and nominal_mzs</span>
</span><span id="SearchMolecularFormulasLC-959"><a href="#SearchMolecularFormulasLC-959"><span class="linenos"> 959</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">polarity</span> <span class="o">==</span> <span class="s2">&quot;positive&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC-960"><a href="#SearchMolecularFormulasLC-960"><span class="linenos"> 960</span></a>            <span class="n">ion_charge</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="SearchMolecularFormulasLC-961"><a href="#SearchMolecularFormulasLC-961"><span class="linenos"> 961</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">polarity</span> <span class="o">==</span> <span class="s2">&quot;negative&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC-962"><a href="#SearchMolecularFormulasLC-962"><span class="linenos"> 962</span></a>            <span class="n">ion_charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="SearchMolecularFormulasLC-963"><a href="#SearchMolecularFormulasLC-963"><span class="linenos"> 963</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC-964"><a href="#SearchMolecularFormulasLC-964"><span class="linenos"> 964</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Polarity must be either &#39;positive&#39; or &#39;negative&#39;&quot;</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-965"><a href="#SearchMolecularFormulasLC-965"><span class="linenos"> 965</span></a>        
</span><span id="SearchMolecularFormulasLC-966"><a href="#SearchMolecularFormulasLC-966"><span class="linenos"> 966</span></a>        <span class="c1"># Check that the length of the mass spectrum list and the ms_peaks list are the same</span>
</span><span id="SearchMolecularFormulasLC-967"><a href="#SearchMolecularFormulasLC-967"><span class="linenos"> 967</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mass_spectrum_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms_peaks_list</span><span class="p">):</span>
</span><span id="SearchMolecularFormulasLC-968"><a href="#SearchMolecularFormulasLC-968"><span class="linenos"> 968</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The length of the mass spectrum list and the ms_peaks list must be the same&quot;</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-969"><a href="#SearchMolecularFormulasLC-969"><span class="linenos"> 969</span></a>        
</span><span id="SearchMolecularFormulasLC-970"><a href="#SearchMolecularFormulasLC-970"><span class="linenos"> 970</span></a>        <span class="n">nominal_mzs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">nominal_mz</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mass_spectrum_list</span><span class="p">]</span>
</span><span id="SearchMolecularFormulasLC-971"><a href="#SearchMolecularFormulasLC-971"><span class="linenos"> 971</span></a>        <span class="n">nominal_mzs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">nominal_mzs</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]))</span>
</span><span id="SearchMolecularFormulasLC-972"><a href="#SearchMolecularFormulasLC-972"><span class="linenos"> 972</span></a>        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">verbose_processing</span> 
</span><span id="SearchMolecularFormulasLC-973"><a href="#SearchMolecularFormulasLC-973"><span class="linenos"> 973</span></a>
</span><span id="SearchMolecularFormulasLC-974"><a href="#SearchMolecularFormulasLC-974"><span class="linenos"> 974</span></a>        <span class="c1"># reset average error, only relevant if average mass error method is being used</span>
</span><span id="SearchMolecularFormulasLC-975"><a href="#SearchMolecularFormulasLC-975"><span class="linenos"> 975</span></a>        <span class="n">SearchMolecularFormulaWorker</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC-976"><a href="#SearchMolecularFormulasLC-976"><span class="linenos"> 976</span></a>            <span class="n">find_isotopologues</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span>
</span><span id="SearchMolecularFormulasLC-977"><a href="#SearchMolecularFormulasLC-977"><span class="linenos"> 977</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">reset_error</span><span class="p">(</span><span class="n">mass_spectrum_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="SearchMolecularFormulasLC-978"><a href="#SearchMolecularFormulasLC-978"><span class="linenos"> 978</span></a>
</span><span id="SearchMolecularFormulasLC-979"><a href="#SearchMolecularFormulasLC-979"><span class="linenos"> 979</span></a>        <span class="c1"># check database for all possible molecular formula combinations based on the setting passed to self.mass_spectrum_obj.molecular_search_settings</span>
</span><span id="SearchMolecularFormulasLC-980"><a href="#SearchMolecularFormulasLC-980"><span class="linenos"> 980</span></a>        <span class="n">classes</span> <span class="o">=</span> <span class="n">MolecularCombinations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="p">)</span><span class="o">.</span><span class="n">runworker</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC-981"><a href="#SearchMolecularFormulasLC-981"><span class="linenos"> 981</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-982"><a href="#SearchMolecularFormulasLC-982"><span class="linenos"> 982</span></a>            <span class="n">print_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="SearchMolecularFormulasLC-983"><a href="#SearchMolecularFormulasLC-983"><span class="linenos"> 983</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-984"><a href="#SearchMolecularFormulasLC-984"><span class="linenos"> 984</span></a>        
</span><span id="SearchMolecularFormulasLC-985"><a href="#SearchMolecularFormulasLC-985"><span class="linenos"> 985</span></a>        <span class="c1"># split the database load to not blowout the memory</span>
</span><span id="SearchMolecularFormulasLC-986"><a href="#SearchMolecularFormulasLC-986"><span class="linenos"> 986</span></a>        <span class="k">for</span> <span class="n">classe_chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC-987"><a href="#SearchMolecularFormulasLC-987"><span class="linenos"> 987</span></a>            <span class="n">classes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">db_chunk_size</span>
</span><span id="SearchMolecularFormulasLC-988"><a href="#SearchMolecularFormulasLC-988"><span class="linenos"> 988</span></a>        <span class="p">):</span>
</span><span id="SearchMolecularFormulasLC-989"><a href="#SearchMolecularFormulasLC-989"><span class="linenos"> 989</span></a>            <span class="n">classes_str_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">class_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">class_tuple</span> <span class="ow">in</span> <span class="n">classe_chunk</span><span class="p">]</span>
</span><span id="SearchMolecularFormulasLC-990"><a href="#SearchMolecularFormulasLC-990"><span class="linenos"> 990</span></a>
</span><span id="SearchMolecularFormulasLC-991"><a href="#SearchMolecularFormulasLC-991"><span class="linenos"> 991</span></a>            <span class="c1"># load the molecular formula objs binned by ion type and heteroatoms classes, {ion type:{classe:[list_formula]}}</span>
</span><span id="SearchMolecularFormulasLC-992"><a href="#SearchMolecularFormulasLC-992"><span class="linenos"> 992</span></a>            <span class="c1"># for adduct ion type a third key is added {atoms:{ion type:{classe:[list_formula]}}}</span>
</span><span id="SearchMolecularFormulasLC-993"><a href="#SearchMolecularFormulasLC-993"><span class="linenos"> 993</span></a>            <span class="n">dict_res</span> <span class="o">=</span> <span class="n">SearchMolecularFormulas</span><span class="o">.</span><span class="n">database_to_dict</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC-994"><a href="#SearchMolecularFormulasLC-994"><span class="linenos"> 994</span></a>                <span class="n">classes_str_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-995"><a href="#SearchMolecularFormulasLC-995"><span class="linenos"> 995</span></a>                <span class="n">nominal_mzs</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-996"><a href="#SearchMolecularFormulasLC-996"><span class="linenos"> 996</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-997"><a href="#SearchMolecularFormulasLC-997"><span class="linenos"> 997</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-998"><a href="#SearchMolecularFormulasLC-998"><span class="linenos"> 998</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-999"><a href="#SearchMolecularFormulasLC-999"><span class="linenos"> 999</span></a>
</span><span id="SearchMolecularFormulasLC-1000"><a href="#SearchMolecularFormulasLC-1000"><span class="linenos">1000</span></a>            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">classe_chunk</span><span class="p">,</span> <span class="n">disable</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-1001"><a href="#SearchMolecularFormulasLC-1001"><span class="linenos">1001</span></a>            <span class="k">for</span> <span class="n">classe_tuple</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC-1002"><a href="#SearchMolecularFormulasLC-1002"><span class="linenos">1002</span></a>                <span class="c1"># class string is a json serialized dict</span>
</span><span id="SearchMolecularFormulasLC-1003"><a href="#SearchMolecularFormulasLC-1003"><span class="linenos">1003</span></a>                <span class="n">classe_str</span> <span class="o">=</span> <span class="n">classe_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SearchMolecularFormulasLC-1004"><a href="#SearchMolecularFormulasLC-1004"><span class="linenos">1004</span></a>
</span><span id="SearchMolecularFormulasLC-1005"><a href="#SearchMolecularFormulasLC-1005"><span class="linenos">1005</span></a>                <span class="c1"># Perform search for (de)protonated ion type</span>
</span><span id="SearchMolecularFormulasLC-1006"><a href="#SearchMolecularFormulasLC-1006"><span class="linenos">1006</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">isProtonated</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC-1007"><a href="#SearchMolecularFormulasLC-1007"><span class="linenos">1007</span></a>                    <span class="n">ion_type</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">protonated_de_ion</span>
</span><span id="SearchMolecularFormulasLC-1008"><a href="#SearchMolecularFormulasLC-1008"><span class="linenos">1008</span></a>
</span><span id="SearchMolecularFormulasLC-1009"><a href="#SearchMolecularFormulasLC-1009"><span class="linenos">1009</span></a>                    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description_str</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC-1010"><a href="#SearchMolecularFormulasLC-1010"><span class="linenos">1010</span></a>                        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Started molecular formula search for class </span><span class="si">%s</span><span class="s2">, (de)protonated &quot;</span>
</span><span id="SearchMolecularFormulasLC-1011"><a href="#SearchMolecularFormulasLC-1011"><span class="linenos">1011</span></a>                        <span class="o">%</span> <span class="n">classe_str</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1012"><a href="#SearchMolecularFormulasLC-1012"><span class="linenos">1012</span></a>                        <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1013"><a href="#SearchMolecularFormulasLC-1013"><span class="linenos">1013</span></a>                    <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-1014"><a href="#SearchMolecularFormulasLC-1014"><span class="linenos">1014</span></a>
</span><span id="SearchMolecularFormulasLC-1015"><a href="#SearchMolecularFormulasLC-1015"><span class="linenos">1015</span></a>                    <span class="n">candidate_formulas</span> <span class="o">=</span> <span class="n">dict_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ion_type</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">classe_str</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-1016"><a href="#SearchMolecularFormulasLC-1016"><span class="linenos">1016</span></a>
</span><span id="SearchMolecularFormulasLC-1017"><a href="#SearchMolecularFormulasLC-1017"><span class="linenos">1017</span></a>                    <span class="k">if</span> <span class="n">candidate_formulas</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC-1018"><a href="#SearchMolecularFormulasLC-1018"><span class="linenos">1018</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">search_spectra_against_candidates</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC-1019"><a href="#SearchMolecularFormulasLC-1019"><span class="linenos">1019</span></a>                            <span class="n">mass_spectrum_list</span><span class="o">=</span><span class="n">mass_spectrum_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1020"><a href="#SearchMolecularFormulasLC-1020"><span class="linenos">1020</span></a>                            <span class="n">ms_peaks_list</span><span class="o">=</span><span class="n">ms_peaks_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1021"><a href="#SearchMolecularFormulasLC-1021"><span class="linenos">1021</span></a>                            <span class="n">candidate_formulas</span><span class="o">=</span><span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1022"><a href="#SearchMolecularFormulasLC-1022"><span class="linenos">1022</span></a>                            <span class="n">ion_type</span><span class="o">=</span><span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1023"><a href="#SearchMolecularFormulasLC-1023"><span class="linenos">1023</span></a>                            <span class="n">ion_charge</span><span class="o">=</span><span class="n">ion_charge</span>
</span><span id="SearchMolecularFormulasLC-1024"><a href="#SearchMolecularFormulasLC-1024"><span class="linenos">1024</span></a>                        <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-1025"><a href="#SearchMolecularFormulasLC-1025"><span class="linenos">1025</span></a>
</span><span id="SearchMolecularFormulasLC-1026"><a href="#SearchMolecularFormulasLC-1026"><span class="linenos">1026</span></a>
</span><span id="SearchMolecularFormulasLC-1027"><a href="#SearchMolecularFormulasLC-1027"><span class="linenos">1027</span></a>                <span class="c1"># Perform search for radical ion type</span>
</span><span id="SearchMolecularFormulasLC-1028"><a href="#SearchMolecularFormulasLC-1028"><span class="linenos">1028</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">isRadical</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC-1029"><a href="#SearchMolecularFormulasLC-1029"><span class="linenos">1029</span></a>                    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description_str</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC-1030"><a href="#SearchMolecularFormulasLC-1030"><span class="linenos">1030</span></a>                        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Started molecular formula search for class </span><span class="si">%s</span><span class="s2">, radical &quot;</span>
</span><span id="SearchMolecularFormulasLC-1031"><a href="#SearchMolecularFormulasLC-1031"><span class="linenos">1031</span></a>                        <span class="o">%</span> <span class="n">classe_str</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1032"><a href="#SearchMolecularFormulasLC-1032"><span class="linenos">1032</span></a>                        <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1033"><a href="#SearchMolecularFormulasLC-1033"><span class="linenos">1033</span></a>                    <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-1034"><a href="#SearchMolecularFormulasLC-1034"><span class="linenos">1034</span></a>
</span><span id="SearchMolecularFormulasLC-1035"><a href="#SearchMolecularFormulasLC-1035"><span class="linenos">1035</span></a>                    <span class="n">ion_type</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">radical_ion</span>
</span><span id="SearchMolecularFormulasLC-1036"><a href="#SearchMolecularFormulasLC-1036"><span class="linenos">1036</span></a>
</span><span id="SearchMolecularFormulasLC-1037"><a href="#SearchMolecularFormulasLC-1037"><span class="linenos">1037</span></a>                    <span class="n">candidate_formulas</span> <span class="o">=</span> <span class="n">dict_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ion_type</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">classe_str</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-1038"><a href="#SearchMolecularFormulasLC-1038"><span class="linenos">1038</span></a>
</span><span id="SearchMolecularFormulasLC-1039"><a href="#SearchMolecularFormulasLC-1039"><span class="linenos">1039</span></a>                    <span class="k">if</span> <span class="n">candidate_formulas</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC-1040"><a href="#SearchMolecularFormulasLC-1040"><span class="linenos">1040</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">search_spectra_against_candidates</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC-1041"><a href="#SearchMolecularFormulasLC-1041"><span class="linenos">1041</span></a>                            <span class="n">mass_spectrum_list</span><span class="o">=</span><span class="n">mass_spectrum_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1042"><a href="#SearchMolecularFormulasLC-1042"><span class="linenos">1042</span></a>                            <span class="n">ms_peaks_list</span><span class="o">=</span><span class="n">ms_peaks_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1043"><a href="#SearchMolecularFormulasLC-1043"><span class="linenos">1043</span></a>                            <span class="n">candidate_formulas</span><span class="o">=</span><span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1044"><a href="#SearchMolecularFormulasLC-1044"><span class="linenos">1044</span></a>                            <span class="n">ion_type</span><span class="o">=</span><span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1045"><a href="#SearchMolecularFormulasLC-1045"><span class="linenos">1045</span></a>                            <span class="n">ion_charge</span><span class="o">=</span><span class="n">ion_charge</span>
</span><span id="SearchMolecularFormulasLC-1046"><a href="#SearchMolecularFormulasLC-1046"><span class="linenos">1046</span></a>                        <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-1047"><a href="#SearchMolecularFormulasLC-1047"><span class="linenos">1047</span></a>
</span><span id="SearchMolecularFormulasLC-1048"><a href="#SearchMolecularFormulasLC-1048"><span class="linenos">1048</span></a>                <span class="c1"># Perform search for adduct ion type</span>
</span><span id="SearchMolecularFormulasLC-1049"><a href="#SearchMolecularFormulasLC-1049"><span class="linenos">1049</span></a>                <span class="c1"># looks for adduct, used_atom_valences should be 0</span>
</span><span id="SearchMolecularFormulasLC-1050"><a href="#SearchMolecularFormulasLC-1050"><span class="linenos">1050</span></a>                <span class="c1"># this code does not support H exchance by halogen atoms</span>
</span><span id="SearchMolecularFormulasLC-1051"><a href="#SearchMolecularFormulasLC-1051"><span class="linenos">1051</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">isAdduct</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC-1052"><a href="#SearchMolecularFormulasLC-1052"><span class="linenos">1052</span></a>                    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description_str</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC-1053"><a href="#SearchMolecularFormulasLC-1053"><span class="linenos">1053</span></a>                        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Started molecular formula search for class </span><span class="si">%s</span><span class="s2">, adduct &quot;</span>
</span><span id="SearchMolecularFormulasLC-1054"><a href="#SearchMolecularFormulasLC-1054"><span class="linenos">1054</span></a>                        <span class="o">%</span> <span class="n">classe_str</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1055"><a href="#SearchMolecularFormulasLC-1055"><span class="linenos">1055</span></a>                        <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1056"><a href="#SearchMolecularFormulasLC-1056"><span class="linenos">1056</span></a>                    <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-1057"><a href="#SearchMolecularFormulasLC-1057"><span class="linenos">1057</span></a>
</span><span id="SearchMolecularFormulasLC-1058"><a href="#SearchMolecularFormulasLC-1058"><span class="linenos">1058</span></a>                    <span class="n">ion_type</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">adduct_ion</span>
</span><span id="SearchMolecularFormulasLC-1059"><a href="#SearchMolecularFormulasLC-1059"><span class="linenos">1059</span></a>                    <span class="n">dict_atoms_formulas</span> <span class="o">=</span> <span class="n">dict_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ion_type</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-1060"><a href="#SearchMolecularFormulasLC-1060"><span class="linenos">1060</span></a>
</span><span id="SearchMolecularFormulasLC-1061"><a href="#SearchMolecularFormulasLC-1061"><span class="linenos">1061</span></a>                    <span class="k">for</span> <span class="n">adduct_atom</span><span class="p">,</span> <span class="n">dict_by_class</span> <span class="ow">in</span> <span class="n">dict_atoms_formulas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="SearchMolecularFormulasLC-1062"><a href="#SearchMolecularFormulasLC-1062"><span class="linenos">1062</span></a>                        <span class="n">candidate_formulas</span> <span class="o">=</span> <span class="n">dict_by_class</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">classe_str</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-1063"><a href="#SearchMolecularFormulasLC-1063"><span class="linenos">1063</span></a>
</span><span id="SearchMolecularFormulasLC-1064"><a href="#SearchMolecularFormulasLC-1064"><span class="linenos">1064</span></a>                        <span class="k">if</span> <span class="n">candidate_formulas</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC-1065"><a href="#SearchMolecularFormulasLC-1065"><span class="linenos">1065</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">search_spectra_against_candidates</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC-1066"><a href="#SearchMolecularFormulasLC-1066"><span class="linenos">1066</span></a>                                <span class="n">mass_spectrum_list</span><span class="o">=</span><span class="n">mass_spectrum_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1067"><a href="#SearchMolecularFormulasLC-1067"><span class="linenos">1067</span></a>                                <span class="n">ms_peaks_list</span><span class="o">=</span><span class="n">ms_peaks_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1068"><a href="#SearchMolecularFormulasLC-1068"><span class="linenos">1068</span></a>                                <span class="n">candidate_formulas</span><span class="o">=</span><span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1069"><a href="#SearchMolecularFormulasLC-1069"><span class="linenos">1069</span></a>                                <span class="n">ion_type</span><span class="o">=</span><span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC-1070"><a href="#SearchMolecularFormulasLC-1070"><span class="linenos">1070</span></a>                                <span class="n">ion_charge</span><span class="o">=</span><span class="n">ion_charge</span>
</span><span id="SearchMolecularFormulasLC-1071"><a href="#SearchMolecularFormulasLC-1071"><span class="linenos">1071</span></a>                            <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-1072"><a href="#SearchMolecularFormulasLC-1072"><span class="linenos">1072</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="SearchMolecularFormulasLC-1073"><a href="#SearchMolecularFormulasLC-1073"><span class="linenos">1073</span></a>        
</span><span id="SearchMolecularFormulasLC-1074"><a href="#SearchMolecularFormulasLC-1074"><span class="linenos">1074</span></a>    <span class="k">def</span> <span class="nf">run_mass_feature_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SearchMolecularFormulasLC-1075"><a href="#SearchMolecularFormulasLC-1075"><span class="linenos">1075</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the molecular formula search on the mass features.</span>
</span><span id="SearchMolecularFormulasLC-1076"><a href="#SearchMolecularFormulasLC-1076"><span class="linenos">1076</span></a><span class="sd">        </span>
</span><span id="SearchMolecularFormulasLC-1077"><a href="#SearchMolecularFormulasLC-1077"><span class="linenos">1077</span></a><span class="sd">        Calls bulk_run_molecular_formula_search() with specified mass spectra and mass peaks.</span>
</span><span id="SearchMolecularFormulasLC-1078"><a href="#SearchMolecularFormulasLC-1078"><span class="linenos">1078</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulasLC-1079"><a href="#SearchMolecularFormulasLC-1079"><span class="linenos">1079</span></a>        <span class="n">mass_features_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span>
</span><span id="SearchMolecularFormulasLC-1080"><a href="#SearchMolecularFormulasLC-1080"><span class="linenos">1080</span></a>
</span><span id="SearchMolecularFormulasLC-1081"><a href="#SearchMolecularFormulasLC-1081"><span class="linenos">1081</span></a>        <span class="c1"># Get the list of mass spectrum (and peaks to search with each mass spectrum) for all mass features</span>
</span><span id="SearchMolecularFormulasLC-1082"><a href="#SearchMolecularFormulasLC-1082"><span class="linenos">1082</span></a>        <span class="n">scan_list</span> <span class="o">=</span> <span class="n">mass_features_df</span><span class="o">.</span><span class="n">apex_scan</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="SearchMolecularFormulasLC-1083"><a href="#SearchMolecularFormulasLC-1083"><span class="linenos">1083</span></a>        <span class="n">mass_spectrum_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">_ms</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scan_list</span><span class="p">]</span>
</span><span id="SearchMolecularFormulasLC-1084"><a href="#SearchMolecularFormulasLC-1084"><span class="linenos">1084</span></a>        <span class="n">ms_peaks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SearchMolecularFormulasLC-1085"><a href="#SearchMolecularFormulasLC-1085"><span class="linenos">1085</span></a>        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scan_list</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC-1086"><a href="#SearchMolecularFormulasLC-1086"><span class="linenos">1086</span></a>            <span class="n">mf_df_scan</span> <span class="o">=</span> <span class="n">mass_features_df</span><span class="p">[</span><span class="n">mass_features_df</span><span class="o">.</span><span class="n">apex_scan</span> <span class="o">==</span> <span class="n">scan</span><span class="p">]</span>
</span><span id="SearchMolecularFormulasLC-1087"><a href="#SearchMolecularFormulasLC-1087"><span class="linenos">1087</span></a>            <span class="n">peaks_to_search</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SearchMolecularFormulasLC-1088"><a href="#SearchMolecularFormulasLC-1088"><span class="linenos">1088</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">ms1_peak</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mf_df_scan</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="SearchMolecularFormulasLC-1089"><a href="#SearchMolecularFormulasLC-1089"><span class="linenos">1089</span></a>            <span class="p">]</span>
</span><span id="SearchMolecularFormulasLC-1090"><a href="#SearchMolecularFormulasLC-1090"><span class="linenos">1090</span></a>            <span class="n">ms_peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peaks_to_search</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-1091"><a href="#SearchMolecularFormulasLC-1091"><span class="linenos">1091</span></a>        
</span><span id="SearchMolecularFormulasLC-1092"><a href="#SearchMolecularFormulasLC-1092"><span class="linenos">1092</span></a>        <span class="c1"># Run the molecular formula search</span>
</span><span id="SearchMolecularFormulasLC-1093"><a href="#SearchMolecularFormulasLC-1093"><span class="linenos">1093</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_run_molecular_formula_search</span><span class="p">(</span><span class="n">mass_spectrum_list</span><span class="p">,</span> <span class="n">ms_peaks</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-1094"><a href="#SearchMolecularFormulasLC-1094"><span class="linenos">1094</span></a>    
</span><span id="SearchMolecularFormulasLC-1095"><a href="#SearchMolecularFormulasLC-1095"><span class="linenos">1095</span></a>    <span class="k">def</span> <span class="nf">run_untargeted_worker_ms1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SearchMolecularFormulasLC-1096"><a href="#SearchMolecularFormulasLC-1096"><span class="linenos">1096</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run untargeted molecular formula search on the ms1 mass spectrum.&quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulasLC-1097"><a href="#SearchMolecularFormulasLC-1097"><span class="linenos">1097</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;run_untargeted_worker_ms1 search is not implemented in CoreMS 3.0 and greater&quot;</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC-1098"><a href="#SearchMolecularFormulasLC-1098"><span class="linenos">1098</span></a>
</span><span id="SearchMolecularFormulasLC-1099"><a href="#SearchMolecularFormulasLC-1099"><span class="linenos">1099</span></a>    <span class="k">def</span> <span class="nf">run_target_worker_ms1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SearchMolecularFormulasLC-1100"><a href="#SearchMolecularFormulasLC-1100"><span class="linenos">1100</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run targeted molecular formula search on the ms1 mass spectrum.&quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulasLC-1101"><a href="#SearchMolecularFormulasLC-1101"><span class="linenos">1101</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;run_target_worker_ms1 formula search is not yet implemented in CoreMS 3.0 and greater&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Class for searching molecular formulas in a LC object.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>lcms_obj</strong> (LCMSBase):
The LCMSBase object.</li>
<li><strong>sql_db</strong> (MolForm_SQL, optional):
The SQL database object, by default None.</li>
<li><strong>first_hit</strong> (bool, optional):
Flag to indicate whether to skip peaks that already have a molecular formula assigned, by default False.</li>
<li><strong>find_isotopologues</strong> (bool, optional):
Flag to indicate whether to find isotopologues, by default True.</li>
</ul>

<h6 id="methods">Methods</h6>

<ul>
<li>search_spectra_against_candidates().
Search a list of mass spectra against a list of candidate formulas with a given ion type and charge.</li>
<li>bulk_run_molecular_formula_search().
Run the molecular formula search on the given list of mass spectra.
Pulls the settings from the LCMSBase object to set ion type and charge to search for. </li>
<li>run_mass_feature_search().
Run the molecular formula search on mass features.
Calls bulk_run_molecular_formula_search() with specified mass spectra and mass peaks.</li>
<li>run_untargeted_worker_ms1().
Run untargeted molecular formula search on the ms1 mass spectrum.
DEPRECATED: use run_mass_feature_search() or bulk_run_molecular_formula_search() instead.</li>
<li>run_target_worker_ms1().
Run targeted molecular formula search on the ms1 mass spectrum.
DEPRECATED: use run_mass_feature_search() or bulk_run_molecular_formula_search() instead.</li>
</ul>
</div>


                            <div id="SearchMolecularFormulasLC.__init__" class="classattr">
                                        <input id="SearchMolecularFormulasLC.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SearchMolecularFormulasLC</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">lcms_obj</span>, </span><span class="param"><span class="n">sql_db</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">first_hit</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="n">find_isotopologues</span><span class="o">=</span><span class="kc">True</span></span>)</span>

                <label class="view-source-button" for="SearchMolecularFormulasLC.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulasLC.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulasLC.__init__-895"><a href="#SearchMolecularFormulasLC.__init__-895"><span class="linenos">895</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lcms_obj</span><span class="p">,</span> <span class="n">sql_db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">first_hit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">find_isotopologues</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="SearchMolecularFormulasLC.__init__-896"><a href="#SearchMolecularFormulasLC.__init__-896"><span class="linenos">896</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">first_hit</span> <span class="o">=</span> <span class="n">first_hit</span>
</span><span id="SearchMolecularFormulasLC.__init__-897"><a href="#SearchMolecularFormulasLC.__init__-897"><span class="linenos">897</span></a>
</span><span id="SearchMolecularFormulasLC.__init__-898"><a href="#SearchMolecularFormulasLC.__init__-898"><span class="linenos">898</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span> <span class="o">=</span> <span class="n">find_isotopologues</span>
</span><span id="SearchMolecularFormulasLC.__init__-899"><a href="#SearchMolecularFormulasLC.__init__-899"><span class="linenos">899</span></a>
</span><span id="SearchMolecularFormulasLC.__init__-900"><a href="#SearchMolecularFormulasLC.__init__-900"><span class="linenos">900</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span> <span class="o">=</span> <span class="n">lcms_obj</span>
</span><span id="SearchMolecularFormulasLC.__init__-901"><a href="#SearchMolecularFormulasLC.__init__-901"><span class="linenos">901</span></a>
</span><span id="SearchMolecularFormulasLC.__init__-902"><a href="#SearchMolecularFormulasLC.__init__-902"><span class="linenos">902</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">sql_db</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC.__init__-903"><a href="#SearchMolecularFormulasLC.__init__-903"><span class="linenos">903</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span> <span class="o">=</span> <span class="n">MolForm_SQL</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC.__init__-904"><a href="#SearchMolecularFormulasLC.__init__-904"><span class="linenos">904</span></a>                <span class="n">url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="s1">&#39;ms1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">url_database</span>
</span><span id="SearchMolecularFormulasLC.__init__-905"><a href="#SearchMolecularFormulasLC.__init__-905"><span class="linenos">905</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.__init__-906"><a href="#SearchMolecularFormulasLC.__init__-906"><span class="linenos">906</span></a>
</span><span id="SearchMolecularFormulasLC.__init__-907"><a href="#SearchMolecularFormulasLC.__init__-907"><span class="linenos">907</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC.__init__-908"><a href="#SearchMolecularFormulasLC.__init__-908"><span class="linenos">908</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span> <span class="o">=</span> <span class="n">sql_db</span>
</span></pre></div>


    

                            </div>
                            <div id="SearchMolecularFormulasLC.first_hit" class="classattr">
                                <div class="attr variable">
            <span class="name">first_hit</span>

        
    </div>
    <a class="headerlink" href="#SearchMolecularFormulasLC.first_hit"></a>
    
    

                            </div>
                            <div id="SearchMolecularFormulasLC.find_isotopologues" class="classattr">
                                <div class="attr variable">
            <span class="name">find_isotopologues</span>

        
    </div>
    <a class="headerlink" href="#SearchMolecularFormulasLC.find_isotopologues"></a>
    
    

                            </div>
                            <div id="SearchMolecularFormulasLC.lcms_obj" class="classattr">
                                <div class="attr variable">
            <span class="name">lcms_obj</span>

        
    </div>
    <a class="headerlink" href="#SearchMolecularFormulasLC.lcms_obj"></a>
    
    

                            </div>
                            <div id="SearchMolecularFormulasLC.search_spectra_against_candidates" class="classattr">
                                        <input id="SearchMolecularFormulasLC.search_spectra_against_candidates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">search_spectra_against_candidates</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">mass_spectrum_list</span>,</span><span class="param">	<span class="n">ms_peaks_list</span>,</span><span class="param">	<span class="n">candidate_formulas</span>,</span><span class="param">	<span class="n">ion_type</span>,</span><span class="param">	<span class="n">ion_charge</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SearchMolecularFormulasLC.search_spectra_against_candidates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulasLC.search_spectra_against_candidates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-910"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-910"><span class="linenos">910</span></a>    <span class="k">def</span> <span class="nf">search_spectra_against_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass_spectrum_list</span><span class="p">,</span> <span class="n">ms_peaks_list</span><span class="p">,</span> <span class="n">candidate_formulas</span><span class="p">,</span> <span class="n">ion_type</span><span class="p">,</span> <span class="n">ion_charge</span><span class="p">):</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-911"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-911"><span class="linenos">911</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Search a list of mass spectra against a list of candidate formulas with a given ion type and charge.</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-912"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-912"><span class="linenos">912</span></a>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-913"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-913"><span class="linenos">913</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-914"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-914"><span class="linenos">914</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-915"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-915"><span class="linenos">915</span></a><span class="sd">        mass_spectrum_list : list of MassSpectrum</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-916"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-916"><span class="linenos">916</span></a><span class="sd">            The list of mass spectra to perform the search on.</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-917"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-917"><span class="linenos">917</span></a><span class="sd">        ms_peaks_list : list of lists of MSPeak objects</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-918"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-918"><span class="linenos">918</span></a><span class="sd">            The list of mass spectrum peaks to search within each mass spectrum.</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-919"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-919"><span class="linenos">919</span></a><span class="sd">        candidate_formulas : dict</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-920"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-920"><span class="linenos">920</span></a><span class="sd">            The candidate formulas.</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-921"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-921"><span class="linenos">921</span></a><span class="sd">        ion_type : str</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-922"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-922"><span class="linenos">922</span></a><span class="sd">            The ion type.</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-923"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-923"><span class="linenos">923</span></a><span class="sd">        ion_charge : int</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-924"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-924"><span class="linenos">924</span></a><span class="sd">            The ion charge, either 1 or -1.</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-925"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-925"><span class="linenos">925</span></a>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-926"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-926"><span class="linenos">926</span></a><span class="sd">        Notes</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-927"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-927"><span class="linenos">927</span></a><span class="sd">        -----</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-928"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-928"><span class="linenos">928</span></a><span class="sd">        This function is designed to be used with the bulk_run_molecular_formula_search function.</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-929"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-929"><span class="linenos">929</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-930"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-930"><span class="linenos">930</span></a>        <span class="k">for</span> <span class="n">mass_spectrum</span><span class="p">,</span> <span class="n">ms_peaks</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mass_spectrum_list</span><span class="p">,</span> <span class="n">ms_peaks_list</span><span class="p">):</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-931"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-931"><span class="linenos">931</span></a>            <span class="n">single_ms_search</span> <span class="o">=</span> <span class="n">SearchMolecularFormulas</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-932"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-932"><span class="linenos">932</span></a>                <span class="n">mass_spectrum</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-933"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-933"><span class="linenos">933</span></a>                <span class="n">sql_db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-934"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-934"><span class="linenos">934</span></a>                <span class="n">first_hit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">first_hit</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-935"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-935"><span class="linenos">935</span></a>                <span class="n">find_isotopologues</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-936"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-936"><span class="linenos">936</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-937"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-937"><span class="linenos">937</span></a>            <span class="n">single_ms_search</span><span class="o">.</span><span class="n">run_search</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-938"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-938"><span class="linenos">938</span></a>                <span class="n">ms_peaks</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-939"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-939"><span class="linenos">939</span></a>                <span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-940"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-940"><span class="linenos">940</span></a>                <span class="n">mass_spectrum</span><span class="o">.</span><span class="n">min_abundance</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-941"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-941"><span class="linenos">941</span></a>                <span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-942"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-942"><span class="linenos">942</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.search_spectra_against_candidates-943"><a href="#SearchMolecularFormulasLC.search_spectra_against_candidates-943"><span class="linenos">943</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Search a list of mass spectra against a list of candidate formulas with a given ion type and charge.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>mass_spectrum_list</strong> (list of MassSpectrum):
The list of mass spectra to perform the search on.</li>
<li><strong>ms_peaks_list</strong> (list of lists of MSPeak objects):
The list of mass spectrum peaks to search within each mass spectrum.</li>
<li><strong>candidate_formulas</strong> (dict):
The candidate formulas.</li>
<li><strong>ion_type</strong> (str):
The ion type.</li>
<li><strong>ion_charge</strong> (int):
The ion charge, either 1 or -1.</li>
</ul>

<h6 id="notes">Notes</h6>

<p>This function is designed to be used with the bulk_run_molecular_formula_search function.</p>
</div>


                            </div>
                            <div id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search" class="classattr">
                                        <input id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">bulk_run_molecular_formula_search</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">mass_spectrum_list</span>,</span><span class="param">	<span class="n">ms_peaks_list</span>,</span><span class="param">	<span class="n">mass_spectrum_setting_key</span><span class="o">=</span><span class="s1">&#39;ms1&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-945"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-945"><span class="linenos"> 945</span></a>    <span class="k">def</span> <span class="nf">bulk_run_molecular_formula_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass_spectrum_list</span><span class="p">,</span> <span class="n">ms_peaks_list</span><span class="p">,</span> <span class="n">mass_spectrum_setting_key</span><span class="o">=</span><span class="s1">&#39;ms1&#39;</span><span class="p">):</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-946"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-946"><span class="linenos"> 946</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the molecular formula search on the given list of mass spectra</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-947"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-947"><span class="linenos"> 947</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-948"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-948"><span class="linenos"> 948</span></a><span class="sd">        Parameters</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-949"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-949"><span class="linenos"> 949</span></a><span class="sd">        ----------</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-950"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-950"><span class="linenos"> 950</span></a><span class="sd">        mass_spectrum_list : list of MassSpectrum</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-951"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-951"><span class="linenos"> 951</span></a><span class="sd">            The list of mass spectra to search.</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-952"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-952"><span class="linenos"> 952</span></a><span class="sd">        ms_peaks_list : list of lists of MSPeak objects </span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-953"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-953"><span class="linenos"> 953</span></a><span class="sd">            The mass peaks to perform molecular formula search within each mass spectrum</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-954"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-954"><span class="linenos"> 954</span></a><span class="sd">        mass_spectrum_setting_key : str, optional</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-955"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-955"><span class="linenos"> 955</span></a><span class="sd">            The mass spectrum setting key, by default &#39;ms1&#39;.</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-956"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-956"><span class="linenos"> 956</span></a><span class="sd">            This is used to get the appropriate molecular search settings from the LCMSBase object</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-957"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-957"><span class="linenos"> 957</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-958"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-958"><span class="linenos"> 958</span></a>        <span class="c1"># Set min_abundance and nominal_mzs</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-959"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-959"><span class="linenos"> 959</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">polarity</span> <span class="o">==</span> <span class="s2">&quot;positive&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-960"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-960"><span class="linenos"> 960</span></a>            <span class="n">ion_charge</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-961"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-961"><span class="linenos"> 961</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">polarity</span> <span class="o">==</span> <span class="s2">&quot;negative&quot;</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-962"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-962"><span class="linenos"> 962</span></a>            <span class="n">ion_charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-963"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-963"><span class="linenos"> 963</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-964"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-964"><span class="linenos"> 964</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Polarity must be either &#39;positive&#39; or &#39;negative&#39;&quot;</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-965"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-965"><span class="linenos"> 965</span></a>        
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-966"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-966"><span class="linenos"> 966</span></a>        <span class="c1"># Check that the length of the mass spectrum list and the ms_peaks list are the same</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-967"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-967"><span class="linenos"> 967</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mass_spectrum_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms_peaks_list</span><span class="p">):</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-968"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-968"><span class="linenos"> 968</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The length of the mass spectrum list and the ms_peaks list must be the same&quot;</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-969"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-969"><span class="linenos"> 969</span></a>        
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-970"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-970"><span class="linenos"> 970</span></a>        <span class="n">nominal_mzs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">nominal_mz</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mass_spectrum_list</span><span class="p">]</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-971"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-971"><span class="linenos"> 971</span></a>        <span class="n">nominal_mzs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">nominal_mzs</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]))</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-972"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-972"><span class="linenos"> 972</span></a>        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">verbose_processing</span> 
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-973"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-973"><span class="linenos"> 973</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-974"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-974"><span class="linenos"> 974</span></a>        <span class="c1"># reset average error, only relevant if average mass error method is being used</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-975"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-975"><span class="linenos"> 975</span></a>        <span class="n">SearchMolecularFormulaWorker</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-976"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-976"><span class="linenos"> 976</span></a>            <span class="n">find_isotopologues</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">find_isotopologues</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-977"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-977"><span class="linenos"> 977</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">reset_error</span><span class="p">(</span><span class="n">mass_spectrum_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-978"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-978"><span class="linenos"> 978</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-979"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-979"><span class="linenos"> 979</span></a>        <span class="c1"># check database for all possible molecular formula combinations based on the setting passed to self.mass_spectrum_obj.molecular_search_settings</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-980"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-980"><span class="linenos"> 980</span></a>        <span class="n">classes</span> <span class="o">=</span> <span class="n">MolecularCombinations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="p">)</span><span class="o">.</span><span class="n">runworker</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-981"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-981"><span class="linenos"> 981</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-982"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-982"><span class="linenos"> 982</span></a>            <span class="n">print_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-983"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-983"><span class="linenos"> 983</span></a>        <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-984"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-984"><span class="linenos"> 984</span></a>        
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-985"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-985"><span class="linenos"> 985</span></a>        <span class="c1"># split the database load to not blowout the memory</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-986"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-986"><span class="linenos"> 986</span></a>        <span class="k">for</span> <span class="n">classe_chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-987"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-987"><span class="linenos"> 987</span></a>            <span class="n">classes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">db_chunk_size</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-988"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-988"><span class="linenos"> 988</span></a>        <span class="p">):</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-989"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-989"><span class="linenos"> 989</span></a>            <span class="n">classes_str_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">class_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">class_tuple</span> <span class="ow">in</span> <span class="n">classe_chunk</span><span class="p">]</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-990"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-990"><span class="linenos"> 990</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-991"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-991"><span class="linenos"> 991</span></a>            <span class="c1"># load the molecular formula objs binned by ion type and heteroatoms classes, {ion type:{classe:[list_formula]}}</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-992"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-992"><span class="linenos"> 992</span></a>            <span class="c1"># for adduct ion type a third key is added {atoms:{ion type:{classe:[list_formula]}}}</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-993"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-993"><span class="linenos"> 993</span></a>            <span class="n">dict_res</span> <span class="o">=</span> <span class="n">SearchMolecularFormulas</span><span class="o">.</span><span class="n">database_to_dict</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-994"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-994"><span class="linenos"> 994</span></a>                <span class="n">classes_str_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-995"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-995"><span class="linenos"> 995</span></a>                <span class="n">nominal_mzs</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-996"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-996"><span class="linenos"> 996</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-997"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-997"><span class="linenos"> 997</span></a>                <span class="n">ion_charge</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-998"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-998"><span class="linenos"> 998</span></a>            <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-999"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-999"><span class="linenos"> 999</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1000"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1000"><span class="linenos">1000</span></a>            <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">classe_chunk</span><span class="p">,</span> <span class="n">disable</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1001"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1001"><span class="linenos">1001</span></a>            <span class="k">for</span> <span class="n">classe_tuple</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1002"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1002"><span class="linenos">1002</span></a>                <span class="c1"># class string is a json serialized dict</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1003"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1003"><span class="linenos">1003</span></a>                <span class="n">classe_str</span> <span class="o">=</span> <span class="n">classe_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1004"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1004"><span class="linenos">1004</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1005"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1005"><span class="linenos">1005</span></a>                <span class="c1"># Perform search for (de)protonated ion type</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1006"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1006"><span class="linenos">1006</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">isProtonated</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1007"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1007"><span class="linenos">1007</span></a>                    <span class="n">ion_type</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">protonated_de_ion</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1008"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1008"><span class="linenos">1008</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1009"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1009"><span class="linenos">1009</span></a>                    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description_str</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1010"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1010"><span class="linenos">1010</span></a>                        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Started molecular formula search for class </span><span class="si">%s</span><span class="s2">, (de)protonated &quot;</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1011"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1011"><span class="linenos">1011</span></a>                        <span class="o">%</span> <span class="n">classe_str</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1012"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1012"><span class="linenos">1012</span></a>                        <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1013"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1013"><span class="linenos">1013</span></a>                    <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1014"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1014"><span class="linenos">1014</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1015"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1015"><span class="linenos">1015</span></a>                    <span class="n">candidate_formulas</span> <span class="o">=</span> <span class="n">dict_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ion_type</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">classe_str</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1016"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1016"><span class="linenos">1016</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1017"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1017"><span class="linenos">1017</span></a>                    <span class="k">if</span> <span class="n">candidate_formulas</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1018"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1018"><span class="linenos">1018</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">search_spectra_against_candidates</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1019"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1019"><span class="linenos">1019</span></a>                            <span class="n">mass_spectrum_list</span><span class="o">=</span><span class="n">mass_spectrum_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1020"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1020"><span class="linenos">1020</span></a>                            <span class="n">ms_peaks_list</span><span class="o">=</span><span class="n">ms_peaks_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1021"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1021"><span class="linenos">1021</span></a>                            <span class="n">candidate_formulas</span><span class="o">=</span><span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1022"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1022"><span class="linenos">1022</span></a>                            <span class="n">ion_type</span><span class="o">=</span><span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1023"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1023"><span class="linenos">1023</span></a>                            <span class="n">ion_charge</span><span class="o">=</span><span class="n">ion_charge</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1024"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1024"><span class="linenos">1024</span></a>                        <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1025"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1025"><span class="linenos">1025</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1026"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1026"><span class="linenos">1026</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1027"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1027"><span class="linenos">1027</span></a>                <span class="c1"># Perform search for radical ion type</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1028"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1028"><span class="linenos">1028</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">isRadical</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1029"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1029"><span class="linenos">1029</span></a>                    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description_str</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1030"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1030"><span class="linenos">1030</span></a>                        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Started molecular formula search for class </span><span class="si">%s</span><span class="s2">, radical &quot;</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1031"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1031"><span class="linenos">1031</span></a>                        <span class="o">%</span> <span class="n">classe_str</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1032"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1032"><span class="linenos">1032</span></a>                        <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1033"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1033"><span class="linenos">1033</span></a>                    <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1034"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1034"><span class="linenos">1034</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1035"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1035"><span class="linenos">1035</span></a>                    <span class="n">ion_type</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">radical_ion</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1036"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1036"><span class="linenos">1036</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1037"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1037"><span class="linenos">1037</span></a>                    <span class="n">candidate_formulas</span> <span class="o">=</span> <span class="n">dict_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ion_type</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">classe_str</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1038"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1038"><span class="linenos">1038</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1039"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1039"><span class="linenos">1039</span></a>                    <span class="k">if</span> <span class="n">candidate_formulas</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1040"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1040"><span class="linenos">1040</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">search_spectra_against_candidates</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1041"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1041"><span class="linenos">1041</span></a>                            <span class="n">mass_spectrum_list</span><span class="o">=</span><span class="n">mass_spectrum_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1042"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1042"><span class="linenos">1042</span></a>                            <span class="n">ms_peaks_list</span><span class="o">=</span><span class="n">ms_peaks_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1043"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1043"><span class="linenos">1043</span></a>                            <span class="n">candidate_formulas</span><span class="o">=</span><span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1044"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1044"><span class="linenos">1044</span></a>                            <span class="n">ion_type</span><span class="o">=</span><span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1045"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1045"><span class="linenos">1045</span></a>                            <span class="n">ion_charge</span><span class="o">=</span><span class="n">ion_charge</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1046"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1046"><span class="linenos">1046</span></a>                        <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1047"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1047"><span class="linenos">1047</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1048"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1048"><span class="linenos">1048</span></a>                <span class="c1"># Perform search for adduct ion type</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1049"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1049"><span class="linenos">1049</span></a>                <span class="c1"># looks for adduct, used_atom_valences should be 0</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1050"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1050"><span class="linenos">1050</span></a>                <span class="c1"># this code does not support H exchance by halogen atoms</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1051"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1051"><span class="linenos">1051</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="p">[</span><span class="n">mass_spectrum_setting_key</span><span class="p">]</span><span class="o">.</span><span class="n">molecular_search</span><span class="o">.</span><span class="n">isAdduct</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1052"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1052"><span class="linenos">1052</span></a>                    <span class="n">pbar</span><span class="o">.</span><span class="n">set_description_str</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1053"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1053"><span class="linenos">1053</span></a>                        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Started molecular formula search for class </span><span class="si">%s</span><span class="s2">, adduct &quot;</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1054"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1054"><span class="linenos">1054</span></a>                        <span class="o">%</span> <span class="n">classe_str</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1055"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1055"><span class="linenos">1055</span></a>                        <span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1056"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1056"><span class="linenos">1056</span></a>                    <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1057"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1057"><span class="linenos">1057</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1058"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1058"><span class="linenos">1058</span></a>                    <span class="n">ion_type</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">adduct_ion</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1059"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1059"><span class="linenos">1059</span></a>                    <span class="n">dict_atoms_formulas</span> <span class="o">=</span> <span class="n">dict_res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ion_type</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1060"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1060"><span class="linenos">1060</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1061"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1061"><span class="linenos">1061</span></a>                    <span class="k">for</span> <span class="n">adduct_atom</span><span class="p">,</span> <span class="n">dict_by_class</span> <span class="ow">in</span> <span class="n">dict_atoms_formulas</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1062"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1062"><span class="linenos">1062</span></a>                        <span class="n">candidate_formulas</span> <span class="o">=</span> <span class="n">dict_by_class</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">classe_str</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1063"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1063"><span class="linenos">1063</span></a>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1064"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1064"><span class="linenos">1064</span></a>                        <span class="k">if</span> <span class="n">candidate_formulas</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1065"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1065"><span class="linenos">1065</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">search_spectra_against_candidates</span><span class="p">(</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1066"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1066"><span class="linenos">1066</span></a>                                <span class="n">mass_spectrum_list</span><span class="o">=</span><span class="n">mass_spectrum_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1067"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1067"><span class="linenos">1067</span></a>                                <span class="n">ms_peaks_list</span><span class="o">=</span><span class="n">ms_peaks_list</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1068"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1068"><span class="linenos">1068</span></a>                                <span class="n">candidate_formulas</span><span class="o">=</span><span class="n">candidate_formulas</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1069"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1069"><span class="linenos">1069</span></a>                                <span class="n">ion_type</span><span class="o">=</span><span class="n">ion_type</span><span class="p">,</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1070"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1070"><span class="linenos">1070</span></a>                                <span class="n">ion_charge</span><span class="o">=</span><span class="n">ion_charge</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1071"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1071"><span class="linenos">1071</span></a>                            <span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1072"><a href="#SearchMolecularFormulasLC.bulk_run_molecular_formula_search-1072"><span class="linenos">1072</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sql_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Run the molecular formula search on the given list of mass spectra</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>mass_spectrum_list</strong> (list of MassSpectrum):
The list of mass spectra to search.</li>
<li><strong>ms_peaks_list</strong> (list of lists of MSPeak objects):
The mass peaks to perform molecular formula search within each mass spectrum</li>
<li><strong>mass_spectrum_setting_key</strong> (str, optional):
The mass spectrum setting key, by default 'ms1'.
This is used to get the appropriate molecular search settings from the LCMSBase object</li>
</ul>
</div>


                            </div>
                            <div id="SearchMolecularFormulasLC.run_mass_feature_search" class="classattr">
                                        <input id="SearchMolecularFormulasLC.run_mass_feature_search-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_mass_feature_search</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SearchMolecularFormulasLC.run_mass_feature_search-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulasLC.run_mass_feature_search"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1074"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1074"><span class="linenos">1074</span></a>    <span class="k">def</span> <span class="nf">run_mass_feature_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1075"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1075"><span class="linenos">1075</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the molecular formula search on the mass features.</span>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1076"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1076"><span class="linenos">1076</span></a><span class="sd">        </span>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1077"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1077"><span class="linenos">1077</span></a><span class="sd">        Calls bulk_run_molecular_formula_search() with specified mass spectra and mass peaks.</span>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1078"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1078"><span class="linenos">1078</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1079"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1079"><span class="linenos">1079</span></a>        <span class="n">mass_features_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1080"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1080"><span class="linenos">1080</span></a>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1081"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1081"><span class="linenos">1081</span></a>        <span class="c1"># Get the list of mass spectrum (and peaks to search with each mass spectrum) for all mass features</span>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1082"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1082"><span class="linenos">1082</span></a>        <span class="n">scan_list</span> <span class="o">=</span> <span class="n">mass_features_df</span><span class="o">.</span><span class="n">apex_scan</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1083"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1083"><span class="linenos">1083</span></a>        <span class="n">mass_spectrum_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">_ms</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scan_list</span><span class="p">]</span>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1084"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1084"><span class="linenos">1084</span></a>        <span class="n">ms_peaks</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1085"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1085"><span class="linenos">1085</span></a>        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scan_list</span><span class="p">:</span>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1086"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1086"><span class="linenos">1086</span></a>            <span class="n">mf_df_scan</span> <span class="o">=</span> <span class="n">mass_features_df</span><span class="p">[</span><span class="n">mass_features_df</span><span class="o">.</span><span class="n">apex_scan</span> <span class="o">==</span> <span class="n">scan</span><span class="p">]</span>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1087"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1087"><span class="linenos">1087</span></a>            <span class="n">peaks_to_search</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1088"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1088"><span class="linenos">1088</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">lcms_obj</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">ms1_peak</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mf_df_scan</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1089"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1089"><span class="linenos">1089</span></a>            <span class="p">]</span>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1090"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1090"><span class="linenos">1090</span></a>            <span class="n">ms_peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peaks_to_search</span><span class="p">)</span>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1091"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1091"><span class="linenos">1091</span></a>        
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1092"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1092"><span class="linenos">1092</span></a>        <span class="c1"># Run the molecular formula search</span>
</span><span id="SearchMolecularFormulasLC.run_mass_feature_search-1093"><a href="#SearchMolecularFormulasLC.run_mass_feature_search-1093"><span class="linenos">1093</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_run_molecular_formula_search</span><span class="p">(</span><span class="n">mass_spectrum_list</span><span class="p">,</span> <span class="n">ms_peaks</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Run the molecular formula search on the mass features.</p>

<p>Calls bulk_run_molecular_formula_search() with specified mass spectra and mass peaks.</p>
</div>


                            </div>
                            <div id="SearchMolecularFormulasLC.run_untargeted_worker_ms1" class="classattr">
                                        <input id="SearchMolecularFormulasLC.run_untargeted_worker_ms1-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_untargeted_worker_ms1</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SearchMolecularFormulasLC.run_untargeted_worker_ms1-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulasLC.run_untargeted_worker_ms1"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulasLC.run_untargeted_worker_ms1-1095"><a href="#SearchMolecularFormulasLC.run_untargeted_worker_ms1-1095"><span class="linenos">1095</span></a>    <span class="k">def</span> <span class="nf">run_untargeted_worker_ms1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SearchMolecularFormulasLC.run_untargeted_worker_ms1-1096"><a href="#SearchMolecularFormulasLC.run_untargeted_worker_ms1-1096"><span class="linenos">1096</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run untargeted molecular formula search on the ms1 mass spectrum.&quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulasLC.run_untargeted_worker_ms1-1097"><a href="#SearchMolecularFormulasLC.run_untargeted_worker_ms1-1097"><span class="linenos">1097</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;run_untargeted_worker_ms1 search is not implemented in CoreMS 3.0 and greater&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Run untargeted molecular formula search on the ms1 mass spectrum.</p>
</div>


                            </div>
                            <div id="SearchMolecularFormulasLC.run_target_worker_ms1" class="classattr">
                                        <input id="SearchMolecularFormulasLC.run_target_worker_ms1-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_target_worker_ms1</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SearchMolecularFormulasLC.run_target_worker_ms1-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SearchMolecularFormulasLC.run_target_worker_ms1"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SearchMolecularFormulasLC.run_target_worker_ms1-1099"><a href="#SearchMolecularFormulasLC.run_target_worker_ms1-1099"><span class="linenos">1099</span></a>    <span class="k">def</span> <span class="nf">run_target_worker_ms1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SearchMolecularFormulasLC.run_target_worker_ms1-1100"><a href="#SearchMolecularFormulasLC.run_target_worker_ms1-1100"><span class="linenos">1100</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run targeted molecular formula search on the ms1 mass spectrum.&quot;&quot;&quot;</span>
</span><span id="SearchMolecularFormulasLC.run_target_worker_ms1-1101"><a href="#SearchMolecularFormulasLC.run_target_worker_ms1-1101"><span class="linenos">1101</span></a>        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;run_target_worker_ms1 formula search is not yet implemented in CoreMS 3.0 and greater&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Run targeted molecular formula search on the ms1 mass spectrum.</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>