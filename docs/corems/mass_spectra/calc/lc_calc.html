<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.1.0"/>
    <title>corems.mass_spectra.calc.lc_calc API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../calc.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;corems.mass_spectra.calc</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#find_closest">find_closest</a>
            </li>
            <li>
                    <a class="class" href="#LCCalculations">LCCalculations</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LCCalculations.get_max_eic">get_max_eic</a>
                        </li>
                        <li>
                                <a class="function" href="#LCCalculations.smooth_tic">smooth_tic</a>
                        </li>
                        <li>
                                <a class="function" href="#LCCalculations.eic_centroid_detector">eic_centroid_detector</a>
                        </li>
                        <li>
                                <a class="function" href="#LCCalculations.find_nearest_scan">find_nearest_scan</a>
                        </li>
                        <li>
                                <a class="function" href="#LCCalculations.add_peak_metrics">add_peak_metrics</a>
                        </li>
                        <li>
                                <a class="function" href="#LCCalculations.get_average_mass_spectrum">get_average_mass_spectrum</a>
                        </li>
                        <li>
                                <a class="function" href="#LCCalculations.find_mass_features">find_mass_features</a>
                        </li>
                        <li>
                                <a class="function" href="#LCCalculations.integrate_mass_features">integrate_mass_features</a>
                        </li>
                        <li>
                                <a class="function" href="#LCCalculations.find_c13_mass_features">find_c13_mass_features</a>
                        </li>
                        <li>
                                <a class="function" href="#LCCalculations.deconvolute_ms1_mass_features">deconvolute_ms1_mass_features</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#PHCalculations">PHCalculations</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#PHCalculations.sparse_mean_filter">sparse_mean_filter</a>
                        </li>
                        <li>
                                <a class="function" href="#PHCalculations.embed_unique_indices">embed_unique_indices</a>
                        </li>
                        <li>
                                <a class="function" href="#PHCalculations.sparse_upper_star">sparse_upper_star</a>
                        </li>
                        <li>
                                <a class="function" href="#PHCalculations.check_if_grid">check_if_grid</a>
                        </li>
                        <li>
                                <a class="function" href="#PHCalculations.grid_data">grid_data</a>
                        </li>
                        <li>
                                <a class="function" href="#PHCalculations.find_mass_features_ph">find_mass_features_ph</a>
                        </li>
                        <li>
                                <a class="function" href="#PHCalculations.cluster_mass_features">cluster_mass_features</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../../corems.html">corems</a><wbr>.<a href="./../../mass_spectra.html">mass_spectra</a><wbr>.<a href="./../calc.html">calc</a><wbr>.lc_calc    </h1>

                
                        <input id="mod-lc_calc-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-lc_calc-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">from</span> <span class="nn">ripser</span> <span class="kn">import</span> <span class="n">ripser</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">KDTree</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">from</span> <span class="nn">corems.chroma_peak.factory.chroma_peak_classes</span> <span class="kn">import</span> <span class="n">LCMSMassFeature</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">from</span> <span class="nn">corems.mass_spectra.calc</span> <span class="kn">import</span> <span class="n">SignalProcessing</span> <span class="k">as</span> <span class="n">sp</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">from</span> <span class="nn">corems.mass_spectra.factory.chromat_data</span> <span class="kn">import</span> <span class="n">EIC_Data</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">from</span> <span class="nn">corems.mass_spectrum.input.numpyArray</span> <span class="kn">import</span> <span class="n">ms_from_array_profile</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="k">def</span> <span class="nf">find_closest</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the index of closest value in A to each value in target.</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="sd">    Parameters</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="sd">    ----------</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="sd">    A : :obj:`~numpy.array`</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="sd">        The array to search (blueprint). A must be sorted.</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="sd">    target : :obj:`~numpy.array`</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="sd">        The array of values to search for. target must be sorted.</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="sd">    Returns</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="sd">    -------</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="sd">    :obj:`~numpy.array`</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="sd">        The indices of the closest values in A to each value in target.</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>    <span class="n">idx</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a>    <span class="n">left</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>    <span class="n">right</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a>    <span class="n">idx</span> <span class="o">-=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">left</span> <span class="o">&lt;</span> <span class="n">right</span> <span class="o">-</span> <span class="n">target</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>    <span class="k">return</span> <span class="n">idx</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="k">class</span> <span class="nc">LCCalculations</span><span class="p">:</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Methods for performing LC calculations on mass spectra data.</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="sd">    Notes</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="sd">    -----</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="sd">    This class is intended to be used as a mixin for the LCMSBase class.</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="sd">    Methods</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="sd">    -------</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="sd">    * get_max_eic(eic_data).</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="sd">        Returns the maximum EIC value from the given EIC data. A static method.</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="sd">    * smooth_tic(tic).</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="sd">        Smooths the TIC data using the specified smoothing method and settings.</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="sd">    * eic_centroid_detector(rt, eic, max_eic).</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="sd">        Performs EIC centroid detection on the given EIC data.</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="sd">    * find_nearest_scan(rt).</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">        Finds the nearest scan to the given retention time.</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="sd">    * get_average_mass_spectrum(scan_list, apex_scan, spectrum_mode=&quot;profile&quot;, ms_level=1, auto_process=True, use_parser=False, perform_checks=True, polarity=None).</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">        Returns an averaged mass spectrum object.</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">    * find_mass_features(ms_level=1).</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="sd">        Find regions of interest for a given MS level (default is MS1).</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd">    * integrate_mass_features(drop_if_fail=False, ms_level=1).</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="sd">        Integrate mass features of interest and extracts EICs.</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="sd">    * find_c13_mass_features().</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="sd">        Evaluate mass features and mark likely C13 isotopes.</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">    * deconvolute_ms1_mass_features().</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="sd">        Deconvolute mass features&#39; ms1 mass spectra.</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>    <span class="k">def</span> <span class="nf">get_max_eic</span><span class="p">(</span><span class="n">eic_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the maximum EIC value from the given EIC data.</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="sd">        Notes</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="sd">        -----</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a><span class="sd">        This is a static method.</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="sd">        Parameters</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a><span class="sd">        ----------</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a><span class="sd">        eic_data : dict</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a><span class="sd">            A dictionary containing EIC data.</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a><span class="sd">        Returns</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a><span class="sd">        -------</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a><span class="sd">        float</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a><span class="sd">            The maximum EIC value.</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>        <span class="n">max_eic</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>        <span class="k">for</span> <span class="n">eic_data</span> <span class="ow">in</span> <span class="n">eic_data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>            <span class="n">ind_max_eic</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">eic_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;EIC&quot;</span><span class="p">))</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>            <span class="n">max_eic</span> <span class="o">=</span> <span class="n">ind_max_eic</span> <span class="k">if</span> <span class="n">ind_max_eic</span> <span class="o">&gt;</span> <span class="n">max_eic</span> <span class="k">else</span> <span class="n">max_eic</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="k">return</span> <span class="n">max_eic</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>    <span class="k">def</span> <span class="nf">smooth_tic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tic</span><span class="p">):</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Smooths the TIC or EIC data using the specified smoothing method and settings.</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a><span class="sd">        Parameters</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a><span class="sd">        ----------</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="sd">        tic : numpy.ndarray</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="sd">            The TIC (or EIC) data to be smoothed.</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a><span class="sd">        Returns</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a><span class="sd">        -------</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="sd">        numpy.ndarray</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="sd">            The smoothed TIC data.</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>        <span class="n">implemented_smooth_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">implemented_smooth_method</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>        <span class="n">pol_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">savgol_pol_order</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>        <span class="n">window_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">smooth_window</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>        <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">smooth_method</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>        <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">smooth_signal</span><span class="p">(</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>            <span class="n">tic</span><span class="p">,</span> <span class="n">window_len</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">pol_order</span><span class="p">,</span> <span class="n">implemented_smooth_method</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>        <span class="p">)</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>    <span class="k">def</span> <span class="nf">eic_centroid_detector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">eic</span><span class="p">,</span> <span class="n">max_eic</span><span class="p">,</span> <span class="n">apex_indexes</span><span class="o">=</span><span class="p">[]):</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs EIC centroid detection on the given EIC data.</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a><span class="sd">        Parameters</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a><span class="sd">        ----------</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a><span class="sd">        rt : numpy.ndarray</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a><span class="sd">            The retention time data.</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a><span class="sd">        eic : numpy.ndarray</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a><span class="sd">            The EIC data.</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a><span class="sd">        max_eic : float</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a><span class="sd">            The maximum EIC value.</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a><span class="sd">        apex_indexes : list, optional</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a><span class="sd">            The apexes of the EIC peaks. Defaults to [], which means that the apexes will be calculated by the function.</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a><span class="sd">        Returns</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a><span class="sd">        -------</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="sd">        numpy.ndarray</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="sd">            The indexes of left, apex, and right limits as a generator.</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>        <span class="n">max_prominence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">peak_max_prominence_percent</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>        <span class="n">max_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">peak_height_max_percent</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>        <span class="n">signal_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">eic_signal_threshold</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>        <span class="n">min_peak_datapoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">min_peak_datapoints</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>        <span class="n">peak_derivative_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">peak_derivative_threshold</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>        <span class="n">include_indexes</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">peak_picking_first_derivative</span><span class="p">(</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>            <span class="n">domain</span><span class="o">=</span><span class="n">rt</span><span class="p">,</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>            <span class="n">signal</span><span class="o">=</span><span class="n">eic</span><span class="p">,</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>            <span class="n">max_height</span><span class="o">=</span><span class="n">max_height</span><span class="p">,</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>            <span class="n">max_prominence</span><span class="o">=</span><span class="n">max_prominence</span><span class="p">,</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>            <span class="n">max_signal</span><span class="o">=</span><span class="n">max_eic</span><span class="p">,</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>            <span class="n">min_peak_datapoints</span><span class="o">=</span><span class="n">min_peak_datapoints</span><span class="p">,</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>            <span class="n">peak_derivative_threshold</span><span class="o">=</span><span class="n">peak_derivative_threshold</span><span class="p">,</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>            <span class="n">signal_threshold</span><span class="o">=</span><span class="n">signal_threshold</span><span class="p">,</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>            <span class="n">correct_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>            <span class="n">plot_res</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>            <span class="n">apex_indexes</span><span class="o">=</span><span class="n">apex_indexes</span><span class="p">,</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>        <span class="p">)</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>        <span class="k">return</span> <span class="n">include_indexes</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>    <span class="k">def</span> <span class="nf">find_nearest_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rt</span><span class="p">):</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Finds the nearest scan to the given retention time.</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a><span class="sd">        Parameters</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a><span class="sd">        ----------</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a><span class="sd">        rt : float</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a><span class="sd">            The retention time (in minutes) to find the nearest scan for.</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a><span class="sd">        Returns</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="sd">        -------</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">        int</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a><span class="sd">            The scan number of the nearest scan.</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>        <span class="n">array_rt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retention_time</span><span class="p">)</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>        <span class="n">scan_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">array_rt</span> <span class="o">-</span> <span class="n">rt</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>        <span class="n">real_scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans_number</span><span class="p">[</span><span class="n">scan_index</span><span class="p">]</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>        <span class="k">return</span> <span class="n">real_scan</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>    <span class="k">def</span> <span class="nf">add_peak_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add peak metrics to the mass features.</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a><span class="sd">        This function calculates the peak metrics for each mass feature and adds them to the mass feature objects.</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>        <span class="c1"># Check that at least some mass features have eic data</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">mf</span><span class="o">.</span><span class="n">_eic_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">values</span><span class="p">()]):</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>                <span class="s2">&quot;No mass features have EIC data. Run integrate_mass_features first.&quot;</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>            <span class="p">)</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>        <span class="k">for</span> <span class="n">mass_feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>            <span class="c1"># Check if the mass feature has been integrated</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>            <span class="k">if</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">_eic_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>                <span class="c1"># Calculate peak metrics</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">calc_half_height_width</span><span class="p">()</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">calc_tailing_factor</span><span class="p">()</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">calc_dispersity_index</span><span class="p">()</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>    <span class="k">def</span> <span class="nf">get_average_mass_spectrum</span><span class="p">(</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>        <span class="n">scan_list</span><span class="p">,</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>        <span class="n">apex_scan</span><span class="p">,</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>        <span class="n">spectrum_mode</span><span class="o">=</span><span class="s2">&quot;profile&quot;</span><span class="p">,</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>        <span class="n">ms_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>        <span class="n">auto_process</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>        <span class="n">use_parser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>        <span class="n">perform_checks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>        <span class="n">polarity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>        <span class="n">ms_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>    <span class="p">):</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an averaged mass spectrum object</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a><span class="sd">        Parameters</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a><span class="sd">        ----------</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a><span class="sd">        scan_list : list</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a><span class="sd">            List of scan numbers to average.</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a><span class="sd">        apex_scan : int</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a><span class="sd">            Number of the apex scan</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a><span class="sd">        spectrum_mode : str, optional</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a><span class="sd">            The spectrum mode to use. Defaults to &quot;profile&quot;. Not that only &quot;profile&quot; mode is supported for averaging.</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a><span class="sd">        ms_level : int, optional</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a><span class="sd">            The MS level to use. Defaults to 1.</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a><span class="sd">        auto_process : bool, optional</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a><span class="sd">            If True, the averaged mass spectrum will be auto-processed. Defaults to True.</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a><span class="sd">        use_parser : bool, optional</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a><span class="sd">            If True, the mass spectra will be obtained from the parser. Defaults to False.</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a><span class="sd">        perform_checks : bool, optional</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a><span class="sd">            If True, the function will check if the data are within the ms_unprocessed dictionary and are the correct mode. Defaults to True. Only set to False if you are sure the data are profile, and (if not using the parser) are in the ms_unprocessed dictionary!  ms_unprocessed dictionary also must be indexed on scan</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a><span class="sd">        polarity : int, optional</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a><span class="sd">            The polarity of the mass spectra (1 or -1). If not set, the polarity will be determined from the dataset. Defaults to None. (fastest if set to -1 or 1)</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a><span class="sd">        ms_params : MSParameters, optional</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a><span class="sd">            The mass spectrum parameters to use. If not set (None), the globally set parameters will be used. Defaults to None.</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a><span class="sd">        Returns</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a><span class="sd">        -------</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a><span class="sd">        MassSpectrumProfile</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a><span class="sd">            The averaged mass spectrum object.</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a><span class="sd">        Raises</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a><span class="sd">        ------</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a><span class="sd">        ValueError</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a><span class="sd">            If the spectrum mode is not &quot;profile&quot;.</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a><span class="sd">            If the MS level is not found in the unprocessed mass spectra dictionary.</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a><span class="sd">            If not all scan numbers are found in the unprocessed mass spectra dictionary.</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>        <span class="k">if</span> <span class="n">perform_checks</span><span class="p">:</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>            <span class="k">if</span> <span class="n">spectrum_mode</span> <span class="o">!=</span> <span class="s2">&quot;profile&quot;</span><span class="p">:</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Averaging only supported for profile mode&quot;</span><span class="p">)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>        <span class="k">if</span> <span class="n">polarity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>            <span class="c1"># set polarity to -1 if negative mode, 1 if positive mode (for mass spectrum creation)</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity</span> <span class="o">==</span> <span class="s2">&quot;negative&quot;</span><span class="p">:</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>                <span class="n">polarity</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity</span> <span class="o">==</span> <span class="s2">&quot;positive&quot;</span><span class="p">:</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>                <span class="n">polarity</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>                    <span class="s2">&quot;Polarity not set for dataset, must be a set containing either &#39;positive&#39; or &#39;negative&#39;&quot;</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>                <span class="p">)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>        <span class="c1"># if not using_parser, check that scan numbers are in _ms_unprocessed</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_parser</span><span class="p">:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>            <span class="k">if</span> <span class="n">perform_checks</span><span class="p">:</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>                <span class="c1"># Set index to scan for faster lookup</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>                <span class="n">ms_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="p">[</span><span class="n">ms_level</span><span class="p">]</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>                    <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>                    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>                    <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>                <span class="p">)</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>                <span class="n">my_ms_df</span> <span class="o">=</span> <span class="n">ms_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">scan_list</span><span class="p">]</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>                <span class="c1"># Check that all scan numbers are in the ms_df</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">scan_list</span><span class="p">,</span> <span class="n">ms_df</span><span class="o">.</span><span class="n">index</span><span class="p">)):</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>                        <span class="s2">&quot;Not all scan numbers found in the unprocessed mass spectra dictionary&quot;</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>                    <span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>                <span class="n">my_ms_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;scan&quot;</span><span class="p">:</span> <span class="n">scan_list</span><span class="p">})</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>                    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;scan&quot;</span><span class="p">)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>                    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="p">[</span><span class="n">ms_level</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>                <span class="p">)</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>        <span class="k">if</span> <span class="n">use_parser</span><span class="p">:</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>            <span class="n">ms_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">spectra_parser</span><span class="o">.</span><span class="n">get_mass_spectrum_from_scan</span><span class="p">(</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>                    <span class="n">x</span><span class="p">,</span> <span class="n">spectrum_mode</span><span class="o">=</span><span class="n">spectrum_mode</span><span class="p">,</span> <span class="n">auto_process</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>                <span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scan_list</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>            <span class="p">]</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>            <span class="n">ms_mz</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">_mz_exp</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ms_list</span><span class="p">]</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>            <span class="n">ms_int</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">_abundance</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ms_list</span><span class="p">]</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>            <span class="n">my_ms_df</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ms_mz</span><span class="p">)):</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>                <span class="n">my_ms_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>                        <span class="p">{</span><span class="s2">&quot;mz&quot;</span><span class="p">:</span> <span class="n">ms_mz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;intensity&quot;</span><span class="p">:</span> <span class="n">ms_int</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;scan&quot;</span><span class="p">:</span> <span class="n">scan_list</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>                    <span class="p">)</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>                <span class="p">)</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>            <span class="n">my_ms_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">my_ms_df</span><span class="p">)</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_grid</span><span class="p">(</span><span class="n">my_ms_df</span><span class="p">):</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>            <span class="n">my_ms_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span><span class="p">(</span><span class="n">my_ms_df</span><span class="p">)</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>        <span class="n">my_ms_ave</span> <span class="o">=</span> <span class="n">my_ms_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;mz&quot;</span><span class="p">)[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>        <span class="n">ms</span> <span class="o">=</span> <span class="n">ms_from_array_profile</span><span class="p">(</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>            <span class="n">my_ms_ave</span><span class="o">.</span><span class="n">mz</span><span class="p">,</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>            <span class="n">my_ms_ave</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_location</span><span class="p">,</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>            <span class="n">polarity</span><span class="o">=</span><span class="n">polarity</span><span class="p">,</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>            <span class="n">auto_process</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>        <span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>        <span class="c1"># Set the mass spectrum parameters, auto-process if auto_process is True, and add to the dataset</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>        <span class="k">if</span> <span class="n">ms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>            <span class="k">if</span> <span class="n">ms_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>                <span class="n">ms</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">ms_params</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>            <span class="n">ms</span><span class="o">.</span><span class="n">scan_number</span> <span class="o">=</span> <span class="n">apex_scan</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>            <span class="k">if</span> <span class="n">auto_process</span><span class="p">:</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>                <span class="n">ms</span><span class="o">.</span><span class="n">process_mass_spec</span><span class="p">()</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>        <span class="k">return</span> <span class="n">ms</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>    <span class="k">def</span> <span class="nf">find_mass_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find mass features within an LCMSBase object</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a><span class="sd">        Note that this is a wrapper function that calls the find_mass_features_ph function, but can be extended to support other peak picking methods in the future.</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a><span class="sd">        Parameters</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a><span class="sd">        ----------</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a><span class="sd">        ms_level : int, optional</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a><span class="sd">            The MS level to use for peak picking Default is 1.</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a><span class="sd">        grid : bool, optional</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a><span class="sd">            If True, will regrid the data before running the persistent homology calculations (after checking if the data is gridded, used for persistent homology peak picking. Default is True.</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a><span class="sd">        Raises</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a><span class="sd">        ------</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a><span class="sd">        ValueError</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a><span class="sd">            If no MS level data is found on the object.</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a><span class="sd">            If persistent homology peak picking is attempted on non-profile mode data.</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a><span class="sd">            If data is not gridded and grid is False.</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a><span class="sd">            If peak picking method is not implemented.</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a><span class="sd">        Returns</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a><span class="sd">        -------</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a><span class="sd">        None, but assigns the mass_features and eics attributes to the object.</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>        <span class="n">pp_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">peak_picking_method</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>        <span class="k">if</span> <span class="n">pp_method</span> <span class="o">==</span> <span class="s2">&quot;persistent homology&quot;</span><span class="p">:</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>            <span class="n">msx_scan_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_df</span><span class="p">[</span><span class="s2">&quot;ms_level&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ms_level</span><span class="p">]</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">msx_scan_df</span><span class="p">[</span><span class="s2">&quot;ms_format&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;profile&quot;</span><span class="p">):</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">find_mass_features_ph</span><span class="p">(</span><span class="n">ms_level</span><span class="o">=</span><span class="n">ms_level</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cluster_mass_features</span><span class="p">(</span><span class="n">drop_children</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="s2">&quot;persistence&quot;</span><span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>                    <span class="s2">&quot;MS</span><span class="si">{}</span><span class="s2"> scans are not profile mode, which is required for persistent homology peak picking.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>                        <span class="n">ms_level</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>                    <span class="p">)</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>                <span class="p">)</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Peak picking method not implemented&quot;</span><span class="p">)</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>    <span class="k">def</span> <span class="nf">integrate_mass_features</span><span class="p">(</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">drop_if_fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ms_level</span><span class="o">=</span><span class="mi">1</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>    <span class="p">):</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Integrate mass features and extract EICs.</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a><span class="sd">        Populates the _eics attribute on the LCMSBase object for each unique mz in the mass_features dataframe and adds data (start_scan, final_scan, area) to the mass_features attribute.</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a><span class="sd">        Parameters</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a><span class="sd">        ----------</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a><span class="sd">        drop_if_fail : bool, optional</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a><span class="sd">            Whether to drop mass features if the EIC limit calculations fail.</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a><span class="sd">            Default is True.</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a><span class="sd">        drop_duplicates : bool, optional</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a><span class="sd">            Whether to mass features that appear to be duplicates</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a><span class="sd">            (i.e., mz is similar to another mass feature and limits of the EIC are similar or encapsulating).</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a><span class="sd">            Default is True.</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a><span class="sd">        ms_level : int, optional</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a><span class="sd">            The MS level to use. Default is 1.</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a><span class="sd">        Raises</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a><span class="sd">        ------</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a><span class="sd">        ValueError</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a><span class="sd">            If no mass features are found.</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a><span class="sd">            If no MS level data is found for the given MS level (either in data or in the scan data)</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a><span class="sd">        Returns</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a><span class="sd">        -------</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a><span class="sd">        None, but populates the eics attribute on the LCMSBase object and adds data (start_scan, final_scan, area) to the mass_features attribute.</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a><span class="sd">        Notes</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a><span class="sd">        -----</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a><span class="sd">        drop_if_fail is useful for discarding mass features that do not have good shapes, usually due to a detection on a shoulder of a peak or a noisy region (especially if minimal smoothing is used during mass feature detection).</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>        <span class="c1"># Check if there is data</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>        <span class="k">if</span> <span class="n">ms_level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>            <span class="n">raw_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="p">[</span><span class="n">ms_level</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No MS level &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ms_level</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; data found&quot;</span><span class="p">)</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>            <span class="n">mf_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>                <span class="s2">&quot;No mass features found, did you run find_mass_features() first?&quot;</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>            <span class="p">)</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>        <span class="c1"># Check if mass_spectrum exists on each mass feature</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>            <span class="p">[</span><span class="n">mf</span><span class="o">.</span><span class="n">mass_spectrum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>        <span class="p">):</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>                <span class="s2">&quot;Mass spectrum must be associated with each mass feature, did you run add_associated_ms1() first?&quot;</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>            <span class="p">)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>        <span class="c1"># Subset scan data to only include correct ms_level</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>        <span class="n">scan_df_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_df</span><span class="p">[</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scan_df</span><span class="p">[</span><span class="s2">&quot;ms_level&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">ms_level</span><span class="p">)</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>        <span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>        <span class="k">if</span> <span class="n">scan_df_sub</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No MS level &quot;</span> <span class="o">+</span> <span class="n">ms_level</span> <span class="o">+</span> <span class="s2">&quot; data found in scan data&quot;</span><span class="p">)</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>        <span class="n">scan_df_sub</span> <span class="o">=</span> <span class="n">scan_df_sub</span><span class="p">[[</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>        <span class="n">mzs_to_extract</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>        <span class="n">mzs_to_extract</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>        <span class="c1"># Get EICs for each unique mz in mass features list</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>        <span class="k">for</span> <span class="n">mz</span> <span class="ow">in</span> <span class="n">mzs_to_extract</span><span class="p">:</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>            <span class="n">mz_max</span> <span class="o">=</span> <span class="n">mz</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">eic_tolerance_ppm</span> <span class="o">*</span> <span class="n">mz</span> <span class="o">/</span> <span class="mf">1e6</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>            <span class="n">mz_min</span> <span class="o">=</span> <span class="n">mz</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">eic_tolerance_ppm</span> <span class="o">*</span> <span class="n">mz</span> <span class="o">/</span> <span class="mf">1e6</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>            <span class="n">raw_data_sub</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>                <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">mz_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">mz_max</span><span class="p">)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>            <span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>            <span class="n">raw_data_sub</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>                <span class="n">raw_data_sub</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;scan&quot;</span><span class="p">])[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>            <span class="p">)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>            <span class="n">raw_data_sub</span> <span class="o">=</span> <span class="n">scan_df_sub</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">raw_data_sub</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>            <span class="n">raw_data_sub</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_data_sub</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>            <span class="n">myEIC</span> <span class="o">=</span> <span class="n">EIC_Data</span><span class="p">(</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>                <span class="n">scans</span><span class="o">=</span><span class="n">raw_data_sub</span><span class="p">[</span><span class="s2">&quot;scan&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>                <span class="n">time</span><span class="o">=</span><span class="n">raw_data_sub</span><span class="p">[</span><span class="s2">&quot;scan_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>                <span class="n">eic</span><span class="o">=</span><span class="n">raw_data_sub</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>            <span class="p">)</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>            <span class="c1"># Smooth EIC</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>            <span class="n">smoothed_eic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_tic</span><span class="p">(</span><span class="n">myEIC</span><span class="o">.</span><span class="n">eic</span><span class="p">)</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>            <span class="n">smoothed_eic</span><span class="p">[</span><span class="n">smoothed_eic</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>            <span class="n">myEIC</span><span class="o">.</span><span class="n">eic_smoothed</span> <span class="o">=</span> <span class="n">smoothed_eic</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eics</span><span class="p">[</span><span class="n">mz</span><span class="p">]</span> <span class="o">=</span> <span class="n">myEIC</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>        <span class="c1"># Get limits of mass features using EIC centroid detector and integrate</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>        <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mass_feature</span> <span class="ow">in</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>            <span class="n">mz</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">mz</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>            <span class="n">apex_scan</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">apex_scan</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>            <span class="c1"># Pull EIC data and find apex scan index</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>            <span class="n">myEIC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eics</span><span class="p">[</span><span class="n">mz</span><span class="p">]</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">_eic_data</span> <span class="o">=</span> <span class="n">myEIC</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>            <span class="n">apex_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">myEIC</span><span class="o">.</span><span class="n">scans</span> <span class="o">==</span> <span class="n">apex_scan</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>            <span class="c1"># Find left and right limits of peak using EIC centroid detector, add to EICData</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>            <span class="n">centroid_eics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eic_centroid_detector</span><span class="p">(</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>                <span class="n">myEIC</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>                <span class="n">myEIC</span><span class="o">.</span><span class="n">eic_smoothed</span><span class="p">,</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">intensity</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>                <span class="n">apex_indexes</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">apex_index</span><span class="p">)],</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>            <span class="p">)</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>            <span class="n">l_a_r_scan_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">centroid_eics</span><span class="p">]</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_a_r_scan_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>                <span class="c1"># Add start and final scan to mass_features and EICData</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>                <span class="n">left_scan</span><span class="p">,</span> <span class="n">right_scan</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>                    <span class="n">myEIC</span><span class="o">.</span><span class="n">scans</span><span class="p">[</span><span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>                    <span class="n">myEIC</span><span class="o">.</span><span class="n">scans</span><span class="p">[</span><span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]],</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>                <span class="p">)</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>                <span class="n">mf_scan_apex</span> <span class="o">=</span> <span class="p">[(</span><span class="n">left_scan</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">apex_scan</span><span class="p">),</span> <span class="n">right_scan</span><span class="p">)]</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>                <span class="n">myEIC</span><span class="o">.</span><span class="n">apexes</span> <span class="o">=</span> <span class="n">myEIC</span><span class="o">.</span><span class="n">apexes</span> <span class="o">+</span> <span class="n">mf_scan_apex</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">start_scan</span> <span class="o">=</span> <span class="n">left_scan</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">final_scan</span> <span class="o">=</span> <span class="n">right_scan</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>                <span class="c1"># Find area under peak using limits from EIC centroid detector, add to mass_features and EICData</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>                <span class="n">area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>                    <span class="n">myEIC</span><span class="o">.</span><span class="n">eic_smoothed</span><span class="p">[</span><span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>                    <span class="n">myEIC</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>                <span class="p">)</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>                <span class="n">mf_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>                <span class="n">myEIC</span><span class="o">.</span><span class="n">areas</span> <span class="o">=</span> <span class="n">myEIC</span><span class="o">.</span><span class="n">areas</span> <span class="o">+</span> <span class="p">[</span><span class="n">area</span><span class="p">]</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">eics</span><span class="p">[</span><span class="n">mz</span><span class="p">]</span> <span class="o">=</span> <span class="n">myEIC</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">_area</span> <span class="o">=</span> <span class="n">area</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>                <span class="k">if</span> <span class="n">drop_if_fail</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>        <span class="k">if</span> <span class="n">drop_duplicates</span><span class="p">:</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>            <span class="c1"># Prepare mass feature dataframe</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>            <span class="n">mf_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>            <span class="c1"># For each mass feature, find all mass features within the clustering tolerance ppm and drop if their start and end times are within another mass feature</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>            <span class="c1"># Kepp the first mass fea</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mass_feature</span> <span class="ow">in</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>                <span class="n">mz</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">mz</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>                <span class="n">apex_scan</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">apex_scan</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>                <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mz_diff_ppm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mz</span><span class="p">)</span> <span class="o">/</span> <span class="n">mz</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>                <span class="n">mf_df_sub</span> <span class="o">=</span> <span class="n">mf_df</span><span class="p">[</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>                    <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mz_diff_ppm&quot;</span><span class="p">]</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>                    <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_mz_tolerance_rel</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>                    <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>                <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>                <span class="c1"># For all mass features within the clustering tolerance, check if the start and end times are within the start and end times of the mass feature</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>                <span class="k">for</span> <span class="n">idx2</span><span class="p">,</span> <span class="n">mass_feature2</span> <span class="ow">in</span> <span class="n">mf_df_sub</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>                    <span class="k">if</span> <span class="n">idx2</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">:</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>                        <span class="k">if</span> <span class="p">(</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>                            <span class="n">mass_feature2</span><span class="o">.</span><span class="n">start_scan</span> <span class="o">&gt;=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">start_scan</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>                            <span class="ow">and</span> <span class="n">mass_feature2</span><span class="o">.</span><span class="n">final_scan</span> <span class="o">&lt;=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">final_scan</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>                        <span class="p">):</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>                            <span class="k">if</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx2</span><span class="p">)</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>    <span class="k">def</span> <span class="nf">find_c13_mass_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Mark likely C13 isotopes and connect to monoisoitopic mass features.</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a><span class="sd">        Returns</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a><span class="sd">        -------</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a><span class="sd">        None, but populates the monoisotopic_mf_id and isotopologue_type attributes to the indivual LCMSMassFeatures within the mass_features attribute of the LCMSBase object.</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a><span class="sd">        Raises</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a><span class="sd">        ------</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a><span class="sd">        ValueError</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a><span class="sd">            If no mass features are found.</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;evaluating mass features for C13 isotopes&quot;</span><span class="p">)</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No mass features found, run find_mass_features() first&quot;</span><span class="p">)</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>        <span class="c1"># Data prep fo sparse distance matrix</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>        <span class="c1"># Drop mass features that have no area (these are likely to be noise)</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df</span><span class="p">[</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>        <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mf_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>        <span class="c1"># Sort my ascending mz so we always get the monoisotopic mass first, regardless of the order/intensity of the mass features</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>        <span class="n">mz_diff</span> <span class="o">=</span> <span class="mf">1.003355</span>  <span class="c1"># C13-C12 mass difference</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>        <span class="n">tol</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>            <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_mz_tolerance_rel</span><span class="p">,</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_rt_tolerance</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>        <span class="p">]</span>  <span class="c1"># mz, in relative; scan_time in minutes</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>        <span class="c1"># Compute inter-feature distances</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)):</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>            <span class="c1"># Construct k-d tree</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>            <span class="n">values</span> <span class="o">=</span> <span class="n">mf_df</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>            <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>            <span class="n">max_tol</span> <span class="o">=</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>            <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mz&quot;</span><span class="p">:</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>                <span class="c1"># Maximum absolute tolerance</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>                <span class="n">max_tol</span> <span class="o">=</span> <span class="n">mz_diff</span> <span class="o">+</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>            <span class="c1"># Compute sparse distance matrix</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>            <span class="c1"># the larger the max_tol, the slower this operation is</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>            <span class="n">sdm</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">sparse_distance_matrix</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">max_tol</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;coo_matrix&quot;</span><span class="p">)</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>            <span class="c1"># Only consider forward case, exclude diagonal</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>            <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">sdm</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>            <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mz&quot;</span><span class="p">:</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>                <span class="n">min_tol</span> <span class="o">=</span> <span class="n">mz_diff</span> <span class="o">-</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>                <span class="c1"># Get only the ones that are above the min tol</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>                <span class="n">idx</span> <span class="o">=</span> <span class="n">sdm</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">min_tol</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>                <span class="c1"># Reconstruct sparse distance matrix</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>                <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">(</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>                    <span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">sdm</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">idx</span><span class="p">])),</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>                    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>                <span class="p">)</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>            <span class="c1"># Cast as binary matrix</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>            <span class="n">sdm</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>            <span class="c1"># Stack distances</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>            <span class="k">if</span> <span class="n">distances</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>                <span class="n">distances</span> <span class="o">=</span> <span class="n">sdm</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>                <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sdm</span><span class="p">)</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>        <span class="c1"># Extract indices of within-tolerance points</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">tocoo</span><span class="p">()</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>        <span class="n">pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">distances</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">distances</span><span class="o">.</span><span class="n">col</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># C12 to C13 pairs</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>        <span class="c1"># Turn pairs (which are index of mf_df) into mf_id and then into two dataframes to join to mf_df</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>        <span class="n">pairs_mf</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>        <span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">mf_id</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>        <span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">mf_id</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>        <span class="c1"># Connect monoisotopic masses with isotopologes within mass_features</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>        <span class="n">monos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>        <span class="k">for</span> <span class="n">mono</span> <span class="ow">in</span> <span class="n">monos</span><span class="p">:</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">mono</span><span class="p">]</span><span class="o">.</span><span class="n">monoisotopic_mf_id</span> <span class="o">=</span> <span class="n">mono</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>        <span class="n">pairs_iso_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pairs_mf</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;parent&quot;</span><span class="p">,</span> <span class="s2">&quot;child&quot;</span><span class="p">])</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>            <span class="n">pairs_iso_df</span> <span class="o">=</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>            <span class="n">m1_isos</span> <span class="o">=</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">monos</span><span class="p">,</span> <span class="s2">&quot;child&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>            <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">m1_isos</span><span class="p">:</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>                <span class="c1"># Set monoisotopic_mf_id and isotopologue_type for isotopologues</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>                <span class="n">parent</span> <span class="o">=</span> <span class="n">pairs_mf</span><span class="p">[</span><span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">iso</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>                    <span class="c1"># Choose the parent that is closest in time to the isotopologue</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>                    <span class="n">parent_time</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">retention_time</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parent</span><span class="p">]</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>                    <span class="n">time_diff</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">retention_time</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parent_time</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>                    <span class="p">]</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>                    <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">time_diff</span><span class="p">)]</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>                    <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">monoisotopic_mf_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>                    <span class="n">parent</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>                <span class="p">]</span><span class="o">.</span><span class="n">monoisotopic_mf_id</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">monoisotopic_mf_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>                    <span class="n">mass_diff</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">mz</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>                        <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">monoisotopic_mf_id</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>                        <span class="p">]</span><span class="o">.</span><span class="n">mz</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>                    <span class="p">)</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">isotopologue_type</span> <span class="o">=</span> <span class="s2">&quot;13C&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">mass_diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>                    <span class="p">)</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>            <span class="c1"># Drop the mono and iso from the pairs_iso_df</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>            <span class="n">pairs_iso_df</span> <span class="o">=</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>                <span class="n">index</span><span class="o">=</span><span class="n">monos</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>            <span class="p">)</span>  <span class="c1"># Drop pairs where the parent is a child that is a child of a root</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>            <span class="n">pairs_iso_df</span> <span class="o">=</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;child&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>            <span class="n">pairs_iso_df</span> <span class="o">=</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">m1_isos</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>                <span class="c1"># Get new monos, recognizing that these are just 13C isotopologues that are connected to other 13C isotopologues to repeat the process</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>                <span class="n">monos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">parent</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">child</span><span class="p">)</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>                <span class="p">)</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>            <span class="c1"># Report fraction of compounds annotated with isotopes</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>            <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;c13_flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mf_id&quot;</span><span class="p">],</span> <span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mf_id&quot;</span><span class="p">],</span> <span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>                <span class="p">),</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>                <span class="mi">1</span><span class="p">,</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>                <span class="mi">0</span><span class="p">,</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>            <span class="p">)</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>                <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf_df</span><span class="p">[</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;c13_flag&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mf_df</span><span class="p">),</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>                <span class="o">+</span> <span class="s2">&quot; of mass features have or are C13 isotopes&quot;</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>            <span class="p">)</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>    <span class="k">def</span> <span class="nf">deconvolute_ms1_mass_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Deconvolute MS1 mass features</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a><span class="sd">        Deconvolute mass features ms1 spectrum based on the correlation of all masses within a spectrum over the EIC of the mass features</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a><span class="sd">        Parameters</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a><span class="sd">        ----------</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a><span class="sd">        None</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a><span class="sd">        Returns</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a><span class="sd">        -------</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a><span class="sd">        None, but assigns the _ms_deconvoluted_idx, mass_spectrum_deconvoluted_parent,</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a><span class="sd">        and associated_mass_features_deconvoluted attributes to the mass features in the</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a><span class="sd">        mass_features attribute of the LCMSBase object.</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="sd">        Raises</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="sd">        ------</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a><span class="sd">        ValueError</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a><span class="sd">            If no mass features are found, must run find_mass_features() first.</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">            If no EICs are found, did you run integrate_mass_features() first?</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>        <span class="c1"># Checks for set mass_features and eics</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>                <span class="s2">&quot;No mass features found, did you run find_mass_features() first?&quot;</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>            <span class="p">)</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eics</span> <span class="o">==</span> <span class="p">{}:</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>                <span class="s2">&quot;No EICs found, did you run integrate_mass_features() first?&quot;</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>            <span class="p">)</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>        <span class="k">if</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No unprocessed MS1 spectra found.&quot;</span><span class="p">)</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>        <span class="c1"># Prep ms1 data</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>        <span class="n">ms1_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>        <span class="n">ms1_data</span> <span class="o">=</span> <span class="n">ms1_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;scan&quot;</span><span class="p">)</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>        <span class="c1"># Prep mass feature summary</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>        <span class="n">mass_feature_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>        <span class="c1"># Loop through each mass feature</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>        <span class="k">for</span> <span class="n">mf_id</span><span class="p">,</span> <span class="n">mass_feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>            <span class="c1"># Check that the mass_feature.mz attribute == the mz of the mass feature in the mass_feature_df</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>            <span class="k">if</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">mz</span> <span class="o">!=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">ms1_peak</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">:</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>                <span class="k">continue</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>            <span class="c1"># Get the left and right limits of the EIC of the mass feature</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>            <span class="n">l_scan</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">r_scan</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">_eic_data</span><span class="o">.</span><span class="n">apexes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>            <span class="c1"># Pull from the _ms1_unprocessed data the scan range of interest and sort by mz</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>            <span class="n">ms1_data_sub</span> <span class="o">=</span> <span class="n">ms1_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l_scan</span><span class="p">:</span><span class="n">r_scan</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>            <span class="n">ms1_data_sub</span> <span class="o">=</span> <span class="n">ms1_data_sub</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>            <span class="c1"># Get the centroided masses of the mass feature</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>            <span class="n">mf_mspeak_mzs</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="o">.</span><span class="n">mz_exp</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>            <span class="c1"># Find the closest mz in the ms1 data to the centroided masses of the mass feature</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>            <span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mass_feature_mz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mf_mspeak_mzs</span><span class="p">[</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>                <span class="n">find_closest</span><span class="p">(</span><span class="n">mf_mspeak_mzs</span><span class="p">,</span> <span class="n">ms1_data_sub</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>            <span class="p">]</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>            <span class="c1"># Drop rows with mz_diff &gt; 0.01 between the mass feature mz and the ms1 data mz</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>            <span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mz_diff_rel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mass_feature_mz&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>                <span class="o">/</span> <span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>            <span class="p">)</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>            <span class="n">ms1_data_sub</span> <span class="o">=</span> <span class="n">ms1_data_sub</span><span class="p">[</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>                <span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mz_diff_rel&quot;</span><span class="p">]</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>                <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_mz_tolerance_rel</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>            <span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>            <span class="c1"># Group by mass_feature_mz and scan and sum intensity</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>            <span class="n">ms1_data_sub_group</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>                <span class="n">ms1_data_sub</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;mass_feature_mz&quot;</span><span class="p">,</span> <span class="s2">&quot;scan&quot;</span><span class="p">])[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>                <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>                <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>            <span class="p">)</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>            <span class="c1"># Calculate the correlation of the intensities of the mass feature and the ms1 data (set to 0 if no intensity)</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>            <span class="n">corr</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>                <span class="n">ms1_data_sub_group</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>                    <span class="n">index</span><span class="o">=</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;mass_feature_mz&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>                <span class="p">)</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>                <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>                <span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>            <span class="p">)</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>            <span class="c1"># Subset the correlation matrix to only include the masses of the mass feature and those with a correlation &gt; 0.8</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>            <span class="n">decon_corr_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ms1_deconvolution_corr_min</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>            <span class="n">corr_subset</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mass_feature</span><span class="o">.</span><span class="n">mz</span><span class="p">,]</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>            <span class="n">corr_subset</span> <span class="o">=</span> <span class="n">corr_subset</span><span class="p">[</span><span class="n">corr_subset</span> <span class="o">&gt;</span> <span class="n">decon_corr_min</span><span class="p">]</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>            <span class="c1"># Get the masses from the mass spectrum that are the result of the deconvolution</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>            <span class="n">mzs_decon</span> <span class="o">=</span> <span class="n">corr_subset</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>            <span class="c1"># Get the indices of the mzs_decon in mass_feature.mass_spectrum.mz_exp and assign to the mass feature</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>            <span class="n">mzs_decon_idx</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>                <span class="nb">id</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>                <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">mz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mass_feature</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">)</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>                <span class="k">if</span> <span class="n">mz</span> <span class="ow">in</span> <span class="n">mzs_decon</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>            <span class="p">]</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>            <span class="n">mass_feature</span><span class="o">.</span><span class="n">_ms_deconvoluted_idx</span> <span class="o">=</span> <span class="n">mzs_decon_idx</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>            <span class="c1"># Check if the mass feature&#39;s ms1 peak is the largest in the deconvoluted mass spectrum</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">ms1_peak</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>                <span class="o">==</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="o">.</span><span class="n">abundance</span><span class="p">[</span><span class="n">mzs_decon_idx</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>            <span class="p">):</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">mass_spectrum_deconvoluted_parent</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">mass_spectrum_deconvoluted_parent</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>            <span class="c1"># Check for other mass features that are in the deconvoluted mass spectrum and add the deconvoluted mass spectrum to the mass feature</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>            <span class="c1"># Subset mass_feature_df to only include mass features that are within the clustering tolerance</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>            <span class="n">mass_feature_df_sub</span> <span class="o">=</span> <span class="n">mass_feature_df</span><span class="p">[</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>                <span class="nb">abs</span><span class="p">(</span><span class="n">mass_feature</span><span class="o">.</span><span class="n">retention_time</span> <span class="o">-</span> <span class="n">mass_feature_df</span><span class="p">[</span><span class="s2">&quot;scan_time&quot;</span><span class="p">])</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>                <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_rt_tolerance</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>            <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>            <span class="c1"># Calculate the mz difference in ppm between the mass feature and the peaks in the deconvoluted mass spectrum</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>            <span class="n">mass_feature_df_sub</span><span class="p">[</span><span class="s2">&quot;mz_diff_ppm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mzs_decon</span> <span class="o">-</span> <span class="n">mz</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">/</span> <span class="n">mz</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>                <span class="k">for</span> <span class="n">mz</span> <span class="ow">in</span> <span class="n">mass_feature_df_sub</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>            <span class="p">]</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>            <span class="c1"># Subset mass_feature_df to only include mass features that are within 1 ppm of the deconvoluted masses</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>            <span class="n">mfs_associated_decon</span> <span class="o">=</span> <span class="n">mass_feature_df_sub</span><span class="p">[</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>                <span class="n">mass_feature_df_sub</span><span class="p">[</span><span class="s2">&quot;mz_diff_ppm&quot;</span><span class="p">]</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>                <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_mz_tolerance_rel</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>            <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>            <span class="n">mass_feature</span><span class="o">.</span><span class="n">associated_mass_features_deconvoluted</span> <span class="o">=</span> <span class="n">mfs_associated_decon</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a><span class="k">class</span> <span class="nc">PHCalculations</span><span class="p">:</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Methods for performing calculations related to 2D peak picking via persistent homology on LCMS data.</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a><span class="sd">    Notes</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a><span class="sd">    -----</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a><span class="sd">    This class is intended to be used as a mixin for the LCMSBase class.</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a><span class="sd">    Methods</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a><span class="sd">    -------</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a><span class="sd">    * sparse_mean_filter(idx, V, radius=[0, 1, 1]).</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a><span class="sd">        Sparse implementation of a mean filter.</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a><span class="sd">    * embed_unique_indices(a).</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a><span class="sd">        Creates an array of indices, sorted by unique element.</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a><span class="sd">    * sparse_upper_star(idx, V).</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a><span class="sd">        Sparse implementation of an upper star filtration.</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a><span class="sd">    * check_if_grid(data).</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a><span class="sd">        Check if the data is gridded in mz space.</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a><span class="sd">    * grid_data(data).</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a><span class="sd">        Grid the data in the mz dimension.</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a><span class="sd">    * find_mass_features_ph(ms_level=1, grid=True).</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a><span class="sd">        Find mass features within an LCMSBase object using persistent homology.</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a><span class="sd">    * cluster_mass_features(drop_children=True).</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a><span class="sd">        Cluster regions of interest.</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>    <span class="k">def</span> <span class="nf">sparse_mean_filter</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sparse implementation of a mean filter.</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a><span class="sd">        Parameters</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a><span class="sd">        ----------</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a><span class="sd">        idx : :obj:`~numpy.array`</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a><span class="sd">            Edge indices for each dimension (MxN).</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a><span class="sd">        V : :obj:`~numpy.array`</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a><span class="sd">            Array of intensity data (Mx1).</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a><span class="sd">        radius : float or list</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a><span class="sd">            Radius of the sparse filter in each dimension. Values less than</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a><span class="sd">            zero indicate no connectivity in that dimension.</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a><span class="sd">        Returns</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a><span class="sd">        -------</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a><span class="sd">        :obj:`~numpy.array`</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a><span class="sd">            Filtered intensities (Mx1).</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a><span class="sd">        Notes</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a><span class="sd">        -----</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a><span class="sd">        This function has been adapted from the original implementation in the Deimos package: https://github.com/pnnl/deimos.</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a><span class="sd">        This is a static method.</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>        <span class="c1"># Copy indices</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>        <span class="c1"># Scale</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">radius</span><span class="p">):</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>            <span class="c1"># Increase inter-index distance</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>            <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>                <span class="n">idx</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>            <span class="c1"># Do nothing</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>            <span class="k">elif</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>                <span class="k">pass</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>            <span class="c1"># Decrease inter-index distance</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>                <span class="n">idx</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">r</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>        <span class="c1"># Connectivity matrix</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>        <span class="n">cmat</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>        <span class="n">cmat</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">sparse_distance_matrix</span><span class="p">(</span><span class="n">cmat</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;coo_matrix&quot;</span><span class="p">)</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>        <span class="n">cmat</span><span class="o">.</span><span class="n">setdiag</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>        <span class="c1"># Pair indices</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>        <span class="n">I</span><span class="p">,</span> <span class="n">J</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>        <span class="c1"># Delete cmat</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>        <span class="n">cmat_shape</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>        <span class="k">del</span> <span class="n">cmat</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>        <span class="c1"># Sum over columns</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>        <span class="n">V_sum</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">bsr_matrix</span><span class="p">(</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>            <span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">I</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="n">cmat_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">V</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>        <span class="c1"># Count over columns</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>        <span class="n">V_count</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">bsr_matrix</span><span class="p">(</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">J</span><span class="p">),</span> <span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">I</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="n">cmat_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">V</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>        <span class="k">return</span> <span class="n">V_sum</span> <span class="o">/</span> <span class="n">V_count</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>    <span class="k">def</span> <span class="nf">embed_unique_indices</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates an array of indices, sorted by unique element.</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a><span class="sd">        Parameters</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a><span class="sd">        ----------</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a><span class="sd">        a : :obj:`~numpy.array`</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a><span class="sd">            Array of unique elements (Mx1).</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a><span class="sd">        Returns</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a><span class="sd">        -------</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a><span class="sd">        :obj:`~numpy.array`</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a><span class="sd">            Array of indices (Mx1).</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a><span class="sd">        Notes</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a><span class="sd">        -----</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a><span class="sd">        This function has been adapted from the original implementation in the Deimos package: https://github.com/pnnl/deimos</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a><span class="sd">        This is a static method.</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="k">def</span> <span class="nf">count_tens</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>            <span class="c1"># Count tens</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>            <span class="n">ntens</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>                <span class="n">ntens_test</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntens</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>                <span class="k">if</span> <span class="n">ntens_test</span> <span class="o">==</span> <span class="n">ntens</span><span class="p">:</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>                    <span class="k">return</span> <span class="n">ntens</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>                    <span class="n">ntens</span> <span class="o">=</span> <span class="n">ntens_test</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>        <span class="k">def</span> <span class="nf">arange_exclude_10s</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>            <span class="c1"># How many 10s will there be?</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>            <span class="n">ntens</span> <span class="o">=</span> <span class="n">count_tens</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>            <span class="c1"># Base array</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="n">ntens</span><span class="p">)</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>            <span class="c1"># Exclude 10s</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[(</span><span class="n">arr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">arr</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)][:</span><span class="n">n</span><span class="p">]</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>            <span class="k">return</span> <span class="n">arr</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>        <span class="c1"># Creates an array of indices, sorted by unique element</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>        <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>        <span class="n">idx_unsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">idx_sort</span><span class="p">)</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>        <span class="c1"># Sorts records array so all unique elements are together</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>        <span class="n">sorted_a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">]</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>        <span class="c1"># Returns the unique values, the index of the first occurrence,</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>        <span class="c1"># and the count for each element</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>        <span class="n">vals</span><span class="p">,</span> <span class="n">idx_start</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>            <span class="n">sorted_a</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>        <span class="p">)</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>        <span class="c1"># Splits the indices into separate arrays</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>        <span class="n">splits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">idx_sort</span><span class="p">,</span> <span class="n">idx_start</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>        <span class="c1"># Creates unique indices for each split</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>        <span class="n">idx_unq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">arange_exclude_10s</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">])</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>        <span class="c1"># Reorders according to input array</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>        <span class="n">idx_unq</span> <span class="o">=</span> <span class="n">idx_unq</span><span class="p">[</span><span class="n">idx_unsort</span><span class="p">]</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>        <span class="c1"># Magnitude of each index</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>        <span class="n">exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>            <span class="n">idx_unq</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">idx_unq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">idx_unq</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>        <span class="p">)</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>        <span class="n">idx_unq_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>        <span class="c1"># Result</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">idx_unq</span> <span class="o">/</span> <span class="n">idx_unq_mag</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>    <span class="k">def</span> <span class="nf">sparse_upper_star</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">V</span><span class="p">):</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sparse implementation of an upper star filtration.</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a><span class="sd">        Parameters</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a><span class="sd">        ----------</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a><span class="sd">        idx : :obj:`~numpy.array`</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a><span class="sd">            Edge indices for each dimension (MxN).</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a><span class="sd">        V : :obj:`~numpy.array`</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a><span class="sd">            Array of intensity data (Mx1).</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a><span class="sd">        Returns</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a><span class="sd">        -------</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a><span class="sd">        idx : :obj:`~numpy.array`</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a><span class="sd">            Index of filtered points (Mx1).</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a><span class="sd">        persistence : :obj:`~numpy.array`</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a><span class="sd">            Persistence of each filtered point (Mx1).</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a><span class="sd">        Notes</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a><span class="sd">        -----</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a><span class="sd">        This function has been adapted from the original implementation in the Deimos package: https://github.com/pnnl/deimos</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>        <span class="c1"># Invert</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">V</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>        <span class="c1"># Embed indices</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_unique_indices</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>        <span class="c1"># Connectivity matrix</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>        <span class="n">cmat</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>        <span class="n">cmat</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">sparse_distance_matrix</span><span class="p">(</span><span class="n">cmat</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;coo_matrix&quot;</span><span class="p">)</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>        <span class="n">cmat</span><span class="o">.</span><span class="n">setdiag</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>        <span class="n">cmat</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">cmat</span><span class="p">)</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>        <span class="c1"># Pairwise minimums</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>        <span class="n">I</span><span class="p">,</span> <span class="n">J</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">V</span><span class="p">[</span><span class="n">J</span><span class="p">])</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>        <span class="c1"># Delete connectiity matrix</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>        <span class="n">cmat_shape</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>        <span class="k">del</span> <span class="n">cmat</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>        <span class="c1"># Sparse distance matrix</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>        <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="n">cmat_shape</span><span class="p">)</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>        <span class="c1"># Delete pairwise mins</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>        <span class="k">del</span> <span class="n">d</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">J</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>        <span class="c1"># Persistence homology</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>        <span class="n">ph</span> <span class="o">=</span> <span class="n">ripser</span><span class="p">(</span><span class="n">sdm</span><span class="p">,</span> <span class="n">distance_matrix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maxdim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="s2">&quot;dgms&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>        <span class="c1"># Bound death values</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>        <span class="n">ph</span><span class="p">[</span><span class="n">ph</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>        <span class="c1"># Construct tree to query against</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>        <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>        <span class="c1"># Get the indexes of the first nearest neighbor by birth</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">nn</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ph</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">workers</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>        <span class="k">return</span> <span class="n">nn</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">ph</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ph</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>    <span class="k">def</span> <span class="nf">check_if_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the data are gridded in mz space.</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a><span class="sd">        Parameters</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a><span class="sd">        ----------</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a><span class="sd">        data : DataFrame</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a><span class="sd">            DataFrame containing the mass spectrometry data.  Needs to have mz and scan columns.</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a><span class="sd">        Returns</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a><span class="sd">        -------</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a><span class="sd">        bool</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a><span class="sd">            True if the data is gridded in the mz direction, False otherwise.</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a><span class="sd">        Notes</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a><span class="sd">        -----</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a><span class="sd">        This function is used within the grid_data function and the find_mass_features function and is not intended to be called directly.</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>        <span class="c1"># Calculate the difference between consecutive mz values in a single scan</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>        <span class="n">dat_check</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>        <span class="n">dat_check</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dat_check</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">())</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>        <span class="n">mz_diff_min</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>            <span class="n">dat_check</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;scan&quot;</span><span class="p">)[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>        <span class="p">)</span>  <span class="c1"># within each scan, what is the smallest mz difference between consecutive mz values</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>        <span class="c1"># Find the mininum mz difference between mz values in the data; regardless of scan</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>        <span class="n">dat_check_mz</span> <span class="o">=</span> <span class="n">dat_check</span><span class="p">[[</span><span class="s2">&quot;mz&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>        <span class="n">dat_check_mz</span> <span class="o">=</span> <span class="n">dat_check_mz</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>        <span class="n">dat_check_mz</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dat_check_mz</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">())</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>        <span class="c1"># Get minimum mz_diff between mz values in the data</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>        <span class="n">mz_diff_min_raw</span> <span class="o">=</span> <span class="n">dat_check_mz</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>        <span class="c1"># If the minimum mz difference between mz values in the data is less than the minimum mz difference between mz values within a single scan, then the data is not gridded</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>        <span class="k">if</span> <span class="n">mz_diff_min_raw</span> <span class="o">&lt;</span> <span class="n">mz_diff_min</span><span class="p">:</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>    <span class="k">def</span> <span class="nf">grid_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Grid the data in the mz dimension.</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a><span class="sd">        Data must be gridded prior to persistent homology calculations.</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a><span class="sd">        Parameters</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a><span class="sd">        ----------</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a><span class="sd">        data : DataFrame</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a><span class="sd">            The input data containing mz, scan, scan_time, and intensity columns.</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a><span class="sd">        Returns</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a><span class="sd">        -------</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a><span class="sd">        DataFrame</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a><span class="sd">            The gridded data with mz, scan, scan_time, and intensity columns.</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a><span class="sd">        Raises</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a><span class="sd">        ------</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a><span class="sd">        ValueError</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a><span class="sd">            If gridding fails.</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>        <span class="c1"># Calculate the difference between consecutive mz values in a single scan for grid spacing</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>        <span class="n">data_w</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>        <span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">())</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>        <span class="n">mz_diff_min</span> <span class="o">=</span> <span class="n">data_w</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;scan&quot;</span><span class="p">)[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.99999</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>        <span class="c1"># Need high intensity mz values first so they are parents in the output pairs stack</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>        <span class="n">dat_mz</span> <span class="o">=</span> <span class="n">data_w</span><span class="p">[[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;intensity&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>            <span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>        <span class="p">)</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>        <span class="n">dat_mz</span> <span class="o">=</span> <span class="n">dat_mz</span><span class="p">[[</span><span class="s2">&quot;mz&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>        <span class="c1"># Construct KD tree</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>        <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">dat_mz</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>        <span class="n">sdm</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">sparse_distance_matrix</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">mz_diff_min</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;coo_matrix&quot;</span><span class="p">)</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>        <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">sdm</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>        <span class="n">sdm</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="n">sdm</span><span class="o">.</span><span class="n">tocoo</span><span class="p">()</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>        <span class="n">pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">distances</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">distances</span><span class="o">.</span><span class="n">col</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>        <span class="c1"># Cull pairs to just get root</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>        <span class="n">to_drop</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>            <span class="n">root_parents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>            <span class="n">id_root_parents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">root_parents</span><span class="p">)</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>            <span class="n">children_of_roots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs</span><span class="p">[</span><span class="n">id_root_parents</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>            <span class="n">to_drop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to_drop</span><span class="p">,</span> <span class="n">children_of_roots</span><span class="p">)</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>            <span class="c1"># Set up pairs array for next iteration by removing pairs with children or parents already dropped</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>            <span class="n">pairs</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">to_drop</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>            <span class="n">pairs</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">to_drop</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>        <span class="n">dat_mz</span> <span class="o">=</span> <span class="n">dat_mz</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">to_drop</span><span class="p">))</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>        <span class="n">mz_dat_np</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>            <span class="n">dat_mz</span><span class="p">[[</span><span class="s2">&quot;mz&quot;</span><span class="p">]]</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>            <span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>        <span class="p">)</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>        <span class="c1"># Sort data by mz and recast mz to nearest value in mz_dat_np</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>        <span class="n">data_w</span> <span class="o">=</span> <span class="n">data_w</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>        <span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz_new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mz_dat_np</span><span class="p">[</span><span class="n">find_closest</span><span class="p">(</span><span class="n">mz_dat_np</span><span class="p">,</span> <span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>        <span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz_new&quot;</span><span class="p">])</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>        <span class="c1"># Rename mz_new as mz; drop mz_diff; groupby scan and mz and sum intensity</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>        <span class="n">new_data_w</span> <span class="o">=</span> <span class="n">data_w</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mz&quot;</span><span class="p">:</span> <span class="s2">&quot;mz_orig&quot;</span><span class="p">,</span> <span class="s2">&quot;mz_new&quot;</span><span class="p">:</span> <span class="s2">&quot;mz&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>        <span class="n">new_data_w</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>            <span class="n">new_data_w</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">,</span> <span class="s2">&quot;mz_orig&quot;</span><span class="p">])</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="s2">&quot;mz&quot;</span><span class="p">])[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>        <span class="p">)</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>        <span class="n">new_data_w</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>            <span class="n">new_data_w</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="s2">&quot;mz&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>            <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>        <span class="p">)</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>        <span class="c1"># Check if grid worked and return</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_grid</span><span class="p">(</span><span class="n">new_data_w</span><span class="p">):</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>            <span class="k">return</span> <span class="n">new_data_w</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Gridding failed&quot;</span><span class="p">)</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>    <span class="k">def</span> <span class="nf">find_mass_features_ph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find mass features within an LCMSBase object using persistent homology.</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a><span class="sd">        Assigns the mass_features attribute to the object (a dictionary of LCMSMassFeature objects, keyed by mass feature id)</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a><span class="sd">        Parameters</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a><span class="sd">        ----------</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a><span class="sd">        ms_level : int, optional</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a><span class="sd">            The MS level to use. Default is 1.</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a><span class="sd">        grid : bool, optional</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a><span class="sd">            If True, will regrid the data before running the persistent homology calculations (after checking if the data is gridded). Default is True.</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a><span class="sd">        Raises</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a><span class="sd">        ------</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a><span class="sd">        ValueError</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a><span class="sd">            If no MS level data is found on the object.</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a><span class="sd">            If data is not gridded and grid is False.</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a><span class="sd">        Returns</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a><span class="sd">        -------</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a><span class="sd">        None, but assigns the mass_features attribute to the object.</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a><span class="sd">        Notes</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a><span class="sd">        -----</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a><span class="sd">        This function has been adapted from the original implementation in the Deimos package: https://github.com/pnnl/deimos</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>        <span class="c1"># Check that ms_level is a key in self._ms_uprocessed</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>        <span class="k">if</span> <span class="n">ms_level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>                <span class="s2">&quot;No MS level &quot;</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ms_level</span><span class="p">)</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>                <span class="o">+</span> <span class="s2">&quot; data found, did you instantiate with parser specific to MS level?&quot;</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>            <span class="p">)</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>        <span class="c1"># Get ms data</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="p">[</span><span class="n">ms_level</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>        <span class="c1"># Drop rows with missing intensity values and reset index</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>        <span class="c1"># Threshold data</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ph_inten_min_rel</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">intensity</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>        <span class="n">data_thres</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>        <span class="c1"># Check if gridded, if not, grid</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>        <span class="n">gridded_mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_grid</span><span class="p">(</span><span class="n">data_thres</span><span class="p">)</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>        <span class="k">if</span> <span class="n">gridded_mz</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>            <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>                    <span class="s2">&quot;Data are not gridded in mz dimension, try reprocessing with a different params or grid data before running this function&quot;</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>                <span class="p">)</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>                <span class="n">data_thres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span><span class="p">(</span><span class="n">data_thres</span><span class="p">)</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>        <span class="c1"># Add build factors and add scan_time</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>        <span class="n">data_thres</span> <span class="o">=</span> <span class="n">data_thres</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_df</span><span class="p">[[</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;scan&quot;</span><span class="p">)</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>        <span class="n">factors</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>            <span class="n">dim</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">factorize</span><span class="p">(</span><span class="n">data_thres</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dims</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>        <span class="p">}</span>  <span class="c1"># this is return a float64 index</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>        <span class="c1"># Build indexes</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>            <span class="n">dim</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">factors</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="n">data_thres</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">factors</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>        <span class="p">}</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>        <span class="c1"># Smooth data</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>        <span class="n">iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ph_smooth_it</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>        <span class="n">smooth_radius</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ph_smooth_radius_mz</span><span class="p">,</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ph_smooth_radius_scan</span><span class="p">,</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>        <span class="p">]</span>  <span class="c1"># mz, scan_time smoothing radius (in steps)</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">index</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="n">data_thres</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>        <span class="n">resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>            <span class="c1"># Previous iteration</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>            <span class="n">V_prev</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>            <span class="n">resid_prev</span> <span class="o">=</span> <span class="n">resid</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>            <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_mean_filter</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">smooth_radius</span><span class="p">)</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>            <span class="c1"># Calculate residual with previous iteration</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>            <span class="n">resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">V</span> <span class="o">-</span> <span class="n">V_prev</span><span class="p">)))</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>            <span class="c1"># Evaluate convergence</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>                <span class="c1"># Percent change in residual</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>                <span class="n">test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">resid</span> <span class="o">-</span> <span class="n">resid_prev</span><span class="p">)</span> <span class="o">/</span> <span class="n">resid_prev</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>                <span class="c1"># Exit criteria</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>                <span class="k">if</span> <span class="n">test</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>                    <span class="k">break</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>        <span class="c1"># Overwrite values</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>        <span class="n">data_thres</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">V</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>        <span class="c1"># Use persistent homology to find regions of interest</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>        <span class="n">pidx</span><span class="p">,</span> <span class="n">pers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_upper_star</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>        <span class="n">pidx</span> <span class="o">=</span> <span class="n">pidx</span><span class="p">[</span><span class="n">pers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>        <span class="n">pers</span> <span class="o">=</span> <span class="n">pers</span><span class="p">[</span><span class="n">pers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>        <span class="c1"># Get peaks</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>        <span class="n">peaks</span> <span class="o">=</span> <span class="n">data_thres</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pidx</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>        <span class="c1"># Add persistence column</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>        <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;persistence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pers</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>        <span class="n">mass_features</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>            <span class="n">by</span><span class="o">=</span><span class="s2">&quot;persistence&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>        <span class="c1"># Filter by persistence threshold</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>        <span class="n">persistence_threshold</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ph_persis_min_rel</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">intensity</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>        <span class="p">)</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>        <span class="n">mass_features</span> <span class="o">=</span> <span class="n">mass_features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>            <span class="n">mass_features</span><span class="p">[</span><span class="s2">&quot;persistence&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">persistence_threshold</span><span class="p">,</span> <span class="p">:</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>        <span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>        <span class="c1"># Rename scan column to apex_scan</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>        <span class="n">mass_features</span> <span class="o">=</span> <span class="n">mass_features</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;scan&quot;</span><span class="p">:</span> <span class="s2">&quot;apex_scan&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">:</span> <span class="s2">&quot;retention_time&quot;</span><span class="p">}</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>        <span class="p">)</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>        <span class="c1"># Populate mass_features attribute</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">mass_features</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>            <span class="n">row_dict</span> <span class="o">=</span> <span class="n">mass_features</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>            <span class="n">lcms_feature</span> <span class="o">=</span> <span class="n">LCMSMassFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">row_dict</span><span class="p">)</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">lcms_feature</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">lcms_feature</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">verbose_processing</span><span class="p">:</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mass_features</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; initial mass features&quot;</span><span class="p">)</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>    <span class="k">def</span> <span class="nf">cluster_mass_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drop_children</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="s2">&quot;persistence&quot;</span><span class="p">):</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Cluster mass features</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a><span class="sd">        Based on their proximity in the mz and scan_time dimensions, priorizies the mass features with the highest persistence.</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a><span class="sd">        Parameters</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a><span class="sd">        ----------</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a><span class="sd">        drop_children : bool, optional</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a><span class="sd">            Whether to drop the mass features that are not cluster parents. Default is True.</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a><span class="sd">        sort_by : str, optional</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a><span class="sd">            The column to sort the mass features by, this will determine which mass features get rolled up into a parent mass feature. Default is &quot;persistence&quot;.</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a><span class="sd">        Raises</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a><span class="sd">        ------</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a><span class="sd">        ValueError</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a><span class="sd">            If no mass features are found.</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a><span class="sd">            If too many mass features are found.</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a><span class="sd">        Returns</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a><span class="sd">        -------</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a><span class="sd">        None if drop_children is True, otherwise returns a list of mass feature ids that are not cluster parents.</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No mass features found, run find_mass_features() first&quot;</span><span class="p">)</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">400000</span><span class="p">:</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>                <span class="s2">&quot;Too many mass featuers of interest found, run find_mass_features() with a higher intensity threshold&quot;</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>            <span class="p">)</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>        <span class="n">mf_df_og</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df_og</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>        <span class="c1"># Sort mass features by sort_by column, make mf_id its own column for easier bookkeeping</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">sort_by</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>        <span class="n">tol</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_mz_tolerance_rel</span><span class="p">,</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_rt_tolerance</span><span class="p">,</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>        <span class="p">]</span>  <span class="c1"># mz, in relative; scan_time in minutes</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>        <span class="n">relative</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>        <span class="c1"># Compute inter-feature distances</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)):</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>            <span class="c1"># Construct k-d tree</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>            <span class="n">values</span> <span class="o">=</span> <span class="n">mf_df</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>            <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>            <span class="n">max_tol</span> <span class="o">=</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>            <span class="k">if</span> <span class="n">relative</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>                <span class="c1"># Maximum absolute tolerance</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>                <span class="n">max_tol</span> <span class="o">=</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>            <span class="c1"># Compute sparse distance matrix</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>            <span class="c1"># the larger the max_tol, the slower this operation is</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>            <span class="n">sdm</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">sparse_distance_matrix</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">max_tol</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;coo_matrix&quot;</span><span class="p">)</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>            <span class="c1"># Only consider forward case, exclude diagonal</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>            <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">sdm</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>            <span class="c1"># Filter relative distances</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>            <span class="k">if</span> <span class="n">relative</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>                <span class="c1"># Compute relative distances</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>                <span class="n">rel_dists</span> <span class="o">=</span> <span class="n">sdm</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="n">values</span><span class="p">[</span><span class="n">sdm</span><span class="o">.</span><span class="n">row</span><span class="p">]</span>  <span class="c1"># or col?</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>                <span class="c1"># Indices of relative distances less than tolerance</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>                <span class="n">idx</span> <span class="o">=</span> <span class="n">rel_dists</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>                <span class="c1"># Reconstruct sparse distance matrix</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>                <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">(</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>                    <span class="p">(</span><span class="n">rel_dists</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">sdm</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">idx</span><span class="p">])),</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>                    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>                <span class="p">)</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>            <span class="c1"># Cast as binary matrix</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>            <span class="n">sdm</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>            <span class="c1"># Stack distances</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>            <span class="k">if</span> <span class="n">distances</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>                <span class="n">distances</span> <span class="o">=</span> <span class="n">sdm</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>                <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sdm</span><span class="p">)</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>        <span class="c1"># Extract indices of within-tolerance points</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">tocoo</span><span class="p">()</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>        <span class="n">pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">distances</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">distances</span><span class="o">.</span><span class="n">col</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>        <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;parent&quot;</span><span class="p">,</span> <span class="s2">&quot;child&quot;</span><span class="p">])</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>        <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">)</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>        <span class="n">to_drop</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>            <span class="c1"># Find root_parents and their children</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>            <span class="n">root_parents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_df</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>            <span class="p">)</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>            <span class="n">children_of_roots</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">root_parents</span><span class="p">,</span> <span class="s2">&quot;child&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>            <span class="n">to_drop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to_drop</span><span class="p">,</span> <span class="n">children_of_roots</span><span class="p">)</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>            <span class="c1"># Remove root_children as possible parents from pairs_df for next iteration</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>            <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">children_of_roots</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>            <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;child&quot;</span><span class="p">)</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>            <span class="c1"># Remove root_children as possible children from pairs_df for next iteration</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>            <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">children_of_roots</span><span class="p">)</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>            <span class="c1"># Prepare for next iteration</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>            <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">)</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>        <span class="c1"># Drop mass features that are not cluster parents</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">to_drop</span><span class="p">))</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>        <span class="c1"># Set index back to mf_id</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;mf_id&quot;</span><span class="p">)</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf_df</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; mass features remaining&quot;</span><span class="p">)</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>        <span class="n">mf_df_new</span> <span class="o">=</span> <span class="n">mf_df_og</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>        <span class="n">mf_df_new</span><span class="p">[</span><span class="s2">&quot;cluster_parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mf_df_new</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>        <span class="p">)</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>        <span class="c1"># get mass feature ids of features that are not cluster parents</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>        <span class="n">cluster_daughters</span> <span class="o">=</span> <span class="n">mf_df_new</span><span class="p">[</span><span class="n">mf_df_new</span><span class="p">[</span><span class="s2">&quot;cluster_parent&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>        <span class="k">if</span> <span class="n">drop_children</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>            <span class="c1"># Drop mass features that are not cluster parents from self</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>                <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cluster_daughters</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>            <span class="p">}</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>            <span class="k">return</span> <span class="n">cluster_daughters</span>
</span></pre></div>


            </section>
                <section id="find_closest">
                            <input id="find_closest-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">find_closest</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">A</span>, </span><span class="param"><span class="n">target</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="find_closest-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#find_closest"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="find_closest-14"><a href="#find_closest-14"><span class="linenos">14</span></a><span class="k">def</span> <span class="nf">find_closest</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
</span><span id="find_closest-15"><a href="#find_closest-15"><span class="linenos">15</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the index of closest value in A to each value in target.</span>
</span><span id="find_closest-16"><a href="#find_closest-16"><span class="linenos">16</span></a>
</span><span id="find_closest-17"><a href="#find_closest-17"><span class="linenos">17</span></a><span class="sd">    Parameters</span>
</span><span id="find_closest-18"><a href="#find_closest-18"><span class="linenos">18</span></a><span class="sd">    ----------</span>
</span><span id="find_closest-19"><a href="#find_closest-19"><span class="linenos">19</span></a><span class="sd">    A : :obj:`~numpy.array`</span>
</span><span id="find_closest-20"><a href="#find_closest-20"><span class="linenos">20</span></a><span class="sd">        The array to search (blueprint). A must be sorted.</span>
</span><span id="find_closest-21"><a href="#find_closest-21"><span class="linenos">21</span></a><span class="sd">    target : :obj:`~numpy.array`</span>
</span><span id="find_closest-22"><a href="#find_closest-22"><span class="linenos">22</span></a><span class="sd">        The array of values to search for. target must be sorted.</span>
</span><span id="find_closest-23"><a href="#find_closest-23"><span class="linenos">23</span></a>
</span><span id="find_closest-24"><a href="#find_closest-24"><span class="linenos">24</span></a><span class="sd">    Returns</span>
</span><span id="find_closest-25"><a href="#find_closest-25"><span class="linenos">25</span></a><span class="sd">    -------</span>
</span><span id="find_closest-26"><a href="#find_closest-26"><span class="linenos">26</span></a><span class="sd">    :obj:`~numpy.array`</span>
</span><span id="find_closest-27"><a href="#find_closest-27"><span class="linenos">27</span></a><span class="sd">        The indices of the closest values in A to each value in target.</span>
</span><span id="find_closest-28"><a href="#find_closest-28"><span class="linenos">28</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="find_closest-29"><a href="#find_closest-29"><span class="linenos">29</span></a>    <span class="n">idx</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span><span id="find_closest-30"><a href="#find_closest-30"><span class="linenos">30</span></a>    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="find_closest-31"><a href="#find_closest-31"><span class="linenos">31</span></a>    <span class="n">left</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="find_closest-32"><a href="#find_closest-32"><span class="linenos">32</span></a>    <span class="n">right</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="find_closest-33"><a href="#find_closest-33"><span class="linenos">33</span></a>    <span class="n">idx</span> <span class="o">-=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">left</span> <span class="o">&lt;</span> <span class="n">right</span> <span class="o">-</span> <span class="n">target</span>
</span><span id="find_closest-34"><a href="#find_closest-34"><span class="linenos">34</span></a>    <span class="k">return</span> <span class="n">idx</span>
</span></pre></div>


            <div class="docstring"><p>Find the index of closest value in A to each value in target.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>A</strong> (<code>~numpy.array</code>):
The array to search (blueprint). A must be sorted.</li>
<li><strong>target</strong> (<code>~numpy.array</code>):
The array of values to search for. target must be sorted.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong><code>~numpy.array</code></strong>: The indices of the closest values in A to each value in target.</li>
</ul>
</div>


                </section>
                <section id="LCCalculations">
                            <input id="LCCalculations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LCCalculations</span>:

                <label class="view-source-button" for="LCCalculations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LCCalculations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LCCalculations-37"><a href="#LCCalculations-37"><span class="linenos"> 37</span></a><span class="k">class</span> <span class="nc">LCCalculations</span><span class="p">:</span>
</span><span id="LCCalculations-38"><a href="#LCCalculations-38"><span class="linenos"> 38</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Methods for performing LC calculations on mass spectra data.</span>
</span><span id="LCCalculations-39"><a href="#LCCalculations-39"><span class="linenos"> 39</span></a>
</span><span id="LCCalculations-40"><a href="#LCCalculations-40"><span class="linenos"> 40</span></a><span class="sd">    Notes</span>
</span><span id="LCCalculations-41"><a href="#LCCalculations-41"><span class="linenos"> 41</span></a><span class="sd">    -----</span>
</span><span id="LCCalculations-42"><a href="#LCCalculations-42"><span class="linenos"> 42</span></a><span class="sd">    This class is intended to be used as a mixin for the LCMSBase class.</span>
</span><span id="LCCalculations-43"><a href="#LCCalculations-43"><span class="linenos"> 43</span></a>
</span><span id="LCCalculations-44"><a href="#LCCalculations-44"><span class="linenos"> 44</span></a><span class="sd">    Methods</span>
</span><span id="LCCalculations-45"><a href="#LCCalculations-45"><span class="linenos"> 45</span></a><span class="sd">    -------</span>
</span><span id="LCCalculations-46"><a href="#LCCalculations-46"><span class="linenos"> 46</span></a><span class="sd">    * get_max_eic(eic_data).</span>
</span><span id="LCCalculations-47"><a href="#LCCalculations-47"><span class="linenos"> 47</span></a><span class="sd">        Returns the maximum EIC value from the given EIC data. A static method.</span>
</span><span id="LCCalculations-48"><a href="#LCCalculations-48"><span class="linenos"> 48</span></a><span class="sd">    * smooth_tic(tic).</span>
</span><span id="LCCalculations-49"><a href="#LCCalculations-49"><span class="linenos"> 49</span></a><span class="sd">        Smooths the TIC data using the specified smoothing method and settings.</span>
</span><span id="LCCalculations-50"><a href="#LCCalculations-50"><span class="linenos"> 50</span></a><span class="sd">    * eic_centroid_detector(rt, eic, max_eic).</span>
</span><span id="LCCalculations-51"><a href="#LCCalculations-51"><span class="linenos"> 51</span></a><span class="sd">        Performs EIC centroid detection on the given EIC data.</span>
</span><span id="LCCalculations-52"><a href="#LCCalculations-52"><span class="linenos"> 52</span></a><span class="sd">    * find_nearest_scan(rt).</span>
</span><span id="LCCalculations-53"><a href="#LCCalculations-53"><span class="linenos"> 53</span></a><span class="sd">        Finds the nearest scan to the given retention time.</span>
</span><span id="LCCalculations-54"><a href="#LCCalculations-54"><span class="linenos"> 54</span></a><span class="sd">    * get_average_mass_spectrum(scan_list, apex_scan, spectrum_mode=&quot;profile&quot;, ms_level=1, auto_process=True, use_parser=False, perform_checks=True, polarity=None).</span>
</span><span id="LCCalculations-55"><a href="#LCCalculations-55"><span class="linenos"> 55</span></a><span class="sd">        Returns an averaged mass spectrum object.</span>
</span><span id="LCCalculations-56"><a href="#LCCalculations-56"><span class="linenos"> 56</span></a><span class="sd">    * find_mass_features(ms_level=1).</span>
</span><span id="LCCalculations-57"><a href="#LCCalculations-57"><span class="linenos"> 57</span></a><span class="sd">        Find regions of interest for a given MS level (default is MS1).</span>
</span><span id="LCCalculations-58"><a href="#LCCalculations-58"><span class="linenos"> 58</span></a><span class="sd">    * integrate_mass_features(drop_if_fail=False, ms_level=1).</span>
</span><span id="LCCalculations-59"><a href="#LCCalculations-59"><span class="linenos"> 59</span></a><span class="sd">        Integrate mass features of interest and extracts EICs.</span>
</span><span id="LCCalculations-60"><a href="#LCCalculations-60"><span class="linenos"> 60</span></a><span class="sd">    * find_c13_mass_features().</span>
</span><span id="LCCalculations-61"><a href="#LCCalculations-61"><span class="linenos"> 61</span></a><span class="sd">        Evaluate mass features and mark likely C13 isotopes.</span>
</span><span id="LCCalculations-62"><a href="#LCCalculations-62"><span class="linenos"> 62</span></a><span class="sd">    * deconvolute_ms1_mass_features().</span>
</span><span id="LCCalculations-63"><a href="#LCCalculations-63"><span class="linenos"> 63</span></a><span class="sd">        Deconvolute mass features&#39; ms1 mass spectra.</span>
</span><span id="LCCalculations-64"><a href="#LCCalculations-64"><span class="linenos"> 64</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="LCCalculations-65"><a href="#LCCalculations-65"><span class="linenos"> 65</span></a>
</span><span id="LCCalculations-66"><a href="#LCCalculations-66"><span class="linenos"> 66</span></a>    <span class="nd">@staticmethod</span>
</span><span id="LCCalculations-67"><a href="#LCCalculations-67"><span class="linenos"> 67</span></a>    <span class="k">def</span> <span class="nf">get_max_eic</span><span class="p">(</span><span class="n">eic_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="LCCalculations-68"><a href="#LCCalculations-68"><span class="linenos"> 68</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the maximum EIC value from the given EIC data.</span>
</span><span id="LCCalculations-69"><a href="#LCCalculations-69"><span class="linenos"> 69</span></a>
</span><span id="LCCalculations-70"><a href="#LCCalculations-70"><span class="linenos"> 70</span></a><span class="sd">        Notes</span>
</span><span id="LCCalculations-71"><a href="#LCCalculations-71"><span class="linenos"> 71</span></a><span class="sd">        -----</span>
</span><span id="LCCalculations-72"><a href="#LCCalculations-72"><span class="linenos"> 72</span></a><span class="sd">        This is a static method.</span>
</span><span id="LCCalculations-73"><a href="#LCCalculations-73"><span class="linenos"> 73</span></a>
</span><span id="LCCalculations-74"><a href="#LCCalculations-74"><span class="linenos"> 74</span></a><span class="sd">        Parameters</span>
</span><span id="LCCalculations-75"><a href="#LCCalculations-75"><span class="linenos"> 75</span></a><span class="sd">        ----------</span>
</span><span id="LCCalculations-76"><a href="#LCCalculations-76"><span class="linenos"> 76</span></a><span class="sd">        eic_data : dict</span>
</span><span id="LCCalculations-77"><a href="#LCCalculations-77"><span class="linenos"> 77</span></a><span class="sd">            A dictionary containing EIC data.</span>
</span><span id="LCCalculations-78"><a href="#LCCalculations-78"><span class="linenos"> 78</span></a>
</span><span id="LCCalculations-79"><a href="#LCCalculations-79"><span class="linenos"> 79</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations-80"><a href="#LCCalculations-80"><span class="linenos"> 80</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations-81"><a href="#LCCalculations-81"><span class="linenos"> 81</span></a><span class="sd">        float</span>
</span><span id="LCCalculations-82"><a href="#LCCalculations-82"><span class="linenos"> 82</span></a><span class="sd">            The maximum EIC value.</span>
</span><span id="LCCalculations-83"><a href="#LCCalculations-83"><span class="linenos"> 83</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations-84"><a href="#LCCalculations-84"><span class="linenos"> 84</span></a>        <span class="n">max_eic</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LCCalculations-85"><a href="#LCCalculations-85"><span class="linenos"> 85</span></a>        <span class="k">for</span> <span class="n">eic_data</span> <span class="ow">in</span> <span class="n">eic_data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="LCCalculations-86"><a href="#LCCalculations-86"><span class="linenos"> 86</span></a>            <span class="n">ind_max_eic</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">eic_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;EIC&quot;</span><span class="p">))</span>
</span><span id="LCCalculations-87"><a href="#LCCalculations-87"><span class="linenos"> 87</span></a>            <span class="n">max_eic</span> <span class="o">=</span> <span class="n">ind_max_eic</span> <span class="k">if</span> <span class="n">ind_max_eic</span> <span class="o">&gt;</span> <span class="n">max_eic</span> <span class="k">else</span> <span class="n">max_eic</span>
</span><span id="LCCalculations-88"><a href="#LCCalculations-88"><span class="linenos"> 88</span></a>
</span><span id="LCCalculations-89"><a href="#LCCalculations-89"><span class="linenos"> 89</span></a>        <span class="k">return</span> <span class="n">max_eic</span>
</span><span id="LCCalculations-90"><a href="#LCCalculations-90"><span class="linenos"> 90</span></a>
</span><span id="LCCalculations-91"><a href="#LCCalculations-91"><span class="linenos"> 91</span></a>    <span class="k">def</span> <span class="nf">smooth_tic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tic</span><span class="p">):</span>
</span><span id="LCCalculations-92"><a href="#LCCalculations-92"><span class="linenos"> 92</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Smooths the TIC or EIC data using the specified smoothing method and settings.</span>
</span><span id="LCCalculations-93"><a href="#LCCalculations-93"><span class="linenos"> 93</span></a>
</span><span id="LCCalculations-94"><a href="#LCCalculations-94"><span class="linenos"> 94</span></a><span class="sd">        Parameters</span>
</span><span id="LCCalculations-95"><a href="#LCCalculations-95"><span class="linenos"> 95</span></a><span class="sd">        ----------</span>
</span><span id="LCCalculations-96"><a href="#LCCalculations-96"><span class="linenos"> 96</span></a><span class="sd">        tic : numpy.ndarray</span>
</span><span id="LCCalculations-97"><a href="#LCCalculations-97"><span class="linenos"> 97</span></a><span class="sd">            The TIC (or EIC) data to be smoothed.</span>
</span><span id="LCCalculations-98"><a href="#LCCalculations-98"><span class="linenos"> 98</span></a>
</span><span id="LCCalculations-99"><a href="#LCCalculations-99"><span class="linenos"> 99</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations-100"><a href="#LCCalculations-100"><span class="linenos">100</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations-101"><a href="#LCCalculations-101"><span class="linenos">101</span></a><span class="sd">        numpy.ndarray</span>
</span><span id="LCCalculations-102"><a href="#LCCalculations-102"><span class="linenos">102</span></a><span class="sd">            The smoothed TIC data.</span>
</span><span id="LCCalculations-103"><a href="#LCCalculations-103"><span class="linenos">103</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations-104"><a href="#LCCalculations-104"><span class="linenos">104</span></a>        <span class="n">implemented_smooth_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">implemented_smooth_method</span>
</span><span id="LCCalculations-105"><a href="#LCCalculations-105"><span class="linenos">105</span></a>
</span><span id="LCCalculations-106"><a href="#LCCalculations-106"><span class="linenos">106</span></a>        <span class="n">pol_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">savgol_pol_order</span>
</span><span id="LCCalculations-107"><a href="#LCCalculations-107"><span class="linenos">107</span></a>
</span><span id="LCCalculations-108"><a href="#LCCalculations-108"><span class="linenos">108</span></a>        <span class="n">window_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">smooth_window</span>
</span><span id="LCCalculations-109"><a href="#LCCalculations-109"><span class="linenos">109</span></a>
</span><span id="LCCalculations-110"><a href="#LCCalculations-110"><span class="linenos">110</span></a>        <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">smooth_method</span>
</span><span id="LCCalculations-111"><a href="#LCCalculations-111"><span class="linenos">111</span></a>
</span><span id="LCCalculations-112"><a href="#LCCalculations-112"><span class="linenos">112</span></a>        <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">smooth_signal</span><span class="p">(</span>
</span><span id="LCCalculations-113"><a href="#LCCalculations-113"><span class="linenos">113</span></a>            <span class="n">tic</span><span class="p">,</span> <span class="n">window_len</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">pol_order</span><span class="p">,</span> <span class="n">implemented_smooth_method</span>
</span><span id="LCCalculations-114"><a href="#LCCalculations-114"><span class="linenos">114</span></a>        <span class="p">)</span>
</span><span id="LCCalculations-115"><a href="#LCCalculations-115"><span class="linenos">115</span></a>
</span><span id="LCCalculations-116"><a href="#LCCalculations-116"><span class="linenos">116</span></a>    <span class="k">def</span> <span class="nf">eic_centroid_detector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">eic</span><span class="p">,</span> <span class="n">max_eic</span><span class="p">,</span> <span class="n">apex_indexes</span><span class="o">=</span><span class="p">[]):</span>
</span><span id="LCCalculations-117"><a href="#LCCalculations-117"><span class="linenos">117</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs EIC centroid detection on the given EIC data.</span>
</span><span id="LCCalculations-118"><a href="#LCCalculations-118"><span class="linenos">118</span></a>
</span><span id="LCCalculations-119"><a href="#LCCalculations-119"><span class="linenos">119</span></a><span class="sd">        Parameters</span>
</span><span id="LCCalculations-120"><a href="#LCCalculations-120"><span class="linenos">120</span></a><span class="sd">        ----------</span>
</span><span id="LCCalculations-121"><a href="#LCCalculations-121"><span class="linenos">121</span></a><span class="sd">        rt : numpy.ndarray</span>
</span><span id="LCCalculations-122"><a href="#LCCalculations-122"><span class="linenos">122</span></a><span class="sd">            The retention time data.</span>
</span><span id="LCCalculations-123"><a href="#LCCalculations-123"><span class="linenos">123</span></a><span class="sd">        eic : numpy.ndarray</span>
</span><span id="LCCalculations-124"><a href="#LCCalculations-124"><span class="linenos">124</span></a><span class="sd">            The EIC data.</span>
</span><span id="LCCalculations-125"><a href="#LCCalculations-125"><span class="linenos">125</span></a><span class="sd">        max_eic : float</span>
</span><span id="LCCalculations-126"><a href="#LCCalculations-126"><span class="linenos">126</span></a><span class="sd">            The maximum EIC value.</span>
</span><span id="LCCalculations-127"><a href="#LCCalculations-127"><span class="linenos">127</span></a><span class="sd">        apex_indexes : list, optional</span>
</span><span id="LCCalculations-128"><a href="#LCCalculations-128"><span class="linenos">128</span></a><span class="sd">            The apexes of the EIC peaks. Defaults to [], which means that the apexes will be calculated by the function.</span>
</span><span id="LCCalculations-129"><a href="#LCCalculations-129"><span class="linenos">129</span></a>
</span><span id="LCCalculations-130"><a href="#LCCalculations-130"><span class="linenos">130</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations-131"><a href="#LCCalculations-131"><span class="linenos">131</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations-132"><a href="#LCCalculations-132"><span class="linenos">132</span></a><span class="sd">        numpy.ndarray</span>
</span><span id="LCCalculations-133"><a href="#LCCalculations-133"><span class="linenos">133</span></a><span class="sd">            The indexes of left, apex, and right limits as a generator.</span>
</span><span id="LCCalculations-134"><a href="#LCCalculations-134"><span class="linenos">134</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations-135"><a href="#LCCalculations-135"><span class="linenos">135</span></a>
</span><span id="LCCalculations-136"><a href="#LCCalculations-136"><span class="linenos">136</span></a>        <span class="n">max_prominence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">peak_max_prominence_percent</span>
</span><span id="LCCalculations-137"><a href="#LCCalculations-137"><span class="linenos">137</span></a>
</span><span id="LCCalculations-138"><a href="#LCCalculations-138"><span class="linenos">138</span></a>        <span class="n">max_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">peak_height_max_percent</span>
</span><span id="LCCalculations-139"><a href="#LCCalculations-139"><span class="linenos">139</span></a>
</span><span id="LCCalculations-140"><a href="#LCCalculations-140"><span class="linenos">140</span></a>        <span class="n">signal_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">eic_signal_threshold</span>
</span><span id="LCCalculations-141"><a href="#LCCalculations-141"><span class="linenos">141</span></a>
</span><span id="LCCalculations-142"><a href="#LCCalculations-142"><span class="linenos">142</span></a>        <span class="n">min_peak_datapoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">min_peak_datapoints</span>
</span><span id="LCCalculations-143"><a href="#LCCalculations-143"><span class="linenos">143</span></a>
</span><span id="LCCalculations-144"><a href="#LCCalculations-144"><span class="linenos">144</span></a>        <span class="n">peak_derivative_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">peak_derivative_threshold</span>
</span><span id="LCCalculations-145"><a href="#LCCalculations-145"><span class="linenos">145</span></a>
</span><span id="LCCalculations-146"><a href="#LCCalculations-146"><span class="linenos">146</span></a>        <span class="n">include_indexes</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">peak_picking_first_derivative</span><span class="p">(</span>
</span><span id="LCCalculations-147"><a href="#LCCalculations-147"><span class="linenos">147</span></a>            <span class="n">domain</span><span class="o">=</span><span class="n">rt</span><span class="p">,</span>
</span><span id="LCCalculations-148"><a href="#LCCalculations-148"><span class="linenos">148</span></a>            <span class="n">signal</span><span class="o">=</span><span class="n">eic</span><span class="p">,</span>
</span><span id="LCCalculations-149"><a href="#LCCalculations-149"><span class="linenos">149</span></a>            <span class="n">max_height</span><span class="o">=</span><span class="n">max_height</span><span class="p">,</span>
</span><span id="LCCalculations-150"><a href="#LCCalculations-150"><span class="linenos">150</span></a>            <span class="n">max_prominence</span><span class="o">=</span><span class="n">max_prominence</span><span class="p">,</span>
</span><span id="LCCalculations-151"><a href="#LCCalculations-151"><span class="linenos">151</span></a>            <span class="n">max_signal</span><span class="o">=</span><span class="n">max_eic</span><span class="p">,</span>
</span><span id="LCCalculations-152"><a href="#LCCalculations-152"><span class="linenos">152</span></a>            <span class="n">min_peak_datapoints</span><span class="o">=</span><span class="n">min_peak_datapoints</span><span class="p">,</span>
</span><span id="LCCalculations-153"><a href="#LCCalculations-153"><span class="linenos">153</span></a>            <span class="n">peak_derivative_threshold</span><span class="o">=</span><span class="n">peak_derivative_threshold</span><span class="p">,</span>
</span><span id="LCCalculations-154"><a href="#LCCalculations-154"><span class="linenos">154</span></a>            <span class="n">signal_threshold</span><span class="o">=</span><span class="n">signal_threshold</span><span class="p">,</span>
</span><span id="LCCalculations-155"><a href="#LCCalculations-155"><span class="linenos">155</span></a>            <span class="n">correct_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LCCalculations-156"><a href="#LCCalculations-156"><span class="linenos">156</span></a>            <span class="n">plot_res</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LCCalculations-157"><a href="#LCCalculations-157"><span class="linenos">157</span></a>            <span class="n">apex_indexes</span><span class="o">=</span><span class="n">apex_indexes</span><span class="p">,</span>
</span><span id="LCCalculations-158"><a href="#LCCalculations-158"><span class="linenos">158</span></a>        <span class="p">)</span>
</span><span id="LCCalculations-159"><a href="#LCCalculations-159"><span class="linenos">159</span></a>
</span><span id="LCCalculations-160"><a href="#LCCalculations-160"><span class="linenos">160</span></a>        <span class="k">return</span> <span class="n">include_indexes</span>
</span><span id="LCCalculations-161"><a href="#LCCalculations-161"><span class="linenos">161</span></a>
</span><span id="LCCalculations-162"><a href="#LCCalculations-162"><span class="linenos">162</span></a>    <span class="k">def</span> <span class="nf">find_nearest_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rt</span><span class="p">):</span>
</span><span id="LCCalculations-163"><a href="#LCCalculations-163"><span class="linenos">163</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Finds the nearest scan to the given retention time.</span>
</span><span id="LCCalculations-164"><a href="#LCCalculations-164"><span class="linenos">164</span></a>
</span><span id="LCCalculations-165"><a href="#LCCalculations-165"><span class="linenos">165</span></a><span class="sd">        Parameters</span>
</span><span id="LCCalculations-166"><a href="#LCCalculations-166"><span class="linenos">166</span></a><span class="sd">        ----------</span>
</span><span id="LCCalculations-167"><a href="#LCCalculations-167"><span class="linenos">167</span></a><span class="sd">        rt : float</span>
</span><span id="LCCalculations-168"><a href="#LCCalculations-168"><span class="linenos">168</span></a><span class="sd">            The retention time (in minutes) to find the nearest scan for.</span>
</span><span id="LCCalculations-169"><a href="#LCCalculations-169"><span class="linenos">169</span></a>
</span><span id="LCCalculations-170"><a href="#LCCalculations-170"><span class="linenos">170</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations-171"><a href="#LCCalculations-171"><span class="linenos">171</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations-172"><a href="#LCCalculations-172"><span class="linenos">172</span></a><span class="sd">        int</span>
</span><span id="LCCalculations-173"><a href="#LCCalculations-173"><span class="linenos">173</span></a><span class="sd">            The scan number of the nearest scan.</span>
</span><span id="LCCalculations-174"><a href="#LCCalculations-174"><span class="linenos">174</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations-175"><a href="#LCCalculations-175"><span class="linenos">175</span></a>        <span class="n">array_rt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retention_time</span><span class="p">)</span>
</span><span id="LCCalculations-176"><a href="#LCCalculations-176"><span class="linenos">176</span></a>
</span><span id="LCCalculations-177"><a href="#LCCalculations-177"><span class="linenos">177</span></a>        <span class="n">scan_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">array_rt</span> <span class="o">-</span> <span class="n">rt</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
</span><span id="LCCalculations-178"><a href="#LCCalculations-178"><span class="linenos">178</span></a>
</span><span id="LCCalculations-179"><a href="#LCCalculations-179"><span class="linenos">179</span></a>        <span class="n">real_scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans_number</span><span class="p">[</span><span class="n">scan_index</span><span class="p">]</span>
</span><span id="LCCalculations-180"><a href="#LCCalculations-180"><span class="linenos">180</span></a>
</span><span id="LCCalculations-181"><a href="#LCCalculations-181"><span class="linenos">181</span></a>        <span class="k">return</span> <span class="n">real_scan</span>
</span><span id="LCCalculations-182"><a href="#LCCalculations-182"><span class="linenos">182</span></a>
</span><span id="LCCalculations-183"><a href="#LCCalculations-183"><span class="linenos">183</span></a>    <span class="k">def</span> <span class="nf">add_peak_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LCCalculations-184"><a href="#LCCalculations-184"><span class="linenos">184</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add peak metrics to the mass features.</span>
</span><span id="LCCalculations-185"><a href="#LCCalculations-185"><span class="linenos">185</span></a>
</span><span id="LCCalculations-186"><a href="#LCCalculations-186"><span class="linenos">186</span></a><span class="sd">        This function calculates the peak metrics for each mass feature and adds them to the mass feature objects.</span>
</span><span id="LCCalculations-187"><a href="#LCCalculations-187"><span class="linenos">187</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations-188"><a href="#LCCalculations-188"><span class="linenos">188</span></a>        <span class="c1"># Check that at least some mass features have eic data</span>
</span><span id="LCCalculations-189"><a href="#LCCalculations-189"><span class="linenos">189</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">mf</span><span class="o">.</span><span class="n">_eic_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">values</span><span class="p">()]):</span>
</span><span id="LCCalculations-190"><a href="#LCCalculations-190"><span class="linenos">190</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LCCalculations-191"><a href="#LCCalculations-191"><span class="linenos">191</span></a>                <span class="s2">&quot;No mass features have EIC data. Run integrate_mass_features first.&quot;</span>
</span><span id="LCCalculations-192"><a href="#LCCalculations-192"><span class="linenos">192</span></a>            <span class="p">)</span>
</span><span id="LCCalculations-193"><a href="#LCCalculations-193"><span class="linenos">193</span></a>
</span><span id="LCCalculations-194"><a href="#LCCalculations-194"><span class="linenos">194</span></a>        <span class="k">for</span> <span class="n">mass_feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="LCCalculations-195"><a href="#LCCalculations-195"><span class="linenos">195</span></a>            <span class="c1"># Check if the mass feature has been integrated</span>
</span><span id="LCCalculations-196"><a href="#LCCalculations-196"><span class="linenos">196</span></a>            <span class="k">if</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">_eic_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations-197"><a href="#LCCalculations-197"><span class="linenos">197</span></a>                <span class="c1"># Calculate peak metrics</span>
</span><span id="LCCalculations-198"><a href="#LCCalculations-198"><span class="linenos">198</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">calc_half_height_width</span><span class="p">()</span>
</span><span id="LCCalculations-199"><a href="#LCCalculations-199"><span class="linenos">199</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">calc_tailing_factor</span><span class="p">()</span>
</span><span id="LCCalculations-200"><a href="#LCCalculations-200"><span class="linenos">200</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">calc_dispersity_index</span><span class="p">()</span>
</span><span id="LCCalculations-201"><a href="#LCCalculations-201"><span class="linenos">201</span></a>
</span><span id="LCCalculations-202"><a href="#LCCalculations-202"><span class="linenos">202</span></a>    <span class="k">def</span> <span class="nf">get_average_mass_spectrum</span><span class="p">(</span>
</span><span id="LCCalculations-203"><a href="#LCCalculations-203"><span class="linenos">203</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LCCalculations-204"><a href="#LCCalculations-204"><span class="linenos">204</span></a>        <span class="n">scan_list</span><span class="p">,</span>
</span><span id="LCCalculations-205"><a href="#LCCalculations-205"><span class="linenos">205</span></a>        <span class="n">apex_scan</span><span class="p">,</span>
</span><span id="LCCalculations-206"><a href="#LCCalculations-206"><span class="linenos">206</span></a>        <span class="n">spectrum_mode</span><span class="o">=</span><span class="s2">&quot;profile&quot;</span><span class="p">,</span>
</span><span id="LCCalculations-207"><a href="#LCCalculations-207"><span class="linenos">207</span></a>        <span class="n">ms_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="LCCalculations-208"><a href="#LCCalculations-208"><span class="linenos">208</span></a>        <span class="n">auto_process</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LCCalculations-209"><a href="#LCCalculations-209"><span class="linenos">209</span></a>        <span class="n">use_parser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LCCalculations-210"><a href="#LCCalculations-210"><span class="linenos">210</span></a>        <span class="n">perform_checks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LCCalculations-211"><a href="#LCCalculations-211"><span class="linenos">211</span></a>        <span class="n">polarity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LCCalculations-212"><a href="#LCCalculations-212"><span class="linenos">212</span></a>        <span class="n">ms_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LCCalculations-213"><a href="#LCCalculations-213"><span class="linenos">213</span></a>    <span class="p">):</span>
</span><span id="LCCalculations-214"><a href="#LCCalculations-214"><span class="linenos">214</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an averaged mass spectrum object</span>
</span><span id="LCCalculations-215"><a href="#LCCalculations-215"><span class="linenos">215</span></a>
</span><span id="LCCalculations-216"><a href="#LCCalculations-216"><span class="linenos">216</span></a><span class="sd">        Parameters</span>
</span><span id="LCCalculations-217"><a href="#LCCalculations-217"><span class="linenos">217</span></a><span class="sd">        ----------</span>
</span><span id="LCCalculations-218"><a href="#LCCalculations-218"><span class="linenos">218</span></a><span class="sd">        scan_list : list</span>
</span><span id="LCCalculations-219"><a href="#LCCalculations-219"><span class="linenos">219</span></a><span class="sd">            List of scan numbers to average.</span>
</span><span id="LCCalculations-220"><a href="#LCCalculations-220"><span class="linenos">220</span></a><span class="sd">        apex_scan : int</span>
</span><span id="LCCalculations-221"><a href="#LCCalculations-221"><span class="linenos">221</span></a><span class="sd">            Number of the apex scan</span>
</span><span id="LCCalculations-222"><a href="#LCCalculations-222"><span class="linenos">222</span></a><span class="sd">        spectrum_mode : str, optional</span>
</span><span id="LCCalculations-223"><a href="#LCCalculations-223"><span class="linenos">223</span></a><span class="sd">            The spectrum mode to use. Defaults to &quot;profile&quot;. Not that only &quot;profile&quot; mode is supported for averaging.</span>
</span><span id="LCCalculations-224"><a href="#LCCalculations-224"><span class="linenos">224</span></a><span class="sd">        ms_level : int, optional</span>
</span><span id="LCCalculations-225"><a href="#LCCalculations-225"><span class="linenos">225</span></a><span class="sd">            The MS level to use. Defaults to 1.</span>
</span><span id="LCCalculations-226"><a href="#LCCalculations-226"><span class="linenos">226</span></a><span class="sd">        auto_process : bool, optional</span>
</span><span id="LCCalculations-227"><a href="#LCCalculations-227"><span class="linenos">227</span></a><span class="sd">            If True, the averaged mass spectrum will be auto-processed. Defaults to True.</span>
</span><span id="LCCalculations-228"><a href="#LCCalculations-228"><span class="linenos">228</span></a><span class="sd">        use_parser : bool, optional</span>
</span><span id="LCCalculations-229"><a href="#LCCalculations-229"><span class="linenos">229</span></a><span class="sd">            If True, the mass spectra will be obtained from the parser. Defaults to False.</span>
</span><span id="LCCalculations-230"><a href="#LCCalculations-230"><span class="linenos">230</span></a><span class="sd">        perform_checks : bool, optional</span>
</span><span id="LCCalculations-231"><a href="#LCCalculations-231"><span class="linenos">231</span></a><span class="sd">            If True, the function will check if the data are within the ms_unprocessed dictionary and are the correct mode. Defaults to True. Only set to False if you are sure the data are profile, and (if not using the parser) are in the ms_unprocessed dictionary!  ms_unprocessed dictionary also must be indexed on scan</span>
</span><span id="LCCalculations-232"><a href="#LCCalculations-232"><span class="linenos">232</span></a><span class="sd">        polarity : int, optional</span>
</span><span id="LCCalculations-233"><a href="#LCCalculations-233"><span class="linenos">233</span></a><span class="sd">            The polarity of the mass spectra (1 or -1). If not set, the polarity will be determined from the dataset. Defaults to None. (fastest if set to -1 or 1)</span>
</span><span id="LCCalculations-234"><a href="#LCCalculations-234"><span class="linenos">234</span></a><span class="sd">        ms_params : MSParameters, optional</span>
</span><span id="LCCalculations-235"><a href="#LCCalculations-235"><span class="linenos">235</span></a><span class="sd">            The mass spectrum parameters to use. If not set (None), the globally set parameters will be used. Defaults to None.</span>
</span><span id="LCCalculations-236"><a href="#LCCalculations-236"><span class="linenos">236</span></a>
</span><span id="LCCalculations-237"><a href="#LCCalculations-237"><span class="linenos">237</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations-238"><a href="#LCCalculations-238"><span class="linenos">238</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations-239"><a href="#LCCalculations-239"><span class="linenos">239</span></a><span class="sd">        MassSpectrumProfile</span>
</span><span id="LCCalculations-240"><a href="#LCCalculations-240"><span class="linenos">240</span></a><span class="sd">            The averaged mass spectrum object.</span>
</span><span id="LCCalculations-241"><a href="#LCCalculations-241"><span class="linenos">241</span></a>
</span><span id="LCCalculations-242"><a href="#LCCalculations-242"><span class="linenos">242</span></a><span class="sd">        Raises</span>
</span><span id="LCCalculations-243"><a href="#LCCalculations-243"><span class="linenos">243</span></a><span class="sd">        ------</span>
</span><span id="LCCalculations-244"><a href="#LCCalculations-244"><span class="linenos">244</span></a><span class="sd">        ValueError</span>
</span><span id="LCCalculations-245"><a href="#LCCalculations-245"><span class="linenos">245</span></a><span class="sd">            If the spectrum mode is not &quot;profile&quot;.</span>
</span><span id="LCCalculations-246"><a href="#LCCalculations-246"><span class="linenos">246</span></a><span class="sd">            If the MS level is not found in the unprocessed mass spectra dictionary.</span>
</span><span id="LCCalculations-247"><a href="#LCCalculations-247"><span class="linenos">247</span></a><span class="sd">            If not all scan numbers are found in the unprocessed mass spectra dictionary.</span>
</span><span id="LCCalculations-248"><a href="#LCCalculations-248"><span class="linenos">248</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations-249"><a href="#LCCalculations-249"><span class="linenos">249</span></a>        <span class="k">if</span> <span class="n">perform_checks</span><span class="p">:</span>
</span><span id="LCCalculations-250"><a href="#LCCalculations-250"><span class="linenos">250</span></a>            <span class="k">if</span> <span class="n">spectrum_mode</span> <span class="o">!=</span> <span class="s2">&quot;profile&quot;</span><span class="p">:</span>
</span><span id="LCCalculations-251"><a href="#LCCalculations-251"><span class="linenos">251</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Averaging only supported for profile mode&quot;</span><span class="p">)</span>
</span><span id="LCCalculations-252"><a href="#LCCalculations-252"><span class="linenos">252</span></a>
</span><span id="LCCalculations-253"><a href="#LCCalculations-253"><span class="linenos">253</span></a>        <span class="k">if</span> <span class="n">polarity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations-254"><a href="#LCCalculations-254"><span class="linenos">254</span></a>            <span class="c1"># set polarity to -1 if negative mode, 1 if positive mode (for mass spectrum creation)</span>
</span><span id="LCCalculations-255"><a href="#LCCalculations-255"><span class="linenos">255</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity</span> <span class="o">==</span> <span class="s2">&quot;negative&quot;</span><span class="p">:</span>
</span><span id="LCCalculations-256"><a href="#LCCalculations-256"><span class="linenos">256</span></a>                <span class="n">polarity</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="LCCalculations-257"><a href="#LCCalculations-257"><span class="linenos">257</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity</span> <span class="o">==</span> <span class="s2">&quot;positive&quot;</span><span class="p">:</span>
</span><span id="LCCalculations-258"><a href="#LCCalculations-258"><span class="linenos">258</span></a>                <span class="n">polarity</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="LCCalculations-259"><a href="#LCCalculations-259"><span class="linenos">259</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations-260"><a href="#LCCalculations-260"><span class="linenos">260</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LCCalculations-261"><a href="#LCCalculations-261"><span class="linenos">261</span></a>                    <span class="s2">&quot;Polarity not set for dataset, must be a set containing either &#39;positive&#39; or &#39;negative&#39;&quot;</span>
</span><span id="LCCalculations-262"><a href="#LCCalculations-262"><span class="linenos">262</span></a>                <span class="p">)</span>
</span><span id="LCCalculations-263"><a href="#LCCalculations-263"><span class="linenos">263</span></a>
</span><span id="LCCalculations-264"><a href="#LCCalculations-264"><span class="linenos">264</span></a>        <span class="c1"># if not using_parser, check that scan numbers are in _ms_unprocessed</span>
</span><span id="LCCalculations-265"><a href="#LCCalculations-265"><span class="linenos">265</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_parser</span><span class="p">:</span>
</span><span id="LCCalculations-266"><a href="#LCCalculations-266"><span class="linenos">266</span></a>            <span class="k">if</span> <span class="n">perform_checks</span><span class="p">:</span>
</span><span id="LCCalculations-267"><a href="#LCCalculations-267"><span class="linenos">267</span></a>                <span class="c1"># Set index to scan for faster lookup</span>
</span><span id="LCCalculations-268"><a href="#LCCalculations-268"><span class="linenos">268</span></a>                <span class="n">ms_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LCCalculations-269"><a href="#LCCalculations-269"><span class="linenos">269</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="p">[</span><span class="n">ms_level</span><span class="p">]</span>
</span><span id="LCCalculations-270"><a href="#LCCalculations-270"><span class="linenos">270</span></a>                    <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations-271"><a href="#LCCalculations-271"><span class="linenos">271</span></a>                    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LCCalculations-272"><a href="#LCCalculations-272"><span class="linenos">272</span></a>                    <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</span><span id="LCCalculations-273"><a href="#LCCalculations-273"><span class="linenos">273</span></a>                <span class="p">)</span>
</span><span id="LCCalculations-274"><a href="#LCCalculations-274"><span class="linenos">274</span></a>                <span class="n">my_ms_df</span> <span class="o">=</span> <span class="n">ms_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">scan_list</span><span class="p">]</span>
</span><span id="LCCalculations-275"><a href="#LCCalculations-275"><span class="linenos">275</span></a>                <span class="c1"># Check that all scan numbers are in the ms_df</span>
</span><span id="LCCalculations-276"><a href="#LCCalculations-276"><span class="linenos">276</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">scan_list</span><span class="p">,</span> <span class="n">ms_df</span><span class="o">.</span><span class="n">index</span><span class="p">)):</span>
</span><span id="LCCalculations-277"><a href="#LCCalculations-277"><span class="linenos">277</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LCCalculations-278"><a href="#LCCalculations-278"><span class="linenos">278</span></a>                        <span class="s2">&quot;Not all scan numbers found in the unprocessed mass spectra dictionary&quot;</span>
</span><span id="LCCalculations-279"><a href="#LCCalculations-279"><span class="linenos">279</span></a>                    <span class="p">)</span>
</span><span id="LCCalculations-280"><a href="#LCCalculations-280"><span class="linenos">280</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations-281"><a href="#LCCalculations-281"><span class="linenos">281</span></a>                <span class="n">my_ms_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LCCalculations-282"><a href="#LCCalculations-282"><span class="linenos">282</span></a>                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;scan&quot;</span><span class="p">:</span> <span class="n">scan_list</span><span class="p">})</span>
</span><span id="LCCalculations-283"><a href="#LCCalculations-283"><span class="linenos">283</span></a>                    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;scan&quot;</span><span class="p">)</span>
</span><span id="LCCalculations-284"><a href="#LCCalculations-284"><span class="linenos">284</span></a>                    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="p">[</span><span class="n">ms_level</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</span><span id="LCCalculations-285"><a href="#LCCalculations-285"><span class="linenos">285</span></a>                <span class="p">)</span>
</span><span id="LCCalculations-286"><a href="#LCCalculations-286"><span class="linenos">286</span></a>
</span><span id="LCCalculations-287"><a href="#LCCalculations-287"><span class="linenos">287</span></a>        <span class="k">if</span> <span class="n">use_parser</span><span class="p">:</span>
</span><span id="LCCalculations-288"><a href="#LCCalculations-288"><span class="linenos">288</span></a>            <span class="n">ms_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LCCalculations-289"><a href="#LCCalculations-289"><span class="linenos">289</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">spectra_parser</span><span class="o">.</span><span class="n">get_mass_spectrum_from_scan</span><span class="p">(</span>
</span><span id="LCCalculations-290"><a href="#LCCalculations-290"><span class="linenos">290</span></a>                    <span class="n">x</span><span class="p">,</span> <span class="n">spectrum_mode</span><span class="o">=</span><span class="n">spectrum_mode</span><span class="p">,</span> <span class="n">auto_process</span><span class="o">=</span><span class="kc">False</span>
</span><span id="LCCalculations-291"><a href="#LCCalculations-291"><span class="linenos">291</span></a>                <span class="p">)</span>
</span><span id="LCCalculations-292"><a href="#LCCalculations-292"><span class="linenos">292</span></a>                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scan_list</span>
</span><span id="LCCalculations-293"><a href="#LCCalculations-293"><span class="linenos">293</span></a>            <span class="p">]</span>
</span><span id="LCCalculations-294"><a href="#LCCalculations-294"><span class="linenos">294</span></a>            <span class="n">ms_mz</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">_mz_exp</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ms_list</span><span class="p">]</span>
</span><span id="LCCalculations-295"><a href="#LCCalculations-295"><span class="linenos">295</span></a>            <span class="n">ms_int</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">_abundance</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ms_list</span><span class="p">]</span>
</span><span id="LCCalculations-296"><a href="#LCCalculations-296"><span class="linenos">296</span></a>            <span class="n">my_ms_df</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LCCalculations-297"><a href="#LCCalculations-297"><span class="linenos">297</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ms_mz</span><span class="p">)):</span>
</span><span id="LCCalculations-298"><a href="#LCCalculations-298"><span class="linenos">298</span></a>                <span class="n">my_ms_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LCCalculations-299"><a href="#LCCalculations-299"><span class="linenos">299</span></a>                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="LCCalculations-300"><a href="#LCCalculations-300"><span class="linenos">300</span></a>                        <span class="p">{</span><span class="s2">&quot;mz&quot;</span><span class="p">:</span> <span class="n">ms_mz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;intensity&quot;</span><span class="p">:</span> <span class="n">ms_int</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;scan&quot;</span><span class="p">:</span> <span class="n">scan_list</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span>
</span><span id="LCCalculations-301"><a href="#LCCalculations-301"><span class="linenos">301</span></a>                    <span class="p">)</span>
</span><span id="LCCalculations-302"><a href="#LCCalculations-302"><span class="linenos">302</span></a>                <span class="p">)</span>
</span><span id="LCCalculations-303"><a href="#LCCalculations-303"><span class="linenos">303</span></a>            <span class="n">my_ms_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">my_ms_df</span><span class="p">)</span>
</span><span id="LCCalculations-304"><a href="#LCCalculations-304"><span class="linenos">304</span></a>
</span><span id="LCCalculations-305"><a href="#LCCalculations-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_grid</span><span class="p">(</span><span class="n">my_ms_df</span><span class="p">):</span>
</span><span id="LCCalculations-306"><a href="#LCCalculations-306"><span class="linenos">306</span></a>            <span class="n">my_ms_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span><span class="p">(</span><span class="n">my_ms_df</span><span class="p">)</span>
</span><span id="LCCalculations-307"><a href="#LCCalculations-307"><span class="linenos">307</span></a>
</span><span id="LCCalculations-308"><a href="#LCCalculations-308"><span class="linenos">308</span></a>        <span class="n">my_ms_ave</span> <span class="o">=</span> <span class="n">my_ms_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;mz&quot;</span><span class="p">)[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="LCCalculations-309"><a href="#LCCalculations-309"><span class="linenos">309</span></a>
</span><span id="LCCalculations-310"><a href="#LCCalculations-310"><span class="linenos">310</span></a>        <span class="n">ms</span> <span class="o">=</span> <span class="n">ms_from_array_profile</span><span class="p">(</span>
</span><span id="LCCalculations-311"><a href="#LCCalculations-311"><span class="linenos">311</span></a>            <span class="n">my_ms_ave</span><span class="o">.</span><span class="n">mz</span><span class="p">,</span>
</span><span id="LCCalculations-312"><a href="#LCCalculations-312"><span class="linenos">312</span></a>            <span class="n">my_ms_ave</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span>
</span><span id="LCCalculations-313"><a href="#LCCalculations-313"><span class="linenos">313</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_location</span><span class="p">,</span>
</span><span id="LCCalculations-314"><a href="#LCCalculations-314"><span class="linenos">314</span></a>            <span class="n">polarity</span><span class="o">=</span><span class="n">polarity</span><span class="p">,</span>
</span><span id="LCCalculations-315"><a href="#LCCalculations-315"><span class="linenos">315</span></a>            <span class="n">auto_process</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LCCalculations-316"><a href="#LCCalculations-316"><span class="linenos">316</span></a>        <span class="p">)</span>
</span><span id="LCCalculations-317"><a href="#LCCalculations-317"><span class="linenos">317</span></a>
</span><span id="LCCalculations-318"><a href="#LCCalculations-318"><span class="linenos">318</span></a>        <span class="c1"># Set the mass spectrum parameters, auto-process if auto_process is True, and add to the dataset</span>
</span><span id="LCCalculations-319"><a href="#LCCalculations-319"><span class="linenos">319</span></a>        <span class="k">if</span> <span class="n">ms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations-320"><a href="#LCCalculations-320"><span class="linenos">320</span></a>            <span class="k">if</span> <span class="n">ms_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations-321"><a href="#LCCalculations-321"><span class="linenos">321</span></a>                <span class="n">ms</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">ms_params</span>
</span><span id="LCCalculations-322"><a href="#LCCalculations-322"><span class="linenos">322</span></a>            <span class="n">ms</span><span class="o">.</span><span class="n">scan_number</span> <span class="o">=</span> <span class="n">apex_scan</span>
</span><span id="LCCalculations-323"><a href="#LCCalculations-323"><span class="linenos">323</span></a>            <span class="k">if</span> <span class="n">auto_process</span><span class="p">:</span>
</span><span id="LCCalculations-324"><a href="#LCCalculations-324"><span class="linenos">324</span></a>                <span class="n">ms</span><span class="o">.</span><span class="n">process_mass_spec</span><span class="p">()</span>
</span><span id="LCCalculations-325"><a href="#LCCalculations-325"><span class="linenos">325</span></a>        <span class="k">return</span> <span class="n">ms</span>
</span><span id="LCCalculations-326"><a href="#LCCalculations-326"><span class="linenos">326</span></a>
</span><span id="LCCalculations-327"><a href="#LCCalculations-327"><span class="linenos">327</span></a>    <span class="k">def</span> <span class="nf">find_mass_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="LCCalculations-328"><a href="#LCCalculations-328"><span class="linenos">328</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find mass features within an LCMSBase object</span>
</span><span id="LCCalculations-329"><a href="#LCCalculations-329"><span class="linenos">329</span></a>
</span><span id="LCCalculations-330"><a href="#LCCalculations-330"><span class="linenos">330</span></a><span class="sd">        Note that this is a wrapper function that calls the find_mass_features_ph function, but can be extended to support other peak picking methods in the future.</span>
</span><span id="LCCalculations-331"><a href="#LCCalculations-331"><span class="linenos">331</span></a>
</span><span id="LCCalculations-332"><a href="#LCCalculations-332"><span class="linenos">332</span></a><span class="sd">        Parameters</span>
</span><span id="LCCalculations-333"><a href="#LCCalculations-333"><span class="linenos">333</span></a><span class="sd">        ----------</span>
</span><span id="LCCalculations-334"><a href="#LCCalculations-334"><span class="linenos">334</span></a><span class="sd">        ms_level : int, optional</span>
</span><span id="LCCalculations-335"><a href="#LCCalculations-335"><span class="linenos">335</span></a><span class="sd">            The MS level to use for peak picking Default is 1.</span>
</span><span id="LCCalculations-336"><a href="#LCCalculations-336"><span class="linenos">336</span></a><span class="sd">        grid : bool, optional</span>
</span><span id="LCCalculations-337"><a href="#LCCalculations-337"><span class="linenos">337</span></a><span class="sd">            If True, will regrid the data before running the persistent homology calculations (after checking if the data is gridded, used for persistent homology peak picking. Default is True.</span>
</span><span id="LCCalculations-338"><a href="#LCCalculations-338"><span class="linenos">338</span></a>
</span><span id="LCCalculations-339"><a href="#LCCalculations-339"><span class="linenos">339</span></a><span class="sd">        Raises</span>
</span><span id="LCCalculations-340"><a href="#LCCalculations-340"><span class="linenos">340</span></a><span class="sd">        ------</span>
</span><span id="LCCalculations-341"><a href="#LCCalculations-341"><span class="linenos">341</span></a><span class="sd">        ValueError</span>
</span><span id="LCCalculations-342"><a href="#LCCalculations-342"><span class="linenos">342</span></a><span class="sd">            If no MS level data is found on the object.</span>
</span><span id="LCCalculations-343"><a href="#LCCalculations-343"><span class="linenos">343</span></a><span class="sd">            If persistent homology peak picking is attempted on non-profile mode data.</span>
</span><span id="LCCalculations-344"><a href="#LCCalculations-344"><span class="linenos">344</span></a><span class="sd">            If data is not gridded and grid is False.</span>
</span><span id="LCCalculations-345"><a href="#LCCalculations-345"><span class="linenos">345</span></a><span class="sd">            If peak picking method is not implemented.</span>
</span><span id="LCCalculations-346"><a href="#LCCalculations-346"><span class="linenos">346</span></a>
</span><span id="LCCalculations-347"><a href="#LCCalculations-347"><span class="linenos">347</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations-348"><a href="#LCCalculations-348"><span class="linenos">348</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations-349"><a href="#LCCalculations-349"><span class="linenos">349</span></a><span class="sd">        None, but assigns the mass_features and eics attributes to the object.</span>
</span><span id="LCCalculations-350"><a href="#LCCalculations-350"><span class="linenos">350</span></a>
</span><span id="LCCalculations-351"><a href="#LCCalculations-351"><span class="linenos">351</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations-352"><a href="#LCCalculations-352"><span class="linenos">352</span></a>        <span class="n">pp_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">peak_picking_method</span>
</span><span id="LCCalculations-353"><a href="#LCCalculations-353"><span class="linenos">353</span></a>
</span><span id="LCCalculations-354"><a href="#LCCalculations-354"><span class="linenos">354</span></a>        <span class="k">if</span> <span class="n">pp_method</span> <span class="o">==</span> <span class="s2">&quot;persistent homology&quot;</span><span class="p">:</span>
</span><span id="LCCalculations-355"><a href="#LCCalculations-355"><span class="linenos">355</span></a>            <span class="n">msx_scan_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_df</span><span class="p">[</span><span class="s2">&quot;ms_level&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ms_level</span><span class="p">]</span>
</span><span id="LCCalculations-356"><a href="#LCCalculations-356"><span class="linenos">356</span></a>            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">msx_scan_df</span><span class="p">[</span><span class="s2">&quot;ms_format&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;profile&quot;</span><span class="p">):</span>
</span><span id="LCCalculations-357"><a href="#LCCalculations-357"><span class="linenos">357</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">find_mass_features_ph</span><span class="p">(</span><span class="n">ms_level</span><span class="o">=</span><span class="n">ms_level</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>
</span><span id="LCCalculations-358"><a href="#LCCalculations-358"><span class="linenos">358</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cluster_mass_features</span><span class="p">(</span><span class="n">drop_children</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="s2">&quot;persistence&quot;</span><span class="p">)</span>
</span><span id="LCCalculations-359"><a href="#LCCalculations-359"><span class="linenos">359</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations-360"><a href="#LCCalculations-360"><span class="linenos">360</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LCCalculations-361"><a href="#LCCalculations-361"><span class="linenos">361</span></a>                    <span class="s2">&quot;MS</span><span class="si">{}</span><span class="s2"> scans are not profile mode, which is required for persistent homology peak picking.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="LCCalculations-362"><a href="#LCCalculations-362"><span class="linenos">362</span></a>                        <span class="n">ms_level</span>
</span><span id="LCCalculations-363"><a href="#LCCalculations-363"><span class="linenos">363</span></a>                    <span class="p">)</span>
</span><span id="LCCalculations-364"><a href="#LCCalculations-364"><span class="linenos">364</span></a>                <span class="p">)</span>
</span><span id="LCCalculations-365"><a href="#LCCalculations-365"><span class="linenos">365</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations-366"><a href="#LCCalculations-366"><span class="linenos">366</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Peak picking method not implemented&quot;</span><span class="p">)</span>
</span><span id="LCCalculations-367"><a href="#LCCalculations-367"><span class="linenos">367</span></a>
</span><span id="LCCalculations-368"><a href="#LCCalculations-368"><span class="linenos">368</span></a>    <span class="k">def</span> <span class="nf">integrate_mass_features</span><span class="p">(</span>
</span><span id="LCCalculations-369"><a href="#LCCalculations-369"><span class="linenos">369</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">drop_if_fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ms_level</span><span class="o">=</span><span class="mi">1</span>
</span><span id="LCCalculations-370"><a href="#LCCalculations-370"><span class="linenos">370</span></a>    <span class="p">):</span>
</span><span id="LCCalculations-371"><a href="#LCCalculations-371"><span class="linenos">371</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Integrate mass features and extract EICs.</span>
</span><span id="LCCalculations-372"><a href="#LCCalculations-372"><span class="linenos">372</span></a>
</span><span id="LCCalculations-373"><a href="#LCCalculations-373"><span class="linenos">373</span></a><span class="sd">        Populates the _eics attribute on the LCMSBase object for each unique mz in the mass_features dataframe and adds data (start_scan, final_scan, area) to the mass_features attribute.</span>
</span><span id="LCCalculations-374"><a href="#LCCalculations-374"><span class="linenos">374</span></a>
</span><span id="LCCalculations-375"><a href="#LCCalculations-375"><span class="linenos">375</span></a><span class="sd">        Parameters</span>
</span><span id="LCCalculations-376"><a href="#LCCalculations-376"><span class="linenos">376</span></a><span class="sd">        ----------</span>
</span><span id="LCCalculations-377"><a href="#LCCalculations-377"><span class="linenos">377</span></a><span class="sd">        drop_if_fail : bool, optional</span>
</span><span id="LCCalculations-378"><a href="#LCCalculations-378"><span class="linenos">378</span></a><span class="sd">            Whether to drop mass features if the EIC limit calculations fail.</span>
</span><span id="LCCalculations-379"><a href="#LCCalculations-379"><span class="linenos">379</span></a><span class="sd">            Default is True.</span>
</span><span id="LCCalculations-380"><a href="#LCCalculations-380"><span class="linenos">380</span></a><span class="sd">        drop_duplicates : bool, optional</span>
</span><span id="LCCalculations-381"><a href="#LCCalculations-381"><span class="linenos">381</span></a><span class="sd">            Whether to mass features that appear to be duplicates</span>
</span><span id="LCCalculations-382"><a href="#LCCalculations-382"><span class="linenos">382</span></a><span class="sd">            (i.e., mz is similar to another mass feature and limits of the EIC are similar or encapsulating).</span>
</span><span id="LCCalculations-383"><a href="#LCCalculations-383"><span class="linenos">383</span></a><span class="sd">            Default is True.</span>
</span><span id="LCCalculations-384"><a href="#LCCalculations-384"><span class="linenos">384</span></a><span class="sd">        ms_level : int, optional</span>
</span><span id="LCCalculations-385"><a href="#LCCalculations-385"><span class="linenos">385</span></a><span class="sd">            The MS level to use. Default is 1.</span>
</span><span id="LCCalculations-386"><a href="#LCCalculations-386"><span class="linenos">386</span></a>
</span><span id="LCCalculations-387"><a href="#LCCalculations-387"><span class="linenos">387</span></a><span class="sd">        Raises</span>
</span><span id="LCCalculations-388"><a href="#LCCalculations-388"><span class="linenos">388</span></a><span class="sd">        ------</span>
</span><span id="LCCalculations-389"><a href="#LCCalculations-389"><span class="linenos">389</span></a><span class="sd">        ValueError</span>
</span><span id="LCCalculations-390"><a href="#LCCalculations-390"><span class="linenos">390</span></a><span class="sd">            If no mass features are found.</span>
</span><span id="LCCalculations-391"><a href="#LCCalculations-391"><span class="linenos">391</span></a><span class="sd">            If no MS level data is found for the given MS level (either in data or in the scan data)</span>
</span><span id="LCCalculations-392"><a href="#LCCalculations-392"><span class="linenos">392</span></a>
</span><span id="LCCalculations-393"><a href="#LCCalculations-393"><span class="linenos">393</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations-394"><a href="#LCCalculations-394"><span class="linenos">394</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations-395"><a href="#LCCalculations-395"><span class="linenos">395</span></a><span class="sd">        None, but populates the eics attribute on the LCMSBase object and adds data (start_scan, final_scan, area) to the mass_features attribute.</span>
</span><span id="LCCalculations-396"><a href="#LCCalculations-396"><span class="linenos">396</span></a>
</span><span id="LCCalculations-397"><a href="#LCCalculations-397"><span class="linenos">397</span></a><span class="sd">        Notes</span>
</span><span id="LCCalculations-398"><a href="#LCCalculations-398"><span class="linenos">398</span></a><span class="sd">        -----</span>
</span><span id="LCCalculations-399"><a href="#LCCalculations-399"><span class="linenos">399</span></a><span class="sd">        drop_if_fail is useful for discarding mass features that do not have good shapes, usually due to a detection on a shoulder of a peak or a noisy region (especially if minimal smoothing is used during mass feature detection).</span>
</span><span id="LCCalculations-400"><a href="#LCCalculations-400"><span class="linenos">400</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations-401"><a href="#LCCalculations-401"><span class="linenos">401</span></a>        <span class="c1"># Check if there is data</span>
</span><span id="LCCalculations-402"><a href="#LCCalculations-402"><span class="linenos">402</span></a>        <span class="k">if</span> <span class="n">ms_level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LCCalculations-403"><a href="#LCCalculations-403"><span class="linenos">403</span></a>            <span class="n">raw_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="p">[</span><span class="n">ms_level</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations-404"><a href="#LCCalculations-404"><span class="linenos">404</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations-405"><a href="#LCCalculations-405"><span class="linenos">405</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No MS level &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ms_level</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; data found&quot;</span><span class="p">)</span>
</span><span id="LCCalculations-406"><a href="#LCCalculations-406"><span class="linenos">406</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations-407"><a href="#LCCalculations-407"><span class="linenos">407</span></a>            <span class="n">mf_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations-408"><a href="#LCCalculations-408"><span class="linenos">408</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations-409"><a href="#LCCalculations-409"><span class="linenos">409</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LCCalculations-410"><a href="#LCCalculations-410"><span class="linenos">410</span></a>                <span class="s2">&quot;No mass features found, did you run find_mass_features() first?&quot;</span>
</span><span id="LCCalculations-411"><a href="#LCCalculations-411"><span class="linenos">411</span></a>            <span class="p">)</span>
</span><span id="LCCalculations-412"><a href="#LCCalculations-412"><span class="linenos">412</span></a>        <span class="c1"># Check if mass_spectrum exists on each mass feature</span>
</span><span id="LCCalculations-413"><a href="#LCCalculations-413"><span class="linenos">413</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
</span><span id="LCCalculations-414"><a href="#LCCalculations-414"><span class="linenos">414</span></a>            <span class="p">[</span><span class="n">mf</span><span class="o">.</span><span class="n">mass_spectrum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
</span><span id="LCCalculations-415"><a href="#LCCalculations-415"><span class="linenos">415</span></a>        <span class="p">):</span>
</span><span id="LCCalculations-416"><a href="#LCCalculations-416"><span class="linenos">416</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LCCalculations-417"><a href="#LCCalculations-417"><span class="linenos">417</span></a>                <span class="s2">&quot;Mass spectrum must be associated with each mass feature, did you run add_associated_ms1() first?&quot;</span>
</span><span id="LCCalculations-418"><a href="#LCCalculations-418"><span class="linenos">418</span></a>            <span class="p">)</span>
</span><span id="LCCalculations-419"><a href="#LCCalculations-419"><span class="linenos">419</span></a>
</span><span id="LCCalculations-420"><a href="#LCCalculations-420"><span class="linenos">420</span></a>        <span class="c1"># Subset scan data to only include correct ms_level</span>
</span><span id="LCCalculations-421"><a href="#LCCalculations-421"><span class="linenos">421</span></a>        <span class="n">scan_df_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_df</span><span class="p">[</span>
</span><span id="LCCalculations-422"><a href="#LCCalculations-422"><span class="linenos">422</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scan_df</span><span class="p">[</span><span class="s2">&quot;ms_level&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">ms_level</span><span class="p">)</span>
</span><span id="LCCalculations-423"><a href="#LCCalculations-423"><span class="linenos">423</span></a>        <span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LCCalculations-424"><a href="#LCCalculations-424"><span class="linenos">424</span></a>        <span class="k">if</span> <span class="n">scan_df_sub</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="LCCalculations-425"><a href="#LCCalculations-425"><span class="linenos">425</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No MS level &quot;</span> <span class="o">+</span> <span class="n">ms_level</span> <span class="o">+</span> <span class="s2">&quot; data found in scan data&quot;</span><span class="p">)</span>
</span><span id="LCCalculations-426"><a href="#LCCalculations-426"><span class="linenos">426</span></a>        <span class="n">scan_df_sub</span> <span class="o">=</span> <span class="n">scan_df_sub</span><span class="p">[[</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations-427"><a href="#LCCalculations-427"><span class="linenos">427</span></a>
</span><span id="LCCalculations-428"><a href="#LCCalculations-428"><span class="linenos">428</span></a>        <span class="n">mzs_to_extract</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="LCCalculations-429"><a href="#LCCalculations-429"><span class="linenos">429</span></a>        <span class="n">mzs_to_extract</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</span><span id="LCCalculations-430"><a href="#LCCalculations-430"><span class="linenos">430</span></a>
</span><span id="LCCalculations-431"><a href="#LCCalculations-431"><span class="linenos">431</span></a>        <span class="c1"># Get EICs for each unique mz in mass features list</span>
</span><span id="LCCalculations-432"><a href="#LCCalculations-432"><span class="linenos">432</span></a>        <span class="k">for</span> <span class="n">mz</span> <span class="ow">in</span> <span class="n">mzs_to_extract</span><span class="p">:</span>
</span><span id="LCCalculations-433"><a href="#LCCalculations-433"><span class="linenos">433</span></a>            <span class="n">mz_max</span> <span class="o">=</span> <span class="n">mz</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">eic_tolerance_ppm</span> <span class="o">*</span> <span class="n">mz</span> <span class="o">/</span> <span class="mf">1e6</span>
</span><span id="LCCalculations-434"><a href="#LCCalculations-434"><span class="linenos">434</span></a>            <span class="n">mz_min</span> <span class="o">=</span> <span class="n">mz</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">eic_tolerance_ppm</span> <span class="o">*</span> <span class="n">mz</span> <span class="o">/</span> <span class="mf">1e6</span>
</span><span id="LCCalculations-435"><a href="#LCCalculations-435"><span class="linenos">435</span></a>            <span class="n">raw_data_sub</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span>
</span><span id="LCCalculations-436"><a href="#LCCalculations-436"><span class="linenos">436</span></a>                <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">mz_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">mz_max</span><span class="p">)</span>
</span><span id="LCCalculations-437"><a href="#LCCalculations-437"><span class="linenos">437</span></a>            <span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LCCalculations-438"><a href="#LCCalculations-438"><span class="linenos">438</span></a>            <span class="n">raw_data_sub</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LCCalculations-439"><a href="#LCCalculations-439"><span class="linenos">439</span></a>                <span class="n">raw_data_sub</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;scan&quot;</span><span class="p">])[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="LCCalculations-440"><a href="#LCCalculations-440"><span class="linenos">440</span></a>            <span class="p">)</span>
</span><span id="LCCalculations-441"><a href="#LCCalculations-441"><span class="linenos">441</span></a>            <span class="n">raw_data_sub</span> <span class="o">=</span> <span class="n">scan_df_sub</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">raw_data_sub</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</span><span id="LCCalculations-442"><a href="#LCCalculations-442"><span class="linenos">442</span></a>            <span class="n">raw_data_sub</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_data_sub</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="LCCalculations-443"><a href="#LCCalculations-443"><span class="linenos">443</span></a>            <span class="n">myEIC</span> <span class="o">=</span> <span class="n">EIC_Data</span><span class="p">(</span>
</span><span id="LCCalculations-444"><a href="#LCCalculations-444"><span class="linenos">444</span></a>                <span class="n">scans</span><span class="o">=</span><span class="n">raw_data_sub</span><span class="p">[</span><span class="s2">&quot;scan&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
</span><span id="LCCalculations-445"><a href="#LCCalculations-445"><span class="linenos">445</span></a>                <span class="n">time</span><span class="o">=</span><span class="n">raw_data_sub</span><span class="p">[</span><span class="s2">&quot;scan_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
</span><span id="LCCalculations-446"><a href="#LCCalculations-446"><span class="linenos">446</span></a>                <span class="n">eic</span><span class="o">=</span><span class="n">raw_data_sub</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
</span><span id="LCCalculations-447"><a href="#LCCalculations-447"><span class="linenos">447</span></a>            <span class="p">)</span>
</span><span id="LCCalculations-448"><a href="#LCCalculations-448"><span class="linenos">448</span></a>            <span class="c1"># Smooth EIC</span>
</span><span id="LCCalculations-449"><a href="#LCCalculations-449"><span class="linenos">449</span></a>            <span class="n">smoothed_eic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_tic</span><span class="p">(</span><span class="n">myEIC</span><span class="o">.</span><span class="n">eic</span><span class="p">)</span>
</span><span id="LCCalculations-450"><a href="#LCCalculations-450"><span class="linenos">450</span></a>            <span class="n">smoothed_eic</span><span class="p">[</span><span class="n">smoothed_eic</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LCCalculations-451"><a href="#LCCalculations-451"><span class="linenos">451</span></a>            <span class="n">myEIC</span><span class="o">.</span><span class="n">eic_smoothed</span> <span class="o">=</span> <span class="n">smoothed_eic</span>
</span><span id="LCCalculations-452"><a href="#LCCalculations-452"><span class="linenos">452</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eics</span><span class="p">[</span><span class="n">mz</span><span class="p">]</span> <span class="o">=</span> <span class="n">myEIC</span>
</span><span id="LCCalculations-453"><a href="#LCCalculations-453"><span class="linenos">453</span></a>
</span><span id="LCCalculations-454"><a href="#LCCalculations-454"><span class="linenos">454</span></a>        <span class="c1"># Get limits of mass features using EIC centroid detector and integrate</span>
</span><span id="LCCalculations-455"><a href="#LCCalculations-455"><span class="linenos">455</span></a>        <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="LCCalculations-456"><a href="#LCCalculations-456"><span class="linenos">456</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mass_feature</span> <span class="ow">in</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="LCCalculations-457"><a href="#LCCalculations-457"><span class="linenos">457</span></a>            <span class="n">mz</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">mz</span>
</span><span id="LCCalculations-458"><a href="#LCCalculations-458"><span class="linenos">458</span></a>            <span class="n">apex_scan</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">apex_scan</span>
</span><span id="LCCalculations-459"><a href="#LCCalculations-459"><span class="linenos">459</span></a>
</span><span id="LCCalculations-460"><a href="#LCCalculations-460"><span class="linenos">460</span></a>            <span class="c1"># Pull EIC data and find apex scan index</span>
</span><span id="LCCalculations-461"><a href="#LCCalculations-461"><span class="linenos">461</span></a>            <span class="n">myEIC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eics</span><span class="p">[</span><span class="n">mz</span><span class="p">]</span>
</span><span id="LCCalculations-462"><a href="#LCCalculations-462"><span class="linenos">462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">_eic_data</span> <span class="o">=</span> <span class="n">myEIC</span>
</span><span id="LCCalculations-463"><a href="#LCCalculations-463"><span class="linenos">463</span></a>            <span class="n">apex_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">myEIC</span><span class="o">.</span><span class="n">scans</span> <span class="o">==</span> <span class="n">apex_scan</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LCCalculations-464"><a href="#LCCalculations-464"><span class="linenos">464</span></a>
</span><span id="LCCalculations-465"><a href="#LCCalculations-465"><span class="linenos">465</span></a>            <span class="c1"># Find left and right limits of peak using EIC centroid detector, add to EICData</span>
</span><span id="LCCalculations-466"><a href="#LCCalculations-466"><span class="linenos">466</span></a>            <span class="n">centroid_eics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eic_centroid_detector</span><span class="p">(</span>
</span><span id="LCCalculations-467"><a href="#LCCalculations-467"><span class="linenos">467</span></a>                <span class="n">myEIC</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
</span><span id="LCCalculations-468"><a href="#LCCalculations-468"><span class="linenos">468</span></a>                <span class="n">myEIC</span><span class="o">.</span><span class="n">eic_smoothed</span><span class="p">,</span>
</span><span id="LCCalculations-469"><a href="#LCCalculations-469"><span class="linenos">469</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">intensity</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span>
</span><span id="LCCalculations-470"><a href="#LCCalculations-470"><span class="linenos">470</span></a>                <span class="n">apex_indexes</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">apex_index</span><span class="p">)],</span>
</span><span id="LCCalculations-471"><a href="#LCCalculations-471"><span class="linenos">471</span></a>            <span class="p">)</span>
</span><span id="LCCalculations-472"><a href="#LCCalculations-472"><span class="linenos">472</span></a>            <span class="n">l_a_r_scan_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">centroid_eics</span><span class="p">]</span>
</span><span id="LCCalculations-473"><a href="#LCCalculations-473"><span class="linenos">473</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_a_r_scan_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LCCalculations-474"><a href="#LCCalculations-474"><span class="linenos">474</span></a>                <span class="c1"># Add start and final scan to mass_features and EICData</span>
</span><span id="LCCalculations-475"><a href="#LCCalculations-475"><span class="linenos">475</span></a>                <span class="n">left_scan</span><span class="p">,</span> <span class="n">right_scan</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LCCalculations-476"><a href="#LCCalculations-476"><span class="linenos">476</span></a>                    <span class="n">myEIC</span><span class="o">.</span><span class="n">scans</span><span class="p">[</span><span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="LCCalculations-477"><a href="#LCCalculations-477"><span class="linenos">477</span></a>                    <span class="n">myEIC</span><span class="o">.</span><span class="n">scans</span><span class="p">[</span><span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]],</span>
</span><span id="LCCalculations-478"><a href="#LCCalculations-478"><span class="linenos">478</span></a>                <span class="p">)</span>
</span><span id="LCCalculations-479"><a href="#LCCalculations-479"><span class="linenos">479</span></a>                <span class="n">mf_scan_apex</span> <span class="o">=</span> <span class="p">[(</span><span class="n">left_scan</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">apex_scan</span><span class="p">),</span> <span class="n">right_scan</span><span class="p">)]</span>
</span><span id="LCCalculations-480"><a href="#LCCalculations-480"><span class="linenos">480</span></a>                <span class="n">myEIC</span><span class="o">.</span><span class="n">apexes</span> <span class="o">=</span> <span class="n">myEIC</span><span class="o">.</span><span class="n">apexes</span> <span class="o">+</span> <span class="n">mf_scan_apex</span>
</span><span id="LCCalculations-481"><a href="#LCCalculations-481"><span class="linenos">481</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">start_scan</span> <span class="o">=</span> <span class="n">left_scan</span>
</span><span id="LCCalculations-482"><a href="#LCCalculations-482"><span class="linenos">482</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">final_scan</span> <span class="o">=</span> <span class="n">right_scan</span>
</span><span id="LCCalculations-483"><a href="#LCCalculations-483"><span class="linenos">483</span></a>
</span><span id="LCCalculations-484"><a href="#LCCalculations-484"><span class="linenos">484</span></a>                <span class="c1"># Find area under peak using limits from EIC centroid detector, add to mass_features and EICData</span>
</span><span id="LCCalculations-485"><a href="#LCCalculations-485"><span class="linenos">485</span></a>                <span class="n">area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span>
</span><span id="LCCalculations-486"><a href="#LCCalculations-486"><span class="linenos">486</span></a>                    <span class="n">myEIC</span><span class="o">.</span><span class="n">eic_smoothed</span><span class="p">[</span><span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="LCCalculations-487"><a href="#LCCalculations-487"><span class="linenos">487</span></a>                    <span class="n">myEIC</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="LCCalculations-488"><a href="#LCCalculations-488"><span class="linenos">488</span></a>                <span class="p">)</span>
</span><span id="LCCalculations-489"><a href="#LCCalculations-489"><span class="linenos">489</span></a>                <span class="n">mf_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span>
</span><span id="LCCalculations-490"><a href="#LCCalculations-490"><span class="linenos">490</span></a>                <span class="n">myEIC</span><span class="o">.</span><span class="n">areas</span> <span class="o">=</span> <span class="n">myEIC</span><span class="o">.</span><span class="n">areas</span> <span class="o">+</span> <span class="p">[</span><span class="n">area</span><span class="p">]</span>
</span><span id="LCCalculations-491"><a href="#LCCalculations-491"><span class="linenos">491</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">eics</span><span class="p">[</span><span class="n">mz</span><span class="p">]</span> <span class="o">=</span> <span class="n">myEIC</span>
</span><span id="LCCalculations-492"><a href="#LCCalculations-492"><span class="linenos">492</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">_area</span> <span class="o">=</span> <span class="n">area</span>
</span><span id="LCCalculations-493"><a href="#LCCalculations-493"><span class="linenos">493</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations-494"><a href="#LCCalculations-494"><span class="linenos">494</span></a>                <span class="k">if</span> <span class="n">drop_if_fail</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="LCCalculations-495"><a href="#LCCalculations-495"><span class="linenos">495</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span id="LCCalculations-496"><a href="#LCCalculations-496"><span class="linenos">496</span></a>
</span><span id="LCCalculations-497"><a href="#LCCalculations-497"><span class="linenos">497</span></a>        <span class="k">if</span> <span class="n">drop_duplicates</span><span class="p">:</span>
</span><span id="LCCalculations-498"><a href="#LCCalculations-498"><span class="linenos">498</span></a>            <span class="c1"># Prepare mass feature dataframe</span>
</span><span id="LCCalculations-499"><a href="#LCCalculations-499"><span class="linenos">499</span></a>            <span class="n">mf_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations-500"><a href="#LCCalculations-500"><span class="linenos">500</span></a>
</span><span id="LCCalculations-501"><a href="#LCCalculations-501"><span class="linenos">501</span></a>            <span class="c1"># For each mass feature, find all mass features within the clustering tolerance ppm and drop if their start and end times are within another mass feature</span>
</span><span id="LCCalculations-502"><a href="#LCCalculations-502"><span class="linenos">502</span></a>            <span class="c1"># Kepp the first mass fea</span>
</span><span id="LCCalculations-503"><a href="#LCCalculations-503"><span class="linenos">503</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mass_feature</span> <span class="ow">in</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="LCCalculations-504"><a href="#LCCalculations-504"><span class="linenos">504</span></a>                <span class="n">mz</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">mz</span>
</span><span id="LCCalculations-505"><a href="#LCCalculations-505"><span class="linenos">505</span></a>                <span class="n">apex_scan</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">apex_scan</span>
</span><span id="LCCalculations-506"><a href="#LCCalculations-506"><span class="linenos">506</span></a>
</span><span id="LCCalculations-507"><a href="#LCCalculations-507"><span class="linenos">507</span></a>                <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mz_diff_ppm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mz</span><span class="p">)</span> <span class="o">/</span> <span class="n">mz</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
</span><span id="LCCalculations-508"><a href="#LCCalculations-508"><span class="linenos">508</span></a>                <span class="n">mf_df_sub</span> <span class="o">=</span> <span class="n">mf_df</span><span class="p">[</span>
</span><span id="LCCalculations-509"><a href="#LCCalculations-509"><span class="linenos">509</span></a>                    <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mz_diff_ppm&quot;</span><span class="p">]</span>
</span><span id="LCCalculations-510"><a href="#LCCalculations-510"><span class="linenos">510</span></a>                    <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_mz_tolerance_rel</span>
</span><span id="LCCalculations-511"><a href="#LCCalculations-511"><span class="linenos">511</span></a>                    <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
</span><span id="LCCalculations-512"><a href="#LCCalculations-512"><span class="linenos">512</span></a>                <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations-513"><a href="#LCCalculations-513"><span class="linenos">513</span></a>
</span><span id="LCCalculations-514"><a href="#LCCalculations-514"><span class="linenos">514</span></a>                <span class="c1"># For all mass features within the clustering tolerance, check if the start and end times are within the start and end times of the mass feature</span>
</span><span id="LCCalculations-515"><a href="#LCCalculations-515"><span class="linenos">515</span></a>                <span class="k">for</span> <span class="n">idx2</span><span class="p">,</span> <span class="n">mass_feature2</span> <span class="ow">in</span> <span class="n">mf_df_sub</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="LCCalculations-516"><a href="#LCCalculations-516"><span class="linenos">516</span></a>                    <span class="k">if</span> <span class="n">idx2</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">:</span>
</span><span id="LCCalculations-517"><a href="#LCCalculations-517"><span class="linenos">517</span></a>                        <span class="k">if</span> <span class="p">(</span>
</span><span id="LCCalculations-518"><a href="#LCCalculations-518"><span class="linenos">518</span></a>                            <span class="n">mass_feature2</span><span class="o">.</span><span class="n">start_scan</span> <span class="o">&gt;=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">start_scan</span>
</span><span id="LCCalculations-519"><a href="#LCCalculations-519"><span class="linenos">519</span></a>                            <span class="ow">and</span> <span class="n">mass_feature2</span><span class="o">.</span><span class="n">final_scan</span> <span class="o">&lt;=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">final_scan</span>
</span><span id="LCCalculations-520"><a href="#LCCalculations-520"><span class="linenos">520</span></a>                        <span class="p">):</span>
</span><span id="LCCalculations-521"><a href="#LCCalculations-521"><span class="linenos">521</span></a>                            <span class="k">if</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LCCalculations-522"><a href="#LCCalculations-522"><span class="linenos">522</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx2</span><span class="p">)</span>
</span><span id="LCCalculations-523"><a href="#LCCalculations-523"><span class="linenos">523</span></a>
</span><span id="LCCalculations-524"><a href="#LCCalculations-524"><span class="linenos">524</span></a>    <span class="k">def</span> <span class="nf">find_c13_mass_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LCCalculations-525"><a href="#LCCalculations-525"><span class="linenos">525</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Mark likely C13 isotopes and connect to monoisoitopic mass features.</span>
</span><span id="LCCalculations-526"><a href="#LCCalculations-526"><span class="linenos">526</span></a>
</span><span id="LCCalculations-527"><a href="#LCCalculations-527"><span class="linenos">527</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations-528"><a href="#LCCalculations-528"><span class="linenos">528</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations-529"><a href="#LCCalculations-529"><span class="linenos">529</span></a><span class="sd">        None, but populates the monoisotopic_mf_id and isotopologue_type attributes to the indivual LCMSMassFeatures within the mass_features attribute of the LCMSBase object.</span>
</span><span id="LCCalculations-530"><a href="#LCCalculations-530"><span class="linenos">530</span></a>
</span><span id="LCCalculations-531"><a href="#LCCalculations-531"><span class="linenos">531</span></a><span class="sd">        Raises</span>
</span><span id="LCCalculations-532"><a href="#LCCalculations-532"><span class="linenos">532</span></a><span class="sd">        ------</span>
</span><span id="LCCalculations-533"><a href="#LCCalculations-533"><span class="linenos">533</span></a><span class="sd">        ValueError</span>
</span><span id="LCCalculations-534"><a href="#LCCalculations-534"><span class="linenos">534</span></a><span class="sd">            If no mass features are found.</span>
</span><span id="LCCalculations-535"><a href="#LCCalculations-535"><span class="linenos">535</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations-536"><a href="#LCCalculations-536"><span class="linenos">536</span></a>        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="LCCalculations-537"><a href="#LCCalculations-537"><span class="linenos">537</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="LCCalculations-538"><a href="#LCCalculations-538"><span class="linenos">538</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;evaluating mass features for C13 isotopes&quot;</span><span class="p">)</span>
</span><span id="LCCalculations-539"><a href="#LCCalculations-539"><span class="linenos">539</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations-540"><a href="#LCCalculations-540"><span class="linenos">540</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No mass features found, run find_mass_features() first&quot;</span><span class="p">)</span>
</span><span id="LCCalculations-541"><a href="#LCCalculations-541"><span class="linenos">541</span></a>
</span><span id="LCCalculations-542"><a href="#LCCalculations-542"><span class="linenos">542</span></a>        <span class="c1"># Data prep fo sparse distance matrix</span>
</span><span id="LCCalculations-543"><a href="#LCCalculations-543"><span class="linenos">543</span></a>        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]</span>
</span><span id="LCCalculations-544"><a href="#LCCalculations-544"><span class="linenos">544</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations-545"><a href="#LCCalculations-545"><span class="linenos">545</span></a>        <span class="c1"># Drop mass features that have no area (these are likely to be noise)</span>
</span><span id="LCCalculations-546"><a href="#LCCalculations-546"><span class="linenos">546</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df</span><span class="p">[</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>
</span><span id="LCCalculations-547"><a href="#LCCalculations-547"><span class="linenos">547</span></a>        <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mf_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="LCCalculations-548"><a href="#LCCalculations-548"><span class="linenos">548</span></a>        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]</span>
</span><span id="LCCalculations-549"><a href="#LCCalculations-549"><span class="linenos">549</span></a>
</span><span id="LCCalculations-550"><a href="#LCCalculations-550"><span class="linenos">550</span></a>        <span class="c1"># Sort my ascending mz so we always get the monoisotopic mass first, regardless of the order/intensity of the mass features</span>
</span><span id="LCCalculations-551"><a href="#LCCalculations-551"><span class="linenos">551</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations-552"><a href="#LCCalculations-552"><span class="linenos">552</span></a>
</span><span id="LCCalculations-553"><a href="#LCCalculations-553"><span class="linenos">553</span></a>        <span class="n">mz_diff</span> <span class="o">=</span> <span class="mf">1.003355</span>  <span class="c1"># C13-C12 mass difference</span>
</span><span id="LCCalculations-554"><a href="#LCCalculations-554"><span class="linenos">554</span></a>        <span class="n">tol</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LCCalculations-555"><a href="#LCCalculations-555"><span class="linenos">555</span></a>            <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
</span><span id="LCCalculations-556"><a href="#LCCalculations-556"><span class="linenos">556</span></a>            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_mz_tolerance_rel</span><span class="p">,</span>
</span><span id="LCCalculations-557"><a href="#LCCalculations-557"><span class="linenos">557</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_rt_tolerance</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="LCCalculations-558"><a href="#LCCalculations-558"><span class="linenos">558</span></a>        <span class="p">]</span>  <span class="c1"># mz, in relative; scan_time in minutes</span>
</span><span id="LCCalculations-559"><a href="#LCCalculations-559"><span class="linenos">559</span></a>
</span><span id="LCCalculations-560"><a href="#LCCalculations-560"><span class="linenos">560</span></a>        <span class="c1"># Compute inter-feature distances</span>
</span><span id="LCCalculations-561"><a href="#LCCalculations-561"><span class="linenos">561</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LCCalculations-562"><a href="#LCCalculations-562"><span class="linenos">562</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)):</span>
</span><span id="LCCalculations-563"><a href="#LCCalculations-563"><span class="linenos">563</span></a>            <span class="c1"># Construct k-d tree</span>
</span><span id="LCCalculations-564"><a href="#LCCalculations-564"><span class="linenos">564</span></a>            <span class="n">values</span> <span class="o">=</span> <span class="n">mf_df</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="LCCalculations-565"><a href="#LCCalculations-565"><span class="linenos">565</span></a>            <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="LCCalculations-566"><a href="#LCCalculations-566"><span class="linenos">566</span></a>
</span><span id="LCCalculations-567"><a href="#LCCalculations-567"><span class="linenos">567</span></a>            <span class="n">max_tol</span> <span class="o">=</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="LCCalculations-568"><a href="#LCCalculations-568"><span class="linenos">568</span></a>            <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mz&quot;</span><span class="p">:</span>
</span><span id="LCCalculations-569"><a href="#LCCalculations-569"><span class="linenos">569</span></a>                <span class="c1"># Maximum absolute tolerance</span>
</span><span id="LCCalculations-570"><a href="#LCCalculations-570"><span class="linenos">570</span></a>                <span class="n">max_tol</span> <span class="o">=</span> <span class="n">mz_diff</span> <span class="o">+</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="LCCalculations-571"><a href="#LCCalculations-571"><span class="linenos">571</span></a>
</span><span id="LCCalculations-572"><a href="#LCCalculations-572"><span class="linenos">572</span></a>            <span class="c1"># Compute sparse distance matrix</span>
</span><span id="LCCalculations-573"><a href="#LCCalculations-573"><span class="linenos">573</span></a>            <span class="c1"># the larger the max_tol, the slower this operation is</span>
</span><span id="LCCalculations-574"><a href="#LCCalculations-574"><span class="linenos">574</span></a>            <span class="n">sdm</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">sparse_distance_matrix</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">max_tol</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;coo_matrix&quot;</span><span class="p">)</span>
</span><span id="LCCalculations-575"><a href="#LCCalculations-575"><span class="linenos">575</span></a>
</span><span id="LCCalculations-576"><a href="#LCCalculations-576"><span class="linenos">576</span></a>            <span class="c1"># Only consider forward case, exclude diagonal</span>
</span><span id="LCCalculations-577"><a href="#LCCalculations-577"><span class="linenos">577</span></a>            <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">sdm</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LCCalculations-578"><a href="#LCCalculations-578"><span class="linenos">578</span></a>
</span><span id="LCCalculations-579"><a href="#LCCalculations-579"><span class="linenos">579</span></a>            <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mz&quot;</span><span class="p">:</span>
</span><span id="LCCalculations-580"><a href="#LCCalculations-580"><span class="linenos">580</span></a>                <span class="n">min_tol</span> <span class="o">=</span> <span class="n">mz_diff</span> <span class="o">-</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="LCCalculations-581"><a href="#LCCalculations-581"><span class="linenos">581</span></a>                <span class="c1"># Get only the ones that are above the min tol</span>
</span><span id="LCCalculations-582"><a href="#LCCalculations-582"><span class="linenos">582</span></a>                <span class="n">idx</span> <span class="o">=</span> <span class="n">sdm</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">min_tol</span>
</span><span id="LCCalculations-583"><a href="#LCCalculations-583"><span class="linenos">583</span></a>
</span><span id="LCCalculations-584"><a href="#LCCalculations-584"><span class="linenos">584</span></a>                <span class="c1"># Reconstruct sparse distance matrix</span>
</span><span id="LCCalculations-585"><a href="#LCCalculations-585"><span class="linenos">585</span></a>                <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">(</span>
</span><span id="LCCalculations-586"><a href="#LCCalculations-586"><span class="linenos">586</span></a>                    <span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">sdm</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">idx</span><span class="p">])),</span>
</span><span id="LCCalculations-587"><a href="#LCCalculations-587"><span class="linenos">587</span></a>                    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
</span><span id="LCCalculations-588"><a href="#LCCalculations-588"><span class="linenos">588</span></a>                <span class="p">)</span>
</span><span id="LCCalculations-589"><a href="#LCCalculations-589"><span class="linenos">589</span></a>
</span><span id="LCCalculations-590"><a href="#LCCalculations-590"><span class="linenos">590</span></a>            <span class="c1"># Cast as binary matrix</span>
</span><span id="LCCalculations-591"><a href="#LCCalculations-591"><span class="linenos">591</span></a>            <span class="n">sdm</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="LCCalculations-592"><a href="#LCCalculations-592"><span class="linenos">592</span></a>
</span><span id="LCCalculations-593"><a href="#LCCalculations-593"><span class="linenos">593</span></a>            <span class="c1"># Stack distances</span>
</span><span id="LCCalculations-594"><a href="#LCCalculations-594"><span class="linenos">594</span></a>            <span class="k">if</span> <span class="n">distances</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations-595"><a href="#LCCalculations-595"><span class="linenos">595</span></a>                <span class="n">distances</span> <span class="o">=</span> <span class="n">sdm</span>
</span><span id="LCCalculations-596"><a href="#LCCalculations-596"><span class="linenos">596</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations-597"><a href="#LCCalculations-597"><span class="linenos">597</span></a>                <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sdm</span><span class="p">)</span>
</span><span id="LCCalculations-598"><a href="#LCCalculations-598"><span class="linenos">598</span></a>
</span><span id="LCCalculations-599"><a href="#LCCalculations-599"><span class="linenos">599</span></a>        <span class="c1"># Extract indices of within-tolerance points</span>
</span><span id="LCCalculations-600"><a href="#LCCalculations-600"><span class="linenos">600</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">tocoo</span><span class="p">()</span>
</span><span id="LCCalculations-601"><a href="#LCCalculations-601"><span class="linenos">601</span></a>        <span class="n">pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">distances</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">distances</span><span class="o">.</span><span class="n">col</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># C12 to C13 pairs</span>
</span><span id="LCCalculations-602"><a href="#LCCalculations-602"><span class="linenos">602</span></a>
</span><span id="LCCalculations-603"><a href="#LCCalculations-603"><span class="linenos">603</span></a>        <span class="c1"># Turn pairs (which are index of mf_df) into mf_id and then into two dataframes to join to mf_df</span>
</span><span id="LCCalculations-604"><a href="#LCCalculations-604"><span class="linenos">604</span></a>        <span class="n">pairs_mf</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations-605"><a href="#LCCalculations-605"><span class="linenos">605</span></a>        <span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">mf_id</span><span class="o">.</span><span class="n">values</span>
</span><span id="LCCalculations-606"><a href="#LCCalculations-606"><span class="linenos">606</span></a>        <span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">mf_id</span><span class="o">.</span><span class="n">values</span>
</span><span id="LCCalculations-607"><a href="#LCCalculations-607"><span class="linenos">607</span></a>
</span><span id="LCCalculations-608"><a href="#LCCalculations-608"><span class="linenos">608</span></a>        <span class="c1"># Connect monoisotopic masses with isotopologes within mass_features</span>
</span><span id="LCCalculations-609"><a href="#LCCalculations-609"><span class="linenos">609</span></a>        <span class="n">monos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
</span><span id="LCCalculations-610"><a href="#LCCalculations-610"><span class="linenos">610</span></a>        <span class="k">for</span> <span class="n">mono</span> <span class="ow">in</span> <span class="n">monos</span><span class="p">:</span>
</span><span id="LCCalculations-611"><a href="#LCCalculations-611"><span class="linenos">611</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">mono</span><span class="p">]</span><span class="o">.</span><span class="n">monoisotopic_mf_id</span> <span class="o">=</span> <span class="n">mono</span>
</span><span id="LCCalculations-612"><a href="#LCCalculations-612"><span class="linenos">612</span></a>        <span class="n">pairs_iso_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pairs_mf</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;parent&quot;</span><span class="p">,</span> <span class="s2">&quot;child&quot;</span><span class="p">])</span>
</span><span id="LCCalculations-613"><a href="#LCCalculations-613"><span class="linenos">613</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="LCCalculations-614"><a href="#LCCalculations-614"><span class="linenos">614</span></a>            <span class="n">pairs_iso_df</span> <span class="o">=</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LCCalculations-615"><a href="#LCCalculations-615"><span class="linenos">615</span></a>            <span class="n">m1_isos</span> <span class="o">=</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">monos</span><span class="p">,</span> <span class="s2">&quot;child&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="LCCalculations-616"><a href="#LCCalculations-616"><span class="linenos">616</span></a>            <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">m1_isos</span><span class="p">:</span>
</span><span id="LCCalculations-617"><a href="#LCCalculations-617"><span class="linenos">617</span></a>                <span class="c1"># Set monoisotopic_mf_id and isotopologue_type for isotopologues</span>
</span><span id="LCCalculations-618"><a href="#LCCalculations-618"><span class="linenos">618</span></a>                <span class="n">parent</span> <span class="o">=</span> <span class="n">pairs_mf</span><span class="p">[</span><span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">iso</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="LCCalculations-619"><a href="#LCCalculations-619"><span class="linenos">619</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LCCalculations-620"><a href="#LCCalculations-620"><span class="linenos">620</span></a>                    <span class="c1"># Choose the parent that is closest in time to the isotopologue</span>
</span><span id="LCCalculations-621"><a href="#LCCalculations-621"><span class="linenos">621</span></a>                    <span class="n">parent_time</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">retention_time</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parent</span><span class="p">]</span>
</span><span id="LCCalculations-622"><a href="#LCCalculations-622"><span class="linenos">622</span></a>                    <span class="n">time_diff</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LCCalculations-623"><a href="#LCCalculations-623"><span class="linenos">623</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">retention_time</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>
</span><span id="LCCalculations-624"><a href="#LCCalculations-624"><span class="linenos">624</span></a>                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parent_time</span>
</span><span id="LCCalculations-625"><a href="#LCCalculations-625"><span class="linenos">625</span></a>                    <span class="p">]</span>
</span><span id="LCCalculations-626"><a href="#LCCalculations-626"><span class="linenos">626</span></a>                    <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">time_diff</span><span class="p">)]</span>
</span><span id="LCCalculations-627"><a href="#LCCalculations-627"><span class="linenos">627</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations-628"><a href="#LCCalculations-628"><span class="linenos">628</span></a>                    <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LCCalculations-629"><a href="#LCCalculations-629"><span class="linenos">629</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">monoisotopic_mf_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span>
</span><span id="LCCalculations-630"><a href="#LCCalculations-630"><span class="linenos">630</span></a>                    <span class="n">parent</span>
</span><span id="LCCalculations-631"><a href="#LCCalculations-631"><span class="linenos">631</span></a>                <span class="p">]</span><span class="o">.</span><span class="n">monoisotopic_mf_id</span>
</span><span id="LCCalculations-632"><a href="#LCCalculations-632"><span class="linenos">632</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">monoisotopic_mf_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations-633"><a href="#LCCalculations-633"><span class="linenos">633</span></a>                    <span class="n">mass_diff</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LCCalculations-634"><a href="#LCCalculations-634"><span class="linenos">634</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">mz</span>
</span><span id="LCCalculations-635"><a href="#LCCalculations-635"><span class="linenos">635</span></a>                        <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span>
</span><span id="LCCalculations-636"><a href="#LCCalculations-636"><span class="linenos">636</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">monoisotopic_mf_id</span>
</span><span id="LCCalculations-637"><a href="#LCCalculations-637"><span class="linenos">637</span></a>                        <span class="p">]</span><span class="o">.</span><span class="n">mz</span>
</span><span id="LCCalculations-638"><a href="#LCCalculations-638"><span class="linenos">638</span></a>                    <span class="p">)</span>
</span><span id="LCCalculations-639"><a href="#LCCalculations-639"><span class="linenos">639</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">isotopologue_type</span> <span class="o">=</span> <span class="s2">&quot;13C&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="LCCalculations-640"><a href="#LCCalculations-640"><span class="linenos">640</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">mass_diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="LCCalculations-641"><a href="#LCCalculations-641"><span class="linenos">641</span></a>                    <span class="p">)</span>
</span><span id="LCCalculations-642"><a href="#LCCalculations-642"><span class="linenos">642</span></a>
</span><span id="LCCalculations-643"><a href="#LCCalculations-643"><span class="linenos">643</span></a>            <span class="c1"># Drop the mono and iso from the pairs_iso_df</span>
</span><span id="LCCalculations-644"><a href="#LCCalculations-644"><span class="linenos">644</span></a>            <span class="n">pairs_iso_df</span> <span class="o">=</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="LCCalculations-645"><a href="#LCCalculations-645"><span class="linenos">645</span></a>                <span class="n">index</span><span class="o">=</span><span class="n">monos</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="LCCalculations-646"><a href="#LCCalculations-646"><span class="linenos">646</span></a>            <span class="p">)</span>  <span class="c1"># Drop pairs where the parent is a child that is a child of a root</span>
</span><span id="LCCalculations-647"><a href="#LCCalculations-647"><span class="linenos">647</span></a>            <span class="n">pairs_iso_df</span> <span class="o">=</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;child&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LCCalculations-648"><a href="#LCCalculations-648"><span class="linenos">648</span></a>            <span class="n">pairs_iso_df</span> <span class="o">=</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">m1_isos</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="LCCalculations-649"><a href="#LCCalculations-649"><span class="linenos">649</span></a>
</span><span id="LCCalculations-650"><a href="#LCCalculations-650"><span class="linenos">650</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="LCCalculations-651"><a href="#LCCalculations-651"><span class="linenos">651</span></a>                <span class="c1"># Get new monos, recognizing that these are just 13C isotopologues that are connected to other 13C isotopologues to repeat the process</span>
</span><span id="LCCalculations-652"><a href="#LCCalculations-652"><span class="linenos">652</span></a>                <span class="n">monos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span>
</span><span id="LCCalculations-653"><a href="#LCCalculations-653"><span class="linenos">653</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">parent</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">child</span><span class="p">)</span>
</span><span id="LCCalculations-654"><a href="#LCCalculations-654"><span class="linenos">654</span></a>                <span class="p">)</span>
</span><span id="LCCalculations-655"><a href="#LCCalculations-655"><span class="linenos">655</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="LCCalculations-656"><a href="#LCCalculations-656"><span class="linenos">656</span></a>            <span class="c1"># Report fraction of compounds annotated with isotopes</span>
</span><span id="LCCalculations-657"><a href="#LCCalculations-657"><span class="linenos">657</span></a>            <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;c13_flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="LCCalculations-658"><a href="#LCCalculations-658"><span class="linenos">658</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
</span><span id="LCCalculations-659"><a href="#LCCalculations-659"><span class="linenos">659</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mf_id&quot;</span><span class="p">],</span> <span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span>
</span><span id="LCCalculations-660"><a href="#LCCalculations-660"><span class="linenos">660</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mf_id&quot;</span><span class="p">],</span> <span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span>
</span><span id="LCCalculations-661"><a href="#LCCalculations-661"><span class="linenos">661</span></a>                <span class="p">),</span>
</span><span id="LCCalculations-662"><a href="#LCCalculations-662"><span class="linenos">662</span></a>                <span class="mi">1</span><span class="p">,</span>
</span><span id="LCCalculations-663"><a href="#LCCalculations-663"><span class="linenos">663</span></a>                <span class="mi">0</span><span class="p">,</span>
</span><span id="LCCalculations-664"><a href="#LCCalculations-664"><span class="linenos">664</span></a>            <span class="p">)</span>
</span><span id="LCCalculations-665"><a href="#LCCalculations-665"><span class="linenos">665</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="LCCalculations-666"><a href="#LCCalculations-666"><span class="linenos">666</span></a>                <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf_df</span><span class="p">[</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;c13_flag&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mf_df</span><span class="p">),</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
</span><span id="LCCalculations-667"><a href="#LCCalculations-667"><span class="linenos">667</span></a>                <span class="o">+</span> <span class="s2">&quot; of mass features have or are C13 isotopes&quot;</span>
</span><span id="LCCalculations-668"><a href="#LCCalculations-668"><span class="linenos">668</span></a>            <span class="p">)</span>
</span><span id="LCCalculations-669"><a href="#LCCalculations-669"><span class="linenos">669</span></a>
</span><span id="LCCalculations-670"><a href="#LCCalculations-670"><span class="linenos">670</span></a>    <span class="k">def</span> <span class="nf">deconvolute_ms1_mass_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LCCalculations-671"><a href="#LCCalculations-671"><span class="linenos">671</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Deconvolute MS1 mass features</span>
</span><span id="LCCalculations-672"><a href="#LCCalculations-672"><span class="linenos">672</span></a>
</span><span id="LCCalculations-673"><a href="#LCCalculations-673"><span class="linenos">673</span></a><span class="sd">        Deconvolute mass features ms1 spectrum based on the correlation of all masses within a spectrum over the EIC of the mass features</span>
</span><span id="LCCalculations-674"><a href="#LCCalculations-674"><span class="linenos">674</span></a>
</span><span id="LCCalculations-675"><a href="#LCCalculations-675"><span class="linenos">675</span></a><span class="sd">        Parameters</span>
</span><span id="LCCalculations-676"><a href="#LCCalculations-676"><span class="linenos">676</span></a><span class="sd">        ----------</span>
</span><span id="LCCalculations-677"><a href="#LCCalculations-677"><span class="linenos">677</span></a><span class="sd">        None</span>
</span><span id="LCCalculations-678"><a href="#LCCalculations-678"><span class="linenos">678</span></a>
</span><span id="LCCalculations-679"><a href="#LCCalculations-679"><span class="linenos">679</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations-680"><a href="#LCCalculations-680"><span class="linenos">680</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations-681"><a href="#LCCalculations-681"><span class="linenos">681</span></a><span class="sd">        None, but assigns the _ms_deconvoluted_idx, mass_spectrum_deconvoluted_parent,</span>
</span><span id="LCCalculations-682"><a href="#LCCalculations-682"><span class="linenos">682</span></a><span class="sd">        and associated_mass_features_deconvoluted attributes to the mass features in the</span>
</span><span id="LCCalculations-683"><a href="#LCCalculations-683"><span class="linenos">683</span></a><span class="sd">        mass_features attribute of the LCMSBase object.</span>
</span><span id="LCCalculations-684"><a href="#LCCalculations-684"><span class="linenos">684</span></a>
</span><span id="LCCalculations-685"><a href="#LCCalculations-685"><span class="linenos">685</span></a><span class="sd">        Raises</span>
</span><span id="LCCalculations-686"><a href="#LCCalculations-686"><span class="linenos">686</span></a><span class="sd">        ------</span>
</span><span id="LCCalculations-687"><a href="#LCCalculations-687"><span class="linenos">687</span></a><span class="sd">        ValueError</span>
</span><span id="LCCalculations-688"><a href="#LCCalculations-688"><span class="linenos">688</span></a><span class="sd">            If no mass features are found, must run find_mass_features() first.</span>
</span><span id="LCCalculations-689"><a href="#LCCalculations-689"><span class="linenos">689</span></a><span class="sd">            If no EICs are found, did you run integrate_mass_features() first?</span>
</span><span id="LCCalculations-690"><a href="#LCCalculations-690"><span class="linenos">690</span></a>
</span><span id="LCCalculations-691"><a href="#LCCalculations-691"><span class="linenos">691</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations-692"><a href="#LCCalculations-692"><span class="linenos">692</span></a>        <span class="c1"># Checks for set mass_features and eics</span>
</span><span id="LCCalculations-693"><a href="#LCCalculations-693"><span class="linenos">693</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations-694"><a href="#LCCalculations-694"><span class="linenos">694</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LCCalculations-695"><a href="#LCCalculations-695"><span class="linenos">695</span></a>                <span class="s2">&quot;No mass features found, did you run find_mass_features() first?&quot;</span>
</span><span id="LCCalculations-696"><a href="#LCCalculations-696"><span class="linenos">696</span></a>            <span class="p">)</span>
</span><span id="LCCalculations-697"><a href="#LCCalculations-697"><span class="linenos">697</span></a>
</span><span id="LCCalculations-698"><a href="#LCCalculations-698"><span class="linenos">698</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eics</span> <span class="o">==</span> <span class="p">{}:</span>
</span><span id="LCCalculations-699"><a href="#LCCalculations-699"><span class="linenos">699</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LCCalculations-700"><a href="#LCCalculations-700"><span class="linenos">700</span></a>                <span class="s2">&quot;No EICs found, did you run integrate_mass_features() first?&quot;</span>
</span><span id="LCCalculations-701"><a href="#LCCalculations-701"><span class="linenos">701</span></a>            <span class="p">)</span>
</span><span id="LCCalculations-702"><a href="#LCCalculations-702"><span class="linenos">702</span></a>
</span><span id="LCCalculations-703"><a href="#LCCalculations-703"><span class="linenos">703</span></a>        <span class="k">if</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LCCalculations-704"><a href="#LCCalculations-704"><span class="linenos">704</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No unprocessed MS1 spectra found.&quot;</span><span class="p">)</span>
</span><span id="LCCalculations-705"><a href="#LCCalculations-705"><span class="linenos">705</span></a>
</span><span id="LCCalculations-706"><a href="#LCCalculations-706"><span class="linenos">706</span></a>        <span class="c1"># Prep ms1 data</span>
</span><span id="LCCalculations-707"><a href="#LCCalculations-707"><span class="linenos">707</span></a>        <span class="n">ms1_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations-708"><a href="#LCCalculations-708"><span class="linenos">708</span></a>        <span class="n">ms1_data</span> <span class="o">=</span> <span class="n">ms1_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;scan&quot;</span><span class="p">)</span>
</span><span id="LCCalculations-709"><a href="#LCCalculations-709"><span class="linenos">709</span></a>
</span><span id="LCCalculations-710"><a href="#LCCalculations-710"><span class="linenos">710</span></a>        <span class="c1"># Prep mass feature summary</span>
</span><span id="LCCalculations-711"><a href="#LCCalculations-711"><span class="linenos">711</span></a>        <span class="n">mass_feature_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span>
</span><span id="LCCalculations-712"><a href="#LCCalculations-712"><span class="linenos">712</span></a>
</span><span id="LCCalculations-713"><a href="#LCCalculations-713"><span class="linenos">713</span></a>        <span class="c1"># Loop through each mass feature</span>
</span><span id="LCCalculations-714"><a href="#LCCalculations-714"><span class="linenos">714</span></a>        <span class="k">for</span> <span class="n">mf_id</span><span class="p">,</span> <span class="n">mass_feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LCCalculations-715"><a href="#LCCalculations-715"><span class="linenos">715</span></a>            <span class="c1"># Check that the mass_feature.mz attribute == the mz of the mass feature in the mass_feature_df</span>
</span><span id="LCCalculations-716"><a href="#LCCalculations-716"><span class="linenos">716</span></a>            <span class="k">if</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">mz</span> <span class="o">!=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">ms1_peak</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">:</span>
</span><span id="LCCalculations-717"><a href="#LCCalculations-717"><span class="linenos">717</span></a>                <span class="k">continue</span>
</span><span id="LCCalculations-718"><a href="#LCCalculations-718"><span class="linenos">718</span></a>
</span><span id="LCCalculations-719"><a href="#LCCalculations-719"><span class="linenos">719</span></a>            <span class="c1"># Get the left and right limits of the EIC of the mass feature</span>
</span><span id="LCCalculations-720"><a href="#LCCalculations-720"><span class="linenos">720</span></a>            <span class="n">l_scan</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">r_scan</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">_eic_data</span><span class="o">.</span><span class="n">apexes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LCCalculations-721"><a href="#LCCalculations-721"><span class="linenos">721</span></a>
</span><span id="LCCalculations-722"><a href="#LCCalculations-722"><span class="linenos">722</span></a>            <span class="c1"># Pull from the _ms1_unprocessed data the scan range of interest and sort by mz</span>
</span><span id="LCCalculations-723"><a href="#LCCalculations-723"><span class="linenos">723</span></a>            <span class="n">ms1_data_sub</span> <span class="o">=</span> <span class="n">ms1_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l_scan</span><span class="p">:</span><span class="n">r_scan</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations-724"><a href="#LCCalculations-724"><span class="linenos">724</span></a>            <span class="n">ms1_data_sub</span> <span class="o">=</span> <span class="n">ms1_data_sub</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LCCalculations-725"><a href="#LCCalculations-725"><span class="linenos">725</span></a>
</span><span id="LCCalculations-726"><a href="#LCCalculations-726"><span class="linenos">726</span></a>            <span class="c1"># Get the centroided masses of the mass feature</span>
</span><span id="LCCalculations-727"><a href="#LCCalculations-727"><span class="linenos">727</span></a>            <span class="n">mf_mspeak_mzs</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="o">.</span><span class="n">mz_exp</span>
</span><span id="LCCalculations-728"><a href="#LCCalculations-728"><span class="linenos">728</span></a>
</span><span id="LCCalculations-729"><a href="#LCCalculations-729"><span class="linenos">729</span></a>            <span class="c1"># Find the closest mz in the ms1 data to the centroided masses of the mass feature</span>
</span><span id="LCCalculations-730"><a href="#LCCalculations-730"><span class="linenos">730</span></a>            <span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mass_feature_mz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mf_mspeak_mzs</span><span class="p">[</span>
</span><span id="LCCalculations-731"><a href="#LCCalculations-731"><span class="linenos">731</span></a>                <span class="n">find_closest</span><span class="p">(</span><span class="n">mf_mspeak_mzs</span><span class="p">,</span> <span class="n">ms1_data_sub</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="LCCalculations-732"><a href="#LCCalculations-732"><span class="linenos">732</span></a>            <span class="p">]</span>
</span><span id="LCCalculations-733"><a href="#LCCalculations-733"><span class="linenos">733</span></a>
</span><span id="LCCalculations-734"><a href="#LCCalculations-734"><span class="linenos">734</span></a>            <span class="c1"># Drop rows with mz_diff &gt; 0.01 between the mass feature mz and the ms1 data mz</span>
</span><span id="LCCalculations-735"><a href="#LCCalculations-735"><span class="linenos">735</span></a>            <span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mz_diff_rel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LCCalculations-736"><a href="#LCCalculations-736"><span class="linenos">736</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mass_feature_mz&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span>
</span><span id="LCCalculations-737"><a href="#LCCalculations-737"><span class="linenos">737</span></a>                <span class="o">/</span> <span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span>
</span><span id="LCCalculations-738"><a href="#LCCalculations-738"><span class="linenos">738</span></a>            <span class="p">)</span>
</span><span id="LCCalculations-739"><a href="#LCCalculations-739"><span class="linenos">739</span></a>            <span class="n">ms1_data_sub</span> <span class="o">=</span> <span class="n">ms1_data_sub</span><span class="p">[</span>
</span><span id="LCCalculations-740"><a href="#LCCalculations-740"><span class="linenos">740</span></a>                <span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mz_diff_rel&quot;</span><span class="p">]</span>
</span><span id="LCCalculations-741"><a href="#LCCalculations-741"><span class="linenos">741</span></a>                <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_mz_tolerance_rel</span>
</span><span id="LCCalculations-742"><a href="#LCCalculations-742"><span class="linenos">742</span></a>            <span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LCCalculations-743"><a href="#LCCalculations-743"><span class="linenos">743</span></a>
</span><span id="LCCalculations-744"><a href="#LCCalculations-744"><span class="linenos">744</span></a>            <span class="c1"># Group by mass_feature_mz and scan and sum intensity</span>
</span><span id="LCCalculations-745"><a href="#LCCalculations-745"><span class="linenos">745</span></a>            <span class="n">ms1_data_sub_group</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LCCalculations-746"><a href="#LCCalculations-746"><span class="linenos">746</span></a>                <span class="n">ms1_data_sub</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;mass_feature_mz&quot;</span><span class="p">,</span> <span class="s2">&quot;scan&quot;</span><span class="p">])[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span>
</span><span id="LCCalculations-747"><a href="#LCCalculations-747"><span class="linenos">747</span></a>                <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="LCCalculations-748"><a href="#LCCalculations-748"><span class="linenos">748</span></a>                <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="LCCalculations-749"><a href="#LCCalculations-749"><span class="linenos">749</span></a>            <span class="p">)</span>
</span><span id="LCCalculations-750"><a href="#LCCalculations-750"><span class="linenos">750</span></a>
</span><span id="LCCalculations-751"><a href="#LCCalculations-751"><span class="linenos">751</span></a>            <span class="c1"># Calculate the correlation of the intensities of the mass feature and the ms1 data (set to 0 if no intensity)</span>
</span><span id="LCCalculations-752"><a href="#LCCalculations-752"><span class="linenos">752</span></a>            <span class="n">corr</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LCCalculations-753"><a href="#LCCalculations-753"><span class="linenos">753</span></a>                <span class="n">ms1_data_sub_group</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
</span><span id="LCCalculations-754"><a href="#LCCalculations-754"><span class="linenos">754</span></a>                    <span class="n">index</span><span class="o">=</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;mass_feature_mz&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span>
</span><span id="LCCalculations-755"><a href="#LCCalculations-755"><span class="linenos">755</span></a>                <span class="p">)</span>
</span><span id="LCCalculations-756"><a href="#LCCalculations-756"><span class="linenos">756</span></a>                <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="LCCalculations-757"><a href="#LCCalculations-757"><span class="linenos">757</span></a>                <span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</span><span id="LCCalculations-758"><a href="#LCCalculations-758"><span class="linenos">758</span></a>            <span class="p">)</span>
</span><span id="LCCalculations-759"><a href="#LCCalculations-759"><span class="linenos">759</span></a>
</span><span id="LCCalculations-760"><a href="#LCCalculations-760"><span class="linenos">760</span></a>            <span class="c1"># Subset the correlation matrix to only include the masses of the mass feature and those with a correlation &gt; 0.8</span>
</span><span id="LCCalculations-761"><a href="#LCCalculations-761"><span class="linenos">761</span></a>            <span class="n">decon_corr_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ms1_deconvolution_corr_min</span>
</span><span id="LCCalculations-762"><a href="#LCCalculations-762"><span class="linenos">762</span></a>            <span class="n">corr_subset</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mass_feature</span><span class="o">.</span><span class="n">mz</span><span class="p">,]</span>
</span><span id="LCCalculations-763"><a href="#LCCalculations-763"><span class="linenos">763</span></a>            <span class="n">corr_subset</span> <span class="o">=</span> <span class="n">corr_subset</span><span class="p">[</span><span class="n">corr_subset</span> <span class="o">&gt;</span> <span class="n">decon_corr_min</span><span class="p">]</span>
</span><span id="LCCalculations-764"><a href="#LCCalculations-764"><span class="linenos">764</span></a>
</span><span id="LCCalculations-765"><a href="#LCCalculations-765"><span class="linenos">765</span></a>            <span class="c1"># Get the masses from the mass spectrum that are the result of the deconvolution</span>
</span><span id="LCCalculations-766"><a href="#LCCalculations-766"><span class="linenos">766</span></a>            <span class="n">mzs_decon</span> <span class="o">=</span> <span class="n">corr_subset</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="LCCalculations-767"><a href="#LCCalculations-767"><span class="linenos">767</span></a>
</span><span id="LCCalculations-768"><a href="#LCCalculations-768"><span class="linenos">768</span></a>            <span class="c1"># Get the indices of the mzs_decon in mass_feature.mass_spectrum.mz_exp and assign to the mass feature</span>
</span><span id="LCCalculations-769"><a href="#LCCalculations-769"><span class="linenos">769</span></a>            <span class="n">mzs_decon_idx</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LCCalculations-770"><a href="#LCCalculations-770"><span class="linenos">770</span></a>                <span class="nb">id</span>
</span><span id="LCCalculations-771"><a href="#LCCalculations-771"><span class="linenos">771</span></a>                <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">mz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mass_feature</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">)</span>
</span><span id="LCCalculations-772"><a href="#LCCalculations-772"><span class="linenos">772</span></a>                <span class="k">if</span> <span class="n">mz</span> <span class="ow">in</span> <span class="n">mzs_decon</span>
</span><span id="LCCalculations-773"><a href="#LCCalculations-773"><span class="linenos">773</span></a>            <span class="p">]</span>
</span><span id="LCCalculations-774"><a href="#LCCalculations-774"><span class="linenos">774</span></a>            <span class="n">mass_feature</span><span class="o">.</span><span class="n">_ms_deconvoluted_idx</span> <span class="o">=</span> <span class="n">mzs_decon_idx</span>
</span><span id="LCCalculations-775"><a href="#LCCalculations-775"><span class="linenos">775</span></a>
</span><span id="LCCalculations-776"><a href="#LCCalculations-776"><span class="linenos">776</span></a>            <span class="c1"># Check if the mass feature&#39;s ms1 peak is the largest in the deconvoluted mass spectrum</span>
</span><span id="LCCalculations-777"><a href="#LCCalculations-777"><span class="linenos">777</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="LCCalculations-778"><a href="#LCCalculations-778"><span class="linenos">778</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">ms1_peak</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="LCCalculations-779"><a href="#LCCalculations-779"><span class="linenos">779</span></a>                <span class="o">==</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="o">.</span><span class="n">abundance</span><span class="p">[</span><span class="n">mzs_decon_idx</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="LCCalculations-780"><a href="#LCCalculations-780"><span class="linenos">780</span></a>            <span class="p">):</span>
</span><span id="LCCalculations-781"><a href="#LCCalculations-781"><span class="linenos">781</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">mass_spectrum_deconvoluted_parent</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LCCalculations-782"><a href="#LCCalculations-782"><span class="linenos">782</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations-783"><a href="#LCCalculations-783"><span class="linenos">783</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">mass_spectrum_deconvoluted_parent</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LCCalculations-784"><a href="#LCCalculations-784"><span class="linenos">784</span></a>
</span><span id="LCCalculations-785"><a href="#LCCalculations-785"><span class="linenos">785</span></a>            <span class="c1"># Check for other mass features that are in the deconvoluted mass spectrum and add the deconvoluted mass spectrum to the mass feature</span>
</span><span id="LCCalculations-786"><a href="#LCCalculations-786"><span class="linenos">786</span></a>            <span class="c1"># Subset mass_feature_df to only include mass features that are within the clustering tolerance</span>
</span><span id="LCCalculations-787"><a href="#LCCalculations-787"><span class="linenos">787</span></a>            <span class="n">mass_feature_df_sub</span> <span class="o">=</span> <span class="n">mass_feature_df</span><span class="p">[</span>
</span><span id="LCCalculations-788"><a href="#LCCalculations-788"><span class="linenos">788</span></a>                <span class="nb">abs</span><span class="p">(</span><span class="n">mass_feature</span><span class="o">.</span><span class="n">retention_time</span> <span class="o">-</span> <span class="n">mass_feature_df</span><span class="p">[</span><span class="s2">&quot;scan_time&quot;</span><span class="p">])</span>
</span><span id="LCCalculations-789"><a href="#LCCalculations-789"><span class="linenos">789</span></a>                <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_rt_tolerance</span>
</span><span id="LCCalculations-790"><a href="#LCCalculations-790"><span class="linenos">790</span></a>            <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations-791"><a href="#LCCalculations-791"><span class="linenos">791</span></a>            <span class="c1"># Calculate the mz difference in ppm between the mass feature and the peaks in the deconvoluted mass spectrum</span>
</span><span id="LCCalculations-792"><a href="#LCCalculations-792"><span class="linenos">792</span></a>            <span class="n">mass_feature_df_sub</span><span class="p">[</span><span class="s2">&quot;mz_diff_ppm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LCCalculations-793"><a href="#LCCalculations-793"><span class="linenos">793</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mzs_decon</span> <span class="o">-</span> <span class="n">mz</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">/</span> <span class="n">mz</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
</span><span id="LCCalculations-794"><a href="#LCCalculations-794"><span class="linenos">794</span></a>                <span class="k">for</span> <span class="n">mz</span> <span class="ow">in</span> <span class="n">mass_feature_df_sub</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span>
</span><span id="LCCalculations-795"><a href="#LCCalculations-795"><span class="linenos">795</span></a>            <span class="p">]</span>
</span><span id="LCCalculations-796"><a href="#LCCalculations-796"><span class="linenos">796</span></a>            <span class="c1"># Subset mass_feature_df to only include mass features that are within 1 ppm of the deconvoluted masses</span>
</span><span id="LCCalculations-797"><a href="#LCCalculations-797"><span class="linenos">797</span></a>            <span class="n">mfs_associated_decon</span> <span class="o">=</span> <span class="n">mass_feature_df_sub</span><span class="p">[</span>
</span><span id="LCCalculations-798"><a href="#LCCalculations-798"><span class="linenos">798</span></a>                <span class="n">mass_feature_df_sub</span><span class="p">[</span><span class="s2">&quot;mz_diff_ppm&quot;</span><span class="p">]</span>
</span><span id="LCCalculations-799"><a href="#LCCalculations-799"><span class="linenos">799</span></a>                <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_mz_tolerance_rel</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
</span><span id="LCCalculations-800"><a href="#LCCalculations-800"><span class="linenos">800</span></a>            <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="LCCalculations-801"><a href="#LCCalculations-801"><span class="linenos">801</span></a>
</span><span id="LCCalculations-802"><a href="#LCCalculations-802"><span class="linenos">802</span></a>            <span class="n">mass_feature</span><span class="o">.</span><span class="n">associated_mass_features_deconvoluted</span> <span class="o">=</span> <span class="n">mfs_associated_decon</span>
</span></pre></div>


            <div class="docstring"><p>Methods for performing LC calculations on mass spectra data.</p>

<h6 id="notes">Notes</h6>

<p>This class is intended to be used as a mixin for the LCMSBase class.</p>

<h6 id="methods">Methods</h6>

<ul>
<li>get_max_eic(eic_data).
Returns the maximum EIC value from the given EIC data. A static method.</li>
<li>smooth_tic(tic).
Smooths the TIC data using the specified smoothing method and settings.</li>
<li>eic_centroid_detector(rt, eic, max_eic).
Performs EIC centroid detection on the given EIC data.</li>
<li>find_nearest_scan(rt).
Finds the nearest scan to the given retention time.</li>
<li>get_average_mass_spectrum(scan_list, apex_scan, spectrum_mode="profile", ms_level=1, auto_process=True, use_parser=False, perform_checks=True, polarity=None).
Returns an averaged mass spectrum object.</li>
<li>find_mass_features(ms_level=1).
Find regions of interest for a given MS level (default is MS1).</li>
<li>integrate_mass_features(drop_if_fail=False, ms_level=1).
Integrate mass features of interest and extracts EICs.</li>
<li>find_c13_mass_features().
Evaluate mass features and mark likely C13 isotopes.</li>
<li>deconvolute_ms1_mass_features().
Deconvolute mass features' ms1 mass spectra.</li>
</ul>
</div>


                            <div id="LCCalculations.get_max_eic" class="classattr">
                                        <input id="LCCalculations.get_max_eic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">get_max_eic</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">eic_data</span><span class="p">:</span> <span class="nb">dict</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LCCalculations.get_max_eic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LCCalculations.get_max_eic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LCCalculations.get_max_eic-66"><a href="#LCCalculations.get_max_eic-66"><span class="linenos">66</span></a>    <span class="nd">@staticmethod</span>
</span><span id="LCCalculations.get_max_eic-67"><a href="#LCCalculations.get_max_eic-67"><span class="linenos">67</span></a>    <span class="k">def</span> <span class="nf">get_max_eic</span><span class="p">(</span><span class="n">eic_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="LCCalculations.get_max_eic-68"><a href="#LCCalculations.get_max_eic-68"><span class="linenos">68</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the maximum EIC value from the given EIC data.</span>
</span><span id="LCCalculations.get_max_eic-69"><a href="#LCCalculations.get_max_eic-69"><span class="linenos">69</span></a>
</span><span id="LCCalculations.get_max_eic-70"><a href="#LCCalculations.get_max_eic-70"><span class="linenos">70</span></a><span class="sd">        Notes</span>
</span><span id="LCCalculations.get_max_eic-71"><a href="#LCCalculations.get_max_eic-71"><span class="linenos">71</span></a><span class="sd">        -----</span>
</span><span id="LCCalculations.get_max_eic-72"><a href="#LCCalculations.get_max_eic-72"><span class="linenos">72</span></a><span class="sd">        This is a static method.</span>
</span><span id="LCCalculations.get_max_eic-73"><a href="#LCCalculations.get_max_eic-73"><span class="linenos">73</span></a>
</span><span id="LCCalculations.get_max_eic-74"><a href="#LCCalculations.get_max_eic-74"><span class="linenos">74</span></a><span class="sd">        Parameters</span>
</span><span id="LCCalculations.get_max_eic-75"><a href="#LCCalculations.get_max_eic-75"><span class="linenos">75</span></a><span class="sd">        ----------</span>
</span><span id="LCCalculations.get_max_eic-76"><a href="#LCCalculations.get_max_eic-76"><span class="linenos">76</span></a><span class="sd">        eic_data : dict</span>
</span><span id="LCCalculations.get_max_eic-77"><a href="#LCCalculations.get_max_eic-77"><span class="linenos">77</span></a><span class="sd">            A dictionary containing EIC data.</span>
</span><span id="LCCalculations.get_max_eic-78"><a href="#LCCalculations.get_max_eic-78"><span class="linenos">78</span></a>
</span><span id="LCCalculations.get_max_eic-79"><a href="#LCCalculations.get_max_eic-79"><span class="linenos">79</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations.get_max_eic-80"><a href="#LCCalculations.get_max_eic-80"><span class="linenos">80</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations.get_max_eic-81"><a href="#LCCalculations.get_max_eic-81"><span class="linenos">81</span></a><span class="sd">        float</span>
</span><span id="LCCalculations.get_max_eic-82"><a href="#LCCalculations.get_max_eic-82"><span class="linenos">82</span></a><span class="sd">            The maximum EIC value.</span>
</span><span id="LCCalculations.get_max_eic-83"><a href="#LCCalculations.get_max_eic-83"><span class="linenos">83</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations.get_max_eic-84"><a href="#LCCalculations.get_max_eic-84"><span class="linenos">84</span></a>        <span class="n">max_eic</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LCCalculations.get_max_eic-85"><a href="#LCCalculations.get_max_eic-85"><span class="linenos">85</span></a>        <span class="k">for</span> <span class="n">eic_data</span> <span class="ow">in</span> <span class="n">eic_data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="LCCalculations.get_max_eic-86"><a href="#LCCalculations.get_max_eic-86"><span class="linenos">86</span></a>            <span class="n">ind_max_eic</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">eic_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;EIC&quot;</span><span class="p">))</span>
</span><span id="LCCalculations.get_max_eic-87"><a href="#LCCalculations.get_max_eic-87"><span class="linenos">87</span></a>            <span class="n">max_eic</span> <span class="o">=</span> <span class="n">ind_max_eic</span> <span class="k">if</span> <span class="n">ind_max_eic</span> <span class="o">&gt;</span> <span class="n">max_eic</span> <span class="k">else</span> <span class="n">max_eic</span>
</span><span id="LCCalculations.get_max_eic-88"><a href="#LCCalculations.get_max_eic-88"><span class="linenos">88</span></a>
</span><span id="LCCalculations.get_max_eic-89"><a href="#LCCalculations.get_max_eic-89"><span class="linenos">89</span></a>        <span class="k">return</span> <span class="n">max_eic</span>
</span></pre></div>


            <div class="docstring"><p>Returns the maximum EIC value from the given EIC data.</p>

<h6 id="notes">Notes</h6>

<p>This is a static method.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>eic_data</strong> (dict):
A dictionary containing EIC data.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>float</strong>: The maximum EIC value.</li>
</ul>
</div>


                            </div>
                            <div id="LCCalculations.smooth_tic" class="classattr">
                                        <input id="LCCalculations.smooth_tic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">smooth_tic</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">tic</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LCCalculations.smooth_tic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LCCalculations.smooth_tic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LCCalculations.smooth_tic-91"><a href="#LCCalculations.smooth_tic-91"><span class="linenos"> 91</span></a>    <span class="k">def</span> <span class="nf">smooth_tic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tic</span><span class="p">):</span>
</span><span id="LCCalculations.smooth_tic-92"><a href="#LCCalculations.smooth_tic-92"><span class="linenos"> 92</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Smooths the TIC or EIC data using the specified smoothing method and settings.</span>
</span><span id="LCCalculations.smooth_tic-93"><a href="#LCCalculations.smooth_tic-93"><span class="linenos"> 93</span></a>
</span><span id="LCCalculations.smooth_tic-94"><a href="#LCCalculations.smooth_tic-94"><span class="linenos"> 94</span></a><span class="sd">        Parameters</span>
</span><span id="LCCalculations.smooth_tic-95"><a href="#LCCalculations.smooth_tic-95"><span class="linenos"> 95</span></a><span class="sd">        ----------</span>
</span><span id="LCCalculations.smooth_tic-96"><a href="#LCCalculations.smooth_tic-96"><span class="linenos"> 96</span></a><span class="sd">        tic : numpy.ndarray</span>
</span><span id="LCCalculations.smooth_tic-97"><a href="#LCCalculations.smooth_tic-97"><span class="linenos"> 97</span></a><span class="sd">            The TIC (or EIC) data to be smoothed.</span>
</span><span id="LCCalculations.smooth_tic-98"><a href="#LCCalculations.smooth_tic-98"><span class="linenos"> 98</span></a>
</span><span id="LCCalculations.smooth_tic-99"><a href="#LCCalculations.smooth_tic-99"><span class="linenos"> 99</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations.smooth_tic-100"><a href="#LCCalculations.smooth_tic-100"><span class="linenos">100</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations.smooth_tic-101"><a href="#LCCalculations.smooth_tic-101"><span class="linenos">101</span></a><span class="sd">        numpy.ndarray</span>
</span><span id="LCCalculations.smooth_tic-102"><a href="#LCCalculations.smooth_tic-102"><span class="linenos">102</span></a><span class="sd">            The smoothed TIC data.</span>
</span><span id="LCCalculations.smooth_tic-103"><a href="#LCCalculations.smooth_tic-103"><span class="linenos">103</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations.smooth_tic-104"><a href="#LCCalculations.smooth_tic-104"><span class="linenos">104</span></a>        <span class="n">implemented_smooth_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">implemented_smooth_method</span>
</span><span id="LCCalculations.smooth_tic-105"><a href="#LCCalculations.smooth_tic-105"><span class="linenos">105</span></a>
</span><span id="LCCalculations.smooth_tic-106"><a href="#LCCalculations.smooth_tic-106"><span class="linenos">106</span></a>        <span class="n">pol_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">savgol_pol_order</span>
</span><span id="LCCalculations.smooth_tic-107"><a href="#LCCalculations.smooth_tic-107"><span class="linenos">107</span></a>
</span><span id="LCCalculations.smooth_tic-108"><a href="#LCCalculations.smooth_tic-108"><span class="linenos">108</span></a>        <span class="n">window_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">smooth_window</span>
</span><span id="LCCalculations.smooth_tic-109"><a href="#LCCalculations.smooth_tic-109"><span class="linenos">109</span></a>
</span><span id="LCCalculations.smooth_tic-110"><a href="#LCCalculations.smooth_tic-110"><span class="linenos">110</span></a>        <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">smooth_method</span>
</span><span id="LCCalculations.smooth_tic-111"><a href="#LCCalculations.smooth_tic-111"><span class="linenos">111</span></a>
</span><span id="LCCalculations.smooth_tic-112"><a href="#LCCalculations.smooth_tic-112"><span class="linenos">112</span></a>        <span class="k">return</span> <span class="n">sp</span><span class="o">.</span><span class="n">smooth_signal</span><span class="p">(</span>
</span><span id="LCCalculations.smooth_tic-113"><a href="#LCCalculations.smooth_tic-113"><span class="linenos">113</span></a>            <span class="n">tic</span><span class="p">,</span> <span class="n">window_len</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">pol_order</span><span class="p">,</span> <span class="n">implemented_smooth_method</span>
</span><span id="LCCalculations.smooth_tic-114"><a href="#LCCalculations.smooth_tic-114"><span class="linenos">114</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Smooths the TIC or EIC data using the specified smoothing method and settings.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>tic</strong> (numpy.ndarray):
The TIC (or EIC) data to be smoothed.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>numpy.ndarray</strong>: The smoothed TIC data.</li>
</ul>
</div>


                            </div>
                            <div id="LCCalculations.eic_centroid_detector" class="classattr">
                                        <input id="LCCalculations.eic_centroid_detector-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">eic_centroid_detector</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">rt</span>, </span><span class="param"><span class="n">eic</span>, </span><span class="param"><span class="n">max_eic</span>, </span><span class="param"><span class="n">apex_indexes</span><span class="o">=</span><span class="p">[]</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LCCalculations.eic_centroid_detector-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LCCalculations.eic_centroid_detector"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LCCalculations.eic_centroid_detector-116"><a href="#LCCalculations.eic_centroid_detector-116"><span class="linenos">116</span></a>    <span class="k">def</span> <span class="nf">eic_centroid_detector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">eic</span><span class="p">,</span> <span class="n">max_eic</span><span class="p">,</span> <span class="n">apex_indexes</span><span class="o">=</span><span class="p">[]):</span>
</span><span id="LCCalculations.eic_centroid_detector-117"><a href="#LCCalculations.eic_centroid_detector-117"><span class="linenos">117</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs EIC centroid detection on the given EIC data.</span>
</span><span id="LCCalculations.eic_centroid_detector-118"><a href="#LCCalculations.eic_centroid_detector-118"><span class="linenos">118</span></a>
</span><span id="LCCalculations.eic_centroid_detector-119"><a href="#LCCalculations.eic_centroid_detector-119"><span class="linenos">119</span></a><span class="sd">        Parameters</span>
</span><span id="LCCalculations.eic_centroid_detector-120"><a href="#LCCalculations.eic_centroid_detector-120"><span class="linenos">120</span></a><span class="sd">        ----------</span>
</span><span id="LCCalculations.eic_centroid_detector-121"><a href="#LCCalculations.eic_centroid_detector-121"><span class="linenos">121</span></a><span class="sd">        rt : numpy.ndarray</span>
</span><span id="LCCalculations.eic_centroid_detector-122"><a href="#LCCalculations.eic_centroid_detector-122"><span class="linenos">122</span></a><span class="sd">            The retention time data.</span>
</span><span id="LCCalculations.eic_centroid_detector-123"><a href="#LCCalculations.eic_centroid_detector-123"><span class="linenos">123</span></a><span class="sd">        eic : numpy.ndarray</span>
</span><span id="LCCalculations.eic_centroid_detector-124"><a href="#LCCalculations.eic_centroid_detector-124"><span class="linenos">124</span></a><span class="sd">            The EIC data.</span>
</span><span id="LCCalculations.eic_centroid_detector-125"><a href="#LCCalculations.eic_centroid_detector-125"><span class="linenos">125</span></a><span class="sd">        max_eic : float</span>
</span><span id="LCCalculations.eic_centroid_detector-126"><a href="#LCCalculations.eic_centroid_detector-126"><span class="linenos">126</span></a><span class="sd">            The maximum EIC value.</span>
</span><span id="LCCalculations.eic_centroid_detector-127"><a href="#LCCalculations.eic_centroid_detector-127"><span class="linenos">127</span></a><span class="sd">        apex_indexes : list, optional</span>
</span><span id="LCCalculations.eic_centroid_detector-128"><a href="#LCCalculations.eic_centroid_detector-128"><span class="linenos">128</span></a><span class="sd">            The apexes of the EIC peaks. Defaults to [], which means that the apexes will be calculated by the function.</span>
</span><span id="LCCalculations.eic_centroid_detector-129"><a href="#LCCalculations.eic_centroid_detector-129"><span class="linenos">129</span></a>
</span><span id="LCCalculations.eic_centroid_detector-130"><a href="#LCCalculations.eic_centroid_detector-130"><span class="linenos">130</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations.eic_centroid_detector-131"><a href="#LCCalculations.eic_centroid_detector-131"><span class="linenos">131</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations.eic_centroid_detector-132"><a href="#LCCalculations.eic_centroid_detector-132"><span class="linenos">132</span></a><span class="sd">        numpy.ndarray</span>
</span><span id="LCCalculations.eic_centroid_detector-133"><a href="#LCCalculations.eic_centroid_detector-133"><span class="linenos">133</span></a><span class="sd">            The indexes of left, apex, and right limits as a generator.</span>
</span><span id="LCCalculations.eic_centroid_detector-134"><a href="#LCCalculations.eic_centroid_detector-134"><span class="linenos">134</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations.eic_centroid_detector-135"><a href="#LCCalculations.eic_centroid_detector-135"><span class="linenos">135</span></a>
</span><span id="LCCalculations.eic_centroid_detector-136"><a href="#LCCalculations.eic_centroid_detector-136"><span class="linenos">136</span></a>        <span class="n">max_prominence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">peak_max_prominence_percent</span>
</span><span id="LCCalculations.eic_centroid_detector-137"><a href="#LCCalculations.eic_centroid_detector-137"><span class="linenos">137</span></a>
</span><span id="LCCalculations.eic_centroid_detector-138"><a href="#LCCalculations.eic_centroid_detector-138"><span class="linenos">138</span></a>        <span class="n">max_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">peak_height_max_percent</span>
</span><span id="LCCalculations.eic_centroid_detector-139"><a href="#LCCalculations.eic_centroid_detector-139"><span class="linenos">139</span></a>
</span><span id="LCCalculations.eic_centroid_detector-140"><a href="#LCCalculations.eic_centroid_detector-140"><span class="linenos">140</span></a>        <span class="n">signal_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">eic_signal_threshold</span>
</span><span id="LCCalculations.eic_centroid_detector-141"><a href="#LCCalculations.eic_centroid_detector-141"><span class="linenos">141</span></a>
</span><span id="LCCalculations.eic_centroid_detector-142"><a href="#LCCalculations.eic_centroid_detector-142"><span class="linenos">142</span></a>        <span class="n">min_peak_datapoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">min_peak_datapoints</span>
</span><span id="LCCalculations.eic_centroid_detector-143"><a href="#LCCalculations.eic_centroid_detector-143"><span class="linenos">143</span></a>
</span><span id="LCCalculations.eic_centroid_detector-144"><a href="#LCCalculations.eic_centroid_detector-144"><span class="linenos">144</span></a>        <span class="n">peak_derivative_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">peak_derivative_threshold</span>
</span><span id="LCCalculations.eic_centroid_detector-145"><a href="#LCCalculations.eic_centroid_detector-145"><span class="linenos">145</span></a>
</span><span id="LCCalculations.eic_centroid_detector-146"><a href="#LCCalculations.eic_centroid_detector-146"><span class="linenos">146</span></a>        <span class="n">include_indexes</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">peak_picking_first_derivative</span><span class="p">(</span>
</span><span id="LCCalculations.eic_centroid_detector-147"><a href="#LCCalculations.eic_centroid_detector-147"><span class="linenos">147</span></a>            <span class="n">domain</span><span class="o">=</span><span class="n">rt</span><span class="p">,</span>
</span><span id="LCCalculations.eic_centroid_detector-148"><a href="#LCCalculations.eic_centroid_detector-148"><span class="linenos">148</span></a>            <span class="n">signal</span><span class="o">=</span><span class="n">eic</span><span class="p">,</span>
</span><span id="LCCalculations.eic_centroid_detector-149"><a href="#LCCalculations.eic_centroid_detector-149"><span class="linenos">149</span></a>            <span class="n">max_height</span><span class="o">=</span><span class="n">max_height</span><span class="p">,</span>
</span><span id="LCCalculations.eic_centroid_detector-150"><a href="#LCCalculations.eic_centroid_detector-150"><span class="linenos">150</span></a>            <span class="n">max_prominence</span><span class="o">=</span><span class="n">max_prominence</span><span class="p">,</span>
</span><span id="LCCalculations.eic_centroid_detector-151"><a href="#LCCalculations.eic_centroid_detector-151"><span class="linenos">151</span></a>            <span class="n">max_signal</span><span class="o">=</span><span class="n">max_eic</span><span class="p">,</span>
</span><span id="LCCalculations.eic_centroid_detector-152"><a href="#LCCalculations.eic_centroid_detector-152"><span class="linenos">152</span></a>            <span class="n">min_peak_datapoints</span><span class="o">=</span><span class="n">min_peak_datapoints</span><span class="p">,</span>
</span><span id="LCCalculations.eic_centroid_detector-153"><a href="#LCCalculations.eic_centroid_detector-153"><span class="linenos">153</span></a>            <span class="n">peak_derivative_threshold</span><span class="o">=</span><span class="n">peak_derivative_threshold</span><span class="p">,</span>
</span><span id="LCCalculations.eic_centroid_detector-154"><a href="#LCCalculations.eic_centroid_detector-154"><span class="linenos">154</span></a>            <span class="n">signal_threshold</span><span class="o">=</span><span class="n">signal_threshold</span><span class="p">,</span>
</span><span id="LCCalculations.eic_centroid_detector-155"><a href="#LCCalculations.eic_centroid_detector-155"><span class="linenos">155</span></a>            <span class="n">correct_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LCCalculations.eic_centroid_detector-156"><a href="#LCCalculations.eic_centroid_detector-156"><span class="linenos">156</span></a>            <span class="n">plot_res</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LCCalculations.eic_centroid_detector-157"><a href="#LCCalculations.eic_centroid_detector-157"><span class="linenos">157</span></a>            <span class="n">apex_indexes</span><span class="o">=</span><span class="n">apex_indexes</span><span class="p">,</span>
</span><span id="LCCalculations.eic_centroid_detector-158"><a href="#LCCalculations.eic_centroid_detector-158"><span class="linenos">158</span></a>        <span class="p">)</span>
</span><span id="LCCalculations.eic_centroid_detector-159"><a href="#LCCalculations.eic_centroid_detector-159"><span class="linenos">159</span></a>
</span><span id="LCCalculations.eic_centroid_detector-160"><a href="#LCCalculations.eic_centroid_detector-160"><span class="linenos">160</span></a>        <span class="k">return</span> <span class="n">include_indexes</span>
</span></pre></div>


            <div class="docstring"><p>Performs EIC centroid detection on the given EIC data.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>rt</strong> (numpy.ndarray):
The retention time data.</li>
<li><strong>eic</strong> (numpy.ndarray):
The EIC data.</li>
<li><strong>max_eic</strong> (float):
The maximum EIC value.</li>
<li><strong>apex_indexes</strong> (list, optional):
The apexes of the EIC peaks. Defaults to [], which means that the apexes will be calculated by the function.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>numpy.ndarray</strong>: The indexes of left, apex, and right limits as a generator.</li>
</ul>
</div>


                            </div>
                            <div id="LCCalculations.find_nearest_scan" class="classattr">
                                        <input id="LCCalculations.find_nearest_scan-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">find_nearest_scan</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">rt</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LCCalculations.find_nearest_scan-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LCCalculations.find_nearest_scan"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LCCalculations.find_nearest_scan-162"><a href="#LCCalculations.find_nearest_scan-162"><span class="linenos">162</span></a>    <span class="k">def</span> <span class="nf">find_nearest_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rt</span><span class="p">):</span>
</span><span id="LCCalculations.find_nearest_scan-163"><a href="#LCCalculations.find_nearest_scan-163"><span class="linenos">163</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Finds the nearest scan to the given retention time.</span>
</span><span id="LCCalculations.find_nearest_scan-164"><a href="#LCCalculations.find_nearest_scan-164"><span class="linenos">164</span></a>
</span><span id="LCCalculations.find_nearest_scan-165"><a href="#LCCalculations.find_nearest_scan-165"><span class="linenos">165</span></a><span class="sd">        Parameters</span>
</span><span id="LCCalculations.find_nearest_scan-166"><a href="#LCCalculations.find_nearest_scan-166"><span class="linenos">166</span></a><span class="sd">        ----------</span>
</span><span id="LCCalculations.find_nearest_scan-167"><a href="#LCCalculations.find_nearest_scan-167"><span class="linenos">167</span></a><span class="sd">        rt : float</span>
</span><span id="LCCalculations.find_nearest_scan-168"><a href="#LCCalculations.find_nearest_scan-168"><span class="linenos">168</span></a><span class="sd">            The retention time (in minutes) to find the nearest scan for.</span>
</span><span id="LCCalculations.find_nearest_scan-169"><a href="#LCCalculations.find_nearest_scan-169"><span class="linenos">169</span></a>
</span><span id="LCCalculations.find_nearest_scan-170"><a href="#LCCalculations.find_nearest_scan-170"><span class="linenos">170</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations.find_nearest_scan-171"><a href="#LCCalculations.find_nearest_scan-171"><span class="linenos">171</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations.find_nearest_scan-172"><a href="#LCCalculations.find_nearest_scan-172"><span class="linenos">172</span></a><span class="sd">        int</span>
</span><span id="LCCalculations.find_nearest_scan-173"><a href="#LCCalculations.find_nearest_scan-173"><span class="linenos">173</span></a><span class="sd">            The scan number of the nearest scan.</span>
</span><span id="LCCalculations.find_nearest_scan-174"><a href="#LCCalculations.find_nearest_scan-174"><span class="linenos">174</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations.find_nearest_scan-175"><a href="#LCCalculations.find_nearest_scan-175"><span class="linenos">175</span></a>        <span class="n">array_rt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retention_time</span><span class="p">)</span>
</span><span id="LCCalculations.find_nearest_scan-176"><a href="#LCCalculations.find_nearest_scan-176"><span class="linenos">176</span></a>
</span><span id="LCCalculations.find_nearest_scan-177"><a href="#LCCalculations.find_nearest_scan-177"><span class="linenos">177</span></a>        <span class="n">scan_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">array_rt</span> <span class="o">-</span> <span class="n">rt</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
</span><span id="LCCalculations.find_nearest_scan-178"><a href="#LCCalculations.find_nearest_scan-178"><span class="linenos">178</span></a>
</span><span id="LCCalculations.find_nearest_scan-179"><a href="#LCCalculations.find_nearest_scan-179"><span class="linenos">179</span></a>        <span class="n">real_scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans_number</span><span class="p">[</span><span class="n">scan_index</span><span class="p">]</span>
</span><span id="LCCalculations.find_nearest_scan-180"><a href="#LCCalculations.find_nearest_scan-180"><span class="linenos">180</span></a>
</span><span id="LCCalculations.find_nearest_scan-181"><a href="#LCCalculations.find_nearest_scan-181"><span class="linenos">181</span></a>        <span class="k">return</span> <span class="n">real_scan</span>
</span></pre></div>


            <div class="docstring"><p>Finds the nearest scan to the given retention time.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>rt</strong> (float):
The retention time (in minutes) to find the nearest scan for.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>int</strong>: The scan number of the nearest scan.</li>
</ul>
</div>


                            </div>
                            <div id="LCCalculations.add_peak_metrics" class="classattr">
                                        <input id="LCCalculations.add_peak_metrics-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_peak_metrics</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LCCalculations.add_peak_metrics-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LCCalculations.add_peak_metrics"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LCCalculations.add_peak_metrics-183"><a href="#LCCalculations.add_peak_metrics-183"><span class="linenos">183</span></a>    <span class="k">def</span> <span class="nf">add_peak_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LCCalculations.add_peak_metrics-184"><a href="#LCCalculations.add_peak_metrics-184"><span class="linenos">184</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add peak metrics to the mass features.</span>
</span><span id="LCCalculations.add_peak_metrics-185"><a href="#LCCalculations.add_peak_metrics-185"><span class="linenos">185</span></a>
</span><span id="LCCalculations.add_peak_metrics-186"><a href="#LCCalculations.add_peak_metrics-186"><span class="linenos">186</span></a><span class="sd">        This function calculates the peak metrics for each mass feature and adds them to the mass feature objects.</span>
</span><span id="LCCalculations.add_peak_metrics-187"><a href="#LCCalculations.add_peak_metrics-187"><span class="linenos">187</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations.add_peak_metrics-188"><a href="#LCCalculations.add_peak_metrics-188"><span class="linenos">188</span></a>        <span class="c1"># Check that at least some mass features have eic data</span>
</span><span id="LCCalculations.add_peak_metrics-189"><a href="#LCCalculations.add_peak_metrics-189"><span class="linenos">189</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">mf</span><span class="o">.</span><span class="n">_eic_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">values</span><span class="p">()]):</span>
</span><span id="LCCalculations.add_peak_metrics-190"><a href="#LCCalculations.add_peak_metrics-190"><span class="linenos">190</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LCCalculations.add_peak_metrics-191"><a href="#LCCalculations.add_peak_metrics-191"><span class="linenos">191</span></a>                <span class="s2">&quot;No mass features have EIC data. Run integrate_mass_features first.&quot;</span>
</span><span id="LCCalculations.add_peak_metrics-192"><a href="#LCCalculations.add_peak_metrics-192"><span class="linenos">192</span></a>            <span class="p">)</span>
</span><span id="LCCalculations.add_peak_metrics-193"><a href="#LCCalculations.add_peak_metrics-193"><span class="linenos">193</span></a>
</span><span id="LCCalculations.add_peak_metrics-194"><a href="#LCCalculations.add_peak_metrics-194"><span class="linenos">194</span></a>        <span class="k">for</span> <span class="n">mass_feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span><span id="LCCalculations.add_peak_metrics-195"><a href="#LCCalculations.add_peak_metrics-195"><span class="linenos">195</span></a>            <span class="c1"># Check if the mass feature has been integrated</span>
</span><span id="LCCalculations.add_peak_metrics-196"><a href="#LCCalculations.add_peak_metrics-196"><span class="linenos">196</span></a>            <span class="k">if</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">_eic_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations.add_peak_metrics-197"><a href="#LCCalculations.add_peak_metrics-197"><span class="linenos">197</span></a>                <span class="c1"># Calculate peak metrics</span>
</span><span id="LCCalculations.add_peak_metrics-198"><a href="#LCCalculations.add_peak_metrics-198"><span class="linenos">198</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">calc_half_height_width</span><span class="p">()</span>
</span><span id="LCCalculations.add_peak_metrics-199"><a href="#LCCalculations.add_peak_metrics-199"><span class="linenos">199</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">calc_tailing_factor</span><span class="p">()</span>
</span><span id="LCCalculations.add_peak_metrics-200"><a href="#LCCalculations.add_peak_metrics-200"><span class="linenos">200</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">calc_dispersity_index</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Add peak metrics to the mass features.</p>

<p>This function calculates the peak metrics for each mass feature and adds them to the mass feature objects.</p>
</div>


                            </div>
                            <div id="LCCalculations.get_average_mass_spectrum" class="classattr">
                                        <input id="LCCalculations.get_average_mass_spectrum-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_average_mass_spectrum</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">scan_list</span>,</span><span class="param">	<span class="n">apex_scan</span>,</span><span class="param">	<span class="n">spectrum_mode</span><span class="o">=</span><span class="s1">&#39;profile&#39;</span>,</span><span class="param">	<span class="n">ms_level</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">auto_process</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">use_parser</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">perform_checks</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">polarity</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">ms_params</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LCCalculations.get_average_mass_spectrum-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LCCalculations.get_average_mass_spectrum"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LCCalculations.get_average_mass_spectrum-202"><a href="#LCCalculations.get_average_mass_spectrum-202"><span class="linenos">202</span></a>    <span class="k">def</span> <span class="nf">get_average_mass_spectrum</span><span class="p">(</span>
</span><span id="LCCalculations.get_average_mass_spectrum-203"><a href="#LCCalculations.get_average_mass_spectrum-203"><span class="linenos">203</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LCCalculations.get_average_mass_spectrum-204"><a href="#LCCalculations.get_average_mass_spectrum-204"><span class="linenos">204</span></a>        <span class="n">scan_list</span><span class="p">,</span>
</span><span id="LCCalculations.get_average_mass_spectrum-205"><a href="#LCCalculations.get_average_mass_spectrum-205"><span class="linenos">205</span></a>        <span class="n">apex_scan</span><span class="p">,</span>
</span><span id="LCCalculations.get_average_mass_spectrum-206"><a href="#LCCalculations.get_average_mass_spectrum-206"><span class="linenos">206</span></a>        <span class="n">spectrum_mode</span><span class="o">=</span><span class="s2">&quot;profile&quot;</span><span class="p">,</span>
</span><span id="LCCalculations.get_average_mass_spectrum-207"><a href="#LCCalculations.get_average_mass_spectrum-207"><span class="linenos">207</span></a>        <span class="n">ms_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="LCCalculations.get_average_mass_spectrum-208"><a href="#LCCalculations.get_average_mass_spectrum-208"><span class="linenos">208</span></a>        <span class="n">auto_process</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LCCalculations.get_average_mass_spectrum-209"><a href="#LCCalculations.get_average_mass_spectrum-209"><span class="linenos">209</span></a>        <span class="n">use_parser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LCCalculations.get_average_mass_spectrum-210"><a href="#LCCalculations.get_average_mass_spectrum-210"><span class="linenos">210</span></a>        <span class="n">perform_checks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LCCalculations.get_average_mass_spectrum-211"><a href="#LCCalculations.get_average_mass_spectrum-211"><span class="linenos">211</span></a>        <span class="n">polarity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LCCalculations.get_average_mass_spectrum-212"><a href="#LCCalculations.get_average_mass_spectrum-212"><span class="linenos">212</span></a>        <span class="n">ms_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="LCCalculations.get_average_mass_spectrum-213"><a href="#LCCalculations.get_average_mass_spectrum-213"><span class="linenos">213</span></a>    <span class="p">):</span>
</span><span id="LCCalculations.get_average_mass_spectrum-214"><a href="#LCCalculations.get_average_mass_spectrum-214"><span class="linenos">214</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns an averaged mass spectrum object</span>
</span><span id="LCCalculations.get_average_mass_spectrum-215"><a href="#LCCalculations.get_average_mass_spectrum-215"><span class="linenos">215</span></a>
</span><span id="LCCalculations.get_average_mass_spectrum-216"><a href="#LCCalculations.get_average_mass_spectrum-216"><span class="linenos">216</span></a><span class="sd">        Parameters</span>
</span><span id="LCCalculations.get_average_mass_spectrum-217"><a href="#LCCalculations.get_average_mass_spectrum-217"><span class="linenos">217</span></a><span class="sd">        ----------</span>
</span><span id="LCCalculations.get_average_mass_spectrum-218"><a href="#LCCalculations.get_average_mass_spectrum-218"><span class="linenos">218</span></a><span class="sd">        scan_list : list</span>
</span><span id="LCCalculations.get_average_mass_spectrum-219"><a href="#LCCalculations.get_average_mass_spectrum-219"><span class="linenos">219</span></a><span class="sd">            List of scan numbers to average.</span>
</span><span id="LCCalculations.get_average_mass_spectrum-220"><a href="#LCCalculations.get_average_mass_spectrum-220"><span class="linenos">220</span></a><span class="sd">        apex_scan : int</span>
</span><span id="LCCalculations.get_average_mass_spectrum-221"><a href="#LCCalculations.get_average_mass_spectrum-221"><span class="linenos">221</span></a><span class="sd">            Number of the apex scan</span>
</span><span id="LCCalculations.get_average_mass_spectrum-222"><a href="#LCCalculations.get_average_mass_spectrum-222"><span class="linenos">222</span></a><span class="sd">        spectrum_mode : str, optional</span>
</span><span id="LCCalculations.get_average_mass_spectrum-223"><a href="#LCCalculations.get_average_mass_spectrum-223"><span class="linenos">223</span></a><span class="sd">            The spectrum mode to use. Defaults to &quot;profile&quot;. Not that only &quot;profile&quot; mode is supported for averaging.</span>
</span><span id="LCCalculations.get_average_mass_spectrum-224"><a href="#LCCalculations.get_average_mass_spectrum-224"><span class="linenos">224</span></a><span class="sd">        ms_level : int, optional</span>
</span><span id="LCCalculations.get_average_mass_spectrum-225"><a href="#LCCalculations.get_average_mass_spectrum-225"><span class="linenos">225</span></a><span class="sd">            The MS level to use. Defaults to 1.</span>
</span><span id="LCCalculations.get_average_mass_spectrum-226"><a href="#LCCalculations.get_average_mass_spectrum-226"><span class="linenos">226</span></a><span class="sd">        auto_process : bool, optional</span>
</span><span id="LCCalculations.get_average_mass_spectrum-227"><a href="#LCCalculations.get_average_mass_spectrum-227"><span class="linenos">227</span></a><span class="sd">            If True, the averaged mass spectrum will be auto-processed. Defaults to True.</span>
</span><span id="LCCalculations.get_average_mass_spectrum-228"><a href="#LCCalculations.get_average_mass_spectrum-228"><span class="linenos">228</span></a><span class="sd">        use_parser : bool, optional</span>
</span><span id="LCCalculations.get_average_mass_spectrum-229"><a href="#LCCalculations.get_average_mass_spectrum-229"><span class="linenos">229</span></a><span class="sd">            If True, the mass spectra will be obtained from the parser. Defaults to False.</span>
</span><span id="LCCalculations.get_average_mass_spectrum-230"><a href="#LCCalculations.get_average_mass_spectrum-230"><span class="linenos">230</span></a><span class="sd">        perform_checks : bool, optional</span>
</span><span id="LCCalculations.get_average_mass_spectrum-231"><a href="#LCCalculations.get_average_mass_spectrum-231"><span class="linenos">231</span></a><span class="sd">            If True, the function will check if the data are within the ms_unprocessed dictionary and are the correct mode. Defaults to True. Only set to False if you are sure the data are profile, and (if not using the parser) are in the ms_unprocessed dictionary!  ms_unprocessed dictionary also must be indexed on scan</span>
</span><span id="LCCalculations.get_average_mass_spectrum-232"><a href="#LCCalculations.get_average_mass_spectrum-232"><span class="linenos">232</span></a><span class="sd">        polarity : int, optional</span>
</span><span id="LCCalculations.get_average_mass_spectrum-233"><a href="#LCCalculations.get_average_mass_spectrum-233"><span class="linenos">233</span></a><span class="sd">            The polarity of the mass spectra (1 or -1). If not set, the polarity will be determined from the dataset. Defaults to None. (fastest if set to -1 or 1)</span>
</span><span id="LCCalculations.get_average_mass_spectrum-234"><a href="#LCCalculations.get_average_mass_spectrum-234"><span class="linenos">234</span></a><span class="sd">        ms_params : MSParameters, optional</span>
</span><span id="LCCalculations.get_average_mass_spectrum-235"><a href="#LCCalculations.get_average_mass_spectrum-235"><span class="linenos">235</span></a><span class="sd">            The mass spectrum parameters to use. If not set (None), the globally set parameters will be used. Defaults to None.</span>
</span><span id="LCCalculations.get_average_mass_spectrum-236"><a href="#LCCalculations.get_average_mass_spectrum-236"><span class="linenos">236</span></a>
</span><span id="LCCalculations.get_average_mass_spectrum-237"><a href="#LCCalculations.get_average_mass_spectrum-237"><span class="linenos">237</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations.get_average_mass_spectrum-238"><a href="#LCCalculations.get_average_mass_spectrum-238"><span class="linenos">238</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations.get_average_mass_spectrum-239"><a href="#LCCalculations.get_average_mass_spectrum-239"><span class="linenos">239</span></a><span class="sd">        MassSpectrumProfile</span>
</span><span id="LCCalculations.get_average_mass_spectrum-240"><a href="#LCCalculations.get_average_mass_spectrum-240"><span class="linenos">240</span></a><span class="sd">            The averaged mass spectrum object.</span>
</span><span id="LCCalculations.get_average_mass_spectrum-241"><a href="#LCCalculations.get_average_mass_spectrum-241"><span class="linenos">241</span></a>
</span><span id="LCCalculations.get_average_mass_spectrum-242"><a href="#LCCalculations.get_average_mass_spectrum-242"><span class="linenos">242</span></a><span class="sd">        Raises</span>
</span><span id="LCCalculations.get_average_mass_spectrum-243"><a href="#LCCalculations.get_average_mass_spectrum-243"><span class="linenos">243</span></a><span class="sd">        ------</span>
</span><span id="LCCalculations.get_average_mass_spectrum-244"><a href="#LCCalculations.get_average_mass_spectrum-244"><span class="linenos">244</span></a><span class="sd">        ValueError</span>
</span><span id="LCCalculations.get_average_mass_spectrum-245"><a href="#LCCalculations.get_average_mass_spectrum-245"><span class="linenos">245</span></a><span class="sd">            If the spectrum mode is not &quot;profile&quot;.</span>
</span><span id="LCCalculations.get_average_mass_spectrum-246"><a href="#LCCalculations.get_average_mass_spectrum-246"><span class="linenos">246</span></a><span class="sd">            If the MS level is not found in the unprocessed mass spectra dictionary.</span>
</span><span id="LCCalculations.get_average_mass_spectrum-247"><a href="#LCCalculations.get_average_mass_spectrum-247"><span class="linenos">247</span></a><span class="sd">            If not all scan numbers are found in the unprocessed mass spectra dictionary.</span>
</span><span id="LCCalculations.get_average_mass_spectrum-248"><a href="#LCCalculations.get_average_mass_spectrum-248"><span class="linenos">248</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations.get_average_mass_spectrum-249"><a href="#LCCalculations.get_average_mass_spectrum-249"><span class="linenos">249</span></a>        <span class="k">if</span> <span class="n">perform_checks</span><span class="p">:</span>
</span><span id="LCCalculations.get_average_mass_spectrum-250"><a href="#LCCalculations.get_average_mass_spectrum-250"><span class="linenos">250</span></a>            <span class="k">if</span> <span class="n">spectrum_mode</span> <span class="o">!=</span> <span class="s2">&quot;profile&quot;</span><span class="p">:</span>
</span><span id="LCCalculations.get_average_mass_spectrum-251"><a href="#LCCalculations.get_average_mass_spectrum-251"><span class="linenos">251</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Averaging only supported for profile mode&quot;</span><span class="p">)</span>
</span><span id="LCCalculations.get_average_mass_spectrum-252"><a href="#LCCalculations.get_average_mass_spectrum-252"><span class="linenos">252</span></a>
</span><span id="LCCalculations.get_average_mass_spectrum-253"><a href="#LCCalculations.get_average_mass_spectrum-253"><span class="linenos">253</span></a>        <span class="k">if</span> <span class="n">polarity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations.get_average_mass_spectrum-254"><a href="#LCCalculations.get_average_mass_spectrum-254"><span class="linenos">254</span></a>            <span class="c1"># set polarity to -1 if negative mode, 1 if positive mode (for mass spectrum creation)</span>
</span><span id="LCCalculations.get_average_mass_spectrum-255"><a href="#LCCalculations.get_average_mass_spectrum-255"><span class="linenos">255</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity</span> <span class="o">==</span> <span class="s2">&quot;negative&quot;</span><span class="p">:</span>
</span><span id="LCCalculations.get_average_mass_spectrum-256"><a href="#LCCalculations.get_average_mass_spectrum-256"><span class="linenos">256</span></a>                <span class="n">polarity</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="LCCalculations.get_average_mass_spectrum-257"><a href="#LCCalculations.get_average_mass_spectrum-257"><span class="linenos">257</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity</span> <span class="o">==</span> <span class="s2">&quot;positive&quot;</span><span class="p">:</span>
</span><span id="LCCalculations.get_average_mass_spectrum-258"><a href="#LCCalculations.get_average_mass_spectrum-258"><span class="linenos">258</span></a>                <span class="n">polarity</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="LCCalculations.get_average_mass_spectrum-259"><a href="#LCCalculations.get_average_mass_spectrum-259"><span class="linenos">259</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations.get_average_mass_spectrum-260"><a href="#LCCalculations.get_average_mass_spectrum-260"><span class="linenos">260</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LCCalculations.get_average_mass_spectrum-261"><a href="#LCCalculations.get_average_mass_spectrum-261"><span class="linenos">261</span></a>                    <span class="s2">&quot;Polarity not set for dataset, must be a set containing either &#39;positive&#39; or &#39;negative&#39;&quot;</span>
</span><span id="LCCalculations.get_average_mass_spectrum-262"><a href="#LCCalculations.get_average_mass_spectrum-262"><span class="linenos">262</span></a>                <span class="p">)</span>
</span><span id="LCCalculations.get_average_mass_spectrum-263"><a href="#LCCalculations.get_average_mass_spectrum-263"><span class="linenos">263</span></a>
</span><span id="LCCalculations.get_average_mass_spectrum-264"><a href="#LCCalculations.get_average_mass_spectrum-264"><span class="linenos">264</span></a>        <span class="c1"># if not using_parser, check that scan numbers are in _ms_unprocessed</span>
</span><span id="LCCalculations.get_average_mass_spectrum-265"><a href="#LCCalculations.get_average_mass_spectrum-265"><span class="linenos">265</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">use_parser</span><span class="p">:</span>
</span><span id="LCCalculations.get_average_mass_spectrum-266"><a href="#LCCalculations.get_average_mass_spectrum-266"><span class="linenos">266</span></a>            <span class="k">if</span> <span class="n">perform_checks</span><span class="p">:</span>
</span><span id="LCCalculations.get_average_mass_spectrum-267"><a href="#LCCalculations.get_average_mass_spectrum-267"><span class="linenos">267</span></a>                <span class="c1"># Set index to scan for faster lookup</span>
</span><span id="LCCalculations.get_average_mass_spectrum-268"><a href="#LCCalculations.get_average_mass_spectrum-268"><span class="linenos">268</span></a>                <span class="n">ms_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LCCalculations.get_average_mass_spectrum-269"><a href="#LCCalculations.get_average_mass_spectrum-269"><span class="linenos">269</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="p">[</span><span class="n">ms_level</span><span class="p">]</span>
</span><span id="LCCalculations.get_average_mass_spectrum-270"><a href="#LCCalculations.get_average_mass_spectrum-270"><span class="linenos">270</span></a>                    <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations.get_average_mass_spectrum-271"><a href="#LCCalculations.get_average_mass_spectrum-271"><span class="linenos">271</span></a>                    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LCCalculations.get_average_mass_spectrum-272"><a href="#LCCalculations.get_average_mass_spectrum-272"><span class="linenos">272</span></a>                    <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
</span><span id="LCCalculations.get_average_mass_spectrum-273"><a href="#LCCalculations.get_average_mass_spectrum-273"><span class="linenos">273</span></a>                <span class="p">)</span>
</span><span id="LCCalculations.get_average_mass_spectrum-274"><a href="#LCCalculations.get_average_mass_spectrum-274"><span class="linenos">274</span></a>                <span class="n">my_ms_df</span> <span class="o">=</span> <span class="n">ms_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">scan_list</span><span class="p">]</span>
</span><span id="LCCalculations.get_average_mass_spectrum-275"><a href="#LCCalculations.get_average_mass_spectrum-275"><span class="linenos">275</span></a>                <span class="c1"># Check that all scan numbers are in the ms_df</span>
</span><span id="LCCalculations.get_average_mass_spectrum-276"><a href="#LCCalculations.get_average_mass_spectrum-276"><span class="linenos">276</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">scan_list</span><span class="p">,</span> <span class="n">ms_df</span><span class="o">.</span><span class="n">index</span><span class="p">)):</span>
</span><span id="LCCalculations.get_average_mass_spectrum-277"><a href="#LCCalculations.get_average_mass_spectrum-277"><span class="linenos">277</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LCCalculations.get_average_mass_spectrum-278"><a href="#LCCalculations.get_average_mass_spectrum-278"><span class="linenos">278</span></a>                        <span class="s2">&quot;Not all scan numbers found in the unprocessed mass spectra dictionary&quot;</span>
</span><span id="LCCalculations.get_average_mass_spectrum-279"><a href="#LCCalculations.get_average_mass_spectrum-279"><span class="linenos">279</span></a>                    <span class="p">)</span>
</span><span id="LCCalculations.get_average_mass_spectrum-280"><a href="#LCCalculations.get_average_mass_spectrum-280"><span class="linenos">280</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations.get_average_mass_spectrum-281"><a href="#LCCalculations.get_average_mass_spectrum-281"><span class="linenos">281</span></a>                <span class="n">my_ms_df</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LCCalculations.get_average_mass_spectrum-282"><a href="#LCCalculations.get_average_mass_spectrum-282"><span class="linenos">282</span></a>                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;scan&quot;</span><span class="p">:</span> <span class="n">scan_list</span><span class="p">})</span>
</span><span id="LCCalculations.get_average_mass_spectrum-283"><a href="#LCCalculations.get_average_mass_spectrum-283"><span class="linenos">283</span></a>                    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;scan&quot;</span><span class="p">)</span>
</span><span id="LCCalculations.get_average_mass_spectrum-284"><a href="#LCCalculations.get_average_mass_spectrum-284"><span class="linenos">284</span></a>                    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="p">[</span><span class="n">ms_level</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</span><span id="LCCalculations.get_average_mass_spectrum-285"><a href="#LCCalculations.get_average_mass_spectrum-285"><span class="linenos">285</span></a>                <span class="p">)</span>
</span><span id="LCCalculations.get_average_mass_spectrum-286"><a href="#LCCalculations.get_average_mass_spectrum-286"><span class="linenos">286</span></a>
</span><span id="LCCalculations.get_average_mass_spectrum-287"><a href="#LCCalculations.get_average_mass_spectrum-287"><span class="linenos">287</span></a>        <span class="k">if</span> <span class="n">use_parser</span><span class="p">:</span>
</span><span id="LCCalculations.get_average_mass_spectrum-288"><a href="#LCCalculations.get_average_mass_spectrum-288"><span class="linenos">288</span></a>            <span class="n">ms_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LCCalculations.get_average_mass_spectrum-289"><a href="#LCCalculations.get_average_mass_spectrum-289"><span class="linenos">289</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">spectra_parser</span><span class="o">.</span><span class="n">get_mass_spectrum_from_scan</span><span class="p">(</span>
</span><span id="LCCalculations.get_average_mass_spectrum-290"><a href="#LCCalculations.get_average_mass_spectrum-290"><span class="linenos">290</span></a>                    <span class="n">x</span><span class="p">,</span> <span class="n">spectrum_mode</span><span class="o">=</span><span class="n">spectrum_mode</span><span class="p">,</span> <span class="n">auto_process</span><span class="o">=</span><span class="kc">False</span>
</span><span id="LCCalculations.get_average_mass_spectrum-291"><a href="#LCCalculations.get_average_mass_spectrum-291"><span class="linenos">291</span></a>                <span class="p">)</span>
</span><span id="LCCalculations.get_average_mass_spectrum-292"><a href="#LCCalculations.get_average_mass_spectrum-292"><span class="linenos">292</span></a>                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scan_list</span>
</span><span id="LCCalculations.get_average_mass_spectrum-293"><a href="#LCCalculations.get_average_mass_spectrum-293"><span class="linenos">293</span></a>            <span class="p">]</span>
</span><span id="LCCalculations.get_average_mass_spectrum-294"><a href="#LCCalculations.get_average_mass_spectrum-294"><span class="linenos">294</span></a>            <span class="n">ms_mz</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">_mz_exp</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ms_list</span><span class="p">]</span>
</span><span id="LCCalculations.get_average_mass_spectrum-295"><a href="#LCCalculations.get_average_mass_spectrum-295"><span class="linenos">295</span></a>            <span class="n">ms_int</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">_abundance</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ms_list</span><span class="p">]</span>
</span><span id="LCCalculations.get_average_mass_spectrum-296"><a href="#LCCalculations.get_average_mass_spectrum-296"><span class="linenos">296</span></a>            <span class="n">my_ms_df</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LCCalculations.get_average_mass_spectrum-297"><a href="#LCCalculations.get_average_mass_spectrum-297"><span class="linenos">297</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ms_mz</span><span class="p">)):</span>
</span><span id="LCCalculations.get_average_mass_spectrum-298"><a href="#LCCalculations.get_average_mass_spectrum-298"><span class="linenos">298</span></a>                <span class="n">my_ms_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="LCCalculations.get_average_mass_spectrum-299"><a href="#LCCalculations.get_average_mass_spectrum-299"><span class="linenos">299</span></a>                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
</span><span id="LCCalculations.get_average_mass_spectrum-300"><a href="#LCCalculations.get_average_mass_spectrum-300"><span class="linenos">300</span></a>                        <span class="p">{</span><span class="s2">&quot;mz&quot;</span><span class="p">:</span> <span class="n">ms_mz</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;intensity&quot;</span><span class="p">:</span> <span class="n">ms_int</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;scan&quot;</span><span class="p">:</span> <span class="n">scan_list</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span>
</span><span id="LCCalculations.get_average_mass_spectrum-301"><a href="#LCCalculations.get_average_mass_spectrum-301"><span class="linenos">301</span></a>                    <span class="p">)</span>
</span><span id="LCCalculations.get_average_mass_spectrum-302"><a href="#LCCalculations.get_average_mass_spectrum-302"><span class="linenos">302</span></a>                <span class="p">)</span>
</span><span id="LCCalculations.get_average_mass_spectrum-303"><a href="#LCCalculations.get_average_mass_spectrum-303"><span class="linenos">303</span></a>            <span class="n">my_ms_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">my_ms_df</span><span class="p">)</span>
</span><span id="LCCalculations.get_average_mass_spectrum-304"><a href="#LCCalculations.get_average_mass_spectrum-304"><span class="linenos">304</span></a>
</span><span id="LCCalculations.get_average_mass_spectrum-305"><a href="#LCCalculations.get_average_mass_spectrum-305"><span class="linenos">305</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_grid</span><span class="p">(</span><span class="n">my_ms_df</span><span class="p">):</span>
</span><span id="LCCalculations.get_average_mass_spectrum-306"><a href="#LCCalculations.get_average_mass_spectrum-306"><span class="linenos">306</span></a>            <span class="n">my_ms_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span><span class="p">(</span><span class="n">my_ms_df</span><span class="p">)</span>
</span><span id="LCCalculations.get_average_mass_spectrum-307"><a href="#LCCalculations.get_average_mass_spectrum-307"><span class="linenos">307</span></a>
</span><span id="LCCalculations.get_average_mass_spectrum-308"><a href="#LCCalculations.get_average_mass_spectrum-308"><span class="linenos">308</span></a>        <span class="n">my_ms_ave</span> <span class="o">=</span> <span class="n">my_ms_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;mz&quot;</span><span class="p">)[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="LCCalculations.get_average_mass_spectrum-309"><a href="#LCCalculations.get_average_mass_spectrum-309"><span class="linenos">309</span></a>
</span><span id="LCCalculations.get_average_mass_spectrum-310"><a href="#LCCalculations.get_average_mass_spectrum-310"><span class="linenos">310</span></a>        <span class="n">ms</span> <span class="o">=</span> <span class="n">ms_from_array_profile</span><span class="p">(</span>
</span><span id="LCCalculations.get_average_mass_spectrum-311"><a href="#LCCalculations.get_average_mass_spectrum-311"><span class="linenos">311</span></a>            <span class="n">my_ms_ave</span><span class="o">.</span><span class="n">mz</span><span class="p">,</span>
</span><span id="LCCalculations.get_average_mass_spectrum-312"><a href="#LCCalculations.get_average_mass_spectrum-312"><span class="linenos">312</span></a>            <span class="n">my_ms_ave</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span>
</span><span id="LCCalculations.get_average_mass_spectrum-313"><a href="#LCCalculations.get_average_mass_spectrum-313"><span class="linenos">313</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_location</span><span class="p">,</span>
</span><span id="LCCalculations.get_average_mass_spectrum-314"><a href="#LCCalculations.get_average_mass_spectrum-314"><span class="linenos">314</span></a>            <span class="n">polarity</span><span class="o">=</span><span class="n">polarity</span><span class="p">,</span>
</span><span id="LCCalculations.get_average_mass_spectrum-315"><a href="#LCCalculations.get_average_mass_spectrum-315"><span class="linenos">315</span></a>            <span class="n">auto_process</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="LCCalculations.get_average_mass_spectrum-316"><a href="#LCCalculations.get_average_mass_spectrum-316"><span class="linenos">316</span></a>        <span class="p">)</span>
</span><span id="LCCalculations.get_average_mass_spectrum-317"><a href="#LCCalculations.get_average_mass_spectrum-317"><span class="linenos">317</span></a>
</span><span id="LCCalculations.get_average_mass_spectrum-318"><a href="#LCCalculations.get_average_mass_spectrum-318"><span class="linenos">318</span></a>        <span class="c1"># Set the mass spectrum parameters, auto-process if auto_process is True, and add to the dataset</span>
</span><span id="LCCalculations.get_average_mass_spectrum-319"><a href="#LCCalculations.get_average_mass_spectrum-319"><span class="linenos">319</span></a>        <span class="k">if</span> <span class="n">ms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations.get_average_mass_spectrum-320"><a href="#LCCalculations.get_average_mass_spectrum-320"><span class="linenos">320</span></a>            <span class="k">if</span> <span class="n">ms_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations.get_average_mass_spectrum-321"><a href="#LCCalculations.get_average_mass_spectrum-321"><span class="linenos">321</span></a>                <span class="n">ms</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">ms_params</span>
</span><span id="LCCalculations.get_average_mass_spectrum-322"><a href="#LCCalculations.get_average_mass_spectrum-322"><span class="linenos">322</span></a>            <span class="n">ms</span><span class="o">.</span><span class="n">scan_number</span> <span class="o">=</span> <span class="n">apex_scan</span>
</span><span id="LCCalculations.get_average_mass_spectrum-323"><a href="#LCCalculations.get_average_mass_spectrum-323"><span class="linenos">323</span></a>            <span class="k">if</span> <span class="n">auto_process</span><span class="p">:</span>
</span><span id="LCCalculations.get_average_mass_spectrum-324"><a href="#LCCalculations.get_average_mass_spectrum-324"><span class="linenos">324</span></a>                <span class="n">ms</span><span class="o">.</span><span class="n">process_mass_spec</span><span class="p">()</span>
</span><span id="LCCalculations.get_average_mass_spectrum-325"><a href="#LCCalculations.get_average_mass_spectrum-325"><span class="linenos">325</span></a>        <span class="k">return</span> <span class="n">ms</span>
</span></pre></div>


            <div class="docstring"><p>Returns an averaged mass spectrum object</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>scan_list</strong> (list):
List of scan numbers to average.</li>
<li><strong>apex_scan</strong> (int):
Number of the apex scan</li>
<li><strong>spectrum_mode</strong> (str, optional):
The spectrum mode to use. Defaults to "profile". Not that only "profile" mode is supported for averaging.</li>
<li><strong>ms_level</strong> (int, optional):
The MS level to use. Defaults to 1.</li>
<li><strong>auto_process</strong> (bool, optional):
If True, the averaged mass spectrum will be auto-processed. Defaults to True.</li>
<li><strong>use_parser</strong> (bool, optional):
If True, the mass spectra will be obtained from the parser. Defaults to False.</li>
<li><strong>perform_checks</strong> (bool, optional):
If True, the function will check if the data are within the ms_unprocessed dictionary and are the correct mode. Defaults to True. Only set to False if you are sure the data are profile, and (if not using the parser) are in the ms_unprocessed dictionary!  ms_unprocessed dictionary also must be indexed on scan</li>
<li><strong>polarity</strong> (int, optional):
The polarity of the mass spectra (1 or -1). If not set, the polarity will be determined from the dataset. Defaults to None. (fastest if set to -1 or 1)</li>
<li><strong>ms_params</strong> (MSParameters, optional):
The mass spectrum parameters to use. If not set (None), the globally set parameters will be used. Defaults to None.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>MassSpectrumProfile</strong>: The averaged mass spectrum object.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>ValueError</strong>: If the spectrum mode is not "profile".
If the MS level is not found in the unprocessed mass spectra dictionary.
If not all scan numbers are found in the unprocessed mass spectra dictionary.</li>
</ul>
</div>


                            </div>
                            <div id="LCCalculations.find_mass_features" class="classattr">
                                        <input id="LCCalculations.find_mass_features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">find_mass_features</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">ms_level</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">grid</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LCCalculations.find_mass_features-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LCCalculations.find_mass_features"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LCCalculations.find_mass_features-327"><a href="#LCCalculations.find_mass_features-327"><span class="linenos">327</span></a>    <span class="k">def</span> <span class="nf">find_mass_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="LCCalculations.find_mass_features-328"><a href="#LCCalculations.find_mass_features-328"><span class="linenos">328</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find mass features within an LCMSBase object</span>
</span><span id="LCCalculations.find_mass_features-329"><a href="#LCCalculations.find_mass_features-329"><span class="linenos">329</span></a>
</span><span id="LCCalculations.find_mass_features-330"><a href="#LCCalculations.find_mass_features-330"><span class="linenos">330</span></a><span class="sd">        Note that this is a wrapper function that calls the find_mass_features_ph function, but can be extended to support other peak picking methods in the future.</span>
</span><span id="LCCalculations.find_mass_features-331"><a href="#LCCalculations.find_mass_features-331"><span class="linenos">331</span></a>
</span><span id="LCCalculations.find_mass_features-332"><a href="#LCCalculations.find_mass_features-332"><span class="linenos">332</span></a><span class="sd">        Parameters</span>
</span><span id="LCCalculations.find_mass_features-333"><a href="#LCCalculations.find_mass_features-333"><span class="linenos">333</span></a><span class="sd">        ----------</span>
</span><span id="LCCalculations.find_mass_features-334"><a href="#LCCalculations.find_mass_features-334"><span class="linenos">334</span></a><span class="sd">        ms_level : int, optional</span>
</span><span id="LCCalculations.find_mass_features-335"><a href="#LCCalculations.find_mass_features-335"><span class="linenos">335</span></a><span class="sd">            The MS level to use for peak picking Default is 1.</span>
</span><span id="LCCalculations.find_mass_features-336"><a href="#LCCalculations.find_mass_features-336"><span class="linenos">336</span></a><span class="sd">        grid : bool, optional</span>
</span><span id="LCCalculations.find_mass_features-337"><a href="#LCCalculations.find_mass_features-337"><span class="linenos">337</span></a><span class="sd">            If True, will regrid the data before running the persistent homology calculations (after checking if the data is gridded, used for persistent homology peak picking. Default is True.</span>
</span><span id="LCCalculations.find_mass_features-338"><a href="#LCCalculations.find_mass_features-338"><span class="linenos">338</span></a>
</span><span id="LCCalculations.find_mass_features-339"><a href="#LCCalculations.find_mass_features-339"><span class="linenos">339</span></a><span class="sd">        Raises</span>
</span><span id="LCCalculations.find_mass_features-340"><a href="#LCCalculations.find_mass_features-340"><span class="linenos">340</span></a><span class="sd">        ------</span>
</span><span id="LCCalculations.find_mass_features-341"><a href="#LCCalculations.find_mass_features-341"><span class="linenos">341</span></a><span class="sd">        ValueError</span>
</span><span id="LCCalculations.find_mass_features-342"><a href="#LCCalculations.find_mass_features-342"><span class="linenos">342</span></a><span class="sd">            If no MS level data is found on the object.</span>
</span><span id="LCCalculations.find_mass_features-343"><a href="#LCCalculations.find_mass_features-343"><span class="linenos">343</span></a><span class="sd">            If persistent homology peak picking is attempted on non-profile mode data.</span>
</span><span id="LCCalculations.find_mass_features-344"><a href="#LCCalculations.find_mass_features-344"><span class="linenos">344</span></a><span class="sd">            If data is not gridded and grid is False.</span>
</span><span id="LCCalculations.find_mass_features-345"><a href="#LCCalculations.find_mass_features-345"><span class="linenos">345</span></a><span class="sd">            If peak picking method is not implemented.</span>
</span><span id="LCCalculations.find_mass_features-346"><a href="#LCCalculations.find_mass_features-346"><span class="linenos">346</span></a>
</span><span id="LCCalculations.find_mass_features-347"><a href="#LCCalculations.find_mass_features-347"><span class="linenos">347</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations.find_mass_features-348"><a href="#LCCalculations.find_mass_features-348"><span class="linenos">348</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations.find_mass_features-349"><a href="#LCCalculations.find_mass_features-349"><span class="linenos">349</span></a><span class="sd">        None, but assigns the mass_features and eics attributes to the object.</span>
</span><span id="LCCalculations.find_mass_features-350"><a href="#LCCalculations.find_mass_features-350"><span class="linenos">350</span></a>
</span><span id="LCCalculations.find_mass_features-351"><a href="#LCCalculations.find_mass_features-351"><span class="linenos">351</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations.find_mass_features-352"><a href="#LCCalculations.find_mass_features-352"><span class="linenos">352</span></a>        <span class="n">pp_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">peak_picking_method</span>
</span><span id="LCCalculations.find_mass_features-353"><a href="#LCCalculations.find_mass_features-353"><span class="linenos">353</span></a>
</span><span id="LCCalculations.find_mass_features-354"><a href="#LCCalculations.find_mass_features-354"><span class="linenos">354</span></a>        <span class="k">if</span> <span class="n">pp_method</span> <span class="o">==</span> <span class="s2">&quot;persistent homology&quot;</span><span class="p">:</span>
</span><span id="LCCalculations.find_mass_features-355"><a href="#LCCalculations.find_mass_features-355"><span class="linenos">355</span></a>            <span class="n">msx_scan_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_df</span><span class="p">[</span><span class="s2">&quot;ms_level&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ms_level</span><span class="p">]</span>
</span><span id="LCCalculations.find_mass_features-356"><a href="#LCCalculations.find_mass_features-356"><span class="linenos">356</span></a>            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">msx_scan_df</span><span class="p">[</span><span class="s2">&quot;ms_format&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;profile&quot;</span><span class="p">):</span>
</span><span id="LCCalculations.find_mass_features-357"><a href="#LCCalculations.find_mass_features-357"><span class="linenos">357</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">find_mass_features_ph</span><span class="p">(</span><span class="n">ms_level</span><span class="o">=</span><span class="n">ms_level</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>
</span><span id="LCCalculations.find_mass_features-358"><a href="#LCCalculations.find_mass_features-358"><span class="linenos">358</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cluster_mass_features</span><span class="p">(</span><span class="n">drop_children</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="s2">&quot;persistence&quot;</span><span class="p">)</span>
</span><span id="LCCalculations.find_mass_features-359"><a href="#LCCalculations.find_mass_features-359"><span class="linenos">359</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations.find_mass_features-360"><a href="#LCCalculations.find_mass_features-360"><span class="linenos">360</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LCCalculations.find_mass_features-361"><a href="#LCCalculations.find_mass_features-361"><span class="linenos">361</span></a>                    <span class="s2">&quot;MS</span><span class="si">{}</span><span class="s2"> scans are not profile mode, which is required for persistent homology peak picking.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="LCCalculations.find_mass_features-362"><a href="#LCCalculations.find_mass_features-362"><span class="linenos">362</span></a>                        <span class="n">ms_level</span>
</span><span id="LCCalculations.find_mass_features-363"><a href="#LCCalculations.find_mass_features-363"><span class="linenos">363</span></a>                    <span class="p">)</span>
</span><span id="LCCalculations.find_mass_features-364"><a href="#LCCalculations.find_mass_features-364"><span class="linenos">364</span></a>                <span class="p">)</span>
</span><span id="LCCalculations.find_mass_features-365"><a href="#LCCalculations.find_mass_features-365"><span class="linenos">365</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations.find_mass_features-366"><a href="#LCCalculations.find_mass_features-366"><span class="linenos">366</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Peak picking method not implemented&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Find mass features within an LCMSBase object</p>

<p>Note that this is a wrapper function that calls the find_mass_features_ph function, but can be extended to support other peak picking methods in the future.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>ms_level</strong> (int, optional):
The MS level to use for peak picking Default is 1.</li>
<li><strong>grid</strong> (bool, optional):
If True, will regrid the data before running the persistent homology calculations (after checking if the data is gridded, used for persistent homology peak picking. Default is True.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>ValueError</strong>: If no MS level data is found on the object.
If persistent homology peak picking is attempted on non-profile mode data.
If data is not gridded and grid is False.
If peak picking method is not implemented.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None, but assigns the mass_features and eics attributes to the object.</strong></li>
</ul>
</div>


                            </div>
                            <div id="LCCalculations.integrate_mass_features" class="classattr">
                                        <input id="LCCalculations.integrate_mass_features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">integrate_mass_features</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">drop_if_fail</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">drop_duplicates</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">ms_level</span><span class="o">=</span><span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LCCalculations.integrate_mass_features-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LCCalculations.integrate_mass_features"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LCCalculations.integrate_mass_features-368"><a href="#LCCalculations.integrate_mass_features-368"><span class="linenos">368</span></a>    <span class="k">def</span> <span class="nf">integrate_mass_features</span><span class="p">(</span>
</span><span id="LCCalculations.integrate_mass_features-369"><a href="#LCCalculations.integrate_mass_features-369"><span class="linenos">369</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">drop_if_fail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ms_level</span><span class="o">=</span><span class="mi">1</span>
</span><span id="LCCalculations.integrate_mass_features-370"><a href="#LCCalculations.integrate_mass_features-370"><span class="linenos">370</span></a>    <span class="p">):</span>
</span><span id="LCCalculations.integrate_mass_features-371"><a href="#LCCalculations.integrate_mass_features-371"><span class="linenos">371</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Integrate mass features and extract EICs.</span>
</span><span id="LCCalculations.integrate_mass_features-372"><a href="#LCCalculations.integrate_mass_features-372"><span class="linenos">372</span></a>
</span><span id="LCCalculations.integrate_mass_features-373"><a href="#LCCalculations.integrate_mass_features-373"><span class="linenos">373</span></a><span class="sd">        Populates the _eics attribute on the LCMSBase object for each unique mz in the mass_features dataframe and adds data (start_scan, final_scan, area) to the mass_features attribute.</span>
</span><span id="LCCalculations.integrate_mass_features-374"><a href="#LCCalculations.integrate_mass_features-374"><span class="linenos">374</span></a>
</span><span id="LCCalculations.integrate_mass_features-375"><a href="#LCCalculations.integrate_mass_features-375"><span class="linenos">375</span></a><span class="sd">        Parameters</span>
</span><span id="LCCalculations.integrate_mass_features-376"><a href="#LCCalculations.integrate_mass_features-376"><span class="linenos">376</span></a><span class="sd">        ----------</span>
</span><span id="LCCalculations.integrate_mass_features-377"><a href="#LCCalculations.integrate_mass_features-377"><span class="linenos">377</span></a><span class="sd">        drop_if_fail : bool, optional</span>
</span><span id="LCCalculations.integrate_mass_features-378"><a href="#LCCalculations.integrate_mass_features-378"><span class="linenos">378</span></a><span class="sd">            Whether to drop mass features if the EIC limit calculations fail.</span>
</span><span id="LCCalculations.integrate_mass_features-379"><a href="#LCCalculations.integrate_mass_features-379"><span class="linenos">379</span></a><span class="sd">            Default is True.</span>
</span><span id="LCCalculations.integrate_mass_features-380"><a href="#LCCalculations.integrate_mass_features-380"><span class="linenos">380</span></a><span class="sd">        drop_duplicates : bool, optional</span>
</span><span id="LCCalculations.integrate_mass_features-381"><a href="#LCCalculations.integrate_mass_features-381"><span class="linenos">381</span></a><span class="sd">            Whether to mass features that appear to be duplicates</span>
</span><span id="LCCalculations.integrate_mass_features-382"><a href="#LCCalculations.integrate_mass_features-382"><span class="linenos">382</span></a><span class="sd">            (i.e., mz is similar to another mass feature and limits of the EIC are similar or encapsulating).</span>
</span><span id="LCCalculations.integrate_mass_features-383"><a href="#LCCalculations.integrate_mass_features-383"><span class="linenos">383</span></a><span class="sd">            Default is True.</span>
</span><span id="LCCalculations.integrate_mass_features-384"><a href="#LCCalculations.integrate_mass_features-384"><span class="linenos">384</span></a><span class="sd">        ms_level : int, optional</span>
</span><span id="LCCalculations.integrate_mass_features-385"><a href="#LCCalculations.integrate_mass_features-385"><span class="linenos">385</span></a><span class="sd">            The MS level to use. Default is 1.</span>
</span><span id="LCCalculations.integrate_mass_features-386"><a href="#LCCalculations.integrate_mass_features-386"><span class="linenos">386</span></a>
</span><span id="LCCalculations.integrate_mass_features-387"><a href="#LCCalculations.integrate_mass_features-387"><span class="linenos">387</span></a><span class="sd">        Raises</span>
</span><span id="LCCalculations.integrate_mass_features-388"><a href="#LCCalculations.integrate_mass_features-388"><span class="linenos">388</span></a><span class="sd">        ------</span>
</span><span id="LCCalculations.integrate_mass_features-389"><a href="#LCCalculations.integrate_mass_features-389"><span class="linenos">389</span></a><span class="sd">        ValueError</span>
</span><span id="LCCalculations.integrate_mass_features-390"><a href="#LCCalculations.integrate_mass_features-390"><span class="linenos">390</span></a><span class="sd">            If no mass features are found.</span>
</span><span id="LCCalculations.integrate_mass_features-391"><a href="#LCCalculations.integrate_mass_features-391"><span class="linenos">391</span></a><span class="sd">            If no MS level data is found for the given MS level (either in data or in the scan data)</span>
</span><span id="LCCalculations.integrate_mass_features-392"><a href="#LCCalculations.integrate_mass_features-392"><span class="linenos">392</span></a>
</span><span id="LCCalculations.integrate_mass_features-393"><a href="#LCCalculations.integrate_mass_features-393"><span class="linenos">393</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations.integrate_mass_features-394"><a href="#LCCalculations.integrate_mass_features-394"><span class="linenos">394</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations.integrate_mass_features-395"><a href="#LCCalculations.integrate_mass_features-395"><span class="linenos">395</span></a><span class="sd">        None, but populates the eics attribute on the LCMSBase object and adds data (start_scan, final_scan, area) to the mass_features attribute.</span>
</span><span id="LCCalculations.integrate_mass_features-396"><a href="#LCCalculations.integrate_mass_features-396"><span class="linenos">396</span></a>
</span><span id="LCCalculations.integrate_mass_features-397"><a href="#LCCalculations.integrate_mass_features-397"><span class="linenos">397</span></a><span class="sd">        Notes</span>
</span><span id="LCCalculations.integrate_mass_features-398"><a href="#LCCalculations.integrate_mass_features-398"><span class="linenos">398</span></a><span class="sd">        -----</span>
</span><span id="LCCalculations.integrate_mass_features-399"><a href="#LCCalculations.integrate_mass_features-399"><span class="linenos">399</span></a><span class="sd">        drop_if_fail is useful for discarding mass features that do not have good shapes, usually due to a detection on a shoulder of a peak or a noisy region (especially if minimal smoothing is used during mass feature detection).</span>
</span><span id="LCCalculations.integrate_mass_features-400"><a href="#LCCalculations.integrate_mass_features-400"><span class="linenos">400</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations.integrate_mass_features-401"><a href="#LCCalculations.integrate_mass_features-401"><span class="linenos">401</span></a>        <span class="c1"># Check if there is data</span>
</span><span id="LCCalculations.integrate_mass_features-402"><a href="#LCCalculations.integrate_mass_features-402"><span class="linenos">402</span></a>        <span class="k">if</span> <span class="n">ms_level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LCCalculations.integrate_mass_features-403"><a href="#LCCalculations.integrate_mass_features-403"><span class="linenos">403</span></a>            <span class="n">raw_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="p">[</span><span class="n">ms_level</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations.integrate_mass_features-404"><a href="#LCCalculations.integrate_mass_features-404"><span class="linenos">404</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations.integrate_mass_features-405"><a href="#LCCalculations.integrate_mass_features-405"><span class="linenos">405</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No MS level &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ms_level</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; data found&quot;</span><span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-406"><a href="#LCCalculations.integrate_mass_features-406"><span class="linenos">406</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations.integrate_mass_features-407"><a href="#LCCalculations.integrate_mass_features-407"><span class="linenos">407</span></a>            <span class="n">mf_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations.integrate_mass_features-408"><a href="#LCCalculations.integrate_mass_features-408"><span class="linenos">408</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations.integrate_mass_features-409"><a href="#LCCalculations.integrate_mass_features-409"><span class="linenos">409</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LCCalculations.integrate_mass_features-410"><a href="#LCCalculations.integrate_mass_features-410"><span class="linenos">410</span></a>                <span class="s2">&quot;No mass features found, did you run find_mass_features() first?&quot;</span>
</span><span id="LCCalculations.integrate_mass_features-411"><a href="#LCCalculations.integrate_mass_features-411"><span class="linenos">411</span></a>            <span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-412"><a href="#LCCalculations.integrate_mass_features-412"><span class="linenos">412</span></a>        <span class="c1"># Check if mass_spectrum exists on each mass feature</span>
</span><span id="LCCalculations.integrate_mass_features-413"><a href="#LCCalculations.integrate_mass_features-413"><span class="linenos">413</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
</span><span id="LCCalculations.integrate_mass_features-414"><a href="#LCCalculations.integrate_mass_features-414"><span class="linenos">414</span></a>            <span class="p">[</span><span class="n">mf</span><span class="o">.</span><span class="n">mass_spectrum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
</span><span id="LCCalculations.integrate_mass_features-415"><a href="#LCCalculations.integrate_mass_features-415"><span class="linenos">415</span></a>        <span class="p">):</span>
</span><span id="LCCalculations.integrate_mass_features-416"><a href="#LCCalculations.integrate_mass_features-416"><span class="linenos">416</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LCCalculations.integrate_mass_features-417"><a href="#LCCalculations.integrate_mass_features-417"><span class="linenos">417</span></a>                <span class="s2">&quot;Mass spectrum must be associated with each mass feature, did you run add_associated_ms1() first?&quot;</span>
</span><span id="LCCalculations.integrate_mass_features-418"><a href="#LCCalculations.integrate_mass_features-418"><span class="linenos">418</span></a>            <span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-419"><a href="#LCCalculations.integrate_mass_features-419"><span class="linenos">419</span></a>
</span><span id="LCCalculations.integrate_mass_features-420"><a href="#LCCalculations.integrate_mass_features-420"><span class="linenos">420</span></a>        <span class="c1"># Subset scan data to only include correct ms_level</span>
</span><span id="LCCalculations.integrate_mass_features-421"><a href="#LCCalculations.integrate_mass_features-421"><span class="linenos">421</span></a>        <span class="n">scan_df_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_df</span><span class="p">[</span>
</span><span id="LCCalculations.integrate_mass_features-422"><a href="#LCCalculations.integrate_mass_features-422"><span class="linenos">422</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">scan_df</span><span class="p">[</span><span class="s2">&quot;ms_level&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">ms_level</span><span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-423"><a href="#LCCalculations.integrate_mass_features-423"><span class="linenos">423</span></a>        <span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-424"><a href="#LCCalculations.integrate_mass_features-424"><span class="linenos">424</span></a>        <span class="k">if</span> <span class="n">scan_df_sub</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="LCCalculations.integrate_mass_features-425"><a href="#LCCalculations.integrate_mass_features-425"><span class="linenos">425</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No MS level &quot;</span> <span class="o">+</span> <span class="n">ms_level</span> <span class="o">+</span> <span class="s2">&quot; data found in scan data&quot;</span><span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-426"><a href="#LCCalculations.integrate_mass_features-426"><span class="linenos">426</span></a>        <span class="n">scan_df_sub</span> <span class="o">=</span> <span class="n">scan_df_sub</span><span class="p">[[</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations.integrate_mass_features-427"><a href="#LCCalculations.integrate_mass_features-427"><span class="linenos">427</span></a>
</span><span id="LCCalculations.integrate_mass_features-428"><a href="#LCCalculations.integrate_mass_features-428"><span class="linenos">428</span></a>        <span class="n">mzs_to_extract</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-429"><a href="#LCCalculations.integrate_mass_features-429"><span class="linenos">429</span></a>        <span class="n">mzs_to_extract</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</span><span id="LCCalculations.integrate_mass_features-430"><a href="#LCCalculations.integrate_mass_features-430"><span class="linenos">430</span></a>
</span><span id="LCCalculations.integrate_mass_features-431"><a href="#LCCalculations.integrate_mass_features-431"><span class="linenos">431</span></a>        <span class="c1"># Get EICs for each unique mz in mass features list</span>
</span><span id="LCCalculations.integrate_mass_features-432"><a href="#LCCalculations.integrate_mass_features-432"><span class="linenos">432</span></a>        <span class="k">for</span> <span class="n">mz</span> <span class="ow">in</span> <span class="n">mzs_to_extract</span><span class="p">:</span>
</span><span id="LCCalculations.integrate_mass_features-433"><a href="#LCCalculations.integrate_mass_features-433"><span class="linenos">433</span></a>            <span class="n">mz_max</span> <span class="o">=</span> <span class="n">mz</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">eic_tolerance_ppm</span> <span class="o">*</span> <span class="n">mz</span> <span class="o">/</span> <span class="mf">1e6</span>
</span><span id="LCCalculations.integrate_mass_features-434"><a href="#LCCalculations.integrate_mass_features-434"><span class="linenos">434</span></a>            <span class="n">mz_min</span> <span class="o">=</span> <span class="n">mz</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">eic_tolerance_ppm</span> <span class="o">*</span> <span class="n">mz</span> <span class="o">/</span> <span class="mf">1e6</span>
</span><span id="LCCalculations.integrate_mass_features-435"><a href="#LCCalculations.integrate_mass_features-435"><span class="linenos">435</span></a>            <span class="n">raw_data_sub</span> <span class="o">=</span> <span class="n">raw_data</span><span class="p">[</span>
</span><span id="LCCalculations.integrate_mass_features-436"><a href="#LCCalculations.integrate_mass_features-436"><span class="linenos">436</span></a>                <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">mz_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">mz_max</span><span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-437"><a href="#LCCalculations.integrate_mass_features-437"><span class="linenos">437</span></a>            <span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-438"><a href="#LCCalculations.integrate_mass_features-438"><span class="linenos">438</span></a>            <span class="n">raw_data_sub</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LCCalculations.integrate_mass_features-439"><a href="#LCCalculations.integrate_mass_features-439"><span class="linenos">439</span></a>                <span class="n">raw_data_sub</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;scan&quot;</span><span class="p">])[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="LCCalculations.integrate_mass_features-440"><a href="#LCCalculations.integrate_mass_features-440"><span class="linenos">440</span></a>            <span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-441"><a href="#LCCalculations.integrate_mass_features-441"><span class="linenos">441</span></a>            <span class="n">raw_data_sub</span> <span class="o">=</span> <span class="n">scan_df_sub</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">raw_data_sub</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-442"><a href="#LCCalculations.integrate_mass_features-442"><span class="linenos">442</span></a>            <span class="n">raw_data_sub</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_data_sub</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-443"><a href="#LCCalculations.integrate_mass_features-443"><span class="linenos">443</span></a>            <span class="n">myEIC</span> <span class="o">=</span> <span class="n">EIC_Data</span><span class="p">(</span>
</span><span id="LCCalculations.integrate_mass_features-444"><a href="#LCCalculations.integrate_mass_features-444"><span class="linenos">444</span></a>                <span class="n">scans</span><span class="o">=</span><span class="n">raw_data_sub</span><span class="p">[</span><span class="s2">&quot;scan&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
</span><span id="LCCalculations.integrate_mass_features-445"><a href="#LCCalculations.integrate_mass_features-445"><span class="linenos">445</span></a>                <span class="n">time</span><span class="o">=</span><span class="n">raw_data_sub</span><span class="p">[</span><span class="s2">&quot;scan_time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
</span><span id="LCCalculations.integrate_mass_features-446"><a href="#LCCalculations.integrate_mass_features-446"><span class="linenos">446</span></a>                <span class="n">eic</span><span class="o">=</span><span class="n">raw_data_sub</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
</span><span id="LCCalculations.integrate_mass_features-447"><a href="#LCCalculations.integrate_mass_features-447"><span class="linenos">447</span></a>            <span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-448"><a href="#LCCalculations.integrate_mass_features-448"><span class="linenos">448</span></a>            <span class="c1"># Smooth EIC</span>
</span><span id="LCCalculations.integrate_mass_features-449"><a href="#LCCalculations.integrate_mass_features-449"><span class="linenos">449</span></a>            <span class="n">smoothed_eic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_tic</span><span class="p">(</span><span class="n">myEIC</span><span class="o">.</span><span class="n">eic</span><span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-450"><a href="#LCCalculations.integrate_mass_features-450"><span class="linenos">450</span></a>            <span class="n">smoothed_eic</span><span class="p">[</span><span class="n">smoothed_eic</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LCCalculations.integrate_mass_features-451"><a href="#LCCalculations.integrate_mass_features-451"><span class="linenos">451</span></a>            <span class="n">myEIC</span><span class="o">.</span><span class="n">eic_smoothed</span> <span class="o">=</span> <span class="n">smoothed_eic</span>
</span><span id="LCCalculations.integrate_mass_features-452"><a href="#LCCalculations.integrate_mass_features-452"><span class="linenos">452</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eics</span><span class="p">[</span><span class="n">mz</span><span class="p">]</span> <span class="o">=</span> <span class="n">myEIC</span>
</span><span id="LCCalculations.integrate_mass_features-453"><a href="#LCCalculations.integrate_mass_features-453"><span class="linenos">453</span></a>
</span><span id="LCCalculations.integrate_mass_features-454"><a href="#LCCalculations.integrate_mass_features-454"><span class="linenos">454</span></a>        <span class="c1"># Get limits of mass features using EIC centroid detector and integrate</span>
</span><span id="LCCalculations.integrate_mass_features-455"><a href="#LCCalculations.integrate_mass_features-455"><span class="linenos">455</span></a>        <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="LCCalculations.integrate_mass_features-456"><a href="#LCCalculations.integrate_mass_features-456"><span class="linenos">456</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mass_feature</span> <span class="ow">in</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="LCCalculations.integrate_mass_features-457"><a href="#LCCalculations.integrate_mass_features-457"><span class="linenos">457</span></a>            <span class="n">mz</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">mz</span>
</span><span id="LCCalculations.integrate_mass_features-458"><a href="#LCCalculations.integrate_mass_features-458"><span class="linenos">458</span></a>            <span class="n">apex_scan</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">apex_scan</span>
</span><span id="LCCalculations.integrate_mass_features-459"><a href="#LCCalculations.integrate_mass_features-459"><span class="linenos">459</span></a>
</span><span id="LCCalculations.integrate_mass_features-460"><a href="#LCCalculations.integrate_mass_features-460"><span class="linenos">460</span></a>            <span class="c1"># Pull EIC data and find apex scan index</span>
</span><span id="LCCalculations.integrate_mass_features-461"><a href="#LCCalculations.integrate_mass_features-461"><span class="linenos">461</span></a>            <span class="n">myEIC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eics</span><span class="p">[</span><span class="n">mz</span><span class="p">]</span>
</span><span id="LCCalculations.integrate_mass_features-462"><a href="#LCCalculations.integrate_mass_features-462"><span class="linenos">462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">_eic_data</span> <span class="o">=</span> <span class="n">myEIC</span>
</span><span id="LCCalculations.integrate_mass_features-463"><a href="#LCCalculations.integrate_mass_features-463"><span class="linenos">463</span></a>            <span class="n">apex_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">myEIC</span><span class="o">.</span><span class="n">scans</span> <span class="o">==</span> <span class="n">apex_scan</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LCCalculations.integrate_mass_features-464"><a href="#LCCalculations.integrate_mass_features-464"><span class="linenos">464</span></a>
</span><span id="LCCalculations.integrate_mass_features-465"><a href="#LCCalculations.integrate_mass_features-465"><span class="linenos">465</span></a>            <span class="c1"># Find left and right limits of peak using EIC centroid detector, add to EICData</span>
</span><span id="LCCalculations.integrate_mass_features-466"><a href="#LCCalculations.integrate_mass_features-466"><span class="linenos">466</span></a>            <span class="n">centroid_eics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eic_centroid_detector</span><span class="p">(</span>
</span><span id="LCCalculations.integrate_mass_features-467"><a href="#LCCalculations.integrate_mass_features-467"><span class="linenos">467</span></a>                <span class="n">myEIC</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
</span><span id="LCCalculations.integrate_mass_features-468"><a href="#LCCalculations.integrate_mass_features-468"><span class="linenos">468</span></a>                <span class="n">myEIC</span><span class="o">.</span><span class="n">eic_smoothed</span><span class="p">,</span>
</span><span id="LCCalculations.integrate_mass_features-469"><a href="#LCCalculations.integrate_mass_features-469"><span class="linenos">469</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">intensity</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span>
</span><span id="LCCalculations.integrate_mass_features-470"><a href="#LCCalculations.integrate_mass_features-470"><span class="linenos">470</span></a>                <span class="n">apex_indexes</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">apex_index</span><span class="p">)],</span>
</span><span id="LCCalculations.integrate_mass_features-471"><a href="#LCCalculations.integrate_mass_features-471"><span class="linenos">471</span></a>            <span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-472"><a href="#LCCalculations.integrate_mass_features-472"><span class="linenos">472</span></a>            <span class="n">l_a_r_scan_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">centroid_eics</span><span class="p">]</span>
</span><span id="LCCalculations.integrate_mass_features-473"><a href="#LCCalculations.integrate_mass_features-473"><span class="linenos">473</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_a_r_scan_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LCCalculations.integrate_mass_features-474"><a href="#LCCalculations.integrate_mass_features-474"><span class="linenos">474</span></a>                <span class="c1"># Add start and final scan to mass_features and EICData</span>
</span><span id="LCCalculations.integrate_mass_features-475"><a href="#LCCalculations.integrate_mass_features-475"><span class="linenos">475</span></a>                <span class="n">left_scan</span><span class="p">,</span> <span class="n">right_scan</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LCCalculations.integrate_mass_features-476"><a href="#LCCalculations.integrate_mass_features-476"><span class="linenos">476</span></a>                    <span class="n">myEIC</span><span class="o">.</span><span class="n">scans</span><span class="p">[</span><span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="LCCalculations.integrate_mass_features-477"><a href="#LCCalculations.integrate_mass_features-477"><span class="linenos">477</span></a>                    <span class="n">myEIC</span><span class="o">.</span><span class="n">scans</span><span class="p">[</span><span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]],</span>
</span><span id="LCCalculations.integrate_mass_features-478"><a href="#LCCalculations.integrate_mass_features-478"><span class="linenos">478</span></a>                <span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-479"><a href="#LCCalculations.integrate_mass_features-479"><span class="linenos">479</span></a>                <span class="n">mf_scan_apex</span> <span class="o">=</span> <span class="p">[(</span><span class="n">left_scan</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">apex_scan</span><span class="p">),</span> <span class="n">right_scan</span><span class="p">)]</span>
</span><span id="LCCalculations.integrate_mass_features-480"><a href="#LCCalculations.integrate_mass_features-480"><span class="linenos">480</span></a>                <span class="n">myEIC</span><span class="o">.</span><span class="n">apexes</span> <span class="o">=</span> <span class="n">myEIC</span><span class="o">.</span><span class="n">apexes</span> <span class="o">+</span> <span class="n">mf_scan_apex</span>
</span><span id="LCCalculations.integrate_mass_features-481"><a href="#LCCalculations.integrate_mass_features-481"><span class="linenos">481</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">start_scan</span> <span class="o">=</span> <span class="n">left_scan</span>
</span><span id="LCCalculations.integrate_mass_features-482"><a href="#LCCalculations.integrate_mass_features-482"><span class="linenos">482</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">final_scan</span> <span class="o">=</span> <span class="n">right_scan</span>
</span><span id="LCCalculations.integrate_mass_features-483"><a href="#LCCalculations.integrate_mass_features-483"><span class="linenos">483</span></a>
</span><span id="LCCalculations.integrate_mass_features-484"><a href="#LCCalculations.integrate_mass_features-484"><span class="linenos">484</span></a>                <span class="c1"># Find area under peak using limits from EIC centroid detector, add to mass_features and EICData</span>
</span><span id="LCCalculations.integrate_mass_features-485"><a href="#LCCalculations.integrate_mass_features-485"><span class="linenos">485</span></a>                <span class="n">area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span>
</span><span id="LCCalculations.integrate_mass_features-486"><a href="#LCCalculations.integrate_mass_features-486"><span class="linenos">486</span></a>                    <span class="n">myEIC</span><span class="o">.</span><span class="n">eic_smoothed</span><span class="p">[</span><span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="LCCalculations.integrate_mass_features-487"><a href="#LCCalculations.integrate_mass_features-487"><span class="linenos">487</span></a>                    <span class="n">myEIC</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">l_a_r_scan_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
</span><span id="LCCalculations.integrate_mass_features-488"><a href="#LCCalculations.integrate_mass_features-488"><span class="linenos">488</span></a>                <span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-489"><a href="#LCCalculations.integrate_mass_features-489"><span class="linenos">489</span></a>                <span class="n">mf_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span>
</span><span id="LCCalculations.integrate_mass_features-490"><a href="#LCCalculations.integrate_mass_features-490"><span class="linenos">490</span></a>                <span class="n">myEIC</span><span class="o">.</span><span class="n">areas</span> <span class="o">=</span> <span class="n">myEIC</span><span class="o">.</span><span class="n">areas</span> <span class="o">+</span> <span class="p">[</span><span class="n">area</span><span class="p">]</span>
</span><span id="LCCalculations.integrate_mass_features-491"><a href="#LCCalculations.integrate_mass_features-491"><span class="linenos">491</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">eics</span><span class="p">[</span><span class="n">mz</span><span class="p">]</span> <span class="o">=</span> <span class="n">myEIC</span>
</span><span id="LCCalculations.integrate_mass_features-492"><a href="#LCCalculations.integrate_mass_features-492"><span class="linenos">492</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">_area</span> <span class="o">=</span> <span class="n">area</span>
</span><span id="LCCalculations.integrate_mass_features-493"><a href="#LCCalculations.integrate_mass_features-493"><span class="linenos">493</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations.integrate_mass_features-494"><a href="#LCCalculations.integrate_mass_features-494"><span class="linenos">494</span></a>                <span class="k">if</span> <span class="n">drop_if_fail</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="LCCalculations.integrate_mass_features-495"><a href="#LCCalculations.integrate_mass_features-495"><span class="linenos">495</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span id="LCCalculations.integrate_mass_features-496"><a href="#LCCalculations.integrate_mass_features-496"><span class="linenos">496</span></a>
</span><span id="LCCalculations.integrate_mass_features-497"><a href="#LCCalculations.integrate_mass_features-497"><span class="linenos">497</span></a>        <span class="k">if</span> <span class="n">drop_duplicates</span><span class="p">:</span>
</span><span id="LCCalculations.integrate_mass_features-498"><a href="#LCCalculations.integrate_mass_features-498"><span class="linenos">498</span></a>            <span class="c1"># Prepare mass feature dataframe</span>
</span><span id="LCCalculations.integrate_mass_features-499"><a href="#LCCalculations.integrate_mass_features-499"><span class="linenos">499</span></a>            <span class="n">mf_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations.integrate_mass_features-500"><a href="#LCCalculations.integrate_mass_features-500"><span class="linenos">500</span></a>
</span><span id="LCCalculations.integrate_mass_features-501"><a href="#LCCalculations.integrate_mass_features-501"><span class="linenos">501</span></a>            <span class="c1"># For each mass feature, find all mass features within the clustering tolerance ppm and drop if their start and end times are within another mass feature</span>
</span><span id="LCCalculations.integrate_mass_features-502"><a href="#LCCalculations.integrate_mass_features-502"><span class="linenos">502</span></a>            <span class="c1"># Kepp the first mass fea</span>
</span><span id="LCCalculations.integrate_mass_features-503"><a href="#LCCalculations.integrate_mass_features-503"><span class="linenos">503</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mass_feature</span> <span class="ow">in</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="LCCalculations.integrate_mass_features-504"><a href="#LCCalculations.integrate_mass_features-504"><span class="linenos">504</span></a>                <span class="n">mz</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">mz</span>
</span><span id="LCCalculations.integrate_mass_features-505"><a href="#LCCalculations.integrate_mass_features-505"><span class="linenos">505</span></a>                <span class="n">apex_scan</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">apex_scan</span>
</span><span id="LCCalculations.integrate_mass_features-506"><a href="#LCCalculations.integrate_mass_features-506"><span class="linenos">506</span></a>
</span><span id="LCCalculations.integrate_mass_features-507"><a href="#LCCalculations.integrate_mass_features-507"><span class="linenos">507</span></a>                <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mz_diff_ppm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">mz</span><span class="p">)</span> <span class="o">/</span> <span class="n">mz</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
</span><span id="LCCalculations.integrate_mass_features-508"><a href="#LCCalculations.integrate_mass_features-508"><span class="linenos">508</span></a>                <span class="n">mf_df_sub</span> <span class="o">=</span> <span class="n">mf_df</span><span class="p">[</span>
</span><span id="LCCalculations.integrate_mass_features-509"><a href="#LCCalculations.integrate_mass_features-509"><span class="linenos">509</span></a>                    <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mz_diff_ppm&quot;</span><span class="p">]</span>
</span><span id="LCCalculations.integrate_mass_features-510"><a href="#LCCalculations.integrate_mass_features-510"><span class="linenos">510</span></a>                    <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_mz_tolerance_rel</span>
</span><span id="LCCalculations.integrate_mass_features-511"><a href="#LCCalculations.integrate_mass_features-511"><span class="linenos">511</span></a>                    <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
</span><span id="LCCalculations.integrate_mass_features-512"><a href="#LCCalculations.integrate_mass_features-512"><span class="linenos">512</span></a>                <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations.integrate_mass_features-513"><a href="#LCCalculations.integrate_mass_features-513"><span class="linenos">513</span></a>
</span><span id="LCCalculations.integrate_mass_features-514"><a href="#LCCalculations.integrate_mass_features-514"><span class="linenos">514</span></a>                <span class="c1"># For all mass features within the clustering tolerance, check if the start and end times are within the start and end times of the mass feature</span>
</span><span id="LCCalculations.integrate_mass_features-515"><a href="#LCCalculations.integrate_mass_features-515"><span class="linenos">515</span></a>                <span class="k">for</span> <span class="n">idx2</span><span class="p">,</span> <span class="n">mass_feature2</span> <span class="ow">in</span> <span class="n">mf_df_sub</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span><span id="LCCalculations.integrate_mass_features-516"><a href="#LCCalculations.integrate_mass_features-516"><span class="linenos">516</span></a>                    <span class="k">if</span> <span class="n">idx2</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">:</span>
</span><span id="LCCalculations.integrate_mass_features-517"><a href="#LCCalculations.integrate_mass_features-517"><span class="linenos">517</span></a>                        <span class="k">if</span> <span class="p">(</span>
</span><span id="LCCalculations.integrate_mass_features-518"><a href="#LCCalculations.integrate_mass_features-518"><span class="linenos">518</span></a>                            <span class="n">mass_feature2</span><span class="o">.</span><span class="n">start_scan</span> <span class="o">&gt;=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">start_scan</span>
</span><span id="LCCalculations.integrate_mass_features-519"><a href="#LCCalculations.integrate_mass_features-519"><span class="linenos">519</span></a>                            <span class="ow">and</span> <span class="n">mass_feature2</span><span class="o">.</span><span class="n">final_scan</span> <span class="o">&lt;=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">final_scan</span>
</span><span id="LCCalculations.integrate_mass_features-520"><a href="#LCCalculations.integrate_mass_features-520"><span class="linenos">520</span></a>                        <span class="p">):</span>
</span><span id="LCCalculations.integrate_mass_features-521"><a href="#LCCalculations.integrate_mass_features-521"><span class="linenos">521</span></a>                            <span class="k">if</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LCCalculations.integrate_mass_features-522"><a href="#LCCalculations.integrate_mass_features-522"><span class="linenos">522</span></a>                                <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx2</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Integrate mass features and extract EICs.</p>

<p>Populates the _eics attribute on the LCMSBase object for each unique mz in the mass_features dataframe and adds data (start_scan, final_scan, area) to the mass_features attribute.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>drop_if_fail</strong> (bool, optional):
Whether to drop mass features if the EIC limit calculations fail.
Default is True.</li>
<li><strong>drop_duplicates</strong> (bool, optional):
Whether to mass features that appear to be duplicates
(i.e., mz is similar to another mass feature and limits of the EIC are similar or encapsulating).
Default is True.</li>
<li><strong>ms_level</strong> (int, optional):
The MS level to use. Default is 1.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>ValueError</strong>: If no mass features are found.
If no MS level data is found for the given MS level (either in data or in the scan data)</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None, but populates the eics attribute on the LCMSBase object and adds data (start_scan, final_scan, area) to the mass_features attribute.</strong></li>
</ul>

<h6 id="notes">Notes</h6>

<p>drop_if_fail is useful for discarding mass features that do not have good shapes, usually due to a detection on a shoulder of a peak or a noisy region (especially if minimal smoothing is used during mass feature detection).</p>
</div>


                            </div>
                            <div id="LCCalculations.find_c13_mass_features" class="classattr">
                                        <input id="LCCalculations.find_c13_mass_features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">find_c13_mass_features</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LCCalculations.find_c13_mass_features-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LCCalculations.find_c13_mass_features"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LCCalculations.find_c13_mass_features-524"><a href="#LCCalculations.find_c13_mass_features-524"><span class="linenos">524</span></a>    <span class="k">def</span> <span class="nf">find_c13_mass_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LCCalculations.find_c13_mass_features-525"><a href="#LCCalculations.find_c13_mass_features-525"><span class="linenos">525</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Mark likely C13 isotopes and connect to monoisoitopic mass features.</span>
</span><span id="LCCalculations.find_c13_mass_features-526"><a href="#LCCalculations.find_c13_mass_features-526"><span class="linenos">526</span></a>
</span><span id="LCCalculations.find_c13_mass_features-527"><a href="#LCCalculations.find_c13_mass_features-527"><span class="linenos">527</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations.find_c13_mass_features-528"><a href="#LCCalculations.find_c13_mass_features-528"><span class="linenos">528</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations.find_c13_mass_features-529"><a href="#LCCalculations.find_c13_mass_features-529"><span class="linenos">529</span></a><span class="sd">        None, but populates the monoisotopic_mf_id and isotopologue_type attributes to the indivual LCMSMassFeatures within the mass_features attribute of the LCMSBase object.</span>
</span><span id="LCCalculations.find_c13_mass_features-530"><a href="#LCCalculations.find_c13_mass_features-530"><span class="linenos">530</span></a>
</span><span id="LCCalculations.find_c13_mass_features-531"><a href="#LCCalculations.find_c13_mass_features-531"><span class="linenos">531</span></a><span class="sd">        Raises</span>
</span><span id="LCCalculations.find_c13_mass_features-532"><a href="#LCCalculations.find_c13_mass_features-532"><span class="linenos">532</span></a><span class="sd">        ------</span>
</span><span id="LCCalculations.find_c13_mass_features-533"><a href="#LCCalculations.find_c13_mass_features-533"><span class="linenos">533</span></a><span class="sd">        ValueError</span>
</span><span id="LCCalculations.find_c13_mass_features-534"><a href="#LCCalculations.find_c13_mass_features-534"><span class="linenos">534</span></a><span class="sd">            If no mass features are found.</span>
</span><span id="LCCalculations.find_c13_mass_features-535"><a href="#LCCalculations.find_c13_mass_features-535"><span class="linenos">535</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations.find_c13_mass_features-536"><a href="#LCCalculations.find_c13_mass_features-536"><span class="linenos">536</span></a>        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="LCCalculations.find_c13_mass_features-537"><a href="#LCCalculations.find_c13_mass_features-537"><span class="linenos">537</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="LCCalculations.find_c13_mass_features-538"><a href="#LCCalculations.find_c13_mass_features-538"><span class="linenos">538</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;evaluating mass features for C13 isotopes&quot;</span><span class="p">)</span>
</span><span id="LCCalculations.find_c13_mass_features-539"><a href="#LCCalculations.find_c13_mass_features-539"><span class="linenos">539</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations.find_c13_mass_features-540"><a href="#LCCalculations.find_c13_mass_features-540"><span class="linenos">540</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No mass features found, run find_mass_features() first&quot;</span><span class="p">)</span>
</span><span id="LCCalculations.find_c13_mass_features-541"><a href="#LCCalculations.find_c13_mass_features-541"><span class="linenos">541</span></a>
</span><span id="LCCalculations.find_c13_mass_features-542"><a href="#LCCalculations.find_c13_mass_features-542"><span class="linenos">542</span></a>        <span class="c1"># Data prep fo sparse distance matrix</span>
</span><span id="LCCalculations.find_c13_mass_features-543"><a href="#LCCalculations.find_c13_mass_features-543"><span class="linenos">543</span></a>        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]</span>
</span><span id="LCCalculations.find_c13_mass_features-544"><a href="#LCCalculations.find_c13_mass_features-544"><span class="linenos">544</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations.find_c13_mass_features-545"><a href="#LCCalculations.find_c13_mass_features-545"><span class="linenos">545</span></a>        <span class="c1"># Drop mass features that have no area (these are likely to be noise)</span>
</span><span id="LCCalculations.find_c13_mass_features-546"><a href="#LCCalculations.find_c13_mass_features-546"><span class="linenos">546</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df</span><span class="p">[</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()]</span>
</span><span id="LCCalculations.find_c13_mass_features-547"><a href="#LCCalculations.find_c13_mass_features-547"><span class="linenos">547</span></a>        <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mf_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="LCCalculations.find_c13_mass_features-548"><a href="#LCCalculations.find_c13_mass_features-548"><span class="linenos">548</span></a>        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]</span>
</span><span id="LCCalculations.find_c13_mass_features-549"><a href="#LCCalculations.find_c13_mass_features-549"><span class="linenos">549</span></a>
</span><span id="LCCalculations.find_c13_mass_features-550"><a href="#LCCalculations.find_c13_mass_features-550"><span class="linenos">550</span></a>        <span class="c1"># Sort my ascending mz so we always get the monoisotopic mass first, regardless of the order/intensity of the mass features</span>
</span><span id="LCCalculations.find_c13_mass_features-551"><a href="#LCCalculations.find_c13_mass_features-551"><span class="linenos">551</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations.find_c13_mass_features-552"><a href="#LCCalculations.find_c13_mass_features-552"><span class="linenos">552</span></a>
</span><span id="LCCalculations.find_c13_mass_features-553"><a href="#LCCalculations.find_c13_mass_features-553"><span class="linenos">553</span></a>        <span class="n">mz_diff</span> <span class="o">=</span> <span class="mf">1.003355</span>  <span class="c1"># C13-C12 mass difference</span>
</span><span id="LCCalculations.find_c13_mass_features-554"><a href="#LCCalculations.find_c13_mass_features-554"><span class="linenos">554</span></a>        <span class="n">tol</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LCCalculations.find_c13_mass_features-555"><a href="#LCCalculations.find_c13_mass_features-555"><span class="linenos">555</span></a>            <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
</span><span id="LCCalculations.find_c13_mass_features-556"><a href="#LCCalculations.find_c13_mass_features-556"><span class="linenos">556</span></a>            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_mz_tolerance_rel</span><span class="p">,</span>
</span><span id="LCCalculations.find_c13_mass_features-557"><a href="#LCCalculations.find_c13_mass_features-557"><span class="linenos">557</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_rt_tolerance</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span>
</span><span id="LCCalculations.find_c13_mass_features-558"><a href="#LCCalculations.find_c13_mass_features-558"><span class="linenos">558</span></a>        <span class="p">]</span>  <span class="c1"># mz, in relative; scan_time in minutes</span>
</span><span id="LCCalculations.find_c13_mass_features-559"><a href="#LCCalculations.find_c13_mass_features-559"><span class="linenos">559</span></a>
</span><span id="LCCalculations.find_c13_mass_features-560"><a href="#LCCalculations.find_c13_mass_features-560"><span class="linenos">560</span></a>        <span class="c1"># Compute inter-feature distances</span>
</span><span id="LCCalculations.find_c13_mass_features-561"><a href="#LCCalculations.find_c13_mass_features-561"><span class="linenos">561</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LCCalculations.find_c13_mass_features-562"><a href="#LCCalculations.find_c13_mass_features-562"><span class="linenos">562</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)):</span>
</span><span id="LCCalculations.find_c13_mass_features-563"><a href="#LCCalculations.find_c13_mass_features-563"><span class="linenos">563</span></a>            <span class="c1"># Construct k-d tree</span>
</span><span id="LCCalculations.find_c13_mass_features-564"><a href="#LCCalculations.find_c13_mass_features-564"><span class="linenos">564</span></a>            <span class="n">values</span> <span class="o">=</span> <span class="n">mf_df</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="LCCalculations.find_c13_mass_features-565"><a href="#LCCalculations.find_c13_mass_features-565"><span class="linenos">565</span></a>            <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="LCCalculations.find_c13_mass_features-566"><a href="#LCCalculations.find_c13_mass_features-566"><span class="linenos">566</span></a>
</span><span id="LCCalculations.find_c13_mass_features-567"><a href="#LCCalculations.find_c13_mass_features-567"><span class="linenos">567</span></a>            <span class="n">max_tol</span> <span class="o">=</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="LCCalculations.find_c13_mass_features-568"><a href="#LCCalculations.find_c13_mass_features-568"><span class="linenos">568</span></a>            <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mz&quot;</span><span class="p">:</span>
</span><span id="LCCalculations.find_c13_mass_features-569"><a href="#LCCalculations.find_c13_mass_features-569"><span class="linenos">569</span></a>                <span class="c1"># Maximum absolute tolerance</span>
</span><span id="LCCalculations.find_c13_mass_features-570"><a href="#LCCalculations.find_c13_mass_features-570"><span class="linenos">570</span></a>                <span class="n">max_tol</span> <span class="o">=</span> <span class="n">mz_diff</span> <span class="o">+</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="LCCalculations.find_c13_mass_features-571"><a href="#LCCalculations.find_c13_mass_features-571"><span class="linenos">571</span></a>
</span><span id="LCCalculations.find_c13_mass_features-572"><a href="#LCCalculations.find_c13_mass_features-572"><span class="linenos">572</span></a>            <span class="c1"># Compute sparse distance matrix</span>
</span><span id="LCCalculations.find_c13_mass_features-573"><a href="#LCCalculations.find_c13_mass_features-573"><span class="linenos">573</span></a>            <span class="c1"># the larger the max_tol, the slower this operation is</span>
</span><span id="LCCalculations.find_c13_mass_features-574"><a href="#LCCalculations.find_c13_mass_features-574"><span class="linenos">574</span></a>            <span class="n">sdm</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">sparse_distance_matrix</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">max_tol</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;coo_matrix&quot;</span><span class="p">)</span>
</span><span id="LCCalculations.find_c13_mass_features-575"><a href="#LCCalculations.find_c13_mass_features-575"><span class="linenos">575</span></a>
</span><span id="LCCalculations.find_c13_mass_features-576"><a href="#LCCalculations.find_c13_mass_features-576"><span class="linenos">576</span></a>            <span class="c1"># Only consider forward case, exclude diagonal</span>
</span><span id="LCCalculations.find_c13_mass_features-577"><a href="#LCCalculations.find_c13_mass_features-577"><span class="linenos">577</span></a>            <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">sdm</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="LCCalculations.find_c13_mass_features-578"><a href="#LCCalculations.find_c13_mass_features-578"><span class="linenos">578</span></a>
</span><span id="LCCalculations.find_c13_mass_features-579"><a href="#LCCalculations.find_c13_mass_features-579"><span class="linenos">579</span></a>            <span class="k">if</span> <span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;mz&quot;</span><span class="p">:</span>
</span><span id="LCCalculations.find_c13_mass_features-580"><a href="#LCCalculations.find_c13_mass_features-580"><span class="linenos">580</span></a>                <span class="n">min_tol</span> <span class="o">=</span> <span class="n">mz_diff</span> <span class="o">-</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="LCCalculations.find_c13_mass_features-581"><a href="#LCCalculations.find_c13_mass_features-581"><span class="linenos">581</span></a>                <span class="c1"># Get only the ones that are above the min tol</span>
</span><span id="LCCalculations.find_c13_mass_features-582"><a href="#LCCalculations.find_c13_mass_features-582"><span class="linenos">582</span></a>                <span class="n">idx</span> <span class="o">=</span> <span class="n">sdm</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">min_tol</span>
</span><span id="LCCalculations.find_c13_mass_features-583"><a href="#LCCalculations.find_c13_mass_features-583"><span class="linenos">583</span></a>
</span><span id="LCCalculations.find_c13_mass_features-584"><a href="#LCCalculations.find_c13_mass_features-584"><span class="linenos">584</span></a>                <span class="c1"># Reconstruct sparse distance matrix</span>
</span><span id="LCCalculations.find_c13_mass_features-585"><a href="#LCCalculations.find_c13_mass_features-585"><span class="linenos">585</span></a>                <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">(</span>
</span><span id="LCCalculations.find_c13_mass_features-586"><a href="#LCCalculations.find_c13_mass_features-586"><span class="linenos">586</span></a>                    <span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">sdm</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">idx</span><span class="p">])),</span>
</span><span id="LCCalculations.find_c13_mass_features-587"><a href="#LCCalculations.find_c13_mass_features-587"><span class="linenos">587</span></a>                    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
</span><span id="LCCalculations.find_c13_mass_features-588"><a href="#LCCalculations.find_c13_mass_features-588"><span class="linenos">588</span></a>                <span class="p">)</span>
</span><span id="LCCalculations.find_c13_mass_features-589"><a href="#LCCalculations.find_c13_mass_features-589"><span class="linenos">589</span></a>
</span><span id="LCCalculations.find_c13_mass_features-590"><a href="#LCCalculations.find_c13_mass_features-590"><span class="linenos">590</span></a>            <span class="c1"># Cast as binary matrix</span>
</span><span id="LCCalculations.find_c13_mass_features-591"><a href="#LCCalculations.find_c13_mass_features-591"><span class="linenos">591</span></a>            <span class="n">sdm</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="LCCalculations.find_c13_mass_features-592"><a href="#LCCalculations.find_c13_mass_features-592"><span class="linenos">592</span></a>
</span><span id="LCCalculations.find_c13_mass_features-593"><a href="#LCCalculations.find_c13_mass_features-593"><span class="linenos">593</span></a>            <span class="c1"># Stack distances</span>
</span><span id="LCCalculations.find_c13_mass_features-594"><a href="#LCCalculations.find_c13_mass_features-594"><span class="linenos">594</span></a>            <span class="k">if</span> <span class="n">distances</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations.find_c13_mass_features-595"><a href="#LCCalculations.find_c13_mass_features-595"><span class="linenos">595</span></a>                <span class="n">distances</span> <span class="o">=</span> <span class="n">sdm</span>
</span><span id="LCCalculations.find_c13_mass_features-596"><a href="#LCCalculations.find_c13_mass_features-596"><span class="linenos">596</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations.find_c13_mass_features-597"><a href="#LCCalculations.find_c13_mass_features-597"><span class="linenos">597</span></a>                <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sdm</span><span class="p">)</span>
</span><span id="LCCalculations.find_c13_mass_features-598"><a href="#LCCalculations.find_c13_mass_features-598"><span class="linenos">598</span></a>
</span><span id="LCCalculations.find_c13_mass_features-599"><a href="#LCCalculations.find_c13_mass_features-599"><span class="linenos">599</span></a>        <span class="c1"># Extract indices of within-tolerance points</span>
</span><span id="LCCalculations.find_c13_mass_features-600"><a href="#LCCalculations.find_c13_mass_features-600"><span class="linenos">600</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">tocoo</span><span class="p">()</span>
</span><span id="LCCalculations.find_c13_mass_features-601"><a href="#LCCalculations.find_c13_mass_features-601"><span class="linenos">601</span></a>        <span class="n">pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">distances</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">distances</span><span class="o">.</span><span class="n">col</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># C12 to C13 pairs</span>
</span><span id="LCCalculations.find_c13_mass_features-602"><a href="#LCCalculations.find_c13_mass_features-602"><span class="linenos">602</span></a>
</span><span id="LCCalculations.find_c13_mass_features-603"><a href="#LCCalculations.find_c13_mass_features-603"><span class="linenos">603</span></a>        <span class="c1"># Turn pairs (which are index of mf_df) into mf_id and then into two dataframes to join to mf_df</span>
</span><span id="LCCalculations.find_c13_mass_features-604"><a href="#LCCalculations.find_c13_mass_features-604"><span class="linenos">604</span></a>        <span class="n">pairs_mf</span> <span class="o">=</span> <span class="n">pairs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations.find_c13_mass_features-605"><a href="#LCCalculations.find_c13_mass_features-605"><span class="linenos">605</span></a>        <span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">mf_id</span><span class="o">.</span><span class="n">values</span>
</span><span id="LCCalculations.find_c13_mass_features-606"><a href="#LCCalculations.find_c13_mass_features-606"><span class="linenos">606</span></a>        <span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">mf_id</span><span class="o">.</span><span class="n">values</span>
</span><span id="LCCalculations.find_c13_mass_features-607"><a href="#LCCalculations.find_c13_mass_features-607"><span class="linenos">607</span></a>
</span><span id="LCCalculations.find_c13_mass_features-608"><a href="#LCCalculations.find_c13_mass_features-608"><span class="linenos">608</span></a>        <span class="c1"># Connect monoisotopic masses with isotopologes within mass_features</span>
</span><span id="LCCalculations.find_c13_mass_features-609"><a href="#LCCalculations.find_c13_mass_features-609"><span class="linenos">609</span></a>        <span class="n">monos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
</span><span id="LCCalculations.find_c13_mass_features-610"><a href="#LCCalculations.find_c13_mass_features-610"><span class="linenos">610</span></a>        <span class="k">for</span> <span class="n">mono</span> <span class="ow">in</span> <span class="n">monos</span><span class="p">:</span>
</span><span id="LCCalculations.find_c13_mass_features-611"><a href="#LCCalculations.find_c13_mass_features-611"><span class="linenos">611</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">mono</span><span class="p">]</span><span class="o">.</span><span class="n">monoisotopic_mf_id</span> <span class="o">=</span> <span class="n">mono</span>
</span><span id="LCCalculations.find_c13_mass_features-612"><a href="#LCCalculations.find_c13_mass_features-612"><span class="linenos">612</span></a>        <span class="n">pairs_iso_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pairs_mf</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;parent&quot;</span><span class="p">,</span> <span class="s2">&quot;child&quot;</span><span class="p">])</span>
</span><span id="LCCalculations.find_c13_mass_features-613"><a href="#LCCalculations.find_c13_mass_features-613"><span class="linenos">613</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="LCCalculations.find_c13_mass_features-614"><a href="#LCCalculations.find_c13_mass_features-614"><span class="linenos">614</span></a>            <span class="n">pairs_iso_df</span> <span class="o">=</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LCCalculations.find_c13_mass_features-615"><a href="#LCCalculations.find_c13_mass_features-615"><span class="linenos">615</span></a>            <span class="n">m1_isos</span> <span class="o">=</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">monos</span><span class="p">,</span> <span class="s2">&quot;child&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="LCCalculations.find_c13_mass_features-616"><a href="#LCCalculations.find_c13_mass_features-616"><span class="linenos">616</span></a>            <span class="k">for</span> <span class="n">iso</span> <span class="ow">in</span> <span class="n">m1_isos</span><span class="p">:</span>
</span><span id="LCCalculations.find_c13_mass_features-617"><a href="#LCCalculations.find_c13_mass_features-617"><span class="linenos">617</span></a>                <span class="c1"># Set monoisotopic_mf_id and isotopologue_type for isotopologues</span>
</span><span id="LCCalculations.find_c13_mass_features-618"><a href="#LCCalculations.find_c13_mass_features-618"><span class="linenos">618</span></a>                <span class="n">parent</span> <span class="o">=</span> <span class="n">pairs_mf</span><span class="p">[</span><span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">iso</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="LCCalculations.find_c13_mass_features-619"><a href="#LCCalculations.find_c13_mass_features-619"><span class="linenos">619</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="LCCalculations.find_c13_mass_features-620"><a href="#LCCalculations.find_c13_mass_features-620"><span class="linenos">620</span></a>                    <span class="c1"># Choose the parent that is closest in time to the isotopologue</span>
</span><span id="LCCalculations.find_c13_mass_features-621"><a href="#LCCalculations.find_c13_mass_features-621"><span class="linenos">621</span></a>                    <span class="n">parent_time</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">retention_time</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parent</span><span class="p">]</span>
</span><span id="LCCalculations.find_c13_mass_features-622"><a href="#LCCalculations.find_c13_mass_features-622"><span class="linenos">622</span></a>                    <span class="n">time_diff</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LCCalculations.find_c13_mass_features-623"><a href="#LCCalculations.find_c13_mass_features-623"><span class="linenos">623</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">retention_time</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>
</span><span id="LCCalculations.find_c13_mass_features-624"><a href="#LCCalculations.find_c13_mass_features-624"><span class="linenos">624</span></a>                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parent_time</span>
</span><span id="LCCalculations.find_c13_mass_features-625"><a href="#LCCalculations.find_c13_mass_features-625"><span class="linenos">625</span></a>                    <span class="p">]</span>
</span><span id="LCCalculations.find_c13_mass_features-626"><a href="#LCCalculations.find_c13_mass_features-626"><span class="linenos">626</span></a>                    <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">time_diff</span><span class="p">)]</span>
</span><span id="LCCalculations.find_c13_mass_features-627"><a href="#LCCalculations.find_c13_mass_features-627"><span class="linenos">627</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations.find_c13_mass_features-628"><a href="#LCCalculations.find_c13_mass_features-628"><span class="linenos">628</span></a>                    <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LCCalculations.find_c13_mass_features-629"><a href="#LCCalculations.find_c13_mass_features-629"><span class="linenos">629</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">monoisotopic_mf_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span>
</span><span id="LCCalculations.find_c13_mass_features-630"><a href="#LCCalculations.find_c13_mass_features-630"><span class="linenos">630</span></a>                    <span class="n">parent</span>
</span><span id="LCCalculations.find_c13_mass_features-631"><a href="#LCCalculations.find_c13_mass_features-631"><span class="linenos">631</span></a>                <span class="p">]</span><span class="o">.</span><span class="n">monoisotopic_mf_id</span>
</span><span id="LCCalculations.find_c13_mass_features-632"><a href="#LCCalculations.find_c13_mass_features-632"><span class="linenos">632</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">monoisotopic_mf_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations.find_c13_mass_features-633"><a href="#LCCalculations.find_c13_mass_features-633"><span class="linenos">633</span></a>                    <span class="n">mass_diff</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LCCalculations.find_c13_mass_features-634"><a href="#LCCalculations.find_c13_mass_features-634"><span class="linenos">634</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">mz</span>
</span><span id="LCCalculations.find_c13_mass_features-635"><a href="#LCCalculations.find_c13_mass_features-635"><span class="linenos">635</span></a>                        <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span>
</span><span id="LCCalculations.find_c13_mass_features-636"><a href="#LCCalculations.find_c13_mass_features-636"><span class="linenos">636</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">monoisotopic_mf_id</span>
</span><span id="LCCalculations.find_c13_mass_features-637"><a href="#LCCalculations.find_c13_mass_features-637"><span class="linenos">637</span></a>                        <span class="p">]</span><span class="o">.</span><span class="n">mz</span>
</span><span id="LCCalculations.find_c13_mass_features-638"><a href="#LCCalculations.find_c13_mass_features-638"><span class="linenos">638</span></a>                    <span class="p">)</span>
</span><span id="LCCalculations.find_c13_mass_features-639"><a href="#LCCalculations.find_c13_mass_features-639"><span class="linenos">639</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">iso</span><span class="p">]</span><span class="o">.</span><span class="n">isotopologue_type</span> <span class="o">=</span> <span class="s2">&quot;13C&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="LCCalculations.find_c13_mass_features-640"><a href="#LCCalculations.find_c13_mass_features-640"><span class="linenos">640</span></a>                        <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">mass_diff</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="LCCalculations.find_c13_mass_features-641"><a href="#LCCalculations.find_c13_mass_features-641"><span class="linenos">641</span></a>                    <span class="p">)</span>
</span><span id="LCCalculations.find_c13_mass_features-642"><a href="#LCCalculations.find_c13_mass_features-642"><span class="linenos">642</span></a>
</span><span id="LCCalculations.find_c13_mass_features-643"><a href="#LCCalculations.find_c13_mass_features-643"><span class="linenos">643</span></a>            <span class="c1"># Drop the mono and iso from the pairs_iso_df</span>
</span><span id="LCCalculations.find_c13_mass_features-644"><a href="#LCCalculations.find_c13_mass_features-644"><span class="linenos">644</span></a>            <span class="n">pairs_iso_df</span> <span class="o">=</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
</span><span id="LCCalculations.find_c13_mass_features-645"><a href="#LCCalculations.find_c13_mass_features-645"><span class="linenos">645</span></a>                <span class="n">index</span><span class="o">=</span><span class="n">monos</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
</span><span id="LCCalculations.find_c13_mass_features-646"><a href="#LCCalculations.find_c13_mass_features-646"><span class="linenos">646</span></a>            <span class="p">)</span>  <span class="c1"># Drop pairs where the parent is a child that is a child of a root</span>
</span><span id="LCCalculations.find_c13_mass_features-647"><a href="#LCCalculations.find_c13_mass_features-647"><span class="linenos">647</span></a>            <span class="n">pairs_iso_df</span> <span class="o">=</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;child&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LCCalculations.find_c13_mass_features-648"><a href="#LCCalculations.find_c13_mass_features-648"><span class="linenos">648</span></a>            <span class="n">pairs_iso_df</span> <span class="o">=</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">m1_isos</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="LCCalculations.find_c13_mass_features-649"><a href="#LCCalculations.find_c13_mass_features-649"><span class="linenos">649</span></a>
</span><span id="LCCalculations.find_c13_mass_features-650"><a href="#LCCalculations.find_c13_mass_features-650"><span class="linenos">650</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="LCCalculations.find_c13_mass_features-651"><a href="#LCCalculations.find_c13_mass_features-651"><span class="linenos">651</span></a>                <span class="c1"># Get new monos, recognizing that these are just 13C isotopologues that are connected to other 13C isotopologues to repeat the process</span>
</span><span id="LCCalculations.find_c13_mass_features-652"><a href="#LCCalculations.find_c13_mass_features-652"><span class="linenos">652</span></a>                <span class="n">monos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span>
</span><span id="LCCalculations.find_c13_mass_features-653"><a href="#LCCalculations.find_c13_mass_features-653"><span class="linenos">653</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">parent</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_iso_df</span><span class="o">.</span><span class="n">child</span><span class="p">)</span>
</span><span id="LCCalculations.find_c13_mass_features-654"><a href="#LCCalculations.find_c13_mass_features-654"><span class="linenos">654</span></a>                <span class="p">)</span>
</span><span id="LCCalculations.find_c13_mass_features-655"><a href="#LCCalculations.find_c13_mass_features-655"><span class="linenos">655</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="LCCalculations.find_c13_mass_features-656"><a href="#LCCalculations.find_c13_mass_features-656"><span class="linenos">656</span></a>            <span class="c1"># Report fraction of compounds annotated with isotopes</span>
</span><span id="LCCalculations.find_c13_mass_features-657"><a href="#LCCalculations.find_c13_mass_features-657"><span class="linenos">657</span></a>            <span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;c13_flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="LCCalculations.find_c13_mass_features-658"><a href="#LCCalculations.find_c13_mass_features-658"><span class="linenos">658</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
</span><span id="LCCalculations.find_c13_mass_features-659"><a href="#LCCalculations.find_c13_mass_features-659"><span class="linenos">659</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mf_id&quot;</span><span class="p">],</span> <span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span>
</span><span id="LCCalculations.find_c13_mass_features-660"><a href="#LCCalculations.find_c13_mass_features-660"><span class="linenos">660</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;mf_id&quot;</span><span class="p">],</span> <span class="n">pairs_mf</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span>
</span><span id="LCCalculations.find_c13_mass_features-661"><a href="#LCCalculations.find_c13_mass_features-661"><span class="linenos">661</span></a>                <span class="p">),</span>
</span><span id="LCCalculations.find_c13_mass_features-662"><a href="#LCCalculations.find_c13_mass_features-662"><span class="linenos">662</span></a>                <span class="mi">1</span><span class="p">,</span>
</span><span id="LCCalculations.find_c13_mass_features-663"><a href="#LCCalculations.find_c13_mass_features-663"><span class="linenos">663</span></a>                <span class="mi">0</span><span class="p">,</span>
</span><span id="LCCalculations.find_c13_mass_features-664"><a href="#LCCalculations.find_c13_mass_features-664"><span class="linenos">664</span></a>            <span class="p">)</span>
</span><span id="LCCalculations.find_c13_mass_features-665"><a href="#LCCalculations.find_c13_mass_features-665"><span class="linenos">665</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="LCCalculations.find_c13_mass_features-666"><a href="#LCCalculations.find_c13_mass_features-666"><span class="linenos">666</span></a>                <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf_df</span><span class="p">[</span><span class="n">mf_df</span><span class="p">[</span><span class="s2">&quot;c13_flag&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mf_df</span><span class="p">),</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
</span><span id="LCCalculations.find_c13_mass_features-667"><a href="#LCCalculations.find_c13_mass_features-667"><span class="linenos">667</span></a>                <span class="o">+</span> <span class="s2">&quot; of mass features have or are C13 isotopes&quot;</span>
</span><span id="LCCalculations.find_c13_mass_features-668"><a href="#LCCalculations.find_c13_mass_features-668"><span class="linenos">668</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Mark likely C13 isotopes and connect to monoisoitopic mass features.</p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None, but populates the monoisotopic_mf_id and isotopologue_type attributes to the indivual LCMSMassFeatures within the mass_features attribute of the LCMSBase object.</strong></li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>ValueError</strong>: If no mass features are found.</li>
</ul>
</div>


                            </div>
                            <div id="LCCalculations.deconvolute_ms1_mass_features" class="classattr">
                                        <input id="LCCalculations.deconvolute_ms1_mass_features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">deconvolute_ms1_mass_features</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LCCalculations.deconvolute_ms1_mass_features-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LCCalculations.deconvolute_ms1_mass_features"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LCCalculations.deconvolute_ms1_mass_features-670"><a href="#LCCalculations.deconvolute_ms1_mass_features-670"><span class="linenos">670</span></a>    <span class="k">def</span> <span class="nf">deconvolute_ms1_mass_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-671"><a href="#LCCalculations.deconvolute_ms1_mass_features-671"><span class="linenos">671</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Deconvolute MS1 mass features</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-672"><a href="#LCCalculations.deconvolute_ms1_mass_features-672"><span class="linenos">672</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-673"><a href="#LCCalculations.deconvolute_ms1_mass_features-673"><span class="linenos">673</span></a><span class="sd">        Deconvolute mass features ms1 spectrum based on the correlation of all masses within a spectrum over the EIC of the mass features</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-674"><a href="#LCCalculations.deconvolute_ms1_mass_features-674"><span class="linenos">674</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-675"><a href="#LCCalculations.deconvolute_ms1_mass_features-675"><span class="linenos">675</span></a><span class="sd">        Parameters</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-676"><a href="#LCCalculations.deconvolute_ms1_mass_features-676"><span class="linenos">676</span></a><span class="sd">        ----------</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-677"><a href="#LCCalculations.deconvolute_ms1_mass_features-677"><span class="linenos">677</span></a><span class="sd">        None</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-678"><a href="#LCCalculations.deconvolute_ms1_mass_features-678"><span class="linenos">678</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-679"><a href="#LCCalculations.deconvolute_ms1_mass_features-679"><span class="linenos">679</span></a><span class="sd">        Returns</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-680"><a href="#LCCalculations.deconvolute_ms1_mass_features-680"><span class="linenos">680</span></a><span class="sd">        -------</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-681"><a href="#LCCalculations.deconvolute_ms1_mass_features-681"><span class="linenos">681</span></a><span class="sd">        None, but assigns the _ms_deconvoluted_idx, mass_spectrum_deconvoluted_parent,</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-682"><a href="#LCCalculations.deconvolute_ms1_mass_features-682"><span class="linenos">682</span></a><span class="sd">        and associated_mass_features_deconvoluted attributes to the mass features in the</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-683"><a href="#LCCalculations.deconvolute_ms1_mass_features-683"><span class="linenos">683</span></a><span class="sd">        mass_features attribute of the LCMSBase object.</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-684"><a href="#LCCalculations.deconvolute_ms1_mass_features-684"><span class="linenos">684</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-685"><a href="#LCCalculations.deconvolute_ms1_mass_features-685"><span class="linenos">685</span></a><span class="sd">        Raises</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-686"><a href="#LCCalculations.deconvolute_ms1_mass_features-686"><span class="linenos">686</span></a><span class="sd">        ------</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-687"><a href="#LCCalculations.deconvolute_ms1_mass_features-687"><span class="linenos">687</span></a><span class="sd">        ValueError</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-688"><a href="#LCCalculations.deconvolute_ms1_mass_features-688"><span class="linenos">688</span></a><span class="sd">            If no mass features are found, must run find_mass_features() first.</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-689"><a href="#LCCalculations.deconvolute_ms1_mass_features-689"><span class="linenos">689</span></a><span class="sd">            If no EICs are found, did you run integrate_mass_features() first?</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-690"><a href="#LCCalculations.deconvolute_ms1_mass_features-690"><span class="linenos">690</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-691"><a href="#LCCalculations.deconvolute_ms1_mass_features-691"><span class="linenos">691</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-692"><a href="#LCCalculations.deconvolute_ms1_mass_features-692"><span class="linenos">692</span></a>        <span class="c1"># Checks for set mass_features and eics</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-693"><a href="#LCCalculations.deconvolute_ms1_mass_features-693"><span class="linenos">693</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-694"><a href="#LCCalculations.deconvolute_ms1_mass_features-694"><span class="linenos">694</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-695"><a href="#LCCalculations.deconvolute_ms1_mass_features-695"><span class="linenos">695</span></a>                <span class="s2">&quot;No mass features found, did you run find_mass_features() first?&quot;</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-696"><a href="#LCCalculations.deconvolute_ms1_mass_features-696"><span class="linenos">696</span></a>            <span class="p">)</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-697"><a href="#LCCalculations.deconvolute_ms1_mass_features-697"><span class="linenos">697</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-698"><a href="#LCCalculations.deconvolute_ms1_mass_features-698"><span class="linenos">698</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eics</span> <span class="o">==</span> <span class="p">{}:</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-699"><a href="#LCCalculations.deconvolute_ms1_mass_features-699"><span class="linenos">699</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-700"><a href="#LCCalculations.deconvolute_ms1_mass_features-700"><span class="linenos">700</span></a>                <span class="s2">&quot;No EICs found, did you run integrate_mass_features() first?&quot;</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-701"><a href="#LCCalculations.deconvolute_ms1_mass_features-701"><span class="linenos">701</span></a>            <span class="p">)</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-702"><a href="#LCCalculations.deconvolute_ms1_mass_features-702"><span class="linenos">702</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-703"><a href="#LCCalculations.deconvolute_ms1_mass_features-703"><span class="linenos">703</span></a>        <span class="k">if</span> <span class="mi">1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-704"><a href="#LCCalculations.deconvolute_ms1_mass_features-704"><span class="linenos">704</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No unprocessed MS1 spectra found.&quot;</span><span class="p">)</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-705"><a href="#LCCalculations.deconvolute_ms1_mass_features-705"><span class="linenos">705</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-706"><a href="#LCCalculations.deconvolute_ms1_mass_features-706"><span class="linenos">706</span></a>        <span class="c1"># Prep ms1 data</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-707"><a href="#LCCalculations.deconvolute_ms1_mass_features-707"><span class="linenos">707</span></a>        <span class="n">ms1_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-708"><a href="#LCCalculations.deconvolute_ms1_mass_features-708"><span class="linenos">708</span></a>        <span class="n">ms1_data</span> <span class="o">=</span> <span class="n">ms1_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;scan&quot;</span><span class="p">)</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-709"><a href="#LCCalculations.deconvolute_ms1_mass_features-709"><span class="linenos">709</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-710"><a href="#LCCalculations.deconvolute_ms1_mass_features-710"><span class="linenos">710</span></a>        <span class="c1"># Prep mass feature summary</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-711"><a href="#LCCalculations.deconvolute_ms1_mass_features-711"><span class="linenos">711</span></a>        <span class="n">mass_feature_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-712"><a href="#LCCalculations.deconvolute_ms1_mass_features-712"><span class="linenos">712</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-713"><a href="#LCCalculations.deconvolute_ms1_mass_features-713"><span class="linenos">713</span></a>        <span class="c1"># Loop through each mass feature</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-714"><a href="#LCCalculations.deconvolute_ms1_mass_features-714"><span class="linenos">714</span></a>        <span class="k">for</span> <span class="n">mf_id</span><span class="p">,</span> <span class="n">mass_feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-715"><a href="#LCCalculations.deconvolute_ms1_mass_features-715"><span class="linenos">715</span></a>            <span class="c1"># Check that the mass_feature.mz attribute == the mz of the mass feature in the mass_feature_df</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-716"><a href="#LCCalculations.deconvolute_ms1_mass_features-716"><span class="linenos">716</span></a>            <span class="k">if</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">mz</span> <span class="o">!=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">ms1_peak</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">:</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-717"><a href="#LCCalculations.deconvolute_ms1_mass_features-717"><span class="linenos">717</span></a>                <span class="k">continue</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-718"><a href="#LCCalculations.deconvolute_ms1_mass_features-718"><span class="linenos">718</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-719"><a href="#LCCalculations.deconvolute_ms1_mass_features-719"><span class="linenos">719</span></a>            <span class="c1"># Get the left and right limits of the EIC of the mass feature</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-720"><a href="#LCCalculations.deconvolute_ms1_mass_features-720"><span class="linenos">720</span></a>            <span class="n">l_scan</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">r_scan</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">_eic_data</span><span class="o">.</span><span class="n">apexes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-721"><a href="#LCCalculations.deconvolute_ms1_mass_features-721"><span class="linenos">721</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-722"><a href="#LCCalculations.deconvolute_ms1_mass_features-722"><span class="linenos">722</span></a>            <span class="c1"># Pull from the _ms1_unprocessed data the scan range of interest and sort by mz</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-723"><a href="#LCCalculations.deconvolute_ms1_mass_features-723"><span class="linenos">723</span></a>            <span class="n">ms1_data_sub</span> <span class="o">=</span> <span class="n">ms1_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l_scan</span><span class="p">:</span><span class="n">r_scan</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-724"><a href="#LCCalculations.deconvolute_ms1_mass_features-724"><span class="linenos">724</span></a>            <span class="n">ms1_data_sub</span> <span class="o">=</span> <span class="n">ms1_data_sub</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-725"><a href="#LCCalculations.deconvolute_ms1_mass_features-725"><span class="linenos">725</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-726"><a href="#LCCalculations.deconvolute_ms1_mass_features-726"><span class="linenos">726</span></a>            <span class="c1"># Get the centroided masses of the mass feature</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-727"><a href="#LCCalculations.deconvolute_ms1_mass_features-727"><span class="linenos">727</span></a>            <span class="n">mf_mspeak_mzs</span> <span class="o">=</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="o">.</span><span class="n">mz_exp</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-728"><a href="#LCCalculations.deconvolute_ms1_mass_features-728"><span class="linenos">728</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-729"><a href="#LCCalculations.deconvolute_ms1_mass_features-729"><span class="linenos">729</span></a>            <span class="c1"># Find the closest mz in the ms1 data to the centroided masses of the mass feature</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-730"><a href="#LCCalculations.deconvolute_ms1_mass_features-730"><span class="linenos">730</span></a>            <span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mass_feature_mz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mf_mspeak_mzs</span><span class="p">[</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-731"><a href="#LCCalculations.deconvolute_ms1_mass_features-731"><span class="linenos">731</span></a>                <span class="n">find_closest</span><span class="p">(</span><span class="n">mf_mspeak_mzs</span><span class="p">,</span> <span class="n">ms1_data_sub</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-732"><a href="#LCCalculations.deconvolute_ms1_mass_features-732"><span class="linenos">732</span></a>            <span class="p">]</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-733"><a href="#LCCalculations.deconvolute_ms1_mass_features-733"><span class="linenos">733</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-734"><a href="#LCCalculations.deconvolute_ms1_mass_features-734"><span class="linenos">734</span></a>            <span class="c1"># Drop rows with mz_diff &gt; 0.01 between the mass feature mz and the ms1 data mz</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-735"><a href="#LCCalculations.deconvolute_ms1_mass_features-735"><span class="linenos">735</span></a>            <span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mz_diff_rel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-736"><a href="#LCCalculations.deconvolute_ms1_mass_features-736"><span class="linenos">736</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mass_feature_mz&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-737"><a href="#LCCalculations.deconvolute_ms1_mass_features-737"><span class="linenos">737</span></a>                <span class="o">/</span> <span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-738"><a href="#LCCalculations.deconvolute_ms1_mass_features-738"><span class="linenos">738</span></a>            <span class="p">)</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-739"><a href="#LCCalculations.deconvolute_ms1_mass_features-739"><span class="linenos">739</span></a>            <span class="n">ms1_data_sub</span> <span class="o">=</span> <span class="n">ms1_data_sub</span><span class="p">[</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-740"><a href="#LCCalculations.deconvolute_ms1_mass_features-740"><span class="linenos">740</span></a>                <span class="n">ms1_data_sub</span><span class="p">[</span><span class="s2">&quot;mz_diff_rel&quot;</span><span class="p">]</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-741"><a href="#LCCalculations.deconvolute_ms1_mass_features-741"><span class="linenos">741</span></a>                <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_mz_tolerance_rel</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-742"><a href="#LCCalculations.deconvolute_ms1_mass_features-742"><span class="linenos">742</span></a>            <span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-743"><a href="#LCCalculations.deconvolute_ms1_mass_features-743"><span class="linenos">743</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-744"><a href="#LCCalculations.deconvolute_ms1_mass_features-744"><span class="linenos">744</span></a>            <span class="c1"># Group by mass_feature_mz and scan and sum intensity</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-745"><a href="#LCCalculations.deconvolute_ms1_mass_features-745"><span class="linenos">745</span></a>            <span class="n">ms1_data_sub_group</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-746"><a href="#LCCalculations.deconvolute_ms1_mass_features-746"><span class="linenos">746</span></a>                <span class="n">ms1_data_sub</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;mass_feature_mz&quot;</span><span class="p">,</span> <span class="s2">&quot;scan&quot;</span><span class="p">])[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-747"><a href="#LCCalculations.deconvolute_ms1_mass_features-747"><span class="linenos">747</span></a>                <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-748"><a href="#LCCalculations.deconvolute_ms1_mass_features-748"><span class="linenos">748</span></a>                <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-749"><a href="#LCCalculations.deconvolute_ms1_mass_features-749"><span class="linenos">749</span></a>            <span class="p">)</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-750"><a href="#LCCalculations.deconvolute_ms1_mass_features-750"><span class="linenos">750</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-751"><a href="#LCCalculations.deconvolute_ms1_mass_features-751"><span class="linenos">751</span></a>            <span class="c1"># Calculate the correlation of the intensities of the mass feature and the ms1 data (set to 0 if no intensity)</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-752"><a href="#LCCalculations.deconvolute_ms1_mass_features-752"><span class="linenos">752</span></a>            <span class="n">corr</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-753"><a href="#LCCalculations.deconvolute_ms1_mass_features-753"><span class="linenos">753</span></a>                <span class="n">ms1_data_sub_group</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-754"><a href="#LCCalculations.deconvolute_ms1_mass_features-754"><span class="linenos">754</span></a>                    <span class="n">index</span><span class="o">=</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;mass_feature_mz&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-755"><a href="#LCCalculations.deconvolute_ms1_mass_features-755"><span class="linenos">755</span></a>                <span class="p">)</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-756"><a href="#LCCalculations.deconvolute_ms1_mass_features-756"><span class="linenos">756</span></a>                <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-757"><a href="#LCCalculations.deconvolute_ms1_mass_features-757"><span class="linenos">757</span></a>                <span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-758"><a href="#LCCalculations.deconvolute_ms1_mass_features-758"><span class="linenos">758</span></a>            <span class="p">)</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-759"><a href="#LCCalculations.deconvolute_ms1_mass_features-759"><span class="linenos">759</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-760"><a href="#LCCalculations.deconvolute_ms1_mass_features-760"><span class="linenos">760</span></a>            <span class="c1"># Subset the correlation matrix to only include the masses of the mass feature and those with a correlation &gt; 0.8</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-761"><a href="#LCCalculations.deconvolute_ms1_mass_features-761"><span class="linenos">761</span></a>            <span class="n">decon_corr_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ms1_deconvolution_corr_min</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-762"><a href="#LCCalculations.deconvolute_ms1_mass_features-762"><span class="linenos">762</span></a>            <span class="n">corr_subset</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mass_feature</span><span class="o">.</span><span class="n">mz</span><span class="p">,]</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-763"><a href="#LCCalculations.deconvolute_ms1_mass_features-763"><span class="linenos">763</span></a>            <span class="n">corr_subset</span> <span class="o">=</span> <span class="n">corr_subset</span><span class="p">[</span><span class="n">corr_subset</span> <span class="o">&gt;</span> <span class="n">decon_corr_min</span><span class="p">]</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-764"><a href="#LCCalculations.deconvolute_ms1_mass_features-764"><span class="linenos">764</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-765"><a href="#LCCalculations.deconvolute_ms1_mass_features-765"><span class="linenos">765</span></a>            <span class="c1"># Get the masses from the mass spectrum that are the result of the deconvolution</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-766"><a href="#LCCalculations.deconvolute_ms1_mass_features-766"><span class="linenos">766</span></a>            <span class="n">mzs_decon</span> <span class="o">=</span> <span class="n">corr_subset</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-767"><a href="#LCCalculations.deconvolute_ms1_mass_features-767"><span class="linenos">767</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-768"><a href="#LCCalculations.deconvolute_ms1_mass_features-768"><span class="linenos">768</span></a>            <span class="c1"># Get the indices of the mzs_decon in mass_feature.mass_spectrum.mz_exp and assign to the mass feature</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-769"><a href="#LCCalculations.deconvolute_ms1_mass_features-769"><span class="linenos">769</span></a>            <span class="n">mzs_decon_idx</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-770"><a href="#LCCalculations.deconvolute_ms1_mass_features-770"><span class="linenos">770</span></a>                <span class="nb">id</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-771"><a href="#LCCalculations.deconvolute_ms1_mass_features-771"><span class="linenos">771</span></a>                <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">mz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mass_feature</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="o">.</span><span class="n">mz_exp</span><span class="p">)</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-772"><a href="#LCCalculations.deconvolute_ms1_mass_features-772"><span class="linenos">772</span></a>                <span class="k">if</span> <span class="n">mz</span> <span class="ow">in</span> <span class="n">mzs_decon</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-773"><a href="#LCCalculations.deconvolute_ms1_mass_features-773"><span class="linenos">773</span></a>            <span class="p">]</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-774"><a href="#LCCalculations.deconvolute_ms1_mass_features-774"><span class="linenos">774</span></a>            <span class="n">mass_feature</span><span class="o">.</span><span class="n">_ms_deconvoluted_idx</span> <span class="o">=</span> <span class="n">mzs_decon_idx</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-775"><a href="#LCCalculations.deconvolute_ms1_mass_features-775"><span class="linenos">775</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-776"><a href="#LCCalculations.deconvolute_ms1_mass_features-776"><span class="linenos">776</span></a>            <span class="c1"># Check if the mass feature&#39;s ms1 peak is the largest in the deconvoluted mass spectrum</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-777"><a href="#LCCalculations.deconvolute_ms1_mass_features-777"><span class="linenos">777</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-778"><a href="#LCCalculations.deconvolute_ms1_mass_features-778"><span class="linenos">778</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">ms1_peak</span><span class="o">.</span><span class="n">abundance</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-779"><a href="#LCCalculations.deconvolute_ms1_mass_features-779"><span class="linenos">779</span></a>                <span class="o">==</span> <span class="n">mass_feature</span><span class="o">.</span><span class="n">mass_spectrum</span><span class="o">.</span><span class="n">abundance</span><span class="p">[</span><span class="n">mzs_decon_idx</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-780"><a href="#LCCalculations.deconvolute_ms1_mass_features-780"><span class="linenos">780</span></a>            <span class="p">):</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-781"><a href="#LCCalculations.deconvolute_ms1_mass_features-781"><span class="linenos">781</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">mass_spectrum_deconvoluted_parent</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-782"><a href="#LCCalculations.deconvolute_ms1_mass_features-782"><span class="linenos">782</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-783"><a href="#LCCalculations.deconvolute_ms1_mass_features-783"><span class="linenos">783</span></a>                <span class="n">mass_feature</span><span class="o">.</span><span class="n">mass_spectrum_deconvoluted_parent</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-784"><a href="#LCCalculations.deconvolute_ms1_mass_features-784"><span class="linenos">784</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-785"><a href="#LCCalculations.deconvolute_ms1_mass_features-785"><span class="linenos">785</span></a>            <span class="c1"># Check for other mass features that are in the deconvoluted mass spectrum and add the deconvoluted mass spectrum to the mass feature</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-786"><a href="#LCCalculations.deconvolute_ms1_mass_features-786"><span class="linenos">786</span></a>            <span class="c1"># Subset mass_feature_df to only include mass features that are within the clustering tolerance</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-787"><a href="#LCCalculations.deconvolute_ms1_mass_features-787"><span class="linenos">787</span></a>            <span class="n">mass_feature_df_sub</span> <span class="o">=</span> <span class="n">mass_feature_df</span><span class="p">[</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-788"><a href="#LCCalculations.deconvolute_ms1_mass_features-788"><span class="linenos">788</span></a>                <span class="nb">abs</span><span class="p">(</span><span class="n">mass_feature</span><span class="o">.</span><span class="n">retention_time</span> <span class="o">-</span> <span class="n">mass_feature_df</span><span class="p">[</span><span class="s2">&quot;scan_time&quot;</span><span class="p">])</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-789"><a href="#LCCalculations.deconvolute_ms1_mass_features-789"><span class="linenos">789</span></a>                <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_rt_tolerance</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-790"><a href="#LCCalculations.deconvolute_ms1_mass_features-790"><span class="linenos">790</span></a>            <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-791"><a href="#LCCalculations.deconvolute_ms1_mass_features-791"><span class="linenos">791</span></a>            <span class="c1"># Calculate the mz difference in ppm between the mass feature and the peaks in the deconvoluted mass spectrum</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-792"><a href="#LCCalculations.deconvolute_ms1_mass_features-792"><span class="linenos">792</span></a>            <span class="n">mass_feature_df_sub</span><span class="p">[</span><span class="s2">&quot;mz_diff_ppm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-793"><a href="#LCCalculations.deconvolute_ms1_mass_features-793"><span class="linenos">793</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mzs_decon</span> <span class="o">-</span> <span class="n">mz</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">/</span> <span class="n">mz</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-794"><a href="#LCCalculations.deconvolute_ms1_mass_features-794"><span class="linenos">794</span></a>                <span class="k">for</span> <span class="n">mz</span> <span class="ow">in</span> <span class="n">mass_feature_df_sub</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-795"><a href="#LCCalculations.deconvolute_ms1_mass_features-795"><span class="linenos">795</span></a>            <span class="p">]</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-796"><a href="#LCCalculations.deconvolute_ms1_mass_features-796"><span class="linenos">796</span></a>            <span class="c1"># Subset mass_feature_df to only include mass features that are within 1 ppm of the deconvoluted masses</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-797"><a href="#LCCalculations.deconvolute_ms1_mass_features-797"><span class="linenos">797</span></a>            <span class="n">mfs_associated_decon</span> <span class="o">=</span> <span class="n">mass_feature_df_sub</span><span class="p">[</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-798"><a href="#LCCalculations.deconvolute_ms1_mass_features-798"><span class="linenos">798</span></a>                <span class="n">mass_feature_df_sub</span><span class="p">[</span><span class="s2">&quot;mz_diff_ppm&quot;</span><span class="p">]</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-799"><a href="#LCCalculations.deconvolute_ms1_mass_features-799"><span class="linenos">799</span></a>                <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_mz_tolerance_rel</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-800"><a href="#LCCalculations.deconvolute_ms1_mass_features-800"><span class="linenos">800</span></a>            <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-801"><a href="#LCCalculations.deconvolute_ms1_mass_features-801"><span class="linenos">801</span></a>
</span><span id="LCCalculations.deconvolute_ms1_mass_features-802"><a href="#LCCalculations.deconvolute_ms1_mass_features-802"><span class="linenos">802</span></a>            <span class="n">mass_feature</span><span class="o">.</span><span class="n">associated_mass_features_deconvoluted</span> <span class="o">=</span> <span class="n">mfs_associated_decon</span>
</span></pre></div>


            <div class="docstring"><p>Deconvolute MS1 mass features</p>

<p>Deconvolute mass features ms1 spectrum based on the correlation of all masses within a spectrum over the EIC of the mass features</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>None</strong></li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None, but assigns the _ms_deconvoluted_idx, mass_spectrum_deconvoluted_parent,</strong></li>
<li><strong>and associated_mass_features_deconvoluted attributes to the mass features in the</strong></li>
<li><strong>mass_features attribute of the LCMSBase object.</strong></li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>ValueError</strong>: If no mass features are found, must run find_mass_features() first.
If no EICs are found, did you run integrate_mass_features() first?</li>
</ul>
</div>


                            </div>
                </section>
                <section id="PHCalculations">
                            <input id="PHCalculations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">PHCalculations</span>:

                <label class="view-source-button" for="PHCalculations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PHCalculations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PHCalculations-805"><a href="#PHCalculations-805"><span class="linenos"> 805</span></a><span class="k">class</span> <span class="nc">PHCalculations</span><span class="p">:</span>
</span><span id="PHCalculations-806"><a href="#PHCalculations-806"><span class="linenos"> 806</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Methods for performing calculations related to 2D peak picking via persistent homology on LCMS data.</span>
</span><span id="PHCalculations-807"><a href="#PHCalculations-807"><span class="linenos"> 807</span></a>
</span><span id="PHCalculations-808"><a href="#PHCalculations-808"><span class="linenos"> 808</span></a><span class="sd">    Notes</span>
</span><span id="PHCalculations-809"><a href="#PHCalculations-809"><span class="linenos"> 809</span></a><span class="sd">    -----</span>
</span><span id="PHCalculations-810"><a href="#PHCalculations-810"><span class="linenos"> 810</span></a><span class="sd">    This class is intended to be used as a mixin for the LCMSBase class.</span>
</span><span id="PHCalculations-811"><a href="#PHCalculations-811"><span class="linenos"> 811</span></a>
</span><span id="PHCalculations-812"><a href="#PHCalculations-812"><span class="linenos"> 812</span></a><span class="sd">    Methods</span>
</span><span id="PHCalculations-813"><a href="#PHCalculations-813"><span class="linenos"> 813</span></a><span class="sd">    -------</span>
</span><span id="PHCalculations-814"><a href="#PHCalculations-814"><span class="linenos"> 814</span></a><span class="sd">    * sparse_mean_filter(idx, V, radius=[0, 1, 1]).</span>
</span><span id="PHCalculations-815"><a href="#PHCalculations-815"><span class="linenos"> 815</span></a><span class="sd">        Sparse implementation of a mean filter.</span>
</span><span id="PHCalculations-816"><a href="#PHCalculations-816"><span class="linenos"> 816</span></a><span class="sd">    * embed_unique_indices(a).</span>
</span><span id="PHCalculations-817"><a href="#PHCalculations-817"><span class="linenos"> 817</span></a><span class="sd">        Creates an array of indices, sorted by unique element.</span>
</span><span id="PHCalculations-818"><a href="#PHCalculations-818"><span class="linenos"> 818</span></a><span class="sd">    * sparse_upper_star(idx, V).</span>
</span><span id="PHCalculations-819"><a href="#PHCalculations-819"><span class="linenos"> 819</span></a><span class="sd">        Sparse implementation of an upper star filtration.</span>
</span><span id="PHCalculations-820"><a href="#PHCalculations-820"><span class="linenos"> 820</span></a><span class="sd">    * check_if_grid(data).</span>
</span><span id="PHCalculations-821"><a href="#PHCalculations-821"><span class="linenos"> 821</span></a><span class="sd">        Check if the data is gridded in mz space.</span>
</span><span id="PHCalculations-822"><a href="#PHCalculations-822"><span class="linenos"> 822</span></a><span class="sd">    * grid_data(data).</span>
</span><span id="PHCalculations-823"><a href="#PHCalculations-823"><span class="linenos"> 823</span></a><span class="sd">        Grid the data in the mz dimension.</span>
</span><span id="PHCalculations-824"><a href="#PHCalculations-824"><span class="linenos"> 824</span></a><span class="sd">    * find_mass_features_ph(ms_level=1, grid=True).</span>
</span><span id="PHCalculations-825"><a href="#PHCalculations-825"><span class="linenos"> 825</span></a><span class="sd">        Find mass features within an LCMSBase object using persistent homology.</span>
</span><span id="PHCalculations-826"><a href="#PHCalculations-826"><span class="linenos"> 826</span></a><span class="sd">    * cluster_mass_features(drop_children=True).</span>
</span><span id="PHCalculations-827"><a href="#PHCalculations-827"><span class="linenos"> 827</span></a><span class="sd">        Cluster regions of interest.</span>
</span><span id="PHCalculations-828"><a href="#PHCalculations-828"><span class="linenos"> 828</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PHCalculations-829"><a href="#PHCalculations-829"><span class="linenos"> 829</span></a>
</span><span id="PHCalculations-830"><a href="#PHCalculations-830"><span class="linenos"> 830</span></a>    <span class="nd">@staticmethod</span>
</span><span id="PHCalculations-831"><a href="#PHCalculations-831"><span class="linenos"> 831</span></a>    <span class="k">def</span> <span class="nf">sparse_mean_filter</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
</span><span id="PHCalculations-832"><a href="#PHCalculations-832"><span class="linenos"> 832</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sparse implementation of a mean filter.</span>
</span><span id="PHCalculations-833"><a href="#PHCalculations-833"><span class="linenos"> 833</span></a>
</span><span id="PHCalculations-834"><a href="#PHCalculations-834"><span class="linenos"> 834</span></a><span class="sd">        Parameters</span>
</span><span id="PHCalculations-835"><a href="#PHCalculations-835"><span class="linenos"> 835</span></a><span class="sd">        ----------</span>
</span><span id="PHCalculations-836"><a href="#PHCalculations-836"><span class="linenos"> 836</span></a><span class="sd">        idx : :obj:`~numpy.array`</span>
</span><span id="PHCalculations-837"><a href="#PHCalculations-837"><span class="linenos"> 837</span></a><span class="sd">            Edge indices for each dimension (MxN).</span>
</span><span id="PHCalculations-838"><a href="#PHCalculations-838"><span class="linenos"> 838</span></a><span class="sd">        V : :obj:`~numpy.array`</span>
</span><span id="PHCalculations-839"><a href="#PHCalculations-839"><span class="linenos"> 839</span></a><span class="sd">            Array of intensity data (Mx1).</span>
</span><span id="PHCalculations-840"><a href="#PHCalculations-840"><span class="linenos"> 840</span></a><span class="sd">        radius : float or list</span>
</span><span id="PHCalculations-841"><a href="#PHCalculations-841"><span class="linenos"> 841</span></a><span class="sd">            Radius of the sparse filter in each dimension. Values less than</span>
</span><span id="PHCalculations-842"><a href="#PHCalculations-842"><span class="linenos"> 842</span></a><span class="sd">            zero indicate no connectivity in that dimension.</span>
</span><span id="PHCalculations-843"><a href="#PHCalculations-843"><span class="linenos"> 843</span></a>
</span><span id="PHCalculations-844"><a href="#PHCalculations-844"><span class="linenos"> 844</span></a><span class="sd">        Returns</span>
</span><span id="PHCalculations-845"><a href="#PHCalculations-845"><span class="linenos"> 845</span></a><span class="sd">        -------</span>
</span><span id="PHCalculations-846"><a href="#PHCalculations-846"><span class="linenos"> 846</span></a><span class="sd">        :obj:`~numpy.array`</span>
</span><span id="PHCalculations-847"><a href="#PHCalculations-847"><span class="linenos"> 847</span></a><span class="sd">            Filtered intensities (Mx1).</span>
</span><span id="PHCalculations-848"><a href="#PHCalculations-848"><span class="linenos"> 848</span></a>
</span><span id="PHCalculations-849"><a href="#PHCalculations-849"><span class="linenos"> 849</span></a><span class="sd">        Notes</span>
</span><span id="PHCalculations-850"><a href="#PHCalculations-850"><span class="linenos"> 850</span></a><span class="sd">        -----</span>
</span><span id="PHCalculations-851"><a href="#PHCalculations-851"><span class="linenos"> 851</span></a><span class="sd">        This function has been adapted from the original implementation in the Deimos package: https://github.com/pnnl/deimos.</span>
</span><span id="PHCalculations-852"><a href="#PHCalculations-852"><span class="linenos"> 852</span></a><span class="sd">        This is a static method.</span>
</span><span id="PHCalculations-853"><a href="#PHCalculations-853"><span class="linenos"> 853</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PHCalculations-854"><a href="#PHCalculations-854"><span class="linenos"> 854</span></a>
</span><span id="PHCalculations-855"><a href="#PHCalculations-855"><span class="linenos"> 855</span></a>        <span class="c1"># Copy indices</span>
</span><span id="PHCalculations-856"><a href="#PHCalculations-856"><span class="linenos"> 856</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="PHCalculations-857"><a href="#PHCalculations-857"><span class="linenos"> 857</span></a>
</span><span id="PHCalculations-858"><a href="#PHCalculations-858"><span class="linenos"> 858</span></a>        <span class="c1"># Scale</span>
</span><span id="PHCalculations-859"><a href="#PHCalculations-859"><span class="linenos"> 859</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">radius</span><span class="p">):</span>
</span><span id="PHCalculations-860"><a href="#PHCalculations-860"><span class="linenos"> 860</span></a>            <span class="c1"># Increase inter-index distance</span>
</span><span id="PHCalculations-861"><a href="#PHCalculations-861"><span class="linenos"> 861</span></a>            <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PHCalculations-862"><a href="#PHCalculations-862"><span class="linenos"> 862</span></a>                <span class="n">idx</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span>
</span><span id="PHCalculations-863"><a href="#PHCalculations-863"><span class="linenos"> 863</span></a>
</span><span id="PHCalculations-864"><a href="#PHCalculations-864"><span class="linenos"> 864</span></a>            <span class="c1"># Do nothing</span>
</span><span id="PHCalculations-865"><a href="#PHCalculations-865"><span class="linenos"> 865</span></a>            <span class="k">elif</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PHCalculations-866"><a href="#PHCalculations-866"><span class="linenos"> 866</span></a>                <span class="k">pass</span>
</span><span id="PHCalculations-867"><a href="#PHCalculations-867"><span class="linenos"> 867</span></a>
</span><span id="PHCalculations-868"><a href="#PHCalculations-868"><span class="linenos"> 868</span></a>            <span class="c1"># Decrease inter-index distance</span>
</span><span id="PHCalculations-869"><a href="#PHCalculations-869"><span class="linenos"> 869</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PHCalculations-870"><a href="#PHCalculations-870"><span class="linenos"> 870</span></a>                <span class="n">idx</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">r</span>
</span><span id="PHCalculations-871"><a href="#PHCalculations-871"><span class="linenos"> 871</span></a>
</span><span id="PHCalculations-872"><a href="#PHCalculations-872"><span class="linenos"> 872</span></a>        <span class="c1"># Connectivity matrix</span>
</span><span id="PHCalculations-873"><a href="#PHCalculations-873"><span class="linenos"> 873</span></a>        <span class="n">cmat</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span id="PHCalculations-874"><a href="#PHCalculations-874"><span class="linenos"> 874</span></a>        <span class="n">cmat</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">sparse_distance_matrix</span><span class="p">(</span><span class="n">cmat</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;coo_matrix&quot;</span><span class="p">)</span>
</span><span id="PHCalculations-875"><a href="#PHCalculations-875"><span class="linenos"> 875</span></a>        <span class="n">cmat</span><span class="o">.</span><span class="n">setdiag</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PHCalculations-876"><a href="#PHCalculations-876"><span class="linenos"> 876</span></a>
</span><span id="PHCalculations-877"><a href="#PHCalculations-877"><span class="linenos"> 877</span></a>        <span class="c1"># Pair indices</span>
</span><span id="PHCalculations-878"><a href="#PHCalculations-878"><span class="linenos"> 878</span></a>        <span class="n">I</span><span class="p">,</span> <span class="n">J</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
</span><span id="PHCalculations-879"><a href="#PHCalculations-879"><span class="linenos"> 879</span></a>
</span><span id="PHCalculations-880"><a href="#PHCalculations-880"><span class="linenos"> 880</span></a>        <span class="c1"># Delete cmat</span>
</span><span id="PHCalculations-881"><a href="#PHCalculations-881"><span class="linenos"> 881</span></a>        <span class="n">cmat_shape</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">shape</span>
</span><span id="PHCalculations-882"><a href="#PHCalculations-882"><span class="linenos"> 882</span></a>        <span class="k">del</span> <span class="n">cmat</span>
</span><span id="PHCalculations-883"><a href="#PHCalculations-883"><span class="linenos"> 883</span></a>
</span><span id="PHCalculations-884"><a href="#PHCalculations-884"><span class="linenos"> 884</span></a>        <span class="c1"># Sum over columns</span>
</span><span id="PHCalculations-885"><a href="#PHCalculations-885"><span class="linenos"> 885</span></a>        <span class="n">V_sum</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">bsr_matrix</span><span class="p">(</span>
</span><span id="PHCalculations-886"><a href="#PHCalculations-886"><span class="linenos"> 886</span></a>            <span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">I</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="n">cmat_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">V</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="PHCalculations-887"><a href="#PHCalculations-887"><span class="linenos"> 887</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="PHCalculations-888"><a href="#PHCalculations-888"><span class="linenos"> 888</span></a>
</span><span id="PHCalculations-889"><a href="#PHCalculations-889"><span class="linenos"> 889</span></a>        <span class="c1"># Count over columns</span>
</span><span id="PHCalculations-890"><a href="#PHCalculations-890"><span class="linenos"> 890</span></a>        <span class="n">V_count</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">bsr_matrix</span><span class="p">(</span>
</span><span id="PHCalculations-891"><a href="#PHCalculations-891"><span class="linenos"> 891</span></a>            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">J</span><span class="p">),</span> <span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">I</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="n">cmat_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">V</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="PHCalculations-892"><a href="#PHCalculations-892"><span class="linenos"> 892</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="PHCalculations-893"><a href="#PHCalculations-893"><span class="linenos"> 893</span></a>
</span><span id="PHCalculations-894"><a href="#PHCalculations-894"><span class="linenos"> 894</span></a>        <span class="k">return</span> <span class="n">V_sum</span> <span class="o">/</span> <span class="n">V_count</span>
</span><span id="PHCalculations-895"><a href="#PHCalculations-895"><span class="linenos"> 895</span></a>
</span><span id="PHCalculations-896"><a href="#PHCalculations-896"><span class="linenos"> 896</span></a>    <span class="nd">@staticmethod</span>
</span><span id="PHCalculations-897"><a href="#PHCalculations-897"><span class="linenos"> 897</span></a>    <span class="k">def</span> <span class="nf">embed_unique_indices</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
</span><span id="PHCalculations-898"><a href="#PHCalculations-898"><span class="linenos"> 898</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates an array of indices, sorted by unique element.</span>
</span><span id="PHCalculations-899"><a href="#PHCalculations-899"><span class="linenos"> 899</span></a>
</span><span id="PHCalculations-900"><a href="#PHCalculations-900"><span class="linenos"> 900</span></a><span class="sd">        Parameters</span>
</span><span id="PHCalculations-901"><a href="#PHCalculations-901"><span class="linenos"> 901</span></a><span class="sd">        ----------</span>
</span><span id="PHCalculations-902"><a href="#PHCalculations-902"><span class="linenos"> 902</span></a><span class="sd">        a : :obj:`~numpy.array`</span>
</span><span id="PHCalculations-903"><a href="#PHCalculations-903"><span class="linenos"> 903</span></a><span class="sd">            Array of unique elements (Mx1).</span>
</span><span id="PHCalculations-904"><a href="#PHCalculations-904"><span class="linenos"> 904</span></a>
</span><span id="PHCalculations-905"><a href="#PHCalculations-905"><span class="linenos"> 905</span></a><span class="sd">        Returns</span>
</span><span id="PHCalculations-906"><a href="#PHCalculations-906"><span class="linenos"> 906</span></a><span class="sd">        -------</span>
</span><span id="PHCalculations-907"><a href="#PHCalculations-907"><span class="linenos"> 907</span></a><span class="sd">        :obj:`~numpy.array`</span>
</span><span id="PHCalculations-908"><a href="#PHCalculations-908"><span class="linenos"> 908</span></a><span class="sd">            Array of indices (Mx1).</span>
</span><span id="PHCalculations-909"><a href="#PHCalculations-909"><span class="linenos"> 909</span></a>
</span><span id="PHCalculations-910"><a href="#PHCalculations-910"><span class="linenos"> 910</span></a><span class="sd">        Notes</span>
</span><span id="PHCalculations-911"><a href="#PHCalculations-911"><span class="linenos"> 911</span></a><span class="sd">        -----</span>
</span><span id="PHCalculations-912"><a href="#PHCalculations-912"><span class="linenos"> 912</span></a><span class="sd">        This function has been adapted from the original implementation in the Deimos package: https://github.com/pnnl/deimos</span>
</span><span id="PHCalculations-913"><a href="#PHCalculations-913"><span class="linenos"> 913</span></a><span class="sd">        This is a static method.</span>
</span><span id="PHCalculations-914"><a href="#PHCalculations-914"><span class="linenos"> 914</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PHCalculations-915"><a href="#PHCalculations-915"><span class="linenos"> 915</span></a>
</span><span id="PHCalculations-916"><a href="#PHCalculations-916"><span class="linenos"> 916</span></a>        <span class="k">def</span> <span class="nf">count_tens</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="PHCalculations-917"><a href="#PHCalculations-917"><span class="linenos"> 917</span></a>            <span class="c1"># Count tens</span>
</span><span id="PHCalculations-918"><a href="#PHCalculations-918"><span class="linenos"> 918</span></a>            <span class="n">ntens</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span>
</span><span id="PHCalculations-919"><a href="#PHCalculations-919"><span class="linenos"> 919</span></a>
</span><span id="PHCalculations-920"><a href="#PHCalculations-920"><span class="linenos"> 920</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="PHCalculations-921"><a href="#PHCalculations-921"><span class="linenos"> 921</span></a>                <span class="n">ntens_test</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntens</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span>
</span><span id="PHCalculations-922"><a href="#PHCalculations-922"><span class="linenos"> 922</span></a>
</span><span id="PHCalculations-923"><a href="#PHCalculations-923"><span class="linenos"> 923</span></a>                <span class="k">if</span> <span class="n">ntens_test</span> <span class="o">==</span> <span class="n">ntens</span><span class="p">:</span>
</span><span id="PHCalculations-924"><a href="#PHCalculations-924"><span class="linenos"> 924</span></a>                    <span class="k">return</span> <span class="n">ntens</span>
</span><span id="PHCalculations-925"><a href="#PHCalculations-925"><span class="linenos"> 925</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PHCalculations-926"><a href="#PHCalculations-926"><span class="linenos"> 926</span></a>                    <span class="n">ntens</span> <span class="o">=</span> <span class="n">ntens_test</span>
</span><span id="PHCalculations-927"><a href="#PHCalculations-927"><span class="linenos"> 927</span></a>
</span><span id="PHCalculations-928"><a href="#PHCalculations-928"><span class="linenos"> 928</span></a>        <span class="k">def</span> <span class="nf">arange_exclude_10s</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="PHCalculations-929"><a href="#PHCalculations-929"><span class="linenos"> 929</span></a>            <span class="c1"># How many 10s will there be?</span>
</span><span id="PHCalculations-930"><a href="#PHCalculations-930"><span class="linenos"> 930</span></a>            <span class="n">ntens</span> <span class="o">=</span> <span class="n">count_tens</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="PHCalculations-931"><a href="#PHCalculations-931"><span class="linenos"> 931</span></a>
</span><span id="PHCalculations-932"><a href="#PHCalculations-932"><span class="linenos"> 932</span></a>            <span class="c1"># Base array</span>
</span><span id="PHCalculations-933"><a href="#PHCalculations-933"><span class="linenos"> 933</span></a>            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="n">ntens</span><span class="p">)</span>
</span><span id="PHCalculations-934"><a href="#PHCalculations-934"><span class="linenos"> 934</span></a>
</span><span id="PHCalculations-935"><a href="#PHCalculations-935"><span class="linenos"> 935</span></a>            <span class="c1"># Exclude 10s</span>
</span><span id="PHCalculations-936"><a href="#PHCalculations-936"><span class="linenos"> 936</span></a>            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[(</span><span class="n">arr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">arr</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)][:</span><span class="n">n</span><span class="p">]</span>
</span><span id="PHCalculations-937"><a href="#PHCalculations-937"><span class="linenos"> 937</span></a>
</span><span id="PHCalculations-938"><a href="#PHCalculations-938"><span class="linenos"> 938</span></a>            <span class="k">return</span> <span class="n">arr</span>
</span><span id="PHCalculations-939"><a href="#PHCalculations-939"><span class="linenos"> 939</span></a>
</span><span id="PHCalculations-940"><a href="#PHCalculations-940"><span class="linenos"> 940</span></a>        <span class="c1"># Creates an array of indices, sorted by unique element</span>
</span><span id="PHCalculations-941"><a href="#PHCalculations-941"><span class="linenos"> 941</span></a>        <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span id="PHCalculations-942"><a href="#PHCalculations-942"><span class="linenos"> 942</span></a>        <span class="n">idx_unsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">idx_sort</span><span class="p">)</span>
</span><span id="PHCalculations-943"><a href="#PHCalculations-943"><span class="linenos"> 943</span></a>
</span><span id="PHCalculations-944"><a href="#PHCalculations-944"><span class="linenos"> 944</span></a>        <span class="c1"># Sorts records array so all unique elements are together</span>
</span><span id="PHCalculations-945"><a href="#PHCalculations-945"><span class="linenos"> 945</span></a>        <span class="n">sorted_a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">]</span>
</span><span id="PHCalculations-946"><a href="#PHCalculations-946"><span class="linenos"> 946</span></a>
</span><span id="PHCalculations-947"><a href="#PHCalculations-947"><span class="linenos"> 947</span></a>        <span class="c1"># Returns the unique values, the index of the first occurrence,</span>
</span><span id="PHCalculations-948"><a href="#PHCalculations-948"><span class="linenos"> 948</span></a>        <span class="c1"># and the count for each element</span>
</span><span id="PHCalculations-949"><a href="#PHCalculations-949"><span class="linenos"> 949</span></a>        <span class="n">vals</span><span class="p">,</span> <span class="n">idx_start</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
</span><span id="PHCalculations-950"><a href="#PHCalculations-950"><span class="linenos"> 950</span></a>            <span class="n">sorted_a</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span>
</span><span id="PHCalculations-951"><a href="#PHCalculations-951"><span class="linenos"> 951</span></a>        <span class="p">)</span>
</span><span id="PHCalculations-952"><a href="#PHCalculations-952"><span class="linenos"> 952</span></a>
</span><span id="PHCalculations-953"><a href="#PHCalculations-953"><span class="linenos"> 953</span></a>        <span class="c1"># Splits the indices into separate arrays</span>
</span><span id="PHCalculations-954"><a href="#PHCalculations-954"><span class="linenos"> 954</span></a>        <span class="n">splits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">idx_sort</span><span class="p">,</span> <span class="n">idx_start</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span id="PHCalculations-955"><a href="#PHCalculations-955"><span class="linenos"> 955</span></a>
</span><span id="PHCalculations-956"><a href="#PHCalculations-956"><span class="linenos"> 956</span></a>        <span class="c1"># Creates unique indices for each split</span>
</span><span id="PHCalculations-957"><a href="#PHCalculations-957"><span class="linenos"> 957</span></a>        <span class="n">idx_unq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">arange_exclude_10s</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">])</span>
</span><span id="PHCalculations-958"><a href="#PHCalculations-958"><span class="linenos"> 958</span></a>
</span><span id="PHCalculations-959"><a href="#PHCalculations-959"><span class="linenos"> 959</span></a>        <span class="c1"># Reorders according to input array</span>
</span><span id="PHCalculations-960"><a href="#PHCalculations-960"><span class="linenos"> 960</span></a>        <span class="n">idx_unq</span> <span class="o">=</span> <span class="n">idx_unq</span><span class="p">[</span><span class="n">idx_unsort</span><span class="p">]</span>
</span><span id="PHCalculations-961"><a href="#PHCalculations-961"><span class="linenos"> 961</span></a>
</span><span id="PHCalculations-962"><a href="#PHCalculations-962"><span class="linenos"> 962</span></a>        <span class="c1"># Magnitude of each index</span>
</span><span id="PHCalculations-963"><a href="#PHCalculations-963"><span class="linenos"> 963</span></a>        <span class="n">exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
</span><span id="PHCalculations-964"><a href="#PHCalculations-964"><span class="linenos"> 964</span></a>            <span class="n">idx_unq</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">idx_unq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">idx_unq</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="PHCalculations-965"><a href="#PHCalculations-965"><span class="linenos"> 965</span></a>        <span class="p">)</span>
</span><span id="PHCalculations-966"><a href="#PHCalculations-966"><span class="linenos"> 966</span></a>        <span class="n">idx_unq_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PHCalculations-967"><a href="#PHCalculations-967"><span class="linenos"> 967</span></a>
</span><span id="PHCalculations-968"><a href="#PHCalculations-968"><span class="linenos"> 968</span></a>        <span class="c1"># Result</span>
</span><span id="PHCalculations-969"><a href="#PHCalculations-969"><span class="linenos"> 969</span></a>        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">idx_unq</span> <span class="o">/</span> <span class="n">idx_unq_mag</span>
</span><span id="PHCalculations-970"><a href="#PHCalculations-970"><span class="linenos"> 970</span></a>
</span><span id="PHCalculations-971"><a href="#PHCalculations-971"><span class="linenos"> 971</span></a>    <span class="k">def</span> <span class="nf">sparse_upper_star</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">V</span><span class="p">):</span>
</span><span id="PHCalculations-972"><a href="#PHCalculations-972"><span class="linenos"> 972</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sparse implementation of an upper star filtration.</span>
</span><span id="PHCalculations-973"><a href="#PHCalculations-973"><span class="linenos"> 973</span></a>
</span><span id="PHCalculations-974"><a href="#PHCalculations-974"><span class="linenos"> 974</span></a><span class="sd">        Parameters</span>
</span><span id="PHCalculations-975"><a href="#PHCalculations-975"><span class="linenos"> 975</span></a><span class="sd">        ----------</span>
</span><span id="PHCalculations-976"><a href="#PHCalculations-976"><span class="linenos"> 976</span></a><span class="sd">        idx : :obj:`~numpy.array`</span>
</span><span id="PHCalculations-977"><a href="#PHCalculations-977"><span class="linenos"> 977</span></a><span class="sd">            Edge indices for each dimension (MxN).</span>
</span><span id="PHCalculations-978"><a href="#PHCalculations-978"><span class="linenos"> 978</span></a><span class="sd">        V : :obj:`~numpy.array`</span>
</span><span id="PHCalculations-979"><a href="#PHCalculations-979"><span class="linenos"> 979</span></a><span class="sd">            Array of intensity data (Mx1).</span>
</span><span id="PHCalculations-980"><a href="#PHCalculations-980"><span class="linenos"> 980</span></a><span class="sd">        Returns</span>
</span><span id="PHCalculations-981"><a href="#PHCalculations-981"><span class="linenos"> 981</span></a><span class="sd">        -------</span>
</span><span id="PHCalculations-982"><a href="#PHCalculations-982"><span class="linenos"> 982</span></a><span class="sd">        idx : :obj:`~numpy.array`</span>
</span><span id="PHCalculations-983"><a href="#PHCalculations-983"><span class="linenos"> 983</span></a><span class="sd">            Index of filtered points (Mx1).</span>
</span><span id="PHCalculations-984"><a href="#PHCalculations-984"><span class="linenos"> 984</span></a><span class="sd">        persistence : :obj:`~numpy.array`</span>
</span><span id="PHCalculations-985"><a href="#PHCalculations-985"><span class="linenos"> 985</span></a><span class="sd">            Persistence of each filtered point (Mx1).</span>
</span><span id="PHCalculations-986"><a href="#PHCalculations-986"><span class="linenos"> 986</span></a>
</span><span id="PHCalculations-987"><a href="#PHCalculations-987"><span class="linenos"> 987</span></a><span class="sd">        Notes</span>
</span><span id="PHCalculations-988"><a href="#PHCalculations-988"><span class="linenos"> 988</span></a><span class="sd">        -----</span>
</span><span id="PHCalculations-989"><a href="#PHCalculations-989"><span class="linenos"> 989</span></a><span class="sd">        This function has been adapted from the original implementation in the Deimos package: https://github.com/pnnl/deimos</span>
</span><span id="PHCalculations-990"><a href="#PHCalculations-990"><span class="linenos"> 990</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PHCalculations-991"><a href="#PHCalculations-991"><span class="linenos"> 991</span></a>
</span><span id="PHCalculations-992"><a href="#PHCalculations-992"><span class="linenos"> 992</span></a>        <span class="c1"># Invert</span>
</span><span id="PHCalculations-993"><a href="#PHCalculations-993"><span class="linenos"> 993</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">V</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="PHCalculations-994"><a href="#PHCalculations-994"><span class="linenos"> 994</span></a>
</span><span id="PHCalculations-995"><a href="#PHCalculations-995"><span class="linenos"> 995</span></a>        <span class="c1"># Embed indices</span>
</span><span id="PHCalculations-996"><a href="#PHCalculations-996"><span class="linenos"> 996</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_unique_indices</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
</span><span id="PHCalculations-997"><a href="#PHCalculations-997"><span class="linenos"> 997</span></a>
</span><span id="PHCalculations-998"><a href="#PHCalculations-998"><span class="linenos"> 998</span></a>        <span class="c1"># Connectivity matrix</span>
</span><span id="PHCalculations-999"><a href="#PHCalculations-999"><span class="linenos"> 999</span></a>        <span class="n">cmat</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span id="PHCalculations-1000"><a href="#PHCalculations-1000"><span class="linenos">1000</span></a>        <span class="n">cmat</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">sparse_distance_matrix</span><span class="p">(</span><span class="n">cmat</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;coo_matrix&quot;</span><span class="p">)</span>
</span><span id="PHCalculations-1001"><a href="#PHCalculations-1001"><span class="linenos">1001</span></a>        <span class="n">cmat</span><span class="o">.</span><span class="n">setdiag</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PHCalculations-1002"><a href="#PHCalculations-1002"><span class="linenos">1002</span></a>        <span class="n">cmat</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">cmat</span><span class="p">)</span>
</span><span id="PHCalculations-1003"><a href="#PHCalculations-1003"><span class="linenos">1003</span></a>
</span><span id="PHCalculations-1004"><a href="#PHCalculations-1004"><span class="linenos">1004</span></a>        <span class="c1"># Pairwise minimums</span>
</span><span id="PHCalculations-1005"><a href="#PHCalculations-1005"><span class="linenos">1005</span></a>        <span class="n">I</span><span class="p">,</span> <span class="n">J</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
</span><span id="PHCalculations-1006"><a href="#PHCalculations-1006"><span class="linenos">1006</span></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">V</span><span class="p">[</span><span class="n">J</span><span class="p">])</span>
</span><span id="PHCalculations-1007"><a href="#PHCalculations-1007"><span class="linenos">1007</span></a>
</span><span id="PHCalculations-1008"><a href="#PHCalculations-1008"><span class="linenos">1008</span></a>        <span class="c1"># Delete connectiity matrix</span>
</span><span id="PHCalculations-1009"><a href="#PHCalculations-1009"><span class="linenos">1009</span></a>        <span class="n">cmat_shape</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">shape</span>
</span><span id="PHCalculations-1010"><a href="#PHCalculations-1010"><span class="linenos">1010</span></a>        <span class="k">del</span> <span class="n">cmat</span>
</span><span id="PHCalculations-1011"><a href="#PHCalculations-1011"><span class="linenos">1011</span></a>
</span><span id="PHCalculations-1012"><a href="#PHCalculations-1012"><span class="linenos">1012</span></a>        <span class="c1"># Sparse distance matrix</span>
</span><span id="PHCalculations-1013"><a href="#PHCalculations-1013"><span class="linenos">1013</span></a>        <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="n">cmat_shape</span><span class="p">)</span>
</span><span id="PHCalculations-1014"><a href="#PHCalculations-1014"><span class="linenos">1014</span></a>
</span><span id="PHCalculations-1015"><a href="#PHCalculations-1015"><span class="linenos">1015</span></a>        <span class="c1"># Delete pairwise mins</span>
</span><span id="PHCalculations-1016"><a href="#PHCalculations-1016"><span class="linenos">1016</span></a>        <span class="k">del</span> <span class="n">d</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">J</span>
</span><span id="PHCalculations-1017"><a href="#PHCalculations-1017"><span class="linenos">1017</span></a>
</span><span id="PHCalculations-1018"><a href="#PHCalculations-1018"><span class="linenos">1018</span></a>        <span class="c1"># Persistence homology</span>
</span><span id="PHCalculations-1019"><a href="#PHCalculations-1019"><span class="linenos">1019</span></a>        <span class="n">ph</span> <span class="o">=</span> <span class="n">ripser</span><span class="p">(</span><span class="n">sdm</span><span class="p">,</span> <span class="n">distance_matrix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maxdim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="s2">&quot;dgms&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PHCalculations-1020"><a href="#PHCalculations-1020"><span class="linenos">1020</span></a>
</span><span id="PHCalculations-1021"><a href="#PHCalculations-1021"><span class="linenos">1021</span></a>        <span class="c1"># Bound death values</span>
</span><span id="PHCalculations-1022"><a href="#PHCalculations-1022"><span class="linenos">1022</span></a>        <span class="n">ph</span><span class="p">[</span><span class="n">ph</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
</span><span id="PHCalculations-1023"><a href="#PHCalculations-1023"><span class="linenos">1023</span></a>
</span><span id="PHCalculations-1024"><a href="#PHCalculations-1024"><span class="linenos">1024</span></a>        <span class="c1"># Construct tree to query against</span>
</span><span id="PHCalculations-1025"><a href="#PHCalculations-1025"><span class="linenos">1025</span></a>        <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
</span><span id="PHCalculations-1026"><a href="#PHCalculations-1026"><span class="linenos">1026</span></a>
</span><span id="PHCalculations-1027"><a href="#PHCalculations-1027"><span class="linenos">1027</span></a>        <span class="c1"># Get the indexes of the first nearest neighbor by birth</span>
</span><span id="PHCalculations-1028"><a href="#PHCalculations-1028"><span class="linenos">1028</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">nn</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ph</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">workers</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PHCalculations-1029"><a href="#PHCalculations-1029"><span class="linenos">1029</span></a>
</span><span id="PHCalculations-1030"><a href="#PHCalculations-1030"><span class="linenos">1030</span></a>        <span class="k">return</span> <span class="n">nn</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">ph</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ph</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PHCalculations-1031"><a href="#PHCalculations-1031"><span class="linenos">1031</span></a>
</span><span id="PHCalculations-1032"><a href="#PHCalculations-1032"><span class="linenos">1032</span></a>    <span class="k">def</span> <span class="nf">check_if_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span id="PHCalculations-1033"><a href="#PHCalculations-1033"><span class="linenos">1033</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the data are gridded in mz space.</span>
</span><span id="PHCalculations-1034"><a href="#PHCalculations-1034"><span class="linenos">1034</span></a>
</span><span id="PHCalculations-1035"><a href="#PHCalculations-1035"><span class="linenos">1035</span></a><span class="sd">        Parameters</span>
</span><span id="PHCalculations-1036"><a href="#PHCalculations-1036"><span class="linenos">1036</span></a><span class="sd">        ----------</span>
</span><span id="PHCalculations-1037"><a href="#PHCalculations-1037"><span class="linenos">1037</span></a><span class="sd">        data : DataFrame</span>
</span><span id="PHCalculations-1038"><a href="#PHCalculations-1038"><span class="linenos">1038</span></a><span class="sd">            DataFrame containing the mass spectrometry data.  Needs to have mz and scan columns.</span>
</span><span id="PHCalculations-1039"><a href="#PHCalculations-1039"><span class="linenos">1039</span></a>
</span><span id="PHCalculations-1040"><a href="#PHCalculations-1040"><span class="linenos">1040</span></a><span class="sd">        Returns</span>
</span><span id="PHCalculations-1041"><a href="#PHCalculations-1041"><span class="linenos">1041</span></a><span class="sd">        -------</span>
</span><span id="PHCalculations-1042"><a href="#PHCalculations-1042"><span class="linenos">1042</span></a><span class="sd">        bool</span>
</span><span id="PHCalculations-1043"><a href="#PHCalculations-1043"><span class="linenos">1043</span></a><span class="sd">            True if the data is gridded in the mz direction, False otherwise.</span>
</span><span id="PHCalculations-1044"><a href="#PHCalculations-1044"><span class="linenos">1044</span></a>
</span><span id="PHCalculations-1045"><a href="#PHCalculations-1045"><span class="linenos">1045</span></a><span class="sd">        Notes</span>
</span><span id="PHCalculations-1046"><a href="#PHCalculations-1046"><span class="linenos">1046</span></a><span class="sd">        -----</span>
</span><span id="PHCalculations-1047"><a href="#PHCalculations-1047"><span class="linenos">1047</span></a><span class="sd">        This function is used within the grid_data function and the find_mass_features function and is not intended to be called directly.</span>
</span><span id="PHCalculations-1048"><a href="#PHCalculations-1048"><span class="linenos">1048</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PHCalculations-1049"><a href="#PHCalculations-1049"><span class="linenos">1049</span></a>        <span class="c1"># Calculate the difference between consecutive mz values in a single scan</span>
</span><span id="PHCalculations-1050"><a href="#PHCalculations-1050"><span class="linenos">1050</span></a>        <span class="n">dat_check</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations-1051"><a href="#PHCalculations-1051"><span class="linenos">1051</span></a>        <span class="n">dat_check</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dat_check</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">())</span>
</span><span id="PHCalculations-1052"><a href="#PHCalculations-1052"><span class="linenos">1052</span></a>        <span class="n">mz_diff_min</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="PHCalculations-1053"><a href="#PHCalculations-1053"><span class="linenos">1053</span></a>            <span class="n">dat_check</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;scan&quot;</span><span class="p">)[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="PHCalculations-1054"><a href="#PHCalculations-1054"><span class="linenos">1054</span></a>        <span class="p">)</span>  <span class="c1"># within each scan, what is the smallest mz difference between consecutive mz values</span>
</span><span id="PHCalculations-1055"><a href="#PHCalculations-1055"><span class="linenos">1055</span></a>
</span><span id="PHCalculations-1056"><a href="#PHCalculations-1056"><span class="linenos">1056</span></a>        <span class="c1"># Find the mininum mz difference between mz values in the data; regardless of scan</span>
</span><span id="PHCalculations-1057"><a href="#PHCalculations-1057"><span class="linenos">1057</span></a>        <span class="n">dat_check_mz</span> <span class="o">=</span> <span class="n">dat_check</span><span class="p">[[</span><span class="s2">&quot;mz&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations-1058"><a href="#PHCalculations-1058"><span class="linenos">1058</span></a>        <span class="n">dat_check_mz</span> <span class="o">=</span> <span class="n">dat_check_mz</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations-1059"><a href="#PHCalculations-1059"><span class="linenos">1059</span></a>        <span class="n">dat_check_mz</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dat_check_mz</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">())</span>
</span><span id="PHCalculations-1060"><a href="#PHCalculations-1060"><span class="linenos">1060</span></a>
</span><span id="PHCalculations-1061"><a href="#PHCalculations-1061"><span class="linenos">1061</span></a>        <span class="c1"># Get minimum mz_diff between mz values in the data</span>
</span><span id="PHCalculations-1062"><a href="#PHCalculations-1062"><span class="linenos">1062</span></a>        <span class="n">mz_diff_min_raw</span> <span class="o">=</span> <span class="n">dat_check_mz</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="PHCalculations-1063"><a href="#PHCalculations-1063"><span class="linenos">1063</span></a>
</span><span id="PHCalculations-1064"><a href="#PHCalculations-1064"><span class="linenos">1064</span></a>        <span class="c1"># If the minimum mz difference between mz values in the data is less than the minimum mz difference between mz values within a single scan, then the data is not gridded</span>
</span><span id="PHCalculations-1065"><a href="#PHCalculations-1065"><span class="linenos">1065</span></a>        <span class="k">if</span> <span class="n">mz_diff_min_raw</span> <span class="o">&lt;</span> <span class="n">mz_diff_min</span><span class="p">:</span>
</span><span id="PHCalculations-1066"><a href="#PHCalculations-1066"><span class="linenos">1066</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="PHCalculations-1067"><a href="#PHCalculations-1067"><span class="linenos">1067</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PHCalculations-1068"><a href="#PHCalculations-1068"><span class="linenos">1068</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="PHCalculations-1069"><a href="#PHCalculations-1069"><span class="linenos">1069</span></a>
</span><span id="PHCalculations-1070"><a href="#PHCalculations-1070"><span class="linenos">1070</span></a>    <span class="k">def</span> <span class="nf">grid_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span id="PHCalculations-1071"><a href="#PHCalculations-1071"><span class="linenos">1071</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Grid the data in the mz dimension.</span>
</span><span id="PHCalculations-1072"><a href="#PHCalculations-1072"><span class="linenos">1072</span></a>
</span><span id="PHCalculations-1073"><a href="#PHCalculations-1073"><span class="linenos">1073</span></a><span class="sd">        Data must be gridded prior to persistent homology calculations.</span>
</span><span id="PHCalculations-1074"><a href="#PHCalculations-1074"><span class="linenos">1074</span></a>
</span><span id="PHCalculations-1075"><a href="#PHCalculations-1075"><span class="linenos">1075</span></a><span class="sd">        Parameters</span>
</span><span id="PHCalculations-1076"><a href="#PHCalculations-1076"><span class="linenos">1076</span></a><span class="sd">        ----------</span>
</span><span id="PHCalculations-1077"><a href="#PHCalculations-1077"><span class="linenos">1077</span></a><span class="sd">        data : DataFrame</span>
</span><span id="PHCalculations-1078"><a href="#PHCalculations-1078"><span class="linenos">1078</span></a><span class="sd">            The input data containing mz, scan, scan_time, and intensity columns.</span>
</span><span id="PHCalculations-1079"><a href="#PHCalculations-1079"><span class="linenos">1079</span></a>
</span><span id="PHCalculations-1080"><a href="#PHCalculations-1080"><span class="linenos">1080</span></a><span class="sd">        Returns</span>
</span><span id="PHCalculations-1081"><a href="#PHCalculations-1081"><span class="linenos">1081</span></a><span class="sd">        -------</span>
</span><span id="PHCalculations-1082"><a href="#PHCalculations-1082"><span class="linenos">1082</span></a><span class="sd">        DataFrame</span>
</span><span id="PHCalculations-1083"><a href="#PHCalculations-1083"><span class="linenos">1083</span></a><span class="sd">            The gridded data with mz, scan, scan_time, and intensity columns.</span>
</span><span id="PHCalculations-1084"><a href="#PHCalculations-1084"><span class="linenos">1084</span></a>
</span><span id="PHCalculations-1085"><a href="#PHCalculations-1085"><span class="linenos">1085</span></a><span class="sd">        Raises</span>
</span><span id="PHCalculations-1086"><a href="#PHCalculations-1086"><span class="linenos">1086</span></a><span class="sd">        ------</span>
</span><span id="PHCalculations-1087"><a href="#PHCalculations-1087"><span class="linenos">1087</span></a><span class="sd">        ValueError</span>
</span><span id="PHCalculations-1088"><a href="#PHCalculations-1088"><span class="linenos">1088</span></a><span class="sd">            If gridding fails.</span>
</span><span id="PHCalculations-1089"><a href="#PHCalculations-1089"><span class="linenos">1089</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PHCalculations-1090"><a href="#PHCalculations-1090"><span class="linenos">1090</span></a>
</span><span id="PHCalculations-1091"><a href="#PHCalculations-1091"><span class="linenos">1091</span></a>        <span class="c1"># Calculate the difference between consecutive mz values in a single scan for grid spacing</span>
</span><span id="PHCalculations-1092"><a href="#PHCalculations-1092"><span class="linenos">1092</span></a>        <span class="n">data_w</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations-1093"><a href="#PHCalculations-1093"><span class="linenos">1093</span></a>        <span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">())</span>
</span><span id="PHCalculations-1094"><a href="#PHCalculations-1094"><span class="linenos">1094</span></a>        <span class="n">mz_diff_min</span> <span class="o">=</span> <span class="n">data_w</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;scan&quot;</span><span class="p">)[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.99999</span>
</span><span id="PHCalculations-1095"><a href="#PHCalculations-1095"><span class="linenos">1095</span></a>
</span><span id="PHCalculations-1096"><a href="#PHCalculations-1096"><span class="linenos">1096</span></a>        <span class="c1"># Need high intensity mz values first so they are parents in the output pairs stack</span>
</span><span id="PHCalculations-1097"><a href="#PHCalculations-1097"><span class="linenos">1097</span></a>        <span class="n">dat_mz</span> <span class="o">=</span> <span class="n">data_w</span><span class="p">[[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;intensity&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
</span><span id="PHCalculations-1098"><a href="#PHCalculations-1098"><span class="linenos">1098</span></a>            <span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
</span><span id="PHCalculations-1099"><a href="#PHCalculations-1099"><span class="linenos">1099</span></a>        <span class="p">)</span>
</span><span id="PHCalculations-1100"><a href="#PHCalculations-1100"><span class="linenos">1100</span></a>        <span class="n">dat_mz</span> <span class="o">=</span> <span class="n">dat_mz</span><span class="p">[[</span><span class="s2">&quot;mz&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations-1101"><a href="#PHCalculations-1101"><span class="linenos">1101</span></a>
</span><span id="PHCalculations-1102"><a href="#PHCalculations-1102"><span class="linenos">1102</span></a>        <span class="c1"># Construct KD tree</span>
</span><span id="PHCalculations-1103"><a href="#PHCalculations-1103"><span class="linenos">1103</span></a>        <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">dat_mz</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="PHCalculations-1104"><a href="#PHCalculations-1104"><span class="linenos">1104</span></a>        <span class="n">sdm</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">sparse_distance_matrix</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">mz_diff_min</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;coo_matrix&quot;</span><span class="p">)</span>
</span><span id="PHCalculations-1105"><a href="#PHCalculations-1105"><span class="linenos">1105</span></a>        <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">sdm</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PHCalculations-1106"><a href="#PHCalculations-1106"><span class="linenos">1106</span></a>        <span class="n">sdm</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="PHCalculations-1107"><a href="#PHCalculations-1107"><span class="linenos">1107</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="n">sdm</span><span class="o">.</span><span class="n">tocoo</span><span class="p">()</span>
</span><span id="PHCalculations-1108"><a href="#PHCalculations-1108"><span class="linenos">1108</span></a>        <span class="n">pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">distances</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">distances</span><span class="o">.</span><span class="n">col</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PHCalculations-1109"><a href="#PHCalculations-1109"><span class="linenos">1109</span></a>
</span><span id="PHCalculations-1110"><a href="#PHCalculations-1110"><span class="linenos">1110</span></a>        <span class="c1"># Cull pairs to just get root</span>
</span><span id="PHCalculations-1111"><a href="#PHCalculations-1111"><span class="linenos">1111</span></a>        <span class="n">to_drop</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PHCalculations-1112"><a href="#PHCalculations-1112"><span class="linenos">1112</span></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PHCalculations-1113"><a href="#PHCalculations-1113"><span class="linenos">1113</span></a>            <span class="n">root_parents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
</span><span id="PHCalculations-1114"><a href="#PHCalculations-1114"><span class="linenos">1114</span></a>            <span class="n">id_root_parents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">root_parents</span><span class="p">)</span>
</span><span id="PHCalculations-1115"><a href="#PHCalculations-1115"><span class="linenos">1115</span></a>            <span class="n">children_of_roots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs</span><span class="p">[</span><span class="n">id_root_parents</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="PHCalculations-1116"><a href="#PHCalculations-1116"><span class="linenos">1116</span></a>            <span class="n">to_drop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to_drop</span><span class="p">,</span> <span class="n">children_of_roots</span><span class="p">)</span>
</span><span id="PHCalculations-1117"><a href="#PHCalculations-1117"><span class="linenos">1117</span></a>
</span><span id="PHCalculations-1118"><a href="#PHCalculations-1118"><span class="linenos">1118</span></a>            <span class="c1"># Set up pairs array for next iteration by removing pairs with children or parents already dropped</span>
</span><span id="PHCalculations-1119"><a href="#PHCalculations-1119"><span class="linenos">1119</span></a>            <span class="n">pairs</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">to_drop</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="PHCalculations-1120"><a href="#PHCalculations-1120"><span class="linenos">1120</span></a>            <span class="n">pairs</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">to_drop</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="PHCalculations-1121"><a href="#PHCalculations-1121"><span class="linenos">1121</span></a>        <span class="n">dat_mz</span> <span class="o">=</span> <span class="n">dat_mz</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">to_drop</span><span class="p">))</span>
</span><span id="PHCalculations-1122"><a href="#PHCalculations-1122"><span class="linenos">1122</span></a>        <span class="n">mz_dat_np</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="PHCalculations-1123"><a href="#PHCalculations-1123"><span class="linenos">1123</span></a>            <span class="n">dat_mz</span><span class="p">[[</span><span class="s2">&quot;mz&quot;</span><span class="p">]]</span>
</span><span id="PHCalculations-1124"><a href="#PHCalculations-1124"><span class="linenos">1124</span></a>            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span>
</span><span id="PHCalculations-1125"><a href="#PHCalculations-1125"><span class="linenos">1125</span></a>            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations-1126"><a href="#PHCalculations-1126"><span class="linenos">1126</span></a>            <span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="PHCalculations-1127"><a href="#PHCalculations-1127"><span class="linenos">1127</span></a>        <span class="p">)</span>
</span><span id="PHCalculations-1128"><a href="#PHCalculations-1128"><span class="linenos">1128</span></a>
</span><span id="PHCalculations-1129"><a href="#PHCalculations-1129"><span class="linenos">1129</span></a>        <span class="c1"># Sort data by mz and recast mz to nearest value in mz_dat_np</span>
</span><span id="PHCalculations-1130"><a href="#PHCalculations-1130"><span class="linenos">1130</span></a>        <span class="n">data_w</span> <span class="o">=</span> <span class="n">data_w</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations-1131"><a href="#PHCalculations-1131"><span class="linenos">1131</span></a>        <span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz_new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mz_dat_np</span><span class="p">[</span><span class="n">find_closest</span><span class="p">(</span><span class="n">mz_dat_np</span><span class="p">,</span> <span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>
</span><span id="PHCalculations-1132"><a href="#PHCalculations-1132"><span class="linenos">1132</span></a>        <span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz_new&quot;</span><span class="p">])</span>
</span><span id="PHCalculations-1133"><a href="#PHCalculations-1133"><span class="linenos">1133</span></a>
</span><span id="PHCalculations-1134"><a href="#PHCalculations-1134"><span class="linenos">1134</span></a>        <span class="c1"># Rename mz_new as mz; drop mz_diff; groupby scan and mz and sum intensity</span>
</span><span id="PHCalculations-1135"><a href="#PHCalculations-1135"><span class="linenos">1135</span></a>        <span class="n">new_data_w</span> <span class="o">=</span> <span class="n">data_w</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mz&quot;</span><span class="p">:</span> <span class="s2">&quot;mz_orig&quot;</span><span class="p">,</span> <span class="s2">&quot;mz_new&quot;</span><span class="p">:</span> <span class="s2">&quot;mz&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations-1136"><a href="#PHCalculations-1136"><span class="linenos">1136</span></a>        <span class="n">new_data_w</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="PHCalculations-1137"><a href="#PHCalculations-1137"><span class="linenos">1137</span></a>            <span class="n">new_data_w</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">,</span> <span class="s2">&quot;mz_orig&quot;</span><span class="p">])</span>
</span><span id="PHCalculations-1138"><a href="#PHCalculations-1138"><span class="linenos">1138</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="s2">&quot;mz&quot;</span><span class="p">])[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span>
</span><span id="PHCalculations-1139"><a href="#PHCalculations-1139"><span class="linenos">1139</span></a>            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="PHCalculations-1140"><a href="#PHCalculations-1140"><span class="linenos">1140</span></a>            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="PHCalculations-1141"><a href="#PHCalculations-1141"><span class="linenos">1141</span></a>        <span class="p">)</span>
</span><span id="PHCalculations-1142"><a href="#PHCalculations-1142"><span class="linenos">1142</span></a>        <span class="n">new_data_w</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="PHCalculations-1143"><a href="#PHCalculations-1143"><span class="linenos">1143</span></a>            <span class="n">new_data_w</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="s2">&quot;mz&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>
</span><span id="PHCalculations-1144"><a href="#PHCalculations-1144"><span class="linenos">1144</span></a>            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations-1145"><a href="#PHCalculations-1145"><span class="linenos">1145</span></a>            <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations-1146"><a href="#PHCalculations-1146"><span class="linenos">1146</span></a>        <span class="p">)</span>
</span><span id="PHCalculations-1147"><a href="#PHCalculations-1147"><span class="linenos">1147</span></a>
</span><span id="PHCalculations-1148"><a href="#PHCalculations-1148"><span class="linenos">1148</span></a>        <span class="c1"># Check if grid worked and return</span>
</span><span id="PHCalculations-1149"><a href="#PHCalculations-1149"><span class="linenos">1149</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_grid</span><span class="p">(</span><span class="n">new_data_w</span><span class="p">):</span>
</span><span id="PHCalculations-1150"><a href="#PHCalculations-1150"><span class="linenos">1150</span></a>            <span class="k">return</span> <span class="n">new_data_w</span>
</span><span id="PHCalculations-1151"><a href="#PHCalculations-1151"><span class="linenos">1151</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PHCalculations-1152"><a href="#PHCalculations-1152"><span class="linenos">1152</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Gridding failed&quot;</span><span class="p">)</span>
</span><span id="PHCalculations-1153"><a href="#PHCalculations-1153"><span class="linenos">1153</span></a>
</span><span id="PHCalculations-1154"><a href="#PHCalculations-1154"><span class="linenos">1154</span></a>    <span class="k">def</span> <span class="nf">find_mass_features_ph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="PHCalculations-1155"><a href="#PHCalculations-1155"><span class="linenos">1155</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find mass features within an LCMSBase object using persistent homology.</span>
</span><span id="PHCalculations-1156"><a href="#PHCalculations-1156"><span class="linenos">1156</span></a>
</span><span id="PHCalculations-1157"><a href="#PHCalculations-1157"><span class="linenos">1157</span></a><span class="sd">        Assigns the mass_features attribute to the object (a dictionary of LCMSMassFeature objects, keyed by mass feature id)</span>
</span><span id="PHCalculations-1158"><a href="#PHCalculations-1158"><span class="linenos">1158</span></a>
</span><span id="PHCalculations-1159"><a href="#PHCalculations-1159"><span class="linenos">1159</span></a><span class="sd">        Parameters</span>
</span><span id="PHCalculations-1160"><a href="#PHCalculations-1160"><span class="linenos">1160</span></a><span class="sd">        ----------</span>
</span><span id="PHCalculations-1161"><a href="#PHCalculations-1161"><span class="linenos">1161</span></a><span class="sd">        ms_level : int, optional</span>
</span><span id="PHCalculations-1162"><a href="#PHCalculations-1162"><span class="linenos">1162</span></a><span class="sd">            The MS level to use. Default is 1.</span>
</span><span id="PHCalculations-1163"><a href="#PHCalculations-1163"><span class="linenos">1163</span></a><span class="sd">        grid : bool, optional</span>
</span><span id="PHCalculations-1164"><a href="#PHCalculations-1164"><span class="linenos">1164</span></a><span class="sd">            If True, will regrid the data before running the persistent homology calculations (after checking if the data is gridded). Default is True.</span>
</span><span id="PHCalculations-1165"><a href="#PHCalculations-1165"><span class="linenos">1165</span></a>
</span><span id="PHCalculations-1166"><a href="#PHCalculations-1166"><span class="linenos">1166</span></a><span class="sd">        Raises</span>
</span><span id="PHCalculations-1167"><a href="#PHCalculations-1167"><span class="linenos">1167</span></a><span class="sd">        ------</span>
</span><span id="PHCalculations-1168"><a href="#PHCalculations-1168"><span class="linenos">1168</span></a><span class="sd">        ValueError</span>
</span><span id="PHCalculations-1169"><a href="#PHCalculations-1169"><span class="linenos">1169</span></a><span class="sd">            If no MS level data is found on the object.</span>
</span><span id="PHCalculations-1170"><a href="#PHCalculations-1170"><span class="linenos">1170</span></a><span class="sd">            If data is not gridded and grid is False.</span>
</span><span id="PHCalculations-1171"><a href="#PHCalculations-1171"><span class="linenos">1171</span></a>
</span><span id="PHCalculations-1172"><a href="#PHCalculations-1172"><span class="linenos">1172</span></a><span class="sd">        Returns</span>
</span><span id="PHCalculations-1173"><a href="#PHCalculations-1173"><span class="linenos">1173</span></a><span class="sd">        -------</span>
</span><span id="PHCalculations-1174"><a href="#PHCalculations-1174"><span class="linenos">1174</span></a><span class="sd">        None, but assigns the mass_features attribute to the object.</span>
</span><span id="PHCalculations-1175"><a href="#PHCalculations-1175"><span class="linenos">1175</span></a>
</span><span id="PHCalculations-1176"><a href="#PHCalculations-1176"><span class="linenos">1176</span></a><span class="sd">        Notes</span>
</span><span id="PHCalculations-1177"><a href="#PHCalculations-1177"><span class="linenos">1177</span></a><span class="sd">        -----</span>
</span><span id="PHCalculations-1178"><a href="#PHCalculations-1178"><span class="linenos">1178</span></a><span class="sd">        This function has been adapted from the original implementation in the Deimos package: https://github.com/pnnl/deimos</span>
</span><span id="PHCalculations-1179"><a href="#PHCalculations-1179"><span class="linenos">1179</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PHCalculations-1180"><a href="#PHCalculations-1180"><span class="linenos">1180</span></a>        <span class="c1"># Check that ms_level is a key in self._ms_uprocessed</span>
</span><span id="PHCalculations-1181"><a href="#PHCalculations-1181"><span class="linenos">1181</span></a>        <span class="k">if</span> <span class="n">ms_level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="PHCalculations-1182"><a href="#PHCalculations-1182"><span class="linenos">1182</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PHCalculations-1183"><a href="#PHCalculations-1183"><span class="linenos">1183</span></a>                <span class="s2">&quot;No MS level &quot;</span>
</span><span id="PHCalculations-1184"><a href="#PHCalculations-1184"><span class="linenos">1184</span></a>                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ms_level</span><span class="p">)</span>
</span><span id="PHCalculations-1185"><a href="#PHCalculations-1185"><span class="linenos">1185</span></a>                <span class="o">+</span> <span class="s2">&quot; data found, did you instantiate with parser specific to MS level?&quot;</span>
</span><span id="PHCalculations-1186"><a href="#PHCalculations-1186"><span class="linenos">1186</span></a>            <span class="p">)</span>
</span><span id="PHCalculations-1187"><a href="#PHCalculations-1187"><span class="linenos">1187</span></a>
</span><span id="PHCalculations-1188"><a href="#PHCalculations-1188"><span class="linenos">1188</span></a>        <span class="c1"># Get ms data</span>
</span><span id="PHCalculations-1189"><a href="#PHCalculations-1189"><span class="linenos">1189</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="p">[</span><span class="n">ms_level</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations-1190"><a href="#PHCalculations-1190"><span class="linenos">1190</span></a>
</span><span id="PHCalculations-1191"><a href="#PHCalculations-1191"><span class="linenos">1191</span></a>        <span class="c1"># Drop rows with missing intensity values and reset index</span>
</span><span id="PHCalculations-1192"><a href="#PHCalculations-1192"><span class="linenos">1192</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations-1193"><a href="#PHCalculations-1193"><span class="linenos">1193</span></a>
</span><span id="PHCalculations-1194"><a href="#PHCalculations-1194"><span class="linenos">1194</span></a>        <span class="c1"># Threshold data</span>
</span><span id="PHCalculations-1195"><a href="#PHCalculations-1195"><span class="linenos">1195</span></a>        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]</span>
</span><span id="PHCalculations-1196"><a href="#PHCalculations-1196"><span class="linenos">1196</span></a>        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ph_inten_min_rel</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">intensity</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="PHCalculations-1197"><a href="#PHCalculations-1197"><span class="linenos">1197</span></a>        <span class="n">data_thres</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations-1198"><a href="#PHCalculations-1198"><span class="linenos">1198</span></a>
</span><span id="PHCalculations-1199"><a href="#PHCalculations-1199"><span class="linenos">1199</span></a>        <span class="c1"># Check if gridded, if not, grid</span>
</span><span id="PHCalculations-1200"><a href="#PHCalculations-1200"><span class="linenos">1200</span></a>        <span class="n">gridded_mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_grid</span><span class="p">(</span><span class="n">data_thres</span><span class="p">)</span>
</span><span id="PHCalculations-1201"><a href="#PHCalculations-1201"><span class="linenos">1201</span></a>        <span class="k">if</span> <span class="n">gridded_mz</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="PHCalculations-1202"><a href="#PHCalculations-1202"><span class="linenos">1202</span></a>            <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="PHCalculations-1203"><a href="#PHCalculations-1203"><span class="linenos">1203</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PHCalculations-1204"><a href="#PHCalculations-1204"><span class="linenos">1204</span></a>                    <span class="s2">&quot;Data are not gridded in mz dimension, try reprocessing with a different params or grid data before running this function&quot;</span>
</span><span id="PHCalculations-1205"><a href="#PHCalculations-1205"><span class="linenos">1205</span></a>                <span class="p">)</span>
</span><span id="PHCalculations-1206"><a href="#PHCalculations-1206"><span class="linenos">1206</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PHCalculations-1207"><a href="#PHCalculations-1207"><span class="linenos">1207</span></a>                <span class="n">data_thres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span><span class="p">(</span><span class="n">data_thres</span><span class="p">)</span>
</span><span id="PHCalculations-1208"><a href="#PHCalculations-1208"><span class="linenos">1208</span></a>
</span><span id="PHCalculations-1209"><a href="#PHCalculations-1209"><span class="linenos">1209</span></a>        <span class="c1"># Add build factors and add scan_time</span>
</span><span id="PHCalculations-1210"><a href="#PHCalculations-1210"><span class="linenos">1210</span></a>        <span class="n">data_thres</span> <span class="o">=</span> <span class="n">data_thres</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_df</span><span class="p">[[</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;scan&quot;</span><span class="p">)</span>
</span><span id="PHCalculations-1211"><a href="#PHCalculations-1211"><span class="linenos">1211</span></a>        <span class="n">factors</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="PHCalculations-1212"><a href="#PHCalculations-1212"><span class="linenos">1212</span></a>            <span class="n">dim</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">factorize</span><span class="p">(</span><span class="n">data_thres</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="PHCalculations-1213"><a href="#PHCalculations-1213"><span class="linenos">1213</span></a>            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dims</span>
</span><span id="PHCalculations-1214"><a href="#PHCalculations-1214"><span class="linenos">1214</span></a>        <span class="p">}</span>  <span class="c1"># this is return a float64 index</span>
</span><span id="PHCalculations-1215"><a href="#PHCalculations-1215"><span class="linenos">1215</span></a>
</span><span id="PHCalculations-1216"><a href="#PHCalculations-1216"><span class="linenos">1216</span></a>        <span class="c1"># Build indexes</span>
</span><span id="PHCalculations-1217"><a href="#PHCalculations-1217"><span class="linenos">1217</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="PHCalculations-1218"><a href="#PHCalculations-1218"><span class="linenos">1218</span></a>            <span class="n">dim</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">factors</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="n">data_thres</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="PHCalculations-1219"><a href="#PHCalculations-1219"><span class="linenos">1219</span></a>            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">factors</span>
</span><span id="PHCalculations-1220"><a href="#PHCalculations-1220"><span class="linenos">1220</span></a>        <span class="p">}</span>
</span><span id="PHCalculations-1221"><a href="#PHCalculations-1221"><span class="linenos">1221</span></a>
</span><span id="PHCalculations-1222"><a href="#PHCalculations-1222"><span class="linenos">1222</span></a>        <span class="c1"># Smooth data</span>
</span><span id="PHCalculations-1223"><a href="#PHCalculations-1223"><span class="linenos">1223</span></a>        <span class="n">iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ph_smooth_it</span>
</span><span id="PHCalculations-1224"><a href="#PHCalculations-1224"><span class="linenos">1224</span></a>        <span class="n">smooth_radius</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="PHCalculations-1225"><a href="#PHCalculations-1225"><span class="linenos">1225</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ph_smooth_radius_mz</span><span class="p">,</span>
</span><span id="PHCalculations-1226"><a href="#PHCalculations-1226"><span class="linenos">1226</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ph_smooth_radius_scan</span><span class="p">,</span>
</span><span id="PHCalculations-1227"><a href="#PHCalculations-1227"><span class="linenos">1227</span></a>        <span class="p">]</span>  <span class="c1"># mz, scan_time smoothing radius (in steps)</span>
</span><span id="PHCalculations-1228"><a href="#PHCalculations-1228"><span class="linenos">1228</span></a>
</span><span id="PHCalculations-1229"><a href="#PHCalculations-1229"><span class="linenos">1229</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">index</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="PHCalculations-1230"><a href="#PHCalculations-1230"><span class="linenos">1230</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="n">data_thres</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="PHCalculations-1231"><a href="#PHCalculations-1231"><span class="linenos">1231</span></a>        <span class="n">resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="PHCalculations-1232"><a href="#PHCalculations-1232"><span class="linenos">1232</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
</span><span id="PHCalculations-1233"><a href="#PHCalculations-1233"><span class="linenos">1233</span></a>            <span class="c1"># Previous iteration</span>
</span><span id="PHCalculations-1234"><a href="#PHCalculations-1234"><span class="linenos">1234</span></a>            <span class="n">V_prev</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations-1235"><a href="#PHCalculations-1235"><span class="linenos">1235</span></a>            <span class="n">resid_prev</span> <span class="o">=</span> <span class="n">resid</span>
</span><span id="PHCalculations-1236"><a href="#PHCalculations-1236"><span class="linenos">1236</span></a>            <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_mean_filter</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">smooth_radius</span><span class="p">)</span>
</span><span id="PHCalculations-1237"><a href="#PHCalculations-1237"><span class="linenos">1237</span></a>
</span><span id="PHCalculations-1238"><a href="#PHCalculations-1238"><span class="linenos">1238</span></a>            <span class="c1"># Calculate residual with previous iteration</span>
</span><span id="PHCalculations-1239"><a href="#PHCalculations-1239"><span class="linenos">1239</span></a>            <span class="n">resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">V</span> <span class="o">-</span> <span class="n">V_prev</span><span class="p">)))</span>
</span><span id="PHCalculations-1240"><a href="#PHCalculations-1240"><span class="linenos">1240</span></a>
</span><span id="PHCalculations-1241"><a href="#PHCalculations-1241"><span class="linenos">1241</span></a>            <span class="c1"># Evaluate convergence</span>
</span><span id="PHCalculations-1242"><a href="#PHCalculations-1242"><span class="linenos">1242</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PHCalculations-1243"><a href="#PHCalculations-1243"><span class="linenos">1243</span></a>                <span class="c1"># Percent change in residual</span>
</span><span id="PHCalculations-1244"><a href="#PHCalculations-1244"><span class="linenos">1244</span></a>                <span class="n">test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">resid</span> <span class="o">-</span> <span class="n">resid_prev</span><span class="p">)</span> <span class="o">/</span> <span class="n">resid_prev</span>
</span><span id="PHCalculations-1245"><a href="#PHCalculations-1245"><span class="linenos">1245</span></a>
</span><span id="PHCalculations-1246"><a href="#PHCalculations-1246"><span class="linenos">1246</span></a>                <span class="c1"># Exit criteria</span>
</span><span id="PHCalculations-1247"><a href="#PHCalculations-1247"><span class="linenos">1247</span></a>                <span class="k">if</span> <span class="n">test</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PHCalculations-1248"><a href="#PHCalculations-1248"><span class="linenos">1248</span></a>                    <span class="k">break</span>
</span><span id="PHCalculations-1249"><a href="#PHCalculations-1249"><span class="linenos">1249</span></a>
</span><span id="PHCalculations-1250"><a href="#PHCalculations-1250"><span class="linenos">1250</span></a>        <span class="c1"># Overwrite values</span>
</span><span id="PHCalculations-1251"><a href="#PHCalculations-1251"><span class="linenos">1251</span></a>        <span class="n">data_thres</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">V</span>
</span><span id="PHCalculations-1252"><a href="#PHCalculations-1252"><span class="linenos">1252</span></a>
</span><span id="PHCalculations-1253"><a href="#PHCalculations-1253"><span class="linenos">1253</span></a>        <span class="c1"># Use persistent homology to find regions of interest</span>
</span><span id="PHCalculations-1254"><a href="#PHCalculations-1254"><span class="linenos">1254</span></a>        <span class="n">pidx</span><span class="p">,</span> <span class="n">pers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_upper_star</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
</span><span id="PHCalculations-1255"><a href="#PHCalculations-1255"><span class="linenos">1255</span></a>        <span class="n">pidx</span> <span class="o">=</span> <span class="n">pidx</span><span class="p">[</span><span class="n">pers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="PHCalculations-1256"><a href="#PHCalculations-1256"><span class="linenos">1256</span></a>        <span class="n">pers</span> <span class="o">=</span> <span class="n">pers</span><span class="p">[</span><span class="n">pers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="PHCalculations-1257"><a href="#PHCalculations-1257"><span class="linenos">1257</span></a>
</span><span id="PHCalculations-1258"><a href="#PHCalculations-1258"><span class="linenos">1258</span></a>        <span class="c1"># Get peaks</span>
</span><span id="PHCalculations-1259"><a href="#PHCalculations-1259"><span class="linenos">1259</span></a>        <span class="n">peaks</span> <span class="o">=</span> <span class="n">data_thres</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pidx</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations-1260"><a href="#PHCalculations-1260"><span class="linenos">1260</span></a>
</span><span id="PHCalculations-1261"><a href="#PHCalculations-1261"><span class="linenos">1261</span></a>        <span class="c1"># Add persistence column</span>
</span><span id="PHCalculations-1262"><a href="#PHCalculations-1262"><span class="linenos">1262</span></a>        <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;persistence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pers</span>
</span><span id="PHCalculations-1263"><a href="#PHCalculations-1263"><span class="linenos">1263</span></a>        <span class="n">mass_features</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
</span><span id="PHCalculations-1264"><a href="#PHCalculations-1264"><span class="linenos">1264</span></a>            <span class="n">by</span><span class="o">=</span><span class="s2">&quot;persistence&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
</span><span id="PHCalculations-1265"><a href="#PHCalculations-1265"><span class="linenos">1265</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations-1266"><a href="#PHCalculations-1266"><span class="linenos">1266</span></a>
</span><span id="PHCalculations-1267"><a href="#PHCalculations-1267"><span class="linenos">1267</span></a>        <span class="c1"># Filter by persistence threshold</span>
</span><span id="PHCalculations-1268"><a href="#PHCalculations-1268"><span class="linenos">1268</span></a>        <span class="n">persistence_threshold</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="PHCalculations-1269"><a href="#PHCalculations-1269"><span class="linenos">1269</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ph_persis_min_rel</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">intensity</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="PHCalculations-1270"><a href="#PHCalculations-1270"><span class="linenos">1270</span></a>        <span class="p">)</span>
</span><span id="PHCalculations-1271"><a href="#PHCalculations-1271"><span class="linenos">1271</span></a>        <span class="n">mass_features</span> <span class="o">=</span> <span class="n">mass_features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
</span><span id="PHCalculations-1272"><a href="#PHCalculations-1272"><span class="linenos">1272</span></a>            <span class="n">mass_features</span><span class="p">[</span><span class="s2">&quot;persistence&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">persistence_threshold</span><span class="p">,</span> <span class="p">:</span>
</span><span id="PHCalculations-1273"><a href="#PHCalculations-1273"><span class="linenos">1273</span></a>        <span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations-1274"><a href="#PHCalculations-1274"><span class="linenos">1274</span></a>
</span><span id="PHCalculations-1275"><a href="#PHCalculations-1275"><span class="linenos">1275</span></a>        <span class="c1"># Rename scan column to apex_scan</span>
</span><span id="PHCalculations-1276"><a href="#PHCalculations-1276"><span class="linenos">1276</span></a>        <span class="n">mass_features</span> <span class="o">=</span> <span class="n">mass_features</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
</span><span id="PHCalculations-1277"><a href="#PHCalculations-1277"><span class="linenos">1277</span></a>            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;scan&quot;</span><span class="p">:</span> <span class="s2">&quot;apex_scan&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">:</span> <span class="s2">&quot;retention_time&quot;</span><span class="p">}</span>
</span><span id="PHCalculations-1278"><a href="#PHCalculations-1278"><span class="linenos">1278</span></a>        <span class="p">)</span>
</span><span id="PHCalculations-1279"><a href="#PHCalculations-1279"><span class="linenos">1279</span></a>
</span><span id="PHCalculations-1280"><a href="#PHCalculations-1280"><span class="linenos">1280</span></a>        <span class="c1"># Populate mass_features attribute</span>
</span><span id="PHCalculations-1281"><a href="#PHCalculations-1281"><span class="linenos">1281</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PHCalculations-1282"><a href="#PHCalculations-1282"><span class="linenos">1282</span></a>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">mass_features</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
</span><span id="PHCalculations-1283"><a href="#PHCalculations-1283"><span class="linenos">1283</span></a>            <span class="n">row_dict</span> <span class="o">=</span> <span class="n">mass_features</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</span><span id="PHCalculations-1284"><a href="#PHCalculations-1284"><span class="linenos">1284</span></a>            <span class="n">lcms_feature</span> <span class="o">=</span> <span class="n">LCMSMassFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">row_dict</span><span class="p">)</span>
</span><span id="PHCalculations-1285"><a href="#PHCalculations-1285"><span class="linenos">1285</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">lcms_feature</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">lcms_feature</span>
</span><span id="PHCalculations-1286"><a href="#PHCalculations-1286"><span class="linenos">1286</span></a>
</span><span id="PHCalculations-1287"><a href="#PHCalculations-1287"><span class="linenos">1287</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">verbose_processing</span><span class="p">:</span>
</span><span id="PHCalculations-1288"><a href="#PHCalculations-1288"><span class="linenos">1288</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mass_features</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; initial mass features&quot;</span><span class="p">)</span>
</span><span id="PHCalculations-1289"><a href="#PHCalculations-1289"><span class="linenos">1289</span></a>
</span><span id="PHCalculations-1290"><a href="#PHCalculations-1290"><span class="linenos">1290</span></a>    <span class="k">def</span> <span class="nf">cluster_mass_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drop_children</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="s2">&quot;persistence&quot;</span><span class="p">):</span>
</span><span id="PHCalculations-1291"><a href="#PHCalculations-1291"><span class="linenos">1291</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Cluster mass features</span>
</span><span id="PHCalculations-1292"><a href="#PHCalculations-1292"><span class="linenos">1292</span></a>
</span><span id="PHCalculations-1293"><a href="#PHCalculations-1293"><span class="linenos">1293</span></a><span class="sd">        Based on their proximity in the mz and scan_time dimensions, priorizies the mass features with the highest persistence.</span>
</span><span id="PHCalculations-1294"><a href="#PHCalculations-1294"><span class="linenos">1294</span></a>
</span><span id="PHCalculations-1295"><a href="#PHCalculations-1295"><span class="linenos">1295</span></a><span class="sd">        Parameters</span>
</span><span id="PHCalculations-1296"><a href="#PHCalculations-1296"><span class="linenos">1296</span></a><span class="sd">        ----------</span>
</span><span id="PHCalculations-1297"><a href="#PHCalculations-1297"><span class="linenos">1297</span></a><span class="sd">        drop_children : bool, optional</span>
</span><span id="PHCalculations-1298"><a href="#PHCalculations-1298"><span class="linenos">1298</span></a><span class="sd">            Whether to drop the mass features that are not cluster parents. Default is True.</span>
</span><span id="PHCalculations-1299"><a href="#PHCalculations-1299"><span class="linenos">1299</span></a><span class="sd">        sort_by : str, optional</span>
</span><span id="PHCalculations-1300"><a href="#PHCalculations-1300"><span class="linenos">1300</span></a><span class="sd">            The column to sort the mass features by, this will determine which mass features get rolled up into a parent mass feature. Default is &quot;persistence&quot;.</span>
</span><span id="PHCalculations-1301"><a href="#PHCalculations-1301"><span class="linenos">1301</span></a>
</span><span id="PHCalculations-1302"><a href="#PHCalculations-1302"><span class="linenos">1302</span></a><span class="sd">        Raises</span>
</span><span id="PHCalculations-1303"><a href="#PHCalculations-1303"><span class="linenos">1303</span></a><span class="sd">        ------</span>
</span><span id="PHCalculations-1304"><a href="#PHCalculations-1304"><span class="linenos">1304</span></a><span class="sd">        ValueError</span>
</span><span id="PHCalculations-1305"><a href="#PHCalculations-1305"><span class="linenos">1305</span></a><span class="sd">            If no mass features are found.</span>
</span><span id="PHCalculations-1306"><a href="#PHCalculations-1306"><span class="linenos">1306</span></a><span class="sd">            If too many mass features are found.</span>
</span><span id="PHCalculations-1307"><a href="#PHCalculations-1307"><span class="linenos">1307</span></a>
</span><span id="PHCalculations-1308"><a href="#PHCalculations-1308"><span class="linenos">1308</span></a><span class="sd">        Returns</span>
</span><span id="PHCalculations-1309"><a href="#PHCalculations-1309"><span class="linenos">1309</span></a><span class="sd">        -------</span>
</span><span id="PHCalculations-1310"><a href="#PHCalculations-1310"><span class="linenos">1310</span></a><span class="sd">        None if drop_children is True, otherwise returns a list of mass feature ids that are not cluster parents.</span>
</span><span id="PHCalculations-1311"><a href="#PHCalculations-1311"><span class="linenos">1311</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PHCalculations-1312"><a href="#PHCalculations-1312"><span class="linenos">1312</span></a>        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="PHCalculations-1313"><a href="#PHCalculations-1313"><span class="linenos">1313</span></a>
</span><span id="PHCalculations-1314"><a href="#PHCalculations-1314"><span class="linenos">1314</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PHCalculations-1315"><a href="#PHCalculations-1315"><span class="linenos">1315</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No mass features found, run find_mass_features() first&quot;</span><span class="p">)</span>
</span><span id="PHCalculations-1316"><a href="#PHCalculations-1316"><span class="linenos">1316</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">400000</span><span class="p">:</span>
</span><span id="PHCalculations-1317"><a href="#PHCalculations-1317"><span class="linenos">1317</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PHCalculations-1318"><a href="#PHCalculations-1318"><span class="linenos">1318</span></a>                <span class="s2">&quot;Too many mass featuers of interest found, run find_mass_features() with a higher intensity threshold&quot;</span>
</span><span id="PHCalculations-1319"><a href="#PHCalculations-1319"><span class="linenos">1319</span></a>            <span class="p">)</span>
</span><span id="PHCalculations-1320"><a href="#PHCalculations-1320"><span class="linenos">1320</span></a>        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]</span>
</span><span id="PHCalculations-1321"><a href="#PHCalculations-1321"><span class="linenos">1321</span></a>        <span class="n">mf_df_og</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span>
</span><span id="PHCalculations-1322"><a href="#PHCalculations-1322"><span class="linenos">1322</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df_og</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations-1323"><a href="#PHCalculations-1323"><span class="linenos">1323</span></a>
</span><span id="PHCalculations-1324"><a href="#PHCalculations-1324"><span class="linenos">1324</span></a>        <span class="c1"># Sort mass features by sort_by column, make mf_id its own column for easier bookkeeping</span>
</span><span id="PHCalculations-1325"><a href="#PHCalculations-1325"><span class="linenos">1325</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">sort_by</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PHCalculations-1326"><a href="#PHCalculations-1326"><span class="linenos">1326</span></a>
</span><span id="PHCalculations-1327"><a href="#PHCalculations-1327"><span class="linenos">1327</span></a>        <span class="n">tol</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="PHCalculations-1328"><a href="#PHCalculations-1328"><span class="linenos">1328</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_mz_tolerance_rel</span><span class="p">,</span>
</span><span id="PHCalculations-1329"><a href="#PHCalculations-1329"><span class="linenos">1329</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_rt_tolerance</span><span class="p">,</span>
</span><span id="PHCalculations-1330"><a href="#PHCalculations-1330"><span class="linenos">1330</span></a>        <span class="p">]</span>  <span class="c1"># mz, in relative; scan_time in minutes</span>
</span><span id="PHCalculations-1331"><a href="#PHCalculations-1331"><span class="linenos">1331</span></a>        <span class="n">relative</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
</span><span id="PHCalculations-1332"><a href="#PHCalculations-1332"><span class="linenos">1332</span></a>
</span><span id="PHCalculations-1333"><a href="#PHCalculations-1333"><span class="linenos">1333</span></a>        <span class="c1"># Compute inter-feature distances</span>
</span><span id="PHCalculations-1334"><a href="#PHCalculations-1334"><span class="linenos">1334</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PHCalculations-1335"><a href="#PHCalculations-1335"><span class="linenos">1335</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)):</span>
</span><span id="PHCalculations-1336"><a href="#PHCalculations-1336"><span class="linenos">1336</span></a>            <span class="c1"># Construct k-d tree</span>
</span><span id="PHCalculations-1337"><a href="#PHCalculations-1337"><span class="linenos">1337</span></a>            <span class="n">values</span> <span class="o">=</span> <span class="n">mf_df</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="PHCalculations-1338"><a href="#PHCalculations-1338"><span class="linenos">1338</span></a>            <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="PHCalculations-1339"><a href="#PHCalculations-1339"><span class="linenos">1339</span></a>
</span><span id="PHCalculations-1340"><a href="#PHCalculations-1340"><span class="linenos">1340</span></a>            <span class="n">max_tol</span> <span class="o">=</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="PHCalculations-1341"><a href="#PHCalculations-1341"><span class="linenos">1341</span></a>            <span class="k">if</span> <span class="n">relative</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="PHCalculations-1342"><a href="#PHCalculations-1342"><span class="linenos">1342</span></a>                <span class="c1"># Maximum absolute tolerance</span>
</span><span id="PHCalculations-1343"><a href="#PHCalculations-1343"><span class="linenos">1343</span></a>                <span class="n">max_tol</span> <span class="o">=</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="PHCalculations-1344"><a href="#PHCalculations-1344"><span class="linenos">1344</span></a>
</span><span id="PHCalculations-1345"><a href="#PHCalculations-1345"><span class="linenos">1345</span></a>            <span class="c1"># Compute sparse distance matrix</span>
</span><span id="PHCalculations-1346"><a href="#PHCalculations-1346"><span class="linenos">1346</span></a>            <span class="c1"># the larger the max_tol, the slower this operation is</span>
</span><span id="PHCalculations-1347"><a href="#PHCalculations-1347"><span class="linenos">1347</span></a>            <span class="n">sdm</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">sparse_distance_matrix</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">max_tol</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;coo_matrix&quot;</span><span class="p">)</span>
</span><span id="PHCalculations-1348"><a href="#PHCalculations-1348"><span class="linenos">1348</span></a>
</span><span id="PHCalculations-1349"><a href="#PHCalculations-1349"><span class="linenos">1349</span></a>            <span class="c1"># Only consider forward case, exclude diagonal</span>
</span><span id="PHCalculations-1350"><a href="#PHCalculations-1350"><span class="linenos">1350</span></a>            <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">sdm</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PHCalculations-1351"><a href="#PHCalculations-1351"><span class="linenos">1351</span></a>
</span><span id="PHCalculations-1352"><a href="#PHCalculations-1352"><span class="linenos">1352</span></a>            <span class="c1"># Filter relative distances</span>
</span><span id="PHCalculations-1353"><a href="#PHCalculations-1353"><span class="linenos">1353</span></a>            <span class="k">if</span> <span class="n">relative</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="PHCalculations-1354"><a href="#PHCalculations-1354"><span class="linenos">1354</span></a>                <span class="c1"># Compute relative distances</span>
</span><span id="PHCalculations-1355"><a href="#PHCalculations-1355"><span class="linenos">1355</span></a>                <span class="n">rel_dists</span> <span class="o">=</span> <span class="n">sdm</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="n">values</span><span class="p">[</span><span class="n">sdm</span><span class="o">.</span><span class="n">row</span><span class="p">]</span>  <span class="c1"># or col?</span>
</span><span id="PHCalculations-1356"><a href="#PHCalculations-1356"><span class="linenos">1356</span></a>
</span><span id="PHCalculations-1357"><a href="#PHCalculations-1357"><span class="linenos">1357</span></a>                <span class="c1"># Indices of relative distances less than tolerance</span>
</span><span id="PHCalculations-1358"><a href="#PHCalculations-1358"><span class="linenos">1358</span></a>                <span class="n">idx</span> <span class="o">=</span> <span class="n">rel_dists</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="PHCalculations-1359"><a href="#PHCalculations-1359"><span class="linenos">1359</span></a>
</span><span id="PHCalculations-1360"><a href="#PHCalculations-1360"><span class="linenos">1360</span></a>                <span class="c1"># Reconstruct sparse distance matrix</span>
</span><span id="PHCalculations-1361"><a href="#PHCalculations-1361"><span class="linenos">1361</span></a>                <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">(</span>
</span><span id="PHCalculations-1362"><a href="#PHCalculations-1362"><span class="linenos">1362</span></a>                    <span class="p">(</span><span class="n">rel_dists</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">sdm</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">idx</span><span class="p">])),</span>
</span><span id="PHCalculations-1363"><a href="#PHCalculations-1363"><span class="linenos">1363</span></a>                    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
</span><span id="PHCalculations-1364"><a href="#PHCalculations-1364"><span class="linenos">1364</span></a>                <span class="p">)</span>
</span><span id="PHCalculations-1365"><a href="#PHCalculations-1365"><span class="linenos">1365</span></a>
</span><span id="PHCalculations-1366"><a href="#PHCalculations-1366"><span class="linenos">1366</span></a>            <span class="c1"># Cast as binary matrix</span>
</span><span id="PHCalculations-1367"><a href="#PHCalculations-1367"><span class="linenos">1367</span></a>            <span class="n">sdm</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="PHCalculations-1368"><a href="#PHCalculations-1368"><span class="linenos">1368</span></a>
</span><span id="PHCalculations-1369"><a href="#PHCalculations-1369"><span class="linenos">1369</span></a>            <span class="c1"># Stack distances</span>
</span><span id="PHCalculations-1370"><a href="#PHCalculations-1370"><span class="linenos">1370</span></a>            <span class="k">if</span> <span class="n">distances</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PHCalculations-1371"><a href="#PHCalculations-1371"><span class="linenos">1371</span></a>                <span class="n">distances</span> <span class="o">=</span> <span class="n">sdm</span>
</span><span id="PHCalculations-1372"><a href="#PHCalculations-1372"><span class="linenos">1372</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PHCalculations-1373"><a href="#PHCalculations-1373"><span class="linenos">1373</span></a>                <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sdm</span><span class="p">)</span>
</span><span id="PHCalculations-1374"><a href="#PHCalculations-1374"><span class="linenos">1374</span></a>
</span><span id="PHCalculations-1375"><a href="#PHCalculations-1375"><span class="linenos">1375</span></a>        <span class="c1"># Extract indices of within-tolerance points</span>
</span><span id="PHCalculations-1376"><a href="#PHCalculations-1376"><span class="linenos">1376</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">tocoo</span><span class="p">()</span>
</span><span id="PHCalculations-1377"><a href="#PHCalculations-1377"><span class="linenos">1377</span></a>        <span class="n">pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">distances</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">distances</span><span class="o">.</span><span class="n">col</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PHCalculations-1378"><a href="#PHCalculations-1378"><span class="linenos">1378</span></a>        <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;parent&quot;</span><span class="p">,</span> <span class="s2">&quot;child&quot;</span><span class="p">])</span>
</span><span id="PHCalculations-1379"><a href="#PHCalculations-1379"><span class="linenos">1379</span></a>        <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">)</span>
</span><span id="PHCalculations-1380"><a href="#PHCalculations-1380"><span class="linenos">1380</span></a>
</span><span id="PHCalculations-1381"><a href="#PHCalculations-1381"><span class="linenos">1381</span></a>        <span class="n">to_drop</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PHCalculations-1382"><a href="#PHCalculations-1382"><span class="linenos">1382</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="PHCalculations-1383"><a href="#PHCalculations-1383"><span class="linenos">1383</span></a>            <span class="c1"># Find root_parents and their children</span>
</span><span id="PHCalculations-1384"><a href="#PHCalculations-1384"><span class="linenos">1384</span></a>            <span class="n">root_parents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span>
</span><span id="PHCalculations-1385"><a href="#PHCalculations-1385"><span class="linenos">1385</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_df</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="PHCalculations-1386"><a href="#PHCalculations-1386"><span class="linenos">1386</span></a>            <span class="p">)</span>
</span><span id="PHCalculations-1387"><a href="#PHCalculations-1387"><span class="linenos">1387</span></a>            <span class="n">children_of_roots</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">root_parents</span><span class="p">,</span> <span class="s2">&quot;child&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="PHCalculations-1388"><a href="#PHCalculations-1388"><span class="linenos">1388</span></a>            <span class="n">to_drop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to_drop</span><span class="p">,</span> <span class="n">children_of_roots</span><span class="p">)</span>
</span><span id="PHCalculations-1389"><a href="#PHCalculations-1389"><span class="linenos">1389</span></a>
</span><span id="PHCalculations-1390"><a href="#PHCalculations-1390"><span class="linenos">1390</span></a>            <span class="c1"># Remove root_children as possible parents from pairs_df for next iteration</span>
</span><span id="PHCalculations-1391"><a href="#PHCalculations-1391"><span class="linenos">1391</span></a>            <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">children_of_roots</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="PHCalculations-1392"><a href="#PHCalculations-1392"><span class="linenos">1392</span></a>            <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;child&quot;</span><span class="p">)</span>
</span><span id="PHCalculations-1393"><a href="#PHCalculations-1393"><span class="linenos">1393</span></a>            <span class="c1"># Remove root_children as possible children from pairs_df for next iteration</span>
</span><span id="PHCalculations-1394"><a href="#PHCalculations-1394"><span class="linenos">1394</span></a>            <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">children_of_roots</span><span class="p">)</span>
</span><span id="PHCalculations-1395"><a href="#PHCalculations-1395"><span class="linenos">1395</span></a>
</span><span id="PHCalculations-1396"><a href="#PHCalculations-1396"><span class="linenos">1396</span></a>            <span class="c1"># Prepare for next iteration</span>
</span><span id="PHCalculations-1397"><a href="#PHCalculations-1397"><span class="linenos">1397</span></a>            <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">)</span>
</span><span id="PHCalculations-1398"><a href="#PHCalculations-1398"><span class="linenos">1398</span></a>
</span><span id="PHCalculations-1399"><a href="#PHCalculations-1399"><span class="linenos">1399</span></a>        <span class="c1"># Drop mass features that are not cluster parents</span>
</span><span id="PHCalculations-1400"><a href="#PHCalculations-1400"><span class="linenos">1400</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">to_drop</span><span class="p">))</span>
</span><span id="PHCalculations-1401"><a href="#PHCalculations-1401"><span class="linenos">1401</span></a>
</span><span id="PHCalculations-1402"><a href="#PHCalculations-1402"><span class="linenos">1402</span></a>        <span class="c1"># Set index back to mf_id</span>
</span><span id="PHCalculations-1403"><a href="#PHCalculations-1403"><span class="linenos">1403</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;mf_id&quot;</span><span class="p">)</span>
</span><span id="PHCalculations-1404"><a href="#PHCalculations-1404"><span class="linenos">1404</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="PHCalculations-1405"><a href="#PHCalculations-1405"><span class="linenos">1405</span></a>            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf_df</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; mass features remaining&quot;</span><span class="p">)</span>
</span><span id="PHCalculations-1406"><a href="#PHCalculations-1406"><span class="linenos">1406</span></a>
</span><span id="PHCalculations-1407"><a href="#PHCalculations-1407"><span class="linenos">1407</span></a>        <span class="n">mf_df_new</span> <span class="o">=</span> <span class="n">mf_df_og</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations-1408"><a href="#PHCalculations-1408"><span class="linenos">1408</span></a>        <span class="n">mf_df_new</span><span class="p">[</span><span class="s2">&quot;cluster_parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="PHCalculations-1409"><a href="#PHCalculations-1409"><span class="linenos">1409</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mf_df_new</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="PHCalculations-1410"><a href="#PHCalculations-1410"><span class="linenos">1410</span></a>        <span class="p">)</span>
</span><span id="PHCalculations-1411"><a href="#PHCalculations-1411"><span class="linenos">1411</span></a>
</span><span id="PHCalculations-1412"><a href="#PHCalculations-1412"><span class="linenos">1412</span></a>        <span class="c1"># get mass feature ids of features that are not cluster parents</span>
</span><span id="PHCalculations-1413"><a href="#PHCalculations-1413"><span class="linenos">1413</span></a>        <span class="n">cluster_daughters</span> <span class="o">=</span> <span class="n">mf_df_new</span><span class="p">[</span><span class="n">mf_df_new</span><span class="p">[</span><span class="s2">&quot;cluster_parent&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="PHCalculations-1414"><a href="#PHCalculations-1414"><span class="linenos">1414</span></a>        <span class="k">if</span> <span class="n">drop_children</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="PHCalculations-1415"><a href="#PHCalculations-1415"><span class="linenos">1415</span></a>            <span class="c1"># Drop mass features that are not cluster parents from self</span>
</span><span id="PHCalculations-1416"><a href="#PHCalculations-1416"><span class="linenos">1416</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="PHCalculations-1417"><a href="#PHCalculations-1417"><span class="linenos">1417</span></a>                <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
</span><span id="PHCalculations-1418"><a href="#PHCalculations-1418"><span class="linenos">1418</span></a>                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="PHCalculations-1419"><a href="#PHCalculations-1419"><span class="linenos">1419</span></a>                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cluster_daughters</span>
</span><span id="PHCalculations-1420"><a href="#PHCalculations-1420"><span class="linenos">1420</span></a>            <span class="p">}</span>
</span><span id="PHCalculations-1421"><a href="#PHCalculations-1421"><span class="linenos">1421</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PHCalculations-1422"><a href="#PHCalculations-1422"><span class="linenos">1422</span></a>            <span class="k">return</span> <span class="n">cluster_daughters</span>
</span></pre></div>


            <div class="docstring"><p>Methods for performing calculations related to 2D peak picking via persistent homology on LCMS data.</p>

<h6 id="notes">Notes</h6>

<p>This class is intended to be used as a mixin for the LCMSBase class.</p>

<h6 id="methods">Methods</h6>

<ul>
<li>sparse_mean_filter(idx, V, radius=[0, 1, 1]).
Sparse implementation of a mean filter.</li>
<li>embed_unique_indices(a).
Creates an array of indices, sorted by unique element.</li>
<li>sparse_upper_star(idx, V).
Sparse implementation of an upper star filtration.</li>
<li>check_if_grid(data).
Check if the data is gridded in mz space.</li>
<li>grid_data(data).
Grid the data in the mz dimension.</li>
<li>find_mass_features_ph(ms_level=1, grid=True).
Find mass features within an LCMSBase object using persistent homology.</li>
<li>cluster_mass_features(drop_children=True).
Cluster regions of interest.</li>
</ul>
</div>


                            <div id="PHCalculations.sparse_mean_filter" class="classattr">
                                        <input id="PHCalculations.sparse_mean_filter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">sparse_mean_filter</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">idx</span>, </span><span class="param"><span class="n">V</span>, </span><span class="param"><span class="n">radius</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PHCalculations.sparse_mean_filter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PHCalculations.sparse_mean_filter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PHCalculations.sparse_mean_filter-830"><a href="#PHCalculations.sparse_mean_filter-830"><span class="linenos">830</span></a>    <span class="nd">@staticmethod</span>
</span><span id="PHCalculations.sparse_mean_filter-831"><a href="#PHCalculations.sparse_mean_filter-831"><span class="linenos">831</span></a>    <span class="k">def</span> <span class="nf">sparse_mean_filter</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
</span><span id="PHCalculations.sparse_mean_filter-832"><a href="#PHCalculations.sparse_mean_filter-832"><span class="linenos">832</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sparse implementation of a mean filter.</span>
</span><span id="PHCalculations.sparse_mean_filter-833"><a href="#PHCalculations.sparse_mean_filter-833"><span class="linenos">833</span></a>
</span><span id="PHCalculations.sparse_mean_filter-834"><a href="#PHCalculations.sparse_mean_filter-834"><span class="linenos">834</span></a><span class="sd">        Parameters</span>
</span><span id="PHCalculations.sparse_mean_filter-835"><a href="#PHCalculations.sparse_mean_filter-835"><span class="linenos">835</span></a><span class="sd">        ----------</span>
</span><span id="PHCalculations.sparse_mean_filter-836"><a href="#PHCalculations.sparse_mean_filter-836"><span class="linenos">836</span></a><span class="sd">        idx : :obj:`~numpy.array`</span>
</span><span id="PHCalculations.sparse_mean_filter-837"><a href="#PHCalculations.sparse_mean_filter-837"><span class="linenos">837</span></a><span class="sd">            Edge indices for each dimension (MxN).</span>
</span><span id="PHCalculations.sparse_mean_filter-838"><a href="#PHCalculations.sparse_mean_filter-838"><span class="linenos">838</span></a><span class="sd">        V : :obj:`~numpy.array`</span>
</span><span id="PHCalculations.sparse_mean_filter-839"><a href="#PHCalculations.sparse_mean_filter-839"><span class="linenos">839</span></a><span class="sd">            Array of intensity data (Mx1).</span>
</span><span id="PHCalculations.sparse_mean_filter-840"><a href="#PHCalculations.sparse_mean_filter-840"><span class="linenos">840</span></a><span class="sd">        radius : float or list</span>
</span><span id="PHCalculations.sparse_mean_filter-841"><a href="#PHCalculations.sparse_mean_filter-841"><span class="linenos">841</span></a><span class="sd">            Radius of the sparse filter in each dimension. Values less than</span>
</span><span id="PHCalculations.sparse_mean_filter-842"><a href="#PHCalculations.sparse_mean_filter-842"><span class="linenos">842</span></a><span class="sd">            zero indicate no connectivity in that dimension.</span>
</span><span id="PHCalculations.sparse_mean_filter-843"><a href="#PHCalculations.sparse_mean_filter-843"><span class="linenos">843</span></a>
</span><span id="PHCalculations.sparse_mean_filter-844"><a href="#PHCalculations.sparse_mean_filter-844"><span class="linenos">844</span></a><span class="sd">        Returns</span>
</span><span id="PHCalculations.sparse_mean_filter-845"><a href="#PHCalculations.sparse_mean_filter-845"><span class="linenos">845</span></a><span class="sd">        -------</span>
</span><span id="PHCalculations.sparse_mean_filter-846"><a href="#PHCalculations.sparse_mean_filter-846"><span class="linenos">846</span></a><span class="sd">        :obj:`~numpy.array`</span>
</span><span id="PHCalculations.sparse_mean_filter-847"><a href="#PHCalculations.sparse_mean_filter-847"><span class="linenos">847</span></a><span class="sd">            Filtered intensities (Mx1).</span>
</span><span id="PHCalculations.sparse_mean_filter-848"><a href="#PHCalculations.sparse_mean_filter-848"><span class="linenos">848</span></a>
</span><span id="PHCalculations.sparse_mean_filter-849"><a href="#PHCalculations.sparse_mean_filter-849"><span class="linenos">849</span></a><span class="sd">        Notes</span>
</span><span id="PHCalculations.sparse_mean_filter-850"><a href="#PHCalculations.sparse_mean_filter-850"><span class="linenos">850</span></a><span class="sd">        -----</span>
</span><span id="PHCalculations.sparse_mean_filter-851"><a href="#PHCalculations.sparse_mean_filter-851"><span class="linenos">851</span></a><span class="sd">        This function has been adapted from the original implementation in the Deimos package: https://github.com/pnnl/deimos.</span>
</span><span id="PHCalculations.sparse_mean_filter-852"><a href="#PHCalculations.sparse_mean_filter-852"><span class="linenos">852</span></a><span class="sd">        This is a static method.</span>
</span><span id="PHCalculations.sparse_mean_filter-853"><a href="#PHCalculations.sparse_mean_filter-853"><span class="linenos">853</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PHCalculations.sparse_mean_filter-854"><a href="#PHCalculations.sparse_mean_filter-854"><span class="linenos">854</span></a>
</span><span id="PHCalculations.sparse_mean_filter-855"><a href="#PHCalculations.sparse_mean_filter-855"><span class="linenos">855</span></a>        <span class="c1"># Copy indices</span>
</span><span id="PHCalculations.sparse_mean_filter-856"><a href="#PHCalculations.sparse_mean_filter-856"><span class="linenos">856</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
</span><span id="PHCalculations.sparse_mean_filter-857"><a href="#PHCalculations.sparse_mean_filter-857"><span class="linenos">857</span></a>
</span><span id="PHCalculations.sparse_mean_filter-858"><a href="#PHCalculations.sparse_mean_filter-858"><span class="linenos">858</span></a>        <span class="c1"># Scale</span>
</span><span id="PHCalculations.sparse_mean_filter-859"><a href="#PHCalculations.sparse_mean_filter-859"><span class="linenos">859</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">radius</span><span class="p">):</span>
</span><span id="PHCalculations.sparse_mean_filter-860"><a href="#PHCalculations.sparse_mean_filter-860"><span class="linenos">860</span></a>            <span class="c1"># Increase inter-index distance</span>
</span><span id="PHCalculations.sparse_mean_filter-861"><a href="#PHCalculations.sparse_mean_filter-861"><span class="linenos">861</span></a>            <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PHCalculations.sparse_mean_filter-862"><a href="#PHCalculations.sparse_mean_filter-862"><span class="linenos">862</span></a>                <span class="n">idx</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span>
</span><span id="PHCalculations.sparse_mean_filter-863"><a href="#PHCalculations.sparse_mean_filter-863"><span class="linenos">863</span></a>
</span><span id="PHCalculations.sparse_mean_filter-864"><a href="#PHCalculations.sparse_mean_filter-864"><span class="linenos">864</span></a>            <span class="c1"># Do nothing</span>
</span><span id="PHCalculations.sparse_mean_filter-865"><a href="#PHCalculations.sparse_mean_filter-865"><span class="linenos">865</span></a>            <span class="k">elif</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="PHCalculations.sparse_mean_filter-866"><a href="#PHCalculations.sparse_mean_filter-866"><span class="linenos">866</span></a>                <span class="k">pass</span>
</span><span id="PHCalculations.sparse_mean_filter-867"><a href="#PHCalculations.sparse_mean_filter-867"><span class="linenos">867</span></a>
</span><span id="PHCalculations.sparse_mean_filter-868"><a href="#PHCalculations.sparse_mean_filter-868"><span class="linenos">868</span></a>            <span class="c1"># Decrease inter-index distance</span>
</span><span id="PHCalculations.sparse_mean_filter-869"><a href="#PHCalculations.sparse_mean_filter-869"><span class="linenos">869</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PHCalculations.sparse_mean_filter-870"><a href="#PHCalculations.sparse_mean_filter-870"><span class="linenos">870</span></a>                <span class="n">idx</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">r</span>
</span><span id="PHCalculations.sparse_mean_filter-871"><a href="#PHCalculations.sparse_mean_filter-871"><span class="linenos">871</span></a>
</span><span id="PHCalculations.sparse_mean_filter-872"><a href="#PHCalculations.sparse_mean_filter-872"><span class="linenos">872</span></a>        <span class="c1"># Connectivity matrix</span>
</span><span id="PHCalculations.sparse_mean_filter-873"><a href="#PHCalculations.sparse_mean_filter-873"><span class="linenos">873</span></a>        <span class="n">cmat</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span id="PHCalculations.sparse_mean_filter-874"><a href="#PHCalculations.sparse_mean_filter-874"><span class="linenos">874</span></a>        <span class="n">cmat</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">sparse_distance_matrix</span><span class="p">(</span><span class="n">cmat</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;coo_matrix&quot;</span><span class="p">)</span>
</span><span id="PHCalculations.sparse_mean_filter-875"><a href="#PHCalculations.sparse_mean_filter-875"><span class="linenos">875</span></a>        <span class="n">cmat</span><span class="o">.</span><span class="n">setdiag</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PHCalculations.sparse_mean_filter-876"><a href="#PHCalculations.sparse_mean_filter-876"><span class="linenos">876</span></a>
</span><span id="PHCalculations.sparse_mean_filter-877"><a href="#PHCalculations.sparse_mean_filter-877"><span class="linenos">877</span></a>        <span class="c1"># Pair indices</span>
</span><span id="PHCalculations.sparse_mean_filter-878"><a href="#PHCalculations.sparse_mean_filter-878"><span class="linenos">878</span></a>        <span class="n">I</span><span class="p">,</span> <span class="n">J</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
</span><span id="PHCalculations.sparse_mean_filter-879"><a href="#PHCalculations.sparse_mean_filter-879"><span class="linenos">879</span></a>
</span><span id="PHCalculations.sparse_mean_filter-880"><a href="#PHCalculations.sparse_mean_filter-880"><span class="linenos">880</span></a>        <span class="c1"># Delete cmat</span>
</span><span id="PHCalculations.sparse_mean_filter-881"><a href="#PHCalculations.sparse_mean_filter-881"><span class="linenos">881</span></a>        <span class="n">cmat_shape</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">shape</span>
</span><span id="PHCalculations.sparse_mean_filter-882"><a href="#PHCalculations.sparse_mean_filter-882"><span class="linenos">882</span></a>        <span class="k">del</span> <span class="n">cmat</span>
</span><span id="PHCalculations.sparse_mean_filter-883"><a href="#PHCalculations.sparse_mean_filter-883"><span class="linenos">883</span></a>
</span><span id="PHCalculations.sparse_mean_filter-884"><a href="#PHCalculations.sparse_mean_filter-884"><span class="linenos">884</span></a>        <span class="c1"># Sum over columns</span>
</span><span id="PHCalculations.sparse_mean_filter-885"><a href="#PHCalculations.sparse_mean_filter-885"><span class="linenos">885</span></a>        <span class="n">V_sum</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">bsr_matrix</span><span class="p">(</span>
</span><span id="PHCalculations.sparse_mean_filter-886"><a href="#PHCalculations.sparse_mean_filter-886"><span class="linenos">886</span></a>            <span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">J</span><span class="p">],</span> <span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">I</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="n">cmat_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">V</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="PHCalculations.sparse_mean_filter-887"><a href="#PHCalculations.sparse_mean_filter-887"><span class="linenos">887</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="PHCalculations.sparse_mean_filter-888"><a href="#PHCalculations.sparse_mean_filter-888"><span class="linenos">888</span></a>
</span><span id="PHCalculations.sparse_mean_filter-889"><a href="#PHCalculations.sparse_mean_filter-889"><span class="linenos">889</span></a>        <span class="c1"># Count over columns</span>
</span><span id="PHCalculations.sparse_mean_filter-890"><a href="#PHCalculations.sparse_mean_filter-890"><span class="linenos">890</span></a>        <span class="n">V_count</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">bsr_matrix</span><span class="p">(</span>
</span><span id="PHCalculations.sparse_mean_filter-891"><a href="#PHCalculations.sparse_mean_filter-891"><span class="linenos">891</span></a>            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">J</span><span class="p">),</span> <span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">I</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="n">cmat_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">V</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="PHCalculations.sparse_mean_filter-892"><a href="#PHCalculations.sparse_mean_filter-892"><span class="linenos">892</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="PHCalculations.sparse_mean_filter-893"><a href="#PHCalculations.sparse_mean_filter-893"><span class="linenos">893</span></a>
</span><span id="PHCalculations.sparse_mean_filter-894"><a href="#PHCalculations.sparse_mean_filter-894"><span class="linenos">894</span></a>        <span class="k">return</span> <span class="n">V_sum</span> <span class="o">/</span> <span class="n">V_count</span>
</span></pre></div>


            <div class="docstring"><p>Sparse implementation of a mean filter.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>idx</strong> (<code>~numpy.array</code>):
Edge indices for each dimension (MxN).</li>
<li><strong>V</strong> (<code>~numpy.array</code>):
Array of intensity data (Mx1).</li>
<li><strong>radius</strong> (float or list):
Radius of the sparse filter in each dimension. Values less than
zero indicate no connectivity in that dimension.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong><code>~numpy.array</code></strong>: Filtered intensities (Mx1).</li>
</ul>

<h6 id="notes">Notes</h6>

<p>This function has been adapted from the original implementation in the Deimos package: <a href="https://github.com/pnnl/deimos">https://github.com/pnnl/deimos</a>.
This is a static method.</p>
</div>


                            </div>
                            <div id="PHCalculations.embed_unique_indices" class="classattr">
                                        <input id="PHCalculations.embed_unique_indices-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">embed_unique_indices</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">a</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PHCalculations.embed_unique_indices-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PHCalculations.embed_unique_indices"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PHCalculations.embed_unique_indices-896"><a href="#PHCalculations.embed_unique_indices-896"><span class="linenos">896</span></a>    <span class="nd">@staticmethod</span>
</span><span id="PHCalculations.embed_unique_indices-897"><a href="#PHCalculations.embed_unique_indices-897"><span class="linenos">897</span></a>    <span class="k">def</span> <span class="nf">embed_unique_indices</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
</span><span id="PHCalculations.embed_unique_indices-898"><a href="#PHCalculations.embed_unique_indices-898"><span class="linenos">898</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates an array of indices, sorted by unique element.</span>
</span><span id="PHCalculations.embed_unique_indices-899"><a href="#PHCalculations.embed_unique_indices-899"><span class="linenos">899</span></a>
</span><span id="PHCalculations.embed_unique_indices-900"><a href="#PHCalculations.embed_unique_indices-900"><span class="linenos">900</span></a><span class="sd">        Parameters</span>
</span><span id="PHCalculations.embed_unique_indices-901"><a href="#PHCalculations.embed_unique_indices-901"><span class="linenos">901</span></a><span class="sd">        ----------</span>
</span><span id="PHCalculations.embed_unique_indices-902"><a href="#PHCalculations.embed_unique_indices-902"><span class="linenos">902</span></a><span class="sd">        a : :obj:`~numpy.array`</span>
</span><span id="PHCalculations.embed_unique_indices-903"><a href="#PHCalculations.embed_unique_indices-903"><span class="linenos">903</span></a><span class="sd">            Array of unique elements (Mx1).</span>
</span><span id="PHCalculations.embed_unique_indices-904"><a href="#PHCalculations.embed_unique_indices-904"><span class="linenos">904</span></a>
</span><span id="PHCalculations.embed_unique_indices-905"><a href="#PHCalculations.embed_unique_indices-905"><span class="linenos">905</span></a><span class="sd">        Returns</span>
</span><span id="PHCalculations.embed_unique_indices-906"><a href="#PHCalculations.embed_unique_indices-906"><span class="linenos">906</span></a><span class="sd">        -------</span>
</span><span id="PHCalculations.embed_unique_indices-907"><a href="#PHCalculations.embed_unique_indices-907"><span class="linenos">907</span></a><span class="sd">        :obj:`~numpy.array`</span>
</span><span id="PHCalculations.embed_unique_indices-908"><a href="#PHCalculations.embed_unique_indices-908"><span class="linenos">908</span></a><span class="sd">            Array of indices (Mx1).</span>
</span><span id="PHCalculations.embed_unique_indices-909"><a href="#PHCalculations.embed_unique_indices-909"><span class="linenos">909</span></a>
</span><span id="PHCalculations.embed_unique_indices-910"><a href="#PHCalculations.embed_unique_indices-910"><span class="linenos">910</span></a><span class="sd">        Notes</span>
</span><span id="PHCalculations.embed_unique_indices-911"><a href="#PHCalculations.embed_unique_indices-911"><span class="linenos">911</span></a><span class="sd">        -----</span>
</span><span id="PHCalculations.embed_unique_indices-912"><a href="#PHCalculations.embed_unique_indices-912"><span class="linenos">912</span></a><span class="sd">        This function has been adapted from the original implementation in the Deimos package: https://github.com/pnnl/deimos</span>
</span><span id="PHCalculations.embed_unique_indices-913"><a href="#PHCalculations.embed_unique_indices-913"><span class="linenos">913</span></a><span class="sd">        This is a static method.</span>
</span><span id="PHCalculations.embed_unique_indices-914"><a href="#PHCalculations.embed_unique_indices-914"><span class="linenos">914</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PHCalculations.embed_unique_indices-915"><a href="#PHCalculations.embed_unique_indices-915"><span class="linenos">915</span></a>
</span><span id="PHCalculations.embed_unique_indices-916"><a href="#PHCalculations.embed_unique_indices-916"><span class="linenos">916</span></a>        <span class="k">def</span> <span class="nf">count_tens</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="PHCalculations.embed_unique_indices-917"><a href="#PHCalculations.embed_unique_indices-917"><span class="linenos">917</span></a>            <span class="c1"># Count tens</span>
</span><span id="PHCalculations.embed_unique_indices-918"><a href="#PHCalculations.embed_unique_indices-918"><span class="linenos">918</span></a>            <span class="n">ntens</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span>
</span><span id="PHCalculations.embed_unique_indices-919"><a href="#PHCalculations.embed_unique_indices-919"><span class="linenos">919</span></a>
</span><span id="PHCalculations.embed_unique_indices-920"><a href="#PHCalculations.embed_unique_indices-920"><span class="linenos">920</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="PHCalculations.embed_unique_indices-921"><a href="#PHCalculations.embed_unique_indices-921"><span class="linenos">921</span></a>                <span class="n">ntens_test</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntens</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span>
</span><span id="PHCalculations.embed_unique_indices-922"><a href="#PHCalculations.embed_unique_indices-922"><span class="linenos">922</span></a>
</span><span id="PHCalculations.embed_unique_indices-923"><a href="#PHCalculations.embed_unique_indices-923"><span class="linenos">923</span></a>                <span class="k">if</span> <span class="n">ntens_test</span> <span class="o">==</span> <span class="n">ntens</span><span class="p">:</span>
</span><span id="PHCalculations.embed_unique_indices-924"><a href="#PHCalculations.embed_unique_indices-924"><span class="linenos">924</span></a>                    <span class="k">return</span> <span class="n">ntens</span>
</span><span id="PHCalculations.embed_unique_indices-925"><a href="#PHCalculations.embed_unique_indices-925"><span class="linenos">925</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="PHCalculations.embed_unique_indices-926"><a href="#PHCalculations.embed_unique_indices-926"><span class="linenos">926</span></a>                    <span class="n">ntens</span> <span class="o">=</span> <span class="n">ntens_test</span>
</span><span id="PHCalculations.embed_unique_indices-927"><a href="#PHCalculations.embed_unique_indices-927"><span class="linenos">927</span></a>
</span><span id="PHCalculations.embed_unique_indices-928"><a href="#PHCalculations.embed_unique_indices-928"><span class="linenos">928</span></a>        <span class="k">def</span> <span class="nf">arange_exclude_10s</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span><span id="PHCalculations.embed_unique_indices-929"><a href="#PHCalculations.embed_unique_indices-929"><span class="linenos">929</span></a>            <span class="c1"># How many 10s will there be?</span>
</span><span id="PHCalculations.embed_unique_indices-930"><a href="#PHCalculations.embed_unique_indices-930"><span class="linenos">930</span></a>            <span class="n">ntens</span> <span class="o">=</span> <span class="n">count_tens</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="PHCalculations.embed_unique_indices-931"><a href="#PHCalculations.embed_unique_indices-931"><span class="linenos">931</span></a>
</span><span id="PHCalculations.embed_unique_indices-932"><a href="#PHCalculations.embed_unique_indices-932"><span class="linenos">932</span></a>            <span class="c1"># Base array</span>
</span><span id="PHCalculations.embed_unique_indices-933"><a href="#PHCalculations.embed_unique_indices-933"><span class="linenos">933</span></a>            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="n">ntens</span><span class="p">)</span>
</span><span id="PHCalculations.embed_unique_indices-934"><a href="#PHCalculations.embed_unique_indices-934"><span class="linenos">934</span></a>
</span><span id="PHCalculations.embed_unique_indices-935"><a href="#PHCalculations.embed_unique_indices-935"><span class="linenos">935</span></a>            <span class="c1"># Exclude 10s</span>
</span><span id="PHCalculations.embed_unique_indices-936"><a href="#PHCalculations.embed_unique_indices-936"><span class="linenos">936</span></a>            <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[(</span><span class="n">arr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">arr</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)][:</span><span class="n">n</span><span class="p">]</span>
</span><span id="PHCalculations.embed_unique_indices-937"><a href="#PHCalculations.embed_unique_indices-937"><span class="linenos">937</span></a>
</span><span id="PHCalculations.embed_unique_indices-938"><a href="#PHCalculations.embed_unique_indices-938"><span class="linenos">938</span></a>            <span class="k">return</span> <span class="n">arr</span>
</span><span id="PHCalculations.embed_unique_indices-939"><a href="#PHCalculations.embed_unique_indices-939"><span class="linenos">939</span></a>
</span><span id="PHCalculations.embed_unique_indices-940"><a href="#PHCalculations.embed_unique_indices-940"><span class="linenos">940</span></a>        <span class="c1"># Creates an array of indices, sorted by unique element</span>
</span><span id="PHCalculations.embed_unique_indices-941"><a href="#PHCalculations.embed_unique_indices-941"><span class="linenos">941</span></a>        <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span id="PHCalculations.embed_unique_indices-942"><a href="#PHCalculations.embed_unique_indices-942"><span class="linenos">942</span></a>        <span class="n">idx_unsort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">idx_sort</span><span class="p">)</span>
</span><span id="PHCalculations.embed_unique_indices-943"><a href="#PHCalculations.embed_unique_indices-943"><span class="linenos">943</span></a>
</span><span id="PHCalculations.embed_unique_indices-944"><a href="#PHCalculations.embed_unique_indices-944"><span class="linenos">944</span></a>        <span class="c1"># Sorts records array so all unique elements are together</span>
</span><span id="PHCalculations.embed_unique_indices-945"><a href="#PHCalculations.embed_unique_indices-945"><span class="linenos">945</span></a>        <span class="n">sorted_a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">idx_sort</span><span class="p">]</span>
</span><span id="PHCalculations.embed_unique_indices-946"><a href="#PHCalculations.embed_unique_indices-946"><span class="linenos">946</span></a>
</span><span id="PHCalculations.embed_unique_indices-947"><a href="#PHCalculations.embed_unique_indices-947"><span class="linenos">947</span></a>        <span class="c1"># Returns the unique values, the index of the first occurrence,</span>
</span><span id="PHCalculations.embed_unique_indices-948"><a href="#PHCalculations.embed_unique_indices-948"><span class="linenos">948</span></a>        <span class="c1"># and the count for each element</span>
</span><span id="PHCalculations.embed_unique_indices-949"><a href="#PHCalculations.embed_unique_indices-949"><span class="linenos">949</span></a>        <span class="n">vals</span><span class="p">,</span> <span class="n">idx_start</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
</span><span id="PHCalculations.embed_unique_indices-950"><a href="#PHCalculations.embed_unique_indices-950"><span class="linenos">950</span></a>            <span class="n">sorted_a</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span>
</span><span id="PHCalculations.embed_unique_indices-951"><a href="#PHCalculations.embed_unique_indices-951"><span class="linenos">951</span></a>        <span class="p">)</span>
</span><span id="PHCalculations.embed_unique_indices-952"><a href="#PHCalculations.embed_unique_indices-952"><span class="linenos">952</span></a>
</span><span id="PHCalculations.embed_unique_indices-953"><a href="#PHCalculations.embed_unique_indices-953"><span class="linenos">953</span></a>        <span class="c1"># Splits the indices into separate arrays</span>
</span><span id="PHCalculations.embed_unique_indices-954"><a href="#PHCalculations.embed_unique_indices-954"><span class="linenos">954</span></a>        <span class="n">splits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">idx_sort</span><span class="p">,</span> <span class="n">idx_start</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span><span id="PHCalculations.embed_unique_indices-955"><a href="#PHCalculations.embed_unique_indices-955"><span class="linenos">955</span></a>
</span><span id="PHCalculations.embed_unique_indices-956"><a href="#PHCalculations.embed_unique_indices-956"><span class="linenos">956</span></a>        <span class="c1"># Creates unique indices for each split</span>
</span><span id="PHCalculations.embed_unique_indices-957"><a href="#PHCalculations.embed_unique_indices-957"><span class="linenos">957</span></a>        <span class="n">idx_unq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">arange_exclude_10s</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">])</span>
</span><span id="PHCalculations.embed_unique_indices-958"><a href="#PHCalculations.embed_unique_indices-958"><span class="linenos">958</span></a>
</span><span id="PHCalculations.embed_unique_indices-959"><a href="#PHCalculations.embed_unique_indices-959"><span class="linenos">959</span></a>        <span class="c1"># Reorders according to input array</span>
</span><span id="PHCalculations.embed_unique_indices-960"><a href="#PHCalculations.embed_unique_indices-960"><span class="linenos">960</span></a>        <span class="n">idx_unq</span> <span class="o">=</span> <span class="n">idx_unq</span><span class="p">[</span><span class="n">idx_unsort</span><span class="p">]</span>
</span><span id="PHCalculations.embed_unique_indices-961"><a href="#PHCalculations.embed_unique_indices-961"><span class="linenos">961</span></a>
</span><span id="PHCalculations.embed_unique_indices-962"><a href="#PHCalculations.embed_unique_indices-962"><span class="linenos">962</span></a>        <span class="c1"># Magnitude of each index</span>
</span><span id="PHCalculations.embed_unique_indices-963"><a href="#PHCalculations.embed_unique_indices-963"><span class="linenos">963</span></a>        <span class="n">exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
</span><span id="PHCalculations.embed_unique_indices-964"><a href="#PHCalculations.embed_unique_indices-964"><span class="linenos">964</span></a>            <span class="n">idx_unq</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">idx_unq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">idx_unq</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="PHCalculations.embed_unique_indices-965"><a href="#PHCalculations.embed_unique_indices-965"><span class="linenos">965</span></a>        <span class="p">)</span>
</span><span id="PHCalculations.embed_unique_indices-966"><a href="#PHCalculations.embed_unique_indices-966"><span class="linenos">966</span></a>        <span class="n">idx_unq_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PHCalculations.embed_unique_indices-967"><a href="#PHCalculations.embed_unique_indices-967"><span class="linenos">967</span></a>
</span><span id="PHCalculations.embed_unique_indices-968"><a href="#PHCalculations.embed_unique_indices-968"><span class="linenos">968</span></a>        <span class="c1"># Result</span>
</span><span id="PHCalculations.embed_unique_indices-969"><a href="#PHCalculations.embed_unique_indices-969"><span class="linenos">969</span></a>        <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">idx_unq</span> <span class="o">/</span> <span class="n">idx_unq_mag</span>
</span></pre></div>


            <div class="docstring"><p>Creates an array of indices, sorted by unique element.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>a</strong> (<code>~numpy.array</code>):
Array of unique elements (Mx1).</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong><code>~numpy.array</code></strong>: Array of indices (Mx1).</li>
</ul>

<h6 id="notes">Notes</h6>

<p>This function has been adapted from the original implementation in the Deimos package: <a href="https://github.com/pnnl/deimos">https://github.com/pnnl/deimos</a>
This is a static method.</p>
</div>


                            </div>
                            <div id="PHCalculations.sparse_upper_star" class="classattr">
                                        <input id="PHCalculations.sparse_upper_star-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sparse_upper_star</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">idx</span>, </span><span class="param"><span class="n">V</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PHCalculations.sparse_upper_star-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PHCalculations.sparse_upper_star"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PHCalculations.sparse_upper_star-971"><a href="#PHCalculations.sparse_upper_star-971"><span class="linenos"> 971</span></a>    <span class="k">def</span> <span class="nf">sparse_upper_star</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">V</span><span class="p">):</span>
</span><span id="PHCalculations.sparse_upper_star-972"><a href="#PHCalculations.sparse_upper_star-972"><span class="linenos"> 972</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sparse implementation of an upper star filtration.</span>
</span><span id="PHCalculations.sparse_upper_star-973"><a href="#PHCalculations.sparse_upper_star-973"><span class="linenos"> 973</span></a>
</span><span id="PHCalculations.sparse_upper_star-974"><a href="#PHCalculations.sparse_upper_star-974"><span class="linenos"> 974</span></a><span class="sd">        Parameters</span>
</span><span id="PHCalculations.sparse_upper_star-975"><a href="#PHCalculations.sparse_upper_star-975"><span class="linenos"> 975</span></a><span class="sd">        ----------</span>
</span><span id="PHCalculations.sparse_upper_star-976"><a href="#PHCalculations.sparse_upper_star-976"><span class="linenos"> 976</span></a><span class="sd">        idx : :obj:`~numpy.array`</span>
</span><span id="PHCalculations.sparse_upper_star-977"><a href="#PHCalculations.sparse_upper_star-977"><span class="linenos"> 977</span></a><span class="sd">            Edge indices for each dimension (MxN).</span>
</span><span id="PHCalculations.sparse_upper_star-978"><a href="#PHCalculations.sparse_upper_star-978"><span class="linenos"> 978</span></a><span class="sd">        V : :obj:`~numpy.array`</span>
</span><span id="PHCalculations.sparse_upper_star-979"><a href="#PHCalculations.sparse_upper_star-979"><span class="linenos"> 979</span></a><span class="sd">            Array of intensity data (Mx1).</span>
</span><span id="PHCalculations.sparse_upper_star-980"><a href="#PHCalculations.sparse_upper_star-980"><span class="linenos"> 980</span></a><span class="sd">        Returns</span>
</span><span id="PHCalculations.sparse_upper_star-981"><a href="#PHCalculations.sparse_upper_star-981"><span class="linenos"> 981</span></a><span class="sd">        -------</span>
</span><span id="PHCalculations.sparse_upper_star-982"><a href="#PHCalculations.sparse_upper_star-982"><span class="linenos"> 982</span></a><span class="sd">        idx : :obj:`~numpy.array`</span>
</span><span id="PHCalculations.sparse_upper_star-983"><a href="#PHCalculations.sparse_upper_star-983"><span class="linenos"> 983</span></a><span class="sd">            Index of filtered points (Mx1).</span>
</span><span id="PHCalculations.sparse_upper_star-984"><a href="#PHCalculations.sparse_upper_star-984"><span class="linenos"> 984</span></a><span class="sd">        persistence : :obj:`~numpy.array`</span>
</span><span id="PHCalculations.sparse_upper_star-985"><a href="#PHCalculations.sparse_upper_star-985"><span class="linenos"> 985</span></a><span class="sd">            Persistence of each filtered point (Mx1).</span>
</span><span id="PHCalculations.sparse_upper_star-986"><a href="#PHCalculations.sparse_upper_star-986"><span class="linenos"> 986</span></a>
</span><span id="PHCalculations.sparse_upper_star-987"><a href="#PHCalculations.sparse_upper_star-987"><span class="linenos"> 987</span></a><span class="sd">        Notes</span>
</span><span id="PHCalculations.sparse_upper_star-988"><a href="#PHCalculations.sparse_upper_star-988"><span class="linenos"> 988</span></a><span class="sd">        -----</span>
</span><span id="PHCalculations.sparse_upper_star-989"><a href="#PHCalculations.sparse_upper_star-989"><span class="linenos"> 989</span></a><span class="sd">        This function has been adapted from the original implementation in the Deimos package: https://github.com/pnnl/deimos</span>
</span><span id="PHCalculations.sparse_upper_star-990"><a href="#PHCalculations.sparse_upper_star-990"><span class="linenos"> 990</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PHCalculations.sparse_upper_star-991"><a href="#PHCalculations.sparse_upper_star-991"><span class="linenos"> 991</span></a>
</span><span id="PHCalculations.sparse_upper_star-992"><a href="#PHCalculations.sparse_upper_star-992"><span class="linenos"> 992</span></a>        <span class="c1"># Invert</span>
</span><span id="PHCalculations.sparse_upper_star-993"><a href="#PHCalculations.sparse_upper_star-993"><span class="linenos"> 993</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">V</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</span><span id="PHCalculations.sparse_upper_star-994"><a href="#PHCalculations.sparse_upper_star-994"><span class="linenos"> 994</span></a>
</span><span id="PHCalculations.sparse_upper_star-995"><a href="#PHCalculations.sparse_upper_star-995"><span class="linenos"> 995</span></a>        <span class="c1"># Embed indices</span>
</span><span id="PHCalculations.sparse_upper_star-996"><a href="#PHCalculations.sparse_upper_star-996"><span class="linenos"> 996</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embed_unique_indices</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
</span><span id="PHCalculations.sparse_upper_star-997"><a href="#PHCalculations.sparse_upper_star-997"><span class="linenos"> 997</span></a>
</span><span id="PHCalculations.sparse_upper_star-998"><a href="#PHCalculations.sparse_upper_star-998"><span class="linenos"> 998</span></a>        <span class="c1"># Connectivity matrix</span>
</span><span id="PHCalculations.sparse_upper_star-999"><a href="#PHCalculations.sparse_upper_star-999"><span class="linenos"> 999</span></a>        <span class="n">cmat</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
</span><span id="PHCalculations.sparse_upper_star-1000"><a href="#PHCalculations.sparse_upper_star-1000"><span class="linenos">1000</span></a>        <span class="n">cmat</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">sparse_distance_matrix</span><span class="p">(</span><span class="n">cmat</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;coo_matrix&quot;</span><span class="p">)</span>
</span><span id="PHCalculations.sparse_upper_star-1001"><a href="#PHCalculations.sparse_upper_star-1001"><span class="linenos">1001</span></a>        <span class="n">cmat</span><span class="o">.</span><span class="n">setdiag</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PHCalculations.sparse_upper_star-1002"><a href="#PHCalculations.sparse_upper_star-1002"><span class="linenos">1002</span></a>        <span class="n">cmat</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">cmat</span><span class="p">)</span>
</span><span id="PHCalculations.sparse_upper_star-1003"><a href="#PHCalculations.sparse_upper_star-1003"><span class="linenos">1003</span></a>
</span><span id="PHCalculations.sparse_upper_star-1004"><a href="#PHCalculations.sparse_upper_star-1004"><span class="linenos">1004</span></a>        <span class="c1"># Pairwise minimums</span>
</span><span id="PHCalculations.sparse_upper_star-1005"><a href="#PHCalculations.sparse_upper_star-1005"><span class="linenos">1005</span></a>        <span class="n">I</span><span class="p">,</span> <span class="n">J</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
</span><span id="PHCalculations.sparse_upper_star-1006"><a href="#PHCalculations.sparse_upper_star-1006"><span class="linenos">1006</span></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">I</span><span class="p">],</span> <span class="n">V</span><span class="p">[</span><span class="n">J</span><span class="p">])</span>
</span><span id="PHCalculations.sparse_upper_star-1007"><a href="#PHCalculations.sparse_upper_star-1007"><span class="linenos">1007</span></a>
</span><span id="PHCalculations.sparse_upper_star-1008"><a href="#PHCalculations.sparse_upper_star-1008"><span class="linenos">1008</span></a>        <span class="c1"># Delete connectiity matrix</span>
</span><span id="PHCalculations.sparse_upper_star-1009"><a href="#PHCalculations.sparse_upper_star-1009"><span class="linenos">1009</span></a>        <span class="n">cmat_shape</span> <span class="o">=</span> <span class="n">cmat</span><span class="o">.</span><span class="n">shape</span>
</span><span id="PHCalculations.sparse_upper_star-1010"><a href="#PHCalculations.sparse_upper_star-1010"><span class="linenos">1010</span></a>        <span class="k">del</span> <span class="n">cmat</span>
</span><span id="PHCalculations.sparse_upper_star-1011"><a href="#PHCalculations.sparse_upper_star-1011"><span class="linenos">1011</span></a>
</span><span id="PHCalculations.sparse_upper_star-1012"><a href="#PHCalculations.sparse_upper_star-1012"><span class="linenos">1012</span></a>        <span class="c1"># Sparse distance matrix</span>
</span><span id="PHCalculations.sparse_upper_star-1013"><a href="#PHCalculations.sparse_upper_star-1013"><span class="linenos">1013</span></a>        <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="n">cmat_shape</span><span class="p">)</span>
</span><span id="PHCalculations.sparse_upper_star-1014"><a href="#PHCalculations.sparse_upper_star-1014"><span class="linenos">1014</span></a>
</span><span id="PHCalculations.sparse_upper_star-1015"><a href="#PHCalculations.sparse_upper_star-1015"><span class="linenos">1015</span></a>        <span class="c1"># Delete pairwise mins</span>
</span><span id="PHCalculations.sparse_upper_star-1016"><a href="#PHCalculations.sparse_upper_star-1016"><span class="linenos">1016</span></a>        <span class="k">del</span> <span class="n">d</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">J</span>
</span><span id="PHCalculations.sparse_upper_star-1017"><a href="#PHCalculations.sparse_upper_star-1017"><span class="linenos">1017</span></a>
</span><span id="PHCalculations.sparse_upper_star-1018"><a href="#PHCalculations.sparse_upper_star-1018"><span class="linenos">1018</span></a>        <span class="c1"># Persistence homology</span>
</span><span id="PHCalculations.sparse_upper_star-1019"><a href="#PHCalculations.sparse_upper_star-1019"><span class="linenos">1019</span></a>        <span class="n">ph</span> <span class="o">=</span> <span class="n">ripser</span><span class="p">(</span><span class="n">sdm</span><span class="p">,</span> <span class="n">distance_matrix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maxdim</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="s2">&quot;dgms&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PHCalculations.sparse_upper_star-1020"><a href="#PHCalculations.sparse_upper_star-1020"><span class="linenos">1020</span></a>
</span><span id="PHCalculations.sparse_upper_star-1021"><a href="#PHCalculations.sparse_upper_star-1021"><span class="linenos">1021</span></a>        <span class="c1"># Bound death values</span>
</span><span id="PHCalculations.sparse_upper_star-1022"><a href="#PHCalculations.sparse_upper_star-1022"><span class="linenos">1022</span></a>        <span class="n">ph</span><span class="p">[</span><span class="n">ph</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
</span><span id="PHCalculations.sparse_upper_star-1023"><a href="#PHCalculations.sparse_upper_star-1023"><span class="linenos">1023</span></a>
</span><span id="PHCalculations.sparse_upper_star-1024"><a href="#PHCalculations.sparse_upper_star-1024"><span class="linenos">1024</span></a>        <span class="c1"># Construct tree to query against</span>
</span><span id="PHCalculations.sparse_upper_star-1025"><a href="#PHCalculations.sparse_upper_star-1025"><span class="linenos">1025</span></a>        <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
</span><span id="PHCalculations.sparse_upper_star-1026"><a href="#PHCalculations.sparse_upper_star-1026"><span class="linenos">1026</span></a>
</span><span id="PHCalculations.sparse_upper_star-1027"><a href="#PHCalculations.sparse_upper_star-1027"><span class="linenos">1027</span></a>        <span class="c1"># Get the indexes of the first nearest neighbor by birth</span>
</span><span id="PHCalculations.sparse_upper_star-1028"><a href="#PHCalculations.sparse_upper_star-1028"><span class="linenos">1028</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">nn</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ph</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">workers</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PHCalculations.sparse_upper_star-1029"><a href="#PHCalculations.sparse_upper_star-1029"><span class="linenos">1029</span></a>
</span><span id="PHCalculations.sparse_upper_star-1030"><a href="#PHCalculations.sparse_upper_star-1030"><span class="linenos">1030</span></a>        <span class="k">return</span> <span class="n">nn</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="n">ph</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ph</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">1</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sparse implementation of an upper star filtration.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>idx</strong> (<code>~numpy.array</code>):
Edge indices for each dimension (MxN).</li>
<li><strong>V</strong> (<code>~numpy.array</code>):
Array of intensity data (Mx1).</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>idx</strong> (<code>~numpy.array</code>):
Index of filtered points (Mx1).</li>
<li><strong>persistence</strong> (<code>~numpy.array</code>):
Persistence of each filtered point (Mx1).</li>
</ul>

<h6 id="notes">Notes</h6>

<p>This function has been adapted from the original implementation in the Deimos package: <a href="https://github.com/pnnl/deimos">https://github.com/pnnl/deimos</a></p>
</div>


                            </div>
                            <div id="PHCalculations.check_if_grid" class="classattr">
                                        <input id="PHCalculations.check_if_grid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_if_grid</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">data</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PHCalculations.check_if_grid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PHCalculations.check_if_grid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PHCalculations.check_if_grid-1032"><a href="#PHCalculations.check_if_grid-1032"><span class="linenos">1032</span></a>    <span class="k">def</span> <span class="nf">check_if_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span id="PHCalculations.check_if_grid-1033"><a href="#PHCalculations.check_if_grid-1033"><span class="linenos">1033</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if the data are gridded in mz space.</span>
</span><span id="PHCalculations.check_if_grid-1034"><a href="#PHCalculations.check_if_grid-1034"><span class="linenos">1034</span></a>
</span><span id="PHCalculations.check_if_grid-1035"><a href="#PHCalculations.check_if_grid-1035"><span class="linenos">1035</span></a><span class="sd">        Parameters</span>
</span><span id="PHCalculations.check_if_grid-1036"><a href="#PHCalculations.check_if_grid-1036"><span class="linenos">1036</span></a><span class="sd">        ----------</span>
</span><span id="PHCalculations.check_if_grid-1037"><a href="#PHCalculations.check_if_grid-1037"><span class="linenos">1037</span></a><span class="sd">        data : DataFrame</span>
</span><span id="PHCalculations.check_if_grid-1038"><a href="#PHCalculations.check_if_grid-1038"><span class="linenos">1038</span></a><span class="sd">            DataFrame containing the mass spectrometry data.  Needs to have mz and scan columns.</span>
</span><span id="PHCalculations.check_if_grid-1039"><a href="#PHCalculations.check_if_grid-1039"><span class="linenos">1039</span></a>
</span><span id="PHCalculations.check_if_grid-1040"><a href="#PHCalculations.check_if_grid-1040"><span class="linenos">1040</span></a><span class="sd">        Returns</span>
</span><span id="PHCalculations.check_if_grid-1041"><a href="#PHCalculations.check_if_grid-1041"><span class="linenos">1041</span></a><span class="sd">        -------</span>
</span><span id="PHCalculations.check_if_grid-1042"><a href="#PHCalculations.check_if_grid-1042"><span class="linenos">1042</span></a><span class="sd">        bool</span>
</span><span id="PHCalculations.check_if_grid-1043"><a href="#PHCalculations.check_if_grid-1043"><span class="linenos">1043</span></a><span class="sd">            True if the data is gridded in the mz direction, False otherwise.</span>
</span><span id="PHCalculations.check_if_grid-1044"><a href="#PHCalculations.check_if_grid-1044"><span class="linenos">1044</span></a>
</span><span id="PHCalculations.check_if_grid-1045"><a href="#PHCalculations.check_if_grid-1045"><span class="linenos">1045</span></a><span class="sd">        Notes</span>
</span><span id="PHCalculations.check_if_grid-1046"><a href="#PHCalculations.check_if_grid-1046"><span class="linenos">1046</span></a><span class="sd">        -----</span>
</span><span id="PHCalculations.check_if_grid-1047"><a href="#PHCalculations.check_if_grid-1047"><span class="linenos">1047</span></a><span class="sd">        This function is used within the grid_data function and the find_mass_features function and is not intended to be called directly.</span>
</span><span id="PHCalculations.check_if_grid-1048"><a href="#PHCalculations.check_if_grid-1048"><span class="linenos">1048</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PHCalculations.check_if_grid-1049"><a href="#PHCalculations.check_if_grid-1049"><span class="linenos">1049</span></a>        <span class="c1"># Calculate the difference between consecutive mz values in a single scan</span>
</span><span id="PHCalculations.check_if_grid-1050"><a href="#PHCalculations.check_if_grid-1050"><span class="linenos">1050</span></a>        <span class="n">dat_check</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations.check_if_grid-1051"><a href="#PHCalculations.check_if_grid-1051"><span class="linenos">1051</span></a>        <span class="n">dat_check</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dat_check</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">())</span>
</span><span id="PHCalculations.check_if_grid-1052"><a href="#PHCalculations.check_if_grid-1052"><span class="linenos">1052</span></a>        <span class="n">mz_diff_min</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="PHCalculations.check_if_grid-1053"><a href="#PHCalculations.check_if_grid-1053"><span class="linenos">1053</span></a>            <span class="n">dat_check</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;scan&quot;</span><span class="p">)[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="PHCalculations.check_if_grid-1054"><a href="#PHCalculations.check_if_grid-1054"><span class="linenos">1054</span></a>        <span class="p">)</span>  <span class="c1"># within each scan, what is the smallest mz difference between consecutive mz values</span>
</span><span id="PHCalculations.check_if_grid-1055"><a href="#PHCalculations.check_if_grid-1055"><span class="linenos">1055</span></a>
</span><span id="PHCalculations.check_if_grid-1056"><a href="#PHCalculations.check_if_grid-1056"><span class="linenos">1056</span></a>        <span class="c1"># Find the mininum mz difference between mz values in the data; regardless of scan</span>
</span><span id="PHCalculations.check_if_grid-1057"><a href="#PHCalculations.check_if_grid-1057"><span class="linenos">1057</span></a>        <span class="n">dat_check_mz</span> <span class="o">=</span> <span class="n">dat_check</span><span class="p">[[</span><span class="s2">&quot;mz&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations.check_if_grid-1058"><a href="#PHCalculations.check_if_grid-1058"><span class="linenos">1058</span></a>        <span class="n">dat_check_mz</span> <span class="o">=</span> <span class="n">dat_check_mz</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations.check_if_grid-1059"><a href="#PHCalculations.check_if_grid-1059"><span class="linenos">1059</span></a>        <span class="n">dat_check_mz</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dat_check_mz</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">())</span>
</span><span id="PHCalculations.check_if_grid-1060"><a href="#PHCalculations.check_if_grid-1060"><span class="linenos">1060</span></a>
</span><span id="PHCalculations.check_if_grid-1061"><a href="#PHCalculations.check_if_grid-1061"><span class="linenos">1061</span></a>        <span class="c1"># Get minimum mz_diff between mz values in the data</span>
</span><span id="PHCalculations.check_if_grid-1062"><a href="#PHCalculations.check_if_grid-1062"><span class="linenos">1062</span></a>        <span class="n">mz_diff_min_raw</span> <span class="o">=</span> <span class="n">dat_check_mz</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="PHCalculations.check_if_grid-1063"><a href="#PHCalculations.check_if_grid-1063"><span class="linenos">1063</span></a>
</span><span id="PHCalculations.check_if_grid-1064"><a href="#PHCalculations.check_if_grid-1064"><span class="linenos">1064</span></a>        <span class="c1"># If the minimum mz difference between mz values in the data is less than the minimum mz difference between mz values within a single scan, then the data is not gridded</span>
</span><span id="PHCalculations.check_if_grid-1065"><a href="#PHCalculations.check_if_grid-1065"><span class="linenos">1065</span></a>        <span class="k">if</span> <span class="n">mz_diff_min_raw</span> <span class="o">&lt;</span> <span class="n">mz_diff_min</span><span class="p">:</span>
</span><span id="PHCalculations.check_if_grid-1066"><a href="#PHCalculations.check_if_grid-1066"><span class="linenos">1066</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="PHCalculations.check_if_grid-1067"><a href="#PHCalculations.check_if_grid-1067"><span class="linenos">1067</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PHCalculations.check_if_grid-1068"><a href="#PHCalculations.check_if_grid-1068"><span class="linenos">1068</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span></pre></div>


            <div class="docstring"><p>Check if the data are gridded in mz space.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>data</strong> (DataFrame):
DataFrame containing the mass spectrometry data.  Needs to have mz and scan columns.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>bool</strong>: True if the data is gridded in the mz direction, False otherwise.</li>
</ul>

<h6 id="notes">Notes</h6>

<p>This function is used within the grid_data function and the find_mass_features function and is not intended to be called directly.</p>
</div>


                            </div>
                            <div id="PHCalculations.grid_data" class="classattr">
                                        <input id="PHCalculations.grid_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">grid_data</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">data</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PHCalculations.grid_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PHCalculations.grid_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PHCalculations.grid_data-1070"><a href="#PHCalculations.grid_data-1070"><span class="linenos">1070</span></a>    <span class="k">def</span> <span class="nf">grid_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span id="PHCalculations.grid_data-1071"><a href="#PHCalculations.grid_data-1071"><span class="linenos">1071</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Grid the data in the mz dimension.</span>
</span><span id="PHCalculations.grid_data-1072"><a href="#PHCalculations.grid_data-1072"><span class="linenos">1072</span></a>
</span><span id="PHCalculations.grid_data-1073"><a href="#PHCalculations.grid_data-1073"><span class="linenos">1073</span></a><span class="sd">        Data must be gridded prior to persistent homology calculations.</span>
</span><span id="PHCalculations.grid_data-1074"><a href="#PHCalculations.grid_data-1074"><span class="linenos">1074</span></a>
</span><span id="PHCalculations.grid_data-1075"><a href="#PHCalculations.grid_data-1075"><span class="linenos">1075</span></a><span class="sd">        Parameters</span>
</span><span id="PHCalculations.grid_data-1076"><a href="#PHCalculations.grid_data-1076"><span class="linenos">1076</span></a><span class="sd">        ----------</span>
</span><span id="PHCalculations.grid_data-1077"><a href="#PHCalculations.grid_data-1077"><span class="linenos">1077</span></a><span class="sd">        data : DataFrame</span>
</span><span id="PHCalculations.grid_data-1078"><a href="#PHCalculations.grid_data-1078"><span class="linenos">1078</span></a><span class="sd">            The input data containing mz, scan, scan_time, and intensity columns.</span>
</span><span id="PHCalculations.grid_data-1079"><a href="#PHCalculations.grid_data-1079"><span class="linenos">1079</span></a>
</span><span id="PHCalculations.grid_data-1080"><a href="#PHCalculations.grid_data-1080"><span class="linenos">1080</span></a><span class="sd">        Returns</span>
</span><span id="PHCalculations.grid_data-1081"><a href="#PHCalculations.grid_data-1081"><span class="linenos">1081</span></a><span class="sd">        -------</span>
</span><span id="PHCalculations.grid_data-1082"><a href="#PHCalculations.grid_data-1082"><span class="linenos">1082</span></a><span class="sd">        DataFrame</span>
</span><span id="PHCalculations.grid_data-1083"><a href="#PHCalculations.grid_data-1083"><span class="linenos">1083</span></a><span class="sd">            The gridded data with mz, scan, scan_time, and intensity columns.</span>
</span><span id="PHCalculations.grid_data-1084"><a href="#PHCalculations.grid_data-1084"><span class="linenos">1084</span></a>
</span><span id="PHCalculations.grid_data-1085"><a href="#PHCalculations.grid_data-1085"><span class="linenos">1085</span></a><span class="sd">        Raises</span>
</span><span id="PHCalculations.grid_data-1086"><a href="#PHCalculations.grid_data-1086"><span class="linenos">1086</span></a><span class="sd">        ------</span>
</span><span id="PHCalculations.grid_data-1087"><a href="#PHCalculations.grid_data-1087"><span class="linenos">1087</span></a><span class="sd">        ValueError</span>
</span><span id="PHCalculations.grid_data-1088"><a href="#PHCalculations.grid_data-1088"><span class="linenos">1088</span></a><span class="sd">            If gridding fails.</span>
</span><span id="PHCalculations.grid_data-1089"><a href="#PHCalculations.grid_data-1089"><span class="linenos">1089</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PHCalculations.grid_data-1090"><a href="#PHCalculations.grid_data-1090"><span class="linenos">1090</span></a>
</span><span id="PHCalculations.grid_data-1091"><a href="#PHCalculations.grid_data-1091"><span class="linenos">1091</span></a>        <span class="c1"># Calculate the difference between consecutive mz values in a single scan for grid spacing</span>
</span><span id="PHCalculations.grid_data-1092"><a href="#PHCalculations.grid_data-1092"><span class="linenos">1092</span></a>        <span class="n">data_w</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations.grid_data-1093"><a href="#PHCalculations.grid_data-1093"><span class="linenos">1093</span></a>        <span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">())</span>
</span><span id="PHCalculations.grid_data-1094"><a href="#PHCalculations.grid_data-1094"><span class="linenos">1094</span></a>        <span class="n">mz_diff_min</span> <span class="o">=</span> <span class="n">data_w</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;scan&quot;</span><span class="p">)[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.99999</span>
</span><span id="PHCalculations.grid_data-1095"><a href="#PHCalculations.grid_data-1095"><span class="linenos">1095</span></a>
</span><span id="PHCalculations.grid_data-1096"><a href="#PHCalculations.grid_data-1096"><span class="linenos">1096</span></a>        <span class="c1"># Need high intensity mz values first so they are parents in the output pairs stack</span>
</span><span id="PHCalculations.grid_data-1097"><a href="#PHCalculations.grid_data-1097"><span class="linenos">1097</span></a>        <span class="n">dat_mz</span> <span class="o">=</span> <span class="n">data_w</span><span class="p">[[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;intensity&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
</span><span id="PHCalculations.grid_data-1098"><a href="#PHCalculations.grid_data-1098"><span class="linenos">1098</span></a>            <span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
</span><span id="PHCalculations.grid_data-1099"><a href="#PHCalculations.grid_data-1099"><span class="linenos">1099</span></a>        <span class="p">)</span>
</span><span id="PHCalculations.grid_data-1100"><a href="#PHCalculations.grid_data-1100"><span class="linenos">1100</span></a>        <span class="n">dat_mz</span> <span class="o">=</span> <span class="n">dat_mz</span><span class="p">[[</span><span class="s2">&quot;mz&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations.grid_data-1101"><a href="#PHCalculations.grid_data-1101"><span class="linenos">1101</span></a>
</span><span id="PHCalculations.grid_data-1102"><a href="#PHCalculations.grid_data-1102"><span class="linenos">1102</span></a>        <span class="c1"># Construct KD tree</span>
</span><span id="PHCalculations.grid_data-1103"><a href="#PHCalculations.grid_data-1103"><span class="linenos">1103</span></a>        <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">dat_mz</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="PHCalculations.grid_data-1104"><a href="#PHCalculations.grid_data-1104"><span class="linenos">1104</span></a>        <span class="n">sdm</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">sparse_distance_matrix</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">mz_diff_min</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;coo_matrix&quot;</span><span class="p">)</span>
</span><span id="PHCalculations.grid_data-1105"><a href="#PHCalculations.grid_data-1105"><span class="linenos">1105</span></a>        <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">sdm</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PHCalculations.grid_data-1106"><a href="#PHCalculations.grid_data-1106"><span class="linenos">1106</span></a>        <span class="n">sdm</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="PHCalculations.grid_data-1107"><a href="#PHCalculations.grid_data-1107"><span class="linenos">1107</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="n">sdm</span><span class="o">.</span><span class="n">tocoo</span><span class="p">()</span>
</span><span id="PHCalculations.grid_data-1108"><a href="#PHCalculations.grid_data-1108"><span class="linenos">1108</span></a>        <span class="n">pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">distances</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">distances</span><span class="o">.</span><span class="n">col</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PHCalculations.grid_data-1109"><a href="#PHCalculations.grid_data-1109"><span class="linenos">1109</span></a>
</span><span id="PHCalculations.grid_data-1110"><a href="#PHCalculations.grid_data-1110"><span class="linenos">1110</span></a>        <span class="c1"># Cull pairs to just get root</span>
</span><span id="PHCalculations.grid_data-1111"><a href="#PHCalculations.grid_data-1111"><span class="linenos">1111</span></a>        <span class="n">to_drop</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PHCalculations.grid_data-1112"><a href="#PHCalculations.grid_data-1112"><span class="linenos">1112</span></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PHCalculations.grid_data-1113"><a href="#PHCalculations.grid_data-1113"><span class="linenos">1113</span></a>            <span class="n">root_parents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span>
</span><span id="PHCalculations.grid_data-1114"><a href="#PHCalculations.grid_data-1114"><span class="linenos">1114</span></a>            <span class="n">id_root_parents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">root_parents</span><span class="p">)</span>
</span><span id="PHCalculations.grid_data-1115"><a href="#PHCalculations.grid_data-1115"><span class="linenos">1115</span></a>            <span class="n">children_of_roots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs</span><span class="p">[</span><span class="n">id_root_parents</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="PHCalculations.grid_data-1116"><a href="#PHCalculations.grid_data-1116"><span class="linenos">1116</span></a>            <span class="n">to_drop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to_drop</span><span class="p">,</span> <span class="n">children_of_roots</span><span class="p">)</span>
</span><span id="PHCalculations.grid_data-1117"><a href="#PHCalculations.grid_data-1117"><span class="linenos">1117</span></a>
</span><span id="PHCalculations.grid_data-1118"><a href="#PHCalculations.grid_data-1118"><span class="linenos">1118</span></a>            <span class="c1"># Set up pairs array for next iteration by removing pairs with children or parents already dropped</span>
</span><span id="PHCalculations.grid_data-1119"><a href="#PHCalculations.grid_data-1119"><span class="linenos">1119</span></a>            <span class="n">pairs</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">to_drop</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="PHCalculations.grid_data-1120"><a href="#PHCalculations.grid_data-1120"><span class="linenos">1120</span></a>            <span class="n">pairs</span> <span class="o">=</span> <span class="n">pairs</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pairs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">to_drop</span><span class="p">),</span> <span class="p">:]</span>
</span><span id="PHCalculations.grid_data-1121"><a href="#PHCalculations.grid_data-1121"><span class="linenos">1121</span></a>        <span class="n">dat_mz</span> <span class="o">=</span> <span class="n">dat_mz</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">to_drop</span><span class="p">))</span>
</span><span id="PHCalculations.grid_data-1122"><a href="#PHCalculations.grid_data-1122"><span class="linenos">1122</span></a>        <span class="n">mz_dat_np</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="PHCalculations.grid_data-1123"><a href="#PHCalculations.grid_data-1123"><span class="linenos">1123</span></a>            <span class="n">dat_mz</span><span class="p">[[</span><span class="s2">&quot;mz&quot;</span><span class="p">]]</span>
</span><span id="PHCalculations.grid_data-1124"><a href="#PHCalculations.grid_data-1124"><span class="linenos">1124</span></a>            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span>
</span><span id="PHCalculations.grid_data-1125"><a href="#PHCalculations.grid_data-1125"><span class="linenos">1125</span></a>            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations.grid_data-1126"><a href="#PHCalculations.grid_data-1126"><span class="linenos">1126</span></a>            <span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span id="PHCalculations.grid_data-1127"><a href="#PHCalculations.grid_data-1127"><span class="linenos">1127</span></a>        <span class="p">)</span>
</span><span id="PHCalculations.grid_data-1128"><a href="#PHCalculations.grid_data-1128"><span class="linenos">1128</span></a>
</span><span id="PHCalculations.grid_data-1129"><a href="#PHCalculations.grid_data-1129"><span class="linenos">1129</span></a>        <span class="c1"># Sort data by mz and recast mz to nearest value in mz_dat_np</span>
</span><span id="PHCalculations.grid_data-1130"><a href="#PHCalculations.grid_data-1130"><span class="linenos">1130</span></a>        <span class="n">data_w</span> <span class="o">=</span> <span class="n">data_w</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations.grid_data-1131"><a href="#PHCalculations.grid_data-1131"><span class="linenos">1131</span></a>        <span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz_new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mz_dat_np</span><span class="p">[</span><span class="n">find_closest</span><span class="p">(</span><span class="n">mz_dat_np</span><span class="p">,</span> <span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>
</span><span id="PHCalculations.grid_data-1132"><a href="#PHCalculations.grid_data-1132"><span class="linenos">1132</span></a>        <span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">data_w</span><span class="p">[</span><span class="s2">&quot;mz_new&quot;</span><span class="p">])</span>
</span><span id="PHCalculations.grid_data-1133"><a href="#PHCalculations.grid_data-1133"><span class="linenos">1133</span></a>
</span><span id="PHCalculations.grid_data-1134"><a href="#PHCalculations.grid_data-1134"><span class="linenos">1134</span></a>        <span class="c1"># Rename mz_new as mz; drop mz_diff; groupby scan and mz and sum intensity</span>
</span><span id="PHCalculations.grid_data-1135"><a href="#PHCalculations.grid_data-1135"><span class="linenos">1135</span></a>        <span class="n">new_data_w</span> <span class="o">=</span> <span class="n">data_w</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;mz&quot;</span><span class="p">:</span> <span class="s2">&quot;mz_orig&quot;</span><span class="p">,</span> <span class="s2">&quot;mz_new&quot;</span><span class="p">:</span> <span class="s2">&quot;mz&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations.grid_data-1136"><a href="#PHCalculations.grid_data-1136"><span class="linenos">1136</span></a>        <span class="n">new_data_w</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="PHCalculations.grid_data-1137"><a href="#PHCalculations.grid_data-1137"><span class="linenos">1137</span></a>            <span class="n">new_data_w</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mz_diff&quot;</span><span class="p">,</span> <span class="s2">&quot;mz_orig&quot;</span><span class="p">])</span>
</span><span id="PHCalculations.grid_data-1138"><a href="#PHCalculations.grid_data-1138"><span class="linenos">1138</span></a>            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="s2">&quot;mz&quot;</span><span class="p">])[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span>
</span><span id="PHCalculations.grid_data-1139"><a href="#PHCalculations.grid_data-1139"><span class="linenos">1139</span></a>            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="PHCalculations.grid_data-1140"><a href="#PHCalculations.grid_data-1140"><span class="linenos">1140</span></a>            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span><span id="PHCalculations.grid_data-1141"><a href="#PHCalculations.grid_data-1141"><span class="linenos">1141</span></a>        <span class="p">)</span>
</span><span id="PHCalculations.grid_data-1142"><a href="#PHCalculations.grid_data-1142"><span class="linenos">1142</span></a>        <span class="n">new_data_w</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="PHCalculations.grid_data-1143"><a href="#PHCalculations.grid_data-1143"><span class="linenos">1143</span></a>            <span class="n">new_data_w</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="s2">&quot;mz&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>
</span><span id="PHCalculations.grid_data-1144"><a href="#PHCalculations.grid_data-1144"><span class="linenos">1144</span></a>            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations.grid_data-1145"><a href="#PHCalculations.grid_data-1145"><span class="linenos">1145</span></a>            <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations.grid_data-1146"><a href="#PHCalculations.grid_data-1146"><span class="linenos">1146</span></a>        <span class="p">)</span>
</span><span id="PHCalculations.grid_data-1147"><a href="#PHCalculations.grid_data-1147"><span class="linenos">1147</span></a>
</span><span id="PHCalculations.grid_data-1148"><a href="#PHCalculations.grid_data-1148"><span class="linenos">1148</span></a>        <span class="c1"># Check if grid worked and return</span>
</span><span id="PHCalculations.grid_data-1149"><a href="#PHCalculations.grid_data-1149"><span class="linenos">1149</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_grid</span><span class="p">(</span><span class="n">new_data_w</span><span class="p">):</span>
</span><span id="PHCalculations.grid_data-1150"><a href="#PHCalculations.grid_data-1150"><span class="linenos">1150</span></a>            <span class="k">return</span> <span class="n">new_data_w</span>
</span><span id="PHCalculations.grid_data-1151"><a href="#PHCalculations.grid_data-1151"><span class="linenos">1151</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PHCalculations.grid_data-1152"><a href="#PHCalculations.grid_data-1152"><span class="linenos">1152</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Gridding failed&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Grid the data in the mz dimension.</p>

<p>Data must be gridded prior to persistent homology calculations.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>data</strong> (DataFrame):
The input data containing mz, scan, scan_time, and intensity columns.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>DataFrame</strong>: The gridded data with mz, scan, scan_time, and intensity columns.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>ValueError</strong>: If gridding fails.</li>
</ul>
</div>


                            </div>
                            <div id="PHCalculations.find_mass_features_ph" class="classattr">
                                        <input id="PHCalculations.find_mass_features_ph-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">find_mass_features_ph</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">ms_level</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">grid</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PHCalculations.find_mass_features_ph-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PHCalculations.find_mass_features_ph"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PHCalculations.find_mass_features_ph-1154"><a href="#PHCalculations.find_mass_features_ph-1154"><span class="linenos">1154</span></a>    <span class="k">def</span> <span class="nf">find_mass_features_ph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="PHCalculations.find_mass_features_ph-1155"><a href="#PHCalculations.find_mass_features_ph-1155"><span class="linenos">1155</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Find mass features within an LCMSBase object using persistent homology.</span>
</span><span id="PHCalculations.find_mass_features_ph-1156"><a href="#PHCalculations.find_mass_features_ph-1156"><span class="linenos">1156</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1157"><a href="#PHCalculations.find_mass_features_ph-1157"><span class="linenos">1157</span></a><span class="sd">        Assigns the mass_features attribute to the object (a dictionary of LCMSMassFeature objects, keyed by mass feature id)</span>
</span><span id="PHCalculations.find_mass_features_ph-1158"><a href="#PHCalculations.find_mass_features_ph-1158"><span class="linenos">1158</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1159"><a href="#PHCalculations.find_mass_features_ph-1159"><span class="linenos">1159</span></a><span class="sd">        Parameters</span>
</span><span id="PHCalculations.find_mass_features_ph-1160"><a href="#PHCalculations.find_mass_features_ph-1160"><span class="linenos">1160</span></a><span class="sd">        ----------</span>
</span><span id="PHCalculations.find_mass_features_ph-1161"><a href="#PHCalculations.find_mass_features_ph-1161"><span class="linenos">1161</span></a><span class="sd">        ms_level : int, optional</span>
</span><span id="PHCalculations.find_mass_features_ph-1162"><a href="#PHCalculations.find_mass_features_ph-1162"><span class="linenos">1162</span></a><span class="sd">            The MS level to use. Default is 1.</span>
</span><span id="PHCalculations.find_mass_features_ph-1163"><a href="#PHCalculations.find_mass_features_ph-1163"><span class="linenos">1163</span></a><span class="sd">        grid : bool, optional</span>
</span><span id="PHCalculations.find_mass_features_ph-1164"><a href="#PHCalculations.find_mass_features_ph-1164"><span class="linenos">1164</span></a><span class="sd">            If True, will regrid the data before running the persistent homology calculations (after checking if the data is gridded). Default is True.</span>
</span><span id="PHCalculations.find_mass_features_ph-1165"><a href="#PHCalculations.find_mass_features_ph-1165"><span class="linenos">1165</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1166"><a href="#PHCalculations.find_mass_features_ph-1166"><span class="linenos">1166</span></a><span class="sd">        Raises</span>
</span><span id="PHCalculations.find_mass_features_ph-1167"><a href="#PHCalculations.find_mass_features_ph-1167"><span class="linenos">1167</span></a><span class="sd">        ------</span>
</span><span id="PHCalculations.find_mass_features_ph-1168"><a href="#PHCalculations.find_mass_features_ph-1168"><span class="linenos">1168</span></a><span class="sd">        ValueError</span>
</span><span id="PHCalculations.find_mass_features_ph-1169"><a href="#PHCalculations.find_mass_features_ph-1169"><span class="linenos">1169</span></a><span class="sd">            If no MS level data is found on the object.</span>
</span><span id="PHCalculations.find_mass_features_ph-1170"><a href="#PHCalculations.find_mass_features_ph-1170"><span class="linenos">1170</span></a><span class="sd">            If data is not gridded and grid is False.</span>
</span><span id="PHCalculations.find_mass_features_ph-1171"><a href="#PHCalculations.find_mass_features_ph-1171"><span class="linenos">1171</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1172"><a href="#PHCalculations.find_mass_features_ph-1172"><span class="linenos">1172</span></a><span class="sd">        Returns</span>
</span><span id="PHCalculations.find_mass_features_ph-1173"><a href="#PHCalculations.find_mass_features_ph-1173"><span class="linenos">1173</span></a><span class="sd">        -------</span>
</span><span id="PHCalculations.find_mass_features_ph-1174"><a href="#PHCalculations.find_mass_features_ph-1174"><span class="linenos">1174</span></a><span class="sd">        None, but assigns the mass_features attribute to the object.</span>
</span><span id="PHCalculations.find_mass_features_ph-1175"><a href="#PHCalculations.find_mass_features_ph-1175"><span class="linenos">1175</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1176"><a href="#PHCalculations.find_mass_features_ph-1176"><span class="linenos">1176</span></a><span class="sd">        Notes</span>
</span><span id="PHCalculations.find_mass_features_ph-1177"><a href="#PHCalculations.find_mass_features_ph-1177"><span class="linenos">1177</span></a><span class="sd">        -----</span>
</span><span id="PHCalculations.find_mass_features_ph-1178"><a href="#PHCalculations.find_mass_features_ph-1178"><span class="linenos">1178</span></a><span class="sd">        This function has been adapted from the original implementation in the Deimos package: https://github.com/pnnl/deimos</span>
</span><span id="PHCalculations.find_mass_features_ph-1179"><a href="#PHCalculations.find_mass_features_ph-1179"><span class="linenos">1179</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PHCalculations.find_mass_features_ph-1180"><a href="#PHCalculations.find_mass_features_ph-1180"><span class="linenos">1180</span></a>        <span class="c1"># Check that ms_level is a key in self._ms_uprocessed</span>
</span><span id="PHCalculations.find_mass_features_ph-1181"><a href="#PHCalculations.find_mass_features_ph-1181"><span class="linenos">1181</span></a>        <span class="k">if</span> <span class="n">ms_level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="PHCalculations.find_mass_features_ph-1182"><a href="#PHCalculations.find_mass_features_ph-1182"><span class="linenos">1182</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PHCalculations.find_mass_features_ph-1183"><a href="#PHCalculations.find_mass_features_ph-1183"><span class="linenos">1183</span></a>                <span class="s2">&quot;No MS level &quot;</span>
</span><span id="PHCalculations.find_mass_features_ph-1184"><a href="#PHCalculations.find_mass_features_ph-1184"><span class="linenos">1184</span></a>                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ms_level</span><span class="p">)</span>
</span><span id="PHCalculations.find_mass_features_ph-1185"><a href="#PHCalculations.find_mass_features_ph-1185"><span class="linenos">1185</span></a>                <span class="o">+</span> <span class="s2">&quot; data found, did you instantiate with parser specific to MS level?&quot;</span>
</span><span id="PHCalculations.find_mass_features_ph-1186"><a href="#PHCalculations.find_mass_features_ph-1186"><span class="linenos">1186</span></a>            <span class="p">)</span>
</span><span id="PHCalculations.find_mass_features_ph-1187"><a href="#PHCalculations.find_mass_features_ph-1187"><span class="linenos">1187</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1188"><a href="#PHCalculations.find_mass_features_ph-1188"><span class="linenos">1188</span></a>        <span class="c1"># Get ms data</span>
</span><span id="PHCalculations.find_mass_features_ph-1189"><a href="#PHCalculations.find_mass_features_ph-1189"><span class="linenos">1189</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ms_unprocessed</span><span class="p">[</span><span class="n">ms_level</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations.find_mass_features_ph-1190"><a href="#PHCalculations.find_mass_features_ph-1190"><span class="linenos">1190</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1191"><a href="#PHCalculations.find_mass_features_ph-1191"><span class="linenos">1191</span></a>        <span class="c1"># Drop rows with missing intensity values and reset index</span>
</span><span id="PHCalculations.find_mass_features_ph-1192"><a href="#PHCalculations.find_mass_features_ph-1192"><span class="linenos">1192</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations.find_mass_features_ph-1193"><a href="#PHCalculations.find_mass_features_ph-1193"><span class="linenos">1193</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1194"><a href="#PHCalculations.find_mass_features_ph-1194"><span class="linenos">1194</span></a>        <span class="c1"># Threshold data</span>
</span><span id="PHCalculations.find_mass_features_ph-1195"><a href="#PHCalculations.find_mass_features_ph-1195"><span class="linenos">1195</span></a>        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]</span>
</span><span id="PHCalculations.find_mass_features_ph-1196"><a href="#PHCalculations.find_mass_features_ph-1196"><span class="linenos">1196</span></a>        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ph_inten_min_rel</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">intensity</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="PHCalculations.find_mass_features_ph-1197"><a href="#PHCalculations.find_mass_features_ph-1197"><span class="linenos">1197</span></a>        <span class="n">data_thres</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations.find_mass_features_ph-1198"><a href="#PHCalculations.find_mass_features_ph-1198"><span class="linenos">1198</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1199"><a href="#PHCalculations.find_mass_features_ph-1199"><span class="linenos">1199</span></a>        <span class="c1"># Check if gridded, if not, grid</span>
</span><span id="PHCalculations.find_mass_features_ph-1200"><a href="#PHCalculations.find_mass_features_ph-1200"><span class="linenos">1200</span></a>        <span class="n">gridded_mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_if_grid</span><span class="p">(</span><span class="n">data_thres</span><span class="p">)</span>
</span><span id="PHCalculations.find_mass_features_ph-1201"><a href="#PHCalculations.find_mass_features_ph-1201"><span class="linenos">1201</span></a>        <span class="k">if</span> <span class="n">gridded_mz</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="PHCalculations.find_mass_features_ph-1202"><a href="#PHCalculations.find_mass_features_ph-1202"><span class="linenos">1202</span></a>            <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="PHCalculations.find_mass_features_ph-1203"><a href="#PHCalculations.find_mass_features_ph-1203"><span class="linenos">1203</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PHCalculations.find_mass_features_ph-1204"><a href="#PHCalculations.find_mass_features_ph-1204"><span class="linenos">1204</span></a>                    <span class="s2">&quot;Data are not gridded in mz dimension, try reprocessing with a different params or grid data before running this function&quot;</span>
</span><span id="PHCalculations.find_mass_features_ph-1205"><a href="#PHCalculations.find_mass_features_ph-1205"><span class="linenos">1205</span></a>                <span class="p">)</span>
</span><span id="PHCalculations.find_mass_features_ph-1206"><a href="#PHCalculations.find_mass_features_ph-1206"><span class="linenos">1206</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PHCalculations.find_mass_features_ph-1207"><a href="#PHCalculations.find_mass_features_ph-1207"><span class="linenos">1207</span></a>                <span class="n">data_thres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_data</span><span class="p">(</span><span class="n">data_thres</span><span class="p">)</span>
</span><span id="PHCalculations.find_mass_features_ph-1208"><a href="#PHCalculations.find_mass_features_ph-1208"><span class="linenos">1208</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1209"><a href="#PHCalculations.find_mass_features_ph-1209"><span class="linenos">1209</span></a>        <span class="c1"># Add build factors and add scan_time</span>
</span><span id="PHCalculations.find_mass_features_ph-1210"><a href="#PHCalculations.find_mass_features_ph-1210"><span class="linenos">1210</span></a>        <span class="n">data_thres</span> <span class="o">=</span> <span class="n">data_thres</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_df</span><span class="p">[[</span><span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;scan&quot;</span><span class="p">)</span>
</span><span id="PHCalculations.find_mass_features_ph-1211"><a href="#PHCalculations.find_mass_features_ph-1211"><span class="linenos">1211</span></a>        <span class="n">factors</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="PHCalculations.find_mass_features_ph-1212"><a href="#PHCalculations.find_mass_features_ph-1212"><span class="linenos">1212</span></a>            <span class="n">dim</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">factorize</span><span class="p">(</span><span class="n">data_thres</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="PHCalculations.find_mass_features_ph-1213"><a href="#PHCalculations.find_mass_features_ph-1213"><span class="linenos">1213</span></a>            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dims</span>
</span><span id="PHCalculations.find_mass_features_ph-1214"><a href="#PHCalculations.find_mass_features_ph-1214"><span class="linenos">1214</span></a>        <span class="p">}</span>  <span class="c1"># this is return a float64 index</span>
</span><span id="PHCalculations.find_mass_features_ph-1215"><a href="#PHCalculations.find_mass_features_ph-1215"><span class="linenos">1215</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1216"><a href="#PHCalculations.find_mass_features_ph-1216"><span class="linenos">1216</span></a>        <span class="c1"># Build indexes</span>
</span><span id="PHCalculations.find_mass_features_ph-1217"><a href="#PHCalculations.find_mass_features_ph-1217"><span class="linenos">1217</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="PHCalculations.find_mass_features_ph-1218"><a href="#PHCalculations.find_mass_features_ph-1218"><span class="linenos">1218</span></a>            <span class="n">dim</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">factors</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="n">data_thres</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="PHCalculations.find_mass_features_ph-1219"><a href="#PHCalculations.find_mass_features_ph-1219"><span class="linenos">1219</span></a>            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">factors</span>
</span><span id="PHCalculations.find_mass_features_ph-1220"><a href="#PHCalculations.find_mass_features_ph-1220"><span class="linenos">1220</span></a>        <span class="p">}</span>
</span><span id="PHCalculations.find_mass_features_ph-1221"><a href="#PHCalculations.find_mass_features_ph-1221"><span class="linenos">1221</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1222"><a href="#PHCalculations.find_mass_features_ph-1222"><span class="linenos">1222</span></a>        <span class="c1"># Smooth data</span>
</span><span id="PHCalculations.find_mass_features_ph-1223"><a href="#PHCalculations.find_mass_features_ph-1223"><span class="linenos">1223</span></a>        <span class="n">iterations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ph_smooth_it</span>
</span><span id="PHCalculations.find_mass_features_ph-1224"><a href="#PHCalculations.find_mass_features_ph-1224"><span class="linenos">1224</span></a>        <span class="n">smooth_radius</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="PHCalculations.find_mass_features_ph-1225"><a href="#PHCalculations.find_mass_features_ph-1225"><span class="linenos">1225</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ph_smooth_radius_mz</span><span class="p">,</span>
</span><span id="PHCalculations.find_mass_features_ph-1226"><a href="#PHCalculations.find_mass_features_ph-1226"><span class="linenos">1226</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ph_smooth_radius_scan</span><span class="p">,</span>
</span><span id="PHCalculations.find_mass_features_ph-1227"><a href="#PHCalculations.find_mass_features_ph-1227"><span class="linenos">1227</span></a>        <span class="p">]</span>  <span class="c1"># mz, scan_time smoothing radius (in steps)</span>
</span><span id="PHCalculations.find_mass_features_ph-1228"><a href="#PHCalculations.find_mass_features_ph-1228"><span class="linenos">1228</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1229"><a href="#PHCalculations.find_mass_features_ph-1229"><span class="linenos">1229</span></a>        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">index</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dims</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="PHCalculations.find_mass_features_ph-1230"><a href="#PHCalculations.find_mass_features_ph-1230"><span class="linenos">1230</span></a>        <span class="n">V</span> <span class="o">=</span> <span class="n">data_thres</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span><span id="PHCalculations.find_mass_features_ph-1231"><a href="#PHCalculations.find_mass_features_ph-1231"><span class="linenos">1231</span></a>        <span class="n">resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="PHCalculations.find_mass_features_ph-1232"><a href="#PHCalculations.find_mass_features_ph-1232"><span class="linenos">1232</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
</span><span id="PHCalculations.find_mass_features_ph-1233"><a href="#PHCalculations.find_mass_features_ph-1233"><span class="linenos">1233</span></a>            <span class="c1"># Previous iteration</span>
</span><span id="PHCalculations.find_mass_features_ph-1234"><a href="#PHCalculations.find_mass_features_ph-1234"><span class="linenos">1234</span></a>            <span class="n">V_prev</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations.find_mass_features_ph-1235"><a href="#PHCalculations.find_mass_features_ph-1235"><span class="linenos">1235</span></a>            <span class="n">resid_prev</span> <span class="o">=</span> <span class="n">resid</span>
</span><span id="PHCalculations.find_mass_features_ph-1236"><a href="#PHCalculations.find_mass_features_ph-1236"><span class="linenos">1236</span></a>            <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_mean_filter</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">smooth_radius</span><span class="p">)</span>
</span><span id="PHCalculations.find_mass_features_ph-1237"><a href="#PHCalculations.find_mass_features_ph-1237"><span class="linenos">1237</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1238"><a href="#PHCalculations.find_mass_features_ph-1238"><span class="linenos">1238</span></a>            <span class="c1"># Calculate residual with previous iteration</span>
</span><span id="PHCalculations.find_mass_features_ph-1239"><a href="#PHCalculations.find_mass_features_ph-1239"><span class="linenos">1239</span></a>            <span class="n">resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">V</span> <span class="o">-</span> <span class="n">V_prev</span><span class="p">)))</span>
</span><span id="PHCalculations.find_mass_features_ph-1240"><a href="#PHCalculations.find_mass_features_ph-1240"><span class="linenos">1240</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1241"><a href="#PHCalculations.find_mass_features_ph-1241"><span class="linenos">1241</span></a>            <span class="c1"># Evaluate convergence</span>
</span><span id="PHCalculations.find_mass_features_ph-1242"><a href="#PHCalculations.find_mass_features_ph-1242"><span class="linenos">1242</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PHCalculations.find_mass_features_ph-1243"><a href="#PHCalculations.find_mass_features_ph-1243"><span class="linenos">1243</span></a>                <span class="c1"># Percent change in residual</span>
</span><span id="PHCalculations.find_mass_features_ph-1244"><a href="#PHCalculations.find_mass_features_ph-1244"><span class="linenos">1244</span></a>                <span class="n">test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">resid</span> <span class="o">-</span> <span class="n">resid_prev</span><span class="p">)</span> <span class="o">/</span> <span class="n">resid_prev</span>
</span><span id="PHCalculations.find_mass_features_ph-1245"><a href="#PHCalculations.find_mass_features_ph-1245"><span class="linenos">1245</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1246"><a href="#PHCalculations.find_mass_features_ph-1246"><span class="linenos">1246</span></a>                <span class="c1"># Exit criteria</span>
</span><span id="PHCalculations.find_mass_features_ph-1247"><a href="#PHCalculations.find_mass_features_ph-1247"><span class="linenos">1247</span></a>                <span class="k">if</span> <span class="n">test</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PHCalculations.find_mass_features_ph-1248"><a href="#PHCalculations.find_mass_features_ph-1248"><span class="linenos">1248</span></a>                    <span class="k">break</span>
</span><span id="PHCalculations.find_mass_features_ph-1249"><a href="#PHCalculations.find_mass_features_ph-1249"><span class="linenos">1249</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1250"><a href="#PHCalculations.find_mass_features_ph-1250"><span class="linenos">1250</span></a>        <span class="c1"># Overwrite values</span>
</span><span id="PHCalculations.find_mass_features_ph-1251"><a href="#PHCalculations.find_mass_features_ph-1251"><span class="linenos">1251</span></a>        <span class="n">data_thres</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">V</span>
</span><span id="PHCalculations.find_mass_features_ph-1252"><a href="#PHCalculations.find_mass_features_ph-1252"><span class="linenos">1252</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1253"><a href="#PHCalculations.find_mass_features_ph-1253"><span class="linenos">1253</span></a>        <span class="c1"># Use persistent homology to find regions of interest</span>
</span><span id="PHCalculations.find_mass_features_ph-1254"><a href="#PHCalculations.find_mass_features_ph-1254"><span class="linenos">1254</span></a>        <span class="n">pidx</span><span class="p">,</span> <span class="n">pers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_upper_star</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span>
</span><span id="PHCalculations.find_mass_features_ph-1255"><a href="#PHCalculations.find_mass_features_ph-1255"><span class="linenos">1255</span></a>        <span class="n">pidx</span> <span class="o">=</span> <span class="n">pidx</span><span class="p">[</span><span class="n">pers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="PHCalculations.find_mass_features_ph-1256"><a href="#PHCalculations.find_mass_features_ph-1256"><span class="linenos">1256</span></a>        <span class="n">pers</span> <span class="o">=</span> <span class="n">pers</span><span class="p">[</span><span class="n">pers</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="PHCalculations.find_mass_features_ph-1257"><a href="#PHCalculations.find_mass_features_ph-1257"><span class="linenos">1257</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1258"><a href="#PHCalculations.find_mass_features_ph-1258"><span class="linenos">1258</span></a>        <span class="c1"># Get peaks</span>
</span><span id="PHCalculations.find_mass_features_ph-1259"><a href="#PHCalculations.find_mass_features_ph-1259"><span class="linenos">1259</span></a>        <span class="n">peaks</span> <span class="o">=</span> <span class="n">data_thres</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">pidx</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations.find_mass_features_ph-1260"><a href="#PHCalculations.find_mass_features_ph-1260"><span class="linenos">1260</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1261"><a href="#PHCalculations.find_mass_features_ph-1261"><span class="linenos">1261</span></a>        <span class="c1"># Add persistence column</span>
</span><span id="PHCalculations.find_mass_features_ph-1262"><a href="#PHCalculations.find_mass_features_ph-1262"><span class="linenos">1262</span></a>        <span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;persistence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pers</span>
</span><span id="PHCalculations.find_mass_features_ph-1263"><a href="#PHCalculations.find_mass_features_ph-1263"><span class="linenos">1263</span></a>        <span class="n">mass_features</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
</span><span id="PHCalculations.find_mass_features_ph-1264"><a href="#PHCalculations.find_mass_features_ph-1264"><span class="linenos">1264</span></a>            <span class="n">by</span><span class="o">=</span><span class="s2">&quot;persistence&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
</span><span id="PHCalculations.find_mass_features_ph-1265"><a href="#PHCalculations.find_mass_features_ph-1265"><span class="linenos">1265</span></a>        <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations.find_mass_features_ph-1266"><a href="#PHCalculations.find_mass_features_ph-1266"><span class="linenos">1266</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1267"><a href="#PHCalculations.find_mass_features_ph-1267"><span class="linenos">1267</span></a>        <span class="c1"># Filter by persistence threshold</span>
</span><span id="PHCalculations.find_mass_features_ph-1268"><a href="#PHCalculations.find_mass_features_ph-1268"><span class="linenos">1268</span></a>        <span class="n">persistence_threshold</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="PHCalculations.find_mass_features_ph-1269"><a href="#PHCalculations.find_mass_features_ph-1269"><span class="linenos">1269</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">ph_persis_min_rel</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">intensity</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="PHCalculations.find_mass_features_ph-1270"><a href="#PHCalculations.find_mass_features_ph-1270"><span class="linenos">1270</span></a>        <span class="p">)</span>
</span><span id="PHCalculations.find_mass_features_ph-1271"><a href="#PHCalculations.find_mass_features_ph-1271"><span class="linenos">1271</span></a>        <span class="n">mass_features</span> <span class="o">=</span> <span class="n">mass_features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
</span><span id="PHCalculations.find_mass_features_ph-1272"><a href="#PHCalculations.find_mass_features_ph-1272"><span class="linenos">1272</span></a>            <span class="n">mass_features</span><span class="p">[</span><span class="s2">&quot;persistence&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">persistence_threshold</span><span class="p">,</span> <span class="p">:</span>
</span><span id="PHCalculations.find_mass_features_ph-1273"><a href="#PHCalculations.find_mass_features_ph-1273"><span class="linenos">1273</span></a>        <span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PHCalculations.find_mass_features_ph-1274"><a href="#PHCalculations.find_mass_features_ph-1274"><span class="linenos">1274</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1275"><a href="#PHCalculations.find_mass_features_ph-1275"><span class="linenos">1275</span></a>        <span class="c1"># Rename scan column to apex_scan</span>
</span><span id="PHCalculations.find_mass_features_ph-1276"><a href="#PHCalculations.find_mass_features_ph-1276"><span class="linenos">1276</span></a>        <span class="n">mass_features</span> <span class="o">=</span> <span class="n">mass_features</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
</span><span id="PHCalculations.find_mass_features_ph-1277"><a href="#PHCalculations.find_mass_features_ph-1277"><span class="linenos">1277</span></a>            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;scan&quot;</span><span class="p">:</span> <span class="s2">&quot;apex_scan&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">:</span> <span class="s2">&quot;retention_time&quot;</span><span class="p">}</span>
</span><span id="PHCalculations.find_mass_features_ph-1278"><a href="#PHCalculations.find_mass_features_ph-1278"><span class="linenos">1278</span></a>        <span class="p">)</span>
</span><span id="PHCalculations.find_mass_features_ph-1279"><a href="#PHCalculations.find_mass_features_ph-1279"><span class="linenos">1279</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1280"><a href="#PHCalculations.find_mass_features_ph-1280"><span class="linenos">1280</span></a>        <span class="c1"># Populate mass_features attribute</span>
</span><span id="PHCalculations.find_mass_features_ph-1281"><a href="#PHCalculations.find_mass_features_ph-1281"><span class="linenos">1281</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="PHCalculations.find_mass_features_ph-1282"><a href="#PHCalculations.find_mass_features_ph-1282"><span class="linenos">1282</span></a>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">mass_features</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
</span><span id="PHCalculations.find_mass_features_ph-1283"><a href="#PHCalculations.find_mass_features_ph-1283"><span class="linenos">1283</span></a>            <span class="n">row_dict</span> <span class="o">=</span> <span class="n">mass_features</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Index</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</span><span id="PHCalculations.find_mass_features_ph-1284"><a href="#PHCalculations.find_mass_features_ph-1284"><span class="linenos">1284</span></a>            <span class="n">lcms_feature</span> <span class="o">=</span> <span class="n">LCMSMassFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">row_dict</span><span class="p">)</span>
</span><span id="PHCalculations.find_mass_features_ph-1285"><a href="#PHCalculations.find_mass_features_ph-1285"><span class="linenos">1285</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">[</span><span class="n">lcms_feature</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">lcms_feature</span>
</span><span id="PHCalculations.find_mass_features_ph-1286"><a href="#PHCalculations.find_mass_features_ph-1286"><span class="linenos">1286</span></a>
</span><span id="PHCalculations.find_mass_features_ph-1287"><a href="#PHCalculations.find_mass_features_ph-1287"><span class="linenos">1287</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">verbose_processing</span><span class="p">:</span>
</span><span id="PHCalculations.find_mass_features_ph-1288"><a href="#PHCalculations.find_mass_features_ph-1288"><span class="linenos">1288</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mass_features</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; initial mass features&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Find mass features within an LCMSBase object using persistent homology.</p>

<p>Assigns the mass_features attribute to the object (a dictionary of LCMSMassFeature objects, keyed by mass feature id)</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>ms_level</strong> (int, optional):
The MS level to use. Default is 1.</li>
<li><strong>grid</strong> (bool, optional):
If True, will regrid the data before running the persistent homology calculations (after checking if the data is gridded). Default is True.</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>ValueError</strong>: If no MS level data is found on the object.
If data is not gridded and grid is False.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None, but assigns the mass_features attribute to the object.</strong></li>
</ul>

<h6 id="notes">Notes</h6>

<p>This function has been adapted from the original implementation in the Deimos package: <a href="https://github.com/pnnl/deimos">https://github.com/pnnl/deimos</a></p>
</div>


                            </div>
                            <div id="PHCalculations.cluster_mass_features" class="classattr">
                                        <input id="PHCalculations.cluster_mass_features-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cluster_mass_features</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">drop_children</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">sort_by</span><span class="o">=</span><span class="s1">&#39;persistence&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PHCalculations.cluster_mass_features-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PHCalculations.cluster_mass_features"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PHCalculations.cluster_mass_features-1290"><a href="#PHCalculations.cluster_mass_features-1290"><span class="linenos">1290</span></a>    <span class="k">def</span> <span class="nf">cluster_mass_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drop_children</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort_by</span><span class="o">=</span><span class="s2">&quot;persistence&quot;</span><span class="p">):</span>
</span><span id="PHCalculations.cluster_mass_features-1291"><a href="#PHCalculations.cluster_mass_features-1291"><span class="linenos">1291</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Cluster mass features</span>
</span><span id="PHCalculations.cluster_mass_features-1292"><a href="#PHCalculations.cluster_mass_features-1292"><span class="linenos">1292</span></a>
</span><span id="PHCalculations.cluster_mass_features-1293"><a href="#PHCalculations.cluster_mass_features-1293"><span class="linenos">1293</span></a><span class="sd">        Based on their proximity in the mz and scan_time dimensions, priorizies the mass features with the highest persistence.</span>
</span><span id="PHCalculations.cluster_mass_features-1294"><a href="#PHCalculations.cluster_mass_features-1294"><span class="linenos">1294</span></a>
</span><span id="PHCalculations.cluster_mass_features-1295"><a href="#PHCalculations.cluster_mass_features-1295"><span class="linenos">1295</span></a><span class="sd">        Parameters</span>
</span><span id="PHCalculations.cluster_mass_features-1296"><a href="#PHCalculations.cluster_mass_features-1296"><span class="linenos">1296</span></a><span class="sd">        ----------</span>
</span><span id="PHCalculations.cluster_mass_features-1297"><a href="#PHCalculations.cluster_mass_features-1297"><span class="linenos">1297</span></a><span class="sd">        drop_children : bool, optional</span>
</span><span id="PHCalculations.cluster_mass_features-1298"><a href="#PHCalculations.cluster_mass_features-1298"><span class="linenos">1298</span></a><span class="sd">            Whether to drop the mass features that are not cluster parents. Default is True.</span>
</span><span id="PHCalculations.cluster_mass_features-1299"><a href="#PHCalculations.cluster_mass_features-1299"><span class="linenos">1299</span></a><span class="sd">        sort_by : str, optional</span>
</span><span id="PHCalculations.cluster_mass_features-1300"><a href="#PHCalculations.cluster_mass_features-1300"><span class="linenos">1300</span></a><span class="sd">            The column to sort the mass features by, this will determine which mass features get rolled up into a parent mass feature. Default is &quot;persistence&quot;.</span>
</span><span id="PHCalculations.cluster_mass_features-1301"><a href="#PHCalculations.cluster_mass_features-1301"><span class="linenos">1301</span></a>
</span><span id="PHCalculations.cluster_mass_features-1302"><a href="#PHCalculations.cluster_mass_features-1302"><span class="linenos">1302</span></a><span class="sd">        Raises</span>
</span><span id="PHCalculations.cluster_mass_features-1303"><a href="#PHCalculations.cluster_mass_features-1303"><span class="linenos">1303</span></a><span class="sd">        ------</span>
</span><span id="PHCalculations.cluster_mass_features-1304"><a href="#PHCalculations.cluster_mass_features-1304"><span class="linenos">1304</span></a><span class="sd">        ValueError</span>
</span><span id="PHCalculations.cluster_mass_features-1305"><a href="#PHCalculations.cluster_mass_features-1305"><span class="linenos">1305</span></a><span class="sd">            If no mass features are found.</span>
</span><span id="PHCalculations.cluster_mass_features-1306"><a href="#PHCalculations.cluster_mass_features-1306"><span class="linenos">1306</span></a><span class="sd">            If too many mass features are found.</span>
</span><span id="PHCalculations.cluster_mass_features-1307"><a href="#PHCalculations.cluster_mass_features-1307"><span class="linenos">1307</span></a>
</span><span id="PHCalculations.cluster_mass_features-1308"><a href="#PHCalculations.cluster_mass_features-1308"><span class="linenos">1308</span></a><span class="sd">        Returns</span>
</span><span id="PHCalculations.cluster_mass_features-1309"><a href="#PHCalculations.cluster_mass_features-1309"><span class="linenos">1309</span></a><span class="sd">        -------</span>
</span><span id="PHCalculations.cluster_mass_features-1310"><a href="#PHCalculations.cluster_mass_features-1310"><span class="linenos">1310</span></a><span class="sd">        None if drop_children is True, otherwise returns a list of mass feature ids that are not cluster parents.</span>
</span><span id="PHCalculations.cluster_mass_features-1311"><a href="#PHCalculations.cluster_mass_features-1311"><span class="linenos">1311</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="PHCalculations.cluster_mass_features-1312"><a href="#PHCalculations.cluster_mass_features-1312"><span class="linenos">1312</span></a>        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">verbose_processing</span>
</span><span id="PHCalculations.cluster_mass_features-1313"><a href="#PHCalculations.cluster_mass_features-1313"><span class="linenos">1313</span></a>
</span><span id="PHCalculations.cluster_mass_features-1314"><a href="#PHCalculations.cluster_mass_features-1314"><span class="linenos">1314</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PHCalculations.cluster_mass_features-1315"><a href="#PHCalculations.cluster_mass_features-1315"><span class="linenos">1315</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No mass features found, run find_mass_features() first&quot;</span><span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1316"><a href="#PHCalculations.cluster_mass_features-1316"><span class="linenos">1316</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">400000</span><span class="p">:</span>
</span><span id="PHCalculations.cluster_mass_features-1317"><a href="#PHCalculations.cluster_mass_features-1317"><span class="linenos">1317</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="PHCalculations.cluster_mass_features-1318"><a href="#PHCalculations.cluster_mass_features-1318"><span class="linenos">1318</span></a>                <span class="s2">&quot;Too many mass featuers of interest found, run find_mass_features() with a higher intensity threshold&quot;</span>
</span><span id="PHCalculations.cluster_mass_features-1319"><a href="#PHCalculations.cluster_mass_features-1319"><span class="linenos">1319</span></a>            <span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1320"><a href="#PHCalculations.cluster_mass_features-1320"><span class="linenos">1320</span></a>        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;scan_time&quot;</span><span class="p">]</span>
</span><span id="PHCalculations.cluster_mass_features-1321"><a href="#PHCalculations.cluster_mass_features-1321"><span class="linenos">1321</span></a>        <span class="n">mf_df_og</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features_to_df</span><span class="p">()</span>
</span><span id="PHCalculations.cluster_mass_features-1322"><a href="#PHCalculations.cluster_mass_features-1322"><span class="linenos">1322</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df_og</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations.cluster_mass_features-1323"><a href="#PHCalculations.cluster_mass_features-1323"><span class="linenos">1323</span></a>
</span><span id="PHCalculations.cluster_mass_features-1324"><a href="#PHCalculations.cluster_mass_features-1324"><span class="linenos">1324</span></a>        <span class="c1"># Sort mass features by sort_by column, make mf_id its own column for easier bookkeeping</span>
</span><span id="PHCalculations.cluster_mass_features-1325"><a href="#PHCalculations.cluster_mass_features-1325"><span class="linenos">1325</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">sort_by</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1326"><a href="#PHCalculations.cluster_mass_features-1326"><span class="linenos">1326</span></a>
</span><span id="PHCalculations.cluster_mass_features-1327"><a href="#PHCalculations.cluster_mass_features-1327"><span class="linenos">1327</span></a>        <span class="n">tol</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="PHCalculations.cluster_mass_features-1328"><a href="#PHCalculations.cluster_mass_features-1328"><span class="linenos">1328</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_mz_tolerance_rel</span><span class="p">,</span>
</span><span id="PHCalculations.cluster_mass_features-1329"><a href="#PHCalculations.cluster_mass_features-1329"><span class="linenos">1329</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lc_ms</span><span class="o">.</span><span class="n">mass_feature_cluster_rt_tolerance</span><span class="p">,</span>
</span><span id="PHCalculations.cluster_mass_features-1330"><a href="#PHCalculations.cluster_mass_features-1330"><span class="linenos">1330</span></a>        <span class="p">]</span>  <span class="c1"># mz, in relative; scan_time in minutes</span>
</span><span id="PHCalculations.cluster_mass_features-1331"><a href="#PHCalculations.cluster_mass_features-1331"><span class="linenos">1331</span></a>        <span class="n">relative</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
</span><span id="PHCalculations.cluster_mass_features-1332"><a href="#PHCalculations.cluster_mass_features-1332"><span class="linenos">1332</span></a>
</span><span id="PHCalculations.cluster_mass_features-1333"><a href="#PHCalculations.cluster_mass_features-1333"><span class="linenos">1333</span></a>        <span class="c1"># Compute inter-feature distances</span>
</span><span id="PHCalculations.cluster_mass_features-1334"><a href="#PHCalculations.cluster_mass_features-1334"><span class="linenos">1334</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="PHCalculations.cluster_mass_features-1335"><a href="#PHCalculations.cluster_mass_features-1335"><span class="linenos">1335</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)):</span>
</span><span id="PHCalculations.cluster_mass_features-1336"><a href="#PHCalculations.cluster_mass_features-1336"><span class="linenos">1336</span></a>            <span class="c1"># Construct k-d tree</span>
</span><span id="PHCalculations.cluster_mass_features-1337"><a href="#PHCalculations.cluster_mass_features-1337"><span class="linenos">1337</span></a>            <span class="n">values</span> <span class="o">=</span> <span class="n">mf_df</span><span class="p">[</span><span class="n">dims</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</span><span id="PHCalculations.cluster_mass_features-1338"><a href="#PHCalculations.cluster_mass_features-1338"><span class="linenos">1338</span></a>            <span class="n">tree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span><span id="PHCalculations.cluster_mass_features-1339"><a href="#PHCalculations.cluster_mass_features-1339"><span class="linenos">1339</span></a>
</span><span id="PHCalculations.cluster_mass_features-1340"><a href="#PHCalculations.cluster_mass_features-1340"><span class="linenos">1340</span></a>            <span class="n">max_tol</span> <span class="o">=</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="PHCalculations.cluster_mass_features-1341"><a href="#PHCalculations.cluster_mass_features-1341"><span class="linenos">1341</span></a>            <span class="k">if</span> <span class="n">relative</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="PHCalculations.cluster_mass_features-1342"><a href="#PHCalculations.cluster_mass_features-1342"><span class="linenos">1342</span></a>                <span class="c1"># Maximum absolute tolerance</span>
</span><span id="PHCalculations.cluster_mass_features-1343"><a href="#PHCalculations.cluster_mass_features-1343"><span class="linenos">1343</span></a>                <span class="n">max_tol</span> <span class="o">=</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="PHCalculations.cluster_mass_features-1344"><a href="#PHCalculations.cluster_mass_features-1344"><span class="linenos">1344</span></a>
</span><span id="PHCalculations.cluster_mass_features-1345"><a href="#PHCalculations.cluster_mass_features-1345"><span class="linenos">1345</span></a>            <span class="c1"># Compute sparse distance matrix</span>
</span><span id="PHCalculations.cluster_mass_features-1346"><a href="#PHCalculations.cluster_mass_features-1346"><span class="linenos">1346</span></a>            <span class="c1"># the larger the max_tol, the slower this operation is</span>
</span><span id="PHCalculations.cluster_mass_features-1347"><a href="#PHCalculations.cluster_mass_features-1347"><span class="linenos">1347</span></a>            <span class="n">sdm</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">sparse_distance_matrix</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">max_tol</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;coo_matrix&quot;</span><span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1348"><a href="#PHCalculations.cluster_mass_features-1348"><span class="linenos">1348</span></a>
</span><span id="PHCalculations.cluster_mass_features-1349"><a href="#PHCalculations.cluster_mass_features-1349"><span class="linenos">1349</span></a>            <span class="c1"># Only consider forward case, exclude diagonal</span>
</span><span id="PHCalculations.cluster_mass_features-1350"><a href="#PHCalculations.cluster_mass_features-1350"><span class="linenos">1350</span></a>            <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">sdm</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1351"><a href="#PHCalculations.cluster_mass_features-1351"><span class="linenos">1351</span></a>
</span><span id="PHCalculations.cluster_mass_features-1352"><a href="#PHCalculations.cluster_mass_features-1352"><span class="linenos">1352</span></a>            <span class="c1"># Filter relative distances</span>
</span><span id="PHCalculations.cluster_mass_features-1353"><a href="#PHCalculations.cluster_mass_features-1353"><span class="linenos">1353</span></a>            <span class="k">if</span> <span class="n">relative</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="PHCalculations.cluster_mass_features-1354"><a href="#PHCalculations.cluster_mass_features-1354"><span class="linenos">1354</span></a>                <span class="c1"># Compute relative distances</span>
</span><span id="PHCalculations.cluster_mass_features-1355"><a href="#PHCalculations.cluster_mass_features-1355"><span class="linenos">1355</span></a>                <span class="n">rel_dists</span> <span class="o">=</span> <span class="n">sdm</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="n">values</span><span class="p">[</span><span class="n">sdm</span><span class="o">.</span><span class="n">row</span><span class="p">]</span>  <span class="c1"># or col?</span>
</span><span id="PHCalculations.cluster_mass_features-1356"><a href="#PHCalculations.cluster_mass_features-1356"><span class="linenos">1356</span></a>
</span><span id="PHCalculations.cluster_mass_features-1357"><a href="#PHCalculations.cluster_mass_features-1357"><span class="linenos">1357</span></a>                <span class="c1"># Indices of relative distances less than tolerance</span>
</span><span id="PHCalculations.cluster_mass_features-1358"><a href="#PHCalculations.cluster_mass_features-1358"><span class="linenos">1358</span></a>                <span class="n">idx</span> <span class="o">=</span> <span class="n">rel_dists</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="PHCalculations.cluster_mass_features-1359"><a href="#PHCalculations.cluster_mass_features-1359"><span class="linenos">1359</span></a>
</span><span id="PHCalculations.cluster_mass_features-1360"><a href="#PHCalculations.cluster_mass_features-1360"><span class="linenos">1360</span></a>                <span class="c1"># Reconstruct sparse distance matrix</span>
</span><span id="PHCalculations.cluster_mass_features-1361"><a href="#PHCalculations.cluster_mass_features-1361"><span class="linenos">1361</span></a>                <span class="n">sdm</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">(</span>
</span><span id="PHCalculations.cluster_mass_features-1362"><a href="#PHCalculations.cluster_mass_features-1362"><span class="linenos">1362</span></a>                    <span class="p">(</span><span class="n">rel_dists</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">sdm</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">idx</span><span class="p">])),</span>
</span><span id="PHCalculations.cluster_mass_features-1363"><a href="#PHCalculations.cluster_mass_features-1363"><span class="linenos">1363</span></a>                    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span>
</span><span id="PHCalculations.cluster_mass_features-1364"><a href="#PHCalculations.cluster_mass_features-1364"><span class="linenos">1364</span></a>                <span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1365"><a href="#PHCalculations.cluster_mass_features-1365"><span class="linenos">1365</span></a>
</span><span id="PHCalculations.cluster_mass_features-1366"><a href="#PHCalculations.cluster_mass_features-1366"><span class="linenos">1366</span></a>            <span class="c1"># Cast as binary matrix</span>
</span><span id="PHCalculations.cluster_mass_features-1367"><a href="#PHCalculations.cluster_mass_features-1367"><span class="linenos">1367</span></a>            <span class="n">sdm</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sdm</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1368"><a href="#PHCalculations.cluster_mass_features-1368"><span class="linenos">1368</span></a>
</span><span id="PHCalculations.cluster_mass_features-1369"><a href="#PHCalculations.cluster_mass_features-1369"><span class="linenos">1369</span></a>            <span class="c1"># Stack distances</span>
</span><span id="PHCalculations.cluster_mass_features-1370"><a href="#PHCalculations.cluster_mass_features-1370"><span class="linenos">1370</span></a>            <span class="k">if</span> <span class="n">distances</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PHCalculations.cluster_mass_features-1371"><a href="#PHCalculations.cluster_mass_features-1371"><span class="linenos">1371</span></a>                <span class="n">distances</span> <span class="o">=</span> <span class="n">sdm</span>
</span><span id="PHCalculations.cluster_mass_features-1372"><a href="#PHCalculations.cluster_mass_features-1372"><span class="linenos">1372</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="PHCalculations.cluster_mass_features-1373"><a href="#PHCalculations.cluster_mass_features-1373"><span class="linenos">1373</span></a>                <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sdm</span><span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1374"><a href="#PHCalculations.cluster_mass_features-1374"><span class="linenos">1374</span></a>
</span><span id="PHCalculations.cluster_mass_features-1375"><a href="#PHCalculations.cluster_mass_features-1375"><span class="linenos">1375</span></a>        <span class="c1"># Extract indices of within-tolerance points</span>
</span><span id="PHCalculations.cluster_mass_features-1376"><a href="#PHCalculations.cluster_mass_features-1376"><span class="linenos">1376</span></a>        <span class="n">distances</span> <span class="o">=</span> <span class="n">distances</span><span class="o">.</span><span class="n">tocoo</span><span class="p">()</span>
</span><span id="PHCalculations.cluster_mass_features-1377"><a href="#PHCalculations.cluster_mass_features-1377"><span class="linenos">1377</span></a>        <span class="n">pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">distances</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">distances</span><span class="o">.</span><span class="n">col</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1378"><a href="#PHCalculations.cluster_mass_features-1378"><span class="linenos">1378</span></a>        <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;parent&quot;</span><span class="p">,</span> <span class="s2">&quot;child&quot;</span><span class="p">])</span>
</span><span id="PHCalculations.cluster_mass_features-1379"><a href="#PHCalculations.cluster_mass_features-1379"><span class="linenos">1379</span></a>        <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1380"><a href="#PHCalculations.cluster_mass_features-1380"><span class="linenos">1380</span></a>
</span><span id="PHCalculations.cluster_mass_features-1381"><a href="#PHCalculations.cluster_mass_features-1381"><span class="linenos">1381</span></a>        <span class="n">to_drop</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PHCalculations.cluster_mass_features-1382"><a href="#PHCalculations.cluster_mass_features-1382"><span class="linenos">1382</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span><span id="PHCalculations.cluster_mass_features-1383"><a href="#PHCalculations.cluster_mass_features-1383"><span class="linenos">1383</span></a>            <span class="c1"># Find root_parents and their children</span>
</span><span id="PHCalculations.cluster_mass_features-1384"><a href="#PHCalculations.cluster_mass_features-1384"><span class="linenos">1384</span></a>            <span class="n">root_parents</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span>
</span><span id="PHCalculations.cluster_mass_features-1385"><a href="#PHCalculations.cluster_mass_features-1385"><span class="linenos">1385</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pairs_df</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1386"><a href="#PHCalculations.cluster_mass_features-1386"><span class="linenos">1386</span></a>            <span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1387"><a href="#PHCalculations.cluster_mass_features-1387"><span class="linenos">1387</span></a>            <span class="n">children_of_roots</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">root_parents</span><span class="p">,</span> <span class="s2">&quot;child&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="PHCalculations.cluster_mass_features-1388"><a href="#PHCalculations.cluster_mass_features-1388"><span class="linenos">1388</span></a>            <span class="n">to_drop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to_drop</span><span class="p">,</span> <span class="n">children_of_roots</span><span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1389"><a href="#PHCalculations.cluster_mass_features-1389"><span class="linenos">1389</span></a>
</span><span id="PHCalculations.cluster_mass_features-1390"><a href="#PHCalculations.cluster_mass_features-1390"><span class="linenos">1390</span></a>            <span class="c1"># Remove root_children as possible parents from pairs_df for next iteration</span>
</span><span id="PHCalculations.cluster_mass_features-1391"><a href="#PHCalculations.cluster_mass_features-1391"><span class="linenos">1391</span></a>            <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">children_of_roots</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1392"><a href="#PHCalculations.cluster_mass_features-1392"><span class="linenos">1392</span></a>            <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;child&quot;</span><span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1393"><a href="#PHCalculations.cluster_mass_features-1393"><span class="linenos">1393</span></a>            <span class="c1"># Remove root_children as possible children from pairs_df for next iteration</span>
</span><span id="PHCalculations.cluster_mass_features-1394"><a href="#PHCalculations.cluster_mass_features-1394"><span class="linenos">1394</span></a>            <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">children_of_roots</span><span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1395"><a href="#PHCalculations.cluster_mass_features-1395"><span class="linenos">1395</span></a>
</span><span id="PHCalculations.cluster_mass_features-1396"><a href="#PHCalculations.cluster_mass_features-1396"><span class="linenos">1396</span></a>            <span class="c1"># Prepare for next iteration</span>
</span><span id="PHCalculations.cluster_mass_features-1397"><a href="#PHCalculations.cluster_mass_features-1397"><span class="linenos">1397</span></a>            <span class="n">pairs_df</span> <span class="o">=</span> <span class="n">pairs_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;parent&quot;</span><span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1398"><a href="#PHCalculations.cluster_mass_features-1398"><span class="linenos">1398</span></a>
</span><span id="PHCalculations.cluster_mass_features-1399"><a href="#PHCalculations.cluster_mass_features-1399"><span class="linenos">1399</span></a>        <span class="c1"># Drop mass features that are not cluster parents</span>
</span><span id="PHCalculations.cluster_mass_features-1400"><a href="#PHCalculations.cluster_mass_features-1400"><span class="linenos">1400</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">to_drop</span><span class="p">))</span>
</span><span id="PHCalculations.cluster_mass_features-1401"><a href="#PHCalculations.cluster_mass_features-1401"><span class="linenos">1401</span></a>
</span><span id="PHCalculations.cluster_mass_features-1402"><a href="#PHCalculations.cluster_mass_features-1402"><span class="linenos">1402</span></a>        <span class="c1"># Set index back to mf_id</span>
</span><span id="PHCalculations.cluster_mass_features-1403"><a href="#PHCalculations.cluster_mass_features-1403"><span class="linenos">1403</span></a>        <span class="n">mf_df</span> <span class="o">=</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;mf_id&quot;</span><span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1404"><a href="#PHCalculations.cluster_mass_features-1404"><span class="linenos">1404</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="PHCalculations.cluster_mass_features-1405"><a href="#PHCalculations.cluster_mass_features-1405"><span class="linenos">1405</span></a>            <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf_df</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; mass features remaining&quot;</span><span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1406"><a href="#PHCalculations.cluster_mass_features-1406"><span class="linenos">1406</span></a>
</span><span id="PHCalculations.cluster_mass_features-1407"><a href="#PHCalculations.cluster_mass_features-1407"><span class="linenos">1407</span></a>        <span class="n">mf_df_new</span> <span class="o">=</span> <span class="n">mf_df_og</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="PHCalculations.cluster_mass_features-1408"><a href="#PHCalculations.cluster_mass_features-1408"><span class="linenos">1408</span></a>        <span class="n">mf_df_new</span><span class="p">[</span><span class="s2">&quot;cluster_parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="PHCalculations.cluster_mass_features-1409"><a href="#PHCalculations.cluster_mass_features-1409"><span class="linenos">1409</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mf_df_new</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">mf_df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="PHCalculations.cluster_mass_features-1410"><a href="#PHCalculations.cluster_mass_features-1410"><span class="linenos">1410</span></a>        <span class="p">)</span>
</span><span id="PHCalculations.cluster_mass_features-1411"><a href="#PHCalculations.cluster_mass_features-1411"><span class="linenos">1411</span></a>
</span><span id="PHCalculations.cluster_mass_features-1412"><a href="#PHCalculations.cluster_mass_features-1412"><span class="linenos">1412</span></a>        <span class="c1"># get mass feature ids of features that are not cluster parents</span>
</span><span id="PHCalculations.cluster_mass_features-1413"><a href="#PHCalculations.cluster_mass_features-1413"><span class="linenos">1413</span></a>        <span class="n">cluster_daughters</span> <span class="o">=</span> <span class="n">mf_df_new</span><span class="p">[</span><span class="n">mf_df_new</span><span class="p">[</span><span class="s2">&quot;cluster_parent&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
</span><span id="PHCalculations.cluster_mass_features-1414"><a href="#PHCalculations.cluster_mass_features-1414"><span class="linenos">1414</span></a>        <span class="k">if</span> <span class="n">drop_children</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="PHCalculations.cluster_mass_features-1415"><a href="#PHCalculations.cluster_mass_features-1415"><span class="linenos">1415</span></a>            <span class="c1"># Drop mass features that are not cluster parents from self</span>
</span><span id="PHCalculations.cluster_mass_features-1416"><a href="#PHCalculations.cluster_mass_features-1416"><span class="linenos">1416</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="PHCalculations.cluster_mass_features-1417"><a href="#PHCalculations.cluster_mass_features-1417"><span class="linenos">1417</span></a>                <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
</span><span id="PHCalculations.cluster_mass_features-1418"><a href="#PHCalculations.cluster_mass_features-1418"><span class="linenos">1418</span></a>                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_features</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="PHCalculations.cluster_mass_features-1419"><a href="#PHCalculations.cluster_mass_features-1419"><span class="linenos">1419</span></a>                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cluster_daughters</span>
</span><span id="PHCalculations.cluster_mass_features-1420"><a href="#PHCalculations.cluster_mass_features-1420"><span class="linenos">1420</span></a>            <span class="p">}</span>
</span><span id="PHCalculations.cluster_mass_features-1421"><a href="#PHCalculations.cluster_mass_features-1421"><span class="linenos">1421</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="PHCalculations.cluster_mass_features-1422"><a href="#PHCalculations.cluster_mass_features-1422"><span class="linenos">1422</span></a>            <span class="k">return</span> <span class="n">cluster_daughters</span>
</span></pre></div>


            <div class="docstring"><p>Cluster mass features</p>

<p>Based on their proximity in the mz and scan_time dimensions, priorizies the mass features with the highest persistence.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>drop_children</strong> (bool, optional):
Whether to drop the mass features that are not cluster parents. Default is True.</li>
<li><strong>sort_by</strong> (str, optional):
The column to sort the mass features by, this will determine which mass features get rolled up into a parent mass feature. Default is "persistence".</li>
</ul>

<h6 id="raises">Raises</h6>

<ul>
<li><strong>ValueError</strong>: If no mass features are found.
If too many mass features are found.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None if drop_children is True, otherwise returns a list of mass feature ids that are not cluster parents.</strong></li>
</ul>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>